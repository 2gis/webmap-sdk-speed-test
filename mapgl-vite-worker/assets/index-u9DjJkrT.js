(function(){"use strict";function _l(e,t){let n=!1,s;function i(){n=!1,s&&(r(...s),s=!1)}function r(...o){n?s=o:(e(...o),setTimeout(i,t),n=!0)}return r}const Di=256,We=2**32,Lo=2**20,le=2**15,st=2**16-1,xs=le/st,Y=16383,No=96,Ae=.7071067811865475,Sl=1175494351e-47,Bl=3402823466e29,Is="Noto_Sans",Ro=1/2,Fl=-4,Uo=2147483647,Ol=5,Li=4,Co=40,Ni={subdomains:"0123",maxDetailLevel:17},Dl={rasterSizes:[96,84,72,60,48,36,24]},Qt=[2048,2048],Ll={url:"{protocol}://{host}/tiles?tls={tiles}&reg={regions}&tm={time}&fmt=json&z={z}"},mn={baseSize:24},Nl=1e3,Rl={fov:60*Math.PI/180},ko={globeMaxZoom:8,globeInterStartZoom:7},Ul=1e3,Cl={detailLevel:17},Vo=["Commercial_poi_city"],Yo=["Commercial_poi_premium"],kl=["Commercial_poi_default","Commercial_poi_custom","Commercial_poi_navi",...Vo,...Yo],Vl=["Commercial_model"],Yl=["s_personal_poi"],$l=["Landmark_poi","Landmark_point"],Gl=[105,84,63,42,21];function Pp(e){return e}const en=1e-6;let Vt=typeof Float64Array<"u"?Float64Array:Array;function Me(){let e=new Vt(2);return e[0]=0,e[1]=0,e}function $o(e,t){let n=new Vt(2);return n[0]=e,n[1]=t,n}function Ri(e,t){return e[0]=t[0],e[1]=t[1],e}function Fe(e,t,n){return e[0]=t,e[1]=n,e}function It(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e}function zl(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e}function jl(e,t,n){return e[0]=Math.min(t[0],n[0]),e[1]=Math.min(t[1],n[1]),e}function Xl(e,t,n){return e[0]=Math.max(t[0],n[0]),e[1]=Math.max(t[1],n[1]),e}function lt(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e}function Go(e,t){var n=t[0]-e[0],s=t[1]-e[1];return Math.sqrt(n*n+s*s)}function Ui(e){var t=e[0],n=e[1];return Math.sqrt(t*t+n*n)}function Hl(e){var t=e[0],n=e[1];return t*t+n*n}function tn(e,t){var n=t[0],s=t[1],i=n*n+s*s;return i>0&&(i=1/Math.sqrt(i),e[0]=t[0]*i,e[1]=t[1]*i),e}function wn(e,t){return e[0]*t[0]+e[1]*t[1]}function ql(e,t,n,s){var i=t[0],r=t[1];return e[0]=i+s*(n[0]-i),e[1]=r+s*(n[1]-r),e}function Ci(e,t){return e[0]===t[0]&&e[1]===t[1]}const Zl=Ui,nn=zl,zo=Go;(function(){let e=Me();return function(t,n,s,i,r,o){let a,c;for(n||(n=2),s||(s=0),i?c=Math.min(i*n+s,t.length):c=t.length,a=s;a<c;a+=n)e[0]=t[a],e[1]=t[a+1],r(e,e,o),t[a]=e[0],t[a+1]=e[1];return t}})();function Je(){let e=new Vt(3);return e[0]=0,e[1]=0,e[2]=0,e}function As(e){let t=e[0],n=e[1],s=e[2];return Math.sqrt(t*t+n*n+s*s)}function Cn(e,t,n){let s=new Vt(3);return s[0]=e,s[1]=t,s[2]=n,s}function Oe(e,t,n,s){return e[0]=t,e[1]=n,e[2]=s,e}function kn(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e[2]=t[2]+n[2],e}function Wl(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2],e}function Vn(e,t,n){return e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e}function Jl(e,t){let n=t[0]-e[0],s=t[1]-e[1],i=t[2]-e[2];return Math.sqrt(n*n+s*s+i*i)}function Kl(e){let t=e[0],n=e[1],s=e[2];return t*t+n*n+s*s}function Ql(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e}function sn(e,t){let n=t[0],s=t[1],i=t[2],r=n*n+s*s+i*i;return r>0&&(r=1/Math.sqrt(r),e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r),e}function jo(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function Ms(e,t,n){let s=t[0],i=t[1],r=t[2],o=n[0],a=n[1],c=n[2];return e[0]=i*c-r*a,e[1]=r*o-s*c,e[2]=s*a-i*o,e}function Ps(e,t,n){let s=t[0],i=t[1],r=t[2],o=n[3]*s+n[7]*i+n[11]*r+n[15];return o=o||1,e[0]=(n[0]*s+n[4]*i+n[8]*r+n[12])/o,e[1]=(n[1]*s+n[5]*i+n[9]*r+n[13])/o,e[2]=(n[2]*s+n[6]*i+n[10]*r+n[14])/o,e}function ef(e,t){let n=e[0],s=e[1],i=e[2],r=t[0],o=t[1],a=t[2];return Math.abs(n-r)<=en*Math.max(1,Math.abs(n),Math.abs(r))&&Math.abs(s-o)<=en*Math.max(1,Math.abs(s),Math.abs(o))&&Math.abs(i-a)<=en*Math.max(1,Math.abs(i),Math.abs(a))}const rn=Wl,tf=Jl,ki=As;(function(){let e=Je();return function(t,n,s,i,r,o){let a,c;for(n||(n=3),s||(s=0),i?c=Math.min(i*n+s,t.length):c=t.length,a=s;a<c;a+=n)e[0]=t[a],e[1]=t[a+1],e[2]=t[a+2],r(e,e,o),t[a]=e[0],t[a+1]=e[1],t[a+2]=e[2];return t}})();function nf(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function sf(e,t){let n=t[0],s=t[1],i=t[2],r=t[3],o=t[4],a=t[5],c=t[6],l=t[7],f=t[8],d=t[9],u=t[10],p=t[11],w=t[12],A=t[13],h=t[14],m=t[15],I=n*a-s*o,M=n*c-i*o,v=n*l-r*o,S=s*c-i*a,T=s*l-r*a,F=i*l-r*c,E=f*A-d*w,B=f*h-u*w,k=f*m-p*w,U=d*h-u*A,g=d*m-p*A,x=u*m-p*h,_=I*x-M*g+v*U+S*k-T*B+F*E;return _?(_=1/_,e[0]=(a*x-c*g+l*U)*_,e[1]=(i*g-s*x-r*U)*_,e[2]=(A*F-h*T+m*S)*_,e[3]=(u*T-d*F-p*S)*_,e[4]=(c*k-o*x-l*B)*_,e[5]=(n*x-i*k+r*B)*_,e[6]=(h*v-w*F-m*M)*_,e[7]=(f*F-u*v+p*M)*_,e[8]=(o*g-a*k+l*E)*_,e[9]=(s*k-n*g-r*E)*_,e[10]=(w*T-A*v+m*I)*_,e[11]=(d*v-f*T-p*I)*_,e[12]=(a*B-o*U-c*E)*_,e[13]=(n*U-s*B+i*E)*_,e[14]=(A*M-w*S-h*I)*_,e[15]=(f*S-d*M+u*I)*_,e):null}function rf(e,t,n){let s=t[0],i=t[1],r=t[2],o=t[3],a=t[4],c=t[5],l=t[6],f=t[7],d=t[8],u=t[9],p=t[10],w=t[11],A=t[12],h=t[13],m=t[14],I=t[15],M=n[0],v=n[1],S=n[2],T=n[3];return e[0]=M*s+v*a+S*d+T*A,e[1]=M*i+v*c+S*u+T*h,e[2]=M*r+v*l+S*p+T*m,e[3]=M*o+v*f+S*w+T*I,M=n[4],v=n[5],S=n[6],T=n[7],e[4]=M*s+v*a+S*d+T*A,e[5]=M*i+v*c+S*u+T*h,e[6]=M*r+v*l+S*p+T*m,e[7]=M*o+v*f+S*w+T*I,M=n[8],v=n[9],S=n[10],T=n[11],e[8]=M*s+v*a+S*d+T*A,e[9]=M*i+v*c+S*u+T*h,e[10]=M*r+v*l+S*p+T*m,e[11]=M*o+v*f+S*w+T*I,M=n[12],v=n[13],S=n[14],T=n[15],e[12]=M*s+v*a+S*d+T*A,e[13]=M*i+v*c+S*u+T*h,e[14]=M*r+v*l+S*p+T*m,e[15]=M*o+v*f+S*w+T*I,e}function of(e,t,n){let s=n[0],i=n[1],r=n[2],o,a,c,l,f,d,u,p,w,A,h,m;return t===e?(e[12]=t[0]*s+t[4]*i+t[8]*r+t[12],e[13]=t[1]*s+t[5]*i+t[9]*r+t[13],e[14]=t[2]*s+t[6]*i+t[10]*r+t[14],e[15]=t[3]*s+t[7]*i+t[11]*r+t[15]):(o=t[0],a=t[1],c=t[2],l=t[3],f=t[4],d=t[5],u=t[6],p=t[7],w=t[8],A=t[9],h=t[10],m=t[11],e[0]=o,e[1]=a,e[2]=c,e[3]=l,e[4]=f,e[5]=d,e[6]=u,e[7]=p,e[8]=w,e[9]=A,e[10]=h,e[11]=m,e[12]=o*s+f*i+w*r+t[12],e[13]=a*s+d*i+A*r+t[13],e[14]=c*s+u*i+h*r+t[14],e[15]=l*s+p*i+m*r+t[15]),e}function bs(e,t,n){let s=n[0],i=n[1],r=n[2];return e[0]=t[0]*s,e[1]=t[1]*s,e[2]=t[2]*s,e[3]=t[3]*s,e[4]=t[4]*i,e[5]=t[5]*i,e[6]=t[6]*i,e[7]=t[7]*i,e[8]=t[8]*r,e[9]=t[9]*r,e[10]=t[10]*r,e[11]=t[11]*r,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function Xo(e,t,n){let s=Math.sin(n),i=Math.cos(n),r=t[4],o=t[5],a=t[6],c=t[7],l=t[8],f=t[9],d=t[10],u=t[11];return t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=r*i+l*s,e[5]=o*i+f*s,e[6]=a*i+d*s,e[7]=c*i+u*s,e[8]=l*i-r*s,e[9]=f*i-o*s,e[10]=d*i-a*s,e[11]=u*i-c*s,e}function af(e,t,n){let s=Math.sin(n),i=Math.cos(n),r=t[0],o=t[1],a=t[2],c=t[3],l=t[8],f=t[9],d=t[10],u=t[11];return t!==e&&(e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=r*i-l*s,e[1]=o*i-f*s,e[2]=a*i-d*s,e[3]=c*i-u*s,e[8]=r*s+l*i,e[9]=o*s+f*i,e[10]=a*s+d*i,e[11]=c*s+u*i,e}function Ho(e,t,n){let s=Math.sin(n),i=Math.cos(n),r=t[0],o=t[1],a=t[2],c=t[3],l=t[4],f=t[5],d=t[6],u=t[7];return t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=r*i+l*s,e[1]=o*i+f*s,e[2]=a*i+d*s,e[3]=c*i+u*s,e[4]=l*i-r*s,e[5]=f*i-o*s,e[6]=d*i-a*s,e[7]=u*i-c*s,e}function qo(e,t,n){let s=n[0],i=n[1],r=n[2],o=Math.sqrt(s*s+i*i+r*r),a,c,l;return Math.abs(o)<en?null:(o=1/o,s*=o,i*=o,r*=o,a=Math.sin(t),c=Math.cos(t),l=1-c,e[0]=s*s*l+c,e[1]=i*s*l+r*a,e[2]=r*s*l-i*a,e[3]=0,e[4]=s*i*l-r*a,e[5]=i*i*l+c,e[6]=r*i*l+s*a,e[7]=0,e[8]=s*r*l+i*a,e[9]=i*r*l-s*a,e[10]=r*r*l+c,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e)}function cf(e,t,n,s){let i,r,o,a,c,l,f,d,u,p,w=t[0],A=t[1],h=t[2],m=s[0],I=s[1],M=s[2],v=n[0],S=n[1],T=n[2];return Math.abs(w-v)<en&&Math.abs(A-S)<en&&Math.abs(h-T)<en?mat4.identity(e):(f=w-v,d=A-S,u=h-T,p=1/Math.sqrt(f*f+d*d+u*u),f*=p,d*=p,u*=p,i=I*u-M*d,r=M*f-m*u,o=m*d-I*f,p=Math.sqrt(i*i+r*r+o*o),p?(p=1/p,i*=p,r*=p,o*=p):(i=0,r=0,o=0),a=d*o-u*r,c=u*i-f*o,l=f*r-d*i,p=Math.sqrt(a*a+c*c+l*l),p?(p=1/p,a*=p,c*=p,l*=p):(a=0,c=0,l=0),e[0]=i,e[1]=a,e[2]=f,e[3]=0,e[4]=r,e[5]=c,e[6]=d,e[7]=0,e[8]=o,e[9]=l,e[10]=u,e[11]=0,e[12]=-(i*w+r*A+o*h),e[13]=-(a*w+c*A+l*h),e[14]=-(f*w+d*A+u*h),e[15]=1,e)}const lf=rf;function Zo(e,t,n){return e[0]=n[0],e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=n[1],e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=n[2],e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1,e}function Es(){let e=new Vt(4);return e[0]=0,e[1]=0,e[2]=0,e[3]=0,e}function ff(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e}function df(e,t){let n=t[0],s=t[1],i=t[2],r=t[3],o=n*n+s*s+i*i+r*r;return o>0&&(o=1/Math.sqrt(o),e[0]=n*o,e[1]=s*o,e[2]=i*o,e[3]=r*o),e}function Vi(e,t,n){let s=t[0],i=t[1],r=t[2],o=t[3];return e[0]=n[0]*s+n[4]*i+n[8]*r+n[12]*o,e[1]=n[1]*s+n[5]*i+n[9]*r+n[13]*o,e[2]=n[2]*s+n[6]*i+n[10]*r+n[14]*o,e[3]=n[3]*s+n[7]*i+n[11]*r+n[15]*o,e}(function(){let e=Es();return function(t,n,s,i,r,o){let a,c;for(n||(n=4),s||(s=0),i?c=Math.min(i*n+s,t.length):c=t.length,a=s;a<c;a+=n)e[0]=t[a],e[1]=t[a+1],e[2]=t[a+2],e[3]=t[a+3],r(e,e,o),t[a]=e[0],t[a+1]=e[1],t[a+2]=e[2],t[a+3]=e[3];return t}})();const on=Es();class Ie{constructor(t,n){this.state=t,this.camera=n,this.position=[0,0,0]}static fromGeo(t,n=[0,0]){const s=We/2,i=Math.sin(_e(t[1])),r=t[0]*We/360,o=Math.log((1+i)/(1-i))*We/(4*Math.PI);let a=0;if(t.length>2){const c=Ie.scaleFactor(t[1]);a=(t[2]??0)*Te*c}return n[0]=r,n[1]=ft(o,-2147483648,s),n[2]=a,n}static toGeo(t,n=[0,0]){n[0]=t[0]*360/We;const s=-2*Math.PI/We;if(n[1]=90-2*$n(Math.atan(Math.exp(t[1]*s))),t[2]){const i=Ie.scaleFactor(n[1]);n[2]=t[2]/Te/i}return n}static scaleFactor(t){return 1/Math.cos(_e(t))}update(){const{center:t,rotation:n,zoom:s,pitch:i,size:r}=this.state,o=Yi(s,r),a=Math.max(o*Math.sin(i),1);this.position[0]=t[0]+Math.sin(n)*a,this.position[1]=t[1]-Math.cos(n)*a,this.position[2]=o*Math.cos(i)}project(t,n=!1,s=[NaN,NaN]){const{size:i,viewport:r}=this.state;on[0]=t[0],on[1]=t[1],on[2]=t[2],on[3]=1,Vi(on,on,this.camera.viewProjectionMatrix);const[o,a,c,l]=on,f=l*2;if(n&&(c>f||c<-f||o>f||o<-f||a>f||a<-f))return s;const u=i[0]/2,p=i[1]/2;return s[0]=u+r.left+o*u/l,s[1]=p+r.top-a*p/l,s}unproject(t,n=[0,0,0]){const{size:s,viewport:i}=this.state;n[0]=(t[0]-i.left)/s[0]*2-1,n[1]=-((Math.max(this.camera.horizonPixelOffset,t[1])-i.top)/s[1])*2+1,n[2]=0,Ps(n,n,this.camera.viewProjectionMatrixInverse),n[0]-=this.position[0],n[1]-=this.position[1],n[2]-=this.position[2],sn(n,n);const r=-this.position[2]/n[2];return n[0]=this.position[0]+n[0]*r,n[1]=this.position[1]+n[1]*r,n[2]=this.position[2]+n[2]*r,n}setState(t){this.state=t}}const an=Es();function Wo(e){return[e[2],e[0],e[1]]}class Yt{constructor(t,n){this.state=t,this.camera=n,this.position=[0,0,0],this.ivpMatrix=[],this.cachedVisibleArc=new na(()=>{const s=Yi(this.state.zoom,this.state.size)/Te;return Math.acos(Yn/(Yn+s))},()=>[this.state.zoom]),this.cachedPixelRadius=new na(()=>{const s=Ie.toGeo(this.state.center),i=wf(s,0,this.visibleArc),r=this.project(Yt.fromGeo(i));return r[0]-=this.state.viewport.left+this.state.size[0]/2+(this.state.padding.left-this.state.padding.right)/2,r[1]-=this.state.viewport.top+this.state.size[1]/2+(this.state.padding.top-this.state.padding.bottom)/2,Zl(r)},()=>[this.state.zoom,this.state.cameraConfig.fov,this.state.size[0],this.state.size[1],this.state.padding.bottom,this.state.padding.top,this.state.padding.left,this.state.padding.right,this.camera.globeMatrix[0]]),this.update()}get visibleArc(){return this.cachedVisibleArc.value}get pixelRadius(){return this.cachedPixelRadius.value}static fromGeo(t,n=[NaN,NaN,NaN]){const s=_e(t[0]),i=_e(t[1]),r=Math.cos(s),o=Math.sin(s),a=Math.cos(i),c=Math.sin(i),l=Yn*Te;return n[0]=o*a*l,n[1]=c*l,n[2]=r*a*l,n}static toGeo(t,n=[NaN,NaN]){const s=t[0],i=t[1],r=t[2],o=Math.sqrt(s*s+i*i+r*r),a=Math.asin(r/o),c=Math.atan2(i,s);return n[0]=$n(c),n[1]=$n(a),n}update(){const{state:t}=this,n=Ie.toGeo(t.center),s=Yi(t.zoom,t.size)+Yn*Te,i=_e(n[0]),r=_e(n[1]),o=Math.cos(i),a=Math.sin(i),c=Math.cos(r),l=Math.sin(r);this.position=[a*c*s,l*s,o*c*s];const f=[0,0,1];cf(this.ivpMatrix,Wo(this.position),[0,0,0],f),lf(this.ivpMatrix,this.camera.projectionMatrix,this.ivpMatrix),sf(this.ivpMatrix,this.ivpMatrix)}project(t,n=!1,s=[NaN,NaN]){const{size:i,viewport:r}=this.state,o=Es();an[0]=t[0],an[1]=t[1],an[2]=t[2],an[3]=1,Vi(an,an,this.camera.globeMatrix),Vi(o,an,this.camera.viewProjectionMatrix);const[a,c,l,f]=o,d=f*2;if(n&&(l>d||l<-d||a>d||a<-d||c>d||c<-d))return s[0]=NaN,s[1]=NaN,s;const p=i[0]/2,w=i[1]/2;return s[0]=p+r.left+a*p/f,s[1]=w+r.top-c*w/f,s}unproject(t,n,s=[NaN,NaN,NaN]){const{size:i,viewport:r}=this.state,o=[(t[0]-r.left)/i[0]*2-1,-((Math.max(0,t[1])-r.top)/i[1])*2+1,0],a=Wo(this.position),c=[0,0,0,1];Ps(c,o,this.ivpMatrix);const l=sn([],rn([],c,a)),f=Ql([],a),d=jo(f,l),u=Kl(f)-d**2,p=(Yn*Te)**2;if(u>p){if(n)return Yt.fromGeo(Ie.toGeo(this.state.center));const{left:I,bottom:M,top:v,right:S}=this.state.padding,T=t[0]-r.left-i[0]/2-(I-S)/2,F=t[1]-r.top-i[1]/2-(v-M)/2,E=lt([],tn([],[T,F]),this.pixelRadius-1);return E[0]=E[0]+r.left+i[0]/2+(I-S)/2,E[1]=E[1]+r.top+i[1]/2+(v-M)/2,this.unproject(E,!0,s)}const w=Math.sqrt(p-u),A=d-w,h=d+w,m=Math.min(A,h);return s[0]=a[0]+l[0]*m,s[1]=a[1]+l[1]*m,s[2]=a[2]+l[2]*m,s}setState(t){this.state=t}canSee(t){const n=Ie.toGeo(this.state.center);return mf(n,t)<this.visibleArc}}function yn(e,t){return{min:e||$o(1/0,1/0),max:t||$o(-1/0,-1/0)}}function Jo(e,t){jl(e.min,e.min,t),Xl(e.max,e.max,t)}function Ko(e,t){return e[0]=t.min[0]+(t.max[0]-t.min[0])/2,e[1]=t.min[1]+(t.max[1]-t.min[1])/2,e}const Qo=6378137,ea=2*Math.PI*Qo,Te=We/ea;Zo([],[-1,-1,0],[2,2,1]),Zo([],[.5,.5,0],[.5,.5,1]);const Yn=Qo*(Math.PI/2),$e=2**15/We;function hf(e){return Math.max(e,Ul)}function Yi(e,t){const n=Rl,s=hf(t[1])/2,i=We/2**e,r=s/Di*i,o=Math.tan(n.fov/2);return r/o}function uf(e){const n=Ie.toGeo(e)[1],s=1/(2*Math.cos(_e(n)));return Math.log(s)/Math.log(2)}function pf(e,t){const n=uf(t)*yf(9,10,e);return e+ft(n,-1,0)}function ta(e,t){return t*Te*Ie.scaleFactor(e[1])}yn([-2147483648,-2147483648],[We/2,We/2]),yn([-214748364800,-2147483648],[We*100/2,We/2]);function gf(e,t){return e===0?-1/0:-Math.log(t*Di/(e*We))/Math.LN2}Me(),Me();function mf(e,t){const n=Math.cos(_e(t[0]-e[0])),s=Math.sin(_e(t[1])),i=Math.sin(_e(e[1])),r=Math.cos(_e(t[1])),o=Math.cos(_e(e[1]));return Math.acos(s*i+r*o*n)}function wf(e,t,n){const s=_e(e[0]),i=_e(e[1]),r=[0,0];return r[1]=Math.asin(Math.sin(i)*Math.cos(n)+Math.cos(i)*Math.sin(n)*Math.cos(t)),r[0]=s+Math.atan2(Math.sin(t)*Math.sin(n)*Math.cos(i),Math.cos(n)-Math.sin(i)*Math.sin(r[1])),[$n(r[0]),$n(r[1])]}Je();function ft(e,t,n){return e=Math.max(e,t),e=Math.min(e,n),e}function $i(e){return e===0||Number.isNaN(e)?e:e>0?1:-1}function _e(e){return e*Math.PI/180}function $n(e){return e/Math.PI*180}function Gi(e){const t={};for(const n in e){const s=e[n];t[s]=n}return t}function yf(e,t,n){return ft((n-e)/(t-e),0,1)}function zi(e,t,n){return e+(t-e)*n}function ji(e,t){const n=t;typeof e=="number"?n.fill(e):Array.isArray(e)&&typeof e[0]=="number"&&typeof e[1]=="number"&&typeof e[2]=="number"&&(n[0]=e[0],n[1]=e[1],n[2]=e[2])}class na{constructor(t,n){this.getNewValidFor=n,this.getNewValue=t,this.currentValue=NaN,this.currentValidFor=new Array(n().length).fill(NaN)}get value(){const t=this.getNewValidFor();return this.currentValidFor.some((s,i)=>s!==t[i])&&(this.currentValidFor=t,this.currentValue=this.getNewValue()),this.currentValue}}function sa(){let e=new Vt(9);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e}function vf(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10],e}function Xi(){let e=new Vt(4);return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e}function xf(e,t,n){n=n*.5;let s=Math.sin(n);return e[0]=s*t[0],e[1]=s*t[1],e[2]=s*t[2],e[3]=Math.cos(n),e}function Hi(e,t,n,s){let i=t[0],r=t[1],o=t[2],a=t[3],c=n[0],l=n[1],f=n[2],d=n[3],u,p,w,A,h;return p=i*c+r*l+o*f+a*d,p<0&&(p=-p,c=-c,l=-l,f=-f,d=-d),1-p>1e-6?(u=Math.acos(p),w=Math.sin(u),A=Math.sin((1-s)*u)/w,h=Math.sin(s*u)/w):(A=1-s,h=s),e[0]=A*i+h*c,e[1]=A*r+h*l,e[2]=A*o+h*f,e[3]=A*a+h*d,e}function If(e,t){let n=t[0]+t[4]+t[8],s;if(n>0)s=Math.sqrt(n+1),e[3]=.5*s,s=.5/s,e[0]=(t[5]-t[7])*s,e[1]=(t[6]-t[2])*s,e[2]=(t[1]-t[3])*s;else{let i=0;t[4]>t[0]&&(i=1),t[8]>t[i*3+i]&&(i=2);let r=(i+1)%3,o=(i+2)%3;s=Math.sqrt(t[i*3+i]-t[r*3+r]-t[o*3+o]+1),e[i]=.5*s,s=.5/s,e[3]=(t[r*3+o]-t[o*3+r])*s,e[r]=(t[r*3+i]+t[i*3+r])*s,e[o]=(t[o*3+i]+t[i*3+o])*s}return e}const ia=df;(function(){let e=Je(),t=Cn(1,0,0),n=Cn(0,1,0);return function(s,i,r){let o=jo(i,r);return o<-.999999?(Ms(e,t,i),ki(e)<1e-6&&Ms(e,n,i),sn(e,e),xf(s,e,Math.PI),s):o>.999999?(s[0]=0,s[1]=0,s[2]=0,s[3]=1,s):(Ms(e,i,r),s[0]=e[0],s[1]=e[1],s[2]=e[2],s[3]=1+o,ia(s,s))}})(),function(){let e=Xi(),t=Xi();return function(n,s,i,r,o,a){return Hi(e,s,o,a),Hi(t,i,r,a),Hi(n,e,t,2*a*(1-a)),n}}(),function(){let e=sa();return function(t,n,s,i){return e[0]=s[0],e[3]=s[1],e[6]=s[2],e[1]=i[0],e[4]=i[1],e[7]=i[2],e[2]=-n[0],e[5]=-n[1],e[8]=-n[2],ia(t,If(t,e))}}();const At=[0,0,0],Mt=[0,0,0],qi=Je();sa();function dt(e,t,n,s,i){if(t!==s||n!==i){const r=i-n,o=t-s,a=1/Math.sqrt(r*r+o*o);e[0]=r*a,e[1]=o*a}else e[0]=0,e[1]=0}function ra(e,t,n,s){return rn(At,n,t),rn(Mt,n,s),Ms(e,Mt,At),sn(e,e),e}function Pt(e,t,n,s,i){if(t!==s||n!==i){const r=s-t,o=i-n,a=1/Math.sqrt(r*r+o*o);e[0]=r*a,e[1]=o*a}else e[0]=0,e[1]=0}function oa(e,t,n,s,i){const r=t+s,o=n+i,a=t*r+n*o,c=5;if(a!==0){const l=1/a;e[0]=r*l,e[1]=o*l,Ui(e)>c&&tn(e,e)}else e[0]=0,e[1]=0}function De(e){return ft(e*127,-127,127)}function Zi(e,t=e){return e[0]=De(t[0]),e[1]=De(t[1]),e}function Af(e,t,n,s,i){e[0]=t*s+n*i,e[1]=n*s-t*i}function $t(e,t){const n=t[0];e[0]=-t[1],e[1]=n}function Wi(e,t){const n=t[0];e[0]=t[1],e[1]=-n}function Mf(e,t,n,s,i=!0){if(Ci(t,n)||Ci(n,s)){Fe(e,0,0);return}nn(At,n,t),nn(Mt,s,n),i?($t(At,At),$t(Mt,Mt)):(Wi(At,At),Wi(Mt,Mt)),tn(At,At),tn(Mt,Mt),It(e,At,Mt),tn(e,e)}function Pf(e,t,n){t[0]=As(Oe(qi,e[0],e[1],e[2])),t[1]=As(Oe(qi,e[3],e[4],e[5])),t[2]=As(Oe(qi,e[6],e[7],e[8]))}var cn=(e=>(e[e.Striped=1]="Striped",e[e.Entrance=2]="Entrance",e[e.Patterned=3]="Patterned",e))(cn||{}),Gn=(e=>(e[e.Line=0]="Line",e[e.Arrow=1]="Arrow",e[e.StartBorder=2]="StartBorder",e[e.LineEnding=3]="LineEnding",e))(Gn||{}),ve=(e=>(e[e.TileCut=0]="TileCut",e[e.Butt=1]="Butt",e[e.Round=2]="Round",e))(ve||{});const Ne=Me(),Ts=Me(),vn=Me(),Gt=Me(),zn=Me(),St=Me(),Ji=Me(),it=Me();let xn=0,zt=0;function aa(e,t,n,s,i,r,o,a,c,l){if(!(i<2)){if(Pt(Ne,t[0],n[0],t[1],n[1]),xn=0,r===ve.Round){const f=c!==void 0?c[0]:0,d=l!==void 0?l[0]:0;Ki(e,t[0],n[0],(s==null?void 0:s[0])??0,-Ne[0],-Ne[1],f,d,a)}for(let f=1;f<i;f++)bf(e,t,n,s,f,i,a,c,l);if(o===ve.Round){const f=c!==void 0?c[i-1]:0,d=l!==void 0?l[i-1]:0;Ki(e,t[i-1],n[i-1],(s==null?void 0:s[i-1])??0,Ne[0],Ne[1],f,d,a)}}}function bf(e,t,n,s,i,r,o,a,c){const l=i===r-1;if(Fe(zn,t[i-1],n[i-1]),Fe(St,t[i],n[i]),a!==void 0&&c!==void 0?(Fe(vn,a[i-1],c[i-1]),Fe(Gt,a[i],c[i])):(Fe(vn,0,0),Fe(Gt,0,0)),$t(it,Ne),l)zt=0;else{Fe(Ji,t[i+1],n[i+1]),Pt(Ts,St[0],St[1],Ji[0],Ji[1]);const u=ft(wn(Ne,Ts),-1,1);if(u<=0)zt=0,Ki(e,St[0],St[1],(s==null?void 0:s[i])??0,Ne[0],Ne[1],Gt[0],Gt[1],o);else{const w=Math.sqrt((1-u)/(1+u)),A=$i(wn(it,Ts));zt=w*A}}Ef(e,0,1,3,3,1,2);const f=it[0]*Ae,d=it[1]*Ae;ln(e,zn[0],zn[1],(s==null?void 0:s[i-1])??0,(it[0]+Ne[0]*xn)*Ae,(it[1]+Ne[1]*xn)*Ae,f,d,vn[0],vn[1],o),ln(e,zn[0],zn[1],(s==null?void 0:s[i-1])??0,(-it[0]-Ne[0]*xn)*Ae,(-it[1]-Ne[1]*xn)*Ae,-f,-d,vn[0],vn[1],o),ln(e,St[0],St[1],(s==null?void 0:s[i])??0,(-it[0]+Ne[0]*zt)*Ae,(-it[1]+Ne[1]*zt)*Ae,-f,-d,Gt[0],Gt[1],o),ln(e,St[0],St[1],(s==null?void 0:s[i])??0,(it[0]-Ne[0]*zt)*Ae,(it[1]-Ne[1]*zt)*Ae,f,d,Gt[0],Gt[1],o),l||(Ri(Ne,Ts),xn=zt)}function Ki(e,t,n,s,i,r,o,a,c){Tf(e,0,1,2);const l=-i*.01,f=-r*.01;ln(e,t,n,s,i+l,r+f,i,r,o,a,c),ln(e,t,n,s,-r+l,i+f,-r,i,o,a,c),ln(e,t,n,s,r+l,-i+f,r,-i,o,a,c)}function ln(e,t,n,s,i,r,o,a,c,l,f){const d=e.elements.offset*e.elements.stride,u=d>>1,p=d>>2;e.views.position[u]=Y+t,e.views.position[u+1]=Y+n,e.views.extender[d]=i*127,e.views.extender[d+1]=r*127,e.views.normal[d]=o*127,e.views.normal[d+1]=a*127,"height"in e.views&&(e.views.height[p]=s),"shift"in e.views&&(e.views.shift[p]=c,e.views.shift[p+1]=l),"localID"in e.views&&(e.views.localID[p]=f),e.elements.offset++}function Ef(e,t,n,s,i,r,o){const a=e.indices.buffer,c=e.indices.offset,l=e.elements.offset;a[c]=l+t,a[c+1]=l+n,a[c+2]=l+s,a[c+3]=l+i,a[c+4]=l+r,a[c+5]=l+o,e.indices.offset=c+6}function Tf(e,t,n,s){const i=e.indices.buffer,r=e.indices.offset,o=e.elements.offset;i[r]=o+t,i[r+1]=o+n,i[r+2]=o+s,e.indices.offset=r+3}function Pe(e,t,n){return t.precomputes.forEach((s,i)=>{e.push(n.tileData[i])}),e}function jn(e,t){for(let n=0,s=t.length;n<s;n++)e.push(t[n]);return e}const _f={x:0,y:1};function Sf(e){const t={};for(const n in e)e[n]&&(t[n]=Array.from(e[n]));return t}function Xn(e,t){for(const n in e){const s=_f[n];s!==void 0?e[n].push(t[s]):e[n].push(NaN)}}function Qi(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var _s={},ca;function Bf(){return ca||(ca=1,function(){for(var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",t=new Uint8Array(256),n=0;n<e.length;n++)t[e.charCodeAt(n)]=n;_s.encode=function(s){var i=new Uint8Array(s),r,o=i.length,a="";for(r=0;r<o;r+=3)a+=e[i[r]>>2],a+=e[(i[r]&3)<<4|i[r+1]>>4],a+=e[(i[r+1]&15)<<2|i[r+2]>>6],a+=e[i[r+2]&63];return o%3===2?a=a.substring(0,a.length-1)+"=":o%3===1&&(a=a.substring(0,a.length-2)+"=="),a},_s.decode=function(s){var i=s.length*.75,r=s.length,o,a=0,c,l,f,d;s[s.length-1]==="="&&(i--,s[s.length-2]==="="&&i--);var u=new ArrayBuffer(i),p=new Uint8Array(u);for(o=0;o<r;o+=4)c=t[s.charCodeAt(o)],l=t[s.charCodeAt(o+1)],f=t[s.charCodeAt(o+2)],d=t[s.charCodeAt(o+3)],p[a++]=c<<2|l>>4,p[a++]=(l&15)<<4|f>>2,p[a++]=(f&3)<<6|d&63;return u}}()),_s}Bf();var Ss={},la;function Ff(){return la||(la=1,Ss.read=function(e,t,n,s,i){var r,o,a=i*8-s-1,c=(1<<a)-1,l=c>>1,f=-7,d=n?i-1:0,u=n?-1:1,p=e[t+d];for(d+=u,r=p&(1<<-f)-1,p>>=-f,f+=a;f>0;r=r*256+e[t+d],d+=u,f-=8);for(o=r&(1<<-f)-1,r>>=-f,f+=s;f>0;o=o*256+e[t+d],d+=u,f-=8);if(r===0)r=1-l;else{if(r===c)return o?NaN:(p?-1:1)*(1/0);o=o+Math.pow(2,s),r=r-l}return(p?-1:1)*o*Math.pow(2,r-s)},Ss.write=function(e,t,n,s,i,r){var o,a,c,l=r*8-i-1,f=(1<<l)-1,d=f>>1,u=i===23?Math.pow(2,-24)-Math.pow(2,-77):0,p=s?0:r-1,w=s?1:-1,A=t<0||t===0&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(a=isNaN(t)?1:0,o=f):(o=Math.floor(Math.log(t)/Math.LN2),t*(c=Math.pow(2,-o))<1&&(o--,c*=2),o+d>=1?t+=u/c:t+=u*Math.pow(2,1-d),t*c>=2&&(o++,c/=2),o+d>=f?(a=0,o=f):o+d>=1?(a=(t*c-1)*Math.pow(2,i),o=o+d):(a=t*Math.pow(2,d-1)*Math.pow(2,i),o=0));i>=8;e[n+p]=a&255,p+=w,a/=256,i-=8);for(o=o<<i|a,l+=i;l>0;e[n+p]=o&255,p+=w,o/=256,l-=8);e[n+p-w]|=A*128}),Ss}var er,fa;function Of(){if(fa)return er;fa=1,er=t;var e=Ff();function t(g){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(g)?g:new Uint8Array(g||0),this.pos=0,this.type=0,this.length=this.buf.length}t.Varint=0,t.Fixed64=1,t.Bytes=2,t.Fixed32=5;var n=65536*65536,s=1/n,i=12,r=typeof TextDecoder>"u"?null:new TextDecoder("utf8");t.prototype={destroy:function(){this.buf=null},readFields:function(g,x,_){for(_=_||this.length;this.pos<_;){var C=this.readVarint(),y=C>>3,b=this.pos;this.type=C&7,g(y,x,this),this.pos===b&&this.skip(C)}return x},readMessage:function(g,x){return this.readFields(g,x,this.readVarint()+this.pos)},readFixed32:function(){var g=T(this.buf,this.pos);return this.pos+=4,g},readSFixed32:function(){var g=E(this.buf,this.pos);return this.pos+=4,g},readFixed64:function(){var g=T(this.buf,this.pos)+T(this.buf,this.pos+4)*n;return this.pos+=8,g},readSFixed64:function(){var g=T(this.buf,this.pos)+E(this.buf,this.pos+4)*n;return this.pos+=8,g},readFloat:function(){var g=e.read(this.buf,this.pos,!0,23,4);return this.pos+=4,g},readDouble:function(){var g=e.read(this.buf,this.pos,!0,52,8);return this.pos+=8,g},readVarint:function(g){var x=this.buf,_,C;return C=x[this.pos++],_=C&127,C<128||(C=x[this.pos++],_|=(C&127)<<7,C<128)||(C=x[this.pos++],_|=(C&127)<<14,C<128)||(C=x[this.pos++],_|=(C&127)<<21,C<128)?_:(C=x[this.pos],_|=(C&15)<<28,o(_,g,this))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var g=this.readVarint();return g%2===1?(g+1)/-2:g/2},readBoolean:function(){return!!this.readVarint()},readString:function(){var g=this.readVarint()+this.pos,x=this.pos;return this.pos=g,g-x>=i&&r?k(this.buf,x,g):B(this.buf,x,g)},readBytes:function(){var g=this.readVarint()+this.pos,x=this.buf.subarray(this.pos,g);return this.pos=g,x},readPackedVarint:function(g,x){if(this.type!==t.Bytes)return g.push(this.readVarint(x));var _=a(this);for(g=g||[];this.pos<_;)g.push(this.readVarint(x));return g},readPackedSVarint:function(g){if(this.type!==t.Bytes)return g.push(this.readSVarint());var x=a(this);for(g=g||[];this.pos<x;)g.push(this.readSVarint());return g},readPackedBoolean:function(g){if(this.type!==t.Bytes)return g.push(this.readBoolean());var x=a(this);for(g=g||[];this.pos<x;)g.push(this.readBoolean());return g},readPackedFloat:function(g){if(this.type!==t.Bytes)return g.push(this.readFloat());var x=a(this);for(g=g||[];this.pos<x;)g.push(this.readFloat());return g},readPackedDouble:function(g){if(this.type!==t.Bytes)return g.push(this.readDouble());var x=a(this);for(g=g||[];this.pos<x;)g.push(this.readDouble());return g},readPackedFixed32:function(g){if(this.type!==t.Bytes)return g.push(this.readFixed32());var x=a(this);for(g=g||[];this.pos<x;)g.push(this.readFixed32());return g},readPackedSFixed32:function(g){if(this.type!==t.Bytes)return g.push(this.readSFixed32());var x=a(this);for(g=g||[];this.pos<x;)g.push(this.readSFixed32());return g},readPackedFixed64:function(g){if(this.type!==t.Bytes)return g.push(this.readFixed64());var x=a(this);for(g=g||[];this.pos<x;)g.push(this.readFixed64());return g},readPackedSFixed64:function(g){if(this.type!==t.Bytes)return g.push(this.readSFixed64());var x=a(this);for(g=g||[];this.pos<x;)g.push(this.readSFixed64());return g},skip:function(g){var x=g&7;if(x===t.Varint)for(;this.buf[this.pos++]>127;);else if(x===t.Bytes)this.pos=this.readVarint()+this.pos;else if(x===t.Fixed32)this.pos+=4;else if(x===t.Fixed64)this.pos+=8;else throw new Error("Unimplemented type: "+x)},writeTag:function(g,x){this.writeVarint(g<<3|x)},realloc:function(g){for(var x=this.length||16;x<this.pos+g;)x*=2;if(x!==this.length){var _=new Uint8Array(x);_.set(this.buf),this.buf=_,this.length=x}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(g){this.realloc(4),F(this.buf,g,this.pos),this.pos+=4},writeSFixed32:function(g){this.realloc(4),F(this.buf,g,this.pos),this.pos+=4},writeFixed64:function(g){this.realloc(8),F(this.buf,g&-1,this.pos),F(this.buf,Math.floor(g*s),this.pos+4),this.pos+=8},writeSFixed64:function(g){this.realloc(8),F(this.buf,g&-1,this.pos),F(this.buf,Math.floor(g*s),this.pos+4),this.pos+=8},writeVarint:function(g){if(g=+g||0,g>268435455||g<0){l(g,this);return}this.realloc(4),this.buf[this.pos++]=g&127|(g>127?128:0),!(g<=127)&&(this.buf[this.pos++]=(g>>>=7)&127|(g>127?128:0),!(g<=127)&&(this.buf[this.pos++]=(g>>>=7)&127|(g>127?128:0),!(g<=127)&&(this.buf[this.pos++]=g>>>7&127)))},writeSVarint:function(g){this.writeVarint(g<0?-g*2-1:g*2)},writeBoolean:function(g){this.writeVarint(!!g)},writeString:function(g){g=String(g),this.realloc(g.length*4),this.pos++;var x=this.pos;this.pos=U(this.buf,g,this.pos);var _=this.pos-x;_>=128&&u(x,_,this),this.pos=x-1,this.writeVarint(_),this.pos+=_},writeFloat:function(g){this.realloc(4),e.write(this.buf,g,this.pos,!0,23,4),this.pos+=4},writeDouble:function(g){this.realloc(8),e.write(this.buf,g,this.pos,!0,52,8),this.pos+=8},writeBytes:function(g){var x=g.length;this.writeVarint(x),this.realloc(x);for(var _=0;_<x;_++)this.buf[this.pos++]=g[_]},writeRawMessage:function(g,x){this.pos++;var _=this.pos;g(x,this);var C=this.pos-_;C>=128&&u(_,C,this),this.pos=_-1,this.writeVarint(C),this.pos+=C},writeMessage:function(g,x,_){this.writeTag(g,t.Bytes),this.writeRawMessage(x,_)},writePackedVarint:function(g,x){x.length&&this.writeMessage(g,p,x)},writePackedSVarint:function(g,x){x.length&&this.writeMessage(g,w,x)},writePackedBoolean:function(g,x){x.length&&this.writeMessage(g,m,x)},writePackedFloat:function(g,x){x.length&&this.writeMessage(g,A,x)},writePackedDouble:function(g,x){x.length&&this.writeMessage(g,h,x)},writePackedFixed32:function(g,x){x.length&&this.writeMessage(g,I,x)},writePackedSFixed32:function(g,x){x.length&&this.writeMessage(g,M,x)},writePackedFixed64:function(g,x){x.length&&this.writeMessage(g,v,x)},writePackedSFixed64:function(g,x){x.length&&this.writeMessage(g,S,x)},writeBytesField:function(g,x){this.writeTag(g,t.Bytes),this.writeBytes(x)},writeFixed32Field:function(g,x){this.writeTag(g,t.Fixed32),this.writeFixed32(x)},writeSFixed32Field:function(g,x){this.writeTag(g,t.Fixed32),this.writeSFixed32(x)},writeFixed64Field:function(g,x){this.writeTag(g,t.Fixed64),this.writeFixed64(x)},writeSFixed64Field:function(g,x){this.writeTag(g,t.Fixed64),this.writeSFixed64(x)},writeVarintField:function(g,x){this.writeTag(g,t.Varint),this.writeVarint(x)},writeSVarintField:function(g,x){this.writeTag(g,t.Varint),this.writeSVarint(x)},writeStringField:function(g,x){this.writeTag(g,t.Bytes),this.writeString(x)},writeFloatField:function(g,x){this.writeTag(g,t.Fixed32),this.writeFloat(x)},writeDoubleField:function(g,x){this.writeTag(g,t.Fixed64),this.writeDouble(x)},writeBooleanField:function(g,x){this.writeVarintField(g,!!x)}};function o(g,x,_){var C=_.buf,y,b;if(b=C[_.pos++],y=(b&112)>>4,b<128||(b=C[_.pos++],y|=(b&127)<<3,b<128)||(b=C[_.pos++],y|=(b&127)<<10,b<128)||(b=C[_.pos++],y|=(b&127)<<17,b<128)||(b=C[_.pos++],y|=(b&127)<<24,b<128)||(b=C[_.pos++],y|=(b&1)<<31,b<128))return c(g,y,x);throw new Error("Expected varint not more than 10 bytes")}function a(g){return g.type===t.Bytes?g.readVarint()+g.pos:g.pos+1}function c(g,x,_){return _?x*4294967296+(g>>>0):(x>>>0)*4294967296+(g>>>0)}function l(g,x){var _,C;if(g>=0?(_=g%4294967296|0,C=g/4294967296|0):(_=~(-g%4294967296),C=~(-g/4294967296),_^4294967295?_=_+1|0:(_=0,C=C+1|0)),g>=18446744073709552e3||g<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");x.realloc(10),f(_,C,x),d(C,x)}function f(g,x,_){_.buf[_.pos++]=g&127|128,g>>>=7,_.buf[_.pos++]=g&127|128,g>>>=7,_.buf[_.pos++]=g&127|128,g>>>=7,_.buf[_.pos++]=g&127|128,g>>>=7,_.buf[_.pos]=g&127}function d(g,x){var _=(g&7)<<4;x.buf[x.pos++]|=_|((g>>>=3)?128:0),g&&(x.buf[x.pos++]=g&127|((g>>>=7)?128:0),g&&(x.buf[x.pos++]=g&127|((g>>>=7)?128:0),g&&(x.buf[x.pos++]=g&127|((g>>>=7)?128:0),g&&(x.buf[x.pos++]=g&127|((g>>>=7)?128:0),g&&(x.buf[x.pos++]=g&127)))))}function u(g,x,_){var C=x<=16383?1:x<=2097151?2:x<=268435455?3:Math.floor(Math.log(x)/(Math.LN2*7));_.realloc(C);for(var y=_.pos-1;y>=g;y--)_.buf[y+C]=_.buf[y]}function p(g,x){for(var _=0;_<g.length;_++)x.writeVarint(g[_])}function w(g,x){for(var _=0;_<g.length;_++)x.writeSVarint(g[_])}function A(g,x){for(var _=0;_<g.length;_++)x.writeFloat(g[_])}function h(g,x){for(var _=0;_<g.length;_++)x.writeDouble(g[_])}function m(g,x){for(var _=0;_<g.length;_++)x.writeBoolean(g[_])}function I(g,x){for(var _=0;_<g.length;_++)x.writeFixed32(g[_])}function M(g,x){for(var _=0;_<g.length;_++)x.writeSFixed32(g[_])}function v(g,x){for(var _=0;_<g.length;_++)x.writeFixed64(g[_])}function S(g,x){for(var _=0;_<g.length;_++)x.writeSFixed64(g[_])}function T(g,x){return(g[x]|g[x+1]<<8|g[x+2]<<16)+g[x+3]*16777216}function F(g,x,_){g[_]=x,g[_+1]=x>>>8,g[_+2]=x>>>16,g[_+3]=x>>>24}function E(g,x){return(g[x]|g[x+1]<<8|g[x+2]<<16)+(g[x+3]<<24)}function B(g,x,_){for(var C="",y=x;y<_;){var b=g[y],P=null,D=b>239?4:b>223?3:b>191?2:1;if(y+D>_)break;var O,L,N;D===1?b<128&&(P=b):D===2?(O=g[y+1],(O&192)===128&&(P=(b&31)<<6|O&63,P<=127&&(P=null))):D===3?(O=g[y+1],L=g[y+2],(O&192)===128&&(L&192)===128&&(P=(b&15)<<12|(O&63)<<6|L&63,(P<=2047||P>=55296&&P<=57343)&&(P=null))):D===4&&(O=g[y+1],L=g[y+2],N=g[y+3],(O&192)===128&&(L&192)===128&&(N&192)===128&&(P=(b&15)<<18|(O&63)<<12|(L&63)<<6|N&63,(P<=65535||P>=1114112)&&(P=null))),P===null?(P=65533,D=1):P>65535&&(P-=65536,C+=String.fromCharCode(P>>>10&1023|55296),P=56320|P&1023),C+=String.fromCharCode(P),y+=D}return C}function k(g,x,_){return r.decode(g.subarray(x,_))}function U(g,x,_){for(var C=0,y,b;C<x.length;C++){if(y=x.charCodeAt(C),y>55295&&y<57344)if(b)if(y<56320){g[_++]=239,g[_++]=191,g[_++]=189,b=y;continue}else y=b-55296<<10|y-56320|65536,b=null;else{y>56319||C+1===x.length?(g[_++]=239,g[_++]=191,g[_++]=189):b=y;continue}else b&&(g[_++]=239,g[_++]=191,g[_++]=189,b=null);y<128?g[_++]=y:(y<2048?g[_++]=y>>6|192:(y<65536?g[_++]=y>>12|224:(g[_++]=y>>18|240,g[_++]=y>>12&63|128),g[_++]=y>>6&63|128),g[_++]=y&63|128)}return _}return er}var Df=Of(),Lf=Qi(Df);function Nf(e){let t=0;for(let n=0;n<e.length;n++)t+=e[n]*256**(e.length-1-n);return t}function Rf(e,t){const n={};e.forEach((i,r)=>{n[i]=r});let s=e.length;n.selected=n.selected??s++,n.hovered=n.hovered??s++,n.dpi=n.dpi??s++,n.isRealtime=n.isRealtime??s++,n.pixelDensityPreset=n.pixelDensityPreset??s++,n.tier=n.tier??s++;for(const i in t)n[i]===void 0&&(n[i]=s++);return n}function Uf(e){const t=Rf(e.tileProps,e.defaultProps),n={};for(const s in e.defaultProps)n[s]={index:t[s],value:e.defaultProps[s]};return{version:e.version,dictionaries:e.enumerationValues,reverseDictionaries:Object.keys(e.enumerationValues).reduce((s,i)=>(s[i]=Gi(e.enumerationValues[i]),s),{}),tileProps:t,tilePropsByIndex:Gi(t),defaultProps:n,vertexPropsLegacy:nr(e.vertexProps)?Cf(e):{},vertexProps:nr(e.vertexProps)?[]:e.vertexProps}}function Cf(e){const t=e.vertexProps,n={point:["x","y","z"],polygon:["x","y","cut","signed_z"],polyline:["x","y"]};if(!t)return n;if(!nr(t))return console.warn(`Попытка сгенерировать vertexPropsLegacy для метатайла версии ${e.version}`),{};const s={0:"point",1:"polyline",2:"polygon"};return Object.keys(t).forEach(i=>{const r=s[i];if(typeof r>"u"){console.warn(`Неизвестный тип геометрии "${i}", нужно его поддержать`);return}n[r]=t[parseInt(i,10)]}),n}function da(e,t){const n={};if(t)for(let s=0;s<t.length;s++)n[t[s]]=s;return Uf({enumerationValues:{db_sublayer:n},version:"7.0.0",defaultProps:{},tileProps:e,vertexProps:[]})}function Hn(e,t){const{tileProps:n}=e;let s=Object.keys(n).length;for(const i of t)n[i]===void 0&&(n[i]=s,s+=1)}let fe=0;const qn={beginningIsCut:fe++,class:fe++,componentDistanceEnd:fe++,componentDistanceStart:fe++,db_icon_priority:fe++,db_label_priority:fe++,db_label2_priority:fe++,dpi:fe++,endingIsCut:fe++,height:fe++,db_hidden_by_plan_building_id:fe++,db_hidden_by_plan_id:fe++,id:fe++,isRealtime:fe++,db_label:fe++,db_label2:fe++,nextPointX:fe++,nextPointY:fe++,db_object_class:fe++,objectLength:fe++,pixelDensityPreset:fe++,previousPointX:fe++,previousPointY:fe++,db_region:fe++,selected:fe++,hovered:fe++,db_sublayer:fe++,traffic_color:fe++,traffic_road_class:fe++,traffic_road_z_level:fe++,db_tiers:fe++,model_src:fe++,linkedIds:fe++,db_model_rotation_angle:fe++,db_plan_id:fe++,traffic_color2:fe++};Gi(qn);const tr=[],Bs={};function nr(e){return!Array.isArray(e)}const kf=/\{(\w+)\}/g;function sr(e,t){return e.replace(kf,(n,s)=>t[s])}function Vf(e){const[t,n]=e.split("?");if(!n)return t;const i=n.split("&").map(r=>r.split("=")).filter(([,r])=>r!=="undefined").map(r=>r.join("=")).join("&");return i.length?`${t}?${i}`:t}function Yf(e,t){const n=sr(e,t);return Vf(n)}Array(16),yn(),yn();const ir={};var ht=ir.TileRequestUrl={};ht.read=function(e,t){return e.readFields(ht._readField,{tiles:[]},t)},ht._readField=function(e,t,n){e===1&&t.tiles.push(ht.Tile.read(n,n.readVarint()+n.pos))},ht.write=function(e,t){if(e.tiles)for(var n=0;n<e.tiles.length;n++)t.writeMessage(1,ht.Tile.write,e.tiles[n])},ht.Tile={},ht.Tile.read=function(e,t){return e.readFields(ht.Tile._readField,{x:0,y:0,zoom:0},t)},ht.Tile._readField=function(e,t,n){e===1?t.x=n.readVarint():e===2?t.y=n.readVarint():e===3&&(t.zoom=n.readVarint())},ht.Tile.write=function(e,t){e.x&&t.writeVarintField(1,e.x),e.y&&t.writeVarintField(2,e.y),e.zoom&&t.writeVarintField(3,e.zoom)};var Re=ir.TileResponseData={};Re.read=function(e,t){return e.readFields(Re._readField,{tileGroups:[]},t)},Re._readField=function(e,t,n){e===1&&t.tileGroups.push(Re.TileGroup.read(n,n.readVarint()+n.pos))},Re.write=function(e,t){if(e.tileGroups)for(var n=0;n<e.tileGroups.length;n++)t.writeMessage(1,Re.TileGroup.write,e.tileGroups[n])},Re.TileGroup={},Re.TileGroup.read=function(e,t){return e.readFields(Re.TileGroup._readField,{x:0,y:0,zoom:0,tiles:[]},t)},Re.TileGroup._readField=function(e,t,n){e===1?t.x=n.readVarint():e===2?t.y=n.readVarint():e===3?t.zoom=n.readVarint():e===4&&t.tiles.push(Re.TileGroup.Tile.read(n,n.readVarint()+n.pos))},Re.TileGroup.write=function(e,t){if(e.x&&t.writeVarintField(1,e.x),e.y&&t.writeVarintField(2,e.y),e.zoom&&t.writeVarintField(3,e.zoom),e.tiles)for(var n=0;n<e.tiles.length;n++)t.writeMessage(4,Re.TileGroup.Tile.write,e.tiles[n])},Re.TileGroup.Tile={},Re.TileGroup.Tile.read=function(e,t){return e.readFields(Re.TileGroup.Tile._readField,{regionId:0,hash:null,data:null},t)},Re.TileGroup.Tile._readField=function(e,t,n){e===1?t.regionId=n.readVarint():e===2?t.hash=n.readBytes():e===3&&(t.data=n.readBytes())},Re.TileGroup.Tile.write=function(e,t){e.regionId&&t.writeVarintField(1,e.regionId),e.hash&&t.writeBytesField(2,e.hash),e.data&&t.writeBytesField(3,e.data)};const ha=[0,0,0];function Bt(e){return{coords:e,size:Wn(e[2]),offset:jf(e)}}function ut(e){return`${e[0]}_${e[1]}_${e[2]}_${e[3]}`}function ua(e){return Ni.subdomains[Math.abs(e[0]+e[1])%Ni.subdomains.length]}function $f(e){const t=new Lf(e),n=ir.TileResponseData.read(t),{x:s,y:i,zoom:r,tiles:o}=n.tileGroups[0];return o.map(({regionId:a,hash:c,data:l})=>(l||(console.warn(`Tile ${r}_${s}_${i} from region ${a} is corrupt (has no data)`),l=new Uint8Array(0)),{data:l,regionId:a,metatileHash:Nf(c)}))}function Gf(e){return e.map(t=>({regionId:t.regionId,metatileHash:t.metatileHash}))}function zf(e){const t=Math.ceil(e.byteLength/4)*4,n=new ArrayBuffer(t);return new Uint8Array(n).set(e),n}function Zn(e,t,n){e[0]=t[0]*n.size/le+n.offset[0],e[1]=t[1]*n.size/le+n.offset[1],e[2]=t[2]}Je();function pt(e,t,n){e[0]=(t[0]-n.offset[0])*le/n.size,e[1]=(t[1]-n.offset[1])*le/n.size,e[2]=t[2]}function Wn(e){return 2**(32-e)}function rr(e){return e[0]>=0&&e[0]<=le&&e[1]>=0&&e[1]<=le}function He(e){return ft(e/Lo*le,0,st)}function pa(e){return e/le*Lo}function jf(e){const t=Wn(e[2]),n=2147483648;return Cn(e[0]*t-n,e[1]*t-n,0)}function Xf(e,t){const s=Wn(t),i=e[0]-s/2,r=e[1]-s/2;return[(i+2147483648)/s,(r+2147483648)/s,t,t]}function Hf(e,t=1){const n=Math.max(e.max[0]-e.min[0],e.max[1]-e.min[1],1)*t,s=32-Math.log(n)/Math.LN2,i=Me();return Ko(i,e),Xf(i,s)}const ga=e=>{const[t,n,s,i]=e;return[t,2**s-1-n,s,i]},bt=(e,t)=>{Zn(ha,t,e);const n=Ie.toGeo(ha);return Ie.scaleFactor(n[1])};function Jn(e,t,n){const s=[0,0,0];return Zn(s,[e,t],n),Ie.toGeo(s)}function or(e,t){return Yt.fromGeo(Jn(t[0],t[1],e))}function qf(e,t,n,s=0){return""}function Zf(e,t,n,s){if(isNaN(e.step)||isNaN(e.width))return n;const{tileProps:i,tileAttrs:r}=s,o=bt(t,[0,0]),a=le/Wn(t.coords[2])*Te*o;let c=e.step*a;if(isNaN(c)&&(c=0),c===0)return n;const l=e.width*a,f={},d=n.x,u=n.y,p=d.length;for(const E in n)f[E]=[];let w=0;const A=[w];for(let E=1;E<p;E++)w+=zo([d[E-1],u[E-1]],[d[E],u[E]]),A.push(w);const h=Me(),m=Me(),I=[0,0],M=Math.abs(w/Math.trunc(w/c)),v=[d[0],u[0]];let S=(e.stopLines?1:-1)*Math.sign(e.width),T=0,F=0;for(Xn(f,v),e.stopLines&&!r[i.beginningIsCut]&&(Pt(h,d[F],u[F],d[F+1],u[F+1]),$t(m,h),lt(I,m,S*l),It(v,v,I),Xn(f,v),T+=M/2,S=-S);T<=w;){for(;T>A[F+1];)F++;if(Pt(h,d[F],u[F],d[F+1],u[F+1]),$t(m,h),S>0)lt(I,m,S*l),It(v,v,I),lt(I,h,M/2),It(v,v,I),Xn(f,v);else{const E=Math.min(1,(T-A[F])/(A[F+1]-A[F]));ql(v,[d[F],u[F]],[d[F+1],u[F+1]],E),Xn(f,v)}S=-S,T+=M/2}return e.stopLines&&!r[i.endingIsCut]&&(lt(I,m,S*l),It(v,v,I),Xn(f,v)),f}function ar(e,t,n,s){if(!Wf(e)||e.length===0)return n;let i=Sf(n);for(const r of e){if(typeof r!="object"||!r)return console.warn(`Wrong value ${r} in modifiers list.`),null;if(!("type"in r))return console.warn(`Wrong value ${r} in modifiers list.`),null;switch(r.type){case"zigzag-modifier":i=Zf(r,t,i,s);break;default:return console.warn(`Expression with type ${r.type} cannot be used as geometry modifier.`),null}if(i===null)return null}return i}function Wf(e){return!!e&&Array.isArray(e)}const Jf=new Set(["bottomCenter","bottomRight","bottomLeft","topCenter","topRight","topLeft","rightBottom","rightCenter","rightTop","leftBottom","leftCenter","leftTop","centerCenter"]);function Kf(e){return Jf.has(e)}function Ft(e){return!Array.isArray(e)&&typeof e=="object"&&e!==null&&e.type!==void 0&&e.type!=="color"}function Qf(e){return!Array.isArray(e)&&typeof e=="object"&&e!==null&&e.type==="color"}function ma(e,t){return Array.isArray(e)?e.length>0&&e.every(n=>typeof n===t):!1}function ed(e){return ma(e,"string")}function Kn(e){return ma(e,"number")}function wa(e){return!Array.isArray(e)&&typeof e=="object"&&e!==null&&e.type==="object"}function td(e){const t=typeof e;return e===null||t==="string"||t==="number"||t==="boolean"||ed(e)||Kn(e)}function ya(e){return td(e)||Qf(e)||wa(e)}function cr(e){return Ft(e)&&e.type==="get"}function fn(e){return{type:"color",value:e}}function va(e,t,n){return`${e}_${t}_${n}`}function xa(e){return`texture-${e}`}function Ia(e,t){return e+"-"+t}function Ke(e){if(typeof e=="number"||Kn(e))return e;if(e.type==="literalArray"&&Kn(e.array))return e.array;throw new Error("Unsupported simple literal expression. Can't resolve.")}const Aa=fn([0,0,0,0]);function nd(e){return typeof e!="string"?!1:/(#(?:[0-9a-f]{2}){2,4}|#[0-9a-f]{3}|(?:rgba?|hsla?)\((?:\d+%?(?:,|\s)+){2,3}[\s\/]*[\d\.]+%?\))/i.test(e)}function Fs(e){return!!e&&typeof e=="object"&&e.type==="color"}function sd(e){return!!e&&typeof e=="object"&&e.type==="gradient-color"}function id(e){const t=e.toLowerCase();let n=Aa;switch(t[0]){case"#":n=od(t);break;case"h":n=ad(t);break;case"r":n=cd(t);break}return n}function rd(e){return e.length<7?e[0]+e[1]+e[1]+e[2]+e[2]+e[3]+e[3]+(e.length===5?e[4]+e[4]:"ff"):e.length===7?e+"ff":e}function od(e){if(!new RegExp(`^#[a-f0-9]{${e.length-1}}$`).test(e)||![4,5,7,9].includes(e.length))return Aa;const n=rd(e),s=parseInt(n[1]+n[2],16),i=parseInt(n[3]+n[4],16),r=parseInt(n[5]+n[6],16),o=parseInt(n[7]+n[8],16);return fn([s,i,r,o])}function ad(e){const t=Ma(e);t[0]/=360,t[1]/=100,t[2]/=100;const[n,s,i]=ld(t[0],t[1],t[2]),r=t[3]!==void 0?t[3]*255:255;return fn([Math.round(n),Math.round(s),Math.round(i),Math.round(r)])}function cd(e){const[t,n,s,i]=Ma(e),r=i!==void 0?i*255:255;return fn([Math.round(t),Math.round(n),Math.round(s),Math.round(r)])}function Ma(e){return e.split("(")[1].split(")")[0].split(",").map(n=>parseFloat(n))}function lr(e,t,n){return n<0&&(n+=1),n>1&&(n-=1),n<1/6?e+(t-e)*6*n:n<1/2?t:n<2/3?e+(t-e)*(2/3-n)*6:e}function ld(e,t,n){if(t===0)return[n*255,n*255,n*255];const s=n<.5?n*(1+t):n+t-n*t,i=2*n-s;return[lr(i,s,e+1/3)*255,lr(i,s,e)*255,lr(i,s,e-1/3)*255]}function fr(e){let t="",n=0;for(;n<e.length;){let s=e[n++];if(s>127){if(s>191&&s<224){if(n>=e.length)return console.error("Incomplete 2-byte sequence"),t;s=(s&31)<<6|e[n]&63}else if(s>223&&s<240){if(n+1>=e.length)return console.error("Incomplete 3-byte sequence"),t;s=(s&15)<<12|(e[n]&63)<<6|e[++n]&63}else if(s>239&&s<248){if(n+2>=e.length)return console.error("Incomplete 4-byte sequence"),t;s=(s&7)<<18|(e[n]&63)<<12|(e[++n]&63)<<6|e[++n]&63}else return console.error(`Unknown multibyte start 0x${s.toString(16)} at index ${n-1}`),t;++n}if(s<=65535)t+=String.fromCharCode(s);else if(s<=1114111)s-=65536,t+=String.fromCharCode(s>>10|55296),t+=String.fromCharCode(s&1023|56320);else return console.error(`Code point 0x${s.toString(16)} exceeds UTF-16 reach`),t}return t}const Pa=new Set;function Be(e){Pa.has(e)||(console.log(e),Pa.add(e))}const fd=2166136261,dd=16777619;function hd(e,t){let n=fd;for(const s of t)n=n^s,n=n*dd;e.randomSeed=Math.abs(n)}function ud(e,t,n){let s=.5;return e.randomSeed?(e.randomSeed=e.randomSeed*16807%2147483647,s=(e.randomSeed-1)/2147483646):Be("Resolve 'random': random seed is absent, the mean value between start and end will be used."),s*(n-t)+t}var ba=(e=>(e[e.Uniform=1]="Uniform",e[e.Labeling=2]="Labeling",e[e.Generator=3]="Generator",e))(ba||{}),Ea=(e=>(e[e.Pixels=0]="Pixels",e[e.Meters=1]="Meters",e))(Ea||{});const pd="bottomCenter",dr="__overlapped",gd="default",dn=null;function q(e,t){if(!Ft(e))return e;if(t.allowedExpressions&&!t.allowedExpressions.has(e.type))return Be(`Expression of type ${e.type} is not allowed here`),dn;switch(e.type){case"time":return yd(e,t);case"objectAttr":return Id(e,t);case"coalesce":return vd(e,t);case"all":return md(e,t);case"any":return wd(e,t);case"featureState":return Md(e,t);case"get":return _a(e,t);case"global":return Pd(e,t);case"sourceAttr":return xd(e,t);case"in":return Nd(e,t);case"interpolate":return bd(e,t);case"match":return Ed(e,t);case"step":return Td(e,t);case"to-boolean":return Fd(e,t);case"to-color":return _d(e,t);case"mappoints-to-meters":return Sd(e,t);case"meters-to-pixels":return Bd(e,t);case"!":return Od(e,t);case"==":case"!=":return Dd(e,t);case">":case"<":case">=":case"<=":return Ld(e,t);case"zoom":return t.type==="binder"||t.type==="labeling"?t.styleZoom:t.type==="generator"&&t.tileInfo?t.tileInfo.coords[3]:(Be(`Zoom expression cannot be used in ${t.type} context`),dn);case"distance":if(t.type==="binder"){const s=Ie.toGeo(t.objectCenter),i=Ie.scaleFactor(s[1])*Te;return tf(t.objectCenter,t.cameraCenter)/i}else return Be(`Distance expression can't be resolved in the ${t.type} context`),dn;case"height":return 1;case"+":return Rd(e,t);case"*":return Ud(e,t);case"^":return Cd(e,t);case"log10":return kd(e,t);case"random":return Vd(e,t);case"literalArray":return Yd(e,t);case"literalObject":return{type:"object",value:e.object};case"isBehindObjects":return t.type==="binder"?t.isBehind:(Be(`isBehindObjects expression cannot be used in ${t.type} context`),dn);case"geometry-modifier":return e.modifiers;case"line-pattern":return[e.patternType,...e.parameters.map(s=>q(s,t))];case"precompute":return t.tileData[e.precomputeIndex]??null;case"gltf-animation":return Ad(e,t);case"local-time":return Ta(e,t);case"utc-time":return Ta(e,t);default:return Be(`Not supported expression type <<${e.type}>> in ${JSON.stringify(e)}`),dn}}function md(e,t){return e.array.every(n=>q(n,t)===!0)}function wd(e,t){return e.array.some(n=>q(n,t)===!0)}function Ta(e,t){const n=Date.now()+ +(t.styleState._customUserTimeOffset||0);if(e.type==="local-time"){const s=e.offset?+(q(e.offset,t)||0)*6e4:0;return n+s}if(e.type==="utc-time"){const s=e.offset?+(q(e.offset,t)||0)*6e4:0;return n+new Date().getTimezoneOffset()*6e4+s}return n}function yd(e,t){const n=s=>{const i=q(e.timeSource,t),r=new Date(+(i||0));return s==="day-minutes-720"?(r.getHours()%12||0)*60+r.getMinutes():r.getTime()};return t.type==="binder"?(t.callBackFn&&t.callBackFn(),Array.isArray(e.format)?e.format.map(s=>n(s)):n(e.format)):n("timestamp")}function vd(e,t){for(const n of e.array){const s=q(n,t);if(s!==null)return s}return null}function xd(e,t){return t.type==="generator"?t.sourceAttrs[e.property]??null:null}function Id(e,t){return t.type==="binder"&&t.dynamicObject&&t.dynamicObject[e.property]||null}function Ad(e,t){const n={type:"animation-options"};return e.options?e.options.forEach((s,i)=>n[i]=q(s,t)):Ft(e)||(n[0]=e),n}function Md(e,t){if(t.type==="generator"){const n=t.featureAttrs[t.tileProps[e.property]]??null;return Number.isNaN(n)?null:n}else throw new Error("Feature state expression can be resolved only in generator context")}function _a(e,t){if(t.type==="generator"){let n=t.tileAttrs[t.tileProps[e.property]]??null;return typeof n=="object"&&n!==null&&!Array.isArray(n)&&(n={type:"object",value:n}),Number.isNaN(n)?null:n}else throw new Error("Get expression can be resolved only in generator context")}function Pd(e,t){const n=t.styleState[e.property];return n==null?null:typeof n=="object"&&!Array.isArray(n)?{type:"object",value:n}:n}function bd(e,t){if(e.steps.length===0)return Be("Interpolate expression contains 0 steps, cannot interpolate"),dn;const n=q(e.steps[0].value,t),s=q(e.argument,t);if(typeof s!="number")return Be(`Interpolate value resolved to non-number value: ${s} ${e.argument}`),0;if(Fs(n)){if(Ft(e.argument)&&e.argument.type==="height"){const i={type:"gradient-color",values:[],steps:[]};return e.steps.forEach(r=>{const o=de(r.key,t),a=q(r.value,t);Fs(a)&&!Number.isNaN(o)&&(i.values.push({type:"color",value:a.value}),i.steps.push(o))}),i.steps.length!==2?(Be("Gradient expression must resolve 2 steps"),dn):i}return Gd(e,s,t)}return $d(e,s,t)}function Ed(e,t){const n=q(e.input,t),s=e.cases.find(i=>i.values.has(n));return q((s==null?void 0:s.output)??e.defaultOutput,t)}function Td(e,t){const n=Number(q(e.value,t)),s=hr(e,n,t)-1;return q(e.steps[s].value,t)}function _d(e,t){const n=q(e.value,t);return nd(n)?id(n):Fs(n)?n:(console.warn(`Can't resolve expression. Must be color, but got ${n}`),fn([0,0,0,0]))}function Sd(e,t){if(t.type!=="generator"||!t.tileInfo)throw new Error("Выражение `mappoints-to-meters` можно резолвить только в контексте генератора");return q(e.value,t)/(Te*bt(t.tileInfo,[0,0]))}function Bd(e,t){const n=de(e.value,t);let s,i=n*Di/ea;if(t.type==="generator"){if(!t.tileInfo)return null;s=t.tileInfo.coords[3],i*=bt(t.tileInfo,[0,0])}else s=t.styleZoom;return i*2**(s+1)}function Fd(e,t){return!!q(e.value,t)}function Od(e,t){return!q(e.value,t)}function Dd(e,t){const n=q(e.leftValue,t),s=q(e.rightValue,t);switch(e.type){case"==":return n===s;case"!=":return n!==s}}function Ld(e,t){const n=q(e.leftValue,t);if(n===null)return null;const s=q(e.rightValue,t);if(s===null)return null;switch(e.type){case"<":return n<s;case">":return n>s;case"<=":return n<=s;case">=":return n>=s}}function Nd(e,t){const n=q(e.item,t),s=q(e.collection,t);return s===null?!1:typeof s!="object"?(Be(`InExpression second argument resolved to non-object/non-array value: ${s}`),null):Array.isArray(s)?s.some(i=>i===n):wa(s)?s.value.hasOwnProperty(n):(Be(`InExpression second argument resolved incorrectly: ${s}`),null)}function Rd(e,t){const n=e.array.map(s=>q(s,t));return Kn(n)?n.reduce((s,i)=>s+i,0):(Be(`Resolve AdditionExpression: arguments are not resolved as an array of numbers: ${n}`),null)}function Ud(e,t){const n=e.array.map(s=>q(s,t));return Kn(n)?n.reduce((s,i)=>s*i,1):(Be(`Resolve MultiplicationExpression: arguments are not resolved as an array of numbers: ${n}`),null)}function Cd(e,t){const n=q(e.base,t);if(typeof n!="number")return Be(`Resolve PowExpression: base resolved as non-number value: ${n}`),null;const s=q(e.exponent,t);return typeof s!="number"?(Be(`Resolve PowExpression: exponent resolved as non-number value: ${s}`),null):Math.pow(n,s)}function kd(e,t){const n=q(e.value,t);return typeof n!="number"?(Be(`Resolve Log10Expression: value resolved as non-number value: ${n}`),null):Math.log10(n)}function Vd(e,t){const n=q(e.start,t);if(typeof n!="number")return Be(`Resolve RandomizationExpression: start resolved as non-number value: ${n}`),null;const s=q(e.end,t);return typeof s!="number"?(Be(`Resolve RandomizationExpression: end resolved as non-number value: ${s}`),null):s<n?(Be("Resolve RandomizationExpression: end cannot be less than start."),null):ud(t,n,s)}function Yd(e,t){return e.array.map(n=>q(n,t))}function $d(e,t,n){const s=hr(e,t,n);if(s===0)return Number(q(e.steps[0].value,n));if(s===e.steps.length)return zd(e,n,t);const i=Number(q(e.steps[s-1].value,n));if(n.type==="labeling"&&n.interpolateExpressionAsStep)return i;const r=Sa(e,t,s,n),o=Number(q(e.steps[s].value,n));return(1-r)*i+r*o}function Os(e,t){const n=q(e,t);return Fs(n)?n:sd(n)?n.values[1]:(console.warn(`Can't resolve expression. Must be color, but got ${n}`),fn([0,0,0,0]))}function de(e,t,n=NaN){const s=q(e,t);return typeof s=="number"?s:n}function rt(e,t,n=""){const s=q(e,t);return typeof s=="string"?s:n}function Ds(e,t,n=pd){const s=q(e,t);return Kf(s)?s:n}function Gd(e,t,n){const s=hr(e,t,n);if(s===0)return Os(e.steps[0].value,n);if(s===e.steps.length)return Os(e.steps[e.steps.length-1].value,n);const i=Sa(e,t,s,n),r=Os(e.steps[s-1].value,n).value,o=Os(e.steps[s].value,n).value;return fn([r[0]*(1-i)+o[0]*i,r[1]*(1-i)+o[1]*i,r[2]*(1-i)+o[2]*i,r[3]*(1-i)+o[3]*i])}function zd(e,t,n){const s=e.steps[e.steps.length-1],i=e.base;return i===1?de(s.value,t):de(s.value,t)*Math.pow(i,n-de(s.key,t))}function jt(e,t,n,s){return{type:"labeling",styleZoom:e,styleState:t,interpolateExpressionAsStep:n,randomSeed:0,tileData:s}}function In(e,t,n,s,i,r,o){return{type:"generator",styleState:e,tileProps:n,tileAttrs:s,id:r,tileData:[],featureAttrs:i,sourceAttrs:t,randomSeed:0,tileInfo:o}}function hr(e,t,n){let s=0;for(;s<e.steps.length&&!(t<de(e.steps[s].key,n));)s++;return s}function Sa(e,t,n,s){const i=e.base,r=de(e.steps[n].key,s)-de(e.steps[n-1].key,s),o=t-de(e.steps[n-1].key,s);return i===1?o/r:(Math.pow(i,o)-1)/(Math.pow(i,r)-1)}function Qn(e,t,n,s=!1){const i=[];return hn(i,e,t,n),s?i:Array.from(new Set(i))}Xi();function hn(e,t,n,s){if(!Ft(t)){e.push(t);return}switch(t.type){case"all":return jd(e,t,n,s);case"match":return Xd(e,t,n,s);case"step":return Hd(e,t,n,s);case"interpolate":return qd(e,t,n,s);case"precompute":if(s){const i=s.precomputes[t.precomputeIndex].expr;hn(e,i,n,s);return}break;case"get":{if(!n){console.error("There is no context to resolve the expression. The value from data will not be added to the result.");return}const i=_a(t,n);e.push(i);return}}}function jd(e,t,n,s){t.array.forEach(i=>hn(e,i,n,s))}function Xd(e,t,n,s){hn(e,t.defaultOutput),t.cases.forEach(i=>hn(e,i.output,n,s))}function Hd(e,t,n,s){t.steps.forEach(i=>hn(e,i.value,n,s))}function qd(e,t,n,s){t.steps.forEach(i=>hn(e,i.value,n,s))}const gt=1,mt=-1,wt=[.5,.5],ot=[.5,.5],we=[.5,.5],An=[.5,.5],ur=[0,0];let Qe,ue,me,ye=0,et=0,Ue=0,Ye=0;const Zd={x:0,y:0,z:0,xn2:0,yn2:0,xn1:0,yn1:0,patternedLine:!1,noTurn:!0,leftTurn:!1,sharpTurn:!1,reverseTurn:!1,extender:[.5,.5],faExtender:[.5,.5],saExtender:[.5,.5]},Wd=1-1e-4,Jd=0,Ba=-.9;function Kd(e,t,n,s,i,r,o,a){const c=Zd;c.x=e,c.y=t,c.z=n,c.xn2=s,c.yn2=i,c.xn1=r,c.yn1=o,c.patternedLine=a;const l=s*r+i*o;return c.noTurn=l>Wd,c.leftTurn=s*-o+i*r<0,c.sharpTurn=l<Jd&&l>Ba,c.reverseTurn=l<Ba,c}function pr(e,t,n,s,i,r,o,a,c,l,f,d,u=!1){let p,w,A,h,m,I,M,v,S,T,F,E,B;if(s!==0)if(me=f,ue=d,Qe=ue.indices,et=ue.elements.offset,ye=0,Ue=0,Ye=0,e[0],t[0],s===1)p=e[0],w=t[0],A=(n==null?void 0:n[0])??0,B=0,Ot(Qe,et,0,2,1,1,2,3),xe(ue,me,0,p,w,A,1,-1,1,-1,B,!1,mt),xe(ue,me,0,p,w,A,-1,-1,-1,-1,B,!1,gt),xe(ue,me,0,p,w,A,1,1,1,1,B,!1,mt),xe(ue,me,0,p,w,A,-1,1,-1,1,B,!1,gt),ye=ye+4;else{switch(h=e[0],m=t[0],I=(n==null?void 0:n[0])??0,M=e[1],v=t[1],S=(n==null?void 0:n[1])??0,B=u?me.cDist:0,i){case ve.TileCut:dt(wt,h,m,o,a),dt(we,M,v,h,m),E=gr(M,v,S,wt[0],wt[1],we[0],we[1],u),E.noTurn?Fa(h,m,I,we[0],we[1],B):Ls(0,h,m,I,wt[0],wt[1],we[0],we[1],B,u);break;case ve.Butt:case ve.Round:dt(we,M,v,h,m),Fa(h,m,I,we[0],we[1],B),i===ve.Round&&Ls(0,h,m,I,we[0],we[1],we[0],we[1],B,u);break;default:throw new Error("LoftedLine: unknown Ending Type")}const k=s-1;for(let x=1;x<k;x++){h=e[x-1],m=t[x-1],I=(n==null?void 0:n[x-1])??0,M=e[x],v=t[x],S=(n==null?void 0:n[x])??0,T=e[x+1],F=t[x+1];const _=M-h,C=v-m;B+=Math.sqrt(_*_+C*C)/le,dt(wt,M,v,h,m),dt(we,T,F,M,v),Ls(x,M,v,S,wt[0],wt[1],we[0],we[1],B,u)}h=e[s-2],m=t[s-2],I=(n==null?void 0:n[s-2])??0,M=e[k],v=t[k],S=(n==null?void 0:n[k])??0;const U=M-h,g=v-m;switch(B+=Math.sqrt(U*U+g*g)/le,r){case ve.TileCut:dt(wt,M,v,h,m),dt(we,c,l,M,v),E=gr(M,v,S,wt[0],wt[1],we[0],we[1],u),E.noTurn?Oa(k,M,v,S,we[0],we[1],B):Da(k,B,E);break;case ve.Butt:case ve.Round:dt(we,M,v,h,m),Oa(k,M,v,S,we[0],we[1],B),r===ve.Round&&Ls(k,M,v,S,we[0],we[1],-we[0],-we[1],B,u);break;default:throw new Error("LoftedLine: unknown Ending Type")}}}function gr(e,t,n,s,i,r,o,a){const c=Kd(e,t,n,s,i,r,o,a);if(!c.noTurn&&!c.reverseTurn){oa(ot,s,i,r,o);const l=ot[0],f=ot[1];c.extender[0]=l,c.extender[1]=f,c.faExtender[0]=l-s*2,c.faExtender[1]=f-i*2,c.saExtender[0]=l-r*2,c.saExtender[1]=f-o*2}else c.extender[0]=0,c.extender[1]=0,c.faExtender[0]=0,c.faExtender[1]=0,c.saExtender[0]=0,c.saExtender[1]=0;return c}function mr(e,t,n,s,i,r,o,a,c,l){oa(ot,i,r,o,a),i*-a+r*o<0?xe(ue,me,e,t,n,s,-ot[0],-ot[1],-ot[0],-ot[1],c,!1,l):xe(ue,me,e,t,n,s,ot[0],ot[1],ot[0],ot[1],c,!1,l),ye++}function Ls(e,t,n,s,i,r,o,a,c,l){const f=gr(t,n,s,i,r,o,a,l);Da(e,c,f),Qd(e,c,f),eh(e,c,f)}function Fa(e,t,n,s,i,r){xe(ue,me,0,e,t,n,-s,-i,-s,-i,r,!1,gt),xe(ue,me,0,e,t,n,s,i,s,i,r,!1,mt),ye=ye+2,Ue=1,Ye=0}function Oa(e,t,n,s,i,r,o){const a=ye+1,c=ye;xe(ue,me,e,t,n,s,-i,-r,-i,-r,o,!1,gt),xe(ue,me,e,t,n,s,i,r,i,r,o,!1,mt),ye=ye+2,Ot(Qe,et,Ye,c,Ue,Ue,c,a),Ue=a,Ye=c}function Qd(e,t,n){if(n.noTurn)return;const s=n.sharpTurn?2:1;let i,r;n.reverseTurn||n.patternedLine&&n.sharpTurn?(i=Ye,r=Ue):n.leftTurn?(i=Ue,r=ye+s):(i=ye+s,r=Ye);const o=ye;if(wr(Qe,et,Ue,Ye,o),n.sharpTurn){const c=ye+1;n.leftTurn?Ot(Qe,et,o,c,i,i,c,r):Ot(Qe,et,o,r,c,c,r,i)}else n.leftTurn,wr(Qe,et,o,r,i);const a=n.leftTurn?gt:mt;n.sharpTurn?(n.leftTurn?dt(An,n.xn2,n.yn2,n.xn1,n.yn1):dt(An,n.xn1,n.yn1,n.xn2,n.yn2),mr(e,n.x,n.y,n.z,n.xn2,n.yn2,An[0],An[1],t,a),mr(e,n.x,n.y,n.z,An[0],An[1],n.xn1,n.yn1,t,a)):mr(e,n.x,n.y,n.z,n.xn2,n.yn2,n.xn1,n.yn1,t,a),n.reverseTurn||(n.leftTurn?xe(ue,me,e,n.x,n.y,n.z,-n.xn1,-n.yn1,-n.xn1,-n.yn1,t,!1,a):xe(ue,me,e,n.x,n.y,n.z,n.xn1,n.yn1,n.xn1,n.yn1,t,!1,a),ye++),Ye=r,Ue=i}function Da(e,t,n){if(n.noTurn)return;const s=ye+1,i=ye;if(n.reverseTurn||n.patternedLine&&n.sharpTurn?(xe(ue,me,e,n.x,n.y,n.z,-n.xn2,-n.yn2,-n.xn2,-n.yn2,t,!1,gt),xe(ue,me,e,n.x,n.y,n.z,n.xn2,n.yn2,n.xn2,n.yn2,t,!1,mt)):n.leftTurn?(xe(ue,me,e,n.x,n.y,n.z,-n.xn2,-n.yn2,n.faExtender[0],n.faExtender[1],t,!0,gt),xe(ue,me,e,n.x,n.y,n.z,n.xn2,n.yn2,n.extender[0],n.extender[1],t,!0,mt)):(xe(ue,me,e,n.x,n.y,n.z,-n.xn2,-n.yn2,-n.extender[0],-n.extender[1],t,!0,gt),xe(ue,me,e,n.x,n.y,n.z,n.xn2,n.yn2,-n.faExtender[0],-n.faExtender[1],t,!0,mt)),ye=ye+2,Ot(Qe,et,Ye,i,Ue,Ue,i,s),Ye=i,Ue=s,!n.patternedLine&&!n.reverseTurn){const r=ye+1,o=ye;n.leftTurn?(xe(ue,me,e,n.x,n.y,n.z,-n.xn2,-n.yn2,-n.xn2,-n.yn2,t,!1,0),xe(ue,me,e,n.x,n.y,n.z,0,0,0,0,t,!1,0),Ot(Qe,et,s,i,r,r,i,o)):(xe(ue,me,e,n.x,n.y,n.z,0,0,0,0,t,!1,0),xe(ue,me,e,n.x,n.y,n.z,n.xn2,n.yn2,n.xn2,n.yn2,t,!1,0),Ot(Qe,et,i,o,s,s,o,r)),ye=ye+2,Ye=o,Ue=r}}function eh(e,t,n){if(n.noTurn||n.reverseTurn)return;const s=ye+1,i=ye;if(n.patternedLine&&n.sharpTurn){xe(ue,me,e,n.x,n.y,n.z,n.xn2,n.yn2,n.xn2,n.yn2,t,!1,gt),xe(ue,me,e,n.x,n.y,n.z,-n.xn2,-n.yn2,-n.xn2,-n.yn2,t,!1,mt),ye=ye+2,Ye=i,Ue=s;return}else n.leftTurn?(xe(ue,me,e,n.x,n.y,n.z,-n.xn1,-n.yn1,n.saExtender[0],n.saExtender[1],t,!1,gt),xe(ue,me,e,n.x,n.y,n.z,n.xn1,n.yn1,n.extender[0],n.extender[1],t,!1,mt)):(xe(ue,me,e,n.x,n.y,n.z,-n.xn1,-n.yn1,-n.extender[0],-n.extender[1],t,!1,gt),xe(ue,me,e,n.x,n.y,n.z,n.xn1,n.yn1,-n.saExtender[0],-n.saExtender[1],t,!1,mt));ye=ye+2,n.leftTurn?Ot(Qe,et,Ye,i,Ue,Ue,i,s):Ot(Qe,et,Ue,Ye,s,s,Ye,i),Ye=i,Ue=s}function xe(e,t,n,s,i,r,o,a,c,l,f,d,u){const p=e.elements.offset*t.offsetMultiplier,w=p>>1,A=p<<1;if(e.views.position[p]=Y+s,e.views.position[p+1]=Y+i,e.views.extender[p]=Math.floor(c*Ae*127+.5),e.views.extender[p+1]=Math.floor(l*Ae*127+.5),t.type===cn.Patterned){const h=e,m=1e-5;h.views.texture[w]=(m+f)*Math.sign(u)}else if(t.type===cn.Striped){const h=e;h.views.texExtender[A]=De(o*Ae),h.views.texExtender[A+1]=De(a*Ae),h.views.vertexDistance[w]=f,h.views.objectLength[w]=t.oLen,"componentDistance"in e.views&&(e.views.componentDistance[w]=t.cDist)}else if(t.type===cn.Entrance){const h=e,{px:m,py:I,count:M}=t,v=n===0,S=n===M-1,T=v?n:n-1,F=v?n+1:n;Pt(ur,m[T],I[T],m[F],I[F]),h.views.direction[p]=Math.round(ur[0]*127),h.views.direction[p+1]=Math.round(ur[1]*127),h.views.type[w]=S?Gn.LineEnding:Gn.Line,h.views.texExtender[A]=De(o*(d||S?-1:1)*Ae),h.views.texExtender[A+1]=De(a*(d||S?-1:1)*Ae),h.views.vertexDistance[w]=f,h.views.objectLength[w]=t.oLen}e.views.localID[w]=t.localID,"height"in e.views&&(e.views.height[w]=r),e.elements.offset++}function wr(e,t,n,s,i){const r=e.buffer,o=e.offset;r[o]=t+n,r[o+1]=t+s,r[o+2]=t+i,e.offset=o+3}function Ot(e,t,n,s,i,r,o,a){const c=e.buffer,l=e.offset;c[l]=t+n,c[l+1]=t+s,c[l+2]=t+i,c[l+3]=t+r,c[l+4]=t+o,c[l+5]=t+a,e.offset=l+6}function Ns(e){return No*e}function yr(e){return e/No}const La=32,Na=512;function th(e,t,n,s,i){const r=[e[0][0],e[1][0]],o=_e(90+s),a=[];Zn(a,r,i);const c=Ie.toGeo(a),l=ta(c,t),f=ta(c,n),d=Math.sqrt(l**2+f**2)/2,u=Math.atan(l/-f)+Math.PI+o,p=d*Math.cos(u),w=d*Math.sin(u),A=Math.atan(-l/-f)+Math.PI+o,h=d*Math.cos(A),m=d*Math.sin(A),I=Math.atan(-l/f)+2*Math.PI+o,M=d*Math.cos(I),v=d*Math.sin(I),S=Math.atan(l/f)+o,T=d*Math.cos(S),F=d*Math.sin(S),E=[],B=[],k=[],U=[];return pt(E,[a[0]+p,a[1]+w],i),pt(B,[a[0]+h,a[1]+m],i),pt(k,[a[0]+M,a[1]+v],i),pt(U,[a[0]+T,a[1]+F],i),[[E[0],B[0],k[0],U[0]],[E[1],B[1],k[1],U[1]]]}function vr(e,t){const n=Math.max(e,t);return n*La>Na?Na/n:La}function nh(){let e=new Vt(4);return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e}var Rs={exports:{}},Us={exports:{}},sh=Us.exports,Ra;function ih(){return Ra||(Ra=1,function(e,t){(function(n,s){e.exports=s()})(sh,function(){function n(o,a,c,l,f){s(o,a,c||0,l||o.length-1,f||r)}function s(o,a,c,l,f){for(;l>c;){if(l-c>600){var d=l-c+1,u=a-c+1,p=Math.log(d),w=.5*Math.exp(2*p/3),A=.5*Math.sqrt(p*w*(d-w)/d)*(u-d/2<0?-1:1),h=Math.max(c,Math.floor(a-u*w/d+A)),m=Math.min(l,Math.floor(a+(d-u)*w/d+A));s(o,a,h,m,f)}var I=o[a],M=c,v=l;for(i(o,c,a),f(o[l],I)>0&&i(o,c,l);M<v;){for(i(o,M,v),M++,v--;f(o[M],I)<0;)M++;for(;f(o[v],I)>0;)v--}f(o[c],I)===0?i(o,c,v):(v++,i(o,v,l)),v<=a&&(c=v+1),a<=v&&(l=v-1)}}function i(o,a,c){var l=o[a];o[a]=o[c],o[c]=l}function r(o,a){return o<a?-1:o>a?1:0}return n})}(Us)),Us.exports}var Ua;function rh(){if(Ua)return Rs.exports;Ua=1,Rs.exports=t,Rs.exports.default=t;var e=ih();function t(h,m){if(!(this instanceof t))return new t(h,m);this._maxEntries=Math.max(4,h||9),this._minEntries=Math.max(2,Math.ceil(this._maxEntries*.4)),m&&this._initFormat(m),this.clear()}t.prototype={all:function(){return this._all(this.data,[])},search:function(h){var m=this.data,I=[],M=this.toBBox;if(!p(h,m))return I;for(var v=[],S,T,F,E;m;){for(S=0,T=m.children.length;S<T;S++)F=m.children[S],E=m.leaf?M(F):F,p(h,E)&&(m.leaf?I.push(F):u(h,E)?this._all(F,I):v.push(F));m=v.pop()}return I},collides:function(h){var m=this.data,I=this.toBBox;if(!p(h,m))return!1;for(var M=[],v,S,T,F;m;){for(v=0,S=m.children.length;v<S;v++)if(T=m.children[v],F=m.leaf?I(T):T,p(h,F)){if(m.leaf||u(h,F))return!0;M.push(T)}m=M.pop()}return!1},load:function(h){if(!(h&&h.length))return this;if(h.length<this._minEntries){for(var m=0,I=h.length;m<I;m++)this.insert(h[m]);return this}var M=this._build(h.slice(),0,h.length-1,0);if(!this.data.children.length)this.data=M;else if(this.data.height===M.height)this._splitRoot(this.data,M);else{if(this.data.height<M.height){var v=this.data;this.data=M,M=v}this._insert(M,this.data.height-M.height-1,!0)}return this},insert:function(h){return h&&this._insert(h,this.data.height-1),this},clear:function(){return this.data=w([]),this},remove:function(h,m){if(!h)return this;for(var I=this.data,M=this.toBBox(h),v=[],S=[],T,F,E,B;I||v.length;){if(I||(I=v.pop(),F=v[v.length-1],T=S.pop(),B=!0),I.leaf&&(E=n(h,I.children,m),E!==-1))return I.children.splice(E,1),v.push(I),this._condense(v),this;!B&&!I.leaf&&u(I,M)?(v.push(I),S.push(T),T=0,F=I,I=I.children[0]):F?(T++,I=F.children[T],B=!1):I=null}return this},toBBox:function(h){return h},compareMinX:o,compareMinY:a,toJSON:function(){return this.data},fromJSON:function(h){return this.data=h,this},_all:function(h,m){for(var I=[];h;)h.leaf?m.push.apply(m,h.children):I.push.apply(I,h.children),h=I.pop();return m},_build:function(h,m,I,M){var v=I-m+1,S=this._maxEntries,T;if(v<=S)return T=w(h.slice(m,I+1)),s(T,this.toBBox),T;M||(M=Math.ceil(Math.log(v)/Math.log(S)),S=Math.ceil(v/Math.pow(S,M-1))),T=w([]),T.leaf=!1,T.height=M;var F=Math.ceil(v/S),E=F*Math.ceil(Math.sqrt(S)),B,k,U,g;for(A(h,m,I,E,this.compareMinX),B=m;B<=I;B+=E)for(U=Math.min(B+E-1,I),A(h,B,U,F,this.compareMinY),k=B;k<=U;k+=F)g=Math.min(k+F-1,U),T.children.push(this._build(h,k,g,M-1));return s(T,this.toBBox),T},_chooseSubtree:function(h,m,I,M){for(var v,S,T,F,E,B,k,U;M.push(m),!(m.leaf||M.length-1===I);){for(k=U=1/0,v=0,S=m.children.length;v<S;v++)T=m.children[v],E=c(T),B=f(h,T)-E,B<U?(U=B,k=E<k?E:k,F=T):B===U&&E<k&&(k=E,F=T);m=F||m.children[0]}return m},_insert:function(h,m,I){var M=this.toBBox,v=I?h:M(h),S=[],T=this._chooseSubtree(v,this.data,m,S);for(T.children.push(h),r(T,v);m>=0&&S[m].children.length>this._maxEntries;)this._split(S,m),m--;this._adjustParentBBoxes(v,S,m)},_split:function(h,m){var I=h[m],M=I.children.length,v=this._minEntries;this._chooseSplitAxis(I,v,M);var S=this._chooseSplitIndex(I,v,M),T=w(I.children.splice(S,I.children.length-S));T.height=I.height,T.leaf=I.leaf,s(I,this.toBBox),s(T,this.toBBox),m?h[m-1].children.push(T):this._splitRoot(I,T)},_splitRoot:function(h,m){this.data=w([h,m]),this.data.height=h.height+1,this.data.leaf=!1,s(this.data,this.toBBox)},_chooseSplitIndex:function(h,m,I){var M,v,S,T,F,E,B,k;for(E=B=1/0,M=m;M<=I-m;M++)v=i(h,0,M,this.toBBox),S=i(h,M,I,this.toBBox),T=d(v,S),F=c(v)+c(S),T<E?(E=T,k=M,B=F<B?F:B):T===E&&F<B&&(B=F,k=M);return k},_chooseSplitAxis:function(h,m,I){var M=h.leaf?this.compareMinX:o,v=h.leaf?this.compareMinY:a,S=this._allDistMargin(h,m,I,M),T=this._allDistMargin(h,m,I,v);S<T&&h.children.sort(M)},_allDistMargin:function(h,m,I,M){h.children.sort(M);var v=this.toBBox,S=i(h,0,m,v),T=i(h,I-m,I,v),F=l(S)+l(T),E,B;for(E=m;E<I-m;E++)B=h.children[E],r(S,h.leaf?v(B):B),F+=l(S);for(E=I-m-1;E>=m;E--)B=h.children[E],r(T,h.leaf?v(B):B),F+=l(T);return F},_adjustParentBBoxes:function(h,m,I){for(var M=I;M>=0;M--)r(m[M],h)},_condense:function(h){for(var m=h.length-1,I;m>=0;m--)h[m].children.length===0?m>0?(I=h[m-1].children,I.splice(I.indexOf(h[m]),1)):this.clear():s(h[m],this.toBBox)},_initFormat:function(h){var m=["return a"," - b",";"];this.compareMinX=new Function("a","b",m.join(h[0])),this.compareMinY=new Function("a","b",m.join(h[1])),this.toBBox=new Function("a","return {minX: a"+h[0]+", minY: a"+h[1]+", maxX: a"+h[2]+", maxY: a"+h[3]+"};")}};function n(h,m,I){if(!I)return m.indexOf(h);for(var M=0;M<m.length;M++)if(I(h,m[M]))return M;return-1}function s(h,m){i(h,0,h.children.length,m,h)}function i(h,m,I,M,v){v||(v=w(null)),v.minX=1/0,v.minY=1/0,v.maxX=-1/0,v.maxY=-1/0;for(var S=m,T;S<I;S++)T=h.children[S],r(v,h.leaf?M(T):T);return v}function r(h,m){return h.minX=Math.min(h.minX,m.minX),h.minY=Math.min(h.minY,m.minY),h.maxX=Math.max(h.maxX,m.maxX),h.maxY=Math.max(h.maxY,m.maxY),h}function o(h,m){return h.minX-m.minX}function a(h,m){return h.minY-m.minY}function c(h){return(h.maxX-h.minX)*(h.maxY-h.minY)}function l(h){return h.maxX-h.minX+(h.maxY-h.minY)}function f(h,m){return(Math.max(m.maxX,h.maxX)-Math.min(m.minX,h.minX))*(Math.max(m.maxY,h.maxY)-Math.min(m.minY,h.minY))}function d(h,m){var I=Math.max(h.minX,m.minX),M=Math.max(h.minY,m.minY),v=Math.min(h.maxX,m.maxX),S=Math.min(h.maxY,m.maxY);return Math.max(0,v-I)*Math.max(0,S-M)}function u(h,m){return h.minX<=m.minX&&h.minY<=m.minY&&m.maxX<=h.maxX&&m.maxY<=h.maxY}function p(h,m){return m.minX<=h.maxX&&m.minY<=h.maxY&&m.maxX>=h.minX&&m.maxY>=h.minY}function w(h){return{children:h,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function A(h,m,I,M,v){for(var S=[m,I],T;S.length;)I=S.pop(),m=S.pop(),!(I-m<=M)&&(T=m+Math.ceil((I-m)/M/2)*M,e(h,T,m,I,v),S.push(m,T,T,I))}return Rs.exports}rh(),Je(),Je();const oh=Me(),ah=Me();nh();function ch(e,t,n){const s=nn(oh,t,e),i=nn(ah,n,e);return wn(i,s)/Hl(s)}function Ca(e,t,n,s,i){const r=yr(i);Qn(s.textureImage).forEach(o=>{if(!o.length)return;const a=n.byKey[xa(o)];if(!a){console.error(`Not found raster set with texture ${o}`);return}if(!a.isSvg)return;const c=s.textureSize;let l;if(s.lengthUnits===Ea.Meters){const[d,u=d]=c;l=[d*vr(d,d),u*vr(u,u)]}else l=lh(c);l.forEach(d=>{const[u,p]=Array.isArray(d)?d:[d,d];e.atlasPacker.packSvg(a,[{w:u,h:p}],r),a.rasters.forEach(w=>e.atlasPacker.addRastersToLoad(t,w))})})}function lh(e){return Ft(e)?e.type==="step"?e.steps.map(t=>Array.isArray(t.value)||typeof t.value=="number"?t.value:t.value.type==="literalArray"?t.value.array:(console.warn("textureSize only supports shallow step expression"),[0])):e.type==="literalArray"?[Ke(e)]:(Be(`Unsupported texture size expression of type "${e.type}". Can't resovle.`),[0]):[e]}function xr(e,t){const{tileAttrs:n,tileProps:s}=e,i=Number.isNaN(n[s.db_begin_nominal_height])?0:n[s.db_begin_nominal_height]??0,r=Number.isNaN(n[s.db_end_nominal_height])?0:n[s.db_end_nominal_height]??0,o=n[s.objectLength]??1,a=n[s.componentDistanceStart]??0,c=n[s.componentDistanceEnd]??0,l=zi(i,r,a/o),f=zi(i,r,c/o),d=e.tileInfo?bt(e.tileInfo,[0,0]):1,u=Array.from({length:t.x.length});if(l===f)return u.fill(l*Te*d),u;const p=t.x.length;for(let w=0;w<p;w++)u[w]=Te*d*zi(l,f,ch([t.x[0],t.y[0]],[t.x[p-1],t.y[p-1]],[t.x[w],t.y[w]]));return u}const qe={symbol:"line",sinks:{solid:{stride:12,binder:(e,t)=>{e.views.position=new Uint16Array(t),e.views.extender=new Int8Array(t,4),e.views.normal=new Int8Array(t,6),e.views.localID=new Uint32Array(t,8)},packObjectAttributes(e,t,n,s){return Pe([e,t.innerId,n],t,s)},unpackObjectAttributes(e){return{styleId:e[0],layerId:e[1],tiers:e[2],tileData:e.slice(3)}}},solid3d:{stride:16,binder:(e,t)=>{e.views.position=new Uint16Array(t),e.views.extender=new Int8Array(t,4),e.views.normal=new Int8Array(t,6),e.views.height=new Float32Array(t,8),e.views.localID=new Uint32Array(t,12)},packObjectAttributes(e,t,n,s){return Pe([e,t.innerId,n],t,s)},unpackObjectAttributes(e){return{styleId:e[0],layerId:e[1],tiers:e[2],tileData:e.slice(3)}}},patterned:{stride:16,binder:(e,t)=>{e.views.position=new Uint16Array(t),e.views.extender=new Int16Array(t,4),e.views.texture=new Float32Array(t,8),e.views.localID=new Uint32Array(t,12)},packObjectAttributes(e,t,n,s){return Pe([e,t.innerId,n],t,s)},unpackObjectAttributes(e){return{styleId:e[0],layerId:e[1],tiers:e[2],tileData:e.slice(3)}}},patterned3d:{stride:20,binder:(e,t)=>{e.views.position=new Uint16Array(t),e.views.extender=new Int16Array(t,4),e.views.texture=new Float32Array(t,8),e.views.height=new Float32Array(t,12),e.views.localID=new Uint32Array(t,16)},packObjectAttributes(e,t,n,s){return Pe([e,t.innerId,n],t,s)},unpackObjectAttributes(e){return{styleId:e[0],layerId:e[1],tiers:e[2],tileData:e.slice(3)}}}},generate(e,t,n,s,i,r){const o=ar(q(n.style.geometryModifier,s),i,r,s);if(o===null)return;const{tileAttrs:a,tileProps:c}=s,l=n.style.withHeight?xr(s,o):void 0,f=e.idIndexer.getIndex(s,t,n),d=q(n.ignoreTier,s)?null:s.tileAttrs[c.db_tiers],u=n.style.withHeight?e.getBucket(n.type,"solid3d",qe.sinks.solid3d.packObjectAttributes(t,n,d,s),qe.sinks.solid3d.binder):e.getBucket(n.type,"solid",qe.sinks.solid.packObjectAttributes(t,n,d,s),qe.sinks.solid.binder),p=Number.isNaN(a[c.beginningIsCut])?!1:a[c.beginningIsCut]!==0,w=Number.isNaN(a[c.endingIsCut])?!1:a[c.endingIsCut]!==0,A=rt(n.style.startCap,s),h=rt(n.style.endCap,s);aa(u,o.x,o.y,l,o.x.length,p?ve.TileCut:Cs(A),w?ve.TileCut:Cs(h),f)},generatePatterned(e,t,n,s,i,r){const o=ar(q(n.style.geometryModifier,s),i,r,s);if(o===null)return;const{tileAttrs:a,tileProps:c}=s,l=q(n.ignoreTier,s)?null:s.tileAttrs[c.db_tiers],f=n.style.withHeight?e.getBucket("line","patterned3d",qe.sinks.patterned3d.packObjectAttributes(t,n,l,s),qe.sinks.patterned3d.binder):e.getBucket("line","patterned",qe.sinks.patterned.packObjectAttributes(t,n,l,s),qe.sinks.patterned.binder),d=e.idIndexer.getIndex(s,t,n),u=fh(a[c.componentDistanceStart]/le,a[c.componentDistanceEnd]/le,a[c.objectLength]/le,d,n.style.withHeight?qe.sinks.patterned3d.stride/2:qe.sinks.patterned.stride/2),p=Number.isNaN(a[c.beginningIsCut])?!1:a[c.beginningIsCut]!==0,w=Number.isNaN(a[c.endingIsCut])?!1:a[c.endingIsCut]!==0,A=rt(n.style.startCap,s),h=rt(n.style.endCap,s),m=n.style.withHeight?xr(s,o):void 0;pr(o.x,o.y,m,o.x.length,p?ve.TileCut:Cs(A),w?ve.TileCut:Cs(h),a[c.previousPointX],a[c.previousPointY],a[c.nextPointX],a[c.nextPointY],u,f,!0)}},Mn={type:cn.Patterned,cDist:0,sLen:0,oLen:0,localID:0,offsetMultiplier:8,px:[],py:[],count:0};function fh(e,t,n,s,i){return Mn.cDist=e,Mn.sLen=t-e,Mn.oLen=n,Mn.localID=s,Mn.offsetMultiplier=i,Mn}function Cs(e){switch(e){case"round":return ve.Round;case"tilecut":return ve.TileCut;case"butt":default:return ve.Butt}}const ks={symbol:"shiftedLine",sinks:{solid:{stride:16,binder:(e,t)=>{e.views.position=new Uint16Array(t),e.views.extender=new Int8Array(t,4),e.views.normal=new Int8Array(t,6),e.views.shift=new Float32Array(t,8)},packObjectAttributes(e,t,n,s){return Pe([e,t.innerId,n],t,s)},unpackObjectAttributes(e){return{styleId:e[0],layerId:e[1],tiers:e[2],tileData:e.slice(3)}}}},generate(e,t,n,s,i){const{tileAttrs:r,tileProps:o}=s,a=Number.isNaN(r[o.beginningIsCut])?!1:r[o.beginningIsCut]!==0,c=Number.isNaN(r[o.endingIsCut])?!1:r[o.endingIsCut]!==0,l=q(n.ignoreTier,s)?null:s.tileAttrs[o.db_tiers],f=e.getBucket(n.type,"solid",ks.sinks.solid.packObjectAttributes(t,n,l,s),ks.sinks.solid.binder);aa(f,i.x,i.y,void 0,i.x.length,a?ve.TileCut:ve.Round,c?ve.TileCut:ve.Round,0,i.normal_x,i.normal_y)}};function Ge(e,t){return e===0?0:Math.min(e*2-1,(t-e)*2)}function ka(e,t,n,s,i,r,o,a,c){let l=e.elements.offset;for(let f=0;f<t;f++){const d=Ge(f,t),u=f===t-1;if(i&&i[d]===1||!i&&!u){const p=n[d],w=s[d],A=(f+1)%t,h=Ge(A,t),m=n[h],I=s[h];hh(e,l),dh(e,l,p,w,m,I,r),c?Va(e,l,c[0],c[1],c[0],c[1]):Va(e,l,p,w,m,I),o!==void 0&&"localID"in e.views&&e.views.localID!==void 0&&Ya(e.views.localID,l,o,e.elements.stride),a!==void 0&&"labelingTextureID"in e.views&&e.views.labelingTextureID!==void 0&&Ya(e.views.labelingTextureID,l,a,e.elements.stride),l=l+4}}e.elements.offset=l}function dh(e,t,n,s,i,r,o){const a=e.views.position,c=e.elements.stride/a.BYTES_PER_ELEMENT;t=t*c,a[t]=Y+n,a[t+1]=Y+s,a[t+2]=0,t+=c,a[t]=Y+n,a[t+1]=Y+s,a[t+2]=He(o),t+=c,a[t]=Y+i,a[t+1]=Y+r,a[t+2]=0,t+=c,a[t]=Y+i,a[t+1]=Y+r,a[t+2]=He(o)}function Va(e,t,n,s,i,r){const o=e.views.demPosition,a=e.elements.stride/o.BYTES_PER_ELEMENT;t=t*a,n=(n+Y)/8,s=(s+Y)/8,i=(i+Y)/8,r=(r+Y)/8,o[t]=n,o[t+1]=s,t+=a,o[t]=n,o[t+1]=s,t+=a,o[t]=i,o[t+1]=r,t+=a,o[t]=i,o[t+1]=r}function Ya(e,t,n,s){const i=s/e.BYTES_PER_ELEMENT;t=t*i,e[t]=n,e[t+=i]=n,e[t+=i]=n,e[t+=i]=n}function hh(e,t){const n=e.indices.buffer;let s=e.indices.offset;n[s++]=t,n[s++]=t+3,n[s++]=t+1,n[s++]=t,n[s++]=t+2,n[s++]=t+3,e.indices.offset=s}const Dt=[.5,.5],Lt=[.5,.5];function Ir(e,t,n,s,i,r){let o=e.elements.offset;const a=Ge(t-1,t);let c=n[a],l=s[a],f=i?i[a]:0;const d=o;for(let u=0;u<t;u++){const p=Ge(u,t),w=u===t-1,A=n[p],h=s[p],m=i?i[p]:w?0:1;f!==0&&(Pt(Lt,c,l,A,h),Ga(e,o,m,w?d:o+4),ph(e,o,c,l,A,h),r?$a(e,o,r[0],r[1],r[0],r[1]):$a(e,o,c,l,A,h),Zi(Lt),gh(e,o,Lt),mh(e,o,Lt),o=o+4),c=A,l=h,f=m}e.elements.offset=o}function Ar(e,t,n,s,i,r,o){let a=e.elements.offset;const c=Ge(t-2,t),l=Ge(t-1,t);let f=n[l],d=s[l],u=i?i[c]:1,p=i?i[l]:0;dt(Dt,n[c],s[c],f,d);let w=Dt[0],A=Dt[1];for(let h=0;h<t;h++){const m=Ge(h,t),I=h===t-1,M=n[m],v=s[m],S=i?i[m]:I?0:1;Pt(Lt,f,d,M,v);const T=Lt[1],F=-Lt[0];u!==0&&(p===0?(Dt[0]=w,Dt[1]=A):uh(Dt,w,A,T,F),Af(Lt,w,A,Dt[0],Dt[1]),Ga(e,a,0,0),wh(e,a,f,d,r,o??[f,d]),yh(e,a,Zi(Dt),Zi(Lt)),vh(e,a),a=a+4),f=M,d=v,u=p,p=S,w=T,A=F}e.elements.offset=a}function uh(e,t,n,s,i){let r,o,a;t*s+n*i>0?(r=t+s,o=n+i,a=1/Math.sqrt(r*r+o*o),e[0]=r*a,e[1]=o*a):(r=i-n,o=t-s,r!==0&&o!==0?(a=1/Math.sqrt(r*r+o*o),e[0]=r*a,e[1]=o*a):(e[0]=0,e[1]=0))}function $a(e,t,n,s,i,r){const o=e.views.demPosition,a=e.elements.stride/o.BYTES_PER_ELEMENT;t=t*a,n=(n+Y)/8,s=(s+Y)/8,i=(i+Y)/8,r=(r+Y)/8,o[t]=n,o[t+1]=s,t+=a,o[t]=n,o[t+1]=s,t+=a,o[t]=i,o[t+1]=r,t+=a,o[t]=i,o[t+1]=r}function ph(e,t,n,s,i,r){const{position:o,distance:a}=e.views,c=e.elements.stride/o.BYTES_PER_ELEMENT;t=t*c,o[t]=Y+n,o[t+1]=Y+s,o[t+2]=0,a[t]=0,t+=c,o[t]=Y+n,o[t+1]=Y+s,o[t+2]=0,a[t]=-32767,t+=c,o[t]=Y+i,o[t+1]=Y+r,o[t+2]=0,a[t]=-32767,t+=c,o[t]=Y+i,o[t+1]=Y+r,o[t+2]=0,a[t]=0}function gh(e,t,n){const s=e.elements.stride/e.views.normals.BYTES_PER_ELEMENT;t=t*s;for(let i=0;i<4;i++)e.views.normals[t]=n[0],e.views.normals[t+1]=n[1],e.views.normals[t+2]=0,e.views.normals[t+3]=0,t+=s}function mh(e,t,n){const s=e.elements.stride/e.views.direction.BYTES_PER_ELEMENT;t=t*s;for(let i=0;i<4;i++)e.views.direction[t]=n[0],e.views.direction[t+1]=n[1],e.views.direction[t+2]=0,e.views.direction[t+3]=0,t+=s}function wh(e,t,n,s,i,r){const o=e.elements.stride/e.views.position.BYTES_PER_ELEMENT;t=t*o,e.views.position[t]=Y+n,e.views.position[t+1]=Y+s,e.views.position[t+2]=0,e.views.distance[t]=32767,e.views.demPosition[t]=(Y+r[0])/8,e.views.demPosition[t+1]=(Y+r[1])/8,t+=o,e.views.position[t]=Y+n,e.views.position[t+1]=Y+s,e.views.position[t+2]=0,e.views.distance[t]=-32767,e.views.demPosition[t]=(Y+r[0])/8,e.views.demPosition[t+1]=(Y+r[1])/8,t+=o,e.views.position[t]=Y+n,e.views.position[t+1]=Y+s,e.views.position[t+2]=He(i),e.views.distance[t]=-32767,e.views.demPosition[t]=(Y+r[0])/8,e.views.demPosition[t+1]=(Y+r[1])/8,t+=o,e.views.position[t]=Y+n,e.views.position[t+1]=Y+s,e.views.position[t+2]=He(i),e.views.distance[t]=32767,e.views.demPosition[t]=(Y+r[0])/8,e.views.demPosition[t+1]=(Y+r[1])/8}function yh(e,t,n,s){const i=e.elements.stride/e.views.normals.BYTES_PER_ELEMENT;t=t*i;for(let r=0;r<4;r++)e.views.normals[t]=n[0],e.views.normals[t+1]=n[1],e.views.normals[t+2]=s[0],e.views.normals[t+3]=s[1],t+=i}function vh(e,t){const n=e.elements.stride/e.views.direction.BYTES_PER_ELEMENT;t=t*n;for(let s=0;s<4;s++)e.views.direction[t]=0,e.views.direction[t+2]=127,t+=n}function Ga(e,t,n,s){const i=e.indices.buffer;let r=e.indices.offset;i[r++]=t,i[r++]=t+1,i[r++]=t+3,i[r++]=t+3,i[r++]=t+1,i[r++]=t+2,n!==0&&(i[r++]=t+2,i[r++]=s+1,i[r++]=s+0),e.indices.offset=r}const es=Je(),ts=Je(),Nt=Je();function ns(e,t,n,s,i,r,o,a,c,l,f,d,u){Oe(es,t,n,s),Oe(ts,i,r,o),rn(Nt,ts,es),ef(ts,es)||(sn(Nt,Nt),Vn(Nt,Nt,127)),xh(e,0,1,3,3,1,2),Vs(e,es,Nt,1,a,c,l,d),Vs(e,es,Nt,-1,a,c,l,d),Vs(e,ts,Nt,-1,a,c,f,u),Vs(e,ts,Nt,1,a,c,f,u)}function Vs(e,t,n,s,i,r,o,a){const c=e.elements.offset*e.elements.stride,l=c/e.views.position.BYTES_PER_ELEMENT;if(e.views.position[l]=r?t[0]:Y+t[0],e.views.position[l+1]=r?t[1]:Y+t[1],"z"in e.views){const f=c/e.views.z.BYTES_PER_ELEMENT;e.views.z[f]=t[2]}else e.views.position[l+2]=r?t[2]:He(t[2]);if(e.views.directionDistance[c]=n[0],e.views.directionDistance[c+1]=n[1],e.views.directionDistance[c+2]=n[2],e.views.directionDistance[c+3]=s,"demPosition"in e.views){const f=c/e.views.demPosition.BYTES_PER_ELEMENT;i=i??t,e.views.demPosition[f]=(r?i[0]:Y+i[0])/8,e.views.demPosition[f+1]=(r?i[1]:Y+i[1])/8}"absZ"in e.views&&o!==void 0&&(e.views.absZ[c/e.views.absZ.BYTES_PER_ELEMENT]=o),"isPivot"in e.views&&(e.views.isPivot[c/e.views.isPivot.BYTES_PER_ELEMENT]=a??0),e.elements.offset++}function xh(e,t,n,s,i,r,o){const a=e.indices.buffer,c=e.indices.offset,l=e.elements.offset;a[c]=l+t,a[c+1]=l+n,a[c+2]=l+s,a[c+3]=l+i,a[c+4]=l+r,a[c+5]=l+o,e.indices.offset=c+6}const Ys=le/2,ss=(e,t,n,s,i,r)=>Pe([e,t.innerId,n,s,i],t,r),$s=e=>({styleId:e[0],layerId:e[1],hiddenById:e[2],floorId:e[3],isFloorStack:e[4],tileData:e.slice(5)}),Pn={symbol:"polygonExtrusion",sinks:{sideFill:{stride:20,binder:(e,t)=>{e.views.position=new Uint16Array(t),e.views.localID=new Uint32Array(t,8),e.views.demPosition=new Int16Array(t,12),e.views.labelingTextureID=new Uint32Array(t,16)},packObjectAttributes:ss,unpackObjectAttributes:$s},topFill:{stride:20,binder:(e,t)=>{e.views.position=new Uint16Array(t),e.views.localID=new Uint32Array(t,8),e.views.demPosition=new Int16Array(t,12),e.views.labelingTextureID=new Uint32Array(t,16)},packObjectAttributes:ss,unpackObjectAttributes:$s},sideStroke:{stride:20,binder:(e,t)=>{e.views.position=new Uint16Array(t),e.views.distance=new Int16Array(t,6),e.views.normals=new Int8Array(t,8),e.views.direction=new Int8Array(t,12),e.views.demPosition=new Int16Array(t,16)},packObjectAttributes:ss,unpackObjectAttributes:$s},topStroke:{stride:16,binder:(e,t)=>{e.views.position=new Uint16Array(t),e.views.directionDistance=new Int8Array(t,8),e.views.demPosition=new Int16Array(t,12)},packObjectAttributes:ss,unpackObjectAttributes:$s}},generate(e,t,n,s,i){const r=i.x,o=i.y,a=i.cut??[],c=s.tileProps.db_plan_id?s.tileAttrs[s.tileProps.db_plan_id]:"",l=s.tileAttrs[s.tileProps.db_hidden_by_plan_building_id]??"",f=s.tileAttrs[s.tileProps.db_sublayer]==="Floor_ground",d=r.length,u=s.id??"";let p;s.tileProps.db_centroid_x&&s.tileProps.db_centroid_y&&!Number.isNaN(s.tileAttrs[s.tileProps.db_centroid_x])&&!Number.isNaN(s.tileAttrs[s.tileProps.db_centroid_y])?p=[s.tileAttrs[s.tileProps.db_centroid_x],s.tileAttrs[s.tileProps.db_centroid_y]]:p=bh(r,o,a);const w=q(n.style.height,s),A=s.tileInfo?bt(s.tileInfo,[0,0]):1,h=w*Te*A,m=e.idIndexer.getIndex(s,t,n,{floorId:Number.isNaN(c)?void 0:c}),I=e.pointIndexer.getIndex(u),M=ss(t,n,l,c,f,s);if(h>0){const F=e.getBucket("polygonExtrusion","sideFill",M,Pn.sinks.sideFill.binder);let E=F.indices.offset;ka(F,d,r,o,a,h,m,I,p),F.objectsData[E]={objectId:u,size:F.indices.offset-E};const B=e.getBucket("polygonExtrusion","sideStroke",M,Pn.sinks.sideStroke.binder);c||(E=B.indices.offset,Ir(B,d,r,o,a,p),Ar(B,d,r,o,a,h,p),B.objectsData[E]={objectId:u,size:B.indices.offset-E})}const v=e.getBucket("polygonExtrusion","topFill",M,Pn.sinks.topFill.binder);let S=v.indices.offset;Ih(v,d,r,o,h,m,I,p),v.objectsData[S]={objectId:u,size:v.indices.offset-S};const T=e.getBucket("polygonExtrusion","topStroke",M,Pn.sinks.topStroke.binder);S=T.indices.offset,Ah(T,d,r,o,a,h,p),T.objectsData[S]={objectId:u,size:T.indices.offset-S}}};function Ih(e,t,n,s,i,r,o,a){let c=e.elements.offset;const l=c;Mr(e,c++,n[0],s[0],i,r,o,a),Mr(e,c++,n[1],s[1],i,r,o,a);for(let f=2;f<t;f++)Mh(e,l,f),Mr(e,c++,n[f],s[f],i,r,o,a);e.elements.offset=c}function Ah(e,t,n,s,i,r,o){for(let a=0;a<t;a++){const c=Ge(a,t);if(i&&i[c]===1){const l=Ge((a+1)%t,t);ns(e,n[c],s[c],r,n[l],s[l],r,o)}}}function Mr(e,t,n,s,i,r,o,a){const c=e.elements.stride,l=t*(c/e.views.position.BYTES_PER_ELEMENT);e.views.position[l]=Y+n,e.views.position[l+1]=Y+s,e.views.position[l+2]=He(i),e.views.position[l+3]=1,e.views.demPosition[l]=(Y+a[0])/8,e.views.demPosition[l+1]=(Y+a[1])/8;const f=t*(c/e.views.localID.BYTES_PER_ELEMENT);e.views.localID[f]=r,e.views.labelingTextureID[f]=o}function Mh(e,t,n){const s=e.indices.buffer;let i=e.indices.offset;n%2===0?(s[i++]=t+n-2,s[i++]=t+n-1,s[i++]=t+n):(s[i++]=t+n-1,s[i++]=t+n-2,s[i++]=t+n),e.indices.offset=i}function za(e){return(Ys-Math.abs(e[0]-Ys))**2+(Ys-Math.abs(e[1]-Ys))**2}function Ph(e){return e[0]===0||e[0]===le||e[1]===0||e[1]===le}function bh(e,t,n){let s,i=le**2;const r=e.length,o=yn();for(let a=0;a<r;a++){s||Jo(o,[e[a],t[a]]);const c=Ge(a,r);if(n[c]===0){const l=[e[c],t[c]],f=Ge((a+1)%r,r),d=[e[f],t[f]];if(Ph(l)){const u=za(l);u<i&&(s=l,i=u);const p=za(d);p<i&&(s=d,i=p)}else s=[(e[c]+e[f])/2,(t[c]+t[f])/2]}}return s||(s=[],Ko(s,o)),s}const is={type:cn.Striped,cDist:0,oLen:0,sLen:0,localID:0,offsetMultiplier:14,px:[],py:[],count:0};function Eh(e,t,n,s){return is.cDist=e,is.oLen=t,is.localID=n,is.offsetMultiplier=s,is}const Xt={symbol:"dashedLine",sinks:{stroke:{stride:28,binder:(e,t)=>{e.views.position=new Uint16Array(t),e.views.extender=new Int16Array(t,4),e.views.texExtender=new Int8Array(t,8),e.views.vertexDistance=new Float32Array(t,12),e.views.componentDistance=new Float32Array(t,16),e.views.objectLength=new Float32Array(t,20),e.views.localID=new Uint32Array(t,24)},packObjectAttributes(e,t,n,s){return Pe([e,t.innerId,n],t,s)},unpackObjectAttributes(e){return{styleId:e[0],layerId:e[1],tiers:e[2],tileData:e.slice(3)}}},stroke3d:{stride:32,binder:(e,t)=>{e.views.position=new Uint16Array(t),e.views.extender=new Int16Array(t,4),e.views.texExtender=new Int8Array(t,8),e.views.vertexDistance=new Float32Array(t,12),e.views.componentDistance=new Float32Array(t,16),e.views.objectLength=new Float32Array(t,20),e.views.height=new Float32Array(t,24),e.views.localID=new Uint32Array(t,28)},packObjectAttributes(e,t,n,s){return Pe([e,t.innerId,n],t,s)},unpackObjectAttributes(e){return{styleId:e[0],layerId:e[1],tiers:e[2],tileData:e.slice(3)}}}},generate(e,t,n,s,i,r){const o=ar(q(n.style.geometryModifier,s),i,r,s);if(o===null)return;const{tileAttrs:a,tileProps:c}=s,l=q(n.ignoreTier,s)?null:s.tileAttrs[c.db_tiers],f=n.style.withHeight?e.getBucket(n.type,"stroke3d",Xt.sinks.stroke3d.packObjectAttributes(t,n,l,s),Xt.sinks.stroke3d.binder):e.getBucket(n.type,"stroke",Xt.sinks.stroke.packObjectAttributes(t,n,l,s),Xt.sinks.stroke.binder),d=e.idIndexer.getIndex(s,t,n),u=Eh(a[c.componentDistanceStart]/le,a[c.objectLength]/le,d,n.style.withHeight?Xt.sinks.stroke3d.stride/2:Xt.sinks.stroke.stride/2),p=Number.isNaN(a[c.beginningIsCut])?!1:a[c.beginningIsCut]!==0,w=Number.isNaN(a[c.endingIsCut])?!1:a[c.endingIsCut]!==0,A=n.style.withHeight?xr(s,o):void 0;pr(o.x,o.y,A,o.x.length,p?ve.TileCut:ve.Butt,w?ve.TileCut:ve.Butt,a[c.previousPointX],a[c.previousPointY],a[c.nextPointX],a[c.nextPointY],u,f)}},Gs=[st/2,st/2],Ht={symbol:"buildingModel",sinks:{fill:{stride:24,binder:(e,t)=>{e.views.position=new Uint16Array(t),e.views.texCoords=new Uint16Array(t,8),e.views.localID=new Uint32Array(t,12),e.views.demPosition=new Int16Array(t,16),e.views.labelingTextureID=new Uint32Array(t,20)},packObjectAttributes:(e,t,n,s,i,r)=>Pe([e,t.innerId,n,i,s],t,r),unpackObjectAttributes:e=>({styleId:e[0],layerId:e[1],texture:e[2],id:e[3],matrix:e[4],tileData:e.slice(5)})},stroke:{stride:16,binder:(e,t)=>{e.views.position=new Uint16Array(t),e.views.directionDistance=new Int8Array(t,8),e.views.demPosition=new Int16Array(t,12)},packObjectAttributes:(e,t,n,s,i)=>Pe([e,t.innerId,s,n],t,i),unpackObjectAttributes:e=>({styleId:e[0],layerId:e[1],id:e[2],matrix:e[3],tileData:e.slice(4)})}},processSubmesh(e,t,n,s,i,r,o,a,c){const l=n.id??"",f=s.idIndexer.getIndex(n,e,t),d=s.pointIndexer.getIndex(l),u=s.getBucket(t.type,"fill",Ht.sinks.fill.packObjectAttributes(e,t,a,c,l,n),Ht.sinks.fill.binder,o);_h(u,r);for(let p=0;p<i.length;p++)Th(u,i,p,f,d)},processOuterEdge(e,t,n,s,i,r,o){const a=n.id??"",c=s.getBucket(t.type,"stroke",Ht.sinks.stroke.packObjectAttributes(e,t,o,a,n),Ht.sinks.stroke.binder);for(let l=0;l<r.length;l+=2){const f=r[l]*5,d=r[l+1]*5;ns(c,i[f],i[f+1],i[f+2],i[d],i[d+1],i[d+2],Gs,!0)}}};function Th(e,t,n,s,i){const r=e.elements.offset,o=Ht.sinks.fill.stride,a=n*5,c=r*(o/e.views.position.BYTES_PER_ELEMENT),l=r*(o/e.views.localID.BYTES_PER_ELEMENT);e.views.position[c]=t[a],e.views.position[c+1]=t[a+1],e.views.position[c+2]=t[a+2],e.views.texCoords[c]=t[a+3],e.views.texCoords[c+1]=t[a+4],e.views.localID[l]=s,e.views.demPosition[c]=Gs[0]/8,e.views.demPosition[c+1]=Gs[1]/8,e.views.labelingTextureID[l]=i,e.elements.offset++}function _h(e,t){const n=e.elements.offset;let s=e.indices.offset;for(let i=0;i<t.length;i++)e.indices.buffer[s++]=n+t[i];e.indices.offset=s}const bn=Me(),rs=Me(),En={type:cn.Entrance,offsetMultiplier:18,cDist:0,oLen:0,sLen:0,px:[],py:[],count:0,localID:0};function Sh(e,t,n,s){return En.px=e.x,En.py=e.y,En.oLen=n/le,En.count=t,En.localID=s,En}const zs={symbol:"arrow",sinks:{stroke:{stride:36,binder:(e,t)=>{e.views.position=new Uint16Array(t),e.views.segmentEnd=new Uint16Array(t,4),e.views.texExtender=new Int8Array(t,8),e.views.arrowExtender=new Int8Array(t,10),e.views.extender=new Int16Array(t,12),e.views.direction=new Int16Array(t,16),e.views.vertexDistance=new Float32Array(t,20),e.views.objectLength=new Float32Array(t,24),e.views.type=new Float32Array(t,28),e.views.localID=new Uint32Array(t,32)},packObjectAttributes(e,t,n,s){return Pe([e,t.innerId,n>2?1:0],t,s)},unpackObjectAttributes(e){return{styleId:e[0],layerId:e[1],isLongArrow:e[2],tileData:e.slice(3)}}}},generate:(e,t,n,s,i)=>{const r=i.x,o=i.y,a=i.x.length,c=Bh(r,o,a),l=e.getBucket(n.type,"stroke",zs.sinks.stroke.packObjectAttributes(t,n,a,s),zs.sinks.stroke.binder),f=e.idIndexer.getIndex(s,t,n),d=Sh(i,a,c,f);pr(i.x,i.y,void 0,a,ve.Butt,ve.Butt,0,0,0,0,d,l);let u=0;ja(l,Gn.StartBorder,r[0],o[0],r[1],o[1],0,0,u,c,f);for(let p=0;p<a-1;p++){if(p!==0){const w=r[p]-r[p-1],A=o[p]-o[p-1];u+=Math.sqrt(w*w+A*A)}ja(l,Gn.Arrow,r[p],o[p],r[p+1],o[p+1],-1,0,u,c,f)}}};function Bh(e,t,n){let s=0;for(let i=1;i<n;i++){const r=e[i]-e[i-1],o=t[i]-t[i-1];s+=Math.sqrt(r*r+o*o)}return s}function ja(e,t,n,s,i,r,o,a,c,l,f){Fh(e,1,2,0,0,2,3),js(e,t,n,s,i,r,o,a,-1,-1,c,l,!0,f),js(e,t,n,s,i,r,o,a,1,-1,c,l,!1,f),js(e,t,n,s,i,r,o,a,1,1,c,l,!1,f),js(e,t,n,s,i,r,o,a,-1,1,c,l,!0,f)}function js(e,t,n,s,i,r,o,a,c,l,f,d,u,p){const w=e.elements,A=w.stride*w.offset,h=A>>1,m=h>>1;Pt(bn,n,s,i,r),$t(rs,bn),e.views.position[h]=Y+n,e.views.position[h+1]=Y+s,e.views.segmentEnd[h]=Y+i,e.views.segmentEnd[h+1]=Y+r,e.views.texExtender[A]=De(rs[0]*l*(u?-1:1)*Ae),e.views.texExtender[A+1]=De(rs[1]*l*(u?-1:1)*Ae),e.views.arrowExtender[A]=De(c*Ae),e.views.arrowExtender[A+1]=De(l*Ae);const I=c+o,M=l+a,v=bn[0]*I+rs[0]*M,S=bn[1]*I+rs[1]*M;e.views.extender[h]=Math.round(v*Ae*127),e.views.extender[h+1]=Math.round(S*Ae*127),e.views.direction[h]=Math.round(bn[0]*127),e.views.direction[h+1]=Math.round(bn[1]*127),e.views.vertexDistance[m]=f/st,e.views.objectLength[m]=d/st,e.views.type[m]=t,e.views.localID[m]=p,e.elements.offset++}function Fh(e,t,n,s,i,r,o){const{elements:a,indices:c}=e,{buffer:l,offset:f}=c,d=a.offset;l[f]=d+t,l[f+1]=d+n,l[f+2]=d+s,l[f+3]=d+i,l[f+4]=d+r,l[f+5]=d+o,c.offset=f+6}const Pr={symbol:"circle",sinks:{fill:{stride:20,binder:(e,t)=>{e.views.flatPosition=new Uint16Array(t),e.views.ecefPosition=new Int16Array(t,6),e.views.extender=new Int16Array(t,12),e.views.localID=new Uint32Array(t,16)},packObjectAttributes:(e,t,n)=>Pe([e,t.innerId],t,n),unpackObjectAttributes:e=>({styleId:e[0],layerId:e[1],tileData:e.slice(2)})}},generate(e,t,n,s,i){const r=e.getBucket(n.type,"fill",Pr.sinks.fill.packObjectAttributes(t,n,s),Pr.sinks.fill.binder),o=e.idIndexer.getIndex(s,t,n),a=[i.x[0],i.y[0],i.z?i.z[0]:0],c=s.tileInfo?or(s.tileInfo,a):[0,0,0];Oh(r,0,2,1,0,3,2),Xs(r,a,c,-1,-1,o),Xs(r,a,c,-1,1,o),Xs(r,a,c,1,1,o),Xs(r,a,c,1,-1,o)}};function Xs(e,[t,n,s],i,r,o,a){const l=e.elements.offset*e.elements.stride>>1,f=l>>1;e.views.flatPosition[l]=Y+t,e.views.flatPosition[l+1]=Y+n,e.views.flatPosition[l+2]=He(s),e.views.ecefPosition[l]=i[0]*$e,e.views.ecefPosition[l+1]=i[1]*$e,e.views.ecefPosition[l+2]=i[2]*$e,e.views.extender[l]=r,e.views.extender[l+1]=o,e.views.localID[f]=a,e.elements.offset++}function Oh(e,t,n,s,i,r,o){const{elements:a,indices:c}=e,{buffer:l,offset:f}=c,d=a.offset;l[f]=d+t,l[f+1]=d+n,l[f+2]=d+s,l[f+3]=d+i,l[f+4]=d+r,l[f+5]=d+o,c.offset=f+6}const Tn=Me(),_n=Me(),Xa=Me(),Ha=Me(),br=(e,t,n)=>Pe([e,t.innerId],t,n),Er=e=>({styleId:e[0],layerId:e[1],tileData:e.slice(2)}),os=pa(1),qt={symbol:"lineExtrusion",sinks:{fill:{stride:12,binder:(e,t)=>{e.views.position=new Uint16Array(t),e.views.demPosition=new Int16Array(t,8)},packObjectAttributes:br,unpackObjectAttributes:Er},topStroke:{stride:16,binder:(e,t)=>{e.views.position=new Uint16Array(t),e.views.directionDistance=new Int8Array(t,8),e.views.demPosition=new Int16Array(t,12)},packObjectAttributes:br,unpackObjectAttributes:Er},sideStroke:{stride:20,binder:(e,t)=>{e.views.position=new Uint16Array(t),e.views.distance=new Int16Array(t,6),e.views.normals=new Int8Array(t,8),e.views.direction=new Int8Array(t,12),e.views.demPosition=new Int16Array(t,16)},packObjectAttributes:br,unpackObjectAttributes:Er}},generate(e,t,n,s,i){const r=i.x,o=i.y,a=r.length,c=e.getBucket(n.type,"fill",qt.sinks.fill.packObjectAttributes(t,n,s),qt.sinks.fill.binder),l=e.getBucket(n.type,"topStroke",qt.sinks.topStroke.packObjectAttributes(t,n,s),qt.sinks.topStroke.binder),f=e.getBucket(n.type,"sideStroke",qt.sinks.sideStroke.packObjectAttributes(t,n,s),qt.sinks.sideStroke.binder);for(let d=0;d<a-1;d++){const u=r[d],p=o[d],w=r[d+1],A=o[d+1];Fe(Tn,u,w),Fe(_n,p,A),Fe(Xa,w,u),Fe(Ha,A,p),ka(c,2,Tn,_n,void 0,os),ns(l,u,p,os,w,A,os),Ir(f,2,Tn,_n,void 0),Ir(f,2,Xa,Ha,void 0),Ar(f,2,Tn,_n,void 0,os)}Fe(Tn,r[a-1],r[0]),Fe(_n,o[a-1],o[0]),Ar(f,2,Tn,_n,void 0,os)}};function Dh(e){const t=Math.log(e)*256;return t+(t<0?-.5:.5)<<16>>16}function Zt(e){return e*32768+.5<<16>>>16}function Lh(e){return Math.log(e)*256+.5<<16>>16}const Tr={symbol:"raster",sinks:{fill:{stride:8,binder:(e,t)=>{e.views.position=new Uint16Array(t),e.views.txtrCoords=new Uint16Array(t,4)},packObjectAttributes(e,t,n,s,i){return Pe([e,t.innerId,s,i],t,n)},unpackObjectAttributes(e){return{styleId:e[0],layerId:e[1],textureIndex:e[2],tiers:e[3],tileData:e.slice(4)}}}},generate(e,t,n,s,i,r,o){const a=t.x,c=t.y,l=e.getBucket(i.type,"fill",Tr.sinks.fill.packObjectAttributes(n,i,s,r,o),Tr.sinks.fill.binder);let f=l.elements.offset;Nh(l.indices,f,0,1,2,2,1,3),Hs(l,f++,a[0],c[0],0,1),Hs(l,f++,a[1],c[1],1,1),Hs(l,f++,a[2],c[2],0,0),Hs(l,f++,a[3],c[3],1,0),l.elements.offset=f}};function Hs(e,t,n,s,i,r){t=t*4,e.views.position[t]=Y+n,e.views.position[t+1]=Y+s,e.views.txtrCoords[t]=Zt(i),e.views.txtrCoords[t+1]=Zt(r)}function Nh(e,t,n,s,i,r,o,a){const c=e.buffer,l=e.offset;c[l]=t+n,c[l+1]=t+s,c[l+2]=t+i,c[l+3]=t+r,c[l+4]=t+o,c[l+5]=t+a,e.offset=l+6}function Rh(e){return!!e&&e.type==="polygon"}function qa(e,t,n,s,i){return Pe([e,t.innerId,n,s],t,i)}const Uh=(e,t,n,s,i)=>Pe([e,t.innerId,n,s],t,i),Za=e=>({styleId:e[0],layerId:e[1],tiers:e[2],floorId:e[3],tileData:e.slice(4)}),Wt={symbol:"polygon",sinks:{fill:{stride:8,binder:(e,t)=>{e.views.position=new Uint16Array(t),e.views.localID=new Uint32Array(t,4)},packObjectAttributes:qa,unpackObjectAttributes:Za},stroke:{stride:8,binder:(e,t)=>{e.views.position=new Uint16Array(t),e.views.directionDistance=new Int8Array(t,4)},packObjectAttributes:qa,unpackObjectAttributes:Za},shadow:{stride:4,binder:(e,t)=>{e.views.position=new Uint16Array(t)},packObjectAttributes:Uh,unpackObjectAttributes:e=>({styleId:e[0],layerId:e[1],tiers:e[2],floorId:e[3],tileData:e.slice(4)})}},generate(e,t,n,s,i,r,o){if(s.tileAttrs[s.tileProps.db_geometry_type]==="polyline")return;const c=i.x,l=i.y,f=i.cut,d=s.tileAttrs[s.tileProps.db_plan_id]||"";Rh(n)&&o&&Ca(e,t,o,n.style,r);const u=e.idIndexer.getIndex(s,t,n,{floorId:d||void 0}),p=s.id??"",w=n.type==="polygon"&&!q(n.ignoreTier,s)?s.tileAttrs[s.tileProps.db_tiers]:null,A=e.getBucket("polygon","fill",Wt.sinks.fill.packObjectAttributes(t,n,w,d,s),Wt.sinks.fill.binder),h=A.indices.offset;Wa(A,c.length,c,l,u),A.objectsData[h]={objectId:p,size:A.indices.offset-h};const m=e.getBucket("polygon","stroke",Wt.sinks.stroke.packObjectAttributes(t,n,w,d,s),Wt.sinks.stroke.binder);if(f){const I=m.indices.offset;Ch(m,c.length,c,l,f),m.objectsData[I]={objectId:p,size:m.indices.offset-I}}}};function Wa(e,t,n,s,i){const r=e.indices.buffer;let o=e.indices.offset,a=e.elements.offset;const c=a;_r(e,a++,n[0],s[0],i),_r(e,a++,n[1],s[1],i);for(let l=2;l<t;l++)kh(r,o,c,l),_r(e,a++,n[l],s[l],i),o=o+3;e.elements.offset=a,e.indices.offset=o}function Ch(e,t,n,s,i){for(let r=0;r<t;r++){const o=Ge(r,t);if(i[o]===1){const a=Ge((r+1)%t,t);ns(e,n[o],s[o],0,n[a],s[a],0)}}}function _r(e,t,n,s,i){t=t*e.elements.stride/e.views.position.BYTES_PER_ELEMENT,e.views.position[t]=Y+n,e.views.position[t+1]=Y+s,t=t>>1,"localID"in e.views&&(e.views.localID[t]=i)}function kh(e,t,n,s){s%2===0?(e[t]=n+s-2,e[t+1]=n+s-1,e[t+2]=n+s):(e[t]=n+s-1,e[t+1]=n+s-2,e[t+2]=n+s)}function Vh(e,t,n=[],s=[]){return{x:Ja(n,e),y:Ja(s,t)}}function Ja(e,t){const n=e.reduce((i,r)=>i.concat(r),[0]).concat(t),s=n.length-1;return{coords:n.slice(n[0]===n[1]?1:0,n[s-1]===n[s]?s:s+1),isOddStretchable:Yh(e)}}function Yh(e){var t;return!((t=e==null?void 0:e[0])!=null&&t[0])}function $h(e,t,n,s,i){return[Ka(e.x,t,s[0],i),Ka(e.y,n,s[1],i)]}function Ka(e,t,n,s){if(e.coords.length<2)throw new Error("The source coords array must have at least two coordinates");return e.coords.map((i,r)=>(t+i+s*(r===0?-1:r===e.coords.length-1?1:0))/n)}function Gh(e,t,n,s,i=0,r=0){return[ec(Qa(e.x,t),s,i),ec(Qa(e.y,n),s,r)]}function Qa(e,t){const{stretchSize:n,fixSize:s}=zh(e),{coords:i,isOddStretchable:r}=e,o=t<s?s:t,a=[i[0]];for(let c=1;c<i.length;c++){const l=i[c-1],f=i[c],d=c%2===(r?1:0),u=a[a.length-1];if(!d){a.push(u+f-l);continue}a.push(Math.round((o-s)*(f-l)/n)+u)}return a}function zh({coords:e,isOddStretchable:t}){if(e.length<2)throw new Error("An axis must have at least two coordinates");if(e.length===2)return{stretchSize:e[e.length-1],fixSize:0};let n=0;for(let s=t?0:1;s<e.length-1;s=s+2)n+=e[s+1]-e[s];return{stretchSize:n,fixSize:e[e.length-1]-n}}function ec(e,t,n=0){const s=e[e.length-1]-e[0],i=e.map(r=>Math.round(r-s/2+n));return i.length===2?i[i.length-1]+=2*t:(i[0]-=t,i[i.length-1]+=t),i}function jh(e,t,n,s,i,r,o,a,c){const l=Vh(n.w,n.h,a,c),f=$h(l,n.x,n.y,t,Ro),d=Gh(l,s,i,Ro,r,o);e.set(d,f)}function Xh(e,t,n,s,i,r,o,a,c,l,f,d){const{textureX:u,textureY:p,stretchedX:w,stretchedY:A,countX:h,countY:m}=i,I=o!==-1/0?o:Sl,M=a!==1/0?a:Bl,[v,S]=d;for(let T=0;T<h-1;T++){const F=u[T],E=u[T+1],B=w[T],k=w[T+1];for(let U=0;U<m-1;U++){const g=p[U],x=p[U+1],_=A[U],C=A[U+1];tc(r,0,2,1,1,2,3),qs(r,e,t,n,s,B,_,F,g,v,S,I,M,c,l,f),qs(r,e,t,n,s,k,_,E,g,v,S,I,M,c,l,f),qs(r,e,t,n,s,B,C,F,x,v,S,I,M,c,l,f),qs(r,e,t,n,s,k,C,E,x,v,S,I,M,c,l,f)}}}const un=[0,0];function Hh(e,t,n,s,i,r,o){const{stretchedX:a,stretchedY:c}=s,l=Math.ceil((a[a.length-1]-a[0])/2),f=Math.ceil((c[c.length-1]-c[0])/2),d=r*Co/2;un[0]=a[0]+l,un[1]=c[0]+f;const u=un[0]-d,p=un[0]+d,w=un[1]-d,A=un[1]+d;return tc(i,0,2,1,1,2,3),Zs(i,e,t,n,u,w,o),Zs(i,e,t,n,p,w,o),Zs(i,e,t,n,u,A,o),Zs(i,e,t,n,p,A,o),un}function qs(e,t,n,s,i,r,o,a,c,l,f,d,u,p,w,A){let h=e.elements.offset*20;e.views.flatPosition[h]=Y+t,e.views.flatPosition[h+1]=Y+n,e.views.flatPosition[h+2]=He(s),e.views.ecefPosition[h]=i[0]*$e,e.views.ecefPosition[h+1]=i[1]*$e,e.views.ecefPosition[h+2]=i[2]*$e,e.views.cornerOffset[h]=r,e.views.cornerOffset[h+1]=-o,e.views.checkPointOffset[h]=l,e.views.checkPointOffset[h+1]=f,e.views.texCoords[h]=Zt(a),e.views.texCoords[h+1]=Zt(c),e.views.scales[h]=Lh(d),e.views.scales[h+1]=Dh(u),h=h>>1,e.views.localID[h]=p,e.views.labelingTextureID[h]=w,e.views.spritePointTextureID[h]=A,e.elements.offset++}function Zs(e,t,n,s,i,r,o){const a=e.elements,c=a.stride*a.offset>>1;e.views.position[c]=Y+t,e.views.position[c+1]=Y+n,e.views.position[c+2]=He(s),e.views.cornerOffset[c]=i,e.views.cornerOffset[c+1]=-r,e.views.labelingTextureID[c>>1]=o,a.offset++}function tc(e,t,n,s,i,r,o){const{elements:a,indices:c}=e,{buffer:l,offset:f}=c,d=a.offset;l[f]=d+t,l[f+1]=d+n,l[f+2]=d+s,l[f+3]=d+i,l[f+4]=d+r,l[f+5]=d+o,c.offset=f+6}class qh{constructor(){this.countX=0,this.countY=0,this.textureX=[],this.textureY=[],this.stretchedX=[],this.stretchedY=[]}reset(){this.countX=0,this.countY=0}set(t,n){this.countX=n[0].length,this.countY=n[1].length,this.textureX=n[0],this.textureY=n[1],this.stretchedX=t[0],this.stretchedY=t[1]}isEmpty(){return this.countX===0||this.countY===0}}var tt=(e=>(e[e.Common=0]="Common",e[e.Commercial=1]="Commercial",e[e.CommercialCity=2]="CommercialCity",e[e.CommercialPremium=3]="CommercialPremium",e[e.Landmark=4]="Landmark",e))(tt||{}),Ws=(e=>(e[e.Point=0]="Point",e[e.Line=1]="Line",e))(Ws||{}),Et=(e=>(e[e.Text=0]="Text",e[e.Icon=1]="Icon",e[e.PoiText=2]="PoiText",e[e.PoiText2=3]="PoiText2",e[e.OneWayLine=4]="OneWayLine",e[e.LineText=5]="LineText",e[e.Box=6]="Box",e))(Et||{});let Zh=Math.random;var Js=(e=>(e[e.Point=0]="Point",e[e.Line=1]="Line",e[e.OneWayLine=2]="OneWayLine",e))(Js||{});function ze(e,t){return Number.isNaN(e)?t:e}const yt=4294967295,Rt=4294967040,Wh=Rt-1,Sr={},Jh=1e6,nc=["main","parser","labeling","models"];let Br=0;nc.forEach(e=>{const t=Br+Math.floor(Wh/nc.length);Sr[e]={min:Br,max:t-Jh},Br=t});class Kh{constructor(t){this.ids=[],this.orphanIds=[],this.phases=[],this.sublayers=[],this.styleIds=[],this.layerIds=[],this.instanceIds=[],this.objectClasses=[],this.floorIds=[],this.center=[],this.strings={},this.minIdentifyIndex=Sr[t].min,this.maxIdentifyIndex=Sr[t].max,this.index=this.minIdentifyIndex}getIndex(t,n,s,i={}){const{id:r,tileProps:o,tileAttrs:a}=t,c=s.interactive,l=i.ignoreHover?!1:a[o.hovered],f=l&&s.type!=="polygon3d"||s.type==="embankment";return!!r&&c&&!l&&!f?this.getIndexInternal({id:r,styleId:n,layer:s,sublayer:a[o.db_sublayer],...i}):yt}getIndexInternal(t){var r,o,a,c;const n=this.index+this.ids.length;this.ids.push(t.id),this.floorIds.push(t.floorId??""),this.phases.push(t.layer.renderIndex),this.sublayers.push(((o=(r=t.metatile)==null?void 0:r.dictionaries.db_sublayer)==null?void 0:o[t.sublayer])??NaN),this.styleIds.push(t.styleId),this.layerIds.push(t.layer.innerId),this.instanceIds.push(t.instanceId??0);const{center:s,objectClass:i}=t;if(s?this.center.push(Math.round(s[0]),Math.round(s[1])):this.center.push(Uo,Uo),typeof i=="string"){const l=(c=(a=t.metatile)==null?void 0:a.dictionaries.db_object_class)==null?void 0:c[i];l?this.objectClasses.push(l):(this.objectClasses.push(0),this.strings[n]={objectClass:i})}else this.objectClasses.push(yt);return n}addOrphanId(t){this.orphanIds.push(t)}getIndexerStats(){return{ids:this.ids.length,orphanIds:this.orphanIds.length,floorIds:this.floorIds.length,phases:this.phases.length,sublayers:this.sublayers.length,styleIds:this.styleIds.length,layerIds:this.layerIds.length,instanceIds:this.instanceIds.length,objectClasses:this.objectClasses.length,strings:Object.keys(this.strings).length,center:this.center.length}}getPacked(){const t=this.ids,n=this.orphanIds,s=this.floorIds,i=new Float32Array(this.phases).buffer,r=new Uint32Array(this.sublayers).buffer,o=new Uint16Array(this.styleIds).buffer,a=new Uint32Array(this.layerIds).buffer,c=new Uint8Array(this.instanceIds).buffer,l=new Uint32Array(this.objectClasses).buffer,f=new Int32Array(this.center).buffer,d=this.index,u=this.index+this.ids.length-1;this.index=this.index+this.ids.length,this.index>this.maxIdentifyIndex&&(this.index=this.minIdentifyIndex);const p=this.strings;return this.ids=[],this.orphanIds=[],this.floorIds=[],this.phases=[],this.sublayers=[],this.styleIds=[],this.layerIds=[],this.instanceIds=[],this.objectClasses=[],this.strings={},this.center=[],{idBuffer:t,orphanIds:n,floorIdBuffer:s,startIndex:d,endIndex:u,phaseBuffer:i,sublayerBuffer:r,styleIdBuffer:o,layerIdBuffer:a,instanceIdBuffer:c,objectClassBuffer:l,centerBuffer:f,strings:p}}}function Fr(e){return e.pointType===tt.Commercial||e.pointType===tt.CommercialCity||e.pointType===tt.CommercialPremium}const Or=new Map;class Dr{constructor(t,n,s,i,r,o,a){if(this.anchorWorld=[0,0,0,0],this.anchorGeo=[0,0],this.groupPriority=0,this.labelingGroup=gd,this.marginTopBottom=0,this.marginLeftRight=0,this.elevation=0,this.type=n,this.label=t,this.layer=t.layer,this.elevation=t.elevation,this.id=t.id+"_"+n+"_"+Math.floor(s[0]/1e3)+"_"+Math.floor(s[1]/1e3)+this.getIconLabelPriorityToId(t),ff(this.anchorWorld,s),this.anchorGeo=t.geoPoint,i!==0&&(this.anchorWorld[2]*=i),a){const c=Yt.fromGeo(this.anchorGeo);this.anchorScreen=r.ecef.project(c,!1)}else this.anchorScreen=r.flat.project([this.anchorWorld[0],this.anchorWorld[1],this.anchorWorld[2]+this.elevation,0]);switch(this.anchorPosition=0,this.anchorSegmentIndex=0,this.halfLabelWidth=0,this.commPriorityRandomFactor=NaN,this.itemPriority=n===Et.Icon?t.iconPriority:t.labelPriority,this.layer.type){case"labelLine":this.labelingGroup=this.layer.style.labelingGroup,this.groupPriority=t.styleTextPriority;break;case"oneWayLine":this.labelingGroup=this.layer.style.labelingGroup,this.groupPriority=this.layer.style.priority;break;case"point":{if(Fr(t))if(Or.has(this.label.id))this.commPriorityRandomFactor=Or.get(this.label.id);else{const c=Zh();this.commPriorityRandomFactor=c,Or.set(this.label.id,c)}n===Et.PoiText?(this.labelingGroup=this.layer.style.allowOverlap?dr:this.layer.style.textLabelingGroup,this.groupPriority=this.layer.style.iconImage?Math.min(t.styleTextPriority,t.styleIconPriority):t.styleTextPriority,this.marginTopBottom=this.layer.style.textLabelingMargin.topBottom,this.marginLeftRight=this.layer.style.textLabelingMargin.leftRight):n===Et.PoiText2?(this.labelingGroup=this.layer.style.allowOverlap?dr:this.layer.style.textLabelingGroup2,this.groupPriority=Math.min(t.styleTextPriority,t.styleIconPriority),this.marginTopBottom=this.layer.style.textLabelingMargin.topBottom,this.marginLeftRight=this.layer.style.textLabelingMargin.leftRight):(this.labelingGroup=this.layer.style.allowOverlap?dr:this.layer.style.iconLabelingGroup,this.groupPriority=t.styleIconPriority,this.marginTopBottom=this.layer.style.iconLabelingMargin.topBottom,this.marginLeftRight=this.layer.style.iconLabelingMargin.leftRight);break}}this.labelingGroupTable=o.labelingGroups.table,this.overflowStyleZoom=-1/0,this.boxes=[],this.placementIndex=0}getIconLabelPriorityToId(t){if(Fr(t))return"";const{layer:n}=t;if(n.type==="point"){const s=t.styleIconPriority.toFixed(0),i=t.styleTextPriority.toFixed(0);return"_"+s+"_"+i}return""}}function sc(e,t,n,s,i,r){if(!e||i&&!r)return[0,0];if(!r)return[e.w/t,e.h/t];const o=Lr(n,s,r),a=Ke(n.style.iconTextPadding);return[a[3]+a[1]+o[0],a[0]+a[2]+o[1]]}function Ks(e,t,n){return Nr(de(e.style.textFontSize,t),e.style.textLineHeight,n)}function ic(e,t,n){return Nr(de(e.style.textFontSize2,t),e.style.textLineHeight,n)}function Lr(e,t,n){return Nr(de(e.style.iconTextFontSize,t),e.style.iconTextLineHeight,n)}function Nr(e,t,n){const i=e/mn.baseSize*n.maxWidth,r=e*t*n.lines.length;return[i,r]}function rc(e,t,n){const s=n[0]??0,i=n[1]??0;return[(.5-e.anchorX)*t[0]+s,(.5-e.anchorY)*t[1]+i]}function Qh(e,t,n){const s=t[0]??.5,i=t[1]??.5,r=n[0]??0,o=n[1]??0;return[(.5-s)*e[0]+r,(.5-i)*e[1]+o]}function oc(e,t,n,s,i){const r=n[0]??.5,o=n[1]??.5,a=i[0]??0,c=i[1]??0;return[e[0]/2-r*t[0]-s[3]+a,e[1]/2-o*t[1]-s[0]+c]}function Qs(e,t,n,s,i){const r=t[0],o=t[1],a=n[0],c=n[1];let l=0,f=0;const d=c/2+o/2,u=c/2-o/2,p=-d,w=-u,A=a/2+r/2,h=a/2-r/2,m=-A,I=-h;switch(e){case"bottomCenter":f=d+i;break;case"rightCenter":l=A+i;break;case"topCenter":f=p-i;break;case"leftCenter":l=m-i;break;case"bottomRight":l=h,f=d+i;break;case"topRight":l=h,f=p-i;break;case"bottomLeft":l=I,f=d+i;break;case"rightBottom":l=A+i,f=w;break;case"rightTop":l=A+i,f=u;break;case"topLeft":l=I,f=p-i;break;case"leftTop":l=m-i,f=u;break;case"leftBottom":l=m-i,f=w;break}return[l+s[0],f+s[1]]}var ei=(e=>(e[e.Static=0]="Static",e[e.Unique=1]="Unique",e[e.Loaded=2]="Loaded",e))(ei||{});let eu=1e4+1;const tu={w:0,h:0,x:0,y:0,atlasIndex:0,isPacked:!1},Rr={};function nu(e,t,n,s,i,r){const o=Ia(e,i);if(!Rr[o]){const a=eu++;Rr[o]={type:ei.Unique,isSvg:!1,index:a,key:o,name:"",fileName:"",id:e,regionId:n,url:r,rasters:t.map((c,l)=>({...tu,rasterSetIndex:a,rasterIndex:l,w:c,h:c,anchorX:s[0],anchorY:s[1]}))}}return Rr[o]}function ac(e,t,n){let s,i=1/0;for(let r=0;r<e.length;r++){const o=e[r];if(n&&!o.isPacked)continue;const a=Math.abs(o.w-t);a<i&&(s=r,i=a)}return s}function Ur(e){return!!e&&"stretchX"in e&&Array.isArray(e.stretchX)&&"stretchY"in e&&Array.isArray(e.stretchY)&&"width"in e&&typeof e.width=="number"&&"height"in e&&typeof e.height=="number"}function Cr(e,t){const n=t.precomputes;return e.map((s,i)=>{const r=n[i];return r&&r.usage===ba.Uniform?s:null})}var cc=(e=>(e[e.Icon=0]="Icon",e[e.First=1]="First",e[e.Second=2]="Second",e))(cc||{});const kr=new qh,Sn=[0,0,0];let as=[0,0,0];const Ut={symbol:"point",sinks:{raster:{stride:40,binder:(e,t)=>{e.views.flatPosition=new Uint16Array(t),e.views.ecefPosition=new Int16Array(t,6),e.views.cornerOffset=new Int16Array(t,12),e.views.checkPointOffset=new Int16Array(t,16),e.views.texCoords=new Uint16Array(t,20),e.views.scales=new Int16Array(t,24),e.views.localID=new Uint32Array(t,28),e.views.labelingTextureID=new Uint32Array(t,32),e.views.spritePointTextureID=new Uint32Array(t,36)},packObjectAttributes:(e,t,n,s,i,r)=>jn([e.styleId,e.layer.innerId,t,n,s,i],r),unpackObjectAttributes:e=>({styleId:e[0],layerId:e[1],animDirection:e[2],atlasIndex:e[3],labelTest:e[4],floorId:e[5],tileData:e.slice(6)})},text:{stride:36,binder:(e,t)=>{e.views.flatPosition=new Uint16Array(t),e.views.ecefPosition=new Int16Array(t,6),e.views.cornerOffset=new Int16Array(t,12),e.views.checkPointOffset=new Int16Array(t,16),e.views.texCoords=new Uint16Array(t,20),e.views.localID=new Uint32Array(t,24),e.views.labelingTextureID=new Uint32Array(t,28),e.views.spritePointTextureID=new Uint32Array(t,32)},packObjectAttributes:(e,t,n,s,i,r,o,a)=>jn([e.styleId,e.layer.innerId,t,n,s[0],-s[1],i,r,o],a),unpackObjectAttributes:e=>({styleId:e[0],layerId:e[1],animDirection:e[2],range:e[3],offsetX:e[4],offsetY:e[5],labelIndex:e[6],fontIndex:e[7],floorId:e[8],tileData:e.slice(9)})},labelingTexture:{stride:16,binder:(e,t)=>{e.views.position=new Uint16Array(t),e.views.cornerOffset=new Int16Array(t,8),e.views.labelingTextureID=new Uint32Array(t,12)},packObjectAttributes:(e,t=[0,0])=>jn([e.styleId,e.layer.innerId,t[0],-t[1],e.floorId],[]),unpackObjectAttributes:e=>({styleId:e[0],layerId:e[1],offsetX:e[2],offsetY:e[3],floorId:e[4],tileData:e.slice(5)})}},processElement(e,t,n,s,i,r,o){const{layer:a,label:c}=n;if(a.type!=="point")return;const l=jt(r.styleZoom,r.styleState,!0,c.tileData),f=lc(l,e,i,c),d=e.icons[rt(a.style.iconImage,l)],u=Ur(d),p=sc(f,i,a,l,u,c.iconTextMetrics),w=Ke(a.style.iconTextOffset),A=Ke(a.style.iconTextPadding);let h,m=[0,0];if(f)if(c.iconTextMetrics){const v=Ke(a.style.iconTextAnchor);h=Lr(a,l,c.iconTextMetrics),m=oc(p,h,v,A,w)}else{const v=Ke(a.style.iconOffset);m=rc(f,p,v)}pt(Sn,n.anchorWorld,o);const{globeInterStartZoom:I}=ko;if(!(!(r.globeMode&&r.zoom<I)&&!rr(Sn)))switch(as=Yt.fromGeo(n.anchorGeo),n.type){case Et.Icon:if(!f||u&&!c.iconTextMetrics)return;const v=u?d.stretchX:void 0,S=u?d.stretchY:void 0;if(ou(t,c,Sn,as,s,f,p[0]*i,p[1]*i,m[0]*i,m[1]*i,i,v==null?void 0:v.map(([F,E])=>[F*i,E*i]),S==null?void 0:S.map(([F,E])=>[F*i,E*i])),!h)return;const T=Ke(a.style.iconTextAnchor);su(e,t,n.label,Sn,as,r,s,Qh(h,T,w),a,i);return;case Et.PoiText:iu(e,t,n,Sn,as,p,r,s,m,a,i);return;case Et.PoiText2:ru(e,t,n,Sn,as,p,r,s,m,a,i);return}},getLabelingInfo(e,t,n,s,i,r){const{layer:o}=e;if(o.type!=="point")return;e.labelingElements.length=0;const a=jt(s.styleZoom,s.styleState,!0,e.tileData),c=lc(a,n,r,e),l=n.icons[rt(o.style.iconImage,a)],f=Ur(l),d=sc(c,r,o,a,f,e.iconTextMetrics);let u,p=[0,0];if(c&&(!f||e.iconTextMetrics)){if(e.iconTextMetrics){const m=Ke(o.style.iconTextAnchor),I=Ke(o.style.iconTextOffset),M=Ke(o.style.iconTextPadding);u=Lr(o,a,e.iconTextMetrics),p=oc(d,u,m,M,I)}else{const m=Ke(o.style.iconOffset);p=rc(c,d,m)}const h=new Dr(e,Et.Icon,t,s.buildingHeight,i,n,s.globeMode);h.boxes.push([-d[0]/2+p[0],-d[1]/2+p[1],d[0]/2+p[0],d[1]/2+p[1]]),e.labelingElements.push(h)}const w=rt(o.style.textFont,a);e.label.length>0&&w.length&&(au(e,t,n,d,s,i,p,o),e.label2&&cu(e,t,n,d,s,i,p,o))}};function su(e,t,n,s,i,r,o,a,c,l){const{iconTextMetrics:f}=n;if(!f||!c.style.iconTextFont)return;const d=jt(r.styleZoom,r.styleState,!1,n.tileData),u=rt(c.style.iconTextFont,d),p=e.fontNameToIndex[u]??e.fontNameToIndex[Is];Vr(t,n,0,f,s,i,o,a,c,p,l)}function iu(e,t,n,s,i,r,o,a,c,l,f){const{label:d}=n,{textMetrics:u}=d,p=jt(o.styleZoom,o.styleState,!1,d.tileData),w=rt(l.style.textFont,p);if(!w.length)return;const A=Ks(l,p,u),h=e.fontNameToIndex[w]??e.fontNameToIndex[Is],m=n.parent?Ds(l.style.textPlacement,p):"centerCenter",I=de(l.style.textOffset,p),M=Qs(m,r,A,c,I);Vr(t,d,1,d.textMetrics,s,i,a,M,l,h,f)}function ru(e,t,n,s,i,r,o,a,c,l,f){const{label:d}=n,{textMetrics:u,textMetrics2:p}=d;if(!p||!l.style.textFont2)return;const w=jt(o.styleZoom,o.styleState,!1,d.tileData),A=Ks(l,w,u),h=ic(l,w,p),m=de(l.style.textOffset,w),I=de(l.style.textOffset2??0,w,0),M=rt(l.style.textFont2,w),v=e.fontNameToIndex[M]??e.fontNameToIndex[Is],S=Qs(Ds(l.style.textPlacement,w),r,[h[0],A[1]],c,m);S[1]+=(A[1]+h[1])/2+I,Vr(t,d,2,p,s,i,a,S,l,v,f)}function Vr(e,t,n,s,i,r,o,a,c,l,f){if(n===1&&t.labelingElements.length===1){const u=e.getBucket("point","labelingTexture",Ut.sinks.labelingTexture.packObjectAttributes(t),Ut.sinks.labelingTexture.binder);t.checkPointOffset=fu(u,i,s,c,f,t.labelingTextureIndex)}const d={};for(const u of t.ranges)d[u]=e.getBucket("point","text",Ut.sinks.text.packObjectAttributes(t,o,u,a,n,l,t.floorId,Cr(t.tileData,c)),Ut.sinks.text.binder);lu(d,t,i,r,s,c,n,t.checkPointOffset)}function ou(e,t,n,s,i,r,o,a,c,l,f,d,u){if(o<=0||a<=0)return;const p=t.layer;if(p.type!=="point")return;jh(kr,Qt,r,o,a,c,l,d,u),e.atlasPacker.addRastersToLoad(t.styleId,r);const w=e.getBucket("point","labelingTexture",Ut.sinks.labelingTexture.packObjectAttributes(t),Ut.sinks.labelingTexture.binder);t.checkPointOffset=Hh(n[0],n[1],n[2],kr,w,f,t.labelingTextureIndex);const A=e.getBucket("point","raster",Ut.sinks.raster.packObjectAttributes(t,i,r.atlasIndex,d!==void 0||u!==void 0,t.floorId,Cr(t.tileData,p)),Ut.sinks.raster.binder);Xh(n[0],n[1],n[2],s,kr,A,-1/0,1/0,t.identifyIndex,t.labelingTextureIndex,t.spritePointTextureIndex,t.checkPointOffset)}function au(e,t,n,s,i,r,o,a){const{textMetrics:c}=e;if(!c)return;const l=jt(i.styleZoom,i.styleState,!1,e.tileData),f=de(a.style.textOffset,l),d=Ks(a,l,c),u=new Dr(e,Et.PoiText,t,i.buildingHeight,r,n,i.globeMode);e.labelingElements.length>0&&(u.parent=e.labelingElements[0]);const p=u.parent?Ds(a.style.textPlacement,l):"centerCenter",w=Qs(p,s,d,o,f);u.boxes.push([w[0]-d[0]/2,w[1]-d[1]/2,w[0]+d[0]/2,w[1]+d[1]/2]),e.labelingElements.push(u)}function cu(e,t,n,s,i,r,o,a){const{textMetrics:c,textMetrics2:l}=e;if(!l)return;const f=jt(i.styleZoom,i.styleState,!1,e.tileData),d=Ks(a,f,c),u=ic(a,f,l),p=de(a.style.textOffset,f),w=de(a.style.textOffset2??0,f,0),A=new Dr(e,Et.PoiText2,t,i.buildingHeight,r,n,i.globeMode);e.labelingElements.length>1?(A.parent=e.labelingElements[0],A.firstLabel=e.labelingElements[1]):e.labelingElements.length>0&&(A.parent=e.labelingElements[0],A.firstLabel=e.labelingElements[0]);const h=Qs(Ds(a.style.textPlacement,f),s,[u[0],d[1]],o,p);h[1]+=(d[1]+u[1])/2+w,A.boxes.push([h[0]-u[0]/2,h[1]-u[1]/2,h[0]+u[0]/2,h[1]+u[1]/2]),e.labelingElements.push(A)}function lc(e,t,n,s){const{rasterSets:i}=t,{layer:r}=s;if(r.type!=="point")return;let o;const a=Fr(s);if(a||s.pointType===tt.Landmark)o=i.byKey[Ia(s.id,a?"commercial":"landmark")];else{const c=rt(r.style.iconImage,e);if(c.length){const l=Ke(r.style.iconAnchor);o=i.byKey[va(c,l[0],l[1])]}}if(o){const c=de(r.style.iconWidth,e),l=ac(o.rasters,c*n,!0);if(l!==void 0)return o.rasters[l]}}const ti=[0,0];function lu(e,t,n,s,i,r,o,a){let{textLineHeight:f,textLetterSpacing:d}=r.style;o===cc.Icon&&(f=r.style.iconTextLineHeight,d=r.style.iconTextLetterSpacing);const{identifyPoiLabelIndex:u,labelingTextureIndex:p,spritePointTextureIndex:w}=t,{lines:A,maxWidth:h}=i,m=f*mn.baseSize;let I=fc(1,m,A.length);for(let M=0;M<A.length;M++){const v=A[M].width;let S=0;S=-v/2,ti[0]=S,ti[1]=I;const T=A[M].glyphs;for(let F=0;F<T.length;F++){const E=T[F];E.bitmap!==void 0&&uu(e[E.range],n,s,ti,E,u,p,w,a),ti[0]+=E.advance+mn.baseSize*d}I-=m}}const Tt=[0,0];function fu(e,t,n,s,i,r){const{lines:o,maxWidth:a}=n;if(!o.length)return Tt[0]=0,Tt[1]=0,Tt;const{textLineHeight:c}=s.style,l=c*mn.baseSize,f=-a/2,d=fc(1,l,o.length),u=a/2,p=d-(o.length-1)*l;Tt[0]=i*(f+u)/2,Tt[1]=i*(d+p)/2;const w=i*Co/2,A=Tt[0]-w,h=Tt[0]+w,m=Tt[1]+w,I=Tt[1]-w,M=e.elements.offset;return oi(e.indices,M,1,0,3,2,3,0),si(e,t,A,m,r),si(e,t,h,m,r),si(e,t,A,I,r),si(e,t,h,I,r),Tt}function du(e,t,n,s,i,r,o){const a=n[1]+s.top,c=n[0]+s.left,l=a-s.height,f=c+s.width,d=Math.sin(i),u=Math.cos(i),p=c*u-a*d,w=c*d+a*u,A=f*u-a*d,h=f*d+a*u,m=c*u-l*d,I=c*d+l*u,M=f*u-l*d,v=f*d+l*u,S=e.elements.offset;ii(e,t,p,w,s.texLeft,s.texTop,r,o),ii(e,t,A,h,s.texRight,s.texTop,r,o),ii(e,t,m,I,s.texLeft,s.texBottom,r,o),ii(e,t,M,v,s.texRight,s.texBottom,r,o),oi(e.indices,S,1,0,3,2,3,0)}function hu(e,t,n){const s=e.elements.offset,i=De(Math.cos(n)),r=De(Math.sin(n));ri(e,t,i,r,-1,-1),ri(e,t,i,r,1,-1),ri(e,t,i,r,1,1),ri(e,t,i,r,-1,1),oi(e.indices,s,0,1,2,2,3,0)}function fc(e,t,n){let s;switch(e){case 0:s=t/2+t*(n-1);break;case 2:s=-t/2;break;default:s=n&1?t*(n>>1):t/2+t*(n-1>>1)}return s}function uu(e,t,n,s,i,r,o,a,c){const l=s[1]+i.top,f=s[0]+i.left,d=l-i.height,u=f+i.width,[p,w]=c,A=e.elements.offset;ni(e,t,n,f,l,i.texLeft,i.texTop,p,w,r,o,a),ni(e,t,n,u,l,i.texRight,i.texTop,p,w,r,o,a),ni(e,t,n,f,d,i.texLeft,i.texBottom,p,w,r,o,a),ni(e,t,n,u,d,i.texRight,i.texBottom,p,w,r,o,a),oi(e.indices,A,1,0,3,2,3,0)}function ni(e,t,n,s,i,r,o,a,c,l,f,d){const u=e.elements,p=u.stride*u.offset>>1,w=p>>1;e.views.flatPosition[p]=Y+t[0],e.views.flatPosition[p+1]=Y+t[1],e.views.flatPosition[p+2]=He(t[2]),e.views.ecefPosition[p]=n[0]*$e,e.views.ecefPosition[p+1]=n[1]*$e,e.views.ecefPosition[p+2]=n[2]*$e,e.views.cornerOffset[p]=s,e.views.cornerOffset[p+1]=i,e.views.checkPointOffset[p]=a,e.views.checkPointOffset[p+1]=c,e.views.texCoords[p]=r,e.views.texCoords[p+1]=o,e.views.localID[w]=l,e.views.labelingTextureID[w]=f,e.views.spritePointTextureID[w]=d,u.offset++}function si(e,t,n,s,i){const r=e.elements,o=r.stride*r.offset>>1;e.views.position[o]=Y+t[0],e.views.position[o+1]=Y+t[1],e.views.position[o+2]=He(t[2]),e.views.cornerOffset[o]=n,e.views.cornerOffset[o+1]=s,e.views.labelingTextureID[o>>1]=i,r.offset++}function ii(e,t,n,s,i,r,o,a){const c=e.elements;let l=c.stride*c.offset>>1;e.views.position[l]=Y+t[0],e.views.position[l+1]=Y+t[1],e.views.position[l+2]=He(t[2]),e.views.texCoords[l]=i,e.views.texCoords[l+1]=r,l=l>>1,e.views.cornerOffset[l]=n,e.views.cornerOffset[l+1]=s,e.views.styleZoomLimits[l]=o,e.views.styleZoomLimits[l+1]=a,c.offset++}function ri(e,t,n,s,i,r){const o=e.elements.stride*e.elements.offset,a=o/e.views.position.BYTES_PER_ELEMENT,c=o/e.views.direction.BYTES_PER_ELEMENT;e.views.position[a]=Y+t[0],e.views.position[a+1]=Y+t[1],e.views.direction[c]=n,e.views.direction[c+1]=s,e.views.widenDirection[c]=i,e.views.widenDirection[c+1]=r,e.elements.offset++}function oi(e,t,n,s,i,r,o,a){const c=e.buffer,l=e.offset;c[l]=t+n,c[l+1]=t+s,c[l+2]=t+i,c[l+3]=t+r,c[l+4]=t+o,c[l+5]=t+a,e.offset=l+6}const Yr=[0,0,0],cs=[0,0],$r={symbol:"labelLine",sinks:{raster:{stride:28,binder:(e,t)=>{e.views.position=new Uint16Array(t),e.views.texCoords=new Uint16Array(t,8),e.views.cornerOffset=new Float32Array(t,12),e.views.styleZoomLimits=new Float32Array(t,20)},packObjectAttributes:(e,t,n,s,i,r)=>jn([e.styleId,e.layer.innerId,t,n,s,i],r),unpackObjectAttributes(e){return{styleId:e[0],layerId:e[1],animDirection:e[2],range:e[3],fontIndex:e[4],tiers:e[5],tileData:e.slice(6)}}}},processElement(e,t,n,s,i,r,o){const{label:a,anchorPosition:c,anchorSegmentIndex:l,halfLabelWidth:f,layer:d}=n;if(d.type!=="labelLine")return;const{axis:u}=a,{center:p,styleZoom:w}=r,A=jt(w,r.styleState,!1,a.tileData),h=rt(d.style.textFont,A),m=e.fontNameToIndex[h]??e.fontNameToIndex[Is],I={},M=q(d.ignoreTier,A)?null:a.tiers;for(const E of a.ranges)I[E]=t.getBucket("labelLine","raster",$r.sinks.raster.packObjectAttributes(a,s,E,m,M??null,Cr(a.tileData,d)),$r.sinks.raster.binder);const v=a.textMetrics.lines[0],S=de(d.style.textFontSize,A)/mn.baseSize,T=v.glyphs,F=pu(u,c,f,r.rotation);cs[0]=-v.width/2,cs[1]=0;for(let E=0;E<T.length;E++){const B=T[E],k=(cs[0]+B.left+B.width/2)*S*(F?-1:1),U=$i(k)||1;let g=-1/0,x=1/0;for(let _=l;_>=1&&_<u.vertexCount&&!(x<n.overflowStyleZoom);_+=U,x=g){const C=U===1?_:_-1;g=pf(gf(k,u.lengths[C]-c),p);const y=u.interpolate(c,_);pt(Yr,y,o),rr(Yr)&&B.bitmap!==void 0&&du(I[B.range],Yr,cs,B,y[3]+(F?Math.PI:0),Math.max(g,n.overflowStyleZoom),x)}cs[0]+=B.advance+mn.baseSize*d.style.textLetterSpacing}},getLabelingInfo(){}};function pu(e,t,n,s){const i=e.interpolate(t-n,e.getSegmentIndex(t-n)),r=e.interpolate(t+n,e.getSegmentIndex(t+n)),o=Math.atan2(r[1]-i[1],r[0]-i[0])-s;return Math.cos(o)<0}const Gr=[0,0,0],zr={symbol:"oneWayLine",sinks:{raster:{stride:12,binder:(e,t)=>{e.views.position=new Uint16Array(t),e.views.direction=new Int8Array(t,8),e.views.widenDirection=new Int8Array(t,10)},packObjectAttributes:(e,t,n)=>jn([e.styleId,e.layer.innerId,t,n],e.tileData),unpackObjectAttributes:e=>({styleId:e[0],layerId:e[1],animDirection:e[2],tiers:e[3],tileData:e.slice(4)})}},processElement(e,t,n,s,i,r,o){const{label:a,anchorWorld:c}=n;if(pt(Gr,c,o),!rr(Gr))return;const l=t.getBucket("oneWayLine","raster",zr.sinks.raster.packObjectAttributes(a,s,a.tiers??null),zr.sinks.raster.binder);hu(l,Gr,c[3])},getLabelingInfo(){}},Bn={symbol:"heatmap",sinks:{fill:{stride:8,binder:(e,t)=>{e.views.position=new Float32Array(t)},packObjectAttributes:(e,t,n,s)=>[e,t.innerId,n,s],unpackObjectAttributes:e=>({styleId:e[0],layerId:e[1],textureIndex:e[2],rampTextureIndex:e[3],tileData:e.slice(4)})},framebuffer:{stride:12,binder:(e,t)=>{e.views.position=new Uint16Array(t),e.views.weight=new Float32Array(t,4),e.views.widen=new Int8Array(t,8)},packObjectAttributes:(e,t)=>[e,t],unpackObjectAttributes:e=>({styleId:e[0],layerId:e[1],tileData:e.slice(2)})}},generate(e,t,n,s,i){const r=s.x,o=s.y,a=Number(q(n.style.weight,i));if(Number.isNaN(a)){console.error("Can't resolve style.weight to number");return}const c=e.getBucket(n.type,"framebuffer",Bn.sinks.framebuffer.packObjectAttributes(t,n.innerId),Bn.sinks.framebuffer.binder);for(let l=0;l<r.length;l++)mu(c,0,1,2,2,1,3),ci(c,r[l],o[l],-1,-1,a),ci(c,r[l],o[l],1,-1,a),ci(c,r[l],o[l],-1,1,a),ci(c,r[l],o[l],1,1,a)},generateTexture(e,t,n,s,i){const r=[-1,1,1,-1],o=[-1,-1,1,1],a=e.getBucket(n.type,"fill",Bn.sinks.fill.packObjectAttributes(t,n,s,i),Bn.sinks.fill.binder);let c=a.elements.offset;gu(a.indices,c,0,1,2,0,2,3),ai(a,c++,r[0],o[0]),ai(a,c++,r[1],o[1]),ai(a,c++,r[2],o[2]),ai(a,c++,r[3],o[3]),a.elements.offset=c}};function ai(e,t,n,s){const i=t*2;e.views.position[i]=n,e.views.position[i+1]=s}function gu(e,t,n,s,i,r,o,a){const c=e.buffer,l=e.offset;c[l]=t+n,c[l+1]=t+s,c[l+2]=t+i,c[l+3]=t+r,c[l+4]=t+o,c[l+5]=t+a,e.offset=l+6}function ci(e,t,n,s,i,r){const o=e.elements.offset*e.elements.stride,a=o>>1,c=a>>1;e.views.position[a]=Y+t,e.views.position[a+1]=Y+n,e.views.weight[c]=r,e.views.widen[o]=s,e.views.widen[o+1]=i,e.elements.offset++}function mu(e,t,n,s,i,r,o){const{elements:a,indices:c}=e,{buffer:l,offset:f}=c,d=a.offset;l[f]=d+t,l[f+1]=d+n,l[f+2]=d+s,l[f+3]=d+i,l[f+4]=d+r,l[f+5]=d+o,c.offset=f+6}let wu=0;function dc(){return wu++}const yu=dc();dc();const hc={stride:4,binder:(e,t)=>{},packObjectAttributes(e,t){return[e,t]},unpackObjectAttributes(e){return{styleId:e[0],layerId:e[1],tileData:e.slice(3)}}},jr={stride:20,binder:(e,t)=>{e.views.position=new Uint16Array(t),e.views.normal=new Float32Array(t,4),e.views.height=new Float32Array(t,16)},packObjectAttributes(e,t){return[e,t]},unpackObjectAttributes(e){return{styleId:e[0],layerId:e[1],tileData:e.slice(2)}}},at={symbol:"dem",sinks:{mesh:hc,ground:hc,mesh2:jr,ground2:jr,elevation:jr,hillshade:{stride:8,binder:(e,t)=>{},packObjectAttributes(e,t){return[e,t]},unpackObjectAttributes(e){return{styleId:e[0],layerId:e[1],tileData:e.slice(2)}}},flatBottom:{stride:12,binder:(e,t)=>{e.views.position=new Uint16Array(t),e.views.demPosition=new Int16Array(t,4),e.views.extender=new Int8Array(t,8)},packObjectAttributes(e,t,n){return n?[e,t,n]:[e,t]},unpackObjectAttributes(e){return{styleId:e[0],layerId:e[1],matrix:e[2]?e[2]:void 0,tileData:e.slice(3)}}}},generateMeshElevation(e,t,n,s){const i=e.getBucket("dem","elevation",at.sinks.elevation.packObjectAttributes(n,s),at.sinks.elevation.binder),r=e.getBucket("dem","mesh2",at.sinks.mesh2.packObjectAttributes(n,s),at.sinks.mesh2.binder),o=e.getBucket("dem","ground2",at.sinks.ground2.packObjectAttributes(n,s),at.sinks.ground2.binder);Hr(i,t),Hr(r,t),Hr(o,t)},generateHillshade(e,t,n,s){const i=new Uint16Array(t.reduce((o,a)=>{const[c,l,f,d]=a;return o.push(c*le,l*le,Zt(f),Zt(d)),o},[]));return{symbol:at.symbol,sink:"hillshade",buffer:i.buffer,generatedObjects:[{drawMode:Li,attributes:at.sinks.hillshade.packObjectAttributes(n,s),rangeStart:0,rangeEnd:i.buffer.byteLength,extents:new Uint16Array(6)}]}},generateFloorsBottomFill(e,t,n,s,i,r){const o=n[0],a=n[1],c=n[0].length,l=at.sinks.flatBottom.packObjectAttributes(t,yu,r),f=e.getBucket("dem","flatBottom",l,at.sinks.flatBottom.binder);vu(f,c,o,a,s,i,!!r)}};function vu(e,t,n,s,i,r,o){let a=e.elements.offset;const c=a;if(!(t<3)){Xr(e,a++,n[0],s[0],r,i[0],o),Xr(e,a++,n[1],s[1],r,i[1],o);for(let l=2;l<t;l++)xu(e,c,l),Xr(e,a++,n[l],s[l],r,i[l],o);e.elements.offset=a}}function Xr(e,t,n,s,i,r,o){const a=t*(e.elements.stride/e.views.position.BYTES_PER_ELEMENT),c=t*(e.elements.stride/e.views.extender.BYTES_PER_ELEMENT);e.views.position[a]=o?n:Y+n,e.views.position[a+1]=o?s:Y+s,e.views.demPosition[a]=(o?i[0]:Y+i[0])/8,e.views.demPosition[a+1]=(o?i[1]:Y+i[1])/8,e.views.extender[c]=r[0]*127,e.views.extender[c+1]=r[1]*127}function xu(e,t,n){const s=e.indices.buffer;let i=e.indices.offset;n%2===0?(s[i++]=t+n-2,s[i++]=t+n-1,s[i++]=t+n):(s[i++]=t+n-1,s[i++]=t+n-2,s[i++]=t+n),e.indices.offset=i}function Hr(e,t){for(let n=0;n<t.indices.length;n++){const s=t.indices[n],i=e.elements.offset*(e.elements.stride/e.views.position.BYTES_PER_ELEMENT);e.views.position[i]=Y+t.vertices[s*3],e.views.position[i+1]=Y+t.vertices[s*3+1];const r=e.elements.offset*(e.elements.stride/e.views.normal.BYTES_PER_ELEMENT);e.views.normal[r]=t.normals[s*3],e.views.normal[r+1]=t.normals[s*3+1],e.views.normal[r+2]=t.normals[s*3+2];const o=e.elements.offset*(e.elements.stride/e.views.height.BYTES_PER_ELEMENT);e.views.height[o]=t.vertices[s*3+2],e.elements.offset++,e.indices.buffer[e.indices.offset]=n,e.indices.offset++}}const Iu=new Set(kl),Au=new Set(Vo),Mu=new Set(Yo);new Set(Yl);const Pu=new Set($l);new Set(Vl);function qr(e){return Iu.has(e)}function bu(e){return Au.has(e)}function Eu(e){return Mu.has(e)}function uc(e){return Pu.has(e)}const Tu=(e,t,n,s,i,r,o,a,c,l,f)=>{const{tileProps:d,tileAttrs:u}=s;if(_u(e,t,n,s,l,f),f)return;let p=tt.Common;const w=u[d.db_sublayer];bu(w)?p=tt.CommercialCity:Eu(w)?p=tt.CommercialPremium:qr(w)?p=tt.Commercial:uc(w)&&(p=tt.Landmark);const A=c.x.length===1?Ws.Point:Ws.Line;let h=[],m;if(A===Ws.Point){if(s&&n.style.allowElevation){const U=de(n.style.elevation,s);if(Number.isNaN(U))typeof c.z<"u"&&(c.z=[r<4?pa(c.z[0]):c.z[0]]);else{const g=U*Te*bt(Bt(o),[c.x[0],c.y[0]]);c.z=[g]}}h=[[c.x[0]],[c.y[0]],typeof c.z<"u"?[c.z[0]]:[0]],m=[0,0,0],Zn(m,[h[0][0],h[1][0],h[2][0]],Bt(o))}else h=[c.x,c.y];const I=s.id??"",M=p===tt.Commercial||p===tt.CommercialCity||p===tt.CommercialPremium,v=d.db_plan_id&&!M?u[d.db_plan_id]:"";let S=yt,T=yt;Number.isNaN(I)||(S=e.idIndexer.getIndex(s,t.id,n,{objectClass:u[d.db_object_class],instanceId:0,metatile:i,center:m,floorId:v,ignoreHover:!0}),T=e.idIndexer.getIndex(s,t.id,n,{objectClass:u[d.db_object_class],instanceId:1,metatile:i,center:m,floorId:v,ignoreHover:!0}));const F=u[d.db_point_building_id],E=e.pointIndexer.getIndex(F),B=e.pointIndexer.getIndex(I),k={type:Js.Point,pointType:p,geometryType:A,styleId:t.id,layerId:n.innerId,sourceId:a,tileCoords:o,id:s.id??"",floorId:v,identifyIndex:S,identifyPoiLabelIndex:T,labelingTextureIndex:E,spritePointTextureIndex:B,labelPriority:ze(u[d.db_label_priority],0),label2Priority:ze(u[d.db_label2_priority],0),styleIconPriority:de(n.style.iconPriority,s),styleTextPriority:de(n.style.textPriority,s),iconPriority:ze(u[d.db_icon_priority],0),hovered:ze(u[d.hovered],0),componentDistanceStart:ze(u[d.componentDistanceStart],0),componentDistanceEnd:ze(u[d.componentDistanceEnd],0),objectLength:ze(u[d.objectLength],0),vertices:h,demElevation:NaN,tileData:[...s.tileData]};e.addLabel(k)};function _u(e,t,n,s,i,r){const{tileProps:o,tileAttrs:a}=s,{rasterSets:c,icons:l}=t,f=yr(i),d=Qn(n.style.iconWidth),u=qr(a[o.db_sublayer]),p=uc(a[o.db_sublayer]),w=Ke(n.style.iconAnchor);if(u||p){if(r)return;const A=u?Dl.rasterSizes:Gl,h=nu(s.id??"",A,a[o.db_region],w,u?"commercial":"landmark",o.url_src?a[o.url_src]:void 0);e.atlasPacker.addNewRasterSet(t.id,h),e.atlasPacker.pack(h,d,f)}else Qn(n.style.iconImage).forEach(A=>{if(!A.length)return;const h=c.byKey[va(A,w[0],w[1])];if(!h){console.error(`Not found raster set with image ${A}, anchorX: ${w[0]}, anchorY: ${w[1]}`);return}if(!h.isSvg)return;const m=l[A],I=m&&Ur(m)?[{w:m.width,h:m.height}]:d.map(M=>({w:M,h:M}));e.atlasPacker.packSvg(h,I,f),r&&h.rasters.forEach(M=>e.atlasPacker.addRastersToLoad(t.id,M))})}const Su=(e,t,n,s,i,r,o)=>{const a={type:Js.Line,styleId:t,layerId:n.innerId,sourceId:i,tileCoords:s,id:r.id??"",floorId:r.tileAttrs[r.tileProps.db_plan_id]??"",componentDistanceStart:ze(r.tileAttrs[r.tileProps.componentDistanceStart],0),componentDistanceEnd:ze(r.tileAttrs[r.tileProps.componentDistanceEnd],0),objectLength:ze(r.tileAttrs[r.tileProps.objectLength],0),labelPriority:ze(r.tileAttrs[r.tileProps.db_label_priority],0),styleIconPriority:de(n.style.textPriority,r),styleTextPriority:de(n.style.textPriority,r),vertices:[o.x,o.y],tileData:[...r.tileData],tiers:q(n.ignoreTier,r)?void 0:r.tileAttrs[r.tileProps.db_tiers]};e.addLabel(a)},Bu=(e,t,n,s,i,r,o)=>{const{tileProps:a,tileAttrs:c}=r,l=q(n.ignoreTier,r)?null:c[a.db_tiers],f={type:Js.OneWayLine,styleId:t,layerId:n.innerId,sourceId:i,tileCoords:s,id:r.id??"",floorId:r.tileAttrs[r.tileProps.db_plan_id]??"",componentDistanceStart:ze(r.tileAttrs[r.tileProps.componentDistanceStart],0),componentDistanceEnd:ze(r.tileAttrs[r.tileProps.componentDistanceEnd],0),objectLength:ze(r.tileAttrs[r.tileProps.objectLength],0),labelPriority:ze(r.tileAttrs[r.tileProps.db_label_priority],0),styleIconPriority:de(n.style.priority,r),styleTextPriority:0,vertices:[o.x,o.y],tileData:[...r.tileData],tiers:l};e.addLabel(f)};function Fu(e,t,n){return Du(e)||!t?e:Lu(t)?sr(t,{modelSrc:e,subdomain:ua(n)}):Nu(t,e)}const Ou=new RegExp("^(?:(?:[a-z]+:)?(?:[a-z]+:)?//|data:)","i");function Du(e){return Ou.test(e)}function Lu(e){return/{\w+}/g.test(e)}function Nu(...e){const t=e.filter(s=>s.length>0);let n=t[0];for(let s=1;s<t.length;s++){n[n.length-1]!=="/"&&(n+="/");const i=t[s];i[0]==="/"?n+=i.slice(1):n+=i}return n}function Ru(e){return Array.isArray(e)?e:[e]}var Fn=(e=>(e[e.None=0]="None",e[e.Zoom=1]="Zoom",e[e.Distance=2]="Distance",e))(Fn||{});const _t=[0,0,0],ls=new Int16Array([0,0,0]),je=new Array(16),Zr=new Float32Array(9),pn=[0,0,0],Wr=[0,0,0],Jr=[0,0,0],li=[0,0,0],Uu=Je(),Cu=ki([1,1,1]),On={symbol:"gltfModel",sinks:{instances:{stride:64,binder:(e,t)=>{e.views.flatPosition=new Uint16Array(t),e.views.ecefPosition=new Int16Array(t,8),e.views.matrix=new Float32Array(t,16),e.views.localID=new Uint32Array(t,52),e.views.labelingTextureID=new Uint32Array(t,56),e.views.absZ=new Float32Array(t,60)},packObjectAttributes(e,t,n,s,i,r,o,a,c=[],l,f,d,u){return Pe([e,t.innerId,n,c,a,r,s,i,l,f,d,u],t,o)},unpackObjectAttributes(e){return{styleId:e[0],layerId:e[1],modelIndices:e[2],lngLat:e[3],emitShowHideEvents:e[4],sourceId:e[5],modelStepValues:e[6],modelStepSource:e[7],parentId:e[8],absZ:e[9],floorId:e[10],subkey:e[11],tileData:e.slice(12)}}}},generateInstances(e,t,n,s,i,r,o,a,c,l,f=0){const d=q(n.style.linkedIds,s),u=d===""?[]:Ru(d),p=n.style.modelSrc,w=[];let A=Fn.None;const h=Qn(p,s,n,!0);if(h.length===1)w.push(0);else if(h.length>1){if(!Ft(p)||p.type!=="step"||!Ft(p.value)){console.error(`Only step-expression is allowed as 'modelSrc' style property. Models won't be displayed for layer ${n.id}`);return}switch(p.value.type){case"zoom":A=Fn.Zoom;break;case"distance":A=Fn.Distance;break;default:console.error(`'${p.value.type}' type in 'modelSrc' step expression is not supported. Only 'zoom' and 'distance' are supported. Models won't be displayed for layer ${n.id}`);return}p.steps.forEach(({key:x})=>{w.push(x)})}A===Fn.Distance&&h.reverse(),h.forEach((x,_)=>{x===null&&_!==0&&(h[_]=h[_-1])}),A===Fn.Distance&&h.reverse();const m=h.map(x=>x===null?"":x).map(x=>{let _=t.modelIndex[x];return _===void 0&&(x=Fu(x,a??"",r.coords),_=e.addUsedModelByUrl(x)),e.addUsedModel(_),_}),{tileProps:I,tileAttrs:M}=s;let v=Rt;n.interactive?s.id&&(v=M[I.hovered]?yt:e.idIndexer.getIndex(s,t.id,n,{metatile:l,objectClass:M[I.db_object_class]})):v=n.interactiveOcclusion?Rt:yt;const S=s.id??"-1",T=M[I.db_point_building_id];let F=Rt;s.id&&(F=e.pointIndexer.getIndex(T??s.id));const E=c!=null&&c.has(M[I.db_sublayer])&&S!=="-1"?1:0,B=e.getBucket("gltfModel","instances",On.sinks.instances.packObjectAttributes(t.id,n,m,w,A,o,s,E,E?Jn(i.x[0],i.y[0],r):void 0,T,!!i.abs_z,I.db_plan_id?M[I.db_plan_id]:"",qf(r,i.x[0],i.y[0],f)),On.sinks.instances.binder);let k=B.meta;if(k)k.linkedIds.push(...u);else{const x=I.db_plan_id?M[I.db_plan_id]:void 0;k=B.meta={linkedIds:u.slice(),modelsPath:a??"",buildingId:S,planId:x}}E&&(k.sublayer=M[I.db_sublayer]),T&&(k.childrenIds||(k.childrenIds=[]),k.childrenIds.push(S));let U;const g=Yu(M,s);if(g){const x=i.x[0],_=i.y[0],C=[0,0,0];Zn(C,[x,_],r),U=[C,Ie.fromGeo(g)]}for(let x=0;x<i.x.length;x++){const _=i.abs_z&&i.abs_z[x];Oe(Wr,0,0,0),ji(q(n.style.rotation,s),Wr),Oe(pn,1,1,1),ji(q(n.style.scale,s),pn),Oe(Jr,0,0,0),ji(q(n.style.offset,s),Jr),pc(i.x[x],i.y[x],0,Jr,pn,Wr,U,r,n.minzoom<ko.globeMaxZoom),$u(B,_t,ls,Zr,v,F,_)}},patchBuffer(e,t,n,s,i,r,o,a,c){const l=On.sinks.instances.stride*n;pc(i[0],i[1],i[2],r,o,a,void 0,s,c),_t[0]+=Y,_t[1]+=Y,_t[2]=He(_t[2]),t.subData(e,l+0,new Uint16Array(_t)),c&&t.subData(e,l+8,ls),t.subData(e,l+16,Zr)}};function ku(e,t,n,s){const i=n*le/Wn(s.coords[2]);lt(t,t,i),t[2]*=n,kn(e,e,t)}function pc(e,t,n,s,i,r,o,a,c){Oe(_t,e,t,n);const l=bt(a,_t)*Te;if(nf(je),Ho(je,je,_e(r[2])),af(je,je,_e(r[1])),Xo(je,je,_e(r[0])),bs(je,je,i),o?Vu(je,o[0],o[1]):(Oe(pn,l,l,l),bs(je,je,pn)),Xo(je,je,Math.PI/2),vf(Zr,je),ku(_t,s,l,a),c){const f=or(a,_t);ls[0]=f[0]*$e,ls[1]=f[1]*$e,ls[2]=f[2]*$e}}function Vu(e,t,n){nn(li,n,t),Ho(e,e,Math.atan2(li[1],li[0]));const s=Ui(li);Oe(pn,s,s,s),bs(e,e,pn)}function Yu(e,t){const n=e[t.tileProps.direction];return n===void 0?null:Array.isArray(n)?n:n.type==="Point"?n.coordinates:null}function $u(e,t,n,s,i,r,o){const a=e.elements.offset*On.sinks.instances.stride,c=e.views,l=a/c.flatPosition.BYTES_PER_ELEMENT,f=Y+t[0],d=Y+t[1],u=He(t[2]);if(c.flatPosition[l]=f,c.flatPosition[l+1]=d,c.flatPosition[l+2]=u,c.ecefPosition[l]=n[0],c.ecefPosition[l+1]=n[1],c.ecefPosition[l+2]=n[2],e.elements.offset>e.elements.maximum-1)return;c.matrix.set(s,a/c.matrix.BYTES_PER_ELEMENT),c.localID[a/c.localID.BYTES_PER_ELEMENT]=i,c.labelingTextureID[a/c.labelingTextureID.BYTES_PER_ELEMENT]=r,o!==void 0&&(c.absZ[a/c.absZ.BYTES_PER_ELEMENT]=o),Gu(e,f,d,u,s);const p=e.indices;p.buffer[p.offset]=e.elements.offset,p.offset++,e.elements.offset++}function Gu(e,t,n,s,i){const r=e.extents;t<r[0]&&(r[0]=t),n<r[1]&&(r[1]=n),s<r[2]&&(r[2]=s),t>r[3]&&(r[3]=t),n>r[4]&&(r[4]=n),s>r[5]&&(r[5]=s);const o=Uu;Pf(i,o);const a=ki(o)/Cu;a>e.maxDiag&&(e.maxDiag=a)}var J=(e=>(e[e.side=0]="side",e[e.top=1]="top",e[e.bottom=2]="bottom",e))(J||{});const fs=[0,0,0],ds=[0,0,0],hs=[0,0,0],fi=[0,0,0],gc=(e,t,n,s,i)=>Pe([e,t.innerId,n,s],t,i),mc=(e,t,n,s)=>Pe([e,t.innerId,n],t,s),wc=e=>({styleId:e[0],layerId:e[1],side:e[2],absZ:e[3],tileData:e.slice(4)}),yc=e=>({styleId:e[0],layerId:e[1],absZ:e[2],tileData:e.slice(3)}),X={symbol:"mesh",sinks:{fill:{stride:28,binder:(e,t)=>{e.views.position=new Uint16Array(t),e.views.z=new Float32Array(t,4),e.views.normal=new Int8Array(t,8),e.views.gradient=new Int8Array(t,11),e.views.localID=new Uint32Array(t,12),e.views.demPosition=new Int16Array(t,16),e.views.absZ=new Float32Array(t,16),e.views.isPivot=new Uint8Array(t,20),e.views.labelingTextureID=new Uint32Array(t,24)},packObjectAttributes:gc,unpackObjectAttributes:wc},inverse:{stride:16,binder:(e,t)=>{e.views.position=new Uint16Array(t),e.views.z=new Float32Array(t,4),e.views.demPosition=new Int16Array(t,8),e.views.absZ=new Float32Array(t,8),e.views.isPivot=new Uint8Array(t,12)},packObjectAttributes:mc,unpackObjectAttributes:yc},depthClear:{stride:16,binder:(e,t)=>{e.views.position=new Uint16Array(t),e.views.z=new Float32Array(t,4),e.views.demPosition=new Int16Array(t,8),e.views.absZ=new Float32Array(t,8),e.views.isPivot=new Uint8Array(t,12)},packObjectAttributes:mc,unpackObjectAttributes:yc},stroke:{stride:20,binder:(e,t)=>{e.views.position=new Uint16Array(t),e.views.z=new Float32Array(t,4),e.views.directionDistance=new Int8Array(t,8),e.views.demPosition=new Int16Array(t,12),e.views.absZ=new Float32Array(t,12),e.views.isPivot=new Uint8Array(t,16)},packObjectAttributes:gc,unpackObjectAttributes:wc}},generate(e,t,n,s,i,r,o,a,c,l,f="fill",d=!1){const u=r.x,p=r.y,w=r.signed_z;let A=0;if(n.type==="polygon3d"||n.type==="embankment"){const B=q(n.style.elevation,i),k=i.tileInfo?bt(i.tileInfo,[0,0]):1;A=B*Te*k}const h=r.gradient,m=r.abs_z,I=r.is_pivot,M=u.length,v=i.tileAttrs[i.tileProps.hovered],S=i.id??"",T=e.pointIndexer.getIndex(S);let F=Rt;switch(n.type){case"polygon3d":{n.interactive?(F=v?yt:e.idIndexer.getIndex(i,t,n),!v&&F===yt&&(F=Rt)):F=n.interactiveOcclusion?Rt:yt;break}case"overpass":case"tunnel":{F=e.idIndexer.getIndex(i,t,n),F===yt&&(F=Rt);break}case"embankment":{F=Rt;break}default:{const{type:B}=n}}(n.type==="embankment"||n.type==="polygon3d")&&c&&Ca(e,t,c,n.style,a);let E;if(f==="inverse")E=e.getBucket("mesh","inverse",X.sinks.inverse.packObjectAttributes(t,n,!!m,i),X.sinks.inverse.binder);else if(f==="fill")E=e.getBucket("mesh","fill",X.sinks.fill.packObjectAttributes(t,n,s,!!m,i),X.sinks.fill.binder);else if(f==="depthClear")E=e.getBucket("mesh","depthClear",X.sinks.depthClear.packObjectAttributes(t,n,!!m,i),X.sinks.depthClear.binder);else return;for(let B=0;B<M-2;B++){const k=!(B%2);zu(E);const U=d?2:1,g=d?1:2,x=k?B+U:B+g,_=k?B+g:B+U,C=le/o.size;Oe(fs,u[B],p[B],((w==null?void 0:w[B])??0)*C),Oe(ds,u[x],p[x],((w==null?void 0:w[x])??0)*C),Oe(hs,u[_],p[_],((w==null?void 0:w[_])??0)*C),ra(fi,fs,ds,hs),fs[2]/=C,ds[2]/=C,hs[2]/=C,fs[2]+=A,ds[2]+=A,hs[2]+=A;const y=E.elements.offset;Kr(E,fs,fi,h==null?void 0:h[B],F,T,l,m==null?void 0:m[B],I==null?void 0:I[B]),Kr(E,ds,fi,h==null?void 0:h[x],F,T,l,m==null?void 0:m[x],I==null?void 0:I[x]),Kr(E,hs,fi,h==null?void 0:h[_],F,T,l,m==null?void 0:m[_],I==null?void 0:I[_]),E.objectsData[y]={objectId:S,size:E.elements.offset-y}}}};function Kr(e,t,n,s,i,r,o,a,c){const l=e.elements.stride*e.elements.offset,f=l/e.views.position.BYTES_PER_ELEMENT;e.views.position[f]=Y+t[0],e.views.position[f+1]=Y+t[1],e.views.z[l/e.views.z.BYTES_PER_ELEMENT]=t[2];const d=l/e.views.demPosition.BYTES_PER_ELEMENT;if(e.views.demPosition[d]=(((o==null?void 0:o[0])??t[0])+Y)/8,e.views.demPosition[d+1]=(((o==null?void 0:o[1])??t[1])+Y)/8,a!==void 0&&(e.views.absZ[l/e.views.absZ.BYTES_PER_ELEMENT]=a),e.views.isPivot[l/e.views.isPivot.BYTES_PER_ELEMENT]=c??0,"normal"in e.views){const u=l/e.views.normal.BYTES_PER_ELEMENT,p=l/e.views.localID.BYTES_PER_ELEMENT,w=l/e.views.gradient.BYTES_PER_ELEMENT;e.views.normal[u]=De(n[0]),e.views.normal[u+1]=De(n[1]),e.views.normal[u+2]=De(n[2]),e.views.gradient[w]=De(s??0),e.views.localID[p]=i,e.views.labelingTextureID[p]=r}e.elements.offset++}function zu(e){const t=e.indices.buffer,n=e.indices.offset,s=e.elements.offset;t[n]=s,t[n+1]=s+1,t[n+2]=s+2,e.indices.offset+=3}const vc=[0,0,0],xc=[0,0,0],Ic=[0,0,0],di=[0,0,0],us={symbol:"mapMesh",sinks:{fill:{stride:24,binder:(e,t)=>{e.views.position=new Uint16Array(t),e.views.z=new Float32Array(t,4),e.views.extender=new Int16Array(t,8),e.views.normal=new Int8Array(t,12),e.views.gradient=new Int8Array(t,15),e.views.demPosition=new Int16Array(t,16),e.views.absZ=new Float32Array(t,16),e.views.isPivot=new Uint8Array(t,20)},packObjectAttributes:(e,t,n,s,i)=>Pe([e,t.innerId,n,s],t,i),unpackObjectAttributes:e=>({styleId:e[0],layerId:e[1],meshTier:e[2],absZ:e[3],tileData:e.slice(4)})}},generate(e,t,n,s,i,r,o,a){const c=i.x,l=i.y,f=i.signed_z??[],d=i.gradient,u=i.is_pivot,p=i.abs_z,w=c.length,A=a==null?void 0:a[0],h=a==null?void 0:a[1];if(w<3)return;const m=le/o.size,I=e.getBucket("mapMesh","fill",us.sinks.fill.packObjectAttributes(t,n,r,!!p,s),us.sinks.fill.binder),M=I.indices.buffer;let v=I.indices.offset;const S=I.elements.offset;for(let T=2;T<w;T++){const F=!(T%2),E=F?T-2:T-1,B=F?T-1:T-2;ju(M,v,S,(T-2)*3+2),Oe(Ic,c[E],l[E],f[E]*m),Oe(xc,c[B],l[B],f[B]*m),Oe(vc,c[T],l[T],f[T]*m),ra(di,Ic,xc,vc),Qr(I,c[E],l[E],f[E],d==null?void 0:d[E],u==null?void 0:u[E],p==null?void 0:p[E],di,A,h),Qr(I,c[B],l[B],f[B],d==null?void 0:d[B],u==null?void 0:u[B],p==null?void 0:p[B],di,A,h),Qr(I,c[T],l[T],f[T],d==null?void 0:d[T],u==null?void 0:u[T],p==null?void 0:p[T],di,A,h),v+=3}I.indices.offset=v}};function ju(e,t,n,s){e[t]=n+s-2,e[t+1]=n+s-1,e[t+2]=n+s}function Qr(e,t,n,s,i,r,o,a,c=t,l=n){const f=e.elements.offset*e.elements.stride,d=f/e.views.position.BYTES_PER_ELEMENT,u=f/e.views.normal.BYTES_PER_ELEMENT,p=f/e.views.demPosition.BYTES_PER_ELEMENT;e.views.position[d]=Y+t,e.views.position[d+1]=Y+n,e.views.z[f/e.views.z.BYTES_PER_ELEMENT]=s,e.views.normal[u]=De(a[0]),e.views.normal[u+1]=De(a[1]),e.views.normal[u+2]=De(a[2]),e.views.gradient[f/e.views.gradient.BYTES_PER_ELEMENT]=i??0,e.views.isPivot[f/e.views.isPivot.BYTES_PER_ELEMENT]=r??0,e.views.demPosition[p]=(Y+c)/8,e.views.demPosition[p+1]=(Y+l)/8,o!==void 0&&(e.views.absZ[f/e.views.absZ.BYTES_PER_ELEMENT]=o),e.elements.offset++}const Xu=1,eo=-1,Hu=1.3,Ac=-200,Mc=-300,qu=Math.tan(_e(175/2)),ct=[0,0,0],Jt=[0,0,0],Zu=[0,0,0],ps=[0,0,0],to=[0,0,0],be=[0,0,0];let hi=0,gs=0;const Wu=(e,t)=>e<0||t<0?Math.floor(Math.min(e,t)):Math.ceil(Math.max(e,t)),Pc={symbol:"overpass",sinks:{},generate(e,t,n,s,i,r,o,a){var D;let c=i.signed_z;if(!c)return;const l=i.abs_z!==void 0&&Array.from(i.abs_z).some(O=>O)?i.abs_z:void 0,f=s.styleState.terrainEnabled===!0,d=s.tileAttrs[s.tileProps.db_road_part],u=s.tileAttrs[s.tileProps.db_geometry_type],p=(D=s.tileAttrs[s.tileProps.db_tiers])==null?void 0:D[0],w=!!s.tileAttrs[s.tileProps.db_is_mountain]&&!!l&&f,A=d==="tunnel_arch"&&w,h=d==="border_tunnel"&&w;if(d==="roadbed_flat"||d==="border_tunnel_descent"&&w)return;const I=s.tileProps,M=s.tileAttrs.slice();s.id=void 0,M[I.db_tiers]=void 0;const v=t.id,S=i.x.length,T=i.x,F=i.y,E=i.cut??[],B=new Uint8Array(S);A||c.forEach((O,L)=>{B[L]=O?0:1}),!!s.tileAttrs[s.tileProps.db_ignore_z]&&!!l&&f&&(c=new Int32Array(c.length));const U=f?Hu:1;f&&!w&&(d==="roadbed_tunnel"||d==="roadbed_tunnel_descent"||d==="border_tunnel"||d==="border_tunnel_descent")&&(c=new Int32Array(c).map(O=>O*U)),Fe(ps,0,0);const x=bt(r,ps)*Te,_=le/r.size*x,C=Math.max(de(n.style.borderWidth,s,0),0)*_,y=Math.max(de(n.style.thickness,s,0),0)*x,b=C>0?Math.max(-y,de(n.style.borderHeight,s,0)*x):0,P=Math.max(de(n.style.tunnelHeight,s,0),0)*x;if(u==="polygon"){if(p===void 0)return;const O=[T,F,E,c,new Int8Array(S),B];l&&O.push(l);const L=d==="roadbed_tunnel_descent",N=d==="roadbed_tunnel"||L;us.generate(e,v,n,s,Q(O),p,r,void 0);const R=O.map(V=>Array.from(V));for(let V=0;V<R[3].length;V++)R[3][V]-=y,R[4][V]=0;X.generate(e,v,n,J.bottom,s,Q(R),r,o,a,void 0,N?"inverse":"fill",!0);const H=[];for(let V=0;V<p;V++)H.push(V);const $=e.getBucket("polygon","shadow",Wt.sinks.shadow.packObjectAttributes(v,n,H,"",s),Wt.sinks.shadow.binder);if(Wa($,O[0].length,O[0],O[1],yt),N&&!L){const V=O.slice();V[3]=w?new Array(O[0].length).fill(P):Array.from(O[3]).map(G=>G+Math.abs(G/U)-1),X.generate(e,v,n,J.top,s,Q(V),r,o,a,void 0,w?"fill":"inverse"),w&&X.generate(e,v,n,J.bottom,s,Q(V),r,o,a,void 0,"fill",!0)}if(L&&f&&!w){const V=O.slice();V[3]=new Array(O[0].length).fill(Math.max(0,b)),X.generate(e,v,n,J.top,s,Q(V),r,o,a,void 0,"depthClear")}}else if(u==="polyline"){const O=X.sinks.stroke.packObjectAttributes(v,n,J.top,!!l,s),L=X.sinks.stroke.packObjectAttributes(v,n,J.side,!!l,s),N=X.sinks.stroke.packObjectAttributes(v,n,J.bottom,!!l,s),R=Ju({x:T,y:F,cut:E,signed_z:c,is_pivot:B,abs_z:l});if(d==="tunnel_arch"&&!w){const H=Math.max(b,0),$=ms(R),V=bc(R,C),G=R.map(j=>{const z=j.slice();return z[2]=f?Mc:Ac,z[4]=0,z});ce(e,N,G);const Z=Ze(V,$,C).map(j=>(j[2]=H,j[4]=1,j)),ne=V.map(j=>{const z=j.slice();return z[2]=H,z[4]=1,z}),W=se(Z,ne);do X.generate(e,v,n,J.top,s,Q(W),r,o,a,void 0,H?"fill":"inverse");while(e.isOverloaded());const oe=R.map(j=>{const z=j.slice();return z[2]=H,z[4]=1,z});ce(e,O,oe);const te=se(oe,G);do X.generate(e,v,n,J.side,s,Q(te),r,o,a);while(e.isOverloaded());const ee=se(Z.map(j=>{const z=j.slice();return z[2]=f?Mc:Ac,z[4]=0,z}),Z.map(j=>{const z=j.slice();return z[2]=0,z}));do X.generate(e,v,n,J.side,s,Q(ee),r,o,a,void 0,"inverse");while(e.isOverloaded());if(H){const j=Ze(V,$,C).map(Se=>(Se[2]=0,Se[4]=0,Se));ce(e,N,j),ce(e,O,Z);const z=se(j,Z);do X.generate(e,v,n,J.side,s,Q(z),r,o,a,void 0,"fill");while(e.isOverloaded());const K=V.map(Se=>{const Le=Se.slice();return Le[2]=0,Le[4]=0,Le}),re=se([ne[0],K[0]],[Z[0],j[0]]);do X.generate(e,v,n,J.side,s,Q(re),r,o,a,void 0,"fill");while(e.isOverloaded());ce(e,O,[ne[0],Z[0]]),ce(e,L,[Z[0],j[0]]),ce(e,N,[j[0],K[0]]);const ae=ne.length-1,ke=se([K[ae],ne[ae]],[j[ae],Z[ae]]);do X.generate(e,v,n,J.side,s,Q(ke),r,o,a,void 0,"fill");while(e.isOverloaded());if(ce(e,O,[ne[ae],Z[ae]]),ce(e,L,[Z[ae],j[ae]]),ce(e,N,[j[ae],K[ae]]),f){do X.generate(e,v,n,J.top,s,Q(W),r,o,a,void 0,"depthClear");while(e.isOverloaded());do X.generate(e,v,n,J.side,s,Q(z),r,o,a,void 0,"depthClear");while(e.isOverloaded());do X.generate(e,v,n,J.side,s,Q(re),r,o,a,void 0,"depthClear");while(e.isOverloaded());do X.generate(e,v,n,J.side,s,Q(ke),r,o,a,void 0,"depthClear");while(e.isOverloaded())}}}else if(A){if(!P)return;const H=ms(R),$=bc(R,C),V=Ze(R,H,C),G=Ze($,H,C),Z=R.map(W=>{const oe=W.slice();return oe[2]=P,oe}),ne=se(Z,R);do X.generate(e,v,n,J.side,s,Q(ne),r,o,a,void 0,"depthClear");while(e.isOverloaded());if(C){const W=[R[0],$[0]],oe=W.map(Xe=>{const ge=Xe.slice();return ge[2]=P,ge[4]=P/(P+b),ge}),te=se(W,oe);do X.generate(e,v,n,J.side,s,Q(te),r,o,a);while(e.isOverloaded());const ee=[V[0],G[0]],j=ee.map(Xe=>{const ge=Xe.slice();return ge[2]=P,ge[4]=P/(P+b),ge}),z=se(j,ee);do X.generate(e,v,n,J.side,s,Q(z),r,o,a);while(e.isOverloaded());const K=[V[0],R[0]],re=K.map(Xe=>{const ge=Xe.slice();return ge[2]=P,ge[4]=P/(P+b),ge}),ae=se(K,re);do X.generate(e,v,n,J.side,s,Q(ae),r,o,a);while(e.isOverloaded());const ke=[$[0],G[0]],Se=ke.map(Xe=>{const ge=Xe.slice();return ge[2]=P,ge[4]=P/(P+b),ge}),Le=se(ke,Se);do X.generate(e,v,n,J.side,s,Q(Le),r,o,a);while(e.isOverloaded());const xt=R.length-1,Oi=[$[xt],R[xt]],Do=Oi.map(Xe=>{const ge=Xe.slice();return ge[2]=P,ge[4]=P/(P+b),ge}),Ve=se(Oi,Do);do X.generate(e,v,n,J.side,s,Q(Ve),r,o,a);while(e.isOverloaded());const he=[G[xt],V[xt]],wp=he.map(Xe=>{const ge=Xe.slice();return ge[2]=P,ge[4]=P/(P+b),ge}),yp=se(wp,he);do X.generate(e,v,n,J.side,s,Q(yp),r,o,a);while(e.isOverloaded());const El=[G[xt],$[xt]],vp=El.map(Xe=>{const ge=Xe.slice();return ge[2]=P,ge[4]=P/(P+b),ge}),xp=se(El,vp);do X.generate(e,v,n,J.side,s,Q(xp),r,o,a);while(e.isOverloaded());const Tl=[R[xt],V[xt]],Ip=Tl.map(Xe=>{const ge=Xe.slice();return ge[2]=P,ge[4]=P/(P+b),ge}),Ap=se(Tl,Ip);do X.generate(e,v,n,J.side,s,Q(Ap),r,o,a);while(e.isOverloaded())}if(b){const W=R.length-1,oe=[$[W],R[W],R[0],$[0]].map(Ve=>{const he=Ve.slice();return he[2]=P,he[4]=P/(P+b),he}),te=oe.map(Ve=>{const he=Ve.slice();return he[2]=P+b,he[4]=1,he}),ee=se(oe,te);do X.generate(e,v,n,J.side,s,Q(ee),r,o,a);while(e.isOverloaded());const j=[G[W],V[W],V[0],G[0]].map(Ve=>{const he=Ve.slice();return he[2]=P,he[4]=P/(P+b),he}),z=j.map(Ve=>{const he=Ve.slice();return he[2]=P+b,he[4]=1,he}),K=se(z,j);do X.generate(e,v,n,J.side,s,Q(K),r,o,a);while(e.isOverloaded());const re=se(te,z);do X.generate(e,v,n,J.top,s,Q(re),r,o,a);while(e.isOverloaded());const ae=se(j,oe);do X.generate(e,v,n,J.bottom,s,Q(ae),r,o,a);while(e.isOverloaded());const ke=[$[0],G[0]].map(Ve=>{const he=Ve.slice();return he[2]=P,he[4]=P/(P+b),he}),Se=ke.map(Ve=>{const he=Ve.slice();return he[2]=P+b,he[4]=1,he}),Le=se(ke,Se);do X.generate(e,v,n,J.side,s,Q(Le),r,o,a);while(e.isOverloaded());const xt=[G[W],$[W]].map(Ve=>{const he=Ve.slice();return he[2]=P,he[4]=P/(P+b),he}),Oi=xt.map(Ve=>{const he=Ve.slice();return he[2]=P+b,he[4]=1,he}),Do=se(xt,Oi);do X.generate(e,v,n,J.side,s,Q(Do),r,o,a);while(e.isOverloaded())}}else if(d==="border_overpass"||d==="border_flat"){const H=[M[I.previousPointX],M[I.previousPointY],c[0]??0,0],$=!!M[I.beginningIsCut]&&Ec(R[1],R[0],H);$&&R.splice(0,0,H);const V=R.length-1,G=[M[I.nextPointX],M[I.nextPointY],c[c.length-1]??0,0],Z=!!M[I.endingIsCut]&&Ec(R[V-1],R[V],G);Z&&R.push(G);const ne=ms(R);$&&(ne.shift(),R.shift()),Z&&(ne.pop(),R.pop());const W=R.map(re=>{const ae=re.slice();return ae[2]=Math.max(ae[2]-y,0),ae[4]=0,ae});ce(e,L,R);const oe=Ze(R,ne,C).map(re=>{const ae=re.slice();return ae[2]=Math.max(re[2]-y,0),ae[4]=0,ae}),te=Ze(R,ne,C).map(re=>{const ae=re.slice();return ae[2]=Math.max(re[2]+b,0),ae[4]=1,ae}),ee=R.map(re=>{const ae=re.slice();return b>0&&(ae[2]=Math.max(ae[2]+b,0)),ae[4]=1,ae});if(b>0){ce(e,O,ee);const re=se(ee,R.map(ae=>{const ke=ae.slice();return ke[4]=0,ke}));do X.generate(e,v,n,J.side,s,Q(re),r,o,a);while(e.isOverloaded())}ce(e,N,oe),ce(e,O,te);const j=se(te,ee);do X.generate(e,v,n,J.top,s,Q(j),r,o,a);while(e.isOverloaded());const z=se(W,oe);do X.generate(e,v,n,J.bottom,s,Q(z),r,o,a,void 0,"fill");while(e.isOverloaded());const K=se(oe,te);do X.generate(e,v,n,J.side,s,Q(K),r,o,a,void 0,"fill");while(e.isOverloaded());if(c[0]===0){const re=se([ee[0],W[0]],[te[0],oe[0]]);do X.generate(e,v,n,J.side,s,Q(re),r,o,a,void 0,"fill");while(e.isOverloaded());ce(e,O,[te[0],ee[0]]),ce(e,L,[ee[0],W[0]]),ce(e,L,[oe[0],te[0]]),ce(e,N,[W[0],oe[0]])}if(c[c.length-1]===0){const re=W.length-1,ae=se([W[re],ee[re]],[oe[re],te[re]]);do X.generate(e,v,n,J.side,s,Q(ae),r,o,a,void 0,"fill");while(e.isOverloaded());ce(e,O,[ee[re],te[re]]),ce(e,L,[W[re],ee[re]]),ce(e,L,[te[re],oe[re]]),ce(e,N,[oe[re],W[re]])}}else if(h){const H=R.map(V=>{const G=V.slice();return G[2]=P,G[4]=P/(P+b),G}),$=se(H,R);do X.generate(e,v,n,J.side,s,Q($),r,o,a);while(e.isOverloaded());do X.generate(e,v,n,J.side,s,Q($),r,o,a,void 0,"fill",!0);while(e.isOverloaded())}else{const H=ms(R),$=d==="border_tunnel_descent",V=d==="border_tunnel"||$,G=V?Math.max(b,0):b,Z=R.map(te=>{const ee=te.slice();return ee[2]-=y,$?ee[2]=0:V&&(ee[2]=Math.max(ee[2],eo)),ee[4]=0,ee}),ne=Ze(R,H,C).map(te=>(te[2]-=y,$&&(te[2]=0),te[4]=0,te)),W=Ze(R,H,C).map(te=>(te[2]+=G,$?te[2]=G:V&&(te[2]=Math.max(te[2],eo)),te[4]=1,te)),oe=R.map(te=>{const ee=te.slice();if(ee[4]=1,$)ee[2]=G;else if(V){const j=Math.abs(ee[2]/U),z=G-ee[2],K=ee[2]+j-1;ee[4]=(K+Math.abs(ee[2]))/z,ee[2]=K}else ee[2]+=G;return ee});if(V){$&&ce(e,O,oe);const te=se(oe,R.map(z=>{const K=z.slice();return K[4]=0,K}));do X.generate(e,v,n,J.side,s,Q(te),r,o,a);while(e.isOverloaded());const ee=oe.map(z=>{const K=z.slice();return K[2]=Math.min(z[2],eo),K}),j=se(ee,R);do X.generate(e,v,n,J.side,s,Q(j),r,o,a,void 0,"inverse",!0);while(e.isOverloaded())}if(b>0&&(!V||$)){ce(e,N,ne),ce(e,O,W);const te=se(W,oe);do X.generate(e,v,n,J.top,s,Q(te),r,o,a);while(e.isOverloaded());if($&&f)do X.generate(e,v,n,J.top,s,Q(te),r,o,a,void 0,"depthClear");while(e.isOverloaded())}if(!V||$){const te=se(Z,ne);do X.generate(e,v,n,J.bottom,s,Q(te),r,o,a,void 0,"fill");while(e.isOverloaded());const ee=se(ne,W);do X.generate(e,v,n,J.side,s,Q(ee),r,o,a,void 0,"fill");while(e.isOverloaded());if($&&f)do X.generate(e,v,n,J.side,s,Q(ee),r,o,a,void 0,"depthClear");while(e.isOverloaded());if(c[0]===0){const j=se([oe[0],Z[0]],[W[0],ne[0]]);do X.generate(e,v,n,J.side,s,Q(j),r,o,a,void 0,"fill");while(e.isOverloaded());if($&&f)do X.generate(e,v,n,J.side,s,Q(j),r,o,a,void 0,"depthClear");while(e.isOverloaded());ce(e,O,[W[0],oe[0]]),ce(e,L,[oe[0],Z[0]]),ce(e,L,[ne[0],W[0]]),ce(e,N,[Z[0],ne[0]])}if(c[c.length-1]===0){const j=Z.length-1,z=se([Z[j],oe[j]],[ne[j],W[j]]);do X.generate(e,v,n,J.side,s,Q(z),r,o,a,void 0,"fill");while(e.isOverloaded());if($&&f)do X.generate(e,v,n,J.side,s,Q(z),r,o,a,void 0,"depthClear");while(e.isOverloaded());ce(e,O,[oe[j],W[j]]),ce(e,L,[Z[j],oe[j]]),ce(e,L,[W[j],ne[j]]),ce(e,N,[ne[j],Z[j]])}}}}}};function Ju(e){var s,i,r;const t=[],n=e.x.length;for(let o=0;o<n;o++){const a=[e.x[o],e.y[o],((s=e.signed_z)==null?void 0:s[o])??0,((i=e.cut)==null?void 0:i[o])??0,0,((r=e.is_pivot)==null?void 0:r[o])??0];e.abs_z&&a.push(e.abs_z[o]),t.push(a)}return t}function ms(e){const t=[];Pt(ct,e[0][0],e[0][1],e[1][0],e[1][1]),hi=0;for(let n=1;n<e.length;n++)Ku(t,e,n);return t}function Ku(e,t,n){const s=n===t.length-1;if(Fe(Zu,t[n-1][0],t[n-1][1]),Fe(ps,t[n][0],t[n][1]),Wi(be,ct),s)gs=0;else{Fe(to,t[n+1][0],t[n+1][1]),Pt(Jt,ps[0],ps[1],to[0],to[1]);const o=ft(wn(ct,Jt),-1,1),a=Math.min(Math.sqrt((1-o)/(1+o)),qu),c=$i(wn(be,Jt));gs=a*c}let i=be[0]+ct[0]*hi,r=be[1]+ct[1]*hi;e.push([i,r]),s&&(i=be[0]+ct[0]*gs,r=be[1]+ct[1]*gs,e.push([i,r])),s||(Ri(ct,Jt),hi=gs)}function Ze(e,t,n){const s=[];for(let i=0;i<e.length;i++){const r=e[i].slice();Ri(be,t[i]),lt(be,be,n),It(r,r,be),s.push(r)}return s}function ce(e,t,n){do{const s=e.getBucket("mesh","stroke",t,X.sinks.stroke.binder),i=n.length;for(let r=0;r<i-1;r++){const o=r+1;ns(s,n[r][0],n[r][1],n[r][2],n[o][0],n[o][1],n[o][2],void 0,!1,n[r][6],n[o][6],n[r][5],n[o][5])}}while(e.isOverloaded())}function se(e,t){return Qu([e[0]].concat(e,t.slice().reverse()))}function Qu(e){const t=e.length,n=[[],[],[],[],[],[]];e[0][6]!==void 0&&n.push([]);for(let s=0;s<t;s++){const i=Ge(s,t),r=e[s];n[0][i]=r[0],n[1][i]=r[1],n[2][i]=r[3],n[3][i]=r[2],n[4][i]=r[4]??0,n[5][i]=r[5]??0,n[6]&&(n[6][i]=r[6]??0)}return n}function Q(e){return{x:e[0],y:e[1],cut:e[2],signed_z:e[3],gradient:e[4],is_pivot:e[5],abs_z:e[6]}}function bc(e,t){return e=e.map(n=>n.slice()),rn(be,e[0],e[1]),sn(be,be),Vn(be,be,t),kn(e[0],e[0],be),rn(be,e[e.length-1],e[e.length-2]),sn(be,be),Vn(be,be,t),kn(e[e.length-1],e[e.length-1],be),e}const Ec=function(){const e=Math.cos(_e(Xu));return(t,n,s)=>(nn(ct,n,t),tn(ct,ct),nn(Jt,n,s),tn(Jt,Jt),wn(ct,Jt)<=e)}();function e0(e,t,n,s){return Pe([e,t.innerId,n],t,s)}const ui={symbol:"metricPoint",sinks:{fill:{stride:8,binder:(e,t)=>{e.views.position=new Uint16Array(t),e.views.texCoords=new Uint16Array(t,4)},packObjectAttributes:e0,unpackObjectAttributes:e=>({styleId:e[0],layerId:e[1],tiers:e[2],tileData:e.slice(3)})}},generate(e,t,n,s,i,r,o){n0(e,s,i,n,r);const a=de(i.style.width,r),c=de(i.style.height,r),l=de(i.style.rotation,r),[f,d]=th([t.x,t.y],a,c,l,o),u=q(i.ignoreTier,r)?null:r.tileAttrs[r.tileProps.db_tiers],p=e.getBucket("metricPoint","fill",ui.sinks.fill.packObjectAttributes(s.id,i,u,r),ui.sinks.fill.binder);let w=p.elements.offset;t0(p.indices,w,0,1,2,0,2,3),pi(p,w++,f[0],d[0],0,0),pi(p,w++,f[1],d[1],1,0),pi(p,w++,f[2],d[2],1,1),pi(p,w++,f[3],d[3],0,1),p.elements.offset=w}};function pi(e,t,n,s,i,r){t=t*4,e.views.position[t]=Y+n,e.views.position[t+1]=Y+s,e.views.texCoords[t]=Zt(i),e.views.texCoords[t+1]=Zt(r)}function t0(e,t,n,s,i,r,o,a){const c=e.buffer,l=e.offset;c[l]=t+n,c[l+1]=t+s,c[l+2]=t+i,c[l+3]=t+r,c[l+4]=t+o,c[l+5]=t+a,e.offset=l+6}function n0(e,t,n,s,i){const{rasterSets:r}=t,o=yr(s);Qn(n.style.iconImage).forEach(a=>{if(!a.length)return;const c=r.byKey[xa(a)];if(!c){console.error(`Not found raster set with texture ${a}`);return}if(!c.isSvg)return;const l=de(n.style.width,i),f=de(n.style.height,i),d=vr(l,f),u=l*d,p=f*d;e.atlasPacker.packSvg(c,[{w:u,h:p}],o),c.rasters.forEach(w=>e.atlasPacker.addRastersToLoad(t.id,w))})}const s0=64,gn=1e5,no=4;function i0(e){return e!==null&&typeof e=="object"&&e.type===s0}function Tc(e){return Sc(e.lo,e.hi)}function _c(e){return[e%gn,Math.floor(e/gn)%gn,0,0]}function r0(e){let n=0;for(let s=0;s<no;s++){const i=e[s]*4294967296+n;n=Math.floor(i/gn),e[s]=i%gn}}function o0(e,t){let n=0;for(let s=0;s<no;s++){const i=e[s]+t[s]+n;n=Math.floor(i/gn),e[s]=i%gn}}function a0(e){const t="00000";let n=!0,s=no,i="";for(;--s>=0;){const r=String(e[s]);n?e[s]!==0&&(i+=r,n=!1):i+=t.slice(r.length)+r}return i.length||(i="0"),i}function Sc(e,t){const n=_c(e),s=_c(t);return r0(s),o0(s,n),a0(s)}const Ce=[0,0,0],gi=[0,0,0],mi=new Float64Array(16),Bc={symbol:"tunnel",sinks:{},generate(e,t,n,s,i,r,o,a){var $;const{tileProps:c,tileAttrs:l}=s,f=($=l[c.db_tiers])==null?void 0:$[0];if(Tc(l[c.id])!=="70030076221371399"||!f)return;const u=t.id;Fe(Ce,0,0);const w=bt(r,Ce)*Te,A=le/r.size*w,h=1/(le/r.size),m=l[c.objectLength],I=l[c.componentDistanceStart]??0,M=l[c.componentDistanceEnd]??0,v=I===0?0:-5,S=175,T=243,F=M===m?0:-5;if(Number.isNaN(m)||Number.isNaN(I)||m===0)return;const E=T-S,B=S+E*I/m,k=S+E*M/m,U=3.5*A,g=5*A,x=[];let _=0;for(let V=0;V<i.x.length;V++){const G=[i.x[V],i.y[V],0];V>0&&(_+=zo(G,x[V-1]),G[2]=_),x.push(G)}const C=c0(x),y=ms(x);x.forEach(V=>{const G=V[2]/C;V[2]=(v+G*(F-v))*w,V[5]=(B+G*(k-B))*w});const b=X.sinks.stroke.packObjectAttributes(u,n,J.side,!0,s),P=Ze(x,y,U),D=Ze(x,y,-U),O=se(P,D),L=Ze(x,y,g),N=L.map(V=>{const G=V.slice();return G[2]=Math.max(0,G[2]),G});X.generate(e,u,n,J.side,s,Q(se(L,N)),r,o,a,void 0,"inverse");const R=Ze(x,y,-g),H=R.map(V=>{const G=V.slice();return G[2]=Math.max(0,G[2]),G});X.generate(e,u,n,J.side,s,Q(se(H,R)),r,o,a,void 0,"inverse"),x[0][2]!==0&&x[x.length-1][2]!==0&&X.generate(e,u,n,J.side,s,Q(se(N,H)),r,o,a,void 0,"inverse");do us.generate(e,u,n,s,Q(O),f,r,void 0);while(e.isOverloaded());for(let V=1;V<x.length;V++){const G=[],Z=[],ne=x[V-1],W=x[V],oe=y[V-1],te=y[V];for(let j=0;j<=181;j+=15){const z=_e(j),K=ne.slice();Oe(Ce,oe[0],oe[1],0),Vn(Ce,Ce,U),$t(gi,Ce),qo(mi,-z,gi),Ps(Ce,Ce,mi),Ce[2]*=h,kn(K,K,Ce),G.push(K);const re=W.slice();Oe(Ce,te[0],te[1],0),Vn(Ce,Ce,U),$t(gi,Ce),qo(mi,-z,gi),Ps(Ce,Ce,mi),Ce[2]*=h,kn(re,re,Ce),Z.push(re)}const ee=se(G,Z);if(X.generate(e,u,n,J.side,s,Q(ee),r,o,a,void 0,"fill"),V===1&&x[0][2]===0){ce(e,b,G);const j=x[0].slice(),z=x[0].slice(),K=y[0].slice(),re=y[0].slice();lt(K,K,g),lt(re,re,-g),It(j,j,K),It(z,z,re);const ae=j.slice(),ke=z.slice();ae[2]+=g*h,ke[2]+=g*h;const Se=[j];for(let Le=0;Le<5;Le++)Se.push(ae);for(let Le=0;Le<5;Le++)Se.push(ke);Se.push(z),ce(e,b,Se),X.generate(e,u,n,J.side,s,Q(se(Se,G)),r,o,a,void 0,"fill")}else if(V===x.length-1&&x[x.length-1][2]===0){ce(e,b,Z);const j=x[x.length-1].slice(),z=x[x.length-1].slice(),K=y[x.length-1].slice(),re=y[x.length-1].slice();lt(K,K,g),lt(re,re,-g),It(j,j,K),It(z,z,re);const ae=j.slice(),ke=z.slice();ae[2]+=g*h,ke[2]+=g*h;const Se=[j];for(let Le=0;Le<5;Le++)Se.push(ae);for(let Le=0;Le<5;Le++)Se.push(ke);Se.push(z),ce(e,b,Se),X.generate(e,u,n,J.side,s,Q(se(Z,Se)),r,o,a,void 0,"fill")}}if(x[0][2]===0||x[x.length-1][2]===0){const V=Ze(x,y,g),G=Ze(x,y,-g),Z=V.map(ee=>{const j=ee.slice();return j[2]=Math.max(0,j[2]+g*h),j}),ne=G.map(ee=>{const j=ee.slice();return j[2]=Math.max(0,j[2]+g*h),j});V.forEach(ee=>{ee[2]=Math.max(0,ee[2])}),G.forEach(ee=>{ee[2]=Math.max(0,ee[2])});const W=se(V,Z),oe=se(ne,G);ce(e,b,V),ce(e,b,G),ce(e,b,Z),ce(e,b,ne),X.generate(e,u,n,J.side,s,Q(W),r,o,a,void 0,"fill"),X.generate(e,u,n,J.side,s,Q(oe),r,o,a,void 0,"fill");const te=se(Z,ne);X.generate(e,u,n,J.top,s,Q(te),r,o,a,void 0,"fill")}}};function c0(e){let t=0;for(let n=0;n<e.length-1;n++)t+=Go(e[n],e[n+1]);return t}var Fc=(e=>(e[e.Chess=1]="Chess",e[e.DoubleDash=2]="DoubleDash",e[e.Stripe=3]="Stripe",e[e.Triangles=4]="Triangles",e[e.Circle=5]="Circle",e[e.Chevron=6]="Chevron",e[e.None=-1]="None",e))(Fc||{});const l0={symbol:"simpleMesh",sinks:{fill:{stride:24,binder:()=>{},packObjectAttributes(e,t,n){return Pe([e,t.innerId],t,n)},unpackObjectAttributes(e){return{styleId:e[0],layerId:e[1],tileData:e.slice(2)}}}}},f0=32,wi={symbol:"globe",sinks:{fill:{stride:16,binder:(e,t)=>{e.views.ecefPosition=new Int16Array(t),e.views.flatPosition=new Uint16Array(t,6),e.views.texture=new Uint16Array(t,12)},packObjectAttributes(e,t,n){return[e,t.innerId,n]},unpackObjectAttributes(e){return{styleId:e[0],layerId:e[1],tileData:e.slice(2)}},generate(e,t,n,s){const i=s.coords.join("/"),r=e.getBucket("globe","fill",wi.sinks.fill.packObjectAttributes(t.id,n,i),wi.sinks.fill.binder);u0(r,f0,s.coords)}}}},d0=Yt.fromGeo([0,90]),h0=Yt.fromGeo([0,-90]);function u0(e,t,n){const s=Bt(n),i=e.views.ecefPosition,r=e.indices.buffer,o=n[1]===2**n[2]-1,a=n[1]===0,c=e.elements.offset*wi.sinks.fill.stride/Uint16Array.BYTES_PER_ELEMENT;let l=0,f=e.indices.offset;for(let d=0;d<t;d++)for(let u=0;u<t;u++){let p;const w=[d*32768/(t-1),u*32768/(t-1)];o&&u===t-1?p=d0:a&&u===0?p=h0:p=or(s,w),i[c+l++]=p[0]*$e,i[c+l++]=p[1]*$e,i[c+l++]=p[2]*$e,i[c+l++]=Y+w[0],i[c+l++]=Y+w[1],i[c+l++]=0,i[c+l++]=d/(t-1)*(2**16-1),i[c+l++]=u/(t-1)*(2**16-1)}for(let d=0;d<t-1;d++)for(let u=0;u<t-1;u++){const p=d*t+u,w=p+1,A=p+t,h=A+1;r[f++]=p,r[f++]=A,r[f++]=w,r[f++]=w,r[f++]=A,r[f++]=h}e.indices.offset=f,e.elements.offset=c+l/8}function p0({collector:e,generator:t,args:n}){do t(e,...n);while(e.isOverloaded())}const g0={arrow:zs,line:qe,polygon:Wt,embankment:X,polygon3d:X,metricPoint:ui,labelLine:$r,lineExtrusion:qt,polygonExtrusion:Pn,oneWayLine:zr,dashedLine:Xt,shiftedLine:ks,circle:Pr,buildingModel:Ht,gltfModel:On,point:Ut,raster:Tr,heatmap:Bn,dem:at,mesh:X,mapMesh:us,overpass:Pc,tunnel:Bc,simpleMesh:l0,globe:wi};function Oc(e,t){const n=g0[e];return n?n.sinks[t].stride:0}function Dc(e,t){e.precomputes.forEach((n,s)=>{t.tileData[s]=q(n.expr,t)})}function yi(e,t,n,s,i,r,o,a,c,l,f,d,u,p){n.forEach(w=>{if(hd(s,[f.x[0],f.y[0]]),!(o!==void 0&&(w.maxzoom<=o||w.minzoom>=o+1&&o!==Ni.maxDetailLevel))&&!(s.tileProps.hovered&&!Number.isNaN(s.tileAttrs[s.tileProps.hovered])&&s.tileAttrs[s.tileProps.hovered]===1&&w.type!=="polygon"&&w.type!=="polygonExtrusion"&&w.type!=="point"&&w.type!=="polygon3d")){Dc(w,s);do switch(w.type){case"line":const A=q(w.style.pattern,s);A&&A[0]!==Fc.None?qe.generatePatterned(e,t.id,w,s,c,f):qe.generate(e,t.id,w,s,c,f);break;case"dashedLine":Xt.generate(e,t.id,w,s,c,f);break;case"shiftedLine":ks.generate(e,t.id,w,s,f);break;case"polygon":Wt.generate(e,t.id,w,s,f,l,t.rasterSets);break;case"polygon3d":case"embankment":X.generate(e,t.id,w,J.top,s,f,c,l,t.rasterSets,void 0,"fill");break;case"metricPoint":{ui.generate(e,f,l,t,w,s,c);break}case"polygonExtrusion":Pn.generate(e,t.id,w,s,f);break;case"labelLine":Su(e,t.id,w,c.coords,a,s,f);break;case"oneWayLine":Bu(e,t.id,w,c.coords,a,s,f);break;case"point":{Tu(e,t,w,s,i,r,c.coords,a,f,l,d);break}case"lineExtrusion":qt.generate(e,t.id,w,s,f);break;case"arrow":zs.generate(e,t.id,w,s,f);break;case"heatmap":{Bn.generate(e,t.id,w,f,s);break}case"gltfModel":{On.generateInstances(e,t,w,s,f,c,a,u,p,i,2);break}case"overpass":Pc.generate(e,t,w,s,f,c,l,t.rasterSets);break;case"tunnel":Bc.generate(e,t,w,s,f,c,l,t.rasterSets);break}while(e.isOverloaded())}})}const vi=.8;class m0{constructor(t,n){this.offset=0,this.stride=n,this.buffer=new ArrayBuffer(t),this.view=new Int32Array(this.buffer),this.comittedOffsets=0,this.maximum=t/n,this.watermark=this.maximum*vi}extend(){const t=this.buffer.byteLength*2;this.maximum=t/this.stride,this.watermark=this.maximum*vi;const n=new ArrayBuffer(t),s=new Int32Array(n);return s.set(this.view),this.buffer=n,this.view=s,n}}class w0{constructor(t){this.offset=0,this.buffer=new Int32Array(t),this.comittedOffsets=0,this.watermark=t*vi}extend(){const t=this.buffer.length*2;this.watermark=t*vi;const n=new Int32Array(t);n.set(this.buffer),this.buffer=n}}class Lc{constructor(t,n,s,i,r,o){this.objectsData={},this.extents=new Uint16Array([st,st,st,0,0,0]),this.maxDiag=0,this.drawMode=r;const a=t!=="buildingModel"?67200:67200*5,c=Oc(t,n);this.elements=new m0(a,c),this.indices=new w0(a*2/c),this.views={},this.binder=i,i(this,this.elements.buffer),this.attributes=s,this.key=o}static generateKey(t){return JSON.stringify(t)}resetOffsets(){this.elements.offset=0,this.elements.comittedOffsets=0,this.indices.offset=0,this.indices.comittedOffsets=0}resetBuildingsData(){this.objectsData={}}resetInstancesExtents(){this.extents[0]=st,this.extents[1]=st,this.extents[2]=st,this.extents[3]=0,this.extents[4]=0,this.extents[5]=0,this.maxDiag=0}commit(){this.elements.comittedOffsets=this.elements.offset,this.indices.comittedOffsets=this.indices.offset}rollback(){this.elements.offset=this.elements.comittedOffsets,this.indices.offset=this.indices.comittedOffsets}checkWatermarks(){let t=0;const n=this.elements;n.offset>n.watermark&&(n.offset>=n.buffer.byteLength/n.stride&&(t=1),this.binder(this,n.extend()));const s=this.indices;return s.offset>s.watermark&&(s.offset>=s.buffer.length&&(t=1),s.extend()),t}}function nt(e,t,n){n=n||{},this.w=e||64,this.h=t||64,this.autoResize=!!n.autoResize,this.shelves=[],this.freebins=[],this.stats={},this.bins={},this.maxId=0}nt.prototype.pack=function(e,t){e=[].concat(e),t=t||{};for(var n=[],s,i,r,o,a=0;a<e.length;a++)if(s=e[a].w||e[a].width,i=e[a].h||e[a].height,r=e[a].id,s&&i){if(o=this.packOne(s,i,r),!o)continue;t.inPlace&&(e[a].x=o.x,e[a].y=o.y,e[a].id=o.id),n.push(o)}return this.shrink(),n},nt.prototype.packOne=function(e,t,n){var s={freebin:-1,shelf:-1,waste:1/0},i=0,r,o,a,c;if(typeof n=="string"||typeof n=="number"){if(r=this.getBin(n),r)return this.ref(r),r;typeof n=="number"&&(this.maxId=Math.max(n,this.maxId))}else n=++this.maxId;for(c=0;c<this.freebins.length;c++){if(r=this.freebins[c],t===r.maxh&&e===r.maxw)return this.allocFreebin(c,e,t,n);t>r.maxh||e>r.maxw||t<=r.maxh&&e<=r.maxw&&(a=r.maxw*r.maxh-e*t,a<s.waste&&(s.waste=a,s.freebin=c))}for(c=0;c<this.shelves.length;c++)if(o=this.shelves[c],i+=o.h,!(e>o.free)){if(t===o.h)return this.allocShelf(c,e,t,n);t>o.h||t<o.h&&(a=(o.h-t)*e,a<s.waste&&(s.freebin=-1,s.waste=a,s.shelf=c))}if(s.freebin!==-1)return this.allocFreebin(s.freebin,e,t,n);if(s.shelf!==-1)return this.allocShelf(s.shelf,e,t,n);if(t<=this.h-i&&e<=this.w)return o=new so(i,this.w,t),this.allocShelf(this.shelves.push(o)-1,e,t,n);if(this.autoResize){var l,f,d,u;return l=f=this.h,d=u=this.w,(d<=l||e>d)&&(u=Math.max(e,d)*2),(l<d||t>l)&&(f=Math.max(t,l)*2),this.resize(u,f),this.packOne(e,t,n)}return null},nt.prototype.allocFreebin=function(e,t,n,s){var i=this.freebins.splice(e,1)[0];return i.id=s,i.w=t,i.h=n,i.refcount=0,this.bins[s]=i,this.ref(i),i},nt.prototype.allocShelf=function(e,t,n,s){var i=this.shelves[e],r=i.alloc(t,n,s);return this.bins[s]=r,this.ref(r),r},nt.prototype.shrink=function(){if(this.shelves.length>0){for(var e=0,t=0,n=0;n<this.shelves.length;n++){var s=this.shelves[n];t+=s.h,e=Math.max(s.w-s.free,e)}this.resize(e,t)}},nt.prototype.getBin=function(e){return this.bins[e]},nt.prototype.ref=function(e){if(++e.refcount===1){var t=e.h;this.stats[t]=(this.stats[t]|0)+1}return e.refcount},nt.prototype.unref=function(e){return e.refcount===0?0:(--e.refcount===0&&(this.stats[e.h]--,delete this.bins[e.id],this.freebins.push(e)),e.refcount)},nt.prototype.clear=function(){this.shelves=[],this.freebins=[],this.stats={},this.bins={},this.maxId=0},nt.prototype.resize=function(e,t){this.w=e,this.h=t;for(var n=0;n<this.shelves.length;n++)this.shelves[n].resize(e);return!0};function so(e,t,n){this.x=0,this.y=e,this.w=this.free=t,this.h=n}so.prototype.alloc=function(e,t,n){if(e>this.free||t>this.h)return null;var s=this.x;return this.x+=e,this.free-=e,new y0(n,s,this.y,e,t,e,this.h)},so.prototype.resize=function(e){return this.free+=e-this.w,this.w=e,!0};function y0(e,t,n,s,i,r,o){this.id=e,this.x=t,this.y=n,this.w=s,this.h=i,this.maxw=r||s,this.maxh=o||i,this.refcount=0}class v0{constructor(){this.packer=new nt(Qt[0],Qt[1]),this.currentAtlasIndex=0,this.packedRasters=[],this.rastersToLoad=[],this.newRasterSets=new Map}addNewRasterSet(t,n){let s=this.newRasterSets.get(t);s||(s=[],this.newRasterSets.set(t,s)),s.push(n)}pack(t,n,s){t.isSvg?this.packSvg(t,n.map(i=>({w:i,h:i})),s):this.packPng(t,n,s)}packSvg(t,n,s){const{rasters:i}=t,r=new Set;for(const{w:o,h:a}of i)r.add(`${o}_${a}`);for(const o of n){const a=o.w*s,c=o.h*s;if(r.has(`${a}_${c}`))continue;let l=this.packer.packOne(a+2,c+2);l===null&&(this.packer=new nt(Qt[0],Qt[1]),this.currentAtlasIndex++,l=this.packer.packOne(a+2,c+2));const f=i.length,d={rasterSetIndex:t.index,rasterIndex:f,w:a,h:c,x:l.x+1,y:l.y+1,anchorX:t.anchorX,anchorY:t.anchorY,atlasIndex:this.currentAtlasIndex,isPacked:!0};i.push(d),this.packedRasters.push(t.index,f,d.x,d.y,d.w,d.h,this.currentAtlasIndex)}}addRastersToLoad(t,n){this.rastersToLoad.push(t,n.rasterSetIndex,n.rasterIndex)}getNewRasterSets(){const t=this.newRasterSets;return this.newRasterSets=new Map,t}getPackedRasters(){if(this.packedRasters.length===0)return;const t=new Uint16Array(this.packedRasters);return this.packedRasters=[],t}getRastersToLoad(){const t=new Float64Array(this.rastersToLoad);return this.rastersToLoad=[],t}packPng(t,n,s){const{rasters:i}=t;for(const r of n){const o=r*s,a=ac(i,o,!1);if(a===void 0)continue;const c=t.rasters[a];if(c.isPacked)continue;let l=this.packer.packOne(c.w+2,c.h+2);l===null&&(this.packer=new nt(Qt[0],Qt[1]),this.currentAtlasIndex++,l=this.packer.packOne(c.w+2,c.h+2)),c.x=l.x+1,c.y=l.y+1,c.atlasIndex=this.currentAtlasIndex,c.isPacked=!0,this.packedRasters.push(t.index,a,c.x,c.y,c.w,c.h,this.currentAtlasIndex)}}}const x0=2**32-1;class I0{constructor(){this.colorById=new Map,this.index=0}getIndex(t){if(!t)return this.nextIndex();const n=this.colorById.get(t);if(n!==void 0)return n;const s=this.nextIndex();return this.colorById.set(t,s),s}nextIndex(){return++this.index%x0}}const Nc=2**20,Rc=["main","parser","labeling","models"],io={};for(let e=0;e<Rc.length;e++){const t=Rc[e];io[t]={min:1+e*Nc,max:(e+1)*Nc}}class A0{constructor(t){this.atlasPacker=new v0,this.pointIndexer=new I0,this.floorHidingMap=new Map,this.usedModels=new Set,this.dataModels={},this.promotedObjectAttributes={},this.addedBuckets=[],this.labels=[],this.idIndexer=new Kh(t),this.workerName=t,this.dataModelsIndex=io[t].min,this.buckets={},this.geoJsonData=[],this.reset()}reset(){this.buckets={},this.geoJsonData=[],this.addedBuckets=[],this.floorHidingMap.clear(),this.labels=[],this.usedModels.clear()}getStatsAfterReset(){return{buckets:Object.keys(this.buckets).length,geoJsonData:this.geoJsonData.length,addedBuckets:this.addedBuckets.length,floorHidingMap:this.floorHidingMap.size,labels:this.labels.length,usedModels:this.usedModels.size}}addLabel(t){this.labels.push(t)}addUsedModel(t){this.usedModels.add(t)}getIndexerStats(){return this.idIndexer.getIndexerStats()}getBucketsMemoryFootprint(){return Object.keys(this.buckets).map(t=>{const n=t,s=this.buckets[n];return s?{[t]:Object.keys(s).map(i=>{const r=s[i];if(r&&typeof r=="object"){const o=Object.keys(r).map(a=>{const c=r[a];if(c&&c.elements&&c.elements.buffer)return{elementsBuffer:c.elements.buffer.byteLength,indices:c.indices.buffer.byteLength}});return{[i]:o}}return{[i]:0}})}:{[t]:[]}})}addPromotedObjectAttributes(t,n){this.promotedObjectAttributes[t]=n}addFeature(t){this.geoJsonData.push(t)}addUsedModelByUrl(t){const n=this.dataModels[t];if(n!==void 0)return n;const{min:s,max:i}=io[this.workerName];this.dataModelsIndex=s+(this.dataModelsIndex+1-s)%(i-s);const r=-this.dataModelsIndex;return this.dataModels[t]=r,r}getDataModelsUrls(){const t={};for(const n in this.dataModels)this.usedModels.has(this.dataModels[n])&&(t[n]=this.dataModels[n]);return t}getBucket(t,n,s,i,r=Li){let o=this.buckets[t];o===void 0&&(o={},this.buckets[t]=o);let a=o[n];a===void 0&&(a=o[n]={});const c=Lc.generateKey(s),l=a[c];if(l)return this.addedBuckets.push(l),l;const f=new Lc(t,n,s,i,r,c);return a[c]=f,this.addedBuckets.push(f),f}isOverloaded(){const t=this.addedBuckets;let n=0,s=0;for(;s<t.length;)n=n+t[s++].checkWatermarks();const i=n>0;if(i)for(;s--;)t[s].rollback();else for(;s--;)t[s].commit();return t.length=0,i}addFloorHidingMap(t,n){let s=this.floorHidingMap.get(n);s===void 0&&(s=[],this.floorHidingMap.set(n,s)),s.push(t)}getAccumulatedData(){const t=this.buckets,n=[],s=[];for(const u in t){const p=u,w=t[p];for(const A in w){const h=A,m=w[h],I=Oc(p,h)/4;let M=0;for(const F in m)M+=m[F].indices.offset;if(M===0)continue;const v=[],S=new Int32Array(M*I);let T=0;for(const F in m){const E=m[F],{elements:B,indices:k,attributes:U,meta:g,objectsData:x,extents:_,maxDiag:C}=E,{view:y}=B,{buffer:b}=k;if(B.offset===0)continue;const P=T,D={};for(let O=0;O<k.offset;O++){const L=x?x[O]:null;if(L){const R=T/I;M0(L,R,D)}const N=b[O]*I;for(let R=0;R<I;R++)S[T++]=y[N+R]}v.push({attributes:U,drawMode:E.drawMode,rangeStart:P*4,rangeEnd:T*4,meta:g,objectsData:Object.keys(D).length>0?D:void 0,extents:new Uint16Array(_),maxDiag:C}),E.resetOffsets(),E.resetBuildingsData(),E.resetInstancesExtents(),E.meta=void 0}n.push({symbol:p,sink:h,buffer:S.buffer,generatedObjects:v}),s.push(S.buffer)}}const i=this.idIndexer.getPacked();s.push(i.centerBuffer),s.push(i.instanceIdBuffer),s.push(i.layerIdBuffer),s.push(i.objectClassBuffer),s.push(i.phaseBuffer),s.push(i.styleIdBuffer),s.push(i.sublayerBuffer);const r=this.atlasPacker.getPackedRasters();r!==void 0&&s.push(r.buffer);const o=this.atlasPacker.getRastersToLoad();s.push(o.buffer);const a=this.getDataModelsUrls();this.usedModels=new Set;const c=this.floorHidingMap;this.floorHidingMap=new Map;const l=this.labels;this.labels=[];const f=this.promotedObjectAttributes;this.promotedObjectAttributes={};const d=this.geoJsonData.length?this.geoJsonData:void 0;return this.geoJsonData=[],{data:n,labels:l,floorHidingMap:c,packedRasters:r,rastersToLoad:o,dataModelsUrls:a,identifyIds:i,transferable:s,promotedObjectAttributes:f,debugGeoJsonData:d}}}function M0(e,t,n){const s=e.objectId;n[s]||(n[s]=[]);let i=!1;for(const r of n[s]){const o=r.offset+r.size,a=t+e.size;(r.offset<=t&&o>=t||t<=r.offset&&a>=r.offset)&&(r.offset=Math.min(t,r.offset),r.size=Math.max(o,a)-r.offset,i=!0)}i||n[s].push({offset:t,size:e.size})}function xi(e,t){const n=new XMLHttpRequest;if(n.open("GET",e.url,!0),n.responseType="arraybuffer",e.headers)for(const s in e.headers)n.setRequestHeader(s,e.headers[s]);return n.onerror=function(){t({status:0,message:"Network error"},new ArrayBuffer(0))},n.onload=function(){n.status>=200&&n.status<300&&n.response?t(void 0,n.response):t({status:n.status,message:n.statusText},new ArrayBuffer(0))},n.send(),n}function Uc(e,t){const n=new XMLHttpRequest;if(n.open("GET",e.url,!0),e.headers)for(const s in e.headers)n.setRequestHeader(s,e.headers[s]);return n.onerror=function(){t({status:0,message:"Network error"},{})},n.onload=function(){if(n.status>=200&&n.status<300){if(!n.response||!n.response.length)return t({status:204,message:"No content"},{});let s;try{s=JSON.parse(n.response),t(void 0,s)}catch{t({status:0,message:`Json parse data error from url ${e.url}`},{})}}else t({status:n.status,message:n.statusText},{})},n.send(),n}function Cc(e){return e?e>=500&&e<=599:!1}var Ii=(e=>(e[e.Main=0]="Main",e[e.Parser=1]="Parser",e[e.Labeling=2]="Labeling",e[e.Models=3]="Models",e[e.All=4]="All",e))(Ii||{}),ws=(e=>(e[e.FunctionUse=0]="FunctionUse",e[e.FunctionResult=1]="FunctionResult",e))(ws||{});class P0{constructor(){this.events={}}on(t,n){let s=this.events[t];return s||(s=this.events[t]=[]),s.push(n),this}once(t,n){const s=i=>{this.off(t,s),n.call(this,i)};return this.on(t,s),this}off(t,n){const s=this.events[t];if(!s)return this;const i=s.indexOf(n);return i!==-1&&s.splice(i,1),this}emit(t,n){const s=this.events[t];if(!s)return this;const i=s.slice();for(let r=0;r<i.length;r++)i[r].call(this,n);return this}}class b0 extends P0{constructor(t){super(),this.worker=t,t.addEventListener("message",n=>{const s=n.data;this.emit("message",s)})}send(t,n,s){const i={to:t,msg:n,transferable:s};this.worker.postMessage(i,s)}broadcast(t){const n={to:Ii.All,msg:t};this.worker.postMessage(n)}}class E0{constructor(t){this.onMessage=n=>{const{from:s,msg:i}=n;switch(i.type){case ws.FunctionUse:this.onFunctionUse(i,s);break;case ws.FunctionResult:this.onFunctionResult(i);break}},this.connector=t,this.functions=new Map,this.functionIdCounter=0,this.pendingFunctions=new Map,t.on("message",this.onMessage)}set(t,n){this.functions.set(t,n)}get(t,n){return(...s)=>{const i=this.functionIdCounter++,r=new Promise(a=>{this.pendingFunctions.set(i,a)}),o={type:ws.FunctionUse,data:{id:i,name:n,args:s}};return this.connector.send(t,o),r}}onFunctionUse(t,n){const{data:{name:s,args:i,id:r}}=t,o=this.functions.get(s);if(o){const a=o(...i);a&&a.then?Promise.resolve(a).then(c=>this.sendFunctionResult(n,r,c)):this.sendFunctionResult(n,r,a)}else console.error(`FnRegistry#onFunctionUse: function ${s} not found`)}sendFunctionResult(t,n,s){const i={type:ws.FunctionResult,data:{id:n,result:s}};s&&s.transferable?this.connector.send(t,i,s.transferable):this.connector.send(t,i)}onFunctionResult(t){const{data:{id:n,result:s}}=t,i=this.pendingFunctions.get(n);i?(i(s),this.pendingFunctions.delete(n)):console.error(`FnRegistry#onFunctionResult: pending function ${n} not found`)}}const ro=4;function T0(e,t,n,s,i,r,o,a,c){if(!n)return e.getAccumulatedData();const l=a.coords[3],{tileProps:f}=t,d=Object.keys(f).length,u=[],p=Ns(r),w=In(i,Bs,f,u,tr,void 0,a);for(const A of o.tile){const{color:h=0,color2:m=0,geo:I,road:M,normals:v,zLevel:S=0,is_immersive:T,logicalLevels:F}=A;for(let E=0;E<d;E++)u[E]=NaN;u[f.db_sublayer]="Traffic_jams",u[f.traffic_color]=h,u[f.traffic_color2]=m,u[f.traffic_road_class]=M,u[f.traffic_road_z_level]=S,u[f.db_tiers]=F?[Wu(F.begin,F.end)]:void 0,u[f.db_has_immersive_counterpart]=Number(T),u[f.beginningIsCut]=0,u[f.endingIsCut]=0;for(let E=0;E<I.length;E++){const B=I[E],k=v[E],U=[],g=[],x=[],_=[];for(let b=0;b<B.length;b++)U[b]=B[b][0]*xs,g[b]=B[b][1]*xs,x[b]=k[b][0],_[b]=k[b][1];const C={x:U,y:g,normal_x:x,normal_y:_},y=s.getLayers(n.id,f,u).filter(b=>q(b.filter,w));y.length===0&&w.id&&e.idIndexer.addOrphanId(w.id),yi(e,n,y,w,t,ro,l,c,a,p,C)}}return e.getAccumulatedData()}let oo=[];function _0(e,t,n,s,i,r,o,a,c){var v,S;const{tileProps:l,dictionaries:f}=s,d=Object.keys(l).length,u=new Set(o),p=[];if(((v=f.db_sublayer)==null?void 0:v.s_personal_poi)===void 0)return e.getAccumulatedData();for(let T=0;T<d;T++)p[T]=NaN;const w=Ns(r),A=yn(),h=[];for(const T of a){const F=Ie.fromGeo(T.point);Jo(A,F),h.push(F)}const m=Hf(A),I=Bt(m),M=In(n,Bs,l,p,tr,void 0,I);for(let T=0;T<a.length;T++){const F=a[T],E=Je();pt(E,h[T],I);const B=F.id;M.id=B;const k={x:[E[0]],y:[E[1]]};for(let g=0;g<d;g++)p[g]=NaN;p[l.db_sublayer]="s_personal_poi",p[l.db_object_class]=F.humanReadableClassId??((S=s.reverseDictionaries.db_object_class)==null?void 0:S[F.classId]),p[l.db_label]=F.name,p[l.db_icon_priority]=1,p[l.db_label_priority]=0,p[l.selected]=u.has(B)?1:0,p[l.db_region]=i,oo=t.layers.filter(g=>q(g.filter,M)),oo.length===0&&M.id&&e.idIndexer.addOrphanId(M.id),yi(e,t,oo,M,s,ro,void 0,c,I,w,k)}return e.getAccumulatedData()}class S0{constructor(){this.cache=new Map,this.pendingRequests=new Map}fetch(t,n,s,i,r){return new Promise(o=>{const a=B0(t,i,r,n,s),c=ut(t),l=Uc({url:a},(f,d)=>{if(this.pendingRequests.delete(c),f!==void 0){f.status!==204&&console.error(f),this.cache.set(c,void 0),o();return}const u=d[0];u?this.cache.set(c,u):this.cache.set(c,void 0),o()});this.pendingRequests.set(c,{xhr:l,resolve:o})})}get(t){return this.cache.get(t)}delete(t){this.cache.delete(t)}abortRequest(t){const n=this.pendingRequests.get(t);n!==void 0&&(n.xhr.abort(),n.resolve(),this.pendingRequests.delete(t))}}function B0(e,t,n,s,i){const r=2**e[2]-1,o=e[0],c=(r-e[1]&16777215)*(1<<24)+(o&16777215);return sr(Ll.url,{protocol:i,host:s,z:String(e[2]),tiles:String(c),regions:t.join(","),time:String(n)})}function ys(e){return typeof e!="boolean"&&e.type==="attrs"}function kc(e){return typeof e!="boolean"&&e.type==="unextractable"}function Ai(e){if(!Ft(e))return[!!e];let t=[];const n=[];switch(e.type){case"all":const i=e.array.map(Ai);for(const a of i){const c=[];for(const l of a){if(l===!1)return[!1];ys(l)?c.push(l):kc(l)&&n.push(l)}c.length>0&&(t.length===0?t=c:t=Vc(t,c))}break;case"match":if(!cr(e.input))return[{type:"unextractable",exp:e}];if(e.input.type==="precompute")return[{type:"unextractable",exp:e}];const r=e.input.property,o=e.defaultOutput;for(const a of e.cases){const c=Ai(a.output),l=[];a.values.forEach(f=>{l.push({type:"attrs",attrs:{[r]:f}})});for(const f of c)if(ys(f))for(const d of Vc([f],l))t.push(d);else if(kc(f)){n.push(f);for(const d of l)t.push(d)}else if(f===!0&&!o)for(const d of l)t.push(d)}break;case"==":{let a,c;if(cr(e.leftValue)&&ya(e.rightValue))a=e.leftValue.property,c=e.rightValue;else if(cr(e.rightValue)&&ya(e.leftValue))a=e.rightValue.property,c=e.leftValue;else return[{type:"unextractable",exp:e}];t.push({type:"attrs",attrs:{[a]:c}});break}default:return[{type:"unextractable",exp:e}]}return t.concat(n)}function Vc(e,t){const n=[];for(const s of e)for(const i of t)n.push({type:"attrs",attrs:{...s.attrs,...i.attrs}});return n}class F0{constructor(){this.layers=[],this.keyStat={},this.orderedKeys=[],this.tree=null,this.treeNodesCount=0,this.traverseCount=0,this.traverseIterations=0}addLayers(t){for(const n of t)n.type==="custom"||!n.filter||(this.layers.push(n),this.statLayerKeys(n));this.buildTree()}getLayers(t,n){const s=[],i=(r,o)=>{if(this.traverseIterations+=1,!r)return;for(const f of r.leafs)s.push(f);const a=this.orderedKeys[o];if(!a)return;const c=n[t[a]],l=i0(c)?Tc(c):c;l!==void 0&&i(r.children[l],o+1),i(r.novalue,o+1)};return this.traverseCount+=1,i(this.tree,0),s}stat(){const t=this.traverseIterations/this.traverseCount||0;return{tree:this.tree,treeNodes:this.treeNodesCount,layers:this.layers.length,keyStat:this.keyStat,itersPerTraverse:t}}statLayerKeys(t){const s=Ai(t.filter).filter(i=>ys(i))[0];if(!(!s||!ys(s)))for(const i in s.attrs)this.keyStat[i]===void 0&&(this.keyStat[i]=0),this.keyStat[i]+=1}getOrderedKeys(){return Object.entries(this.keyStat).sort(([n,s],[i,r])=>r-s).map(([n,s])=>n)}buildTree(){this.orderedKeys=this.getOrderedKeys();const t=[];for(const n of this.layers){const i=Ai(n.filter).filter(ys);i.length===0&&t.push(n);for(const r of i){const o=new Set(Object.keys(r.attrs));let a=0;const c=r.attrs;let l=this.tree;for(let f=0;f<=this.orderedKeys.length;f++){if(a===o.size){l==null||l.leafs.push(n);break}const d=this.orderedKeys[f],u=this.orderedKeys[f+1]||"";if(l||(l=this.makeTreeNode(d),this.tree===null&&(this.tree=l)),o.has(d)){const p=c[d];l.children[p]||(l.children[p]=this.makeTreeNode(u)),l=l.children[p],a+=1}else l.novalue||(l.novalue=this.makeTreeNode(u)),l=l.novalue}}}t.length>0&&(this.tree||(this.tree=this.makeTreeNode("")),this.tree.leafs=t)}makeTreeNode(t){return this.treeNodesCount+=1,{key:t,children:{},novalue:null,leafs:[]}}}class O0{constructor(){this.metaStyles=new Map,this.layerTrees=new Map}proxySyncStyle(t){const n=new F0;n.addLayers(t.layers),this.layerTrees.set(t.id,n),this.metaStyles.set(t.id,t)}getStyle(t){return this.metaStyles.get(t)}getLayers(t,n,s){const i=this.layerTrees.get(t);return i?i.getLayers(n,s):[]}}class D0{constructor(t){this.fnRegistry=t,this.onClassCreate=({id:n,name:s,args:i})=>{const r=this.classes.get(s);if(!r){console.error(`ClassRegistry#onClassCreate: class ${s} not found`);return}const o=r.scope?new r.ClassConstructor(r.scope,...i):new r.ClassConstructor(...i);r.hosts.set(n,o)},this.onMethodUse=({id:n,name:s,method:i,args:r})=>{const o=this.classes.get(s);if(!o){console.error(`ClassRegistry#onMethodUse: class ${s} not found`);return}const a=o.hosts.get(n);if(!a){console.error(`ClassRegistry#onMethodUse: instance ${n} in class ${s} not found when calling the ${i} method`);return}if(!a[i]){console.error(`ClassRegistry#onMethodUse: method ${i} in instance ${n} in class ${s} not found`);return}return i==="destroy"&&o.hosts.delete(n),a[i](...r)},this.classes=new Map,this.idCounter=0,this.fnRegistry.set("createClass",this.onClassCreate),this.fnRegistry.set("classMethodUse",this.onMethodUse)}set(t,n,s){const i=this,r={ClassConstructor:n,hosts:new Map,proxies:new Map,scope:s};return this.classes.set(t,r),{get:o=>{class a{constructor(...f){this.id=i.idCounter++,i.fnRegistry.get(o,"createClass")({id:this.id,args:f,name:t})}}return Object.getOwnPropertyNames(n.prototype).forEach(l=>{l!=="constructor"&&(a.prototype[l]=function(...f){return i.fnRegistry.get(o,"classMethodUse")({id:this.id,name:t,method:l,args:f})})}),a}}}}const L0={point:{point:!0,heatmap:!0,gltfModel:!0,metricPoint:!0},polygon:{polygon:!0,polygonExtrusion:!0,mesh:!0,embankment:!0,polygon3d:!0,overpass:!0},line:{line:!0,lineExtrusion:!0,labelLine:!0,dashedLine:!0,oneWayLine:!0,metricPoint:!0,overpass:!0}};function N0(e,t){return!!L0[e][t]}function R0(e){const t=e.vertices.x,n=e.vertices.y;let s=0;for(let i=0;i<t.length-1;i++)s+=Math.hypot(t[i]-t[i+1],n[i]-n[i+1]);return s}function ao(e,t){const n=new Set(t[0].map((s,i)=>t[0][i]===e[0]&&e[1]===t[1][i]?i:-1));return Array.from(n)}function U0(e,t,n,s){t>=0&&n>=0&&Math.abs(t-n)===1&&(e[2][0]=1),n>=0&&s>=0&&Math.abs(n-s)===1&&(e[2][1]=1),t>=0&&s>=0&&Math.abs(t-s)===1&&(e[2][2]=1)}function Yc(e,t){const n=ao([e[0][0],e[1][0]],t),s=ao([e[0][1],e[1][1]],t),i=ao([e[0][2],e[1][2]],t);n.forEach(r=>s.forEach(o=>i.forEach(a=>{U0(e,r,o,a)})))}function C0(){return da(["id","db_label","db_label2","selected","hovered","componentDistanceStart","componentDistanceEnd","objectLength","beginningIsCut","endingIsCut","db_geometry_type","db_plan_id"],["GEOJSON_METATILE_UNKNOWN_SUBLAYER","Commercial_poi_default","Commercial_poi_city","Commercial_poi_premium","Commercial_model","Immersive_model","Immersive_model_multipart","Animated_immersive_model"])}function k0(e){if(e<0||e>4)throw new Error("[2gl] Invalid attribute location count. Must be 1, 2, 3 or 4")}const ie=class ie{constructor(t,n,s=!1,i=!1){this.elementsType=null,this.isDirty=!0,this._glBuffer=null,this._glContext=null,this._initData=t,this.byteLength=t.byteLength,this.type=s?ie.ElementArrayBuffer:ie.ArrayBuffer,this.options=Object.assign({},ie.defaultOptions,n),this.drawType=(n==null?void 0:n.drawType)??ie.StaticDraw;const r=[ie.UnsignedByte,ie.UnsignedShort,ie.UnsignedInt];s&&!r.includes(this.options.dataType)&&(console.warn("Please provide dataType of one of the following values:Buffer.UnsignedByte, Buffer.UnsignedShort, Buffer.UnsignedInt. Defaulting to UnsignedInt"),this.options.dataType=ie.UnsignedInt),this._preserveData=i}static _dataTypeSize(t){switch(t){case ie.Byte:case ie.UnsignedByte:return 1;case ie.UnsignedShort:case ie.Short:return 2;case ie.Float:case ie.Int:case ie.UnsignedInt:return 4}throw new Error(`[2gl] Unsupported Buffer data type: ${String(t)}`)}memSizeJs(){var t;return((t=this._initData)==null?void 0:t.byteLength)??0}memSizeGPU(){return this.byteLength}bind(t,n,s,i,r){if(this._glBuffer||this.prepare(t),this.type===ie.ArrayBuffer){t.bindBuffer(t.ARRAY_BUFFER,this._glBuffer),n=n||0,s=s||this.options,r=r??1,k0(r);const o=this._toGlParam(t,s.dataType)||t.FLOAT;if(r===1)t.vertexAttribPointer(n,s.itemSize,o,s.normalized,s.stride,s.offset),this.bindVertexAttribDivisor(t,n,s,i);else{const a=ie._dataTypeSize(s.dataType);for(let c=0;c<r;c++)t.vertexAttribPointer(n+c,r,o,s.normalized,s.stride,s.offset+c*r*a),this.bindVertexAttribDivisor(t,n+c,s,i)}}else this.type===ie.ElementArrayBuffer&&t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this._glBuffer);return this}remove(){return this._unprepare(),this}subData(t,n,s){this._glBuffer||this.prepare(t);const i=this._toGlParam(t,this.type)||t.ARRAY_BUFFER;return t.bindBuffer(i,this._glBuffer),t.bufferSubData(i,n,s),this}replaceData(t){t&&(this._initData=t),this.isDirty=!0}commitData(t){const n=this._toGlParam(t,this.type)||t.ARRAY_BUFFER,s=this._toGlParam(t,this.drawType)||t.STATIC_DRAW;t.bindBuffer(n,this._glBuffer),t.bufferData(n,this._initData,s),this.isDirty=!1}prepare(t){return this._glContext=t,this._glBuffer=t.createBuffer(),this.commitData(t),this._preserveData||(this._initData=null),this}getGLType(t){return this._toGlParam(t,this.options.dataType)}getData(){return this._initData}_unprepare(){this._glBuffer&&this._glContext&&this._glContext.deleteBuffer(this._glBuffer),this._glBuffer=null,this._glContext=null,this._initData=null,this.isDirty=!1}_toGlParam(t,n){return n===ie.ArrayBuffer?t.ARRAY_BUFFER:n===ie.ElementArrayBuffer?t.ELEMENT_ARRAY_BUFFER:n===ie.StaticDraw?t.STATIC_DRAW:n===ie.DynamicDraw?t.DYNAMIC_DRAW:n===ie.Byte?t.BYTE:n===ie.Short?t.SHORT:n===ie.Int?t.INT:n===ie.Float?t.FLOAT:n===ie.UnsignedByte?t.UNSIGNED_BYTE:n===ie.UnsignedShort?t.UNSIGNED_SHORT:n===ie.UnsignedInt?t.UNSIGNED_INT:null}_hasRealWebGLContext(){return typeof window<"u"&&("WebGLRenderingContext"in window||"WebGL2RenderingContext"in window)}bindVertexAttribDivisor(t,n,s,i){s.instanceDivisor&&this._hasRealWebGLContext()&&(t instanceof WebGLRenderingContext?i?i.vertexAttribDivisorANGLE(n,s.instanceDivisor):console.error("Can't set up instanced attribute divisor. Missing ANGLE_instanced_arrays extension"):t.vertexAttribDivisor(n,s.instanceDivisor))}};ie.ArrayBuffer=1,ie.ElementArrayBuffer=2,ie.StaticDraw=10,ie.DynamicDraw=11,ie.Float=20,ie.UnsignedByte=21,ie.UnsignedShort=22,ie.UnsignedInt=23,ie.Byte=24,ie.Short=25,ie.Int=26,ie.defaultOptions={itemSize:3,dataType:ie.Float,stride:0,offset:0,normalized:!1,instanceDivisor:0,drawType:ie.StaticDraw};let $c=ie;var co,Gc;function V0(){if(Gc)return co;Gc=1;var e=4,t=.001,n=1e-7,s=10,i=11,r=1/(i-1),o=typeof Float32Array=="function";function a(A,h){return 1-3*h+3*A}function c(A,h){return 3*h-6*A}function l(A){return 3*A}function f(A,h,m){return((a(h,m)*A+c(h,m))*A+l(h))*A}function d(A,h,m){return 3*a(h,m)*A*A+2*c(h,m)*A+l(h)}function u(A,h,m,I,M){var v,S,T=0;do S=h+(m-h)/2,v=f(S,I,M)-A,v>0?m=S:h=S;while(Math.abs(v)>n&&++T<s);return S}function p(A,h,m,I){for(var M=0;M<e;++M){var v=d(h,m,I);if(v===0)return h;var S=f(h,m,I)-A;h-=S/v}return h}function w(A){return A}return co=function(h,m,I,M){if(!(0<=h&&h<=1&&0<=I&&I<=1))throw new Error("bezier x values must be in [0, 1] range");if(h===m&&I===M)return w;for(var v=o?new Float32Array(i):new Array(i),S=0;S<i;++S)v[S]=f(S*r,h,I);function T(F){for(var E=0,B=1,k=i-1;B!==k&&v[B]<=F;++B)E+=r;--B;var U=(F-v[B])/(v[B+1]-v[B]),g=E+U*r,x=d(g,h,I);return x>=t?p(F,g,h,I):x===0?g:u(F,E,E+r,h,I)}return function(E){return E===0?0:E===1?1:f(T(E),m,M)}},co}var Y0=V0(),$0=Qi(Y0);$0(.25,.1,.25,1);function lo(e){if(typeof e=="number")return e;let t=0;if(Array.isArray(e))for(const n of e)t+=lo(n);else for(const n in e){const s=e[n];typeof s=="number"?t+=s:t+=lo(s)}return t}const G0=15;function fo(e,t,n,s,i=2){const r=i+2;let o=s;const a=n-t>>1;let c=n-t,l;const f=e[t],d=e[t+1],u=e[n],p=e[n+1];for(let w=t+r;w<n;w+=r){const A=z0(e[w],e[w+1],f,d,u,p);if(A>o)l=w,o=A;else if(A===o){const h=Math.abs(w-a);h<c&&(l=w,c=h)}}o>s&&(l-t>r&&fo(e,t,l,s,i),e[l+2]=o,n-l>r&&fo(e,l,n,s,i))}function z0(e,t,n,s,i,r){let o=i-n,a=r-s;if(o!==0||a!==0){const c=((e-n)*o+(t-s)*a)/(o*o+a*a);c>1?(n=i,s=r):c>0&&(n+=o*c,s+=a*c)}return o=e-n,a=t-s,o*o+a*a}function vs(e,t,n,s,i,r=4){const o={id:e??null,index:i,type:t,geometry:n,tags:s,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};if(t==="Point"||t==="MultiPoint"||t==="LineString")Mi(o,n,r);else if(t==="Polygon")Mi(o,n[0],r);else if(t==="MultiLineString")for(const a of n)Mi(o,a,r);else if(t==="MultiPolygon")for(const a of n)Mi(o,a[0],r);return o}function Mi(e,t,n=4){for(let s=0;s<t.length;s+=n)e.minX=Math.min(e.minX,t[s]),e.minY=Math.min(e.minY,t[s+1]),e.maxX=Math.max(e.maxX,t[s]),e.maxY=Math.max(e.maxY,t[s+1])}function j0(e,t){const n=[];if(e.type==="FeatureCollection")for(let s=0;s<e.features.length;s++)Pi(n,e.features[s],t,s);else e.type==="Feature"?Pi(n,e,t,0):Pi(n,{geometry:e},t,0);return n}function Pi(e,t,n,s){if(!t.geometry)return;const i=t.geometry.coordinates,r=t.geometry.type,o=Math.pow(n.tolerance/((1<<n.maxZoom)*n.extent),2);let a=[],c=t.id;if(n.promoteId?c=t.properties[n.promoteId]:n.generateId&&(c=s||0),r==="Point")zc(i,a,n.dimensions);else if(r==="MultiPoint")for(const l of i)zc(l,a,n.dimensions);else if(r==="LineString")ho(i,a,o,!1,n.dimensions);else if(r==="MultiLineString")if(n.lineMetrics){for(const l of i)a=[],ho(l,a,o,!1,n.dimensions),e.push(vs(c,"LineString",a,t.properties,s,n.dimensions+2));return}else uo(i,a,o,!1,n.dimensions);else if(r==="Polygon")uo(i,a,o,!0,n.dimensions);else if(r==="MultiPolygon")for(const l of i){const f=[];uo(l,f,o,!0,n.dimensions),a.push(f)}else if(r==="GeometryCollection"){for(const l of t.geometry.geometries)Pi(e,{id:c,geometry:l,properties:t.properties},n,s);return}else throw new Error("Input data is not a valid GeoJSON object.");e.push(vs(c,r,a,t.properties,s,n.dimensions+2))}function zc(e,t,n=2){t.push(jc(e[0]),Xc(e[1]),0,1);for(let s=2;s<n;s++)t.push(e[s])}function ho(e,t,n,s,i=2){let r,o,a=0;for(let l=0;l<e.length;l++){const f=jc(e[l][0]),d=Xc(e[l][1]);t.push(f,d,0,1);for(let u=2;u<i;u++)t.push(e[l][u]);l>0&&(s?a+=(r*d-f*o)/2:a+=Math.sqrt(Math.pow(f-r,2)+Math.pow(d-o,2))),r=f,o=d}const c=t.length-(i+2);t[2]=1,fo(t,0,c,n,i),t[c+2]=1,t.size=Math.abs(a),t.start=0,t.end=t.size}function uo(e,t,n,s,i=2){for(let r=0;r<e.length;r++){const o=[];ho(e[r],o,n,s,i),t.push(o)}}function jc(e){return e/360+.5}function Xc(e){const t=Math.sin(e*Math.PI/180),n=.5-.25*Math.log((1+t)/(1-t))/Math.PI;return n<0?0:n>1?1:n}function Ct(e,t,n,s,i,r,o,a){const c=(a.dimensions===void 0?2:a.dimensions)+2;if(n/=t,s/=t,r>=n&&o<s)return e;if(o<n||r>=s)return null;const l=[];for(const f of e){const d=f.geometry;let u=f.type;const p=i===0?f.minX:f.minY,w=i===0?f.maxX:f.maxY;if(p>=n&&w<s){l.push(f);continue}else if(w<n||p>=s)continue;let A=[];if(u==="Point"||u==="MultiPoint")X0(d,A,n,s,i,c);else if(u==="LineString")Hc(d,A,n,s,i,!1,a.lineMetrics,c);else if(u==="MultiLineString")po(d,A,n,s,i,!1,c);else if(u==="Polygon")po(d,A,n,s,i,!0,c);else if(u==="MultiPolygon")for(const h of d){const m=[];po(h,m,n,s,i,!0,c),m.length&&A.push(m)}if(A.length){if(a.lineMetrics&&u==="LineString"){for(const h of A)l.push(vs(f.id,u,h,f.tags,f.index,c));continue}(u==="LineString"||u==="MultiLineString")&&(A.length===1?(u="LineString",A=A[0]):u="MultiLineString"),(u==="Point"||u==="MultiPoint")&&(u=A.length===c?"Point":"MultiPoint"),l.push(vs(f.id,u,A,f.tags,f.index,c))}}return l.length?l:null}function X0(e,t,n,s,i,r=4){for(let o=0;o<e.length;o+=r){const a=e[o+i];if(a>=n&&a<=s){Dn(t,e[o],e[o+1],e[o+2]);for(let c=3;c<r;c++)t.push(e[o+c])}}}function Hc(e,t,n,s,i,r,o,a=4){let c=qc(e);const l=i===0?H0:q0;let f=e.start,d,u;for(let I=0;I<e.length-a;I+=a){const M=e[I],v=e[I+1],S=e[I+2],T=e[I+a],F=e[I+a+1],E=i===0?M:v,B=i===0?T:F;let k=!1;if(o&&(d=Math.sqrt(Math.pow(M-T,2)+Math.pow(v-F,2))),E<n){if(B>n){u=l(c,M,v,T,F,n),c.push(0);for(let U=4;U<a;U++){const g=e[I+U];c.push((e[I+a+U]-g)*u+g)}o&&(c.start=f+d*u)}}else if(E>s){if(B<s){u=l(c,M,v,T,F,s),c.push(0);for(let U=4;U<a;U++){const g=e[I+U];c.push((e[I+a+U]-g)*u+g)}o&&(c.start=f+d*u)}}else{Dn(c,M,v,S);for(let U=3;U<a;U++)c.push(e[I+U])}if(B<n&&E>=n){u=l(c,M,v,T,F,n),c.push(0);for(let U=4;U<a;U++){const g=e[I+U];c.push((e[I+a+U]-g)*u+g)}k=!0}if(B>s&&E<=s){u=l(c,M,v,T,F,s),c.push(0);for(let U=4;U<a;U++){const g=e[I+U];c.push((e[I+a+U]-g)*u+g)}k=!0}!r&&k&&(o&&(c.end=f+d*u),t.push(c),c=qc(e)),o&&(f+=d)}let p=e.length-a;const w=e[p],A=e[p+1],h=e[p+2],m=i===0?w:A;if(m>=n&&m<=s){Dn(c,w,A,h);for(let I=3;I<a;I++)c.push(e[p+I])}if(p=c.length-a,r&&p>=3&&(c[p]!==c[0]||c[p+1]!==c[1])){Dn(c,c[0],c[1],c[2]);for(let I=3;I<a;I++)c.push(c[I])}c.length&&t.push(c)}function qc(e){const t=[];return t.size=e.size,t.start=e.start,t.end=e.end,t}function po(e,t,n,s,i,r,o){for(const a of e)Hc(a,t,n,s,i,r,!1,o)}function Dn(e,t,n,s){e.push(t,n,s)}function H0(e,t,n,s,i,r){const o=(r-t)/(s-t);return Dn(e,r,n+(i-n)*o,1),o}function q0(e,t,n,s,i,r){const o=(r-n)/(i-n);return Dn(e,t+(s-t)*o,r,1),o}function Z0(e,t){const n=t.buffer/t.extent,s=t.dimensions+2;let i=e;const r=Ct(e,1,-1-n,n,0,-1,2,t),o=Ct(e,1,1-n,2+n,0,-1,2,t);return(r||o)&&(i=Ct(e,1,-n,1+n,0,-1,2,t)||[],r&&(i=Zc(r,1,s).concat(i)),o&&(i=i.concat(Zc(o,-1,s)))),i}function Zc(e,t,n=4){const s=[];for(let i=0;i<e.length;i++){const r=e[i],o=r.type;let a;if(o==="Point"||o==="MultiPoint"||o==="LineString")a=go(r.geometry,t,n);else if(o==="MultiLineString"||o==="Polygon"){a=[];for(const c of r.geometry)a.push(go(c,t,n))}else if(o==="MultiPolygon"){a=[];for(const c of r.geometry){const l=[];for(const f of c)l.push(go(f,t,n));a.push(l)}}s.push(vs(r.id,o,a,r.tags,r.index,n))}return s}function go(e,t,n=4){const s=[];s.size=e.size,e.start!==void 0&&(s.start=e.start,s.end=e.end);for(let i=0;i<e.length;i+=n){s.push(e[i]+t,e[i+1],e[i+2],e[i+3]);for(let r=4;r<n;r++)s.push(e[i+r])}return s}function Wc(e,t,n){if(e.transformed)return e;const s=1<<e.z,i=e.x,r=e.y;for(const o of e.features){const a=o.geometry,c=o.type;o.geometry=[];const l=n.cuts&&c!==1?1:0,f=n.dimensions+l;if(c===1)for(let d=0;d<a.length;d+=f)o.geometry.push(Kc(a,d,f,t,s,i,r));else if(c===2)o.geometry=Jc(a,t,s,i,r,f);else for(let d=0;d<a.length;d++)o.geometry.push(Jc(a[d],t,s,i,r,f))}return e.transformed=!0,e}function Jc(e,t,n,s,i,r=3){const o=[];for(let a=0;a<e.length;a++){const c=[];for(let l=0;l<e[a].length;l+=r)c.push(Kc(e[a],l,r,t,n,s,i));o.push(c)}return o}function Kc(e,t,n,s,i,r,o){const a=[Math.round(s*(e[t]*i-r)),Math.round(s*(e[t+1]*i-o))];for(let c=2;c<n;c++)a.push(e[t+c]);return a}function W0(e,t,n,s,i){const r=t===i.maxZoom?0:i.tolerance/((1<<t)*i.extent),o={features:[],numPoints:0,numSimplified:0,numFeatures:e.length,source:null,x:n,y:s,z:t,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0};for(const a of e)J0(o,a,r,i);return o}function J0(e,t,n,s){const i=t.geometry,r=t.type,o=s.dimensions+2;let a=[];if(e.minX=Math.min(e.minX,t.minX),e.minY=Math.min(e.minY,t.minY),e.maxX=Math.max(e.maxX,t.maxX),e.maxY=Math.max(e.maxY,t.maxY),r==="Point"||r==="MultiPoint")for(let c=0;c<i.length;c+=o){a.push(i[c],i[c+1]);for(let l=4;l<o;l++)a.push(i[c+l]);e.numPoints++,e.numSimplified++}else if(r==="LineString")mo(a,i,e,n,!1,!1,s);else if(r==="MultiLineString"||r==="Polygon"){for(let c=0;c<i.length;c++)mo(a,i[c],e,n,r==="Polygon",c===0,s);r==="Polygon"&&a.length&&(a=[a])}else if(r==="MultiPolygon")for(let c=0;c<i.length;c++){const l=i[c],f=[];for(let d=0;d<l.length;d++)mo(f,l[d],e,n,!0,d===0,s);f.length&&a.push(f)}if(a.length){let c=t.tags||null;if(r==="LineString"&&s.lineMetrics){c={};for(const f in t.tags)c[f]=t.tags[f];c.mapbox_clip_start=i.start/i.size,c.mapbox_clip_end=i.end/i.size}const l={geometry:a,type:r==="Polygon"||r==="MultiPolygon"?3:r==="LineString"||r==="MultiLineString"?2:1,tags:c};t.id!==null&&(l.id=t.id),s.generateIndex&&(l.index=t.index),e.features.push(l)}}function mo(e,t,n,s,i,r,o){const a=s*s,c=o&&!!o.cuts,l=o.dimensions+2;if(s>0&&t.size<(i?a:s)){n.numPoints+=t.length/l;return}const f=[];for(let d=0;d<t.length;d+=l){if(s===0||t[d+2]>a){n.numSimplified++,f.push(t[d],t[d+1]);for(let u=4;u<l;u++)f.push(t[d+u]);c&&f.push(t[d+3])}n.numPoints++}i&&K0(f,r,l-(c?1:2)),e.push(f)}function K0(e,t,n=3){let s=0;for(let i=0,r=e.length,o=r-n;i<r;o=i,i+=n)s+=(e[i]-e[o])*(e[i+1]+e[o+1]);if(s>0===t)for(let i=0,r=e.length;i<r/2;i+=n)for(let o=0;o<n;o++){const a=e[i+o],c=r-i-(n-o);e[i+o]=e[c],e[c]=a}return e}const wo={Points:1,Lines:2,Polygons:3},Q0={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,generateIndex:!1,debug:0,dimensions:2,cuts:!1};class e1{constructor(t,n){n=this.options=t1(Object.create(Q0),n);const s=n.debug;if(s&&console.time("preprocess data"),n.maxZoom<0||n.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(n.promoteId&&n.generateId)throw new Error("promoteId and generateId cannot be used together.");let i=j0(t,n);this.tiles={},this.tileCoords=[],s&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",n.indexMaxZoom,n.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),i=Z0(i,n),i.length&&this.splitTile(i,0,0,0),s&&(i.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}splitTile(t,n,s,i,r,o,a){const c=[t,n,s,i],l=this.options,f=l.debug;for(;c.length;){i=c.pop(),s=c.pop(),n=c.pop(),t=c.pop();const d=1<<n,u=yo(n,s,i);let p=this.tiles[u];if(!p&&(f>1&&console.time("creation"),p=this.tiles[u]=W0(t,n,s,i,l),this.tileCoords.push({z:n,x:s,y:i}),f)){f>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",n,s,i,p.numFeatures,p.numPoints,p.numSimplified),console.timeEnd("creation"));const E=`z${n}`;this.stats[E]=(this.stats[E]||0)+1,this.total++}if(p.source=t,r==null){if(n===l.indexMaxZoom||p.numPoints<=l.indexMaxPoints)continue}else{if(n===l.maxZoom||n===r)continue;if(r!=null){const E=r-n;if(s!==o>>E||i!==a>>E)continue}}if(p.source=null,t.length===0)continue;f>1&&console.time("clipping");const w=.5*l.buffer/l.extent,A=.5-w,h=.5+w,m=1+w;let I=null,M=null,v=null,S=null,T=Ct(t,d,s-w,s+h,0,p.minX,p.maxX,l),F=Ct(t,d,s+A,s+m,0,p.minX,p.maxX,l);t=null,T&&(I=Ct(T,d,i-w,i+h,1,p.minY,p.maxY,l),M=Ct(T,d,i+A,i+m,1,p.minY,p.maxY,l),T=null),F&&(v=Ct(F,d,i-w,i+h,1,p.minY,p.maxY,l),S=Ct(F,d,i+A,i+m,1,p.minY,p.maxY,l),F=null),f>1&&console.timeEnd("clipping"),c.push(I||[],n+1,s*2,i*2),c.push(M||[],n+1,s*2,i*2+1),c.push(v||[],n+1,s*2+1,i*2),c.push(S||[],n+1,s*2+1,i*2+1)}}getTile(t,n,s){t=+t,n=+n,s=+s;const i=this.options,{extent:r,debug:o}=i;if(t<0||t>24)return null;const a=1<<t;n=n+a&a-1;const c=yo(t,n,s);if(this.tiles[c])return Wc(this.tiles[c],r,i);o>1&&console.log("drilling down to z%d-%d-%d",t,n,s);let l=t,f=n,d=s,u;for(;!u&&l>0;)l--,f=f>>1,d=d>>1,u=this.tiles[yo(l,f,d)];return!u||!u.source?null:(o>1&&(console.log("found parent tile z%d-%d-%d",l,f,d),console.time("drilling down")),this.splitTile(u.source,l,f,d,t,n,s),o>1&&console.timeEnd("drilling down"),this.tiles[c]?Wc(this.tiles[c],r,i):null)}}function yo(e,t,n){return((1<<e)*n+t)*32+e}function t1(e,t){for(const n in t)e[n]=t[n];return e}function n1(e,t){return new e1(e,t)}var bi={exports:{}},Qc;function s1(){if(Qc)return bi.exports;Qc=1,bi.exports=e,bi.exports.default=e;function e(y,b,P){P=P||2;var D=b&&b.length,O=D?b[0]*P:y.length,L=t(y,0,O,P,!0),N=[];if(!L||L.next===L.prev)return N;var R,H,$,V,G,Z,ne;if(D&&(L=c(y,b,L,P)),y.length>80*P){R=$=y[0],H=V=y[1];for(var W=P;W<O;W+=P)G=y[W],Z=y[W+1],G<R&&(R=G),Z<H&&(H=Z),G>$&&($=G),Z>V&&(V=Z);ne=Math.max($-R,V-H),ne=ne!==0?32767/ne:0}return s(L,N,P,R,H,ne,0),N}function t(y,b,P,D,O){var L,N;if(O===C(y,b,P,D)>0)for(L=b;L<P;L+=D)N=g(L,y[L],y[L+1],N);else for(L=P-D;L>=b;L-=D)N=g(L,y[L],y[L+1],N);return N&&v(N,N.next)&&(x(N),N=N.next),N}function n(y,b){if(!y)return y;b||(b=y);var P=y,D;do if(D=!1,!P.steiner&&(v(P,P.next)||M(P.prev,P,P.next)===0)){if(x(P),P=b=P.prev,P===P.next)break;D=!0}else P=P.next;while(D||P!==b);return b}function s(y,b,P,D,O,L,N){if(y){!N&&L&&p(y,D,O,L);for(var R=y,H,$;y.prev!==y.next;){if(H=y.prev,$=y.next,L?r(y,D,O,L):i(y)){b.push(H.i/P|0),b.push(y.i/P|0),b.push($.i/P|0),x(y),y=$.next,R=$.next;continue}if(y=$,y===R){N?N===1?(y=o(n(y),b,P),s(y,b,P,D,O,L,2)):N===2&&a(y,b,P,D,O,L):s(n(y),b,P,D,O,L,1);break}}}}function i(y){var b=y.prev,P=y,D=y.next;if(M(b,P,D)>=0)return!1;for(var O=b.x,L=P.x,N=D.x,R=b.y,H=P.y,$=D.y,V=O<L?O<N?O:N:L<N?L:N,G=R<H?R<$?R:$:H<$?H:$,Z=O>L?O>N?O:N:L>N?L:N,ne=R>H?R>$?R:$:H>$?H:$,W=D.next;W!==b;){if(W.x>=V&&W.x<=Z&&W.y>=G&&W.y<=ne&&m(O,R,L,H,N,$,W.x,W.y)&&M(W.prev,W,W.next)>=0)return!1;W=W.next}return!0}function r(y,b,P,D){var O=y.prev,L=y,N=y.next;if(M(O,L,N)>=0)return!1;for(var R=O.x,H=L.x,$=N.x,V=O.y,G=L.y,Z=N.y,ne=R<H?R<$?R:$:H<$?H:$,W=V<G?V<Z?V:Z:G<Z?G:Z,oe=R>H?R>$?R:$:H>$?H:$,te=V>G?V>Z?V:Z:G>Z?G:Z,ee=A(ne,W,b,P,D),j=A(oe,te,b,P,D),z=y.prevZ,K=y.nextZ;z&&z.z>=ee&&K&&K.z<=j;){if(z.x>=ne&&z.x<=oe&&z.y>=W&&z.y<=te&&z!==O&&z!==N&&m(R,V,H,G,$,Z,z.x,z.y)&&M(z.prev,z,z.next)>=0||(z=z.prevZ,K.x>=ne&&K.x<=oe&&K.y>=W&&K.y<=te&&K!==O&&K!==N&&m(R,V,H,G,$,Z,K.x,K.y)&&M(K.prev,K,K.next)>=0))return!1;K=K.nextZ}for(;z&&z.z>=ee;){if(z.x>=ne&&z.x<=oe&&z.y>=W&&z.y<=te&&z!==O&&z!==N&&m(R,V,H,G,$,Z,z.x,z.y)&&M(z.prev,z,z.next)>=0)return!1;z=z.prevZ}for(;K&&K.z<=j;){if(K.x>=ne&&K.x<=oe&&K.y>=W&&K.y<=te&&K!==O&&K!==N&&m(R,V,H,G,$,Z,K.x,K.y)&&M(K.prev,K,K.next)>=0)return!1;K=K.nextZ}return!0}function o(y,b,P){var D=y;do{var O=D.prev,L=D.next.next;!v(O,L)&&S(O,D,D.next,L)&&B(O,L)&&B(L,O)&&(b.push(O.i/P|0),b.push(D.i/P|0),b.push(L.i/P|0),x(D),x(D.next),D=y=L),D=D.next}while(D!==y);return n(D)}function a(y,b,P,D,O,L){var N=y;do{for(var R=N.next.next;R!==N.prev;){if(N.i!==R.i&&I(N,R)){var H=U(N,R);N=n(N,N.next),H=n(H,H.next),s(N,b,P,D,O,L,0),s(H,b,P,D,O,L,0);return}R=R.next}N=N.next}while(N!==y)}function c(y,b,P,D){var O=[],L,N,R,H,$;for(L=0,N=b.length;L<N;L++)R=b[L]*D,H=L<N-1?b[L+1]*D:y.length,$=t(y,R,H,D,!1),$===$.next&&($.steiner=!0),O.push(h($));for(O.sort(l),L=0;L<O.length;L++)P=f(O[L],P);return P}function l(y,b){return y.x-b.x}function f(y,b){var P=d(y,b);if(!P)return b;var D=U(P,y);return n(D,D.next),n(P,P.next)}function d(y,b){var P=b,D=y.x,O=y.y,L=-1/0,N;do{if(O<=P.y&&O>=P.next.y&&P.next.y!==P.y){var R=P.x+(O-P.y)*(P.next.x-P.x)/(P.next.y-P.y);if(R<=D&&R>L&&(L=R,N=P.x<P.next.x?P:P.next,R===D))return N}P=P.next}while(P!==b);if(!N)return null;var H=N,$=N.x,V=N.y,G=1/0,Z;P=N;do D>=P.x&&P.x>=$&&D!==P.x&&m(O<V?D:L,O,$,V,O<V?L:D,O,P.x,P.y)&&(Z=Math.abs(O-P.y)/(D-P.x),B(P,y)&&(Z<G||Z===G&&(P.x>N.x||P.x===N.x&&u(N,P)))&&(N=P,G=Z)),P=P.next;while(P!==H);return N}function u(y,b){return M(y.prev,y,b.prev)<0&&M(b.next,y,y.next)<0}function p(y,b,P,D){var O=y;do O.z===0&&(O.z=A(O.x,O.y,b,P,D)),O.prevZ=O.prev,O.nextZ=O.next,O=O.next;while(O!==y);O.prevZ.nextZ=null,O.prevZ=null,w(O)}function w(y){var b,P,D,O,L,N,R,H,$=1;do{for(P=y,y=null,L=null,N=0;P;){for(N++,D=P,R=0,b=0;b<$&&(R++,D=D.nextZ,!!D);b++);for(H=$;R>0||H>0&&D;)R!==0&&(H===0||!D||P.z<=D.z)?(O=P,P=P.nextZ,R--):(O=D,D=D.nextZ,H--),L?L.nextZ=O:y=O,O.prevZ=L,L=O;P=D}L.nextZ=null,$*=2}while(N>1);return y}function A(y,b,P,D,O){return y=(y-P)*O|0,b=(b-D)*O|0,y=(y|y<<8)&16711935,y=(y|y<<4)&252645135,y=(y|y<<2)&858993459,y=(y|y<<1)&1431655765,b=(b|b<<8)&16711935,b=(b|b<<4)&252645135,b=(b|b<<2)&858993459,b=(b|b<<1)&1431655765,y|b<<1}function h(y){var b=y,P=y;do(b.x<P.x||b.x===P.x&&b.y<P.y)&&(P=b),b=b.next;while(b!==y);return P}function m(y,b,P,D,O,L,N,R){return(O-N)*(b-R)>=(y-N)*(L-R)&&(y-N)*(D-R)>=(P-N)*(b-R)&&(P-N)*(L-R)>=(O-N)*(D-R)}function I(y,b){return y.next.i!==b.i&&y.prev.i!==b.i&&!E(y,b)&&(B(y,b)&&B(b,y)&&k(y,b)&&(M(y.prev,y,b.prev)||M(y,b.prev,b))||v(y,b)&&M(y.prev,y,y.next)>0&&M(b.prev,b,b.next)>0)}function M(y,b,P){return(b.y-y.y)*(P.x-b.x)-(b.x-y.x)*(P.y-b.y)}function v(y,b){return y.x===b.x&&y.y===b.y}function S(y,b,P,D){var O=F(M(y,b,P)),L=F(M(y,b,D)),N=F(M(P,D,y)),R=F(M(P,D,b));return!!(O!==L&&N!==R||O===0&&T(y,P,b)||L===0&&T(y,D,b)||N===0&&T(P,y,D)||R===0&&T(P,b,D))}function T(y,b,P){return b.x<=Math.max(y.x,P.x)&&b.x>=Math.min(y.x,P.x)&&b.y<=Math.max(y.y,P.y)&&b.y>=Math.min(y.y,P.y)}function F(y){return y>0?1:y<0?-1:0}function E(y,b){var P=y;do{if(P.i!==y.i&&P.next.i!==y.i&&P.i!==b.i&&P.next.i!==b.i&&S(P,P.next,y,b))return!0;P=P.next}while(P!==y);return!1}function B(y,b){return M(y.prev,y,y.next)<0?M(y,b,y.next)>=0&&M(y,y.prev,b)>=0:M(y,b,y.prev)<0||M(y,y.next,b)<0}function k(y,b){var P=y,D=!1,O=(y.x+b.x)/2,L=(y.y+b.y)/2;do P.y>L!=P.next.y>L&&P.next.y!==P.y&&O<(P.next.x-P.x)*(L-P.y)/(P.next.y-P.y)+P.x&&(D=!D),P=P.next;while(P!==y);return D}function U(y,b){var P=new _(y.i,y.x,y.y),D=new _(b.i,b.x,b.y),O=y.next,L=b.prev;return y.next=b,b.prev=y,P.next=O,O.prev=P,D.next=P,P.prev=D,L.next=D,D.prev=L,D}function g(y,b,P,D){var O=new _(y,b,P);return D?(O.next=D.next,O.prev=D,D.next.prev=O,D.next=O):(O.prev=O,O.next=O),O}function x(y){y.next.prev=y.prev,y.prev.next=y.next,y.prevZ&&(y.prevZ.nextZ=y.nextZ),y.nextZ&&(y.nextZ.prevZ=y.prevZ)}function _(y,b,P){this.i=y,this.x=b,this.y=P,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}e.deviation=function(y,b,P,D){var O=b&&b.length,L=O?b[0]*P:y.length,N=Math.abs(C(y,0,L,P));if(O)for(var R=0,H=b.length;R<H;R++){var $=b[R]*P,V=R<H-1?b[R+1]*P:y.length;N-=Math.abs(C(y,$,V,P))}var G=0;for(R=0;R<D.length;R+=3){var Z=D[R]*P,ne=D[R+1]*P,W=D[R+2]*P;G+=Math.abs((y[Z]-y[W])*(y[ne+1]-y[Z+1])-(y[Z]-y[ne])*(y[W+1]-y[Z+1]))}return N===0&&G===0?0:Math.abs((G-N)/N)};function C(y,b,P,D){for(var O=0,L=b,N=P-D;L<P;L+=D)O+=(y[N]-y[L])*(y[L+1]+y[N+1]),N=L;return O}return e.flatten=function(y){for(var b=y[0][0].length,P={vertices:[],holes:[],dimensions:b},D=0,O=0;O<y.length;O++){for(var L=0;L<y[O].length;L++)for(var N=0;N<b;N++)P.vertices.push(y[O][L][N]);O>0&&(D+=y[O-1].length,P.holes.push(D))}return P},bi.exports}var i1=s1(),el=Qi(i1);function r1(e){const t=Bt(e),n=Ie.scaleFactor(Jn(0,0,t)[1]),s=Ie.scaleFactor(Jn(0,le,t)[1]);return{min:n,max:s,range:s-n}}function o1(e,t,n,s){const i=[];return e.geometry.forEach(r=>{const o=[],a=[],c=[];r.forEach(u=>{c.push(...d1(u,t)),o.length&&a.push(o.length),o.push(...u)});const l=[];for(let u=0;u<o.length;u++)for(let p=0;p<n;p++)l.push(o[u][p]);const f=el(l,a,n),d=new Array(n);for(let u=0;u<f.length;u+=3){const p=[];for(let w=0;w<n+1;w++)p.push([]);for(let w=0;w<3;w++)vo(d,o[f[u+2-w]],t,s),p[0][w]=d[0],p[1][w]=d[1],p[2][w]=0,n>2&&(p[3][w]=d[2]),n>3&&(p[4][w]=d[3]);c.forEach(w=>{const A=[[],[],[]];w.forEach((h,m)=>{A[0][m]=h[0],A[1][m]=h[1]}),Yc(p,A)}),i.push({tags:e.tags,id:e.id,index:e.index,type:"polygon",vertices:{x:p[0],y:p[1],cut:p[2],signed_z:p[3],abs_z:p[4]}})}}),i}function a1(e,t,n,s){const i=Array(n);return e.geometry.map(r=>{const o=[];for(let a=0;a<n;a++)o.push([]);return r.forEach((a,c)=>{vo(i,a,t,s),o[0][c]=i[0],o[1][c]=i[1],n>2&&(o[2][c]=i[2]),n>3&&(o[3][c]=i[3])}),{tags:e.tags,id:e.id,index:e.index,type:"line",vertices:{x:o[0],y:o[1],z:o[2],signed_z:o[2],abs_z:o[3]}}})}function c1(e,t,n,s){const i=Array(n);return e.geometry.map(r=>{vo(i,r,t,s);const o={x:[i[0]],y:[i[1]],z:n>2?[i[2]??0]:void 0,abs_z:n>3&&i[3]!==void 0?[i[3]]:void 0};return{tags:e.tags,id:e.id,index:e.index,type:"point",vertices:o}})}function vo(e,t,n,s){const i=tl(t,n);e[0]=i[0],e[1]=i[1];const r=s.min+i[1]/le*s.range;t[2]===void 0?e[2]=0:e[2]=t[2]*Te*r,t[3]!==void 0&&(e[3]=t[3]*Te*r)}function tl(e,t){return[ft(e[0]/t*le,0,le),ft((t-e[1])/t*le,0,le)]}function l1(e,t){return e[0]<0||e[0]>t||e[1]<0||e[1]>t}function f1(e,t,n){return e[0]>n&&t[0]>n||e[0]<0&&t[0]<0||e[1]>n&&t[1]>n||e[1]<0&&t[1]<0}function d1(e,t){const n=[];let s=[];for(let i=0;i<e.length;i++){const r=e[i];if(s.push(tl(r,t)),!l1(r,t))continue;const o=e[i+1];if(!o)break;f1(r,o,t)&&(s.length>1&&n.push(s),s=[])}return s.length>1&&n.push(s),n}const nl=4096,sl=2,Ln={maxZoom:G0,tolerance:3,extent:nl,buffer:1,debug:0,lineMetrics:!1,promoteId:null,generateId:!1,generateIndex:!0,indexMaxZoom:0,indexMaxPoints:1e5,dimensions:sl};class xo{constructor(t){this.options=t}get geoJsonVtInstance(){return this.geoJsonVT||(this.geoJsonVT=n1(this.options.data,{...Ln,maxZoom:this.options.maxZoom??Ln.maxZoom,dimensions:this.options.dimensions??Ln.dimensions,extent:this.options.extent??Ln.extent,buffer:this.options.buffer??Ln.buffer,promoteId:this.options.promoteId,tolerance:this.options.tolerance??Ln.tolerance})),this.geoJsonVT}fetchTile(t){const[n,s,i]=ga(t),r={components:[],byId:new Map},o=this.geoJsonVtInstance.getTile(i,n,s),a=this.options.dimensions??sl,c=this.options.extent??nl,l=r1(t);if(!o)return Promise.resolve(r);for(const f of o.features)switch(f.type){case wo.Points:r.components=r.components.concat(c1(f,c,a,l));break;case wo.Lines:r.components=r.components.concat(a1(f,c,a,l));break;case wo.Polygons:r.components=r.components.concat(o1(f,c,a,l));break;default:console.warn("unsupported type ",o);break}return Promise.resolve(r)}destroy(){this.geoJsonVT=void 0}}function h1(e,t,n){const s={components:[],byId:new Map};return e.features.forEach((i,r)=>{s.components.push(...il(i.geometry,t).map(o=>({...o,index:r,id:i.id,tags:i.properties||{}})))}),s}function il(e,t,n){switch(e.type){case"GeometryCollection":{let s=[];return e.geometries.forEach(i=>{s=s.concat(il(i,t))}),s}case"Point":case"MultiPoint":return u1(e,t);case"LineString":case"MultiLineString":return p1(e,t);case"Polygon":case"MultiPolygon":return g1(e,t)}}function u1(e,t){return e.type==="Point"?[rl(e.coordinates,t)]:e.coordinates.map(n=>rl(n,t))}function p1(e,t){return e.type==="LineString"?[ol(e.coordinates,t)]:e.coordinates.map(n=>ol(n,t))}function g1(e,t,n){return e.type==="Polygon"?al(e.coordinates,t):e.coordinates.reduce((s,i)=>s.concat(al(i,t)),[])}function rl(e,t){const n=[0,0,0];return pt(n,Ie.fromGeo(e),t),{type:"point",vertices:{x:[n[0]],y:[n[1]]}}}function ol(e,t){const n=[[],[]],s=[0,0,0];return e.forEach((i,r)=>{pt(s,Ie.fromGeo(i),t),n[0][r]=s[0],n[1][r]=s[1]}),{type:"line",vertices:{x:n[0],y:n[1]}}}function al(e,t,n){const s=[],i=[],r=[],o=[],a=[];e.forEach(f=>{const d=f.map(u=>(pt(a,Ie.fromGeo(u),t),[ft(a[0],0,le),ft(a[1],0,le)]));o.push(d),i.length&&r.push(i.length),i.push(...d)});const c=[];for(let f=0;f<i.length;f++)c.push(i[f][0]),c.push(i[f][1]);const l=el(c,r);for(let f=0;f<l.length;f+=3){const d=[[],[],[],[]];for(let p=0;p<3;p++)d[0][p]=i[l[f+p]][0],d[1][p]=i[l[f+p]][1],d[2][p]=0,d[3][p]=i[l[f+p]][2];o.forEach(p=>{const w=[[],[],[]];p.forEach((A,h)=>{w[0][h]=A[0],w[1][h]=A[1]}),Yc(d,w)});const u={type:"polygon",vertices:{x:d[0],y:d[1],cut:d[2]}};s.push(u)}return s}function cl(e){return new Promise(t=>setTimeout(t,e))}class m1{constructor(t,n=!1){this.dataType=t,this.pendingRequests=new Map,this.ignoredStatusCodes=n?[204,404]:[204]}async fetch(t,n,s=3,i=300){var o;let r=0;for(;r<=s;)try{const a=await this.fetchAttempt(t,n);if(!a.error||!Cc((o=a.error)==null?void 0:o.status))return a;throw new Error(`Fetching ${t} attempt ${r} failed.`)}catch{if(r>=s)return{rejected:!0};await cl(Math.pow(2,r)*i),r++}return{rejected:!0}}destroy(){this.pendingRequests.forEach((t,n)=>{this.abortRequest(n)})}abortRequest(t){const n=this.pendingRequests.get(t);n!==void 0&&(n.xhr.abort(),n.resolve({rejected:!0}),this.pendingRequests.delete(t))}fetchAttempt(t,n){return new Promise(s=>{const i=n(t),r=ut(t),a=(this.dataType==="json"?Uc:xi)({url:i},(c,l)=>{if(this.pendingRequests.delete(r),c!==void 0){this.ignoredStatusCodes.includes(c.status)||console.error(`Failed to fetch a tile by url "${i}" Error: status "${c.status}", message: ${c.message}`),s({error:c});return}s({data:l})});this.pendingRequests.set(r,{xhr:a,resolve:s})})}}class Ei{constructor(t){this.tileLoader=new m1("json",t.ignoreMissingTiles),this.options=t,this.url=n=>{const s=this.options.flipY?n:ga(n);return Yf(this.options.url,{x:s[0].toString(),y:s[1].toString(),z:s[2].toString(),subdomain:ua(s)})}}fetchTile(t){return this.tileLoader.fetch(t,this.url).then(n=>n.data?h1(n.data,Bt(t)):{components:[],byId:new Map})}abortTile(t){this.tileLoader.abortRequest(ut(t))}destroy(){this.tileLoader.destroy()}}class Io extends Map{constructor(t){super(t),this.featureAttrs=(t==null?void 0:t.featureAttrs)||new Set,this.clearAttrs=!0}set(t,n){return super.set(t,n),Object.keys(n).forEach(s=>this.featureAttrs.add(s)),this}}function w1(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var Ao={};/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */Ao.read=function(e,t,n,s,i){var r,o,a=i*8-s-1,c=(1<<a)-1,l=c>>1,f=-7,d=n?i-1:0,u=n?-1:1,p=e[t+d];for(d+=u,r=p&(1<<-f)-1,p>>=-f,f+=a;f>0;r=r*256+e[t+d],d+=u,f-=8);for(o=r&(1<<-f)-1,r>>=-f,f+=s;f>0;o=o*256+e[t+d],d+=u,f-=8);if(r===0)r=1-l;else{if(r===c)return o?NaN:(p?-1:1)*(1/0);o=o+Math.pow(2,s),r=r-l}return(p?-1:1)*o*Math.pow(2,r-s)},Ao.write=function(e,t,n,s,i,r){var o,a,c,l=r*8-i-1,f=(1<<l)-1,d=f>>1,u=i===23?Math.pow(2,-24)-Math.pow(2,-77):0,p=s?0:r-1,w=s?1:-1,A=t<0||t===0&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(a=isNaN(t)?1:0,o=f):(o=Math.floor(Math.log(t)/Math.LN2),t*(c=Math.pow(2,-o))<1&&(o--,c*=2),o+d>=1?t+=u/c:t+=u*Math.pow(2,1-d),t*c>=2&&(o++,c/=2),o+d>=f?(a=0,o=f):o+d>=1?(a=(t*c-1)*Math.pow(2,i),o=o+d):(a=t*Math.pow(2,d-1)*Math.pow(2,i),o=0));i>=8;e[n+p]=a&255,p+=w,a/=256,i-=8);for(o=o<<i|a,l+=i;l>0;e[n+p]=o&255,p+=w,o/=256,l-=8);e[n+p-w]|=A*128};var y1=pe,Ti=Ao;function pe(e){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(e)?e:new Uint8Array(e||0),this.pos=0,this.type=0,this.length=this.buf.length}pe.Varint=0,pe.Fixed64=1,pe.Bytes=2,pe.Fixed32=5;var Mo=65536*65536,ll=1/Mo,v1=12,fl=typeof TextDecoder>"u"?null:new TextDecoder("utf8");pe.prototype={destroy:function(){this.buf=null},readFields:function(e,t,n){for(n=n||this.length;this.pos<n;){var s=this.readVarint(),i=s>>3,r=this.pos;this.type=s&7,e(i,t,this),this.pos===r&&this.skip(s)}return t},readMessage:function(e,t){return this.readFields(e,t,this.readVarint()+this.pos)},readFixed32:function(){var e=_i(this.buf,this.pos);return this.pos+=4,e},readSFixed32:function(){var e=hl(this.buf,this.pos);return this.pos+=4,e},readFixed64:function(){var e=_i(this.buf,this.pos)+_i(this.buf,this.pos+4)*Mo;return this.pos+=8,e},readSFixed64:function(){var e=_i(this.buf,this.pos)+hl(this.buf,this.pos+4)*Mo;return this.pos+=8,e},readFloat:function(){var e=Ti.read(this.buf,this.pos,!0,23,4);return this.pos+=4,e},readDouble:function(){var e=Ti.read(this.buf,this.pos,!0,52,8);return this.pos+=8,e},readVarint:function(e){var t=this.buf,n,s;return s=t[this.pos++],n=s&127,s<128||(s=t[this.pos++],n|=(s&127)<<7,s<128)||(s=t[this.pos++],n|=(s&127)<<14,s<128)||(s=t[this.pos++],n|=(s&127)<<21,s<128)?n:(s=t[this.pos],n|=(s&15)<<28,x1(n,e,this))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var e=this.readVarint();return e%2===1?(e+1)/-2:e/2},readBoolean:function(){return!!this.readVarint()},readString:function(){var e=this.readVarint()+this.pos,t=this.pos;return this.pos=e,e-t>=v1&&fl?N1(this.buf,t,e):L1(this.buf,t,e)},readBytes:function(){var e=this.readVarint()+this.pos,t=this.buf.subarray(this.pos,e);return this.pos=e,t},readPackedVarint:function(e,t){if(this.type!==pe.Bytes)return e.push(this.readVarint(t));var n=kt(this);for(e=e||[];this.pos<n;)e.push(this.readVarint(t));return e},readPackedSVarint:function(e){if(this.type!==pe.Bytes)return e.push(this.readSVarint());var t=kt(this);for(e=e||[];this.pos<t;)e.push(this.readSVarint());return e},readPackedBoolean:function(e){if(this.type!==pe.Bytes)return e.push(this.readBoolean());var t=kt(this);for(e=e||[];this.pos<t;)e.push(this.readBoolean());return e},readPackedFloat:function(e){if(this.type!==pe.Bytes)return e.push(this.readFloat());var t=kt(this);for(e=e||[];this.pos<t;)e.push(this.readFloat());return e},readPackedDouble:function(e){if(this.type!==pe.Bytes)return e.push(this.readDouble());var t=kt(this);for(e=e||[];this.pos<t;)e.push(this.readDouble());return e},readPackedFixed32:function(e){if(this.type!==pe.Bytes)return e.push(this.readFixed32());var t=kt(this);for(e=e||[];this.pos<t;)e.push(this.readFixed32());return e},readPackedSFixed32:function(e){if(this.type!==pe.Bytes)return e.push(this.readSFixed32());var t=kt(this);for(e=e||[];this.pos<t;)e.push(this.readSFixed32());return e},readPackedFixed64:function(e){if(this.type!==pe.Bytes)return e.push(this.readFixed64());var t=kt(this);for(e=e||[];this.pos<t;)e.push(this.readFixed64());return e},readPackedSFixed64:function(e){if(this.type!==pe.Bytes)return e.push(this.readSFixed64());var t=kt(this);for(e=e||[];this.pos<t;)e.push(this.readSFixed64());return e},skip:function(e){var t=e&7;if(t===pe.Varint)for(;this.buf[this.pos++]>127;);else if(t===pe.Bytes)this.pos=this.readVarint()+this.pos;else if(t===pe.Fixed32)this.pos+=4;else if(t===pe.Fixed64)this.pos+=8;else throw new Error("Unimplemented type: "+t)},writeTag:function(e,t){this.writeVarint(e<<3|t)},realloc:function(e){for(var t=this.length||16;t<this.pos+e;)t*=2;if(t!==this.length){var n=new Uint8Array(t);n.set(this.buf),this.buf=n,this.length=t}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(e){this.realloc(4),Nn(this.buf,e,this.pos),this.pos+=4},writeSFixed32:function(e){this.realloc(4),Nn(this.buf,e,this.pos),this.pos+=4},writeFixed64:function(e){this.realloc(8),Nn(this.buf,e&-1,this.pos),Nn(this.buf,Math.floor(e*ll),this.pos+4),this.pos+=8},writeSFixed64:function(e){this.realloc(8),Nn(this.buf,e&-1,this.pos),Nn(this.buf,Math.floor(e*ll),this.pos+4),this.pos+=8},writeVarint:function(e){if(e=+e||0,e>268435455||e<0){A1(e,this);return}this.realloc(4),this.buf[this.pos++]=e&127|(e>127?128:0),!(e<=127)&&(this.buf[this.pos++]=(e>>>=7)&127|(e>127?128:0),!(e<=127)&&(this.buf[this.pos++]=(e>>>=7)&127|(e>127?128:0),!(e<=127)&&(this.buf[this.pos++]=e>>>7&127)))},writeSVarint:function(e){this.writeVarint(e<0?-e*2-1:e*2)},writeBoolean:function(e){this.writeVarint(!!e)},writeString:function(e){e=String(e),this.realloc(e.length*4),this.pos++;var t=this.pos;this.pos=R1(this.buf,e,this.pos);var n=this.pos-t;n>=128&&dl(t,n,this),this.pos=t-1,this.writeVarint(n),this.pos+=n},writeFloat:function(e){this.realloc(4),Ti.write(this.buf,e,this.pos,!0,23,4),this.pos+=4},writeDouble:function(e){this.realloc(8),Ti.write(this.buf,e,this.pos,!0,52,8),this.pos+=8},writeBytes:function(e){var t=e.length;this.writeVarint(t),this.realloc(t);for(var n=0;n<t;n++)this.buf[this.pos++]=e[n]},writeRawMessage:function(e,t){this.pos++;var n=this.pos;e(t,this);var s=this.pos-n;s>=128&&dl(n,s,this),this.pos=n-1,this.writeVarint(s),this.pos+=s},writeMessage:function(e,t,n){this.writeTag(e,pe.Bytes),this.writeRawMessage(t,n)},writePackedVarint:function(e,t){t.length&&this.writeMessage(e,b1,t)},writePackedSVarint:function(e,t){t.length&&this.writeMessage(e,E1,t)},writePackedBoolean:function(e,t){t.length&&this.writeMessage(e,S1,t)},writePackedFloat:function(e,t){t.length&&this.writeMessage(e,T1,t)},writePackedDouble:function(e,t){t.length&&this.writeMessage(e,_1,t)},writePackedFixed32:function(e,t){t.length&&this.writeMessage(e,B1,t)},writePackedSFixed32:function(e,t){t.length&&this.writeMessage(e,F1,t)},writePackedFixed64:function(e,t){t.length&&this.writeMessage(e,O1,t)},writePackedSFixed64:function(e,t){t.length&&this.writeMessage(e,D1,t)},writeBytesField:function(e,t){this.writeTag(e,pe.Bytes),this.writeBytes(t)},writeFixed32Field:function(e,t){this.writeTag(e,pe.Fixed32),this.writeFixed32(t)},writeSFixed32Field:function(e,t){this.writeTag(e,pe.Fixed32),this.writeSFixed32(t)},writeFixed64Field:function(e,t){this.writeTag(e,pe.Fixed64),this.writeFixed64(t)},writeSFixed64Field:function(e,t){this.writeTag(e,pe.Fixed64),this.writeSFixed64(t)},writeVarintField:function(e,t){this.writeTag(e,pe.Varint),this.writeVarint(t)},writeSVarintField:function(e,t){this.writeTag(e,pe.Varint),this.writeSVarint(t)},writeStringField:function(e,t){this.writeTag(e,pe.Bytes),this.writeString(t)},writeFloatField:function(e,t){this.writeTag(e,pe.Fixed32),this.writeFloat(t)},writeDoubleField:function(e,t){this.writeTag(e,pe.Fixed64),this.writeDouble(t)},writeBooleanField:function(e,t){this.writeVarintField(e,!!t)}};function x1(e,t,n){var s=n.buf,i,r;if(r=s[n.pos++],i=(r&112)>>4,r<128||(r=s[n.pos++],i|=(r&127)<<3,r<128)||(r=s[n.pos++],i|=(r&127)<<10,r<128)||(r=s[n.pos++],i|=(r&127)<<17,r<128)||(r=s[n.pos++],i|=(r&127)<<24,r<128)||(r=s[n.pos++],i|=(r&1)<<31,r<128))return I1(e,i,t);throw new Error("Expected varint not more than 10 bytes")}function kt(e){return e.type===pe.Bytes?e.readVarint()+e.pos:e.pos+1}function I1(e,t,n){return n?t*4294967296+(e>>>0):(t>>>0)*4294967296+(e>>>0)}function A1(e,t){var n,s;if(e>=0?(n=e%4294967296|0,s=e/4294967296|0):(n=~(-e%4294967296),s=~(-e/4294967296),n^4294967295?n=n+1|0:(n=0,s=s+1|0)),e>=18446744073709552e3||e<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");t.realloc(10),M1(n,s,t),P1(s,t)}function M1(e,t,n){n.buf[n.pos++]=e&127|128,e>>>=7,n.buf[n.pos++]=e&127|128,e>>>=7,n.buf[n.pos++]=e&127|128,e>>>=7,n.buf[n.pos++]=e&127|128,e>>>=7,n.buf[n.pos]=e&127}function P1(e,t){var n=(e&7)<<4;t.buf[t.pos++]|=n|((e>>>=3)?128:0),e&&(t.buf[t.pos++]=e&127|((e>>>=7)?128:0),e&&(t.buf[t.pos++]=e&127|((e>>>=7)?128:0),e&&(t.buf[t.pos++]=e&127|((e>>>=7)?128:0),e&&(t.buf[t.pos++]=e&127|((e>>>=7)?128:0),e&&(t.buf[t.pos++]=e&127)))))}function dl(e,t,n){var s=t<=16383?1:t<=2097151?2:t<=268435455?3:Math.floor(Math.log(t)/(Math.LN2*7));n.realloc(s);for(var i=n.pos-1;i>=e;i--)n.buf[i+s]=n.buf[i]}function b1(e,t){for(var n=0;n<e.length;n++)t.writeVarint(e[n])}function E1(e,t){for(var n=0;n<e.length;n++)t.writeSVarint(e[n])}function T1(e,t){for(var n=0;n<e.length;n++)t.writeFloat(e[n])}function _1(e,t){for(var n=0;n<e.length;n++)t.writeDouble(e[n])}function S1(e,t){for(var n=0;n<e.length;n++)t.writeBoolean(e[n])}function B1(e,t){for(var n=0;n<e.length;n++)t.writeFixed32(e[n])}function F1(e,t){for(var n=0;n<e.length;n++)t.writeSFixed32(e[n])}function O1(e,t){for(var n=0;n<e.length;n++)t.writeFixed64(e[n])}function D1(e,t){for(var n=0;n<e.length;n++)t.writeSFixed64(e[n])}function _i(e,t){return(e[t]|e[t+1]<<8|e[t+2]<<16)+e[t+3]*16777216}function Nn(e,t,n){e[n]=t,e[n+1]=t>>>8,e[n+2]=t>>>16,e[n+3]=t>>>24}function hl(e,t){return(e[t]|e[t+1]<<8|e[t+2]<<16)+(e[t+3]<<24)}function L1(e,t,n){for(var s="",i=t;i<n;){var r=e[i],o=null,a=r>239?4:r>223?3:r>191?2:1;if(i+a>n)break;var c,l,f;a===1?r<128&&(o=r):a===2?(c=e[i+1],(c&192)===128&&(o=(r&31)<<6|c&63,o<=127&&(o=null))):a===3?(c=e[i+1],l=e[i+2],(c&192)===128&&(l&192)===128&&(o=(r&15)<<12|(c&63)<<6|l&63,(o<=2047||o>=55296&&o<=57343)&&(o=null))):a===4&&(c=e[i+1],l=e[i+2],f=e[i+3],(c&192)===128&&(l&192)===128&&(f&192)===128&&(o=(r&15)<<18|(c&63)<<12|(l&63)<<6|f&63,(o<=65535||o>=1114112)&&(o=null))),o===null?(o=65533,a=1):o>65535&&(o-=65536,s+=String.fromCharCode(o>>>10&1023|55296),o=56320|o&1023),s+=String.fromCharCode(o),i+=a}return s}function N1(e,t,n){return fl.decode(e.subarray(t,n))}function R1(e,t,n){for(var s=0,i,r;s<t.length;s++){if(i=t.charCodeAt(s),i>55295&&i<57344)if(r)if(i<56320){e[n++]=239,e[n++]=191,e[n++]=189,r=i;continue}else i=r-55296<<10|i-56320|65536,r=null;else{i>56319||s+1===t.length?(e[n++]=239,e[n++]=191,e[n++]=189):r=i;continue}else r&&(e[n++]=239,e[n++]=191,e[n++]=189,r=null);i<128?e[n++]=i:(i<2048?e[n++]=i>>6|192:(i<65536?e[n++]=i>>12|224:(e[n++]=i>>18|240,e[n++]=i>>12&63|128),e[n++]=i>>6&63|128),e[n++]=i&63|128)}return n}const U1=w1(y1),C1=1,Po={1:({pbf:e})=>e.readBoolean(),2:({pbf:e})=>e.readDouble(),3:({pbf:e})=>e.readString(),5:e=>{const{pbf:t}=e,n=t.readVarint(),s=new Array(n);for(let i=0;i<n;i++)s[i]=bo(e,t.readVarint());return s},4:e=>{const{pbf:t}=e,n=t.readVarint(),s={};for(let r=0;r<n;r++){var i=t.readVarint();s[e.keys[i>>3]]=bo(e,i&7)}return s},6:e=>null};function bo(e,t){const n=e.pbf;if(n.pos<n.length){const s=Po[t];if(!s)throw new Error(`Type ${t} is not supported`);return s(e)}}function ul(e){const t=e.readVarint(),n=[];for(let s=0;s<t;s++){const i=e.readString(),r=e.readVarint();n.push({key:i,type:r})}return n}function k1(e,t){if(!e||!e.byteLength||e.byteLength<4)throw new Error("Bad array or insufficient array length.");const n=new U1(e),s=n.readFixed32(),i=s>>24&255;if(i>C1)throw new Error(`Version ${i} is not supported`);const r=s>>16&255,o=r;if(r===1&&o!==1)throw new Error("Packed with PackMethod.Generic cannot be unpacked with anything than UnpackMethod.Generic");switch(o){case 1:const a=n.readFixed32();if(a>=e.byteLength)return;const c=n.pos;n.pos=a;const l=n.readVarint(),f=new Array(l);for(let u=0;u<l;u++)f[u]=n.readString();n.pos=c;const d=n.readVarint();return bo({keys:f,pbf:n},d);case 2:{const u={keys:[],pbf:n},p=n.readFixed32(),w=ul(n),A={};for(const{key:h,type:m}of w){const I=Po[m],M=[];for(let v=0;v<p;v++)M.push(I(u));A[h]=M}return A}case 3:{const u={keys:[],pbf:n},p=n.readFixed32(),w=ul(n),A=new Array(p);for(let h=0;h<p;h++)A[h]={};for(const{key:h,type:m}of w){const I=Po[m];for(let M=0;M<p;M++)A[M][h]=I(u)}return A}default:throw new Error(`Method ${o} is not supported`)}}function pl(e){const t=new Io;if(e instanceof ArrayBuffer){const n=k1(e);if(Array.isArray(n))for(const{id:s,...i}of n)t.set(s,i);else for(const s in n)t.set(s,n[s])}else for(const n in e)t.set(n,e[n]);return t}class V1{constructor(t,n,s){this.scope=t,this.options=n,this.id=s,this.featureStateMap=new Io,t.sources[s]=this,this.tileData={},this.styleManager=t.styleManager,this.collector=t.collector,this.sourceAttrs=this.options.attributes||{},this.metatile=C0(),this.tileServer="url"in n?new Ei(n):new xo(n)}fetchTile(t){const n=ut(t);return this.tileData[n]?Promise.resolve(this.tileData[n]):this.tileServer.fetchTile(t).then(s=>(this.tileData[n]=s,s))}abortTileFetch(t){this.tileServer instanceof Ei&&this.tileServer.abortTile(t)}generateTile(t,n,s,i,r,o,a,c){const l=ut(n),f=this.tileData[l],d=Bt(n),u=[],p=[],w=this.styleManager.getStyle(s),A=new Set(i),{promoteId:h}=this.options,m={},I="generateId"in this.options?this.options.generateId:!1;if(!w)return Promise.resolve({results:u,transferable:p});f&&f.components.forEach((T,F)=>{const{tileProps:E}=this.metatile,B=[],k=[];if(T.tags){const O=Object.keys(T.tags);Hn(this.metatile,O);for(const L of O)B[E[L]]=T.tags[L]}const U=Object.keys(this.sourceAttrs);Hn(this.metatile,U);const g=Array.from(this.featureStateMap.featureAttrs);Hn(this.metatile,g);for(const O of U)B[E[O]]=this.sourceAttrs[O];const x=B[E.db_hidden_by_plan_id];if(x&&t._activeFloorIds.includes(x))return;const _=I?String(T.index+this.id*2**32):h?B[E[h]]:void 0;if(_!==void 0){const O=A.has(_);if(B[E.selected]=O?1:0,f.byId.set(_,F),m[_]=T.index,this.featureStateMap.featureAttrs.size>0){const L=_!==void 0&&this.featureStateMap.get(_);if(L)for(const N of this.featureStateMap.featureAttrs)this.featureStateMap.clearAttrs=!1,k[E[N]]=L[N];else if(this.featureStateMap.clearAttrs===!1){this.featureStateMap.clearAttrs=!0;for(const N in E)k[E[N]]!==void 0&&(k[E[N]]=void 0)}}}const{coords:C}=d,y=C[3],b=Ns(r),P=In(t,this.sourceAttrs,E,B,k,_,d),D=this.styleManager.getLayers(w.id,E,B).filter(O=>N0(T.type,O.type)&&q(O.filter,P)&&(a?q(a,P):!0));if(D.length===0&&P.id&&this.collector.idIndexer.addOrphanId(P.id),B[E.db_geometry_type]=T.type==="line"?"polyline":T.type,(T.type==="point"||T.type==="line")&&(B[E.db_label]===void 0&&(B[E.db_label]=NaN),B[E.db_label2]===void 0&&(B[E.db_label2]=NaN)),T.type==="line"){const O=R0(T);B[E.componentDistanceStart]=0,B[E.componentDistanceEnd]=O,B[E.objectLength]=O,typeof B[E.beginningIsCut]!="number"&&(B[E.beginningIsCut]=0),typeof B[E.endingIsCut]!="number"&&(B[E.endingIsCut]=0)}yi(this.collector,w,D,P,this.metatile,ro,y,this.id,d,b,T.vertices,void 0,o,c)});const M=this.collector.getAccumulatedData(),v={regionId:0,metatileHash:Fl,collectorOutput:M,styleId:w.id};Object.keys(m).length>0&&(v.idToIndex=m),u.push(v),p.push(...M.transferable),this.scope.debouncedResetCollector(),this.scope.syncNewRasterSets();const S={results:u,transferable:p};return Promise.resolve(S)}getObjectAttributes(t,n){const s=this.tileData[n];if(s){const i=s.byId.get(t);if(i===void 0)return;const r=s.components[i];return r===void 0?void 0:r.tags}}deleteTile(t){delete this.tileData[ut(t)]}setSourceAttrs(t){this.sourceAttrs=t}destroy(){delete this.scope.sources[this.id],this.tileData={},this.sourceAttrs={},this.tileServer.destroy()}setFeatureStateMap(t){this.featureStateMap=pl(t)}setData(t){if(typeof t=="string"){if(this.tileServer instanceof Ei)return this.tileServer.destroy(),this.options={...this.options,url:t},this.tileServer=new Ei(this.options),this.tileData={},Promise.resolve(!0)}else if(this.tileServer instanceof xo)return this.tileServer.destroy(),this.options={...this.options,data:t},this.tileServer=new xo(this.options),this.tileData={},Promise.resolve(!0);return Promise.resolve(!1)}}class Y1{constructor(){this.cache=new Map,this.pendingRequests=new Map}async fetch(t,n=3,s=300){var o;let i=0,r;for(;i<=n;)try{if(r=await this.fetchAttempt(t),!r)return;if(!r.err||!Cc((o=r.err)==null?void 0:o.status))return r;throw new Error(`Fetching ${t.coords} attempt ${i} failed.`)}catch{if(i>=n)return{metadata:[]};await cl(Math.pow(2,i)*s),i++}}get(t){return this.cache.get(t)||[]}delete(t){this.cache.delete(t)}abortRequest(t){const n=this.pendingRequests.get(t);n!==void 0&&(n.xhr.abort(),n.resolve(),this.pendingRequests.delete(t))}destroy(){this.cache.clear(),this.pendingRequests.clear()}fetchAttempt({tileUrl:t,coords:n}){return new Promise(s=>{const i=ut(n),r=xi({url:t},(o,a)=>{if(this.pendingRequests.delete(i),o||a.byteLength===0){o!==void 0&&console.error(o),this.cache.set(i,[]),s({metadata:[],err:o});return}const c=$f(a),l=Gf(c);this.cache.set(i,c),s({metadata:l,err:o})});this.pendingRequests.set(i,{xhr:r,resolve:s})})}}const gl=0;ei.Loaded;function $1(e){const t=[],n=Object.keys(qn).length;for(let s=0;s<n;s++)t[s]=NaN;for(const s in e){if(qn[s]===void 0)throw new Error(`No such tile prop '${s}'`);t[qn[s]]=e[s]}return t}function G1(e,t,n){const i=le,r={x:new Uint16Array([0,i,i,0,0]),y:new Uint16Array([0,0,i,i,0])},o=$1({}),a=In(n,Bs,qn,o,tr);p0({collector:e,generator:qe.generate,args:[gl,t,a,Bt([0,0,0,0]),r]})}function Eo(e){for(let t=1;t<e.length;t++)e[t]=e[t]+e[t-1]}function z1(e){let t=0,n=0,s=0;for(let i=0;i<e.length;i+=2)s=n+e[i],n=s>>>0,e[i]=n,t=t+e[i+1]+(s>4294967295?1:0)>>>0,e[i+1]=t}const ml={1:Eo,2:Eo,4:Eo,8:z1};class wl{constructor(t){this.offset=0,this.buffer=t,this.u8=new Uint8Array(t),this.u16=new Uint16Array(t),this.u32=new Uint32Array(t),this.s8=new Int8Array(t),this.s16=new Int16Array(t),this.s32=new Int32Array(t),this.f32=new Float32Array(t)}readS8(){return this.s8[this.offset++]}readU16(){const t=this.u16[this.offset>>1];return this.offset+=2,t}readU32(){const t=this.u32[this.offset>>2];return this.offset+=4,t}readF32(){const t=this.f32[this.offset>>2];return this.offset+=4,t}readU8Vector(t=1){const s=this.readU32()*t,i=-s&3,r=this.u8.subarray(this.offset,this.offset+s);return this.offset+=s+i,r}readU16Vector(t=1){const s=this.readU32()*t*2,i=-s&3,r=this.u16.subarray(this.offset>>1,this.offset+s>>1);return this.offset+=s+i,r}}function Ee(e,t,n,s){const i=t.BYTES_PER_ELEMENT;e.offset+=-e.offset&i-1;const r=new t(e.buffer,e.offset,n);return e.offset+=i*n,s&&ml[i](r),r}function Si(e,t,n){e.offset+=-e.offset&7;const s=new Uint32Array(e.buffer,e.offset,t*2);return e.offset+=8*t,n&&ml[8](s),s}function yl(e,t,n){e.offset+=-e.offset&3;const s=new Uint32Array(e.buffer,e.offset,t),i=new Float32Array(e.buffer,e.offset,t);e.offset+=4*t;let r;if(n){let o=0;for(r=0;r<t;r++)o=o+s[r]>>>0,i[r]=o/1e3}else for(r=0;r<t;r++)i[r]=s[r]/1e3;return i}function vl(e,t,n){e.offset+=-e.offset&3;const s=new Int32Array(e.buffer,e.offset,t),i=new Float32Array(e.buffer,e.offset,t);e.offset+=4*t;let r;if(n){let o=0;for(r=0;r<t;r++)o=o+s[r]>>>0,i[r]=(o|0)/1e3}else for(r=0;r<t;r++)i[r]=s[r]/1e3;return i}function j1(e,t){let n=e.offset;const s=e.u8,i=e.buffer,r=[];for(;t--;)r.push(s[n++]|0);const o=[];for(;++t<r.length;){let a=r[t];a===255&&(a=s[n++]|s[n++]<<8|s[n++]<<16|0),o.push(new Uint8Array(i,n,a)),n=n+a}return e.offset=n,o}function X1(e,t){e.offset+=-e.offset&3;let n=e.offset;const s=e.u32,i=e.buffer,r=[];for(let a=0;a<t;a++)r.push(s[n>>2]),n+=4;const o=[];for(let a=0;a<t;a++){const c=r[a];n+=-n&7,o.push(new Uint8Array(i,n,c)),n+=c}return e.offset=n,o}function H1(e,t,n){switch(n){case 2:return Ee(e,Uint8Array,t);case 3:return Ee(e,Uint8Array,t,!0);case 4:return Ee(e,Uint16Array,t);case 5:return Ee(e,Uint16Array,t,!0);case 6:return Ee(e,Uint32Array,t);case 7:return Ee(e,Uint32Array,t,!0);case 8:return Si(e,t);case 9:return Si(e,t,!0);case 10:return Ee(e,Uint8Array,t);case 11:return j1(e,t);case 12:return X1(e,t);case 13:return Ee(e,Int8Array,t);case 14:return Ee(e,Int8Array,t,!0);case 15:return Ee(e,Int16Array,t);case 16:return Ee(e,Int16Array,t,!0);case 17:return Ee(e,Int32Array,t);case 18:return Ee(e,Int32Array,t,!0);case 19:return Si(e,t);case 20:return Si(e,t,!0);case 21:return yl(e,t);case 22:return yl(e,t,!0);case 23:return vl(e,t);case 24:return vl(e,t,!0);case 25:return Ee(e,Uint32Array,t);default:throw new Error("Unknown stream type "+n)}}function To(e){let t=0;for(let n=0;n<e.length;n++)t+=e[n];return t}function q1(e,t,n){return new e.constructor(e.buffer,e.byteOffset+t*e.BYTES_PER_ELEMENT,n)}let Kt;const Rn=[],vt=new Int32Array(256);let _o;const So=[],xl=[],Il=[],Bo=[0,0,0,0,0];let Al=0,Fo=0,Oo=0,Un={};function Z1(e,t,n,s,i,r,o,a,c=!1,l,f,d,u){const{styleState:p,sourceId:w,sourceAttrs:A,tileInfo:h,pixelRatio:m,selectedIds:I,dataFilter:M,floorsEnabled:v,hoverId:S,generateOnlySelectedPoi:T,generateOnlyHoveredPoi:F,modelsPath:E}=i,{data:B}=r,k=new Set(I),U=zf(B);if(U.byteLength<8)return s.getAccumulatedData();Rn.length=0;const g=new wl(U);if(g.readU32()!==1279676242)return s.getAccumulatedData();const _=g.readU16();if(_!==2&&_!==3&&_!==4)return console.error(`Unsupported tile format version: "${_}"`),s.getAccumulatedData();Kt=_,g.readU16();const C=Ns(m);return W1(g),J1(g),K1(Kt,e,t,p,n,s,g,h,C,k,M,o,a,v,w,A,c,S,T,F,E,l,f,d,u),s.getAccumulatedData()}function W1(e){const t=Kt===4?2:1,n=e.u8;let s=e.offset,i=e.u32[s>>2];for(s+=4,Al=i,Fo=s;i--;)s=n[s++]*2+s,s=n[s++]*t+s;e.offset=s+(-s&3)}function J1(e){const t=e.u32[e.offset>>2];e.offset+=4,_o=Ee(e,Uint8Array,t);const n=Ee(e,Uint32Array,t);for(let s=0;s<t;s++){const i=_o[s];Rn[s]=H1(e,n[s],i),vt[s]=0}}function K1(e,t,n,s,i,r,o,a,c,l,f,d,u,p,w,A,h=!1,m,I,M,v,S,T,F,E){const B=Array.from(i.featureAttrs);Hn(d,B);const k=Al,U=Ee(o,Int32Array,k),g=To(U),x=Ee(o,Uint8Array,g,!0),_=Ee(o,Uint8Array,To(x),!0),C=Ee(o,Uint8Array,g,!0),y=Ee(o,Uint8Array,To(C),!0),b=Ee(o,Uint16Array,g,!0);let P=0,D=0,O=0,L=!0;for(let N=0;N<k;N++){const R=U[N];np(o,d,u);for(let H=0;H<R;H++){const $=x[P];$>0&&(Q1(u,$,_,D,d,e,h),D+=$);const V=C[P];if(V>0&&(ep(u,V,y,O),O+=V),!u[d.tileProps.db_geometry_type]){console.error(`Geometry type not specified for data source ${w}. Metatile version ${d.version}`);return}L=$>0||V>0;const G=d.tileProps;let Z=u[G[F??""]];Number.isNaN(Z)&&(Z=void 0);const ne=In(s,A,G,u,[],Z,a),W=b[P];W>0&&tp(e,t,n,s,ne,i,r,W,a,c,l,f,d,p,w,m,I,M,v,S,L,T,E),P++}}Ml()}function Q1(e,t,n,s,i,r,o=!1){var a;for(;t--;){const c=n[s++],l=xl[c],f=So[c],d=_o[l];if(d===8||d===9||d===19||d===20)e[f]=Sc(Rn[l][vt[l]],Rn[l][vt[l]+1]),vt[l]+=2;else{const u=Rn[l][vt[l]];switch(f){case i.tileProps.objectLength:case i.tileProps.db_centroid_x:case i.tileProps.db_centroid_y:case i.tileProps.componentDistanceEnd:case i.tileProps.componentDistanceStart:case i.tileProps.previousPointX:case i.tileProps.previousPointY:case i.tileProps.nextPointX:case i.tileProps.nextPointY:e[f]=r===2?u*xs:u;break;case i.tileProps.db_label:e[f]=fr(u);break;case i.tileProps.db_label2:e[f]=fr(u);break;case i.tileProps.db_tiers:const p=u.byteLength/Int32Array.BYTES_PER_ELEMENT,w=new DataView(u.buffer,u.byteOffset,u.byteLength),A=w.getInt32(0,!0);if(p===1&&!A)e[f]=void 0;else{const h=new Array(p);h[0]=A;for(let m=1;m<p;m++)h[m]=w.getInt32(m*Int32Array.BYTES_PER_ELEMENT,!0);e[f]=h}break;default:if(o&&d===11)e[f]=fr(u);else{const h=i.tilePropsByIndex[f];e[f]=((a=i.reverseDictionaries[h])==null?void 0:a[u])??u}}vt[l]++}}}function ep(e,t,n,s){for(;t--;){const i=n[s++],r=So[i];e[r]=NaN}}let Bi=[];function tp(e,t,n,s,i,r,o,a,c,l,f,d,u,p,w,A,h,m,I,M=[],v,S,T){const{tileProps:F,defaultProps:E}=u,{tileAttrs:B,featureAttrs:k,id:U}=i,g=c.coords[3],x=F.db_hidden_by_plan_id!==void 0;if(!v&&Bi.length===0){for(let y=0;y<Oo;y++){const b=Bo[y];vt[b]=vt[b]+a}return}const _=B[F.db_geometry_type],C=Kt===4?u.vertexProps:u.vertexPropsLegacy[_];if(!C){console.error(`Couldn't get vertex keys for tile ${ut(c.coords)} source ${w}. Metatile version ${u.version}`);return}for(let y=0;y<Oo;y++){const b=Kt===4?Il[y]:y,P=Bo[y],D=C[b]??"signed_z";Un[D]=sp(q1(Rn[P],vt[P],a),y,e),Kt===4&&D==="z"&&(Un.signed_z=Un.z),vt[P]=vt[P]+a}if(!(F.db_sublayer!==void 0&&!Number.isNaN(B[F.db_sublayer])&&qr(B[F.db_sublayer]))&&!(x&&s._activeFloorIds&&B[F.db_hidden_by_plan_id]&&s._activeFloorIds.includes(B[F.db_hidden_by_plan_id]))){for(const y in E){const b=E[y];Number.isNaN(B[b.index])&&(B[b.index]=b.value)}if(!(A&&A!==U)){if(U!==void 0){let y=f.has(U);h&&(y=!0);const b=!!m||!!A&&A===U;if(B[F.selected]=y?1:0,B[F.hovered]=b?1:0,M.length>0){const P={};M.forEach(D=>{P[D]=B[F[D]]}),o.addPromotedObjectAttributes(U,P)}p&&g>=Cl.detailLevel&&B[F.db_hidden_by_plan_building_id]&&o.addFloorHidingMap(U,B[F.db_hidden_by_plan_building_id])}else B[F.selected]=0,B[F.hovered]=0;if(r.featureAttrs.size>0){const y=U!==void 0&&r.get(U);if(y)for(const b of r.featureAttrs)r.clearAttrs=!1,k[F[b]]=y[b];else if(r.clearAttrs===!1){r.clearAttrs=!0;for(const b in F)k[F[b]]!==void 0&&(k[F[b]]=void 0)}}if(S){const y=ip(Un,_,c);if(y){const b=rp(i,ut(c.coords));o.addFeature({type:"Feature",properties:b,geometry:y})}return}v&&(Bi=n.getLayers(t.id,F,B).filter(y=>q(y.filter,i)&&(d?q(d,i):!0))),Bi.length===0&&i.id&&o.idIndexer.addOrphanId(i.id),yi(o,t,Bi,i,u,Kt,g,w,c,l,Un,h||m,I,T)}}}function np(e,t,n){const s=Object.keys(t.tileProps).length,i=e.u8;let r,o,a=Fo;for(o=1;o<s;o++)n[o]=NaN;for(r=i[a++],o=0;o<r;o++)So[o]=i[a++],xl[o]=i[a++];for(r=i[a++],o=0;o<r;o++)Kt===4&&(Il[o]=i[a++]),Bo[o]=i[a++];Oo=r,Fo=a,Ml()}function Ml(){Un={}}function sp(e,t,n){if(n===2&&t<3&&e instanceof Uint16Array)for(let s=0;s<e.length;s++)e[s]*=xs;return e}function ip(e,t,n){const s=[],{x:i,y:r,z:o,signed_z:a}=e;for(let c=0;c<e.x.length;c++){const l=Jn(i[c],r[c],n),f=Ie.scaleFactor(l[1]),d=o?o[c]*32:void 0;l[2]=d??(a==null?void 0:a[c])??0,l[2]/=Te*f,s.push(l)}if(s.length)switch(t){case"point":return{type:"MultiPoint",coordinates:s};case"polyline":return{type:"LineString",coordinates:s};case"polygon":return{type:"Polygon",coordinates:[s.map((c,l)=>s[Ge(l,s.length)])]};default:return}}function rp(e,t){const n={tile:t};return Object.keys(e.tileProps).forEach(s=>{const i=e.tileAttrs[e.tileProps[s]];!Number.isNaN(i)&&i!==void 0&&(n[s]=i)}),n}const op=e=>{if(e.length>2){let t=0;for(let n=e.length-1,s=n,i=0;i<=n;i++){const r=e[s],o=e[i];t+=(r[0]+o[0])*(r[1]-o[1]),s=i}return t/2}else return 0},ap=e=>op(e)>0;function cp(e){e=e.slice().sort(lp);const t=e.length,n=new Array(t*2);let s=0;for(let r=0;r<t;r++){const o=e[r];for(;s>=2&&Pl(n[s-2],n[s-1],o)<=0;)s--;n[s++]=o}const i=s+1;for(let r=t-2;r>=0;r--){const o=e[r];for(;s>=i&&Pl(n[s-2],n[s-1],o)<=0;)s--;n[s++]=o}return n.slice(0,s-1)}function Pl(e,t,n){return(t[1]-e[1])*(n[0]-e[0])-(t[0]-e[0])*(n[1]-e[1])}function lp(e,t){return e[0]===t[0]?e[1]-t[1]:e[0]-t[0]}function fp(e){const t=[],n=ap(e),s=Ci(e[0],e[e.length-1]),i=s?e.length-1:e.length;for(let r=i-1,o=0,a=1;o<i;o++,r=o-1,a=(o+1)%i){const c=[];Mf(c,e[r],e[o],e[a],n),t.push(c)}return s&&t.push(t[0]),t}const Fi=[[0],[0],[0]],bl=[];function dp(e,t,n,s,i,r,o,a,c){const{matrix:l,offset:f,id:d,selected:u}=r,p=new wl(i),w=[];if(!e)return{objects:s.getAccumulatedData(),textures:w};if(p.readU32()!==1296191066||p.readU16()!==1)return{objects:s.getAccumulatedData(),textures:[]};p.readU16();const A=p.readU32();for(let E=0;E<A;E++)w.push(p.readU8Vector());const{tileProps:h}=o,m=[],I=Object.keys(h).length;for(let E=0;E<I;E++)m[E]=NaN;if(m[h.db_sublayer]="Building_model",m[h.selected]=u?1:0,m[h.db_region]=a,c.featureAttrs.size>0){const E=Array.from(c.featureAttrs);Hn(o,E)}const M=[],v=typeof d!="number"&&c.get(d);if(v)for(const E of c.featureAttrs)c.clearAttrs=!1,M[h[E]]=v[E];else if(c.clearAttrs===!1){c.clearAttrs=!0;for(const E in h)M[h[E]]!==void 0&&(M[h[E]]=void 0)}const S=p.offset,T=In(n,Bs,h,m,M,d),F=t.getLayers(e.id,h,m).filter(E=>q(E.filter,T));return F.length===0&&T.id&&s.idIndexer.addOrphanId(T.id),F.forEach(E=>{E.type!=="buildingModel"||(Dc(E,T),!q(E.filter,T))||(p.offset=S,hp(e,E,T,s,p,l,f))}),{objects:s.getAccumulatedData(),textures:w}}function hp(e,t,n,s,i,r,o){const a=i.readU32();for(let c=0;c<a;c++){const l=i.readU32(),f=Cn(i.readF32(),i.readF32(),i.readF32()),d=Cn(i.readF32(),i.readF32(),i.readF32()),u=rn(Je(),d,f),p=[];of(p,r,f),bs(p,p,u),p[12]+=o[0],p[13]+=o[1];const w=i.readU16Vector(5),A=i.readU32();for(let M=0;M<A;M++){const v=i.readU32()===1?Ol:Li,S=i.readU16Vector();do Ht.processSubmesh(e.id,t,n,s,w,S,v,l,p);while(s.isOverloaded())}const h=i.readU16Vector();do Ht.processOuterEdge(e.id,t,n,s,w,h,p);while(s.isOverloaded());const m=cp(up(w)),I=fp(m);for(let M=0;M<m.length-2;M++){for(let v=0;v<3;v++){const S=pp(M+v,m.length);Fi[0][v]=m[S][0],Fi[1][v]=m[S][1],Fi[2][v]=0,bl[v]=I[S]}do at.generateFloorsBottomFill(s,e.id,Fi,bl,Gs,p);while(s.isOverloaded())}}}function up(e){const t=[];for(let n=0;n<e.length;n+=5)t.push([e[n],e[n+1]]);return t}function pp(e,t){return e===0?0:e%2?(e+1)/2:t-e/2}class gp{constructor(t){this.scope=t,this.tileLoader=new Y1,this.tileAttrs=[],this.models={},this.featureStateMap=new Io}fetchTile(t,n=3){return this.tileLoader.fetch(t,n)}abortTileRequest(t){this.tileLoader.abortRequest(t)}generateTile(t,n){const{styleManager:s,collector:i,metatiles:r}=this.scope,{tileInfo:o,promoteAttributes:a,promoteId:c,isCustomZenithSource:l,modelShowHideEventsSublayers:f}=t,d=ut(o.coords),u=this.tileLoader.get(d),p=[],w=[],A=[],h={};return u.forEach(m=>{var T;const{regionId:I,metatileHash:M}=m,v=this.scope.styleManager.getStyle(t.styleId);if(!v)return;if(t.areTileBoundsVisible&&t.isDefaultSource){const E=s.getStyle(gl).layers.find(B=>B.id==="debug-tile-bounds");G1(i,E,t.styleState)}const S=Z1(v,s,this.featureStateMap,i,t,m,r[M],this.tileAttrs,l,a,n,c,f);Object.assign(h,S.promotedObjectAttributes),p.push({regionId:I,metatileHash:M,collectorOutput:S,styleId:v.id}),A.push(...S.transferable),(T=S.debugGeoJsonData)==null||T.forEach(F=>w.push(F))}),this.scope.resetCollector(),this.scope.syncRasterSets(),Promise.resolve({results:p,transferable:A,promotedAttrs:Object.keys(h).length>0?h:void 0,geoJsonData:n?w:void 0})}deleteTile(t){this.tileLoader.delete(t)}setFeatureStateMap(t){this.featureStateMap=pl(t)}generateModel(t){const{regionId:n,metatileHash:s,styleId:i,url:r,id:o}=t,{styleManager:a}=this.scope;return new Promise(c=>{const l=this.models[o];(l?Promise.resolve(l):new Promise(d=>{xi({url:r},(u,p)=>{if(u||p.byteLength===0){const w=this.models[o]=new ArrayBuffer(0);d(w)}else this.models[o]=p,d(p)})})).then(d=>{if(d.byteLength===0){c({objects:this.scope.collector.getAccumulatedData(),textures:{isBitmap:!1,data:[]}});return}const u=this.scope.styleManager.getStyle(i);if(!u){c({objects:this.scope.collector.getAccumulatedData(),textures:{isBitmap:!1,data:[]}});return}const{objects:p,textures:w}=dp(u,a,t.styleState,this.scope.collector,d,t,this.scope.metatiles[s],n,this.featureStateMap);if(this.scope.createImageBitmap){const A=w.map(h=>{const m=new Blob([h],{type:"image/png"});return createImageBitmap(m)});Promise.all(A).then(h=>{c({objects:p,textures:{isBitmap:!0,data:h},transferable:[...p.transferable,...h]}),this.scope.resetCollector()})}else c({objects:p,textures:{isBitmap:!1,data:w},transferable:[...p.transferable,d]}),this.scope.resetCollector()})})}destroy(){this.tileLoader.destroy(),this.tileAttrs=[],this.models={}}}function mp(e){const t=new b0(e),n=new E0(t),s=new D0(n),i=new S0,r=new O0,o={main:{addNewRasterSets:n.get(Ii.Main,"addNewRasterSets")},labeling:{addNewRasterSets:n.get(Ii.Labeling,"addNewRasterSets")}},a={},c=new A0("parser"),l=_l(()=>c.reset(),Nl),f=()=>{const E=c.atlasPacker.getNewRasterSets();E.size&&E.forEach((B,k)=>{o.main.addNewRasterSets(k,B),o.labeling.addNewRasterSets(k,B)})},d={sources:{},collector:c,styleManager:r,syncNewRasterSets:f,debouncedResetCollector:l};s.set("GeoJsonSource",V1,d);const u={collector:c,metatiles:a,styleManager:r,syncRasterSets:f,resetCollector:l,createImageBitmap:e.createImageBitmap};s.set("ZenithWorker",gp,u);const p=(E,B)=>{a[E]=B};n.set("setMetatile",p);const w=()=>{var x;const E=c.getIndexerStats(),B=c.getStatsAfterReset(),k=c.getBucketsMemoryFootprint(),U=[];(x=s.classes.get("ZenithWorker"))==null||x.hosts.forEach(_=>{_.tileLoader&&_.tileLoader.cache.size>0&&_.tileLoader.cache.forEach((C,y)=>{U.push({[y]:_.tileLoader.cache.get(y).reduce((b,P)=>b+P.data.byteLength,0)})})});const g={collector:{buckets:k,reset:B,idIndexer:E},zenit:{cache:U}};return{js:{...g,"--sum":lo(g)}}};n.set("getMemoryFootprint",w);const A=(...E)=>r.proxySyncStyle(...E);n.set("syncStyle",A);const h=E=>new Promise(B=>{xi({url:E},(k,U)=>{if(k||U.byteLength===0){B(void 0);return}if(e.createImageBitmap){const g=new Blob([U],{type:"image/png"});createImageBitmap(g).then(x=>{B({isBitmap:!0,data:[x],transferable:[x]})})}else B({isBitmap:!1,data:[U],transferable:[U]})})});n.set("prepareAtlas",h);const m=E=>{for(let U=0;U<E.length;U+=3){const g=E[U+2],x={type:ei.Loaded,isSvg:!1,index:g,key:`loaded-${g}`,name:"",fileName:"",rasters:[{rasterSetIndex:g,rasterIndex:0,w:E[U],h:E[U+1],atlasIndex:0,x:0,y:0,isPacked:!1,anchorX:0,anchorY:0}]};c.atlasPacker.pack(x,[E[U]],1)}const B=c.atlasPacker.getPackedRasters(),k=[];return B!==void 0&&k.push(B.buffer),{packedRasters:B,transferable:k}};n.set("packRasters",m);const I=E=>i.fetch(E.coords,E.tileServer,E.tileProtocol,E.regionIds,E.timestamp);n.set("fetchTrafficTile",I);const M=E=>{i.delete(E)};n.set("deleteTrafficTile",M);const v=E=>{i.abortRequest(E)};n.set("abortTrafficTileRequest",v);const S=da(["db_sublayer","traffic_road_class","traffic_color","traffic_road_z_level","db_tiers","db_has_immersive_counterpart","beginningIsCut","endingIsCut","traffic_color2"],["Traffic_jams"]),T=({coords:E,pixelRatio:B,styleState:k,styleId:U,sourceId:g})=>{const x=ut(E),_=Bt(E),C=[],y=[],b=1,P=r.getStyle(U);if(!P)return Promise.resolve({results:C,transferable:y});const D=i.get(x);if(D){const O=T0(c,S,P,r,k,B,D,_,g);C.push({regionId:b,metatileHash:0,styleId:P.id,collectorOutput:O})}return Promise.resolve({results:C,transferable:y})};n.set("generateTrafficTile",T);const F=(E,B,k,U,g,x,_,C)=>{const y=r.getStyle(x);if(!y)return;const b=_0(c,y,_,a[k],B,U,g,E,C);return l(),f(),{collectorOutput:b,transferable:b.transferable,styleId:y.id}};n.set("generatePersonalPoi",F)}mp(self)})();
