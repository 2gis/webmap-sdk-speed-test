(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const s of r.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&i(s)}).observe(document,{childList:!0,subtree:!0});function n(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(o){if(o.ep)return;o.ep=!0;const r=n(o);fetch(o.href,r)}})();const F9=(t,e)=>{let n;const i={add:()=>{if(!n){const r=`
                    <button>
                        Custom control
                    </button>
                `;n=new mapgl.Control(t,r,{position:"topLeft"})}},setTopLeftPosition:()=>{n&&n.setPosition("topLeft")},setTopCenterPosition:()=>{n&&n.setPosition("topCenter")},setTopRightPosition:()=>{n&&n.setPosition("topRight")},setCenterLeftPosition:()=>{n&&n.setPosition("centerLeft")},setCenterRightPosition:()=>{n&&n.setPosition("centerRight")},setBottomRightPosition:()=>{n&&n.setPosition("bottomRight")},setBottomCenterPosition:()=>{n&&n.setPosition("bottomCenter")},setBottomLeftPosition:()=>{n&&n.setPosition("bottomLeft")},destroy:()=>{n&&(n.destroy(),n=void 0)}},o=e.addFolder("Custom control");o.add(i,"add"),o.add(i,"setTopLeftPosition"),o.add(i,"setTopCenterPosition"),o.add(i,"setTopRightPosition"),o.add(i,"setCenterLeftPosition"),o.add(i,"setCenterRightPosition"),o.add(i,"setBottomRightPosition"),o.add(i,"setBottomCenterPosition"),o.add(i,"setBottomLeftPosition"),o.add(i,"destroy")},k9=(t,e)=>{let n=[];function i(){t._impl.hideLabelsDebug(),n.forEach(s=>s.destroy()),n=[]}const o={addDefault:()=>{i(),n.push(new mapgl.Label(t,{coordinates:t.getCenter(),text:`Default label
Лейбл с параметрами по умолчанию`}))},addCustom:()=>{i(),n.push(new mapgl.Label(t,{coordinates:t.getCenter(),text:`Custom label
Лейбл с кастомными параметрами`,minZoom:1,maxZoom:20,color:"#100000",fontSize:24,haloRadius:2,haloColor:"#1fffff",letterSpacing:2,lineHeight:1.2,zIndex:1,offset:[0,0],relativeAnchor:[.5,.5],anchor:[0,0]}))},addCustomWithImage:()=>{i(),n.push(new mapgl.Label(t,{coordinates:t.getCenter(),text:`Custom label with image
Лейбл с кастомными параметрами
И картинкой`,minZoom:1,maxZoom:20,color:"#100000",fontSize:12,haloRadius:1,haloColor:"#1fffff",letterSpacing:1,lineHeight:1.2,zIndex:1,offset:[0,0],relativeAnchor:[.5,.5],anchor:[0,0],image:{url:"/assets/stretchable-image-debug.svg",size:[500,250],stretchX:[[50,150],[250,450]],stretchY:[[50,150]],padding:[50,50,100,50]}}))},addSuite:()=>{i(),n.push(new mapgl.Label(t,{coordinates:t.getCenter(),text:`Hello
Time to wake up
По-русски тоже можно писать`,haloRadius:2,haloColor:"#00ff0055"})),n.push(new mapgl.Label(t,{coordinates:t.getCenter(),text:"Anchor is used",offset:[150,150]})),n.push(new mapgl.Label(t,{coordinates:t.getCenter(),text:"Small red text",color:"#ff000099",fontSize:14,offset:[-200,-200]})),n.push(new mapgl.Label(t,{coordinates:t.getCenter(),text:"With background",color:"#000000",fontSize:32,offset:[150,-200],image:{url:"assets/stretchable-image-debug.svg",size:[500,250],stretchX:[[50,150],[250,450]],stretchY:[[50,150]],padding:[50,50,100,50]}}))},addLabelingSuite:()=>{i(),t._impl.showLabelsDebug();const s=t.getSize().slice(),a=64,l=s.map(c=>Math.trunc(.25*c));for(let c=l[0];c<=s[0]-l[0];c+=a)for(let d=l[1];d<s[1]-l[1];d+=a){const u=Math.trunc(Math.random()*a),f=t.unproject([c-u,d-u]);n.push(new mapgl.Label(t,{coordinates:f,text:`X${c}Y${d}\r
Label labeL`,haloRadius:2,haloColor:"#00ff0055",labeling:{type:"pointLabelsOnly"},offset:[10,20]}))}},addLabelingSuiteWithImage:()=>{i(),t._impl.showLabelsDebug();const s=t.getSize().slice(),a=64,l=s.map(c=>Math.trunc(.25*c));for(let c=l[0];c<=s[0]-l[0];c+=a)for(let d=l[1];d<s[1]-l[1];d+=a){const u=Math.trunc(Math.random()*a),f=t.unproject([c-u,d-u]);n.push(new mapgl.Label(t,{coordinates:f,text:`X${c}Y${d}\r
Label labeL`,haloRadius:2,haloColor:"#00ff0055",labeling:{type:"pointLabelsOnly"},offset:[10,20],image:{url:"/assets/stretchable-image-debug.svg",size:[250,125],stretchX:[[25,75],[175,225]],stretchY:[[25,75]],padding:[25,25,50,25]}}))}},hide:()=>n.forEach(s=>s.hide()),show:()=>n.forEach(s=>s.show()),move:()=>n.forEach((s,a)=>s.setCoordinates(s.getCoordinates().map(l=>l+(a%2===0?1:-1)*.01))),destroy:()=>{i()}},r=e.addFolder("Labels");r.add(o,"addDefault"),r.add(o,"addCustom"),r.add(o,"addCustomWithImage"),r.add(o,"addSuite"),r.add(o,"addLabelingSuite"),r.add(o,"addLabelingSuiteWithImage"),r.add(o,"show"),r.add(o,"hide"),r.add(o,"move"),r.add(o,"destroy")},R9=(t,e)=>{let n=[];function i(){n.forEach(s=>s.destroy()),n=[]}const o={addDefault:()=>{i(),n.push(new mapgl.Circle(t,{coordinates:t.getCenter(),radius:4e3}))},addCustomInteractive:()=>{i(),n.push(new mapgl.Circle(t,{coordinates:t.getCenter(),radius:4e3,zIndex:1,minZoom:2,maxZoom:20,color:"#ffffff",strokeColor:"#000000",strokeWidth:7}))},addCustomNonInteractive:()=>{i(),n.push(new mapgl.Circle(t,{coordinates:t.getCenter(),radius:4e3,zIndex:1,minZoom:2,maxZoom:20,color:"#ff0000",strokeColor:"#000000",strokeWidth:7,interactive:!1}))},addSuite:()=>{i(),n.length===0&&(n.push(new mapgl.Circle(t,{coordinates:t.getCenter(),radius:200,color:"#ff000055",strokeWidth:10,strokeColor:"#00ff00"})),n.push(new mapgl.Circle(t,{coordinates:t.getCenter(),radius:400,color:"#00ff0022"})),n.push(new mapgl.Circle(t,{coordinates:t.getCenter(),radius:4e3,color:"#0000ff11"})))},destroy:()=>{i()}},r=e.addFolder("Circles");r.add(o,"addSuite"),r.add(o,"addDefault"),r.add(o,"addCustomInteractive"),r.add(o,"addCustomNonInteractive"),r.add(o,"destroy")},z9=10,B9=(t,e)=>{let n=[];function i(){n.forEach(s=>s.destroy()),n=[]}const o={addDefault:()=>{i();const s=[...t.getCenter(),z9],a=new mapgl.CircleMarker(t,{coordinates:s,diameter:40});a.on("click",l=>{console.log(l)}),n.push(a)},addCustomInteractive:()=>{i(),n.push(new mapgl.CircleMarker(t,{coordinates:t.getCenter(),diameter:40,zIndex:1,minZoom:2,maxZoom:20,color:"#14f00055",strokeWidth:10,strokeColor:"#14f00055",stroke2Width:10,stroke2Color:"#14f00055"}))},addCustomNonInteractive:()=>{i(),n.push(new mapgl.CircleMarker(t,{coordinates:t.getCenter(),diameter:40,zIndex:1,minZoom:2,maxZoom:20,color:"#ff000055",strokeWidth:10,strokeColor:"#ff000055",stroke2Width:10,stroke2Color:"#ff000055",interactive:!1}))},destroy:()=>{i()}},r=e.addFolder("CircleMarkers");r.add(o,"addDefault"),r.add(o,"addCustomInteractive"),r.add(o,"addCustomNonInteractive"),r.add(o,"destroy")},O9=(t,e)=>{let n=[];const i=t.getCenter(),o=[i[0]+.01,i[1]+.01],r=[i[0]+.01,i[1]-.01],s=[i[0]-.01,i[1]-.01];function a(){n.forEach(d=>d.destroy()),n=[]}const l={addDefault:()=>{a(),n.push(new mapgl.Polyline(t,{coordinates:[i,o,r]}))},addDefaultDashed:()=>{a(),n.push(new mapgl.Polyline(t,{dashLength:10,coordinates:[i,o,r]}))},addDashed:()=>{a(),n.push(new mapgl.Polyline(t,{dashLength:10,gapLength:30,gapColor:"#ffffff",coordinates:[i,o,r]}))},addInterpolateGapped:()=>{a(),n.push(new mapgl.Polyline(t,{gapLength:["interpolate",["linear"],["zoom"],12,2,16,40],dashLength:10,gapColor:"#ffffff",coordinates:[i,o,r]}))},addCustomInteractive:()=>{a(),n.push(new mapgl.Polyline(t,{coordinates:[i,o,r],zIndex:1,zIndex2:-1,zIndex3:-2,minZoom:2,maxZoom:15,color:"#ffffff",color2:"#ff0000",color3:"#3388ff",width:3,width2:0,width3:0}))},addCustomNonInteractive:()=>{a(),n.push(new mapgl.Polyline(t,{coordinates:[i,o,r],zIndex:1,zIndex2:2,zIndex3:3,minZoom:2,maxZoom:15,color:"#ff0000",color2:"#000000",color3:"#3388ff",width:0,width2:3,width3:5,interactive:!1}))},addSuite:()=>{a();const d=new mapgl.Polyline(t,{coordinates:[i,o,r],width:10,color:"#00ff0055"});d.on("click",f=>{console.log("first",f)});const u=new mapgl.Polyline(t,{coordinates:[r,i,s],width:10,color:"#00ff00",width2:14,color2:"#ff0000",width3:18,color3:"#0000ff"});u.on("click",f=>{console.log("second",f)}),n.push(d),n.push(u)},destroy:()=>{a()}},c=e.addFolder("Polylines");c.add(l,"addDefault"),c.add(l,"addDefaultDashed"),c.add(l,"addDashed"),c.add(l,"addInterpolateGapped"),c.add(l,"addCustomInteractive"),c.add(l,"addCustomNonInteractive"),c.add(l,"addSuite"),c.add(l,"destroy")},D9=(t,e)=>{let n=[];const i=t.getCenter(),o=[i[0]+.01,i[1]+.01],r=[i[0]+.01,i[1]-.01],s=[i[0]-.01,i[1]-.01];function a(){n.forEach(d=>d.destroy()),n=[]}const l={addDefault:()=>{a(),n.push(new mapgl.Polygon(t,{coordinates:[[i,o,r,i]]}))},addCustomInteractive:()=>{a(),n.push(new mapgl.Polygon(t,{coordinates:[[i,o,r,i]],zIndex:1,minZoom:2,maxZoom:20,color:"#ffffff",strokeColor:"#000000",strokeWidth:7}))},addCustomNonInteractive:()=>{a(),n.push(new mapgl.Polygon(t,{coordinates:[[i,o,r,i]],zIndex:1,minZoom:2,maxZoom:20,color:"#ff0000",strokeColor:"#000000",strokeWidth:7,interactive:!1}))},addSuite:()=>{a(),n.push(new mapgl.Polygon(t,{coordinates:[[i,o,r,i]],color:"#99000055",strokeColor:"#bb0000"})),n.push(new mapgl.Polygon(t,{coordinates:[[r,i,s,r]],color:"#00990055",strokeColor:"#00bb00"}))},destroy:()=>{a()}},c=e.addFolder("Polygons");c.add(l,"addDefault"),c.add(l,"addCustomInteractive"),c.add(l,"addCustomNonInteractive"),c.add(l,"addSuite"),c.add(l,"destroy")},N9=(t,e)=>{let n;function i(){n&&(n.destroy(),n=void 0)}const o={addDefault:()=>{i(),n=new mapgl.HtmlMarker(t,{coordinates:t.getCenter(),html:"Html Маркер с параметрами по умолчанию"})},addCustom:()=>{i(),n=new mapgl.HtmlMarker(t,{coordinates:t.getCenter(),html:"Html Маркер с параметрами по умолчанию",anchor:[1,1],minZoom:3,maxZoom:10,zIndex:1})},addSuite:()=>{if(i(),n)return;const c=document.createElement("div");c.innerText="Я попап, кликни в меня!",c.style.padding="10px",c.style.border="1px solid",c.style.background="#fff",c.addEventListener("click",()=>alert("Зря! Зря, зря, зряя...")),n=new mapgl.HtmlMarker(t,{coordinates:t.getCenter(),html:c})},suiteChangeContent:()=>{n&&n.setContent("А я просто строчка!")},destroy:()=>{i()}},r={makeOnClick:!1},s=[];function a(c){const d=c.lngLat.slice(0,2),u=c.point.slice();if(t.getStyleState().terrainEnabled===!0){const _=t.getGroundPoint(u);if(!_)return;d[0]=_[0],d[1]=_[1]}const f=new mapgl.HtmlMarker(t,{coordinates:d,html:'<img src="/assets/images/marker.png">',anchor:[11,34]}),h=s.push(f)-1;f.getContent().addEventListener("click",()=>{f.destroy(),s[h]=void 0})}const l=e.addFolder("HtmlMarkers");l.add(r,"makeOnClick").onChange(()=>{if(r.makeOnClick)t.on("click",a);else{t.off("click",a);for(const c of s)c&&c.destroy()}}),l.add(o,"addDefault"),l.add(o,"addCustom"),l.add(o,"addSuite"),l.add(o,"suiteChangeContent"),l.add(o,"destroy")},U9=(t,e)=>{let n=[];function i(){n.forEach(s=>s.destroy()),n=[]}const o={addDefault:()=>{i(),n.push(new mapgl.Marker(t,{coordinates:t.getCenter()}))},addCustom:()=>{i(),n.push(new mapgl.Marker(t,{coordinates:t.getCenter(),anchor:[15,43],zIndex:0,minZoom:3,maxZoom:10,interactive:!0,icon:"https://docs.2gis.com/img/mapgl/marker.svg",size:[48,48],hoverSize:[68,68],hoverAnchor:[25,63],hoverIcon:"https://docs.2gis.com/img/mapgl/marker.svg",label:{text:"Custom marker",color:"#000000",fontSize:24,haloRadius:0,haloColor:"#ffffff",letterSpacing:0,lineHeight:1.2,zIndex:0,offset:[0,0],anchor:[.5,.5]}}))},addDomClick:()=>{new mapgl.GeoJsonSource(t,{data:{type:"FeatureCollection",features:[{id:"51dc4ea9-43f2-46f3-9d3d-35da3e4fe4a7",type:"Feature",geometry:{type:"Point",coordinates:[37.691296,55.778342]},properties:{id:"51dc4ea9-43f2-46f3-9d3d-35da3e4fe4a7",db_point_building_id:"1",label:"3.4 тыс",total:1,tile:"12/2476/1279",pinType:"marker",active:!1}},{id:"f4c4e817-ecfd-4d7d-9a47-71ff51165d72",type:"Feature",geometry:{type:"Point",coordinates:[37.691576,55.778762]},properties:{id:"f4c4e817-ecfd-4d7d-9a47-71ff51165d72",db_point_building_id:"1",label:"10.0 тыс",total:1,tile:"12/2476/1279",pinType:"marker",active:!1}},{id:"51dc4ea9-43f2-46f3-9d3d-35da3e4fe411",type:"Feature",geometry:{type:"Point",coordinates:[37.691456,55.778622]},properties:{id:"51dc4ea9-43f2-46f3-9d3d-35da3e4fe411",db_point_building_id:"1",label:"13.1 тыс",total:1,tile:"12/2476/1279",pinType:"marker",active:!1}},{id:"51dc4ea9-43f2-46f3-9d3d-35da3e4fe422",type:"Feature",geometry:{type:"Point",coordinates:[37.691416,55.778572]},properties:{id:"51dc4ea9-43f2-46f3-9d3d-35da3e4fe422",db_point_building_id:"1",label:"11.2 тыс",total:1,tile:"12/2476/1279",pinType:"marker",active:!1}},{id:"51dc4ea9-43f2-46f3-9d3d-35da3e4fe433",type:"Feature",geometry:{type:"Point",coordinates:[37.691386,55.778692]},properties:{id:"51dc4ea9-43f2-46f3-9d3d-35da3e4fe433",db_point_building_id:"1",label:"5.1 тыс",total:1,tile:"12/2476/1279",pinType:"marker",active:!1}},{id:"51dc4ea9-43f2-46f3-9d3d-35da3e4fe455",type:"Feature",geometry:{type:"Point",coordinates:[37.691206,55.778402]},properties:{id:"51dc4ea9-43f2-46f3-9d3d-35da3e4fe455",db_point_building_id:"1",label:"7.9 тыс",total:1,tile:"12/2476/1279",pinType:"marker",active:!1}}]},attributes:{source:"geo"}}),t.addLayer({id:"944496",name:"marker-multi--0-9",type:"point",style:{textFont:"Noto_Sans_Semibold",iconImage:"poi_km_pillar",iconWidth:10,iconAnchor:[.5,1],textOffset:-12.5,visibility:"visible",iconOpacity:1,allowOverlap:!0,iconPriority:100,iconTextFont:"Noto_Sans_Semibold",textFontSize:12,textPriority:100,iconTextColor:"#FFFFFF",iconTextField:["get","label"],textPlacement:"leftCenter",allowElevation:!1,iconTextAnchor:[.5,1],iconTextOffset:[7,-12],textLineHeight:1,iconTextPadding:[15,20,15,20],iconTextFontSize:12,iconLabelingGroup:"offers",textLabelingGroup:"offers",duplicationSpacing:1,iconLabelingMargin:{leftRight:10,topBottom:10},iconTextLineHeight:1,textLabelingMargin:{leftRight:0,topBottom:10},textMaxLengthPerLine:30},filter:["all",["match",["sourceAttr","source"],["geo"],!0,!1],["match",["get","pinType"],["marker"],!0,!1],["<=",["get","total"],1],["match",["get","active"],[!0],!1,!0]],metadata:{group:{id:"499341"},style:{iconPriority:{inputMode:"json"},textPriority:{inputMode:"json"},iconTextOffset:{inputMode:"json"}},filterInputMode:"json"},prevLayerId:"836330",nextLayerId:"56553"}),t.addLayer({id:"944496-h",name:"marker-multi--0-9",type:"point",style:{textFont:"Noto_Sans_Semibold",iconImage:"poi_km_pillar",iconWidth:10,iconAnchor:[.5,1],textOffset:-12.5,visibility:"visible",iconOpacity:1,allowOverlap:!0,iconPriority:100,iconTextFont:"Noto_Sans_Semibold",textFontSize:14,textPriority:100,iconTextColor:"#ff0000",iconTextField:["get","label"],textPlacement:"leftCenter",allowElevation:!1,iconTextAnchor:[.5,1],iconTextOffset:[7,-12],textLineHeight:1,iconTextPadding:[15,20,15,20],iconTextFontSize:12,iconLabelingGroup:"offers",textLabelingGroup:"offers",duplicationSpacing:1,iconLabelingMargin:{leftRight:10,topBottom:10},iconTextLineHeight:1,textLabelingMargin:{leftRight:0,topBottom:10},textMaxLengthPerLine:30},filter:["all",["match",["sourceAttr","source"],["geo2"],!0,!1],["match",["get","pinType"],["marker"],!0,!1],["<=",["get","total"],1],["match",["get","active"],[!0],!1,!0]],metadata:{group:{id:"499341"},style:{iconPriority:{inputMode:"json"},textPriority:{inputMode:"json"},iconTextOffset:{inputMode:"json"}},filterInputMode:"json"},prevLayerId:"836330",nextLayerId:"56553"});let s,a;t.on("mouseover",l=>{var c,d,u,f,h,_,p;((c=l==null?void 0:l.targetData)==null?void 0:c.type)==="geojson"&&((u=(d=l.targetData.feature)==null?void 0:d.properties)==null?void 0:u.pinType)==="marker"&&s!==((h=(f=l.targetData.feature)==null?void 0:f.properties)==null?void 0:h.id)&&(s=(p=(_=l.targetData.feature)==null?void 0:_.properties)==null?void 0:p.id,a?a.setData({type:"FeatureCollection",features:[l.targetData.feature]}):a=new mapgl.GeoJsonSource(t,{data:{type:"FeatureCollection",features:[l.targetData.feature]},attributes:{source:"geo2"}}))}),t.on("click",l=>{var c,d,u,f,h,_;((c=l==null?void 0:l.targetData)==null?void 0:c.type)==="geojson"&&alert("Marker label: "+((f=(u=(d=l.targetData)==null?void 0:d.feature)==null?void 0:u.properties)==null?void 0:f.label)+" ID: "+((_=(h=l.targetData)==null?void 0:h.feature)==null?void 0:_.id))})},addSuite:()=>{i(),n.push(new mapgl.Marker(t,{coordinates:t.getCenter()})),n.push(new mapgl.Marker(t,{coordinates:t.getCenter().map(s=>s+.02),label:{text:"With label"}})),n.push(new mapgl.Marker(t,{coordinates:t.getCenter().map(s=>s-.02),label:{text:"Label with background",color:"#000000",fontSize:32,offset:[0,40],image:{url:"/assets/tooltip-top-symmetric.svg",size:[100,50],stretchX:[[10,40],[60,90]],stretchY:[[20,40]],padding:[20,10,10,10]}}})),n.forEach(s=>{s.on("click",a=>console.log("Marker click:",a.lngLat))})},changeIcon(){n.forEach(s=>s.setIcon({icon:"/assets/marker_another_icon.svg"}))},changeHoverIcon(){n.forEach(s=>s.setHoverIcon({icon:"/assets/marker_hover.svg"}))},removeHoverIcon(){n.forEach(s=>s.setHoverIcon())},changeLabel(){n.forEach(s=>s.setLabel({text:`Я новая №${Math.round(Math.random()*100)} подпись маркера!`,fontSize:20,color:"#00ff00",haloColor:"#ff0000",haloRadius:1}))},removeLabel(){n.forEach(s=>s.setLabel())},addAndChangeLabel(){i();const s=new mapgl.Marker(t,{coordinates:t.getCenter().map(a=>a+.02),label:{text:"With label",color:"#ff0000"}});s.setLabel({text:"newnewnew",color:"#0000ff"}),n.push(s)},hide:()=>n.forEach(s=>s.hide()),show:()=>n.forEach(s=>s.show()),move:()=>n.forEach((s,a)=>s.setCoordinates(s.getCoordinates().map(l=>l+(a%2===0?1:-1)*.005))),destroy:()=>{i()}},r=e.addFolder("Markers");Object.keys(o).forEach(s=>r.add(o,s))},G9="tile{subdomain}.maps.2gis.com",H9="jam.api.2gis.com",V9="https://styles.api.2gis.com",U4="https://disk.2gis.com/styles/assets/icons",G4="https://disk.2gis.com/styles/assets/models",H4="https://mapgl.2gis.com/api/fonts",j9="https://keys.api.2gis.com/public/v1/keys/{keyID}/services/mapgl-js-api",$9="https://mapgl.2gis.com/api/js/plugins/rtl-v1.1.1.js",W9="sha512-IyuCqmcNBfZyrExDMisGi0Xhp4PXupx6AMp4cjpKcAzJo+kSmOtRTLbL1xZsfxnsIqci9Q0piqY+kcwl1hCPyw==",Z9="https://mapgl.2gis.com/api/js/plugins/draco_decoder_gltf.js";function ll(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var wl={exports:{}},Bg;function X9(){if(Bg)return wl.exports;Bg=1,wl.exports=n,wl.exports.parse=n,wl.exports.stringify=i;var t=/[-+]?([0-9]*\.[0-9]+|[0-9]+)([eE][-+]?[0-9]+)?/,e=new RegExp("^"+t.source+"(\\s"+t.source+"){1,}");function n(o){var r=o.split(";"),s=r.pop(),a=(r.shift()||"").split("=").pop(),l=0;function c(x){var I=s.substring(l).match(x);return I?(l+=I[0].length,I[0]):null}function d(x){return x&&a.match(/\d+/)&&(x.crs={type:"name",properties:{name:"urn:ogc:def:crs:EPSG::"+a}}),x}function u(){c(/^\s*/)}function f(){u();for(var x=0,I=[],E=[I],L=I,N;N=c(/^(\()/)||c(/^(\))/)||c(/^(,)/)||c(e);){if(N==="(")E.push(L),L=[],E[E.length-1].push(L),x++;else if(N===")"){if(L.length===0||(L=E.pop(),!L))return null;if(x--,x===0)break}else if(N===",")L=[],E[E.length-1].push(L);else if(!N.split(/\s/g).some(isNaN))Array.prototype.push.apply(L,N.split(/\s/g).map(parseFloat));else return null;u()}return x!==0?null:I}function h(){for(var x=[],I,E;E=c(e)||c(/^(,)/);)E===","?(x.push(I),I=[]):E.split(/\s/g).some(isNaN)||(I||(I=[]),Array.prototype.push.apply(I,E.split(/\s/g).map(parseFloat))),u();if(I)x.push(I);else return null;return x.length?x:null}function _(){if(!c(/^(point(\sz)?)/i)||(u(),!c(/^(\()/)))return null;var x=h();return!x||(u(),!c(/^(\))/))?null:{type:"Point",coordinates:x[0]}}function p(){if(!c(/^(multipoint)/i))return null;u();var x=s.substring(s.indexOf("(")+1,s.length-1).replace(/\(/g,"").replace(/\)/g,"");s="MULTIPOINT ("+x+")";var I=f();return I?(u(),{type:"MultiPoint",coordinates:I}):null}function m(){if(!c(/^(multilinestring)/i))return null;u();var x=f();return x?(u(),{type:"MultiLineString",coordinates:x}):null}function g(){if(!c(/^(linestring(\sz)?)/i)||(u(),!c(/^(\()/)))return null;var x=h();return!x||!c(/^(\))/)?null:{type:"LineString",coordinates:x}}function y(){if(!c(/^(polygon(\sz)?)/i))return null;u();var x=f();return x?{type:"Polygon",coordinates:x}:null}function b(){if(!c(/^(multipolygon)/i))return null;u();var x=f();return x?{type:"MultiPolygon",coordinates:x}:null}function v(){var x=[],I;if(!c(/^(geometrycollection)/i)||(u(),!c(/^(\()/)))return null;for(;I=T();)x.push(I),u(),c(/^(,)/),u();return c(/^(\))/)?{type:"GeometryCollection",geometries:x}:null}function T(){return _()||g()||y()||p()||m()||b()||v()}return d(T())}function i(o){o.type==="Feature"&&(o=o.geometry);function r(d){return d.join(" ")}function s(d){return d.map(r).join(", ")}function a(d){return d.map(s).map(c).join(", ")}function l(d){return d.map(a).map(c).join(", ")}function c(d){return"("+d+")"}switch(o.type){case"Point":return"POINT ("+r(o.coordinates)+")";case"LineString":return"LINESTRING ("+s(o.coordinates)+")";case"Polygon":return"POLYGON ("+a(o.coordinates)+")";case"MultiPoint":return"MULTIPOINT ("+s(o.coordinates)+")";case"MultiPolygon":return"MULTIPOLYGON ("+l(o.coordinates)+")";case"MultiLineString":return"MULTILINESTRING ("+a(o.coordinates)+")";case"GeometryCollection":return"GEOMETRYCOLLECTION ("+o.geometries.map(i).join(", ")+")";default:throw new Error("stringify requires a valid GeoJSON Feature or geometry object as input")}}return wl.exports}var l0=X9();function Y9(t){fetch("https://catalog.api.2gis.ru/3.0/profile/data?key=rurbbn3446&locale=ru_RU&user_id=V2:018d4ab2-bc6a-4890-bb06-b8c01e8a3379&auth_id=22026").then(e=>e.json()).then(e=>e.result.last_objects.filter(n=>n.point!==void 0||n.geometry!==void 0)).then(e=>{const n=e.map(i=>({id:i.id,classId:i.class_id!==void 0?i.class_id:0,humanReadableClassId:i.human_readable_class_id,name:q9(i),point:K9(i)}));n.push({id:"14126577041721",classId:5,humanReadableClassId:"personal_poi_mall",name:"Перс. POI возле Меги",point:[82.93830550946373,54.9628577751673]}),n.push({id:"70000001006742023",classId:5,humanReadableClassId:"personal_poi_beauty",name:"Перс. POI INESSA",point:[52.27301046284046,54.90010162718265]}),t._impl.setPersonalPoi(n)})}function q9(t){return t.name_ex!==void 0&&t.name_ex.primary!==void 0?t.name_ex.primary:t.name}function K9(t){return t.point!==void 0?[t.point.lon,t.point.lat]:l0.parse(t.geometry.centroid).coordinates}const J9="https://mapgl.2gis.com/api/js",Q9="tile{subdomain}-sdk.maps.2gis.com",Og="https://tile{subdomain}-sdk.maps.2gis.com/api/v3/ald",V4=c0(),j4={center:[82.920412,55.030111],zoom:11,minZoom:1,autoHideOSMCopyright:!0,key:"4970330e-7f1c-4921-808c-0eb7c4e63001",trafficControl:!0,floorControl:!0,metroControl:!0,viewport:{top:10,bottom:15,right:15,left:10},mobileSdkMode:!1,disableIconCache:!1,disableHoverStyles:!0,disableRotationByUserInteraction:!1,disablePitchByUserInteraction:!1,keepCenterWhileUserZoomRotate:!1,preserveDrawingBuffer:!1,tileServer:Q9,enableTrackResize:!0,showDefaultTileBounds:!1,scaleControl:"bottomCenter",bssUrl:"https://casino-bss-receiver-api-qa.web-staging.2gis.ru/bss/3",maxPitch:70,maxZoom:22,lowZoomMaxPitch:45,pitchHightLimitation:90,webglVersion:2,disableAntiAliasing:!1,loopWorld:!0,trafficMinZoom:9,trafficMaxZoom:16,trafficMaxDetailLevel:17,modelShowHideEventsSublayers:["Animated_immersive_model","Immersive_model","Immersive_model_multipart","Commercial_model"],graphicsPreset:"immersive"},W=nx({...j4});function ex(t,e){const n={getCanvas:()=>console.log(t.getCanvas()),getWebGLContext:()=>{const r=t.getWebGLContext(),s=t.getSize(),a=new Uint8Array(s[0]*s[1]*4);r.readPixels(0,0,s[0],s[1],r.RGBA,r.UNSIGNED_BYTE,a),console.log(`
    // Выполни этот кусок кода в консоли или в своем приложении и в буфере u8 будут пиксели карты.
    // ВАЖНО! Передай preserveDrawingBuffer=true при инициализации карты, иначе в буфере будут одни нули.
    const gl = map.getWebGLContext();
    const size = map.getSize();
    const u8 = new Uint8Array(size[0] * size[1] * 4);
    gl.readPixels(0, 0, size[0], size[1], gl.RGBA, gl.UNSIGNED_BYTE, u8);
            `),console.log({context:r,mapSize:s,mapPixelsBuffer:a})}},i=e.addFolder("Map");i.add(W,"tileServer",{prod:"",staging:"tileserver.web-staging.2gis.ru"}).onChange(()=>document.location.assign(bn(t,W))),i.add(W,"mobileSdkMode").onChange(()=>document.location.assign(bn(t,W))),i.add(mapgl._J.config.render,"alwaysRerender"),i.add(W,"disableIconCache",!!W.disableIconCache).onChange(()=>document.location.assign(bn(t,W))),i.add(W,"disableHoverStyles",!!W.disableHoverStyles).onChange(()=>document.location.assign(bn(t,W))),i.add(W,"disableRotationByUserInteraction",!!W.disableRotationByUserInteraction).onChange(()=>document.location.assign(bn(t,W))),i.add(W,"disablePitchByUserInteraction",!!W.disableRotationByUserInteraction).onChange(()=>document.location.assign(bn(t,W))),i.add(W,"keepCenterWhileUserZoomRotate",!!W.keepCenterWhileUserZoomRotate).onChange(()=>document.location.assign(bn(t,W))),i.add(W,"preserveDrawingBuffer",!!W.preserveDrawingBuffer).onChange(()=>document.location.assign(bn(t,W))),i.add(W,"webglVersion",[1,2]).onChange(()=>document.location.assign(bn(t,W)));const o={language:t.getLanguage()};i.add(o,"language",["ru","en"]).onChange(r=>{t.setLanguage(r),W.lang=r,document.location.assign(bn(t,W))}),i.add(n,"getCanvas"),i.add(n,"getWebGLContext"),i.add({showPersonalPoi:!1},"showPersonalPoi").onChange(r=>{r?Y9(t):t._impl.setPersonalPoi([])}),i.add(W,"loopWorld").onChange(()=>document.location.assign(bn(t,W)))}const xs={iconsPath:U4,fontsPath:H4,modelsPath:G4};function c0(){const t={};return location.search.slice(1).split("&").map(e=>e.split("=")).forEach(e=>{t[e[0]]=e[1]}),t}function tx(t){return Math.ceil((t*Math.LN2+Math.log(256/360/.5))/Math.LN10)}function bn(t,e){const n=Dg(t,j4,!0).reduce((o,r)=>(o[r.key]=r.value,o),{});return Dg(t,e).filter(o=>!(o.key in n)||String(o.value)!==n[o.key]).reduce((o,r,s)=>o+(s===0?"?":"&")+r.key+(r.value!==void 0?"="+r.value:""),"")}function Dg(t,e,n=!1){var s;const i=[],o=c0();if(e.key!==void 0&&i.push({key:"key",value:e.key}),!n){const a=t.getCenter(),l=t.getZoom(),c=Math.round(t.getRotation()),d=Math.round(t.getPitch()),u=tx(l),f=t.getStyleZoom();o.styleZoom!==void 0?i.push({key:"styleZoom",value:f.toFixed(11)}):i.push({key:"zoom",value:l.toFixed(3)}),i.push({key:"lng",value:a[0].toFixed(u)},{key:"lat",value:a[1].toFixed(u)}),c!==0&&i.push({key:"rotation",value:c.toString()}),d!==0&&i.push({key:"pitch",value:d.toString()})}return e.mobileSdkMode&&i.push({key:"mobileSdkMode"}),e.disableIconCache&&i.push({key:"disableIconCache"}),e.disableHoverStyles||i.push({key:"enableHover"}),e.disablePitchByUserInteraction&&i.push({key:"disablePitch"}),e.keepCenterWhileUserZoomRotate&&i.push({key:"keepCenterWhileUserZoomRotate"}),e.disableRotationByUserInteraction&&i.push({key:"disableRotation"}),e.preserveDrawingBuffer&&i.push({key:"preserveDrawingBuffer"}),e.style!==void 0&&i.push({key:"styleId",value:e.style}),e.keyUrl!==void 0&&i.push({key:"keyUrl",value:e.keyUrl}),e.dracoDecoderUrl!==void 0&&i.push({key:"dracoDecoderUrl",value:e.dracoDecoderUrl}),e.styleServer!==void 0&&i.push({key:"styleServer",value:encodeURIComponent(e.styleServer)}),e.fontUrl!==void 0&&i.push({key:"fontUrl",value:encodeURIComponent(e.fontUrl)}),e.iconUrl!==void 0&&i.push({key:"iconUrl",value:encodeURIComponent(e.iconUrl)}),e.modelUrl!==void 0&&i.push({key:"modelUrl",value:encodeURIComponent(e.modelUrl)}),e.nearCameraFade!==void 0&&i.push({key:"nearCameraFade",value:e.nearCameraFade.map(a=>a.toFixed(1).toString()).join(",")}),e.tileServer!==void 0&&e.tileServer&&i.push({key:"tileServer",value:encodeURIComponent(e.tileServer)}),e.modelsTilesUrl!==void 0&&i.push({key:"modelsTilesUrl",value:encodeURIComponent(e.modelsTilesUrl)}),e.defaultSourceModelsRootUrl!==void 0&&i.push({key:"defaultSourceModelsRootUrl",value:encodeURIComponent(e.defaultSourceModelsRootUrl)}),e.tileProtocol!==void 0&&i.push({key:"tileProtocol",value:e.tileProtocol}),e.tileSet!==void 0&&i.push({key:"tileSet",value:e.tileSet}),e.commercialPoiRandomSeed!==void 0&&i.push({key:"comPoiSeed",value:e.commercialPoiRandomSeed.toString()}),e.dem&&i.push({key:"dem"}),e.demTileSet&&i.push({key:"demTileSet",value:e.demTileSet}),e.demReliefTileType&&i.push({key:"demReliefTileType",value:e.demReliefTileType}),e.demElevationSourceType&&i.push({key:"demElevationSourceType",value:e.demElevationSourceType}),e.enableFog===!1&&i.push({key:"fog"}),e.cesiumTiles&&i.push({key:"cesiumTiles"}),e.globe&&i.push({key:"globe"}),e.rampPreset&&i.push({key:"rampPreset",value:e.rampPreset}),e.shading&&i.push({key:"shading",value:String(e.shading)}),e.reliefScale&&i.push({key:"reliefScale",value:String(e.reliefScale)}),e.satellite&&i.push({key:"satellite"}),e.lang!==void 0&&i.push({key:"lang",value:e.lang}),e.tileServerDefaultLang!==void 0&&i.push({key:"defaultLang",value:e.tileServerDefaultLang}),e.defaultBackgroundColor!==void 0&&i.push({key:"defaultBackgroundColor",value:e.defaultBackgroundColor.replace("#","")}),e.trafficProtocol!==void 0&&i.push({key:"trafficProtocol",value:e.trafficProtocol}),e.trafficServer!==void 0&&i.push({key:"trafficServer",value:e.trafficServer}),e.mobileSdkMode&&i.push({key:"mobileSdkMode"}),e.commercialTileSet!==void 0&&i.push({key:"commercialTileSet",value:e.commercialTileSet}),e.modelsTileSet!==void 0&&i.push({key:"modelsTileSet",value:e.modelsTileSet}),e.modelLayer!==void 0&&i.push({key:"modelLayer",value:e.modelLayer}),e.maxPitch!==void 0&&i.push({key:"maxPitch",value:e.maxPitch.toFixed(0)}),e.lowZoomMaxPitch&&i.push({key:"lowZoomMaxPitch",value:e.lowZoomMaxPitch.toString()}),e.showDefaultTileBounds&&i.push({key:"showDefaultTileBounds"}),e.webglVersion!==void 0&&i.push({key:"webglVersion",value:String(e.webglVersion)}),e.debugWideRoads&&i.push({key:"debugWideRoads"}),e.immersiveRoads&&i.push({key:"immersiveRoads"}),e.immersiveOn&&i.push({key:"immersiveOn"}),e.loopWorld!==void 0&&i.push({key:"loopWorld",value:String(e.loopWorld)}),(s=t.getStyleState())!=null&&s.trafficOn&&i.push({key:"traffic"}),e.graphicsPreset&&i.push({key:"graphicsPreset",value:e.graphicsPreset}),["trafficMinZoom","trafficMaxZoom","trafficMaxDetailLevel"].forEach(a=>{e[a]!==void 0&&i.push({key:a,value:String(e[a])})}),e.useFlatDemIrregularMeshNormals&&i.push({key:"useFlatDemIrregularMeshNormals"}),e.disableModelsGrowthAnimation&&i.push({key:"disableModelsGrowthAnimation"}),t.getStyleState()._floorStackOn&&i.push({key:"floorStack"}),i}function nx(t){const e=c0();if(e.lng!==void 0&&e.lat!==void 0&&(t.center=[parseFloat(e.lng),parseFloat(e.lat)]),e.zoom!==void 0&&(t.zoom=parseFloat(e.zoom)),e.styleZoom!==void 0&&(t.styleZoom=parseFloat(e.styleZoom)),e.rotation!==void 0&&(t.rotation=parseFloat(e.rotation)),e.touchRotationThreshold!==void 0&&(t.touchRotationThreshold=parseFloat(e.touchRotationThreshold)),e.key!==void 0&&(t.key=e.key),e.pitch!==void 0&&(t.pitch=parseFloat(e.pitch)),e.styleId!==void 0&&(t.style=e.styleId),e.dracoDecoderUrl!==void 0&&(t.dracoDecoderUrl=decodeURIComponent(e.dracoDecoderUrl)),e.keyUrl!==void 0&&(t.keyUrl=decodeURIComponent(e.keyUrl)),e.styleServer!==void 0&&(t.styleServer=decodeURIComponent(e.styleServer)),e.fontUrl!==void 0&&(t.fontUrl=decodeURIComponent(e.fontUrl)),e.iconUrl!==void 0&&(t.iconUrl=decodeURIComponent(e.iconUrl)),e.modelUrl!==void 0&&(t.modelUrl=decodeURIComponent(e.modelUrl)),e.tileServer!==void 0&&(t.tileServer=decodeURIComponent(e.tileServer)),e.modelsTilesUrl!==void 0&&(t.modelsTilesUrl=decodeURIComponent(e.modelsTilesUrl)),e.defaultSourceModelsRootUrl!==void 0&&(t.defaultSourceModelsRootUrl=decodeURIComponent(e.defaultSourceModelsRootUrl)),"westeros"in e&&(t.westeros=!0),e.tileProtocol!==void 0&&(t.tileProtocol=e.tileProtocol),e.tileSet!==void 0&&(t.tileSet=e.tileSet),e.modelsTileSet!==void 0&&(t.modelsTileSet=e.modelsTileSet),"comPoiSeed"in e&&!Number.isNaN(parseFloat(e.comPoiSeed??""))&&(t.commercialPoiRandomSeed=Number(e.comPoiSeed)),"reliefScale"in e&&(t.reliefScale=Number(e.reliefScale)),"mobileSdkMode"in e&&(t.mobileSdkMode=!0),e.nearCameraFade!==void 0&&(t.nearCameraFade=e.nearCameraFade.split(",").map(Number)),t.rampPreset=e.rampPreset,t.shading=Number(e.shading),e.commercialTileSet!==void 0&&(t.commercialTileSet=e.commercialTileSet),e.defaultBackgroundColor!==void 0&&(t.defaultBackgroundColor="#"+e.defaultBackgroundColor),e.trafficProtocol!==void 0&&(t.trafficProtocol=e.trafficProtocol),e.trafficServer!==void 0&&(t.trafficServer=e.trafficServer),e.lang!==void 0&&(t.lang=e.lang),e.defaultLang!==void 0&&(t.tileServerDefaultLang=e.defaultLang),"disableRotation"in e&&(t.disableRotationByUserInteraction=!0),"disablePitch"in e&&(t.disablePitchByUserInteraction=!0),"disableDragging"in e&&(t.disableDragging=!0),"enableTwoFingerDragging"in e&&(t.enableTwoFingerDragging=!0),"keepCenterWhileUserZoomRotate"in e&&(t.keepCenterWhileUserZoomRotate=!0),"styleServer"in e&&(t.styleServer=decodeURIComponent(e.styleServer??"")),"preserveDrawingBuffer"in e&&(t.preserveDrawingBuffer=!0),"maxPitch"in e&&(t.maxPitch=Number(e.maxPitch)),"lowZoomMaxPitch"in e&&(t.lowZoomMaxPitch=Number(e.lowZoomMaxPitch)),"webglVersion"in e){const i=Number(e.webglVersion);(i===1||i===2)&&(t.webglVersion=i)}if("modelLayer"in e&&(t.modelLayer=e.modelLayer),"showDefaultTileBounds"in e&&(t.showDefaultTileBounds=!0),"enableHover"in e&&(t.disableHoverStyles=!1),"disableIconCache"in e&&(t.disableIconCache=!0),"demTileSet"in e&&(t.demTileSet=e.demTileSet),"demReliefTileType"in e&&(t.demReliefTileType=e.demReliefTileType),"demElevationSourceType"in e&&(t.demElevationSourceType=e.demElevationSourceType),"graphicsPreset"in e&&(t.graphicsPreset=e.graphicsPreset),"disableModelsGrowthAnimation"in e&&(t.disableModelsGrowthAnimation=!0),t.useFlatDemIrregularMeshNormals="useFlatDemIrregularMeshNormals"in e,t.mobileSdkMode="mobileSdkMode"in e,t.dem="dem"in e,t.cesiumTiles="cesiumTiles"in e,t.globe="globe"in e,t.styleState={},t.globe&&(t.styleState.globeEnabled=!0),"floorStack"in e&&(t.styleState._floorStackOn=!0),t.satellite="satellite"in e,t.rampPreset=e.rampPreset,t.shading=Number(e.shading),"enableTrackResize"in e&&(t.enableTrackResize=!!e.enableTrackResize),t.debugWideRoads="debugWideRoads"in e,t.immersiveRoads="immersiveRoads"in e,t.immersiveOn="immersiveOn"in e,"loopWorld"in e&&(t.loopWorld=e.loopWorld==="true"),t.traffic="traffic"in e,["trafficMinZoom","trafficMaxZoom","trafficMaxDetailLevel"].forEach(i=>{i in e&&(t[i]=Number(e[i]))}),e.m!==void 0){const i=decodeURIComponent(e.m).split("/"),o=i[0].split(",");t.center=[parseFloat(o[0]),parseFloat(o[1])],t.zoom=parseFloat(i[1]);for(let r=2;r<=4;r+=2){const s=i[r];if(s!==void 0){const a=parseFloat(i[r+1]);s==="p"?t.pitch=a:s==="r"&&(t.rotation=a)}}}return t}function Vt(t,e){history.replaceState({},document.title,bn(t,e))}function ix(t){return new Promise(e=>setTimeout(e,t))}const yi=256,et=2**32,bt=et/2,Ha=2**20,Se=2**15,vt=2**16-1,oo=Se/vt,Y=16383,$4=2.54,cl=96,d0=et/(yi/cl*$4),Bt=.7071067811865475,ox=1175494351e-47,rx=3402823466e29,ff=["Arial","Helvetica","HelveticaNeueCyr","Open_Sans","Open_Sans_Semibold","Open_Sans_Italic","Segoe_UI","PT_Sans_Caption","PT_Sans","Verdana","Verdana_bold","Noto_Sans","Noto_Sans_Semibold","Noto_Sans_Italic","SuisseIntl_Bold"],Ss="Noto_Sans",sx=1,Ng=sx/2,W4=-4,hf=2147483647,$s="c080bb6a-8134-4993-93a1-5b4d8c36a59b",ax=5,Vc=4,u0=40,xm=65e3,f0="byModel",lx=65536,cx=512,dx="empty",ux=(t,e,n)=>{const i=e.addFolder("CustomStyles");function o(c,d){let u=!1;const f={};for(const h of Object.keys(c))c[h]===d?(f[h+" (from URL)"]=d,u=!0):f[h]=c[h];return!u&&d&&(f["from URL"]=d),f}function r(c,d){c==="default"?(t._impl.setStyle($s,d),n.style=void 0):(t._impl.setStyle(c,d),n.style=c),Vt(t,n)}const s=o({Default:"default","2GIS Day":"c080bb6a-8134-4993-93a1-5b4d8c36a59b","2GIS Night":"e05ac437-fcc2-4845-ad74-b1de9ce07555","2GIS Grayscale":"b2b8046f-9bb0-469a-9860-9847032935cc","2GIS Snow":"1db52c6e-66b6-4c99-9c83-5538fa962d43","2GIS 2009":"9e75a94c-36f7-4254-8101-90139ead38ad","Online Day":"eb10e2c3-3c28-4b81-b74b-859c9c4cf47e","Online Clock":"9d5d7474-05e5-4354-9f71-61a0005ec957","Test Clock":"26f514b8-7bd8-41e7-ad8d-da59b859073c"},n.style),a=o({production:"https://styles.api.2gis.com/styles/{id}",staging:"https://gosharubchinskii.web-staging.2gis.ru/styles/{id}"},n.styleServer),l={style:n.style||"default",styleServer:n.styleServer||a.production};i.add(l,"style",s).onChange(()=>{r(l.style,{stylePath:l.styleServer})}),i.add(l,"styleServer",a).onChange(c=>{r(l.style,{stylePath:c,iconsPath:"https://disk.2gis.com/styles-staging/"})})},fx=(t,e)=>{const n=e.addFolder("lngLatBounds"),i={showBounds:a,extendBounds:l,clearMap:o};n.add(i,"showBounds"),n.add(i,"extendBounds"),n.add(i,"clearMap");function o(){r&&(r.destroy(),r=void 0)}let r;const s={northEast:[83.1381307,55.0313278],southWest:[82.8250339,54.9416712]};function a(){o();const c=new mapgl.LngLatBoundsClass({northEast:[...s.northEast],southWest:[...s.southWest]});r=new mapgl.Polygon(t,{coordinates:[[[c.southWest[0],c.northEast[1]],[c.southWest[0],c.southWest[1]],[c.northEast[0],c.southWest[1]],[c.northEast[0],c.northEast[1]],[c.southWest[0],c.northEast[1]]]]}),t.fitBounds(c,{padding:{top:100,right:100,bottom:100,left:100},considerRotation:!0})}function l(){o();const c=new mapgl.LngLatBoundsClass({northEast:[...s.northEast],southWest:[...s.southWest]});c.extend([83.2381307,55.2313278]),c.extend([81.8050339,54.8416712]),r=new mapgl.Polygon(t,{coordinates:[[[c.southWest[0],c.northEast[1]],[c.southWest[0],c.southWest[1]],[c.northEast[0],c.southWest[1]],[c.northEast[0],c.northEast[1]],[c.southWest[0],c.northEast[1]]]]}),t.fitBounds(c,{padding:{top:100,right:100,bottom:100,left:100},considerRotation:!0})}},hx=(t,e)=>{let n=new Array;const i=t.getControlsLayoutPadding();function o(){t.setControlsLayoutPadding({});const l=t.getControlsLayoutPadding();Object.keys(l).forEach(c=>i[c]=l[c]),e.updateDisplay()}function r(){t.setControlsLayoutPadding(i)}const s={"add controls":()=>{n.length||(o(),i.left=e.domElement.clientWidth+30,e.updateDisplay(),r(),n=new Array("topLeft","topCenter","topRight","centerLeft","centerRight","bottomLeft","bottomCenter","bottomRight").map(l=>{const c=`
                        <button style="border: 3px solid red;">
                            ${l}
                        </button>
                    `;return new mapgl.Control(t,c,{position:l})}))},"remove controls":()=>{var l;for(;n.length;)(l=n.pop())==null||l.destroy()},"set default":o},a=e.addFolder("Controls Layout Padding");a.add(s,"add controls"),a.add(s,"remove controls"),a.add(s,"set default"),a.add(i,"top",0,t.getSize()[1]).onChange(r),a.add(i,"bottom",0,t.getSize()[1]).onChange(r),a.add(i,"right",0,t.getSize()[0]).onChange(r),a.add(i,"left",0,t.getSize()[0]).onChange(r),o()},_i=1e-6;let xi=typeof Float64Array<"u"?Float64Array:Array;function Et(){let t=new xi(2);return t[0]=0,t[1]=0,t}function _x(t){let e=new xi(2);return e[0]=t[0],e[1]=t[1],e}function Sm(t,e){let n=new xi(2);return n[0]=t,n[1]=e,n}function h0(t,e){return t[0]=e[0],t[1]=e[1],t}function Yt(t,e,n){return t[0]=e,t[1]=n,t}function Qi(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t}function mx(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t}function px(t,e,n){return t[0]=Math.min(e[0],n[0]),t[1]=Math.min(e[1],n[1]),t}function gx(t,e,n){return t[0]=Math.max(e[0],n[0]),t[1]=Math.max(e[1],n[1]),t}function Gn(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t}function eo(t,e){var n=e[0]-t[0],i=e[1]-t[1];return Math.sqrt(n*n+i*i)}function _0(t){var e=t[0],n=t[1];return Math.sqrt(e*e+n*n)}function vx(t){var e=t[0],n=t[1];return e*e+n*n}function Uo(t,e){var n=e[0],i=e[1],o=n*n+i*i;return o>0&&(o=1/Math.sqrt(o),t[0]=e[0]*o,t[1]=e[1]*o),t}function Ls(t,e){return t[0]*e[0]+t[1]*e[1]}function Z4(t,e,n,i){var o=e[0],r=e[1];return t[0]=o+i*(n[0]-o),t[1]=r+i*(n[1]-r),t}function Mm(t,e){return t[0]===e[0]&&t[1]===e[1]}function yx(t,e){let n=t[0],i=t[1],o=e[0],r=e[1];return Math.abs(n-o)<=_i*Math.max(1,Math.abs(n),Math.abs(o))&&Math.abs(i-r)<=_i*Math.max(1,Math.abs(i),Math.abs(r))}const X4=_0,ti=mx,Ur=eo;(function(){let t=Et();return function(e,n,i,o,r,s){let a,l;for(n||(n=2),i||(i=0),o?l=Math.min(o*n+i,e.length):l=e.length,a=i;a<l;a+=n)t[0]=e[a],t[1]=e[a+1],r(t,t,s),e[a]=t[0],e[a+1]=t[1];return e}})();function Ke(){let t=new xi(3);return t[0]=0,t[1]=0,t[2]=0,t}function Fa(t){var e=new xi(3);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}function Gr(t){let e=t[0],n=t[1],i=t[2];return Math.sqrt(e*e+n*n+i*i)}function yt(t,e,n){let i=new xi(3);return i[0]=t,i[1]=e,i[2]=n,i}function Sa(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function St(t,e,n,i){return t[0]=e,t[1]=n,t[2]=i,t}function jt(t,e,n){return t[0]=e[0]+n[0],t[1]=e[1]+n[1],t[2]=e[2]+n[2],t}function bx(t,e,n){return t[0]=e[0]-n[0],t[1]=e[1]-n[1],t[2]=e[2]-n[2],t}function ni(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t}function Y4(t,e){let n=e[0]-t[0],i=e[1]-t[1],o=e[2]-t[2];return Math.sqrt(n*n+i*i+o*o)}function wx(t,e){let n=e[0]-t[0],i=e[1]-t[1],o=e[2]-t[2];return n*n+i*i+o*o}function xx(t){let e=t[0],n=t[1],i=t[2];return e*e+n*n+i*i}function q4(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t}function _n(t,e){let n=e[0],i=e[1],o=e[2],r=n*n+i*i+o*o;return r>0&&(r=1/Math.sqrt(r),t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r),t}function Fs(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function ka(t,e,n){let i=e[0],o=e[1],r=e[2],s=n[0],a=n[1],l=n[2];return t[0]=o*l-r*a,t[1]=r*s-i*l,t[2]=i*a-o*s,t}function Nn(t,e,n,i){let o=e[0],r=e[1],s=e[2];return t[0]=o+i*(n[0]-o),t[1]=r+i*(n[1]-r),t[2]=s+i*(n[2]-s),t}function ii(t,e,n){let i=e[0],o=e[1],r=e[2],s=n[3]*i+n[7]*o+n[11]*r+n[15];return s=s||1,t[0]=(n[0]*i+n[4]*o+n[8]*r+n[12])/s,t[1]=(n[1]*i+n[5]*o+n[9]*r+n[13])/s,t[2]=(n[2]*i+n[6]*o+n[10]*r+n[14])/s,t}function Sx(t,e,n){let i=e[0],o=e[1],r=e[2],s=n[0],a=n[1],l=n[2],c=n[3],d=c*i+a*r-l*o,u=c*o+l*i-s*r,f=c*r+s*o-a*i,h=-s*i-a*o-l*r;return t[0]=d*c+h*-s+u*-l-f*-a,t[1]=u*c+h*-a+f*-s-d*-l,t[2]=f*c+h*-l+d*-a-u*-s,t}function Mx(t,e,n,i){let o=[],r=[];return o[0]=e[0]-n[0],o[1]=e[1]-n[1],o[2]=e[2]-n[2],r[0]=o[0],r[1]=o[1]*Math.cos(i)-o[2]*Math.sin(i),r[2]=o[1]*Math.sin(i)+o[2]*Math.cos(i),t[0]=r[0]+n[0],t[1]=r[1]+n[1],t[2]=r[2]+n[2],t}function _a(t,e,n,i){let o=[],r=[];return o[0]=e[0]-n[0],o[1]=e[1]-n[1],o[2]=e[2]-n[2],r[0]=o[2]*Math.sin(i)+o[0]*Math.cos(i),r[1]=o[1],r[2]=o[2]*Math.cos(i)-o[0]*Math.sin(i),t[0]=r[0]+n[0],t[1]=r[1]+n[1],t[2]=r[2]+n[2],t}function ma(t,e,n,i){let o=[],r=[];return o[0]=e[0]-n[0],o[1]=e[1]-n[1],o[2]=e[2]-n[2],r[0]=o[0]*Math.cos(i)-o[1]*Math.sin(i),r[1]=o[0]*Math.sin(i)+o[1]*Math.cos(i),r[2]=o[2],t[0]=r[0]+n[0],t[1]=r[1]+n[1],t[2]=r[2]+n[2],t}function Ug(t,e){let n=yt(t[0],t[1],t[2]),i=yt(e[0],e[1],e[2]);_n(n,n),_n(i,i);let o=Fs(n,i);return o>1?0:o<-1?Math.PI:Math.acos(o)}function Tx(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]}function Ix(t,e){let n=t[0],i=t[1],o=t[2],r=e[0],s=e[1],a=e[2];return Math.abs(n-r)<=_i*Math.max(1,Math.abs(n),Math.abs(r))&&Math.abs(i-s)<=_i*Math.max(1,Math.abs(i),Math.abs(s))&&Math.abs(o-a)<=_i*Math.max(1,Math.abs(o),Math.abs(a))}const $t=bx,Qf=Y4,Ex=wx,mr=Gr;(function(){let t=Ke();return function(e,n,i,o,r,s){let a,l;for(n||(n=3),i||(i=0),o?l=Math.min(o*n+i,e.length):l=e.length,a=i;a<l;a+=n)t[0]=e[a],t[1]=e[a+1],t[2]=e[a+2],r(t,t,s),e[a]=t[0],e[a+1]=t[1],e[a+2]=t[2];return e}})();function K4(){let t=new xi(9);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t}function Ax(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10],t}function jc(){let t=new xi(4);return t[0]=0,t[1]=0,t[2]=0,t[3]=0,t}function Cx(t,e,n,i){let o=new xi(4);return o[0]=t,o[1]=e,o[2]=n,o[3]=i,o}function eh(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}function Px(t,e,n,i,o){return t[0]=e,t[1]=n,t[2]=i,t[3]=o,t}function Lx(t,e,n){return t[0]=e[0]*n[0],t[1]=e[1]*n[1],t[2]=e[2]*n[2],t[3]=e[3]*n[3],t}function jr(t,e,n){return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t}function Fx(t,e){let n=e[0],i=e[1],o=e[2],r=e[3],s=n*n+i*i+o*o+r*r;return s>0&&(s=1/Math.sqrt(s),t[0]=n*s,t[1]=i*s,t[2]=o*s,t[3]=r*s),t}function kx(t,e,n,i){let o=e[0],r=e[1],s=e[2],a=e[3];return t[0]=o+i*(n[0]-o),t[1]=r+i*(n[1]-r),t[2]=s+i*(n[2]-s),t[3]=a+i*(n[3]-a),t}function Va(t,e,n){let i=e[0],o=e[1],r=e[2],s=e[3];return t[0]=n[0]*i+n[4]*o+n[8]*r+n[12]*s,t[1]=n[1]*i+n[5]*o+n[9]*r+n[13]*s,t[2]=n[2]*i+n[6]*o+n[10]*r+n[14]*s,t[3]=n[3]*i+n[7]*o+n[11]*r+n[15]*s,t}function m0(t,e){let n=t[0],i=t[1],o=t[2],r=t[3],s=e[0],a=e[1],l=e[2],c=e[3];return Math.abs(n-s)<=_i*Math.max(1,Math.abs(n),Math.abs(s))&&Math.abs(i-a)<=_i*Math.max(1,Math.abs(i),Math.abs(a))&&Math.abs(o-l)<=_i*Math.max(1,Math.abs(o),Math.abs(l))&&Math.abs(r-c)<=_i*Math.max(1,Math.abs(r),Math.abs(c))}const Rx=Lx;(function(){let t=jc();return function(e,n,i,o,r,s){let a,l;for(n||(n=4),i||(i=0),o?l=Math.min(o*n+i,e.length):l=e.length,a=i;a<l;a+=n)t[0]=e[a],t[1]=e[a+1],t[2]=e[a+2],t[3]=e[a+3],r(t,t,s),e[a]=t[0],e[a+1]=t[1],e[a+2]=t[2],e[a+3]=t[3];return e}})();function Tm(){let t=new xi(4);return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t}function zx(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t}function Bx(t,e,n){n=n*.5;let i=Math.sin(n);return t[0]=i*e[0],t[1]=i*e[1],t[2]=i*e[2],t[3]=Math.cos(n),t}function Ox(t,e,n){n*=.5;let i=e[0],o=e[1],r=e[2],s=e[3],a=Math.sin(n),l=Math.cos(n);return t[0]=i*l-r*a,t[1]=o*l+s*a,t[2]=r*l+i*a,t[3]=s*l-o*a,t}function Dx(t,e,n){n*=.5;let i=e[0],o=e[1],r=e[2],s=e[3],a=Math.sin(n),l=Math.cos(n);return t[0]=i*l+o*a,t[1]=o*l-i*a,t[2]=r*l+s*a,t[3]=s*l-r*a,t}function Mh(t,e,n,i){let o=e[0],r=e[1],s=e[2],a=e[3],l=n[0],c=n[1],d=n[2],u=n[3],f,h,_,p,m;return h=o*l+r*c+s*d+a*u,h<0&&(h=-h,l=-l,c=-c,d=-d,u=-u),1-h>1e-6?(f=Math.acos(h),_=Math.sin(f),p=Math.sin((1-i)*f)/_,m=Math.sin(i*f)/_):(p=1-i,m=i),t[0]=p*o+m*l,t[1]=p*r+m*c,t[2]=p*s+m*d,t[3]=p*a+m*u,t}function Nx(t,e){let n=e[0]+e[4]+e[8],i;if(n>0)i=Math.sqrt(n+1),t[3]=.5*i,i=.5/i,t[0]=(e[5]-e[7])*i,t[1]=(e[6]-e[2])*i,t[2]=(e[1]-e[3])*i;else{let o=0;e[4]>e[0]&&(o=1),e[8]>e[o*3+o]&&(o=2);let r=(o+1)%3,s=(o+2)%3;i=Math.sqrt(e[o*3+o]-e[r*3+r]-e[s*3+s]+1),t[o]=.5*i,i=.5/i,t[3]=(e[r*3+s]-e[s*3+r])*i,t[r]=(e[r*3+o]+e[o*3+r])*i,t[s]=(e[s*3+o]+e[o*3+s])*i}return t}const J4=Fx;(function(){let t=Ke(),e=yt(1,0,0),n=yt(0,1,0);return function(i,o,r){let s=Fs(o,r);return s<-.999999?(ka(t,e,o),mr(t)<1e-6&&ka(t,n,o),_n(t,t),Bx(i,t,Math.PI),i):s>.999999?(i[0]=0,i[1]=0,i[2]=0,i[3]=1,i):(ka(t,o,r),i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=1+s,J4(i,i))}})();(function(){let t=Tm(),e=Tm();return function(n,i,o,r,s,a){return Mh(t,i,s,a),Mh(e,o,r,a),Mh(n,t,e,2*a*(1-a)),n}})();(function(){let t=K4();return function(e,n,i,o){return t[0]=i[0],t[3]=i[1],t[6]=i[2],t[1]=o[0],t[4]=o[1],t[7]=o[2],t[2]=-n[0],t[5]=-n[1],t[8]=-n[2],J4(e,Nx(e,t))}})();function Ui(){let t=new xi(16);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function ja(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function Ux(t,e,n,i,o,r,s,a,l,c,d,u,f,h,_,p){let m=new xi(16);return m[0]=t,m[1]=e,m[2]=n,m[3]=i,m[4]=o,m[5]=r,m[6]=s,m[7]=a,m[8]=l,m[9]=c,m[10]=d,m[11]=u,m[12]=f,m[13]=h,m[14]=_,m[15]=p,m}function Gx(t,e,n,i,o,r,s,a,l,c,d,u,f,h,_,p,m){return t[0]=e,t[1]=n,t[2]=i,t[3]=o,t[4]=r,t[5]=s,t[6]=a,t[7]=l,t[8]=c,t[9]=d,t[10]=u,t[11]=f,t[12]=h,t[13]=_,t[14]=p,t[15]=m,t}function p0(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function Hx(t,e){if(t===e){let n=e[1],i=e[2],o=e[3],r=e[6],s=e[7],a=e[11];t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=n,t[6]=e[9],t[7]=e[13],t[8]=i,t[9]=r,t[11]=e[14],t[12]=o,t[13]=s,t[14]=a}else t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15];return t}function Go(t,e){let n=e[0],i=e[1],o=e[2],r=e[3],s=e[4],a=e[5],l=e[6],c=e[7],d=e[8],u=e[9],f=e[10],h=e[11],_=e[12],p=e[13],m=e[14],g=e[15],y=n*a-i*s,b=n*l-o*s,v=n*c-r*s,T=i*l-o*a,x=i*c-r*a,I=o*c-r*l,E=d*p-u*_,L=d*m-f*_,N=d*g-h*_,k=u*m-f*p,w=u*g-h*p,S=f*g-h*m,A=y*S-b*w+v*k+T*N-x*L+I*E;return A?(A=1/A,t[0]=(a*S-l*w+c*k)*A,t[1]=(o*w-i*S-r*k)*A,t[2]=(p*I-m*x+g*T)*A,t[3]=(f*x-u*I-h*T)*A,t[4]=(l*N-s*S-c*L)*A,t[5]=(n*S-o*N+r*L)*A,t[6]=(m*v-_*I-g*b)*A,t[7]=(d*I-f*v+h*b)*A,t[8]=(s*w-a*N+c*E)*A,t[9]=(i*N-n*w-r*E)*A,t[10]=(_*x-p*v+g*y)*A,t[11]=(u*v-d*x-h*y)*A,t[12]=(a*L-s*k-l*E)*A,t[13]=(n*k-i*L+o*E)*A,t[14]=(p*b-_*T-m*y)*A,t[15]=(d*T-u*b+f*y)*A,t):null}function Sn(t,e,n){let i=e[0],o=e[1],r=e[2],s=e[3],a=e[4],l=e[5],c=e[6],d=e[7],u=e[8],f=e[9],h=e[10],_=e[11],p=e[12],m=e[13],g=e[14],y=e[15],b=n[0],v=n[1],T=n[2],x=n[3];return t[0]=b*i+v*a+T*u+x*p,t[1]=b*o+v*l+T*f+x*m,t[2]=b*r+v*c+T*h+x*g,t[3]=b*s+v*d+T*_+x*y,b=n[4],v=n[5],T=n[6],x=n[7],t[4]=b*i+v*a+T*u+x*p,t[5]=b*o+v*l+T*f+x*m,t[6]=b*r+v*c+T*h+x*g,t[7]=b*s+v*d+T*_+x*y,b=n[8],v=n[9],T=n[10],x=n[11],t[8]=b*i+v*a+T*u+x*p,t[9]=b*o+v*l+T*f+x*m,t[10]=b*r+v*c+T*h+x*g,t[11]=b*s+v*d+T*_+x*y,b=n[12],v=n[13],T=n[14],x=n[15],t[12]=b*i+v*a+T*u+x*p,t[13]=b*o+v*l+T*f+x*m,t[14]=b*r+v*c+T*h+x*g,t[15]=b*s+v*d+T*_+x*y,t}function Q4(t,e,n){let i=n[0],o=n[1],r=n[2],s,a,l,c,d,u,f,h,_,p,m,g;return e===t?(t[12]=e[0]*i+e[4]*o+e[8]*r+e[12],t[13]=e[1]*i+e[5]*o+e[9]*r+e[13],t[14]=e[2]*i+e[6]*o+e[10]*r+e[14],t[15]=e[3]*i+e[7]*o+e[11]*r+e[15]):(s=e[0],a=e[1],l=e[2],c=e[3],d=e[4],u=e[5],f=e[6],h=e[7],_=e[8],p=e[9],m=e[10],g=e[11],t[0]=s,t[1]=a,t[2]=l,t[3]=c,t[4]=d,t[5]=u,t[6]=f,t[7]=h,t[8]=_,t[9]=p,t[10]=m,t[11]=g,t[12]=s*i+d*o+_*r+e[12],t[13]=a*i+u*o+p*r+e[13],t[14]=l*i+f*o+m*r+e[14],t[15]=c*i+h*o+g*r+e[15]),t}function Mc(t,e,n){let i=n[0],o=n[1],r=n[2];return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t[3]=e[3]*i,t[4]=e[4]*o,t[5]=e[5]*o,t[6]=e[6]*o,t[7]=e[7]*o,t[8]=e[8]*r,t[9]=e[9]*r,t[10]=e[10]*r,t[11]=e[11]*r,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function Im(t,e,n){let i=Math.sin(n),o=Math.cos(n),r=e[4],s=e[5],a=e[6],l=e[7],c=e[8],d=e[9],u=e[10],f=e[11];return e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=r*o+c*i,t[5]=s*o+d*i,t[6]=a*o+u*i,t[7]=l*o+f*i,t[8]=c*o-r*i,t[9]=d*o-s*i,t[10]=u*o-a*i,t[11]=f*o-l*i,t}function e3(t,e,n){let i=Math.sin(n),o=Math.cos(n),r=e[0],s=e[1],a=e[2],l=e[3],c=e[8],d=e[9],u=e[10],f=e[11];return e!==t&&(t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=r*o-c*i,t[1]=s*o-d*i,t[2]=a*o-u*i,t[3]=l*o-f*i,t[8]=r*i+c*o,t[9]=s*i+d*o,t[10]=a*i+u*o,t[11]=l*i+f*o,t}function t3(t,e,n){let i=Math.sin(n),o=Math.cos(n),r=e[0],s=e[1],a=e[2],l=e[3],c=e[4],d=e[5],u=e[6],f=e[7];return e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=r*o+c*i,t[1]=s*o+d*i,t[2]=a*o+u*i,t[3]=l*o+f*i,t[4]=c*o-r*i,t[5]=d*o-s*i,t[6]=u*o-a*i,t[7]=f*o-l*i,t}function $u(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=e[1],t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=e[2],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function Gg(t,e,n){let i=n[0],o=n[1],r=n[2],s=Math.sqrt(i*i+o*o+r*r),a,l,c;return Math.abs(s)<_i?null:(s=1/s,i*=s,o*=s,r*=s,a=Math.sin(e),l=Math.cos(e),c=1-l,t[0]=i*i*c+l,t[1]=o*i*c+r*a,t[2]=r*i*c-o*a,t[3]=0,t[4]=i*o*c-r*a,t[5]=o*o*c+l,t[6]=r*o*c+i*a,t[7]=0,t[8]=i*r*c+o*a,t[9]=o*r*c-i*a,t[10]=r*r*c+l,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t)}function Vx(t,e,n,i){let o=e[0],r=e[1],s=e[2],a=e[3],l=o+o,c=r+r,d=s+s,u=o*l,f=o*c,h=o*d,_=r*c,p=r*d,m=s*d,g=a*l,y=a*c,b=a*d,v=i[0],T=i[1],x=i[2];return t[0]=(1-(_+m))*v,t[1]=(f+b)*v,t[2]=(h-y)*v,t[3]=0,t[4]=(f-b)*T,t[5]=(1-(u+m))*T,t[6]=(p+g)*T,t[7]=0,t[8]=(h+y)*x,t[9]=(p-g)*x,t[10]=(1-(u+_))*x,t[11]=0,t[12]=n[0],t[13]=n[1],t[14]=n[2],t[15]=1,t}function n3(t,e,n,i,o,r,s){let a=1/(e-n),l=1/(i-o),c=1/(r-s);return t[0]=-2*a,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*l,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*c,t[11]=0,t[12]=(e+n)*a,t[13]=(o+i)*l,t[14]=(s+r)*c,t[15]=1,t}function Tc(t,e,n,i){let o,r,s,a,l,c,d,u,f,h,_=e[0],p=e[1],m=e[2],g=i[0],y=i[1],b=i[2],v=n[0],T=n[1],x=n[2];return Math.abs(_-v)<_i&&Math.abs(p-T)<_i&&Math.abs(m-x)<_i?mat4.identity(t):(d=_-v,u=p-T,f=m-x,h=1/Math.sqrt(d*d+u*u+f*f),d*=h,u*=h,f*=h,o=y*f-b*u,r=b*d-g*f,s=g*u-y*d,h=Math.sqrt(o*o+r*r+s*s),h?(h=1/h,o*=h,r*=h,s*=h):(o=0,r=0,s=0),a=u*s-f*r,l=f*o-d*s,c=d*r-u*o,h=Math.sqrt(a*a+l*l+c*c),h?(h=1/h,a*=h,l*=h,c*=h):(a=0,l=0,c=0),t[0]=o,t[1]=a,t[2]=d,t[3]=0,t[4]=r,t[5]=l,t[6]=u,t[7]=0,t[8]=s,t[9]=c,t[10]=f,t[11]=0,t[12]=-(o*_+r*p+s*m),t[13]=-(a*_+l*p+c*m),t[14]=-(d*_+u*p+f*m),t[15]=1,t)}function Hg(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]&&t[9]===e[9]&&t[10]===e[10]&&t[11]===e[11]&&t[12]===e[12]&&t[13]===e[13]&&t[14]===e[14]&&t[15]===e[15]}const Hr=Sn;function ro(t,e,n){return t[0]=n[0],t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=n[1],t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=n[2],t[11]=0,t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=1,t}const os=jc();class q{constructor(e,n){this.state=e,this.camera=n,this.position=[0,0,0]}static fromGeo(e,n=[0,0]){const i=et/2,o=Math.sin(Be(e[1])),r=e[0]*et/360,s=Math.log((1+o)/(1-o))*et/(4*Math.PI);let a=0;if(e.length>2){const l=q.scaleFactor(e[1]);a=(e[2]??0)*He*l}return n[0]=r,n[1]=Ve(s,-2147483648,i),n[2]=a,n}static toGeo(e,n=[0,0]){n[0]=e[0]*360/et;const i=-2*Math.PI/et;if(n[1]=90-2*Xa(Math.atan(Math.exp(e[1]*i))),e[2]){const o=q.scaleFactor(n[1]);n[2]=e[2]/He/o}return n}static scaleFactor(e){return 1/Math.cos(Be(e))}update(){const{center:e,rotation:n,zoom:i,pitch:o,size:r}=this.state,s=ks(i,r),a=Math.max(s*Math.sin(o),1);this.position[0]=e[0]+Math.sin(n)*a,this.position[1]=e[1]-Math.cos(n)*a,this.position[2]=s*Math.cos(o)}project(e,n=!1,i=[NaN,NaN]){const{size:o,viewport:r}=this.state;os[0]=e[0],os[1]=e[1],os[2]=e[2],os[3]=1,Va(os,os,this.camera.viewProjectionMatrix);const[s,a,l,c]=os,d=c*2;if(n&&(l>d||l<-d||s>d||s<-d||a>d||a<-d))return i;const f=o[0]/2,h=o[1]/2;return i[0]=f+r.left+s*f/c,i[1]=h+r.top-a*h/c,i}unproject(e,n=[0,0,0]){const{size:i,viewport:o}=this.state;n[0]=(e[0]-o.left)/i[0]*2-1,n[1]=-((Math.max(this.camera.horizonPixelOffset,e[1])-o.top)/i[1])*2+1,n[2]=0,ii(n,n,this.camera.viewProjectionMatrixInverse),n[0]-=this.position[0],n[1]-=this.position[1],n[2]-=this.position[2],_n(n,n);const r=-this.position[2]/n[2];return n[0]=this.position[0]+n[0]*r,n[1]=this.position[1]+n[1]*r,n[2]=this.position[2]+n[2]*r,n}setState(e){this.state=e}}const rs=jc();function Vg(t){return[t[2],t[0],t[1]]}class Rn{constructor(e,n){this.state=e,this.camera=n,this.position=[0,0,0],this.ivpMatrix=[],this.cachedVisibleArc=new Kg(()=>{const i=ks(this.state.zoom,this.state.size)/He;return Math.acos(_s/(_s+i))},()=>[this.state.zoom]),this.cachedPixelRadius=new Kg(()=>{const i=q.toGeo(this.state.center),o=pS(i,0,this.visibleArc),r=this.project(Rn.fromGeo(o));return r[0]-=this.state.viewport.left+this.state.size[0]/2+(this.state.padding.left-this.state.padding.right)/2,r[1]-=this.state.viewport.top+this.state.size[1]/2+(this.state.padding.top-this.state.padding.bottom)/2,X4(r)},()=>[this.state.zoom,this.state.cameraConfig.fov,this.state.size[0],this.state.size[1],this.state.padding.bottom,this.state.padding.top,this.state.padding.left,this.state.padding.right,this.camera.globeMatrix[0]]),this.update()}get visibleArc(){return this.cachedVisibleArc.value}get pixelRadius(){return this.cachedPixelRadius.value}static fromGeo(e,n=[NaN,NaN,NaN]){const i=Be(e[0]),o=Be(e[1]),r=Math.cos(i),s=Math.sin(i),a=Math.cos(o),l=Math.sin(o),c=_s*He;return n[0]=s*a*c,n[1]=l*c,n[2]=r*a*c,n}static toGeo(e,n=[NaN,NaN]){const i=e[0],o=e[1],r=e[2],s=Math.sqrt(i*i+o*o+r*r),a=Math.asin(r/s),l=Math.atan2(o,i);return n[0]=Xa(l),n[1]=Xa(a),n}update(){const{state:e}=this,n=q.toGeo(e.center),i=ks(e.zoom,e.size)+_s*He,o=Be(n[0]),r=Be(n[1]),s=Math.cos(o),a=Math.sin(o),l=Math.cos(r),c=Math.sin(r);this.position=[a*l*i,c*i,s*l*i];const d=[0,0,1];Tc(this.ivpMatrix,Vg(this.position),[0,0,0],d),Hr(this.ivpMatrix,this.camera.projectionMatrix,this.ivpMatrix),Go(this.ivpMatrix,this.ivpMatrix)}project(e,n=!1,i=[NaN,NaN]){const{size:o,viewport:r}=this.state,s=jc();rs[0]=e[0],rs[1]=e[1],rs[2]=e[2],rs[3]=1,Va(rs,rs,this.camera.globeMatrix),Va(s,rs,this.camera.viewProjectionMatrix);const[a,l,c,d]=s,u=d*2;if(n&&(c>u||c<-u||a>u||a<-u||l>u||l<-u))return i[0]=NaN,i[1]=NaN,i;const h=o[0]/2,_=o[1]/2;return i[0]=h+r.left+a*h/d,i[1]=_+r.top-l*_/d,i}unproject(e,n,i=[NaN,NaN,NaN]){const{size:o,viewport:r}=this.state,s=[(e[0]-r.left)/o[0]*2-1,-((Math.max(0,e[1])-r.top)/o[1])*2+1,0],a=Vg(this.position),l=[0,0,0,1];ii(l,s,this.ivpMatrix);const c=_n([],$t([],l,a)),d=q4([],a),u=Fs(d,c),f=xx(d)-u**2,h=(_s*He)**2;if(f>h){if(n)return Rn.fromGeo(q.toGeo(this.state.center));const{left:y,bottom:b,top:v,right:T}=this.state.padding,x=e[0]-r.left-o[0]/2-(y-T)/2,I=e[1]-r.top-o[1]/2-(v-b)/2,E=Gn([],Uo([],[x,I]),this.pixelRadius-1);return E[0]=E[0]+r.left+o[0]/2+(y-T)/2,E[1]=E[1]+r.top+o[1]/2+(v-b)/2,this.unproject(E,!0,i)}const _=Math.sqrt(h-f),p=u-_,m=u+_,g=Math.min(p,m);return i[0]=a[0]+c[0]*g,i[1]=a[1]+c[1]*g,i[2]=a[2]+c[2]*g,i}setState(e){this.state=e}canSee(e){const n=q.toGeo(this.state.center);return ih(n,e)<this.visibleArc}}function es(t,e){return{min:t||Sm(1/0,1/0),max:e||Sm(-1/0,-1/0)}}function jx(t){return es(q.fromGeo(t.southWest),q.fromGeo(t.northEast))}function kr(t,e){px(t.min,t.min,e),gx(t.max,t.max,e)}function jg(t,e){t.min[0]=e.min[0],t.max[0]=e.max[0],t.min[1]=e.min[1],t.max[1]=e.max[1]}function Em(t){t.min[0]=1/0,t.max[0]=-1/0,t.min[1]=1/0,t.max[1]=-1/0}function th(t,e){return t[0]=e.min[0]+(e.max[0]-e.min[0])/2,t[1]=e.min[1]+(e.max[1]-e.min[1])/2,t}function $a(t,e,n){t[0]=Ve(n[0],e.min[0],e.max[0]),t[1]=Ve(n[1],e.min[1],e.max[1])}function $x(t,e){return e[0]<=t.max[0]&&e[0]>=t.min[0]&&e[1]<=t.max[1]&&e[1]>=t.min[1]}function Wx(t,e){return e[1]<=t.max[1]&&e[1]>=t.min[1]}function g0(t,e,n=0){const i=t.min[0]+n<=e.max[0]-n&&e.min[0]+n<=t.max[0]-n,o=t.min[1]+n<=e.max[1]-n&&e.min[1]+n<=t.max[1]-n;return i&&o}function Zx(t,e){return{min:[Math.max(t.min[0],e.min[0]),Math.max(t.min[1],e.min[1])],max:[Math.min(t.max[0],e.max[0]),Math.min(t.max[1],e.max[1])]}}function i3(t,e){const n=th([],t),i=(t.max[0]-t.min[0])/2*e,o=(t.max[1]-t.min[1])/2*e;t.min[0]=n[0]-i,t.min[1]=n[1]-o,t.max[0]=n[0]+i,t.max[1]=n[1]+o}const Am={minZoom:2,maxZoom:20},qe={protocol:"https",server:G9,subdomains:"0123",tileSet:"vector_a",tileKey:dx,appId:"empty",cacheRatio:2,maxUniverseZoom:8,maxRegionalZoom:15,maxDetailLevel:17},hc={minZoom:10,maxZoom:14,tileSet:"com_poi_web",rasterSizes:[96,84,72,60,48,36,24]},pa={minZoom:15,maxZoom:15,tileSet:"vector_immersive"},Xx=100,o3=13.5,tn=[2048,2048],v0={tiles:"{protocol}://{host}/vt?r={request}&ts={tileSet}&key={tileKey}&appId={appId}&lang={lang}&default_lang={defaultLang}&s={sessionId}&dt={dt}",metatile:"{protocol}://{host}/metafiles/{hash}/metatile.json?ts={tileSet}",modelInfo:"{protocol}://{host}/metafiles/{regionId}/models.json?ts={tileSet}",model:"{protocol}://{host}/metafiles/{regionId}/{name}?ts={tileSet}",gltfModel:"{protocol}://{host}/metafiles/{modelSrc}?ts={tileSet}",convertData:"{protocol}://{host}/metafiles/{hash}/convert.json?ts={tileSet}",dynamicPoi:"{protocol}://{host}/metafiles/{regionId}/poi/{id}_{width}_{height}.png?ts={tileSet}",models:"{protocol}://{host}/v2/ald?ts={tileSet}&x={x}&y={y}&z={z}",commercialPoi:"{protocol}://{host}/v2/ald?ts={tileSet}&x={x}&y={y}&z={z}&lang={lang}",floorMeta:"{protocol}://{host}/metafiles/{regionId}/{floorComplexId}.json?ts={tileSet}"},ci={protocol:"https",host:H9,timestampUrl:"{protocol}://{host}/meta?reg={regions}&time&score",updateInterval:2*60*1e3,minZoom:10,maxZoom:16,maxDetailLevel:17,fetchMetaRetryDelays:[2,5,25].map(t=>t*1e3)},Gi={defaultUrl:H4,gamma:.08,baseSize:24},Yx={defaultUrl:U4},qx={url:V9},Lr={doubleClickTime:185,dragThreshold:2,pitchWaitingTime:200,pitchThreshold:7},Kx=1e3,_f={inAnimationTime:180,inAnimationType:"linear",outAnimationTime:800,outAnimationType:"linear"},$g={time:300,type:"linear"},Wa={duration:500,easing:"easeOutQuint"},nc={bounceType:"easeOutElastic",bounceTime:1200,growType:"easeInOutQuad",growTime:1200,iterationCount:1/0},zi={pixelDensity:.5,cacheDebounceTime:400,cacheThrottleTime:300,pickDistance:3},Rr={interval:220,animationTime:200,animationType:"linear",tileMultiplier:1.5,axisAngleToleranceDeg:45,axisCheckDistancePx:13,commercialMargins:{default:{topBottom:60,leftRight:60},city:{topBottom:500,leftRight:500}},lineLabelsHidePitchDeg:40,maxLabelLength:30};Rr.commercialMargins.city;const Jx={autoResizeInterval:50},Qx="en",Ri={macWheelDeltaToZoomDelta:.0018,notMacTrackpadDeltaToZoomDelta:.0018*3,wheelZoomDelta:.65,animDuration:400,throttleDelay:100,mouseRotateDelta:2.5,mousePitchDelta:2.5,mobilePinchDelta:1,mobileTapDelta:10},pr={duration:1300,maxSpeed:8,minSpeed:.02,nonLinearity:5},nn={fov:60*Math.PI/180,useDynamicNearFar:!1,near:1e3,far:2**34,viewportLimitRatio:2,minTrapezeHeight:2*131072,perspectiveDistanceLimitRatio:10,minFogDistance:2e4,pitchInterStartZoom:16.5,pitchInterEndZoom:19},$o={globeMaxZoom:8,globeInterStartZoom:7,globeInterEndZoom:16},eS=1e3,tS=16,Ma={enabled:!0,displayStyleZoom:18,detailLevel:17,viewportPadding:.2,maxStackHeight:40},nS={fpsCaveat:10},iS=3e4,r3=["Commercial_poi_city"],s3=["Commercial_poi_premium"],oS=["Commercial_poi_default","Commercial_poi_custom","Commercial_poi_navi",...r3,...s3],rS=["Commercial_model"],sS=["s_personal_poi"],aS=["Landmark_poi","Landmark_point"],lS=[105,84,63,42,21],cS=16,od={bias:100,textureSize:[2048,2048],shadowRadius:3},a3=6378137,y0=2*Math.PI*a3,He=et/y0,xl=ro([],[-1,-1,0],[2,2,1]),Wu=ro([],[.5,.5,0],[.5,.5,1]),_s=a3*(Math.PI/2),Vn=2**15/et;function Cm(t,e,n,i,o,r,s=0){o[0]=(n[0]+i[0])/2,o[1]=(n[1]+i[1])/2;const a=t.project(n),l=t.project(i),c=t.project(o),d=Ur(c,e),u=Ur(a,e),f=Ur(l,e);if(d<r)return o;if(u<r)return n;if(f<r)return i;if(s>=10)return o;const h=u+d,_=f+d;return h>_?Cm(t,e,i,o,o,r,s+1):Cm(t,e,n,o,o,r,s+1)}function b0(t){return Math.max(t,eS)}function ks(t,e){const n=nn,i=b0(e[1])/2,o=et/2**t,r=i/yi*o,s=Math.tan(n.fov/2);return r/s}function dS(t,e){const n=nn;return Math.log(b0(e[1])*et/(2*yi*Math.tan(n.fov/2)*t))/Math.LN2}function l3(t){return d0*Math.pow(2,-t)}function c3(t){const n=q.toGeo(t)[1],i=1/(2*Math.cos(Be(n)));return Math.log(i)/Math.log(2)}function d3(t,e){return 2**(Math.round(t)-e.coords[2])}function u3(t,e){const n=q.scaleFactor(e[1]);return 1+t*(n-1)}function Ws(t,e){const n=c3(e)*x0(9,10,t);return t+Ve(n,-1,0)}function nh(t,e){const n=c3(e),i=n*x0(9,10+n,t);return t-Ve(i,-1,0)}function Ms(t,e){return $4*(t/cl)/e}function Wg(t,e){return e*He*q.scaleFactor(t[1])}function mf(t,e){const i=Math.PI/180,o=t[1]*i,r=e[1]*i,s=Math.sin((e[1]-t[1])*i/2),a=Math.sin((e[0]-t[0])*i/2),l=s*s+Math.cos(o)*Math.cos(r)*a*a,c=2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l));return Math.round(6371e3*c)}const uS=es([-2147483648,-2147483648],[et/2,et/2]),fS=100,hS=es([-214748364800,-2147483648],[et*fS/2,et/2]);function Za(t){const n=bt;let i=t[0];if(i>=-2147483648&&i<=bt)return;const o=n- -2147483648;i=((i- -2147483648)%o+o)%o+-2147483648,t[0]=i}function w0(t,e){return t*Math.pow(2,-e)*et/yi}function f3(t,e){return t*Math.pow(2,e)*yi/et}function _S(t,e){return t===0?-1/0:-Math.log(e*yi/(t*et))/Math.LN2}Et();Et();function mS(t){const e=t[0],n=t[1];return Yg(e,-2147483648,bt)&&Yg(n,-2147483648,bt)}function $r(t){const e=[...t];return mS(e)||(e[0]=(et+(e[0]+bt)%et)%et-bt),e}function ih(t,e){const n=Math.cos(Be(e[0]-t[0])),i=Math.sin(Be(e[1])),o=Math.sin(Be(t[1])),r=Math.cos(Be(e[1])),s=Math.cos(Be(t[1]));return Math.acos(i*o+r*s*n)}function pS(t,e,n){const i=Be(t[0]),o=Be(t[1]),r=[0,0];return r[1]=Math.asin(Math.sin(o)*Math.cos(n)+Math.cos(o)*Math.sin(n)*Math.cos(e)),r[0]=i+Math.atan2(Math.sin(e)*Math.sin(n)*Math.cos(o),Math.cos(n)-Math.sin(o)*Math.sin(r[1])),[Xa(r[0]),Xa(r[1])]}const gS=[0,0,1],vS=Ke(),Si=[0,0,0];class dl{constructor(e){this.state=e,this.position=[0,0,0],this.projectionMatrix=[],this.viewMatrix=[],this.viewMatrixTranspose=[],this.projectionMatrixInverse=[],this.viewProjectionMatrix=[],this.viewProjectionMatrixInverse=[],this.globeMatrix=[],this.ecefMvpMatrix=new Float32Array(16),this.flat2ecef=0,this.fogDistance=0,this.correctedPitch=0,this.correctedRotation=0,this.horizonPixelOffset=0,this.prevZoom=0,this.horizonPixelOffset=0,this.flat=new q(e,this),this.ecef=new Rn(e,this),this.update()}get globeRatio(){return this.flat2ecef}setState(e){this.state=e,this.flat.setState(e),this.ecef.setState(e),this.update()}update(){const{globeMaxZoom:e}=$o;this.flat2ecef=this.state.globeMode?Ve(e-this.state.zoom,0,1):0,this.limitPitchRotation(),this.updatePosition(),this.updateViewMatrix(),this.updateProjectionMatrices(),this.state.pitch=this.correctedPitch,this.state.rotation=this.correctedRotation,this.flat.update(),this.ecef.update(),Sn(this.viewProjectionMatrix,this.projectionMatrix,this.viewMatrix),Go(this.viewProjectionMatrixInverse,this.viewProjectionMatrix),Go(this.projectionMatrixInverse,this.projectionMatrix),Hx(this.viewMatrixTranspose,this.viewMatrix),this.state.globeMode&&this.updateGlobeMatrix(),Hr(this.ecefMvpMatrix,this.viewProjectionMatrix,this.globeMatrix),this.updateHorizonPixelOffset(),this.updateFogDistance()}project(e,n=!1,i=[NaN,NaN]){if(this.flat2ecef<Number.EPSILON)return this.flat.project(q.fromGeo(e),n,i);if(this.flat2ecef>1-Number.EPSILON)return this.ecef.project(Rn.fromGeo(e),n,i);{const o=this.flat.project(q.fromGeo(e),n),r=this.ecef.project(Rn.fromGeo(e),n);return Array.from(Nn(i,o,r,this.flat2ecef))}}unproject(e,n=[0,0],i=!1){if(this.flat2ecef<Number.EPSILON){const o=[0,0,0];return this.flat.unproject(e,o),q.toGeo(o,n),n}else if(this.flat2ecef>1-Number.EPSILON){const o=[0,0,0];return this.ecef.unproject(e,!1,o),Rn.toGeo(o,n),n}else{const o=[0,0,0],r=[0,0,0];return this.flat.unproject(e,o),q.toGeo(o,o),this.ecef.unproject(e,!1,r),Rn.toGeo(r,r),i?(Cm(this,e,r,o,n,2),n[2]=0,n):(Nn(n,o,r,this.flat2ecef),n[2]=0,n)}}getViewportVertices(e){const{size:n,viewport:i}=this.state;let o={top:0,right:0,bottom:0,left:0};if(e!==void 0){const s=n[0]*e,a=n[1]*e;o={top:s,right:a,bottom:s,left:a}}return[this.flat.unproject([i.left+o.left,n[1]+i.top-o.bottom,0]),this.flat.unproject([n[0]+i.left-o.right,n[1]+i.top-o.bottom,0]),this.flat.unproject([n[0]+i.left-o.right,i.top+o.top,0]),this.flat.unproject([i.left+o.left,i.top+o.top,0])]}getHorizonPixelOffset(){return this.horizonPixelOffset}updatePosition(){const{center:e,zoom:n,size:i}=this.state,o=ks(n,i);this.prevZoom=n;const r=Math.max(o*Math.sin(this.correctedPitch),1);this.position[0]=e[0]+Math.sin(this.correctedRotation)*r,this.position[1]=e[1]-Math.cos(this.correctedRotation)*r,this.position[2]=o*Math.cos(this.correctedPitch)}limitPitchRotation(){const e=this.state,{zoom:n,pitch:i,rotation:o,cameraConfig:r,styleState:s,lowZoomMaxPitch:a,maxPitch:l}=e,{pitchInterStartZoom:c,pitchInterEndZoom:d}=r,{globeInterEndZoom:u,globeMaxZoom:f}=$o;if(this.correctedPitch=i,this.correctedRotation=o,n<d){const h=Math.max(0,n-c)/(d-c);this.correctedPitch=Math.min(i,Ra(a??90,l??90,h))}if(s.globeEnabled&&n<u){const h=Math.max(0,n-f)/(u-f);if(this.correctedPitch=Math.min(this.correctedPitch,Ra(0,l??90,h)),n<=f)this.correctedRotation=0;else if(n!==this.prevZoom){const _=0-o,p=(this.prevZoom-n)/(n-f);p>0&&(this.correctedRotation+=_*p%360)}}}updateProjectionMatrices(){const e=this.state.cameraConfig,n=e.fov;e.useDynamicNearFar||this.state.globeMode?this.updateNearFarState():this.restoreFixedNearFar();const{near:i,far:o}=e,{size:r,view:s}=this.correctViewAndSize(),a=r[0]/r[1];let l=i*Math.tan(n/2),c=2*l,d=a*c,u=-d/2;u+=s.x*d/r[0],l-=s.y*c/r[1],d*=s.width/r[0],c*=s.height/r[1];const f=u+d,h=l-c,_=this.projectionMatrix;_[0]=2*i/(f-u),_[5]=2*i/(l-h),_[8]=(f+u)/(f-u),_[9]=(l+h)/(l-h),_[10]=-(o+i)/(o-i),_[11]=-1,_[14]=-2*o*i/(o-i),_[1]=_[2]=_[3]=_[4]=_[6]=_[7]=_[12]=_[13]=_[15]=0,Go(this.projectionMatrixInverse,this.projectionMatrix)}updateNearFarState(){const{zoom:e,cameraConfig:n}=this.state,i=this.position;if(e>tS)n.near=nn.near;else{const s=.25*i[2],a=Math.min(16-e,1);n.near=s*a+nn.near*(1-a)}const o=(1-Math.min(e,20.5)/21)**2;n.far=nn.far*o}restoreFixedNearFar(){const{cameraConfig:e}=this.state;e.near=nn.near,e.far=nn.far}correctViewAndSize(){const{size:e,padding:n}=this.state,i=Math.max(0,n.top-n.bottom)*Math.tan(this.correctedPitch),o=b0(e[1])+i,r={x:(n.right-n.left)/2,y:(n.bottom-n.top)/2,width:e[0],height:e[1]};r.y+=(o-e[1])/2;const s=[e[0],o];return{view:r,size:s}}updateFogDistance(){const{center:e}=this.state,n=this.state.cameraConfig,i=Qf(this.position,e);this.fogDistance=Math.max(n.minFogDistance,i)}updateViewMatrix(){Tc(this.viewMatrix,this.position,this.state.center,gS)}updateGlobeMatrix(){const e=this.globeMatrix,n=[0,0,0];p0(e);const i=q.toGeo(this.state.center);St(n,this.state.center[0],this.state.center[1],-this.state.center[2]-_s*He),Q4(this.globeMatrix,e,n),Im(e,e,Be(i[1])),e3(e,e,-Be(i[0]))}updateHorizonPixelOffset(){const{viewport:e,size:n,zoom:i}=this.state,o=this.flat.unproject([e.left,n[1]+e.top,0]),r=this.flat.unproject([e.left+n[0]/2,n[1]+e.top,0]),s=this.flat.unproject([n[0]+e.left,n[1]+e.top,0]);$t(Si,s,o),ma(Si,Si,vS,Be(90)),_n(Si,Si);const a=w0(n[1]*this.state.cameraConfig.perspectiveDistanceLimitRatio,i);ni(Si,Si,a),jt(Si,r,Si),this.flat.project(Si,!1,Si),this.horizonPixelOffset=Math.max(0,Math.ceil(Si[1]))}}function Ve(t,e,n){return t=Math.max(t,e),t=Math.min(t,n),t}function oh(t){return t===0||Number.isNaN(t)?t:t>0?1:-1}function pf(t,e){return[e[0]/t[0]*2-1,-(e[1]/t[1])*2+1]}function Be(t){return t*Math.PI/180}function Xa(t){return t/Math.PI*180}function $c(t,e,n){n.zoom!==void 0&&(n.zoom=Ve(n.zoom,t.minZoom,t.maxZoom));const i={...t};Za(i.center);const o=new dl(i),r=o.unproject(e),s=q.fromGeo(r);n.center&&Za(n.center),o.setState({...t,...n});const a=q.fromGeo(o.unproject(e));Math.abs(s[0]-a[0])>2**31&&(a[0]+=(s[0]>0?1:-1)*2**32);const l=Ke();if($t(l,s,a),t.globeMode&&Math.abs(r[1])>70&&t.zoom>$o.globeInterStartZoom&&t.zoom<$o.globeMaxZoom){const c=Math.abs(t.zoom-n.zoom);if(c>1e-4){const d=Math.abs(s[0]-a[0]),u=Math.log10(d/c),f=Math.min(1,10**(6-u));Number.isNaN(f)||ni(l,l,f)}}return l}function Zg(t){return t=t>>>0,t=t-1,t=t|t>>1,t=t|t>>2,t=t|t>>4,t=t|t>>8,t=t|t>>16,t+1}function ts(t,e){const n={...e};for(const i in t)t[i]!==void 0&&(n[i]=t[i]);return n}function Pm(t){const e={};for(const n in t){const i=t[n];e[i]=n}return e}function Xg(t,e){const n=[];for(const i in t)e[i]||n.push(t[i]);return n}function x0(t,e,n){return Ve((n-t)/(e-t),0,1)}function yS(t){return t%1}function Yg(t,e,n){return t>=e&&t<=n}function Lm(t,e){if(t.size!==e.size)return!1;for(const n of Array.from(t))if(!e.has(n))return!1;return!0}function h3(t,e){return t===e?!0:t.length!==e.length?!1:!t.some((n,i)=>n!==e[i])}function Wr(t,e){if(t===e)return!0;if(t&&e&&typeof t=="object"&&typeof e=="object"){const n=Array.isArray(t),i=Array.isArray(e);let o,r,s;if(n&&i){if(r=t.length,r!==e.length)return!1;for(o=r;o--!==0;)if(!Wr(t[o],e[o]))return!1;return!0}if(n!==i)return!1;const a=t instanceof Date,l=e instanceof Date;if(a!==l)return!1;if(a&&l)return t.getTime()===e.getTime();const c=t instanceof RegExp,d=e instanceof RegExp;if(c!==d)return!1;if(c&&d)return t.toString()===e.toString();const u=Object.keys(t);if(r=u.length,r!==Object.keys(e).length)return!1;for(o=r;o--!==0;)if(!Object.prototype.hasOwnProperty.call(e,u[o]))return!1;for(o=r;o--!==0;)if(s=u[o],!Wr(t[s],e[s]))return!1;return!0}return t!==t&&e!==e}function qg(t,e){const n=t.indexOf(e);return n!==-1?(t.splice(n,1),!0):!1}function Ra(t,e,n){return t+(e-t)*n}function Th(t){return t==null}function Wi(t,e){const n=e;typeof t=="number"?n.fill(t):Array.isArray(t)&&typeof t[0]=="number"&&typeof t[1]=="number"&&typeof t[2]=="number"&&(n[0]=t[0],n[1]=t[1],n[2]=t[2])}class Kg{constructor(e,n){this.getNewValidFor=n,this.getNewValue=e,this.currentValue=NaN,this.currentValidFor=new Array(n().length).fill(NaN)}get value(){const e=this.getNewValidFor();return this.currentValidFor.some((i,o)=>i!==e[o])&&(this.currentValidFor=e,this.currentValue=this.getNewValue()),this.currentValue}}function _3(t){return typeof t=="object"&&t!==null&&!Array.isArray(t)}const Ao=[0,0,0],Co=[0,0,0],Ih=Ke();K4();function Zi(t,e,n,i,o){if(e!==i||n!==o){const r=o-n,s=e-i,a=1/Math.sqrt(r*r+s*s);t[0]=r*a,t[1]=s*a}else t[0]=0,t[1]=0}function m3(t,e,n,i){return $t(Ao,n,e),$t(Co,n,i),ka(t,Co,Ao),_n(t,t),t}function Wo(t,e,n,i,o){if(e!==i||n!==o){const r=i-e,s=o-n,a=1/Math.sqrt(r*r+s*s);t[0]=r*a,t[1]=s*a}else t[0]=0,t[1]=0}function p3(t,e,n,i,o){const r=e+i,s=n+o,a=e*r+n*s,l=5;if(a!==0){const c=1/a;t[0]=r*c,t[1]=s*c,_0(t)>l&&Uo(t,t)}else t[0]=0,t[1]=0}function on(t){return Ve(t*127,-127,127)}function Fm(t,e=t){return t[0]=on(e[0]),t[1]=on(e[1]),t}function bS(t,e,n,i,o){t[0]=e*i+n*o,t[1]=n*i-e*o}function Zr(t,e){const n=e[0];t[0]=-e[1],t[1]=n}function km(t,e){const n=e[0];t[0]=e[1],t[1]=-n}function Jg(t){return t[0]===0&&t[1]===0}function rd(t,e){return Math.atan2(e[1]-t[1],e[0]-t[0])}function Rm(t,e){return[(t[0]+e[0])/2,(t[1]+e[1])/2]}function Qg(t,e){const n=Math.sin(e),i=Math.cos(e),o=i*t[0]-n*t[1],r=n*t[0]+i*t[1];Yt(t,o,r)}function wS(t,e,n,i,o=!0){if(Mm(e,n)||Mm(n,i)){Yt(t,0,0);return}ti(Ao,n,e),ti(Co,i,n),o?(Zr(Ao,Ao),Zr(Co,Co)):(km(Ao,Ao),km(Co,Co)),Uo(Ao,Ao),Uo(Co,Co),Qi(t,Ao,Co),Uo(t,t)}function xS(t,e,n){e[0]=Gr(St(Ih,t[0],t[1],t[2])),e[1]=Gr(St(Ih,t[3],t[4],t[5])),e[2]=Gr(St(Ih,t[6],t[7],t[8]))}function SS(t,e,n,i){e[0]=Gr(yt(t[0],t[1],t[2])),e[1]=Gr(yt(t[4],t[5],t[6])),e[2]=Gr(yt(t[8],t[9],t[10])),n[0]=t[12],n[1]=t[13],n[2]=t[14]}function g3(t,e,n,i){const[o,r]=t,[s,a]=e,[l,c]=n;return i[0]=Math.min(Math.max(o,s),l),i[1]=Math.min(Math.max(r,a),c),i[2]=0,i}const MS={version:1,name:"2gis_sample_style",background:{color:"#f6f2de"},layers:[{type:"polygon",id:"background",filter:["match",["get","sublayer"],["Region"],!0,!1],style:{color:["interpolate",["linear"],["zoom"],9,"hsl(50, 61%, 90%)",12,"hsl(51, 37%, 90%)",14,"hsl(49, 48%, 91%)",16,"hsl(51, 51%, 92%)"]}},{type:"polygon",id:"substrate",filter:["match",["get","sublayer"],["Substrate"],!0,!1],style:{color:["interpolate",["linear"],["zoom"],14,"hsl(81, 55%, 69%)",17,"hsl(80, 71%, 92%)"]}},{type:"polygon",id:"kvar_adm",filter:["match",["get","sublayer"],["Administrative_quarter"],!0,!1],style:{color:["interpolate",["linear"],["zoom"],9,"hsl(50, 61%, 90%)",12,"hsl(51, 37%, 90%)",14,"hsl(49, 48%, 91%)",16,"hsl(51, 51%, 92%)"]}},{type:"polygon",id:"kvar_living",filter:["match",["get","sublayer"],["Dwelling_quarter_z13","Dwelling_quarter","Dwelling_quarter_z11","Dwelling_quarter_z09"],!0,!1],style:{color:["interpolate",["linear"],["zoom"],1,"#f2edd4",12,"hsl(48, 39%, 87%)",15,"hsl(51, 30%, 87%)",17,"hsl(48, 39%, 87%)"]}},{type:"polygon",id:"kvar_green",filter:["match",["get","sublayer"],["Forest_quarter","Forest_quarter_z09","Forest_quarter_z11","Forest_quarter_z13"],!0,!1],style:{color:["interpolate",["linear"],["zoom"],10,"hsl(80, 56%, 74%)",12,"hsl(81, 57%, 72%)",15,"hsl(81, 55%, 69%)",17,"hsl(83, 56%, 68%)"]}},{type:"polygon",id:"kvar_graveyard",filter:["match",["get","sublayer"],["Graveyard_quarter","Graveyard_quarter_z13","Graveyard_quarter_z11","Graveyard_quarter_z09"],!0,!1],style:{color:"hsl(75, 37%, 81%)"}},{type:"polygon",id:"kvar_private",filter:["match",["get","sublayer"],["Private_quarter","Private_quarter_z13","Private_quarter_z11","Private_quarter_z09","s_kvar_beach"],!0,!1],minzoom:7,style:{color:"hsl(50, 57%, 90%)"}},{type:"polygon",id:"kvar_prom",filter:["match",["get","sublayer"],["Technical_quarter_z13","Technical_quarter_z11","Technical_quarter_z09","Garage_quarter_z09","Garage_quarter_z11","Garage_quarter_z13","Garage_quarter","Technical_quarter"],!0,!1],style:{color:["interpolate",["linear"],["zoom"],1,"#efefde",9,"hsl(60, 30%, 91%)",12,"hsl(55, 21%, 89%)",15,"hsl(60, 14%, 90%)"]}},{type:"polygon",id:"kvar_dacha",filter:["match",["get","sublayer"],["Dacha_quarter"],!0,!1],style:{color:"hsl(79, 66%, 73%)"}},{type:"polygon",id:"kvar_pedestrian",filter:["match",["get","sublayer"],["Pedestrian_quarter"],!0,!1],style:{color:["interpolate",["linear"],["zoom"],14,"hsl(81, 55%, 69%)",17,"hsl(80, 71%, 92%)"]}},{type:"polygon",id:"kvar_sport",filter:["match",["get","sublayer"],["Sport_quarter"],!0,!1],style:{color:"#dedac8"}},{type:"polygon",id:"kvar_supplementary",filter:["match",["get","sublayer"],["Supplementary_quarter"],!0,!1],minzoom:14,style:{color:"hsl(0, 0%, 100%)"}},{type:"polygon",id:"kvar_runway",filter:["match",["get","sublayer"],["Runway_quarter"],!0,!1],minzoom:13,style:{color:"#ffffff"}},{type:"polygon",id:"kvar_flowerbed",filter:["match",["get","sublayer"],["Flowerbed_quarter"],!0,!1],minzoom:7,style:{color:["interpolate",["linear"],["zoom"],12,"hsl(83, 57%, 72%)",15,"hsl(81, 55%, 69%)",17,"hsl(83, 56%, 68%)"]}},{type:"polygon",id:"kvar_platform",filter:["match",["get","sublayer"],["Platform_quarter"],!0,!1],style:{color:["interpolate",["linear"],["zoom"],12,"hsl(55, 21%, 89%)",15,"hsl(60, 14%, 90%)"]}},{type:"polygon",id:"river",filter:["match",["get","sublayer"],["Water_area","Water_area_z11","Water_area_z13","Water_area_z09"],!0,!1],style:{color:["interpolate",["linear"],["zoom"],10,"hsl(196, 66%, 82%)",12,"hsl(201, 75%, 83%)",15,"hsl(200, 90%, 77%)"]}},{type:"polygon",id:"pool",filter:["match",["get","sublayer"],["Pool"],!0,!1],style:{color:["interpolate",["linear"],["zoom"],12,"hsl(201, 75%, 83%)",15,"hsl(200, 90%, 77%)",16,"hsl(200, 84%, 68%)"]}},{type:"polygon",id:"parking area",filter:["match",["get","sublayer"],["Parking_area"],!0,!1],minzoom:17.5,style:{color:"#c8d0d6"}},{type:"buildingModel",id:"simple model",filter:["match",["get","sublayer"],["Building_model"],!0,!1],minzoom:16,style:{color:"#fffff5",strokeColor:"#ccc9c3"}},{type:"lineExtrusion",id:"low fences",filter:["match",["get","sublayer"],["Low_fence"],!0,!1],minzoom:16.5,style:{sideColor:"#c7c2b5",strokeColor:"#c7c2b5",strokeWidth:2,height:250}},{type:"lineExtrusion",id:"normal fences",filter:["match",["get","sublayer"],["Fence","Temporary_fence"],!0,!1],minzoom:16.5,style:{sideColor:"#c7c2b5",strokeColor:"#c7c2b5",strokeWidth:2,height:400}},{type:"line",id:"internal roads copy",filter:["match",["get","sublayer"],["Internal_road","Oneway_internal_road"],!0,!1],minzoom:15,style:{color:["interpolate",["linear"],["zoom"],15,"hsla(0, 0%, 80%, 0)",18,"#cccccc"],width:["interpolate",["exponential",1.99],["zoom"],16,1.4,19,7]}},{type:"line",id:"other roads background",filter:["match",["get","sublayer"],["Other_road","Uncovered_road","Other_road_pay","Uncovered_road_pay","Oneway_other_road","Oneway_uncovered_road","Other_road_z13","Other_road_bridge","Uncovered_road_bridge","Other_road_pay_bridge","Uncovered_road_pay_bridge"],!0,!1],minzoom:13,style:{color:["interpolate",["linear"],["zoom"],12,"hsla(0, 0%, 78%, 0)",13,"#c6c6c6",16.5,"#cccccc"],width:["interpolate",["exponential",1.99],["zoom"],13,1.9,14,2,15,3.8,19,16]}}]};function v3(t,e=MS){return{...e,layers:[...e.layers,...t]}}function zm(t){return{type:"FeatureCollection",features:[{type:"Feature",properties:{demoCase:"point",label_1:"label one",label_2:"label two"},geometry:{type:"Point",coordinates:t}},{type:"Feature",properties:{demoCase:"pointWithSizeData",label:"Большой размер из данных",size:20},geometry:{type:"Point",coordinates:[t[0]+.03,t[1]+.03]}},{type:"Feature",properties:{demoCase:"pointWithSizeData",label:"Маленький размер из данных",size:10},geometry:{type:"Point",coordinates:[t[0]-.03,t[1]+.03]}},{type:"Feature",properties:{demoCase:"line",name:"name"},geometry:{type:"LineString",coordinates:[[t[0]+.01,t[1]+.01],[t[0]+.01,t[1]-.01],[t[0]-.01,t[1]-.01],[t[0]-.01,t[1]+.01]]}},{type:"Feature",properties:{demoCase:"oneWayLine",name:"name"},geometry:{type:"LineString",coordinates:[[t[0]+.02,t[1]+.02],[t[0]+.02,t[1]-.02],[t[0]-.02,t[1]-.02],[t[0]-.02,t[1]+.02]]}},{type:"Feature",properties:{demoCase:"polygon"},geometry:{type:"Polygon",coordinates:[[[t[0]+.005,t[1]+.005],[t[0]+.005,t[1]-.005],[t[0]-.005,t[1]-.005],[t[0]-.005,t[1]+.005],[t[0]+.005,t[1]+.005]]]}}]}}let Mi;const y3=[],[Eh,Ah]=q.fromGeo([82.92139350410734,55.03009314407664]);for(let t=0;t<360;t+=10){const e=[0,8e3];Qg(e,Be(t));const n=[];n.push([...q.toGeo([Eh,Ah]),80]),n.push([...q.toGeo([e[0]+Eh,e[1]+Ah]),0]),Qg(e,Be(10)),n.push([...q.toGeo([e[0]+Eh,e[1]+Ah]),0]),y3.push([n])}const TS=(t,e)=>{const n={addGeoJsonLayer:()=>{Mi||(Mi=new mapgl.GeoJsonSource(t,{data:zm(t.getCenter()),attributes:{demoCase:"point"}})),t.addLayer({type:"polygon",id:"ADDED_LAYER",filter:["match",["sourceAttr","demoCase"],["point"],!0,!1],style:{strokeColor:"#ff0000",strokeWidth:2,color:["interpolate",["linear"],["zoom"],9,"#0000ff40",12,"#0000ff30",14,"#0000ff20",16,"#0000ff10"]}},"house known type 2d")},addRasterTileLayerAsWMTS:()=>{Mi||(Mi=new mapgl.RasterTileSource(t,{url:(o,r,s)=>`https://tile.openstreetmap.org/${s}/${o}/${r}.png`,attributes:{foo:"asd"}})),t.addLayer({type:"raster",id:"ADDED_LAYER",filter:["match",["sourceAttr","foo"],["asd"],!0,!1],style:{}})},addRasterTileLayerAsWMS:()=>{Mi||(Mi=new mapgl.RasterTileSource(t,{url:(o,r,s,a)=>{const l=a.southWest.toString(),c=a.northEast.toString();return`https://ows.terrestris.de/osm/service?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetMap&FORMAT=image/png&TRANSPARENT=true&LAYERS=OSM-Overlay-WMS&HEIGHT=256&WIDTH=256&SRS=EPSG:3857&STYLES=&BBOX=${l},${c}`},attributes:{foo:"asd"}})),t.addLayer({type:"raster",id:"ADDED_LAYER",filter:["match",["sourceAttr","foo"],["asd"],!0,!1],style:{opacity:.8}})},addMeshLayer:()=>{Mi&&Mi.destroy(),Mi=new mapgl.GeoJsonSource(t,{dimensions:3,data:{type:"FeatureCollection",features:[{type:"Feature",properties:{},geometry:{type:"MultiPolygon",coordinates:y3}}]},attributes:{demoCase:"MESH_LAYER"}}),t.removeLayer("MESH_LAYER"),t.addLayer({type:"mesh",id:"MESH_LAYER",filter:["match",["sourceAttr","demoCase"],["MESH_LAYER"],!0,!1],style:{strokeColor:"#ff0000",strokeWidth:2,color:"#888888"}})},removeLayer:()=>{Mi&&(Mi.destroy(),Mi=void 0),t._impl.setStyle($s),t.removeLayer("ADDED_LAYER")}},i=e.addFolder("Layers");Object.keys(n).forEach(o=>i.add(n,o))};let Sl;const ev=v3([{type:"polygon",id:"geojson-polygon",filter:["match",["get","demoCase"],["polygon"],!0,!1],style:{strokeWidth:2,strokeColor:"#444444",color:"#00ff00a0"}},{type:"line",id:"geojson-line",filter:["match",["get","demoCase"],["line"],!0,!1],style:{color:"#9e02e0",width:5}},{type:"oneWayLine",id:"geojson-one-way-line",filter:["match",["get","demoCase"],["oneWayLine"],!0,!1],style:{color:"#ff0000"}},{type:"labelLine",id:"geojson-label-line",filter:["match",["get","demoCase"],["line"],!0,!1],style:{textField:["get","name"],textFont:"Open_Sans",textDuplicationSpacing:50,textHaloWidth:2,textColor:"#ff0000",textHaloColor:"#ffffff"}},{type:"point",id:"geojson-point",filter:["all",["match",["get","demoCase"],["point"],!0,!1]],style:{iconImage:"peak",iconWidth:16,textFont:["Open_Sans","Open_Sans"],textField:[["get","label_1"],["get","label_2"]],textFontSize:[16,16]}},{type:"point",id:"geojson-point",filter:["all",["match",["get","demoCase"],["pointWithSizeData"],!0,!1]],style:{iconImage:"peak",iconWidth:16,textFont:"Open_Sans",textField:["get","label"],textFontSize:["get","size"],allowOverlap:!0}}]),IS=(t,e)=>{function n(){Sl&&(Sl.destroy(),Sl=void 0,t._impl.setStyle($s))}const i={addWithStyle:()=>{n(),t.setStyle(ev,xs),Sl=new mapgl.GeoJsonSource(t,{data:zm(t.getCenter())})},addWithStringIds:()=>{n(),t.setStyle(ev,xs),Sl=new mapgl.GeoJsonSource(t,{promoteId:"demoCase",data:zm(t.getCenter())})},remove:n},o=e.addFolder("GeoJSON");o.add(i,"addWithStyle"),o.add(i,"addWithStringIds"),o.add(i,"remove")};var Ch,tv;function ES(){if(tv)return Ch;tv=1;var t=4,e=.001,n=1e-7,i=10,o=11,r=1/(o-1),s=typeof Float32Array=="function";function a(p,m){return 1-3*m+3*p}function l(p,m){return 3*m-6*p}function c(p){return 3*p}function d(p,m,g){return((a(m,g)*p+l(m,g))*p+c(m))*p}function u(p,m,g){return 3*a(m,g)*p*p+2*l(m,g)*p+c(m)}function f(p,m,g,y,b){var v,T,x=0;do T=m+(g-m)/2,v=d(T,y,b)-p,v>0?g=T:m=T;while(Math.abs(v)>n&&++x<i);return T}function h(p,m,g,y){for(var b=0;b<t;++b){var v=u(m,g,y);if(v===0)return m;var T=d(m,g,y)-p;m-=T/v}return m}function _(p){return p}return Ch=function(m,g,y,b){if(!(0<=m&&m<=1&&0<=y&&y<=1))throw new Error("bezier x values must be in [0, 1] range");if(m===g&&y===b)return _;for(var v=s?new Float32Array(o):new Array(o),T=0;T<o;++T)v[T]=d(T*r,m,y);function x(I){for(var E=0,L=1,N=o-1;L!==N&&v[L]<=I;++L)E+=r;--L;var k=(I-v[L])/(v[L+1]-v[L]),w=E+k*r,S=u(w,m,y);return S>=e?h(I,w,m,y):S===0?w:f(I,E,E+r,m,y)}return function(E){return E===0?0:E===1?1:d(x(E),g,b)}},Ch}var AS=ES();const CS=ll(AS);function PS(t,e,n,i){return e+n/i*t}const LS=CS(.25,.1,.25,1);function FS(t,e,n,i){return e+n*LS(t/i)}function kS(t,e,n,i){return n*(t/=i)*t+e}function RS(t,e,n,i){return-n*(t/=i)*(t-2)+e}function zS(t,e,n,i){return(t/=i/2)<1?n/2*t*t+e:-n/2*(--t*(t-2)-1)+e}function BS(t,e,n,i){return n*(t/=i)*t*t+e}function OS(t,e,n,i){return n*((t=t/i-1)*t*t+1)+e}function DS(t,e,n,i){return(t/=i/2)<1?n/2*t*t*t+e:n/2*((t-=2)*t*t+2)+e}function NS(t,e,n,i){return n*(t/=i)*t*t*t+e}function US(t,e,n,i){return-n*((t=t/i-1)*t*t*t-1)+e}function GS(t,e,n,i){return(t/=i/2)<1?n/2*t*t*t*t+e:-n/2*((t-=2)*t*t*t-2)+e}function HS(t,e,n,i){return n*(t/=i)*t*t*t*t+e}function VS(t,e,n,i){return n*((t=t/i-1)*t*t*t*t+1)+e}function jS(t,e,n,i){return(t/=i/2)<1?n/2*t*t*t*t*t+e:n/2*((t-=2)*t*t*t*t+2)+e}function $S(t,e,n,i){return-n*Math.cos(t/i*(Math.PI/2))+n+e}function WS(t,e,n,i){return n*Math.sin(t/i*(Math.PI/2))+e}function ZS(t,e,n,i){return-n/2*(Math.cos(Math.PI*t/i)-1)+e}function XS(t,e,n,i){return t==0?e:n*Math.pow(2,10*(t/i-1))+e}function YS(t,e,n,i){return t==i?e+n:n*(-Math.pow(2,-10*t/i)+1)+e}function qS(t,e,n,i){return t==0?e:t==i?e+n:(t/=i/2)<1?n/2*Math.pow(2,10*(t-1))+e:n/2*(-Math.pow(2,-10*--t)+2)+e}function KS(t,e,n,i){return-n*(Math.sqrt(1-(t/=i)*t)-1)+e}function JS(t,e,n,i){return n*Math.sqrt(1-(t=t/i-1)*t)+e}function QS(t,e,n,i){return(t/=i/2)<1?-n/2*(Math.sqrt(1-t*t)-1)+e:n/2*(Math.sqrt(1-(t-=2)*t)+1)+e}function e6(t,e,n,i){var s=1.70158,o=0,r=n;if(t==0)return e;if((t/=i)==1)return e+n;if(o||(o=i*.3),r<Math.abs(n)){r=n;var s=o/4}else var s=o/(2*Math.PI)*Math.asin(n/r);return-(r*Math.pow(2,10*(t-=1))*Math.sin((t*i-s)*(2*Math.PI)/o))+e}function t6(t,e,n,i){var s=1.70158,o=0,r=n;if(t==0)return e;if((t/=i)==1)return e+n;if(o||(o=i*.3),r<Math.abs(n)){r=n;var s=o/4}else var s=o/(2*Math.PI)*Math.asin(n/r);return r*Math.pow(2,-10*t)*Math.sin((t*i-s)*(2*Math.PI)/o)+n+e}function n6(t,e,n,i){var s=1.70158,o=0,r=n;if(t==0)return e;if((t/=i/2)==2)return e+n;if(o||(o=i*(.3*1.5)),r<Math.abs(n)){r=n;var s=o/4}else var s=o/(2*Math.PI)*Math.asin(n/r);return t<1?-.5*(r*Math.pow(2,10*(t-=1))*Math.sin((t*i-s)*(2*Math.PI)/o))+e:r*Math.pow(2,-10*(t-=1))*Math.sin((t*i-s)*(2*Math.PI)/o)*.5+n+e}function i6(t,e,n,i,o){return o==null&&(o=1.70158),n*(t/=i)*t*((o+1)*t-o)+e}function o6(t,e,n,i,o){return o==null&&(o=1.70158),n*((t=t/i-1)*t*((o+1)*t+o)+1)+e}function r6(t,e,n,i,o){return o==null&&(o=1.70158),(t/=i/2)<1?n/2*(t*t*(((o*=1.525)+1)*t-o))+e:n/2*((t-=2)*t*(((o*=1.525)+1)*t+o)+2)+e}function s6(t,e,n,i){return(t/=i)<1/2.75?n*(7.5625*t*t)+e:t<2/2.75?n*(7.5625*(t-=1.5/2.75)*t+.75)+e:t<2.5/2.75?n*(7.5625*(t-=2.25/2.75)*t+.9375)+e:n*(7.5625*(t-=2.625/2.75)*t+.984375)+e}function a6(t,e,n,i){return n*(1-Math.pow(1-t/i,pr.nonLinearity+1))+e}const b3=Object.freeze(Object.defineProperty({__proto__:null,ease:FS,easeInBack:i6,easeInCirc:KS,easeInCubic:BS,easeInElastic:e6,easeInExpo:XS,easeInOutBack:r6,easeInOutCirc:QS,easeInOutCubic:DS,easeInOutElastic:n6,easeInOutExpo:qS,easeInOutQuad:zS,easeInOutQuart:GS,easeInOutQuint:jS,easeInOutSine:ZS,easeInQuad:kS,easeInQuart:NS,easeInQuint:HS,easeInSine:$S,easeOutBack:o6,easeOutBounce:s6,easeOutCirc:JS,easeOutCubic:OS,easeOutElastic:t6,easeOutExpo:YS,easeOutQuad:RS,easeOutQuart:US,easeOutQuint:VS,easeOutSine:WS,inertia:a6,linear:PS},Symbol.toStringTag,{value:"Module"})),l6={easing:"easeInOutQuad",forceFinalValue:!0,renderAfterUpdate:!0};function Ic(t,e){return e.tickers[t]}function At(t,e,n,i,o,r,s,a){let l;e.animationGroup&&(l=Object.keys(n.tickers).filter(c=>n.tickers[c].animationGroup===e.animationGroup)),n.tickers[t]={...l6,...e,from:i,to:o,duration:r,attributes:a,startTime:n.time,alreadyStartedGroupTickers:l,iterationCount:s}}function It(t,e){delete e.tickers[t]}function S0(t,e){return!!e.tickers[t]}function xt(t,e,n){var l;const i=n.tickers[t];if(!i)return;if(i.alreadyStartedGroupTickers&&i.alreadyStartedGroupTickers.some(c=>!!n.tickers[c])){i.startTime=n.time;return}let o=n.time-i.startTime;if(i.iterationCount>1){const c=o;o=c%i.duration,i.iterationCount!==1/0&&c>=i.duration*i.iterationCount&&(o=i.duration)}let r;if(i.from.length){r=[];for(let c=0;c<i.from.length;c++){const d=nv(i.easing,i.from[c],i.to[c],i.duration,o);r.push(d)}}else r=nv(i.easing,i.from,i.to,i.duration,o);let s=!1;o>=i.duration&&(i.forceFinalValue&&(r=i.to),s=!0),e.step&&e.step(n,r,i.attributes,s),s&&(e.keepFinished||It(t,n),e.complete&&e.complete(n)),(typeof i.renderAfterUpdate=="function"?i.renderAfterUpdate():i.renderAfterUpdate)&&((l=i.attributes)!=null&&l.layerId?n.rerenderEvents.push({type:"layerAnimationTicker",layerId:i.attributes.layerId,styleId:i.attributes.styleId}):n.rerenderEvents.push({type:"coreAnimationTicker"}))}function nv(t,e,n,i,o){return b3[t](o,e,n-e,i)}function c6(t,e){const n=[37.57648717860472,55.75165869959561];let i,o,r,s=!1,a;async function l(){if(console.log("add custom layer"),s)return;s=!0,await new Promise(b=>{if(window.THREE){b();return}const v=document.createElement("script");v.src="https://unpkg.com/three@0.126.0/build/three.min.js",v.onload=()=>{b()},document.body.appendChild(v)}),t.setCenter(n),t.setZoom(17),r=new THREE.Camera,r.updateMatrixWorld=()=>{},i=new THREE.WebGLRenderer({canvas:t.getCanvas(),context:t.getWebGLContext(),antialias:window.devicePixelRatio<2}),i.autoClear=!1;const h=new THREE.AmbientLight(4210752),_=new THREE.DirectionalLight(16777215,.8);_.position.set(0,0,1),o=new THREE.Scene,o.add(h,_);const p=new THREE.BoxGeometry(1,1,1),m=new THREE.MeshBasicMaterial({color:65280});a=new THREE.Mesh(p,m);const g=mapgl._J.utils.projectGeoToMap(n),y=4e3;a.scale.set(y,y,y),a.position.set(g[0],g[1],y/2),o.add(a)}function c(){r&&(r.matrixWorldInverse.fromArray(t.getProjectionMatrix()),i.resetState(),i.render(o,r))}function d(h){r&&a.rotateZ(h)}const u={"Анимация самый верх":()=>{try{t.removeLayer("my")}catch{}t.addLayer({id:"my",type:"custom",render:c,onAdd:()=>l(),onRemove:()=>console.log("remove custom layer external callback")});const h=t._impl.modules.styleManager.getStyle(t._impl.state.handyStyleId);if(h){const _=h.layerIdToInnerId.my;At("cube",{easing:"linear"},t._impl.state,.005,.08,1e4,1,{layerId:_,styleId:t._impl.state.handyStyleId}),t._impl.on("framestart",()=>{xt("cube",{step:(p,m)=>d(m)},t._impl.state)})}},"Анимация где модели":()=>{try{t.removeLayer("my")}catch{}t.addLayer({id:"my",type:"custom",render:c,onAdd:()=>l(),onRemove:()=>console.log("remove custom layer external callback")},"616184");const h=t._impl.modules.styleManager.getStyle(t._impl.state.handyStyleId);if(h){const _=h.layerIdToInnerId.my;At("cube",{easing:"linear"},t._impl.state,.005,.08,1e4,1,{layerId:_,styleId:t._impl.state.handyStyleId}),t._impl.on("framestart",()=>{xt("cube",{step:(p,m)=>d(m)},t._impl.state)})}},"добавить слой поверх всего":()=>{try{t.removeLayer("my")}catch{}t.addLayer({id:"my",type:"custom",render:c,onAdd:()=>l(),onRemove:()=>console.log("remove custom layer external callback")})},"добавить под лейблингом":()=>{try{t.removeLayer("my")}catch{}t.addLayer({id:"my",type:"custom",render:c,onAdd:()=>l(),onRemove:()=>console.log("remove custom layer external callback")},"porch")},удалить:()=>{try{t.removeLayer("my")}catch{}}},f=e.addFolder("Кастомный WebGL слой");Object.keys(u).forEach(h=>f.add(u,h))}function d6(t,e){const n=[82.980667,55.043583],i="zenith-source-poly",o="zenithCustom",r={disableTilesAnimation:!1},s={source:null,createAld(){this.remove(),t.setCenter([37.62398139460266,55.752276775400716]),t.addLayer({id:"zenith-layer-k71MSe74GEWBNtMw9xwF4A",type:"line",style:{color:["precompute",["step",["get","double_field_2"],["to-color","#d16419"],1,["to-color","rgba(132, 181, 225, 0.7)"],2,["to-color","rgba(84, 144, 235, 0.7)"],3,["to-color","rgba(100, 97, 241, 0.7)"],4,["to-color","rgba(204, 40, 158, 0.7)"],5,["to-color","rgba(252, 46, 46, 0.7)"],6,["to-color","rgba(255, 153, 0, 0.7)"]]],width:["match",["featureState","sel"],[1],8,2]},webglState:{depthTest:!1,depthMask:!1},minzoom:5,filter:["match",["sourceAttr","sourceName"],[o],!0,!1]}),this.source=window.source=new mapgl.ZenithSource(t,{tileTemplateUrl:"{protocol}://{host}/api/v3/ald?ts={tileSet}&x={x}&y={y}&z={z}&lang={lang}&layer=pro_auto_traffic_detailed",metatileTemplateUrl:"{protocol}://{host}/api/v3/ald/file/{hash}?ts={tileSet}&layer=pro_auto_traffic_detailed",tileServer:"tileserver.k8s.2gis.dev",tileSet:"userdata",tileProtocol:"https",appId:"empty",promoteId:"source_id",subdomains:[],sourceAttributes:{sourceName:o,sourceLayerId:"BACI-p7H-EWZx2OIioMlHQ"},disableTilesAnimation:!0,promoteAttributes:["double_field_2","double_field_3","double_field_4","double_field_5","double_field_6","double_field_7","double_field_8","double_field_9","double_field_10","double_field_11","double_field_12","double_field_13","double_field_14","double_field_15","double_field_16","double_field_17","double_field_18","double_field_19","double_field_20","double_field_21","double_field_22","double_field_23","double_field_24","double_field_25","double_field_26","double_field_27","double_field_28","double_field_29","double_field_30","double_field_31","double_field_32","double_field_33","double_field_34","double_field_35","double_field_36","double_field_37","double_field_38","double_field_39","double_field_40","double_field_41","double_field_42","double_field_43","double_field_44","double_field_45","double_field_46","double_field_47","double_field_48","double_field_49","double_field_50","source_id"]});const l={};t.on("click",c=>{var f,h;const d=(f=c.target)==null?void 0:f.id;if(!d)return;l[d]||(l[d]={sel:0});const u=l[d].sel;l[d]={sel:u?0:1},(h=this.source)==null||h.setFeatureStateMap(l)})},createVt(){this.remove(),t.setCenter(n),t.setZoom(16),t.addLayer({type:"polygon",id:"kvar_green_custom",filter:["all",["match",["sourceAttr","sourceName"],[o],!0,!1],["match",["get","sublayer"],["Forest_quarter","Forest_quarter_z09","Forest_quarter_z11","Forest_quarter_z13"],!0,!1]],style:{color:["interpolate",["linear"],["zoom"],10,"hsl(80, 56%, 74%)",12,"hsl(81, 57%, 72%)",15,"hsl(81, 55%, 69%)",17,"hsl(83, 56%, 68%)"]}}),t.addLayer({id:"house",type:"polygon",filter:["all",["match",["sourceAttr","sourceName"],[o],!0,!1],["match",["get","sublayer"],["Private_house"],!0,!1]],style:{color:"rgba(0, 255, 0, 0.5)",strokeColor:"rgba(255, 0, 0, 0.5)",strokeWidth:3}}),this.source=new mapgl.ZenithSource(t,{tileTemplateUrl:"{protocol}://{host}/vt?r={request}&ts={tileSet}&key={tileKey}&appId={appId}&lang={lang}&default_lang={defaultLang}&s={sessionId}",metatileTemplateUrl:"{protocol}://{host}/metafiles/{hash}/metatile.json?ts={tileSet}",appId:t._impl.state.appId,tileServer:"tile{subdomain}.maps.2gis.com",tileSet:t._impl.state.tileSet,tileProtocol:t._impl.state.tileProtocol,tileKey:t._impl.state.tileKey,subdomains:t._impl.state.subdomains,sourceAttributes:{sourceName:o},disableTilesAnimation:r.disableTilesAnimation,promoteAttributes:["db_sublayer","db_label"]})},remove(){this.source&&(this.source.destroy(),this.source=null,t.removeLayer(i),t._impl.setStyle($s))}},a=e.addFolder("Zenith Source");a.add(r,"disableTilesAnimation"),a.add(s,"createAld"),a.add(s,"createVt"),a.add(s,"remove")}let u6=1;function Rs(){return u6++}var sd={},iv;function f6(){return iv||(iv=1,function(){for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",e=new Uint8Array(256),n=0;n<t.length;n++)e[t.charCodeAt(n)]=n;sd.encode=function(i){var o=new Uint8Array(i),r,s=o.length,a="";for(r=0;r<s;r+=3)a+=t[o[r]>>2],a+=t[(o[r]&3)<<4|o[r+1]>>4],a+=t[(o[r+1]&15)<<2|o[r+2]>>6],a+=t[o[r+2]&63];return s%3===2?a=a.substring(0,a.length-1)+"=":s%3===1&&(a=a.substring(0,a.length-2)+"=="),a},sd.decode=function(i){var o=i.length*.75,r=i.length,s,a=0,l,c,d,u;i[i.length-1]==="="&&(o--,i[i.length-2]==="="&&o--);var f=new ArrayBuffer(o),h=new Uint8Array(f);for(s=0;s<r;s+=4)l=e[i.charCodeAt(s)],c=e[i.charCodeAt(s+1)],d=e[i.charCodeAt(s+2)],u=e[i.charCodeAt(s+3)],h[a++]=l<<2|c>>4,h[a++]=(c&15)<<4|d>>2,h[a++]=(d&3)<<6|u&63;return f}}()),sd}var w3=f6(),ad={},ov;function h6(){return ov||(ov=1,ad.read=function(t,e,n,i,o){var r,s,a=o*8-i-1,l=(1<<a)-1,c=l>>1,d=-7,u=n?o-1:0,f=n?-1:1,h=t[e+u];for(u+=f,r=h&(1<<-d)-1,h>>=-d,d+=a;d>0;r=r*256+t[e+u],u+=f,d-=8);for(s=r&(1<<-d)-1,r>>=-d,d+=i;d>0;s=s*256+t[e+u],u+=f,d-=8);if(r===0)r=1-c;else{if(r===l)return s?NaN:(h?-1:1)*(1/0);s=s+Math.pow(2,i),r=r-c}return(h?-1:1)*s*Math.pow(2,r-i)},ad.write=function(t,e,n,i,o,r){var s,a,l,c=r*8-o-1,d=(1<<c)-1,u=d>>1,f=o===23?Math.pow(2,-24)-Math.pow(2,-77):0,h=i?0:r-1,_=i?1:-1,p=e<0||e===0&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(a=isNaN(e)?1:0,s=d):(s=Math.floor(Math.log(e)/Math.LN2),e*(l=Math.pow(2,-s))<1&&(s--,l*=2),s+u>=1?e+=f/l:e+=f*Math.pow(2,1-u),e*l>=2&&(s++,l/=2),s+u>=d?(a=0,s=d):s+u>=1?(a=(e*l-1)*Math.pow(2,o),s=s+u):(a=e*Math.pow(2,u-1)*Math.pow(2,o),s=0));o>=8;t[n+h]=a&255,h+=_,a/=256,o-=8);for(s=s<<o|a,c+=o;c>0;t[n+h]=s&255,h+=_,s/=256,c-=8);t[n+h-_]|=p*128}),ad}var Ph,rv;function _6(){if(rv)return Ph;rv=1,Ph=e;var t=h6();function e(w){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(w)?w:new Uint8Array(w||0),this.pos=0,this.type=0,this.length=this.buf.length}e.Varint=0,e.Fixed64=1,e.Bytes=2,e.Fixed32=5;var n=65536*65536,i=1/n,o=12,r=typeof TextDecoder>"u"?null:new TextDecoder("utf8");e.prototype={destroy:function(){this.buf=null},readFields:function(w,S,A){for(A=A||this.length;this.pos<A;){var z=this.readVarint(),M=z>>3,P=this.pos;this.type=z&7,w(M,S,this),this.pos===P&&this.skip(z)}return S},readMessage:function(w,S){return this.readFields(w,S,this.readVarint()+this.pos)},readFixed32:function(){var w=x(this.buf,this.pos);return this.pos+=4,w},readSFixed32:function(){var w=E(this.buf,this.pos);return this.pos+=4,w},readFixed64:function(){var w=x(this.buf,this.pos)+x(this.buf,this.pos+4)*n;return this.pos+=8,w},readSFixed64:function(){var w=x(this.buf,this.pos)+E(this.buf,this.pos+4)*n;return this.pos+=8,w},readFloat:function(){var w=t.read(this.buf,this.pos,!0,23,4);return this.pos+=4,w},readDouble:function(){var w=t.read(this.buf,this.pos,!0,52,8);return this.pos+=8,w},readVarint:function(w){var S=this.buf,A,z;return z=S[this.pos++],A=z&127,z<128||(z=S[this.pos++],A|=(z&127)<<7,z<128)||(z=S[this.pos++],A|=(z&127)<<14,z<128)||(z=S[this.pos++],A|=(z&127)<<21,z<128)?A:(z=S[this.pos],A|=(z&15)<<28,s(A,w,this))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var w=this.readVarint();return w%2===1?(w+1)/-2:w/2},readBoolean:function(){return!!this.readVarint()},readString:function(){var w=this.readVarint()+this.pos,S=this.pos;return this.pos=w,w-S>=o&&r?N(this.buf,S,w):L(this.buf,S,w)},readBytes:function(){var w=this.readVarint()+this.pos,S=this.buf.subarray(this.pos,w);return this.pos=w,S},readPackedVarint:function(w,S){if(this.type!==e.Bytes)return w.push(this.readVarint(S));var A=a(this);for(w=w||[];this.pos<A;)w.push(this.readVarint(S));return w},readPackedSVarint:function(w){if(this.type!==e.Bytes)return w.push(this.readSVarint());var S=a(this);for(w=w||[];this.pos<S;)w.push(this.readSVarint());return w},readPackedBoolean:function(w){if(this.type!==e.Bytes)return w.push(this.readBoolean());var S=a(this);for(w=w||[];this.pos<S;)w.push(this.readBoolean());return w},readPackedFloat:function(w){if(this.type!==e.Bytes)return w.push(this.readFloat());var S=a(this);for(w=w||[];this.pos<S;)w.push(this.readFloat());return w},readPackedDouble:function(w){if(this.type!==e.Bytes)return w.push(this.readDouble());var S=a(this);for(w=w||[];this.pos<S;)w.push(this.readDouble());return w},readPackedFixed32:function(w){if(this.type!==e.Bytes)return w.push(this.readFixed32());var S=a(this);for(w=w||[];this.pos<S;)w.push(this.readFixed32());return w},readPackedSFixed32:function(w){if(this.type!==e.Bytes)return w.push(this.readSFixed32());var S=a(this);for(w=w||[];this.pos<S;)w.push(this.readSFixed32());return w},readPackedFixed64:function(w){if(this.type!==e.Bytes)return w.push(this.readFixed64());var S=a(this);for(w=w||[];this.pos<S;)w.push(this.readFixed64());return w},readPackedSFixed64:function(w){if(this.type!==e.Bytes)return w.push(this.readSFixed64());var S=a(this);for(w=w||[];this.pos<S;)w.push(this.readSFixed64());return w},skip:function(w){var S=w&7;if(S===e.Varint)for(;this.buf[this.pos++]>127;);else if(S===e.Bytes)this.pos=this.readVarint()+this.pos;else if(S===e.Fixed32)this.pos+=4;else if(S===e.Fixed64)this.pos+=8;else throw new Error("Unimplemented type: "+S)},writeTag:function(w,S){this.writeVarint(w<<3|S)},realloc:function(w){for(var S=this.length||16;S<this.pos+w;)S*=2;if(S!==this.length){var A=new Uint8Array(S);A.set(this.buf),this.buf=A,this.length=S}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(w){this.realloc(4),I(this.buf,w,this.pos),this.pos+=4},writeSFixed32:function(w){this.realloc(4),I(this.buf,w,this.pos),this.pos+=4},writeFixed64:function(w){this.realloc(8),I(this.buf,w&-1,this.pos),I(this.buf,Math.floor(w*i),this.pos+4),this.pos+=8},writeSFixed64:function(w){this.realloc(8),I(this.buf,w&-1,this.pos),I(this.buf,Math.floor(w*i),this.pos+4),this.pos+=8},writeVarint:function(w){if(w=+w||0,w>268435455||w<0){c(w,this);return}this.realloc(4),this.buf[this.pos++]=w&127|(w>127?128:0),!(w<=127)&&(this.buf[this.pos++]=(w>>>=7)&127|(w>127?128:0),!(w<=127)&&(this.buf[this.pos++]=(w>>>=7)&127|(w>127?128:0),!(w<=127)&&(this.buf[this.pos++]=w>>>7&127)))},writeSVarint:function(w){this.writeVarint(w<0?-w*2-1:w*2)},writeBoolean:function(w){this.writeVarint(!!w)},writeString:function(w){w=String(w),this.realloc(w.length*4),this.pos++;var S=this.pos;this.pos=k(this.buf,w,this.pos);var A=this.pos-S;A>=128&&f(S,A,this),this.pos=S-1,this.writeVarint(A),this.pos+=A},writeFloat:function(w){this.realloc(4),t.write(this.buf,w,this.pos,!0,23,4),this.pos+=4},writeDouble:function(w){this.realloc(8),t.write(this.buf,w,this.pos,!0,52,8),this.pos+=8},writeBytes:function(w){var S=w.length;this.writeVarint(S),this.realloc(S);for(var A=0;A<S;A++)this.buf[this.pos++]=w[A]},writeRawMessage:function(w,S){this.pos++;var A=this.pos;w(S,this);var z=this.pos-A;z>=128&&f(A,z,this),this.pos=A-1,this.writeVarint(z),this.pos+=z},writeMessage:function(w,S,A){this.writeTag(w,e.Bytes),this.writeRawMessage(S,A)},writePackedVarint:function(w,S){S.length&&this.writeMessage(w,h,S)},writePackedSVarint:function(w,S){S.length&&this.writeMessage(w,_,S)},writePackedBoolean:function(w,S){S.length&&this.writeMessage(w,g,S)},writePackedFloat:function(w,S){S.length&&this.writeMessage(w,p,S)},writePackedDouble:function(w,S){S.length&&this.writeMessage(w,m,S)},writePackedFixed32:function(w,S){S.length&&this.writeMessage(w,y,S)},writePackedSFixed32:function(w,S){S.length&&this.writeMessage(w,b,S)},writePackedFixed64:function(w,S){S.length&&this.writeMessage(w,v,S)},writePackedSFixed64:function(w,S){S.length&&this.writeMessage(w,T,S)},writeBytesField:function(w,S){this.writeTag(w,e.Bytes),this.writeBytes(S)},writeFixed32Field:function(w,S){this.writeTag(w,e.Fixed32),this.writeFixed32(S)},writeSFixed32Field:function(w,S){this.writeTag(w,e.Fixed32),this.writeSFixed32(S)},writeFixed64Field:function(w,S){this.writeTag(w,e.Fixed64),this.writeFixed64(S)},writeSFixed64Field:function(w,S){this.writeTag(w,e.Fixed64),this.writeSFixed64(S)},writeVarintField:function(w,S){this.writeTag(w,e.Varint),this.writeVarint(S)},writeSVarintField:function(w,S){this.writeTag(w,e.Varint),this.writeSVarint(S)},writeStringField:function(w,S){this.writeTag(w,e.Bytes),this.writeString(S)},writeFloatField:function(w,S){this.writeTag(w,e.Fixed32),this.writeFloat(S)},writeDoubleField:function(w,S){this.writeTag(w,e.Fixed64),this.writeDouble(S)},writeBooleanField:function(w,S){this.writeVarintField(w,!!S)}};function s(w,S,A){var z=A.buf,M,P;if(P=z[A.pos++],M=(P&112)>>4,P<128||(P=z[A.pos++],M|=(P&127)<<3,P<128)||(P=z[A.pos++],M|=(P&127)<<10,P<128)||(P=z[A.pos++],M|=(P&127)<<17,P<128)||(P=z[A.pos++],M|=(P&127)<<24,P<128)||(P=z[A.pos++],M|=(P&1)<<31,P<128))return l(w,M,S);throw new Error("Expected varint not more than 10 bytes")}function a(w){return w.type===e.Bytes?w.readVarint()+w.pos:w.pos+1}function l(w,S,A){return A?S*4294967296+(w>>>0):(S>>>0)*4294967296+(w>>>0)}function c(w,S){var A,z;if(w>=0?(A=w%4294967296|0,z=w/4294967296|0):(A=~(-w%4294967296),z=~(-w/4294967296),A^4294967295?A=A+1|0:(A=0,z=z+1|0)),w>=18446744073709552e3||w<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");S.realloc(10),d(A,z,S),u(z,S)}function d(w,S,A){A.buf[A.pos++]=w&127|128,w>>>=7,A.buf[A.pos++]=w&127|128,w>>>=7,A.buf[A.pos++]=w&127|128,w>>>=7,A.buf[A.pos++]=w&127|128,w>>>=7,A.buf[A.pos]=w&127}function u(w,S){var A=(w&7)<<4;S.buf[S.pos++]|=A|((w>>>=3)?128:0),w&&(S.buf[S.pos++]=w&127|((w>>>=7)?128:0),w&&(S.buf[S.pos++]=w&127|((w>>>=7)?128:0),w&&(S.buf[S.pos++]=w&127|((w>>>=7)?128:0),w&&(S.buf[S.pos++]=w&127|((w>>>=7)?128:0),w&&(S.buf[S.pos++]=w&127)))))}function f(w,S,A){var z=S<=16383?1:S<=2097151?2:S<=268435455?3:Math.floor(Math.log(S)/(Math.LN2*7));A.realloc(z);for(var M=A.pos-1;M>=w;M--)A.buf[M+z]=A.buf[M]}function h(w,S){for(var A=0;A<w.length;A++)S.writeVarint(w[A])}function _(w,S){for(var A=0;A<w.length;A++)S.writeSVarint(w[A])}function p(w,S){for(var A=0;A<w.length;A++)S.writeFloat(w[A])}function m(w,S){for(var A=0;A<w.length;A++)S.writeDouble(w[A])}function g(w,S){for(var A=0;A<w.length;A++)S.writeBoolean(w[A])}function y(w,S){for(var A=0;A<w.length;A++)S.writeFixed32(w[A])}function b(w,S){for(var A=0;A<w.length;A++)S.writeSFixed32(w[A])}function v(w,S){for(var A=0;A<w.length;A++)S.writeFixed64(w[A])}function T(w,S){for(var A=0;A<w.length;A++)S.writeSFixed64(w[A])}function x(w,S){return(w[S]|w[S+1]<<8|w[S+2]<<16)+w[S+3]*16777216}function I(w,S,A){w[A]=S,w[A+1]=S>>>8,w[A+2]=S>>>16,w[A+3]=S>>>24}function E(w,S){return(w[S]|w[S+1]<<8|w[S+2]<<16)+(w[S+3]<<24)}function L(w,S,A){for(var z="",M=S;M<A;){var P=w[M],C=null,D=P>239?4:P>223?3:P>191?2:1;if(M+D>A)break;var B,U,G;D===1?P<128&&(C=P):D===2?(B=w[M+1],(B&192)===128&&(C=(P&31)<<6|B&63,C<=127&&(C=null))):D===3?(B=w[M+1],U=w[M+2],(B&192)===128&&(U&192)===128&&(C=(P&15)<<12|(B&63)<<6|U&63,(C<=2047||C>=55296&&C<=57343)&&(C=null))):D===4&&(B=w[M+1],U=w[M+2],G=w[M+3],(B&192)===128&&(U&192)===128&&(G&192)===128&&(C=(P&15)<<18|(B&63)<<12|(U&63)<<6|G&63,(C<=65535||C>=1114112)&&(C=null))),C===null?(C=65533,D=1):C>65535&&(C-=65536,z+=String.fromCharCode(C>>>10&1023|55296),C=56320|C&1023),z+=String.fromCharCode(C),M+=D}return z}function N(w,S,A){return r.decode(w.subarray(S,A))}function k(w,S,A){for(var z=0,M,P;z<S.length;z++){if(M=S.charCodeAt(z),M>55295&&M<57344)if(P)if(M<56320){w[A++]=239,w[A++]=191,w[A++]=189,P=M;continue}else M=P-55296<<10|M-56320|65536,P=null;else{M>56319||z+1===S.length?(w[A++]=239,w[A++]=191,w[A++]=189):P=M;continue}else P&&(w[A++]=239,w[A++]=191,w[A++]=189,P=null);M<128?w[A++]=M:(M<2048?w[A++]=M>>6|192:(M<65536?w[A++]=M>>12|224:(w[A++]=M>>18|240,w[A++]=M>>12&63|128),w[A++]=M>>6&63|128),w[A++]=M&63|128)}return A}return Ph}var m6=_6();const rh=ll(m6);function p6(t){let e=0;for(let n=0;n<t.length;n++)e+=t[n]*256**(t.length-1-n);return e}function M0(t){const e=new Uint8Array(6);for(let n=0;n<6;n++)e[n]=Math.floor(t/256**(5-n))&255;return encodeURIComponent(w3.encode(e))}function g6(t,e){const n={};t.forEach((o,r)=>{n[o]=r});let i=t.length;n.selected=n.selected??i++,n.hovered=n.hovered??i++,n.dpi=n.dpi??i++,n.isRealtime=n.isRealtime??i++,n.pixelDensityPreset=n.pixelDensityPreset??i++,n.tier=n.tier??i++;for(const o in e)n[o]===void 0&&(n[o]=i++);return n}function x3(t){const e=g6(t.tileProps,t.defaultProps),n={};for(const i in t.defaultProps)n[i]={index:e[i],value:t.defaultProps[i]};return{version:t.version,dictionaries:t.enumerationValues,reverseDictionaries:Object.keys(t.enumerationValues).reduce((i,o)=>(i[o]=Pm(t.enumerationValues[o]),i),{}),tileProps:e,tilePropsByIndex:Pm(e),defaultProps:n,vertexPropsLegacy:Bm(t.vertexProps)?v6(t):{},vertexProps:Bm(t.vertexProps)?[]:t.vertexProps}}function v6(t){const e=t.vertexProps,n={point:["x","y","z"],polygon:["x","y","cut","signed_z"],polyline:["x","y"]};if(!e)return n;if(!Bm(e))return console.warn(`Попытка сгенерировать vertexPropsLegacy для метатайла версии ${t.version}`),{};const i={0:"point",1:"polyline",2:"polygon"};return Object.keys(e).forEach(o=>{const r=i[o];if(typeof r>"u"){console.warn(`Неизвестный тип геометрии "${o}", нужно его поддержать`);return}n[r]=e[parseInt(o,10)]}),n}function y6(t,e){const n={};if(e)for(let i=0;i<e.length;i++)n[e[i]]=i;return x3({enumerationValues:{db_sublayer:n},version:"7.0.0",defaultProps:{},tileProps:t,vertexProps:[]})}function _c(t,e){const{tileProps:n}=t;let i=Object.keys(n).length;for(const o of e)n[o]===void 0&&(n[o]=i,i+=1)}let Ne=0;const Ho={beginningIsCut:Ne++,class:Ne++,componentDistanceEnd:Ne++,componentDistanceStart:Ne++,db_icon_priority:Ne++,db_label_priority:Ne++,db_label2_priority:Ne++,dpi:Ne++,endingIsCut:Ne++,height:Ne++,db_hidden_by_plan_building_id:Ne++,db_hidden_by_plan_id:Ne++,id:Ne++,isRealtime:Ne++,db_label:Ne++,db_label2:Ne++,nextPointX:Ne++,nextPointY:Ne++,db_object_class:Ne++,objectLength:Ne++,pixelDensityPreset:Ne++,previousPointX:Ne++,previousPointY:Ne++,db_region:Ne++,selected:Ne++,hovered:Ne++,db_sublayer:Ne++,traffic_color:Ne++,traffic_road_class:Ne++,traffic_road_z_level:Ne++,db_tiers:Ne++,model_src:Ne++,linkedIds:Ne++,db_model_rotation_angle:Ne++,db_plan_id:Ne++,traffic_color2:Ne++},S3={version:"5.0.0",tileProps:Ho,tilePropsByIndex:Pm(Ho),defaultProps:{},dictionaries:{},reverseDictionaries:{},vertexPropsLegacy:{},vertexProps:[]},Wc=[],ul={},M3={sourceName:"zenith"};function Bm(t){return!Array.isArray(t)}const Om=/\{(\w+)\}/g;function Ya(t,e){return t.replace(Om,(n,i)=>e[i])}function T3(t){const[e,n]=t.split("?");if(!n)return e;const o=n.split("&").map(r=>r.split("=")).filter(([,r])=>r!=="undefined").map(r=>r.join("=")).join("&");return o.length?`${e}?${o}`:e}function Lh(t,e){return(typeof t=="object"?t.url:v0[t]).replace(Om,(n,i)=>e[i]??n).replace(Om,(n,i)=>e[i]??n)}function wr(t,e){const n=Ya(e.host,{subdomain:e.subdomain}),i=Ya(typeof t=="object"?t.url:v0[t],{...e,host:n});return T3(i)}function Zc(t,e){const n=Ya(t,e);return T3(n)}function za(t,e){let n=0;for(let i=0;i<e.length;i++)n+=e.charCodeAt(i);return t[n%t.length]}function b6(t,e){const n=new URL(e);return t.startsWith("//")?`${n.protocol}${t}`:t.startsWith("/")?`${n.origin}${t}`:t}Array(16);function zr(t,e){return{a:t[1]-e[1],b:e[0]-t[0],c:t[0]*e[1]-e[0]*t[1]}}function Zu(t,e){return Math.abs(I3(t,e))}function I3(t,e){return(e.a*t[0]+e.b*t[1]+e.c)/Math.sqrt(e.a*e.a+e.b*e.b)}function w6(t,e,n){const{a:i,b:o,c:r}=zr(t,e);return yt(n,-(i*n+r)/o,0)}function x6(t,e,n){const{a:i,b:o,c:r}=zr(t,e);return yt(-(o*n+r)/i,n,0)}const ss=es(),Wn=es();function S6(t,e,n){const i=e[e.length-1]*n;let o=t[0],r=0;const s=[o];let a=1,l;for(;a<t.length&&!l;){const c=t[a],d=e[a];let u=c;if(d>i){if(!l){const f=(i-r)/(d-r);l=[],Z4(l,o,c,f)}u=l}s.push(u),o=u,r=e[a],a++}return s}function M6(t,e){let n=t[0];Em(ss),kr(ss,n);let i=[n];const o=[i];let r=1;for(;r<t.length;){const s=t[r];let a=!1,l=s;if(jg(Wn,ss),kr(Wn,l),Wn.max[0]-Wn.min[0]>e){const c=Wn.max[0]===l[0]?Wn.min[0]+e:Wn.max[0]-e;l=w6(n,l,c),a=!0}if(a&&(jg(Wn,ss),kr(Wn,l)),Wn.max[1]-Wn.min[1]>e){const c=Wn.max[1]===l[1]?Wn.min[1]+e:Wn.max[1]-e;l=x6(n,l,c),a=!0}a?(i.push(l),Em(ss),kr(ss,l),i=[l],o.push(i),n=l):(i.push(s),kr(ss,s),n=s,r++)}return o}function T6(t,e,n){const i=t[0]-e[0],o=t[1]-e[1],r=n[0]-e[0],s=n[1]-e[1],a=i*r+o*s,l=r*r+s*s,c=l!==0?a/l:0;return c<0?e:c>1?n:[e[0]+c*r,e[1]+c*s]}function fl(t){const e=t[0][0],n=t[0][1],i=t[1][0],o=t[1][1],r=t[2][0],s=t[2][1],a=t[3][0],l=t[3][1];return{min:[Math.min(e,i,r,a),Math.min(n,o,s,l)],max:[Math.max(e,i,r,a),Math.max(n,o,s,l)]}}function I6(t){return[[t[0][0],t[0][1],t[0][2]],[t[1][0],t[1][1],t[1][2]],[t[2][0],t[2][1],t[2][2]],[t[3][0],t[3][1],t[3][2]]]}function zs(t,e){const n=fl(t);if(!g0(e,n))return!1;const i=[zr(t[3],t[2]),zr(t[1],t[0]),zr(t[0],t[3]),zr(t[2],t[1])],o=[e.min,e.max,[e.min[0],e.max[1]],[e.max[0],e.min[1]]];for(const r of i){let s=!0;for(let a=0;a<o.length;a++){const l=o[a];if(r.a*l[0]+r.b*l[1]+r.c<0){s=!1;break}}if(s)return!1}return!0}function E6(t,e,n){t.forEach(i=>{const o=1+e/Y4(n,i);Nn(i,n,i,o)})}const sh={};var co=sh.TileRequestUrl={};co.read=function(t,e){return t.readFields(co._readField,{tiles:[]},e)};co._readField=function(t,e,n){t===1&&e.tiles.push(co.Tile.read(n,n.readVarint()+n.pos))};co.write=function(t,e){if(t.tiles)for(var n=0;n<t.tiles.length;n++)e.writeMessage(1,co.Tile.write,t.tiles[n])};co.Tile={};co.Tile.read=function(t,e){return t.readFields(co.Tile._readField,{x:0,y:0,zoom:0},e)};co.Tile._readField=function(t,e,n){t===1?e.x=n.readVarint():t===2?e.y=n.readVarint():t===3&&(e.zoom=n.readVarint())};co.Tile.write=function(t,e){t.x&&e.writeVarintField(1,t.x),t.y&&e.writeVarintField(2,t.y),t.zoom&&e.writeVarintField(3,t.zoom)};var mn=sh.TileResponseData={};mn.read=function(t,e){return t.readFields(mn._readField,{tileGroups:[]},e)};mn._readField=function(t,e,n){t===1&&e.tileGroups.push(mn.TileGroup.read(n,n.readVarint()+n.pos))};mn.write=function(t,e){if(t.tileGroups)for(var n=0;n<t.tileGroups.length;n++)e.writeMessage(1,mn.TileGroup.write,t.tileGroups[n])};mn.TileGroup={};mn.TileGroup.read=function(t,e){return t.readFields(mn.TileGroup._readField,{x:0,y:0,zoom:0,tiles:[]},e)};mn.TileGroup._readField=function(t,e,n){t===1?e.x=n.readVarint():t===2?e.y=n.readVarint():t===3?e.zoom=n.readVarint():t===4&&e.tiles.push(mn.TileGroup.Tile.read(n,n.readVarint()+n.pos))};mn.TileGroup.write=function(t,e){if(t.x&&e.writeVarintField(1,t.x),t.y&&e.writeVarintField(2,t.y),t.zoom&&e.writeVarintField(3,t.zoom),t.tiles)for(var n=0;n<t.tiles.length;n++)e.writeMessage(4,mn.TileGroup.Tile.write,t.tiles[n])};mn.TileGroup.Tile={};mn.TileGroup.Tile.read=function(t,e){return t.readFields(mn.TileGroup.Tile._readField,{regionId:0,hash:null,data:null},e)};mn.TileGroup.Tile._readField=function(t,e,n){t===1?e.regionId=n.readVarint():t===2?e.hash=n.readBytes():t===3&&(e.data=n.readBytes())};mn.TileGroup.Tile.write=function(t,e){t.regionId&&e.writeVarintField(1,t.regionId),t.hash&&e.writeBytesField(2,t.hash),t.data&&e.writeBytesField(3,t.data)};const sv=[0,0,0];function Ct(t){return{coords:t,size:Nt(t[2]),offset:Di(t)}}function Ge(t){return`${t[0]}_${t[1]}_${t[2]}_${t[3]}`}function A6(t,e){return`${Ge(t)}_${e.stringify()}`}function E3(t){const e=t.split("_");return[parseInt(e[0],10),parseInt(e[1],10),parseInt(e[2],10),parseInt(e[3],10)]}function A3(t){return qe.subdomains[Math.abs(t[0]+t[1])%qe.subdomains.length]}function C3(t){const e=new rh(t),n=sh.TileResponseData.read(e),{x:i,y:o,zoom:r,tiles:s}=n.tileGroups[0];return s.map(({regionId:a,hash:l,data:c})=>(c||(console.warn(`Tile ${r}_${i}_${o} from region ${a} is corrupt (has no data)`),c=new Uint8Array(0)),{data:c,regionId:a,metatileHash:p6(l)}))}function C6(t){return t.map(e=>({regionId:e.regionId,metatileHash:e.metatileHash}))}function P6(t){const e=Math.ceil(t.byteLength/4)*4,n=new ArrayBuffer(e);return new Uint8Array(n).set(t),n}function Xr(t){const[e,n,i]=t;return{min:Di([e,n,i,i]),max:Di([e+1,n+1,i,i])}}function L6(t,e){return g0(Xr(t),Xr(e),.001)}function Ec(t,e,n,i=0){const o=Xr(t);return o.min[0]-=i,o.min[1]-=i,o.max[0]+=i,o.max[1]+=i,n.environmentManager.isAABBInFog(o)?!1:zs(e,o)}function F6(t){return Math.trunc(t/2)*2+1}function Dm(t,e=1,n=3,i=!1){let o=1/Math.cos(Be(t));return i&&(o=Math.log2(o)),Ve(Math.ceil(o),e,n)-1}const k6=(t,e)=>(isNaN(t[0])||t[0]===e[0])&&(isNaN(t[1])||t[1]===e[1])&&(isNaN(t[2])||t[2]===e[2])&&(isNaN(t[3])||t[3]===e[3]);function P3(t,e,n){const i=R6(e,t.size),o=Math.trunc(e),r=Array.from(t.center);Za(r);const s=q.toGeo(r),a={min:[s[0]-Ve(i*2,0,90),Ve(s[1]-i,-85,85)],max:[s[0]+Ve(i*2,0,90),Ve(s[1]+i,-85,85)]},l=Math.max(Dm(a.min[1],2,4),Dm(a.max[1],2,4)),c=Math.max(n,o-l),d=qa(r,c);d[0]=Math.trunc(d[0]),d[1]=Math.trunc(d[1]);const u=new dl(t),f=L3(t,u,s),h=j6(d,s,f,u,t),_=[];return h.forEach(p=>{k6([NaN,2,2,NaN],p)?_.push(...k3(p,1)):_.push(p)}),_.filter(p=>lh(t,u,p))}function R6(t,e){const n=_s*He,i=ks(t,e)+n,o=nn.fov/2,r=Math.sin(o),s=Math.cos(o),a=n/i;let l=Xa(Math.acos(r**2/a+s*Math.sqrt(1-r**2/a**2)));return Number.isNaN(l)&&(l=90),l}function L3(t,e,n){const i=Rn.toGeo(e.ecef.unproject([t.viewport.left,t.viewport.top]));return Math.min(3*Math.max(ih(i,n)),e.ecef.visibleArc)}function z6(t,e,n,i,o,r){const[s,a,l]=t,c=O6(t),d=i>=5?2:1,u=Dm((c.max[1]+c.min[1])/2,d,3,!0),f=Math.max(Math.abs(c.min[1]),Math.abs(c.max[1])),h=Math.max(n,i-u);return l>=h||f>70&&r>0||f>82||ih(e,[(c.max[0]+c.min[0])/2,(c.max[1]+c.min[1])/2])>.75*o}function B6(t,e){const i=Math.trunc(t.zoom),o=Array.from(t.center);Za(o),q.toGeo(o,o);const r=[],s=new dl(t),a=L3(t,s,o);function l(c,d=0){if(D3(o,a,c)&&lh(t,s,c))if(z6(c,o,2,i,s.ecef.visibleArc,d))r.push(c);else for(const u of k3(c,1))l(u,d+1)}return P3(t,Math.trunc(t.zoom),2).map(([c,d,u])=>{l([c,d,u,e])}),r}function O6(t){return{min:av(t),max:av([t[0]+1,t[1]+1,t[2],t[3]])}}function av(t){const e=Di(t);return q.toGeo(e)}function F3(t,e,n,i,o,r=0,s=1/0,a=!1){if(t.globeMode)return B6(t,o);a&&(n=F6(n),n>s&&(n-=2));const l=fl(t.tilesBounds),c=Nt(n),d=2**n,u=Math.floor((l.min[0]+bt-r)/c),f=Math.floor((l.max[0]+bt+r)/c),h=Math.max(Math.floor((l.min[1]+bt-r)/c),0),_=Math.min(Math.floor((l.max[1]+bt+r)/c),d-1),p=[],m=new Set;for(let g=u;g<=f;g++)for(let y=h;y<=_;y++){const b=[g,y,n,o];if(Ec(b,t.tilesBounds,e,r)){b[0]=(d+b[0]%d)%d;const v=Ge(b);m.has(v)||(m.add(v),p.push(b))}}return t.demMode&&D6(p,t,e,n,i,o),p}function D6(t,e,n,i,o,r){const s=new Set(t.map(Ge)),a=new Set,l=I6(e.tilesBounds);let c=t.slice();for(let d=i;d>=o;d--){let u=0;const f=[];c.forEach(v=>{const T=N6(v),x=Ge(T);a.has(x)||(f.push(T),a.add(x),U6(T,I=>{const E=Ge(I);!s.has(E)&&!a.has(E)&&Ec(I,e.extendedTilesBounds,n)&&(t.push(I),s.add(E),u++)}))});const h=Nt(d-1);E6(l,h,e.center);const _=fl(l),p=2**(d-1),m=Math.floor((_.min[0]+bt)/h),g=Math.floor((_.max[0]+bt)/h),y=Math.max(Math.floor((_.min[1]+bt)/h),0),b=Math.min(Math.floor((_.max[1]+bt)/h),p-1);for(let v=m;v<=g;v++)for(let T=y;T<=b;T++){const x=[v,T,d-1,r];x[0]=(p+x[0]%p)%p;const I=Ge(x);!a.has(I)&&Ec(x,l,n)&&(f.push(x),u++)}if(!u)break;c=f}}function N6(t,e=1){const[n,i,o,r]=t,s=Math.pow(2,e);return[Math.trunc(n/s),Math.trunc(i/s),o-e,r]}function k3(t,e){const[n,i,o,r]=t,s=Math.pow(2,e),a=[];for(let l=0;l<s;l++)for(let c=0;c<s;c++)a.push([n*s+l,i*s+c,o+e,r]);return a}function U6(t,e){let[n,i,o]=t;const r=t[3];n*=2,i*=2,o++,e([n,i,o,r]),e([n+1,i,o,r]),e([n,i+1,o,r]),e([n+1,i+1,o,r])}function R3(t,e,n,i,o,r,s,a,l,c,d,u){const f=new rh,h={tiles:[{x:o[0],y:o[1],zoom:o[2]}]};sh.TileRequestUrl.write(h,f);const _={x:o[0].toString(),y:o[1].toString(),z:o[2].toString(),protocol:n,host:t,subdomain:i[Math.abs(o[0]+o[1])%i.length],tileSet:e,lang:a,appId:s,tileKey:r,sessionId:d,defaultLang:c,dt:u==null?void 0:u.join(","),request:encodeURIComponent(w3.encode(f.finish()))};return wr(l?{url:l}:"tiles",_)}function G6(t,e){const n=t.coords,i=e.coords,o=n[2],r=i[2];return o===r?n[0]===i[0]&&n[1]===i[1]:o<r?Nm(t,e):Nm(e,t)}function Nm(t,e){if(e.zoomLevel<t.zoomLevel)return!1;if(e.zoomLevel===t.zoomLevel)return e.coords[0]===t.coords[0]&&e.coords[1]===t.coords[1]&&e.detailLevel>t.detailLevel;const n=Math.pow(2,e.coords[2]-t.coords[2]),i=t.coords[0]*n,o=i+n,r=t.coords[1]*n,s=r+n,a=e.coords[0],l=e.coords[1];return a>=i&&a<o&&l>=r&&l<s}function H6(t,e,n){const{coords:i}=t,o=Math.min(e,n),r=Math.pow(2,t.zoomLevel-o),s=[Math.floor(i[0]/r),Math.floor(i[1]/r),o,e];return Ge(s)}function Fh(t,e,n,i){const o=H6(e,n,i);return t[o]}function z3(t,e,n){const i=[];for(const o in t){const r=t[o];n(r)&&Nm(e,r)&&i.push(r)}return i}function mc(t,e,n){return eo(t,cv(e.coords))-eo(t,cv(n.coords))}function Sr(t,e,n){t[0]=e[0]*n.size/Se+n.offset[0],t[1]=e[1]*n.size/Se+n.offset[1],t[2]=e[2]}const ld=Ke();function lv(t,e,n,i){ld[0]=e[0][n],ld[1]=e[1][n],ld[2]=(e[2]??[])[n],Sr(t,ld,i)}function mi(t,e,n){t[0]=(e[0]-n.offset[0])*Se/n.size,t[1]=(e[1]-n.offset[1])*Se/n.size,t[2]=e[2]}function Nt(t){return 2**(32-t)}function T0(t){return t[0]>=0&&t[0]<=Se&&t[1]>=0&&t[1]<=Se}function $n(t){return Ve(t/Ha*Se,0,vt)}function B3(t){return t/Se*Ha}function Di(t){const e=Nt(t[2]),n=2147483648;return yt(t[0]*e-n,t[1]*e-n,0)}function Um(t){return[t[0]+2147483648,t[1]+2147483648,32,32]}function cv(t){const e=Nt(t[2]),n=2147483648;return yt((t[0]+.5)*e-n,(t[1]+.5)*e-n,0)}function qa(t,e){const i=Nt(e),o=t[0]-i/2,r=t[1]-i/2;return[(o+2147483648)/i,(r+2147483648)/i,e,e]}function O3(t,e=1){const n=Math.max(t.max[0]-t.min[0],t.max[1]-t.min[1],1)*e,i=32-Math.log(n)/Math.LN2,o=Et();return th(o,t),qa(o,i)}const ah=t=>{const[e,n,i,o]=t;return[e,2**i-1-n,i,o]},_o=(t,e)=>{Sr(sv,e,t);const n=q.toGeo(sv);return q.scaleFactor(n[1])};function Ac(t,e,n){const i=[0,0,0];return Sr(i,[t,e],n),q.toGeo(i)}function V6(t){const e=Math.min(t[0][0],t[1][0],t[2][0],t[3][0])+bt,n=Math.max(t[0][0],t[1][0],t[2][0],t[3][0])+bt,i=Math.floor(e/et),o=Math.floor(n/et);return Array.from({length:o-i+1},(r,s)=>s+i)}function I0(t,e){return Rn.fromGeo(Ac(e[0],e[1],t))}function Mr(t,e,n,i){const o=[];return Sr(o,i,n),ih(q.toGeo(o),t)<e}function D3(t,e,n){const i=Ct(n),o=Se;return Mr(t,e,i,[0,o/2,0])||Mr(t,e,i,[o,o/2,0])||Mr(t,e,i,[o/2,o,0])||Mr(t,e,i,[o/2,0,0])||Mr(t,e,i,[0,0,0])||Mr(t,e,i,[0,o,0])||Mr(t,e,i,[o,o,0])||Mr(t,e,i,[o,0,0])}function cd(t,e,n){const i=[];return Sr(i,n,e),t.ecef.project(Rn.fromGeo(q.toGeo(i)))}function lh(t,e,n){const[i,o,r]=n;if(o===0||o===2**r-1)return!0;const s=Ct(n),a=Se,l=[cd(e,s,[0,0,0]),cd(e,s,[0,a,0]),cd(e,s,[a,a,0]),cd(e,s,[a,0,0])],c=l.map(h=>h[0]),d=l.map(h=>h[1]),u={min:[Math.min(...c),Math.min(...d)],max:[Math.max(...c),Math.max(...d)]},f={min:[t.viewport.left,t.viewport.top],max:[t.viewport.left+t.size[0],t.viewport.top+t.size[1]]};return g0(u,f)}function j6(t,e,n,i,o){const a=new Map,l=[t],c=[];for(c.push(t);l.length;){if(c.length>300){console.warn("collectVisibleGlobeTiles: too many tiles",c.length);break}if(l.length>500){console.warn("collectVisibleGlobeTiles: queue overflow");break}const d=l.shift();if(d){const[u,f,h]=d;a.set(u+"."+f+"."+h,!0),$6(d,a,e,n).filter(p=>lh(o,i,p)).forEach(p=>{const[m,g,y]=p;a.set(m+"."+g+"."+y,!0),c.push(p),l.push(p)})}}return c}function $6(t,e,n,i){const[o,r,s,a]=t,l=2**s-1,c=m=>m>l?0:m<0?l:m,d=([m,g,y,b])=>((g>l||g<0)&&(g=g>l?l:0,m=y===0?m:(m+2**(y-1))%2**y),[m,g,y,b]),u=[c(o-1),r,s,a],f=[c(o+1),r,s,a],h=d([o,r-1,s,a]),_=d([o,r+1,s,a]);return[f,_,h,u].filter(m=>{const[g,y,b]=m;return!e.has(g+"."+y+"."+b)}).filter(m=>D3(n,i,m))}function W6(t,e,n,i=0){return""}function Dt(t,e,n){return e.precomputes.forEach((i,o)=>{t.push(n.tileData[o])}),t}function pc(t,e){for(let n=0,i=e.length;n<i;n++)t.push(e[n]);return t}const Z6=new Set(["bottomCenter","bottomRight","bottomLeft","topCenter","topRight","topLeft","rightBottom","rightCenter","rightTop","leftBottom","leftCenter","leftTop","centerCenter"]);function X6(t){return Z6.has(t)}function Y6(t){return typeof t=="number"||typeof t=="boolean"||typeof t=="string"||t===null}function E0(t){if(Array.isArray(t)){const e=t;if(!e.length)return!1;if({zoom:!0,height:!0,coalesce:!0,"heatmap-density":!0,"shading-intensity":!0,objectAttr:!0,step:!0,interpolate:!0,all:!0,get:!0,sourceAttr:!0,featureState:!0,global:!0,match:!0,in:!0,any:!0,"!":!0,"==":!0,"!=":!0,">=":!0,">":!0,"<=":!0,"<":!0,"to-boolean":!0,"to-color":!0,"+":!0,"*":!0,"^":!0,log10:!0,random:!0,literal:!0,isBehindObjects:!0,"mappoints-to-meters":!0,"meters-to-pixels":!0,uint64:!0,"geometry-modifier":!0,pattern:!0,precompute:!0,"gltf-animation":!0,distance:!0,time:!0,"local-time":!0,"utc-time":!0}[e[0]])return!0}return!1}function N3(t){return E0(t)&&t[0]==="literal"}function Bs(t){return!Array.isArray(t)&&typeof t=="object"&&t!==null&&t.type!==void 0&&t.type!=="color"}function q6(t){return!Array.isArray(t)&&typeof t=="object"&&t!==null&&t.type==="color"}function U3(t,e){return Array.isArray(t)?t.length>0&&t.every(n=>typeof n===e):!1}function K6(t){return U3(t,"string")}function uo(t){return U3(t,"number")}function G3(t){return!Array.isArray(t)&&typeof t=="object"&&t!==null&&t.type==="object"}function J6(t){const e=typeof t;return t===null||e==="string"||e==="number"||e==="boolean"||K6(t)||uo(t)}function Q6(t){return J6(t)||q6(t)||G3(t)}function fo(t){return{type:"color",value:t}}function hl(t,e,n){return`${t}_${e}_${n}`}function _l(t){return`texture-${t}`}function A0(t,e){return t+"-"+e}function sn(t){return N3(t)&&Array.isArray(t[1])?t[1][0]:Array.isArray(t)?E0(t)?t:t[0]:t}function Qo(t){if(N3(t)&&Array.isArray(t[1]))return t[1][1];if(Array.isArray(t)&&!E0(t)&&t[1]!==void 0)return t[1]}function Dn(t){if(typeof t=="number"||uo(t))return t;if(t.type==="literalArray"&&uo(t.array))return t.array;throw new Error("Unsupported simple literal expression. Can't resolve.")}function Ml(t,e=0){const n=Number(t);return isNaN(n)?e:n}const H3=fo([0,0,0,0]);function V3(t){return typeof t!="string"?!1:/(#(?:[0-9a-f]{2}){2,4}|#[0-9a-f]{3}|(?:rgba?|hsla?)\((?:\d+%?(?:,|\s)+){2,3}[\s\/]*[\d\.]+%?\))/i.test(t)}function Cc(t){return!!t&&typeof t=="object"&&t.type==="color"}function C0(t){return!!t&&typeof t=="object"&&t.type==="gradient-color"}function Os(t){const e=t.toLowerCase();let n=H3;switch(e[0]){case"#":n=tM(e);break;case"h":n=nM(e);break;case"r":n=iM(e);break}return n}function eM(t){return t.length<7?t[0]+t[1]+t[1]+t[2]+t[2]+t[3]+t[3]+(t.length===5?t[4]+t[4]:"ff"):t.length===7?t+"ff":t}function tM(t){if(!new RegExp(`^#[a-f0-9]{${t.length-1}}$`).test(t)||![4,5,7,9].includes(t.length))return H3;const n=eM(t),i=parseInt(n[1]+n[2],16),o=parseInt(n[3]+n[4],16),r=parseInt(n[5]+n[6],16),s=parseInt(n[7]+n[8],16);return fo([i,o,r,s])}function nM(t){const e=j3(t);e[0]/=360,e[1]/=100,e[2]/=100;const[n,i,o]=oM(e[0],e[1],e[2]),r=e[3]!==void 0?e[3]*255:255;return fo([Math.round(n),Math.round(i),Math.round(o),Math.round(r)])}function iM(t){const[e,n,i,o]=j3(t),r=o!==void 0?o*255:255;return fo([Math.round(e),Math.round(n),Math.round(i),Math.round(r)])}function j3(t){return t.split("(")[1].split(")")[0].split(",").map(n=>parseFloat(n))}function kh(t,e,n){return n<0&&(n+=1),n>1&&(n-=1),n<1/6?t+(e-t)*6*n:n<1/2?e:n<2/3?t+(e-t)*(2/3-n)*6:t}function oM(t,e,n){if(e===0)return[n*255,n*255,n*255];const i=n<.5?n*(1+e):n+e-n*e,o=2*n-i;return[kh(o,i,t+1/3)*255,kh(o,i,t)*255,kh(o,i,t-1/3)*255]}function Rh(t){let e="",n=0;for(;n<t.length;){let i=t[n++];if(i>127){if(i>191&&i<224){if(n>=t.length)return console.error("Incomplete 2-byte sequence"),e;i=(i&31)<<6|t[n]&63}else if(i>223&&i<240){if(n+1>=t.length)return console.error("Incomplete 3-byte sequence"),e;i=(i&15)<<12|(t[n]&63)<<6|t[++n]&63}else if(i>239&&i<248){if(n+2>=t.length)return console.error("Incomplete 4-byte sequence"),e;i=(i&7)<<18|(t[n]&63)<<12|(t[++n]&63)<<6|t[++n]&63}else return console.error(`Unknown multibyte start 0x${i.toString(16)} at index ${n-1}`),e;++n}if(i<=65535)e+=String.fromCharCode(i);else if(i<=1114111)i-=65536,e+=String.fromCharCode(i>>10|55296),e+=String.fromCharCode(i&1023|56320);else return console.error(`Code point 0x${i.toString(16)} exceeds UTF-16 reach`),e}return e}function rM(t){return Math.floor(t/256)}const dv=new Set;function zh(t){console.group("Gltf model error"),console.warn("Stage:",t.layer),t.message&&console.warn("Message:",t.message),t.originalError&&(console.groupCollapsed("Original error"),console.warn(t.originalError),console.groupEnd()),console.groupEnd()}function $3(t){ct(`Got an empty response from the "${t}" tile generation.`)}function ct(t){dv.has(t)||(console.log(t),dv.add(t))}const sM=2166136261,aM=16777619;function lM(t,e){let n=sM;for(const i of e)n=n^i,n=n*aM;t.randomSeed=Math.abs(n)}function gf(t,e,n){let i=.5;return t.randomSeed?(t.randomSeed=t.randomSeed*16807%2147483647,i=(t.randomSeed-1)/2147483646):ct("Resolve 'random': random seed is absent, the mean value between start and end will be used."),i*(n-e)+e}function cM(t=128){const e=[],n=[];for(let i=0;i<t;i++)e.push(uv(i,2)),n.push(uv(i,3));return{base2:e,base3:n}}function uv(t,e){let n=0,i=1/e;for(;t>0;)n=n+i*(t%e),t=Math.floor(t/e),i=i/e;return n}function dM(t,e){const n=[];for(let i=0;i<e;i++){const o=gf(t,0,2*Math.PI),r=Math.acos(gf(t,0,2)-1),s=Math.sin(r)*Math.cos(o),a=Math.sin(r)*Math.sin(o),l=Math.cos(r);n.push(yt(s,a,l))}return n}var Fn=(t=>(t[t.Uniform=1]="Uniform",t[t.Labeling=2]="Labeling",t[t.Generator=3]="Generator",t))(Fn||{});const wn=-1;var Ds=(t=>(t.global="global",t.none="none",t))(Ds||{}),Vo=(t=>(t[t.Pixels=0]="Pixels",t[t.Meters=1]="Meters",t))(Vo||{});const W3="bottomCenter";function In(t,e){for(const n in e)e[n]!==void 0&&(t[n]=e[n])}function uM(t){const n={color:"#000000",textureImage:"",textureSize:16,textureOpacity:1,strokeColor:"#00000000",strokeWidth:1,visibility:"visible"};if(In(n,t),t.strokeColor===void 0&&!n.textureImage&&(n.strokeColor=n.color),!Array.isArray(n.textureSize)||n.textureSize[0]==="step"||n.textureSize[0]==="literal")return n;if(!n.textureSize.length)n.textureSize=16;else if(uo(n.textureSize))n.textureSize.length===1&&(n.textureSize=n.textureSize[0]);else return n;return n}function fM(t){const n={color:"#000000",textureImage:"",textureSize:16,textureOpacity:1,strokeColor:"#00000000",strokeWidth:1,nearCameraFade:2500,visibility:"visible",elevation:0};if(In(n,t),t.strokeColor===void 0&&!n.textureImage&&(n.strokeColor=n.color),!Array.isArray(n.textureSize)||n.textureSize[0]==="step"||n.textureSize[0]==="literal")return n;if(!n.textureSize.length)n.textureSize=16;else if(uo(n.textureSize))n.textureSize.length===1&&(n.textureSize=n.textureSize[0]);else return n;return n}function hM(t){const e={iconImage:"",color:"#FFFFFF",rotation:0,width:1,visibility:"visible"};return In(e,t),t.height===void 0&&(e.height=e.width),e}function _M(t){const e={topColor:"#000000",strokeColor:"#000000",strokeWidth:1,sideColor:"#000000",sideStrokeColor:"#000000",height:["mappoints-to-meters",["get","db_height"]],nearCameraFade:2500,visibility:"visible"};return In(e,t),t.strokeColor===void 0&&(e.strokeColor=e.topColor),t.sideColor===void 0&&(e.sideColor=e.topColor),t.sideStrokeColor===void 0&&(e.sideStrokeColor=e.sideColor),e}function mM(t){const e={color:"#000000",width:1,shift:0,geometryModifier:["geometry-modifier"],pattern:["pattern","none"],startCap:"round",endCap:"round",withHeight:!1,visibility:"visible"};return In(e,t),e}function pM(t){const e={color:"#000000",strokeColor:"#000000",strokeWidth:1,nearCameraFade:2500,visibility:"visible"};return In(e,t),t.strokeColor===void 0&&(e.strokeColor=e.color),e}function gM(t){const e={sideColor:"#000000",strokeColor:"#000000",strokeWidth:1,sideStrokeColor:"#000000",height:0,visibility:"visible",nearCameraFade:2500};return In(e,t),t.strokeColor===void 0&&(e.strokeColor=e.sideColor),t.sideStrokeColor===void 0&&(e.sideStrokeColor=e.sideColor),e}function vM(t){const e={textField:["get","db_label"],textFont:"Noto_Sans",textColor:"#000000",textFontSize:16,textLetterSpacing:0,textHaloColor:"rgba(0, 0, 0, 0)",textHaloWidth:0,textPriority:0,textLabelingSideMargin:0,textDuplicationSpacing:0,lineEndingOffsets:0,visibility:"visible",labelingGroup:Yr};return In(e,t),e}function yM(t){const e={color:"#000000",lineWidth:2,lineLength:10,tipWidth:1.5,tipHeight:2,roundingRadius:0,priority:0,duplicationSpacing:0,endingOffsets:0,visibility:"visible",labelingGroup:Yr};return In(e,t),e}function bM(t){const e={color:"#000000",gapColor:"#00000000",width:1,shift:0,gapLength:1,dashLength:1,geometryModifier:["geometry-modifier"],withHeight:!1,visibility:"visible"};return In(e,t),e}function wM(t){const e={color:"#000000",width:1,shift:0,visibility:"visible"};return In(e,t),e}function xM(t){const e={color:"#ffffff",strokeColor:"#3388ff",strokeColor2:"#00000000",width:20,strokeWidth:3,strokeWidth2:0,visibility:"visible"};return In(e,t),e}function SM(t){const e={allowOverlap:!1,allowElevation:!1,elevation:NaN,iconOpacity:1,iconImage:"",iconAnchor:[.5,.5],iconOffset:[0,0],iconWidth:16,iconTextField:["get","db_label2"],iconTextFont:"",iconTextAnchor:[.5,.5],iconTextOffset:[0,0],iconTextColor:"#000000",iconTextFontSize:16,iconTextLineHeight:1.2,iconTextLetterSpacing:0,iconTextPadding:[0,0,0,0],iconTextHaloWidth:0,iconTextHaloColor:"rgba(0, 0, 0, 0)",iconPriority:0,iconRotation:0,iconLabelingGroup:Yr,iconLabelingMargin:{topBottom:0,leftRight:0},textField:[["get","db_label"],["get","db_label2"]],textFont:"",textColor:"#000000",textFontSize:16,textLineHeight:1.2,textLetterSpacing:0,textPlacement:W3,textOffset:0,textHaloColor:"rgba(0, 0, 0, 0)",textHaloWidth:0,textLabelingMargin:{topBottom:0,leftRight:0},textPriority:0,textMaxLengthPerLine:30,visibility:"visible",textLabelingGroup:Yr,duplicationSpacing:100,endingOffsets:0};return In(e,t),e}function MM(t){const e={color:"#000000",strokeColor:"#000000",lineWidth:1,strokeWidth:0,tipWidth:1,tipHeight:1,roundingRadius:3,animation:{type:"appearance",tipMovementAmplitude:0},visibility:"visible"};return t.strokeColor===void 0&&(e.strokeColor=e.color),In(e,t),e}function TM(t){const e={opacity:1,visibility:"visible"};return In(e,t),e}function IM(t){return ts(t,{color:["interpolate",["linear"],["heatmap-density"],0,"rgba(53, 136, 253, 0)",.2,"rgba(53, 136, 253, 0.2)",.4,"rgb(255, 201, 77)",.6,"rgb(255, 202, 20)",.75,"rgb(245, 0, 7)",1,"rgb(255, 0, 0)"],radius:30,opacity:1,intensity:1,weight:1,downscale:1,visibility:"visible"})}function EM(t){return ts(t,{shadingIntensity:["interpolate",["linear"],["zoom"],12,0,14.5,.7],verticalScale:1,shadingPalette:["interpolate",["linear"],["shading-intensity"],0,0,1,1],lightingDirection:322})}function AM(t){return ts(t,{modelSrc:"",offset:0,scale:1,rotation:0,color:"#fff",linkedIds:"",visibility:"visible",colorTextureUvIndex:0,nearCameraFade:2500,ignoreGlobalLighting:!1,showRatio:1,metallic:NaN,roughness:NaN,preventObjectsHiding:!1,lightingModel:"phong",playAnimation:-1})}function CM(t){const e={visibility:"visible",sideColor:"#000000",borderTopColor:"#000000",bottomColor:"#000000",strokeColor:"#000000",strokeWidth:1,debug:!1,thickness:1,borderHeight:0,borderWidth:.3,color:"#000000",nearCameraFade:0,tunnelHeight:5};return In(e,t),t.borderTopColor===void 0&&(e.borderTopColor=e.color),t.strokeColor===void 0&&(e.strokeColor=e.color),t.sideColor===void 0&&(e.sideColor=e.color),t.bottomColor===void 0&&(e.bottomColor=e.color),e}function PM(t){const e={visibility:"visible",sideColor:"#000000",topColor:"#000000",bottomColor:"#000000",strokeColor:"#000000",strokeWidth:1,color:"#ffffff",nearCameraFade:0};return In(e,t),e}function LM(t){return ts(t,{skyColor:"#6EC0FF00",fogColor:"#FAFDFF00",starsIntensity:1})}function FM(t){const e={sources:{sun:{type:"directional",altitude:50,azimuth:230,color:"#FFFFFF",intensity:.2},atmosphere:{type:"ambient",color:"#FFFFFF",intensity:.85}},lightingModes:{[Ds.global]:["sun","atmosphere"]},defaultLightingMode:"global"},n=ts(t??{},e);return n.lightingModes[Ds.none]=[],n}function kM(t){return ts(t??{},{light:{},normal:{},immersive:{}})}const Ts="__overlapped",P0="__commercial",Yr="default",Bh={groups:[Yr,Ts,P0],overlay:[[Yr,Ts]],intersect:[[]]},RM="#F5F2E0",ms=null,fv=[0,0,0];function te(t,e){if(!Bs(t))return t;if(e.allowedExpressions&&!e.allowedExpressions.has(t.type))return ct(`Expression of type ${t.type} is not allowed here`),ms;switch(t.type){case"time":return OM(t,e);case"objectAttr":return UM(t,e);case"coalesce":return DM(t,e);case"all":return zM(t,e);case"any":return BM(t,e);case"featureState":return GM(t,e);case"get":return X3(t,e);case"global":return HM(t,e);case"sourceAttr":return NM(t,e);case"in":return QM(t,e);case"interpolate":return VM(t,e);case"match":return jM(t,e);case"step":return $M(t,e);case"to-boolean":return YM(t,e);case"to-color":return WM(t,e);case"mappoints-to-meters":return ZM(t,e);case"meters-to-pixels":return XM(t,e);case"!":return qM(t,e);case"==":case"!=":return KM(t,e);case">":case"<":case">=":case"<=":return JM(t,e);case"zoom":return e.type==="binder"||e.type==="labeling"?e.styleZoom:e.type==="generator"&&e.tileInfo?e.tileInfo.coords[3]:(ct(`Zoom expression cannot be used in ${e.type} context`),ms);case"distance":if(e.type==="binder"){const i=q.toGeo(e.objectCenter),o=q.scaleFactor(i[1])*He;return Qf(e.objectCenter,e.cameraCenter)/o}else return ct(`Distance expression can't be resolved in the ${e.type} context`),ms;case"height":return 1;case"+":return e8(t,e);case"*":return t8(t,e);case"^":return n8(t,e);case"log10":return i8(t,e);case"random":return o8(t,e);case"literalArray":return r8(t,e);case"literalObject":return{type:"object",value:t.object};case"isBehindObjects":return e.type==="binder"?e.isBehind:(ct(`isBehindObjects expression cannot be used in ${e.type} context`),ms);case"geometry-modifier":return t.modifiers;case"line-pattern":return[t.patternType,...t.parameters.map(i=>te(i,e))];case"precompute":return e.tileData[t.precomputeIndex]??null;case"gltf-animation":return Z3(t,e);case"local-time":return hv(t,e);case"utc-time":return hv(t,e);default:return ct(`Not supported expression type <<${t.type}>> in ${JSON.stringify(t)}`),ms}}function zM(t,e){return t.array.every(n=>te(n,e)===!0)}function BM(t,e){return t.array.some(n=>te(n,e)===!0)}function hv(t,e){const n=Date.now()+ +(e.styleState._customUserTimeOffset||0);if(t.type==="local-time"){const i=t.offset?+(te(t.offset,e)||0)*6e4:0;return n+i}if(t.type==="utc-time"){const i=t.offset?+(te(t.offset,e)||0)*6e4:0;return n+new Date().getTimezoneOffset()*6e4+i}return n}function OM(t,e){const n=i=>{const o=te(t.timeSource,e),r=new Date(+(o||0));return i==="day-minutes-720"?(r.getHours()%12||0)*60+r.getMinutes():r.getTime()};return e.type==="binder"?(e.callBackFn&&e.callBackFn(),Array.isArray(t.format)?t.format.map(i=>n(i)):n(t.format)):n("timestamp")}function DM(t,e){for(const n of t.array){const i=te(n,e);if(i!==null)return i}return null}function NM(t,e){return e.type==="generator"?e.sourceAttrs[t.property]??null:null}function UM(t,e){return e.type==="binder"&&e.dynamicObject&&e.dynamicObject[t.property]||null}function Z3(t,e){const n={type:"animation-options"};return t.options?t.options.forEach((i,o)=>n[o]=te(i,e)):Bs(t)||(n[0]=t),n}function GM(t,e){if(e.type==="generator"){const n=e.featureAttrs[e.tileProps[t.property]]??null;return Number.isNaN(n)?null:n}else throw new Error("Feature state expression can be resolved only in generator context")}function X3(t,e){if(e.type==="generator"){let n=e.tileAttrs[e.tileProps[t.property]]??null;return typeof n=="object"&&n!==null&&!Array.isArray(n)&&(n={type:"object",value:n}),Number.isNaN(n)?null:n}else throw new Error("Get expression can be resolved only in generator context")}function HM(t,e){const n=e.styleState[t.property];return n==null?null:typeof n=="object"&&!Array.isArray(n)?{type:"object",value:n}:n}function VM(t,e){if(t.steps.length===0)return ct("Interpolate expression contains 0 steps, cannot interpolate"),ms;const n=te(t.steps[0].value,e),i=te(t.argument,e);if(typeof i!="number")return ct(`Interpolate value resolved to non-number value: ${i} ${t.argument}`),0;if(Cc(n)){if(Bs(t.argument)&&t.argument.type==="height"){const o={type:"gradient-color",values:[],steps:[]};return t.steps.forEach(r=>{const s=K(r.key,e),a=te(r.value,e);Cc(a)&&!Number.isNaN(s)&&(o.values.push({type:"color",value:a.value}),o.steps.push(s))}),o.steps.length!==2?(ct("Gradient expression must resolve 2 steps"),ms):o}return q3(t,i,e)}return L0(t,i,e)}function jM(t,e){const n=te(t.input,e),i=t.cases.find(o=>o.values.has(n));return te((i==null?void 0:i.output)??t.defaultOutput,e)}function $M(t,e){const n=Number(te(t.value,e)),i=F0(t,n,e)-1;return te(t.steps[i].value,e)}function WM(t,e){const n=te(t.value,e);return V3(n)?Os(n):Cc(n)?n:(console.warn(`Can't resolve expression. Must be color, but got ${n}`),fo([0,0,0,0]))}function ZM(t,e){if(e.type!=="generator"||!e.tileInfo)throw new Error("Выражение `mappoints-to-meters` можно резолвить только в контексте генератора");return te(t.value,e)/(He*_o(e.tileInfo,[0,0]))}function XM(t,e){const n=K(t.value,e);let i,o=n*yi/y0;if(e.type==="generator"){if(!e.tileInfo)return null;i=e.tileInfo.coords[3],o*=_o(e.tileInfo,[0,0])}else i=e.styleZoom;return o*2**(i+1)}function YM(t,e){return!!te(t.value,e)}function qM(t,e){return!te(t.value,e)}function KM(t,e){const n=te(t.leftValue,e),i=te(t.rightValue,e);switch(t.type){case"==":return n===i;case"!=":return n!==i}}function JM(t,e){const n=te(t.leftValue,e);if(n===null)return null;const i=te(t.rightValue,e);if(i===null)return null;switch(t.type){case"<":return n<i;case">":return n>i;case"<=":return n<=i;case">=":return n>=i}}function QM(t,e){const n=te(t.item,e),i=te(t.collection,e);return i===null?!1:typeof i!="object"?(ct(`InExpression second argument resolved to non-object/non-array value: ${i}`),null):Array.isArray(i)?i.some(o=>o===n):G3(i)?i.value.hasOwnProperty(n):(ct(`InExpression second argument resolved incorrectly: ${i}`),null)}function e8(t,e){const n=t.array.map(i=>te(i,e));return uo(n)?n.reduce((i,o)=>i+o,0):(ct(`Resolve AdditionExpression: arguments are not resolved as an array of numbers: ${n}`),null)}function t8(t,e){const n=t.array.map(i=>te(i,e));return uo(n)?n.reduce((i,o)=>i*o,1):(ct(`Resolve MultiplicationExpression: arguments are not resolved as an array of numbers: ${n}`),null)}function n8(t,e){const n=te(t.base,e);if(typeof n!="number")return ct(`Resolve PowExpression: base resolved as non-number value: ${n}`),null;const i=te(t.exponent,e);return typeof i!="number"?(ct(`Resolve PowExpression: exponent resolved as non-number value: ${i}`),null):Math.pow(n,i)}function i8(t,e){const n=te(t.value,e);return typeof n!="number"?(ct(`Resolve Log10Expression: value resolved as non-number value: ${n}`),null):Math.log10(n)}function o8(t,e){const n=te(t.start,e);if(typeof n!="number")return ct(`Resolve RandomizationExpression: start resolved as non-number value: ${n}`),null;const i=te(t.end,e);return typeof i!="number"?(ct(`Resolve RandomizationExpression: end resolved as non-number value: ${i}`),null):i<n?(ct("Resolve RandomizationExpression: end cannot be less than start."),null):gf(e,n,i)}function r8(t,e){return t.array.map(n=>te(n,e))}function L0(t,e,n){const i=F0(t,e,n);if(i===0)return Number(te(t.steps[0].value,n));if(i===t.steps.length)return s8(t,n,e);const o=Number(te(t.steps[i-1].value,n));if(n.type==="labeling"&&n.interpolateExpressionAsStep)return o;const r=K3(t,e,i,n),s=Number(te(t.steps[i].value,n));return(1-r)*o+r*s}function Le(t,e){const n=te(t,e);return Cc(n)?n:C0(n)?n.values[1]:(console.warn(`Can't resolve expression. Must be color, but got ${n}`),fo([0,0,0,0]))}function Y3(t,e){const n=te(t,e);return C0(n)?n:null}function K(t,e,n=NaN){const i=te(t,e);return typeof i=="number"?i:n}function Hn(t,e,n=""){const i=te(t,e);return typeof i=="string"?i:n}function ch(t,e,n=W3){const i=te(t,e);return X6(i)?i:n}function q3(t,e,n){const i=F0(t,e,n);if(i===0)return Le(t.steps[0].value,n);if(i===t.steps.length)return Le(t.steps[t.steps.length-1].value,n);const o=K3(t,e,i,n),r=Le(t.steps[i-1].value,n).value,s=Le(t.steps[i].value,n).value;return fo([r[0]*(1-o)+s[0]*o,r[1]*(1-o)+s[1]*o,r[2]*(1-o)+s[2]*o,r[3]*(1-o)+s[3]*o])}function s8(t,e,n){const i=t.steps[t.steps.length-1],o=t.base;return o===1?K(i.value,e):K(i.value,e)*Math.pow(o,n-K(i.key,e))}function ht(t,e,n,i=!1,o,r,s){return{type:"binder",styleZoom:t,styleState:e,tileData:n,randomSeed:0,isBehind:i,dynamicObject:o,cameraCenter:r??fv,objectCenter:s??fv}}function qr(t,e,n,i){return{type:"labeling",styleZoom:t,styleState:e,interpolateExpressionAsStep:n,randomSeed:0,tileData:i}}function Zo(t,e,n,i,o,r,s){return{type:"generator",styleState:t,tileProps:n,tileAttrs:i,id:r,tileData:[],featureAttrs:o,sourceAttrs:e,randomSeed:0,tileInfo:s}}function F0(t,e,n){let i=0;for(;i<t.steps.length&&!(e<K(t.steps[i].key,n));)i++;return i}function K3(t,e,n,i){const o=t.base,r=K(t.steps[n].key,i)-K(t.steps[n-1].key,i),s=e-K(t.steps[n-1].key,i);return o===1?s/r:(Math.pow(o,s)-1)/(Math.pow(o,r)-1)}function Pt(t){const[e,n,i,o]=t.value;return[((e*o+127)/255>>>0)/255,((n*o+127)/255>>>0)/255,((i*o+127)/255>>>0)/255,o/255]}function yr(t,e,n,i=!1){const o=[];return Ns(o,t,e,n),i?o:Array.from(new Set(o))}function a8(t,e){const n={};return Object.keys(t).forEach(i=>{n[i]=l8(t[i],e)}),n}const Xs=Tm();function _v(t,e){const n=new Float32Array(3);return St(n,1,0,0),zx(Xs),Dx(Xs,Xs,-Be(e-90)),Ox(Xs,Xs,-Be(t)),Sx(n,n,Xs),_n(n,n),q4(n,n),n}function l8(t,e){const n={ambientColorIntensity:new Float32Array(Le(t.ambientColor,e).value.map(i=>i/255)),dir1ColorIntensity:new Float32Array(Le(t.dir1Color,e).value.map(i=>i/255)),dir1Direction:_v(te(t.dir1Altitude,e),te(t.dir1Azimuth,e)),dir2ColorIntensity:new Float32Array(Le(t.dir2Color,e).value.map(i=>i/255)),dir2Direction:_v(te(t.dir2Altitude,e),te(t.dir2Azimuth,e)),shadowLightIndex:t.shadowLightIndex??-1,shadowRadius:t.shadowRadius??1};return n.ambientColorIntensity[3]=te(t.ambientIntensity,e),n.dir1ColorIntensity[3]=te(t.dir1Intensity,e),n.dir2ColorIntensity[3]=te(t.dir2Intensity,e),n}function Ns(t,e,n,i){if(!Bs(e)){t.push(e);return}switch(e.type){case"all":return c8(t,e,n,i);case"match":return d8(t,e,n,i);case"step":return u8(t,e,n,i);case"interpolate":return f8(t,e,n,i);case"precompute":if(i){const o=i.precomputes[e.precomputeIndex].expr;Ns(t,o,n,i);return}break;case"get":{if(!n){console.error("There is no context to resolve the expression. The value from data will not be added to the result.");return}const o=X3(e,n);t.push(o);return}}}function c8(t,e,n,i){e.array.forEach(o=>Ns(t,o,n,i))}function d8(t,e,n,i){Ns(t,e.defaultOutput),e.cases.forEach(o=>Ns(t,o.output,n,i))}function u8(t,e,n,i){e.steps.forEach(o=>Ns(t,o.value,n,i))}function f8(t,e,n,i){e.steps.forEach(o=>Ns(t,o.value,n,i))}const to=4294967295,hr=4294967040,h8=hr-1,Gm={},_8=1e6,mv=["main","parser","labeling","models"];let Oh=0;mv.forEach(t=>{const e=Oh+Math.floor(h8/mv.length);Gm[t]={min:Oh,max:e-_8},Oh=e});class m8{constructor(e){this.ids=[],this.orphanIds=[],this.phases=[],this.sublayers=[],this.styleIds=[],this.layerIds=[],this.instanceIds=[],this.objectClasses=[],this.floorIds=[],this.center=[],this.strings={},this.minIdentifyIndex=Gm[e].min,this.maxIdentifyIndex=Gm[e].max,this.index=this.minIdentifyIndex}getIndex(e,n,i,o={}){const{id:r,tileProps:s,tileAttrs:a}=e,l=i.interactive,c=o.ignoreHover?!1:a[s.hovered],d=c&&i.type!=="polygon3d"||i.type==="embankment";return!!r&&l&&!c&&!d?this.getIndexInternal({id:r,styleId:n,layer:i,sublayer:a[s.db_sublayer],...o}):to}getIndexInternal(e){var r,s,a,l;const n=this.index+this.ids.length;this.ids.push(e.id),this.floorIds.push(e.floorId??""),this.phases.push(e.layer.renderIndex),this.sublayers.push(((s=(r=e.metatile)==null?void 0:r.dictionaries.db_sublayer)==null?void 0:s[e.sublayer])??NaN),this.styleIds.push(e.styleId),this.layerIds.push(e.layer.innerId),this.instanceIds.push(e.instanceId??0);const{center:i,objectClass:o}=e;if(i?this.center.push(Math.round(i[0]),Math.round(i[1])):this.center.push(hf,hf),typeof o=="string"){const c=(l=(a=e.metatile)==null?void 0:a.dictionaries.db_object_class)==null?void 0:l[o];c?this.objectClasses.push(c):(this.objectClasses.push(0),this.strings[n]={objectClass:o})}else this.objectClasses.push(to);return n}addOrphanId(e){this.orphanIds.push(e)}getIndexerStats(){return{ids:this.ids.length,orphanIds:this.orphanIds.length,floorIds:this.floorIds.length,phases:this.phases.length,sublayers:this.sublayers.length,styleIds:this.styleIds.length,layerIds:this.layerIds.length,instanceIds:this.instanceIds.length,objectClasses:this.objectClasses.length,strings:Object.keys(this.strings).length,center:this.center.length}}getPacked(){const e=this.ids,n=this.orphanIds,i=this.floorIds,o=new Float32Array(this.phases).buffer,r=new Uint32Array(this.sublayers).buffer,s=new Uint16Array(this.styleIds).buffer,a=new Uint32Array(this.layerIds).buffer,l=new Uint8Array(this.instanceIds).buffer,c=new Uint32Array(this.objectClasses).buffer,d=new Int32Array(this.center).buffer,u=this.index,f=this.index+this.ids.length-1;this.index=this.index+this.ids.length,this.index>this.maxIdentifyIndex&&(this.index=this.minIdentifyIndex);const h=this.strings;return this.ids=[],this.orphanIds=[],this.floorIds=[],this.phases=[],this.sublayers=[],this.styleIds=[],this.layerIds=[],this.instanceIds=[],this.objectClasses=[],this.strings={},this.center=[],{idBuffer:e,orphanIds:n,floorIdBuffer:i,startIndex:u,endIndex:f,phaseBuffer:o,sublayerBuffer:r,styleIdBuffer:s,layerIdBuffer:a,instanceIdBuffer:l,objectClassBuffer:c,centerBuffer:d,strings:h}}}var Us=(t=>(t[t.Static=0]="Static",t[t.Unique=1]="Unique",t[t.Loaded=2]="Loaded",t))(Us||{});const p8=1e4;let J3=p8+1;const g8={w:0,h:0,x:0,y:0,atlasIndex:0,isPacked:!1},Dh={};function v8(t,e,n,i,o,r){const s=A0(t,o);if(!Dh[s]){const a=J3++;Dh[s]={type:Us.Unique,isSvg:!1,index:a,key:s,name:"",fileName:"",id:t,regionId:n,url:r,rasters:e.map((l,c)=>({...g8,rasterSetIndex:a,rasterIndex:c,w:l,h:l,anchorX:i[0],anchorY:i[1]}))}}return Dh[s]}function y8(t){const e=J3++;return{type:Us.Loaded,isSvg:!1,index:e,key:`loaded-${e}`,name:"",fileName:"",rasters:t.map((n,i)=>({...n,rasterIndex:i,rasterSetIndex:e}))}}function ml(t,e,n){let i,o=1/0;for(let r=0;r<t.length;r++){const s=t[r];if(n&&!s.isPacked)continue;const a=Math.abs(s.w-e);a<o&&(i=r,o=a)}return i}function pv(t,e,n){return Zc(n.fontUrlTemplate,{name:t,range:String(e)})}function vf(t,e,n){const i=Vr(t)?t:vs(e.iconBaseUrl,t);return Zc(i,{subdomain:n,appHost:window.location.host})}function b8(t,e){return Vr(t)?t:vs(e.modelsBaseUrl,t)}function w8(t,e,n){return Vr(t)||!e?t:I8(e)?Ya(e,{modelSrc:t,subdomain:A3(n)}):vs(e,t)}function Q3(t,e,n){return t.replace("image",`image_${e}x${n}`)}const e5=/_i$/;function x8(t){return e5.test(t)}function S8(t){return t.replace(e5,"")}function M8(t,e){const n=Vr(e.fontsPath)?e.fontsPath:vs(e.rootUrl,e.fontsPath),i="{name}_{range}.pbf";t.fontUrlTemplate=vs(n,i),t.iconBaseUrl=Vr(e.iconsPath)?e.iconsPath:vs(e.rootUrl,e.iconsPath),t.modelsBaseUrl=Vr(e.modelsPath)?e.modelsPath:vs(e.rootUrl,e.modelsPath)}const T8=new RegExp("^(?:(?:[a-z]+:)?(?:[a-z]+:)?//|data:)","i");function Vr(t){return T8.test(t)}function I8(t){return/{\w+}/g.test(t)}function vs(...t){const e=t.filter(i=>i.length>0);let n=e[0];for(let i=1;i<e.length;i++){n[n.length-1]!=="/"&&(n+="/");const o=e[i];o[0]==="/"?n+=o.slice(1):n+=o}return n}function t5(t,e,n){const i=Dn(n.style.iconAnchor),o=hl(t,i[0],i[1]);return e.rasterSets.byKey[o]}function E8(t,e,n,i){const o=e.icons[n.name];if(!o)return;const r=ml(n.rasters,i*window.devicePixelRatio,!0);if(r===void 0)return;const s=vf(o.url,e,za(t.map.state.subdomains,n.name)),{w:a,h:l}=n.rasters[r];return{fullUrl:s,width:a,height:l}}function A8(t,e,n,i){const o=S8(i),r=t5(o,e,n);if(!r)return;const s=e.icons[r.name];if(s)return vf(s.url,e,za(t.map.state.subdomains,r.name))}function C8(t,e,n){const i=t.styleManager.getStyle(t.map.state.handyStyleId);if(!i)return;const o=i.layersById[e.layerId];if(!o)return;const r=ht(t.map.state.styleZoom,t.map.state.styleState,[]);let s;const a=o.style.iconWidth,l=K(a,r);if(n.isCommercial){s=i.rasterSets.byKey[A0(e.id,"commercial")];const f=s.url;if(!f)return;const h=ml(s.rasters,l*window.devicePixelRatio,!0);if(h===void 0)return;const{w:_,h:p}=s.rasters[h],m=Q3(f,_,p);return{baseUrl:f,fullUrl:m,width:_,height:p}}const c=o.style.iconImage;if(!c)return;const d=Hn(c,r);if(s=t5(d,i,o),!s)return;const u=E8(t,i,s,l);if(u){if(x8(d)){const f=A8(t,i,o,d);f!==void 0&&(u.fullUrlUnhovered=f)}return u}}function P8(t){return Array.isArray(t)?t:[t]}function L8(t){return t&&t.buffer instanceof ArrayBuffer}var Yi=(t=>(t[t.None=0]="None",t[t.Zoom=1]="Zoom",t[t.Distance=2]="Distance",t))(Yi||{}),ic=(t=>(t[t.default=0]="default",t[t.flat=1]="flat",t[t.axis=2]="axis",t[t.centroid=3]="centroid",t))(ic||{});const Fo=[0,0,0],gc=new Int16Array([0,0,0]),On=new Array(16),Hm=new Float32Array(9),Is=[0,0,0],Nh=[0,0,0],Uh=[0,0,0],dd=[0,0,0],F8=Ke(),k8=mr([1,1,1]),Ni={symbol:"gltfModel",sinks:{instances:{stride:64,binder:(t,e)=>{t.views.flatPosition=new Uint16Array(e),t.views.ecefPosition=new Int16Array(e,8),t.views.matrix=new Float32Array(e,16),t.views.localID=new Uint32Array(e,52),t.views.labelingTextureID=new Uint32Array(e,56),t.views.absZ=new Float32Array(e,60)},packObjectAttributes(t,e,n,i,o,r,s,a,l=[],c,d,u,f){return Dt([t,e.innerId,n,l,a,r,i,o,c,d,u,f],e,s)},unpackObjectAttributes(t){return{styleId:t[0],layerId:t[1],modelIndices:t[2],lngLat:t[3],emitShowHideEvents:t[4],sourceId:t[5],modelStepValues:t[6],modelStepSource:t[7],parentId:t[8],absZ:t[9],floorId:t[10],subkey:t[11],tileData:t.slice(12)}}}},generateInstances(t,e,n,i,o,r,s,a,l,c,d=0){const u=te(n.style.linkedIds,i),f=u===""?[]:P8(u),h=n.style.modelSrc,_=[];let p=Yi.None;const m=yr(h,i,n,!0);if(m.length===1)_.push(0);else if(m.length>1){if(!Bs(h)||h.type!=="step"||!Bs(h.value)){console.error(`Only step-expression is allowed as 'modelSrc' style property. Models won't be displayed for layer ${n.id}`);return}switch(h.value.type){case"zoom":p=Yi.Zoom;break;case"distance":p=Yi.Distance;break;default:console.error(`'${h.value.type}' type in 'modelSrc' step expression is not supported. Only 'zoom' and 'distance' are supported. Models won't be displayed for layer ${n.id}`);return}h.steps.forEach(({key:S})=>{_.push(S)})}p===Yi.Distance&&m.reverse(),m.forEach((S,A)=>{S===null&&A!==0&&(m[A]=m[A-1])}),p===Yi.Distance&&m.reverse();const g=m.map(S=>S===null?"":S).map(S=>{let A=e.modelIndex[S];return A===void 0&&(S=w8(S,a??"",r.coords),A=t.addUsedModelByUrl(S)),t.addUsedModel(A),A}),{tileProps:y,tileAttrs:b}=i;let v=hr;n.interactive?i.id&&(v=b[y.hovered]?to:t.idIndexer.getIndex(i,e.id,n,{metatile:c,objectClass:b[y.db_object_class]})):v=n.interactiveOcclusion?hr:to;const T=i.id??"-1",x=b[y.db_point_building_id];let I=hr;i.id&&(I=t.pointIndexer.getIndex(x??i.id));const E=l!=null&&l.has(b[y.db_sublayer])&&T!=="-1"?1:0,L=t.getBucket("gltfModel","instances",Ni.sinks.instances.packObjectAttributes(e.id,n,g,_,p,s,i,E,E?Ac(o.x[0],o.y[0],r):void 0,x,!!o.abs_z,y.db_plan_id?b[y.db_plan_id]:"",W6(r,o.x[0],o.y[0],d)),Ni.sinks.instances.binder);let N=L.meta;if(N)N.linkedIds.push(...f);else{const S=y.db_plan_id?b[y.db_plan_id]:void 0;N=L.meta={linkedIds:f.slice(),modelsPath:a??"",buildingId:T,planId:S}}E&&(N.sublayer=b[y.db_sublayer]),x&&(N.childrenIds||(N.childrenIds=[]),N.childrenIds.push(T));let k;const w=B8(b,i);if(w){const S=o.x[0],A=o.y[0],z=[0,0,0];Sr(z,[S,A],r),k=[z,q.fromGeo(w)]}for(let S=0;S<o.x.length;S++){const A=o.abs_z&&o.abs_z[S];St(Nh,0,0,0),Wi(te(n.style.rotation,i),Nh),St(Is,1,1,1),Wi(te(n.style.scale,i),Is),St(Uh,0,0,0),Wi(te(n.style.offset,i),Uh),gv(o.x[S],o.y[S],0,Uh,Is,Nh,k,r,n.minzoom<$o.globeMaxZoom),O8(L,Fo,gc,Hm,v,I,A)}},patchBuffer(t,e,n,i,o,r,s,a,l){const c=Ni.sinks.instances.stride*n;gv(o[0],o[1],o[2],r,s,a,void 0,i,l),Fo[0]+=Y,Fo[1]+=Y,Fo[2]=$n(Fo[2]),e.subData(t,c+0,new Uint16Array(Fo)),l&&e.subData(t,c+8,gc),e.subData(t,c+16,Hm)}};function R8(t,e,n,i){const o=n*Se/Nt(i.coords[2]);Gn(e,e,o),e[2]*=n,jt(t,t,e)}function gv(t,e,n,i,o,r,s,a,l){St(Fo,t,e,n);const c=_o(a,Fo)*He;if(p0(On),t3(On,On,Be(r[2])),e3(On,On,Be(r[1])),Im(On,On,Be(r[0])),Mc(On,On,o),s?z8(On,s[0],s[1]):(St(Is,c,c,c),Mc(On,On,Is)),Im(On,On,Math.PI/2),Ax(Hm,On),R8(Fo,i,c,a),l){const d=I0(a,Fo);gc[0]=d[0]*Vn,gc[1]=d[1]*Vn,gc[2]=d[2]*Vn}}function z8(t,e,n){ti(dd,n,e),t3(t,t,Math.atan2(dd[1],dd[0]));const i=_0(dd);St(Is,i,i,i),Mc(t,t,Is)}function B8(t,e){const n=t[e.tileProps.direction];return n===void 0?null:Array.isArray(n)?n:n.type==="Point"?n.coordinates:null}function O8(t,e,n,i,o,r,s){const a=t.elements.offset*Ni.sinks.instances.stride,l=t.views,c=a/l.flatPosition.BYTES_PER_ELEMENT,d=Y+e[0],u=Y+e[1],f=$n(e[2]);if(l.flatPosition[c]=d,l.flatPosition[c+1]=u,l.flatPosition[c+2]=f,l.ecefPosition[c]=n[0],l.ecefPosition[c+1]=n[1],l.ecefPosition[c+2]=n[2],t.elements.offset>t.elements.maximum-1)return;l.matrix.set(i,a/l.matrix.BYTES_PER_ELEMENT),l.localID[a/l.localID.BYTES_PER_ELEMENT]=o,l.labelingTextureID[a/l.labelingTextureID.BYTES_PER_ELEMENT]=r,s!==void 0&&(l.absZ[a/l.absZ.BYTES_PER_ELEMENT]=s),D8(t,d,u,f,i);const h=t.indices;h.buffer[h.offset]=t.elements.offset,h.offset++,t.elements.offset++}function D8(t,e,n,i,o){const r=t.extents;e<r[0]&&(r[0]=e),n<r[1]&&(r[1]=n),i<r[2]&&(r[2]=i),e>r[3]&&(r[3]=e),n>r[4]&&(r[4]=n),i>r[5]&&(r[5]=i);const s=F8;xS(o,s);const a=mr(s)/k8;a>t.maxDiag&&(t.maxDiag=a)}var ri=(t=>(t[t.Tile=0]="Tile",t[t.Custom=1]="Custom",t))(ri||{});class N8{constructor(e){this._enable=!1,this.name=e.name,this.index=e.index,this.location=e.location!==void 0?e.location:-1,this.locationsCount=e.locationsCount??1,n5(this.locationsCount)}bindLocation(e,n){return this.location!==-1&&this.index!==!0&&e.bindAttribLocation(n,this.location,this.name),this}getLocation(e,n){return this.location===-1&&this.index!==!0&&(this.location=e.getAttribLocation(n,this.name)),this}bind(e,n){if(!this._enable&&this.index!==!0){for(let i=0;i<this.locationsCount;i++)e.enableVertexAttribArray(this.location+i);this._enable=!0}return n.bind(e,this.location,void 0),this}disable(e){if(this._enable&&this.index!==!0){for(let n=0;n<this.locationsCount;n++)e.disableVertexAttribArray(this.location+n);this._enable=!1}return this}}function n5(t){if(t<0||t>4)throw new Error("[2gl] Invalid attribute location count. Must be 1, 2, 3 or 4")}const Ae=class Ae{constructor(e,n,i=!1,o=!1){this.elementsType=null,this.isDirty=!0,this._glBuffer=null,this._glContext=null,this._initData=e,this.byteLength=e.byteLength,this.type=i?Ae.ElementArrayBuffer:Ae.ArrayBuffer,this.options=Object.assign({},Ae.defaultOptions,n),this.drawType=(n==null?void 0:n.drawType)??Ae.StaticDraw;const r=[Ae.UnsignedByte,Ae.UnsignedShort,Ae.UnsignedInt];i&&!r.includes(this.options.dataType)&&(console.warn("Please provide dataType of one of the following values:Buffer.UnsignedByte, Buffer.UnsignedShort, Buffer.UnsignedInt. Defaulting to UnsignedInt"),this.options.dataType=Ae.UnsignedInt),this._preserveData=o}static _dataTypeSize(e){switch(e){case Ae.Byte:case Ae.UnsignedByte:return 1;case Ae.UnsignedShort:case Ae.Short:return 2;case Ae.Float:case Ae.Int:case Ae.UnsignedInt:return 4}throw new Error(`[2gl] Unsupported Buffer data type: ${String(e)}`)}memSizeJs(){var e;return((e=this._initData)==null?void 0:e.byteLength)??0}memSizeGPU(){return this.byteLength}bind(e,n,i,o,r){if(this._glBuffer||this.prepare(e),this.type===Ae.ArrayBuffer){e.bindBuffer(e.ARRAY_BUFFER,this._glBuffer),n=n||0,i=i||this.options,r=r??1,n5(r);const s=this._toGlParam(e,i.dataType)||e.FLOAT;if(r===1)e.vertexAttribPointer(n,i.itemSize,s,i.normalized,i.stride,i.offset),this.bindVertexAttribDivisor(e,n,i,o);else{const a=Ae._dataTypeSize(i.dataType);for(let l=0;l<r;l++)e.vertexAttribPointer(n+l,r,s,i.normalized,i.stride,i.offset+l*r*a),this.bindVertexAttribDivisor(e,n+l,i,o)}}else this.type===Ae.ElementArrayBuffer&&e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this._glBuffer);return this}remove(){return this._unprepare(),this}subData(e,n,i){this._glBuffer||this.prepare(e);const o=this._toGlParam(e,this.type)||e.ARRAY_BUFFER;return e.bindBuffer(o,this._glBuffer),e.bufferSubData(o,n,i),this}replaceData(e){e&&(this._initData=e),this.isDirty=!0}commitData(e){const n=this._toGlParam(e,this.type)||e.ARRAY_BUFFER,i=this._toGlParam(e,this.drawType)||e.STATIC_DRAW;e.bindBuffer(n,this._glBuffer),e.bufferData(n,this._initData,i),this.isDirty=!1}prepare(e){return this._glContext=e,this._glBuffer=e.createBuffer(),this.commitData(e),this._preserveData||(this._initData=null),this}getGLType(e){return this._toGlParam(e,this.options.dataType)}getData(){return this._initData}_unprepare(){this._glBuffer&&this._glContext&&this._glContext.deleteBuffer(this._glBuffer),this._glBuffer=null,this._glContext=null,this._initData=null,this.isDirty=!1}_toGlParam(e,n){return n===Ae.ArrayBuffer?e.ARRAY_BUFFER:n===Ae.ElementArrayBuffer?e.ELEMENT_ARRAY_BUFFER:n===Ae.StaticDraw?e.STATIC_DRAW:n===Ae.DynamicDraw?e.DYNAMIC_DRAW:n===Ae.Byte?e.BYTE:n===Ae.Short?e.SHORT:n===Ae.Int?e.INT:n===Ae.Float?e.FLOAT:n===Ae.UnsignedByte?e.UNSIGNED_BYTE:n===Ae.UnsignedShort?e.UNSIGNED_SHORT:n===Ae.UnsignedInt?e.UNSIGNED_INT:null}_hasRealWebGLContext(){return typeof window<"u"&&("WebGLRenderingContext"in window||"WebGL2RenderingContext"in window)}bindVertexAttribDivisor(e,n,i,o){i.instanceDivisor&&this._hasRealWebGLContext()&&(e instanceof WebGLRenderingContext?o?o.vertexAttribDivisorANGLE(n,i.instanceDivisor):console.error("Can't set up instanced attribute divisor. Missing ANGLE_instanced_arrays extension"):e.vertexAttribDivisor(n,i.instanceDivisor))}};Ae.ArrayBuffer=1,Ae.ElementArrayBuffer=2,Ae.StaticDraw=10,Ae.DynamicDraw=11,Ae.Float=20,Ae.UnsignedByte=21,Ae.UnsignedShort=22,Ae.UnsignedInt=23,Ae.Byte=24,Ae.Short=25,Ae.Int=26,Ae.defaultOptions={itemSize:3,dataType:Ae.Float,stride:0,offset:0,normalized:!1,instanceDivisor:0,drawType:Ae.StaticDraw};let F=Ae;function i5(t){if(t===void 0)return;const e=window.WebGLRenderingContext,i={[e.UNSIGNED_BYTE]:F.UnsignedByte,[e.UNSIGNED_SHORT]:F.UnsignedShort,[e.UNSIGNED_INT]:F.UnsignedInt,[e.BYTE]:F.Byte,[e.SHORT]:F.Short,[e.INT]:F.Int,[e.FLOAT]:F.Float}[t];return i===void 0?(console.error(`Cannot translate ${t} gltf componentType`),NaN):i}var Es=(t=>(t[t.Striped=1]="Striped",t[t.Entrance=2]="Entrance",t[t.Patterned=3]="Patterned",t))(Es||{}),Pc=(t=>(t[t.Line=0]="Line",t[t.Arrow=1]="Arrow",t[t.StartBorder=2]="StartBorder",t[t.LineEnding=3]="LineEnding",t))(Pc||{}),mt=(t=>(t[t.TileCut=0]="TileCut",t[t.Butt=1]="Butt",t[t.Round=2]="Round",t))(mt||{});const un=Et(),ud=Et(),Ys=Et(),Tr=Et(),Tl=Et(),er=Et(),Gh=Et(),Ti=Et();let ga=0,Ir=0;function o5(t,e,n,i,o,r,s,a,l,c){if(!(o<2)){if(Wo(un,e[0],n[0],e[1],n[1]),ga=0,r===mt.Round){const d=l!==void 0?l[0]:0,u=c!==void 0?c[0]:0;Vm(t,e[0],n[0],(i==null?void 0:i[0])??0,-un[0],-un[1],d,u,a)}for(let d=1;d<o;d++)U8(t,e,n,i,d,o,a,l,c);if(s===mt.Round){const d=l!==void 0?l[o-1]:0,u=c!==void 0?c[o-1]:0;Vm(t,e[o-1],n[o-1],(i==null?void 0:i[o-1])??0,un[0],un[1],d,u,a)}}}function U8(t,e,n,i,o,r,s,a,l){const c=o===r-1;if(Yt(Tl,e[o-1],n[o-1]),Yt(er,e[o],n[o]),a!==void 0&&l!==void 0?(Yt(Ys,a[o-1],l[o-1]),Yt(Tr,a[o],l[o])):(Yt(Ys,0,0),Yt(Tr,0,0)),Zr(Ti,un),c)Ir=0;else{Yt(Gh,e[o+1],n[o+1]),Wo(ud,er[0],er[1],Gh[0],Gh[1]);const f=Ve(Ls(un,ud),-1,1);if(f<=0)Ir=0,Vm(t,er[0],er[1],(i==null?void 0:i[o])??0,un[0],un[1],Tr[0],Tr[1],s);else{const _=Math.sqrt((1-f)/(1+f)),p=oh(Ls(Ti,ud));Ir=_*p}}G8(t,0,1,3,3,1,2);const d=Ti[0]*Bt,u=Ti[1]*Bt;ys(t,Tl[0],Tl[1],(i==null?void 0:i[o-1])??0,(Ti[0]+un[0]*ga)*Bt,(Ti[1]+un[1]*ga)*Bt,d,u,Ys[0],Ys[1],s),ys(t,Tl[0],Tl[1],(i==null?void 0:i[o-1])??0,(-Ti[0]-un[0]*ga)*Bt,(-Ti[1]-un[1]*ga)*Bt,-d,-u,Ys[0],Ys[1],s),ys(t,er[0],er[1],(i==null?void 0:i[o])??0,(-Ti[0]+un[0]*Ir)*Bt,(-Ti[1]+un[1]*Ir)*Bt,-d,-u,Tr[0],Tr[1],s),ys(t,er[0],er[1],(i==null?void 0:i[o])??0,(Ti[0]-un[0]*Ir)*Bt,(Ti[1]-un[1]*Ir)*Bt,d,u,Tr[0],Tr[1],s),c||(h0(un,ud),ga=Ir)}function Vm(t,e,n,i,o,r,s,a,l){H8(t,0,1,2);const c=-o*.01,d=-r*.01;ys(t,e,n,i,o+c,r+d,o,r,s,a,l),ys(t,e,n,i,-r+c,o+d,-r,o,s,a,l),ys(t,e,n,i,r+c,-o+d,r,-o,s,a,l)}function ys(t,e,n,i,o,r,s,a,l,c,d){const u=t.elements.offset*t.elements.stride,f=u>>1,h=u>>2;t.views.position[f]=Y+e,t.views.position[f+1]=Y+n,t.views.extender[u]=o*127,t.views.extender[u+1]=r*127,t.views.normal[u]=s*127,t.views.normal[u+1]=a*127,"height"in t.views&&(t.views.height[h]=i),"shift"in t.views&&(t.views.shift[h]=l,t.views.shift[h+1]=c),"localID"in t.views&&(t.views.localID[h]=d),t.elements.offset++}function G8(t,e,n,i,o,r,s){const a=t.indices.buffer,l=t.indices.offset,c=t.elements.offset;a[l]=c+e,a[l+1]=c+n,a[l+2]=c+i,a[l+3]=c+o,a[l+4]=c+r,a[l+5]=c+s,t.indices.offset=l+6}function H8(t,e,n,i){const o=t.indices.buffer,r=t.indices.offset,s=t.elements.offset;o[r]=s+e,o[r+1]=s+n,o[r+2]=s+i,t.indices.offset=r+3}const V8={x:0,y:1};function j8(t){const e={};for(const n in t)t[n]&&(e[n]=Array.from(t[n]));return e}function Il(t,e){for(const n in t){const i=V8[n];i!==void 0?t[n].push(e[i]):t[n].push(NaN)}}function $8(t,e,n,i){if(isNaN(t.step)||isNaN(t.width))return n;const{tileProps:o,tileAttrs:r}=i,s=_o(e,[0,0]),a=Se/Nt(e.coords[2])*He*s;let l=t.step*a;if(isNaN(l)&&(l=0),l===0)return n;const c=t.width*a,d={},u=n.x,f=n.y,h=u.length;for(const E in n)d[E]=[];let _=0;const p=[_];for(let E=1;E<h;E++)_+=Ur([u[E-1],f[E-1]],[u[E],f[E]]),p.push(_);const m=Et(),g=Et(),y=[0,0],b=Math.abs(_/Math.trunc(_/l)),v=[u[0],f[0]];let T=(t.stopLines?1:-1)*Math.sign(t.width),x=0,I=0;for(Il(d,v),t.stopLines&&!r[o.beginningIsCut]&&(Wo(m,u[I],f[I],u[I+1],f[I+1]),Zr(g,m),Gn(y,g,T*c),Qi(v,v,y),Il(d,v),x+=b/2,T=-T);x<=_;){for(;x>p[I+1];)I++;if(Wo(m,u[I],f[I],u[I+1],f[I+1]),Zr(g,m),T>0)Gn(y,g,T*c),Qi(v,v,y),Gn(y,m,b/2),Qi(v,v,y),Il(d,v);else{const E=Math.min(1,(x-p[I])/(p[I+1]-p[I]));Z4(v,[u[I],f[I]],[u[I+1],f[I+1]],E),Il(d,v)}T=-T,x+=b/2}return t.stopLines&&!r[o.endingIsCut]&&(Gn(y,g,T*c),Qi(v,v,y),Il(d,v)),d}function jm(t,e,n,i){if(!W8(t)||t.length===0)return n;let o=j8(n);for(const r of t){if(typeof r!="object"||!r)return console.warn(`Wrong value ${r} in modifiers list.`),null;if(!("type"in r))return console.warn(`Wrong value ${r} in modifiers list.`),null;switch(r.type){case"zigzag-modifier":o=$8(r,e,o,i);break;default:return console.warn(`Expression with type ${r.type} cannot be used as geometry modifier.`),null}if(o===null)return null}return o}function W8(t){return!!t&&Array.isArray(t)}const so=1,ao=-1,Vi=[.5,.5],Li=[.5,.5],dt=[.5,.5],qs=[.5,.5],Hh=[0,0];let fi,rt,lt,ut=0,hi=0,fn=0,zn=0;const Z8={x:0,y:0,z:0,xn2:0,yn2:0,xn1:0,yn1:0,patternedLine:!1,noTurn:!0,leftTurn:!1,sharpTurn:!1,reverseTurn:!1,extender:[.5,.5],faExtender:[.5,.5],saExtender:[.5,.5]},X8=1-1e-4,Y8=0,vv=-.9;function q8(t,e,n,i,o,r,s,a){const l=Z8;l.x=t,l.y=e,l.z=n,l.xn2=i,l.yn2=o,l.xn1=r,l.yn1=s,l.patternedLine=a;const c=i*r+o*s;return l.noTurn=c>X8,l.leftTurn=i*-s+o*r<0,l.sharpTurn=c<Y8&&c>vv,l.reverseTurn=c<vv,l}function k0(t,e,n,i,o,r,s,a,l,c,d,u,f=!1){let h,_,p,m,g,y,b,v,T,x,I,E,L;if(i!==0)if(lt=d,rt=u,fi=rt.indices,hi=rt.elements.offset,ut=0,fn=0,zn=0,t[0],e[0],i===1)h=t[0],_=e[0],p=(n==null?void 0:n[0])??0,L=0,br(fi,hi,0,2,1,1,2,3),_t(rt,lt,0,h,_,p,1,-1,1,-1,L,!1,ao),_t(rt,lt,0,h,_,p,-1,-1,-1,-1,L,!1,so),_t(rt,lt,0,h,_,p,1,1,1,1,L,!1,ao),_t(rt,lt,0,h,_,p,-1,1,-1,1,L,!1,so),ut=ut+4;else{switch(m=t[0],g=e[0],y=(n==null?void 0:n[0])??0,b=t[1],v=e[1],T=(n==null?void 0:n[1])??0,L=f?lt.cDist:0,o){case mt.TileCut:Zi(Vi,m,g,s,a),Zi(dt,b,v,m,g),E=$m(b,v,T,Vi[0],Vi[1],dt[0],dt[1],f),E.noTurn?yv(m,g,y,dt[0],dt[1],L):fd(0,m,g,y,Vi[0],Vi[1],dt[0],dt[1],L,f);break;case mt.Butt:case mt.Round:Zi(dt,b,v,m,g),yv(m,g,y,dt[0],dt[1],L),o===mt.Round&&fd(0,m,g,y,dt[0],dt[1],dt[0],dt[1],L,f);break;default:throw new Error("LoftedLine: unknown Ending Type")}const N=i-1;for(let S=1;S<N;S++){m=t[S-1],g=e[S-1],y=(n==null?void 0:n[S-1])??0,b=t[S],v=e[S],T=(n==null?void 0:n[S])??0,x=t[S+1],I=e[S+1];const A=b-m,z=v-g;L+=Math.sqrt(A*A+z*z)/Se,Zi(Vi,b,v,m,g),Zi(dt,x,I,b,v),fd(S,b,v,T,Vi[0],Vi[1],dt[0],dt[1],L,f)}m=t[i-2],g=e[i-2],y=(n==null?void 0:n[i-2])??0,b=t[N],v=e[N],T=(n==null?void 0:n[N])??0;const k=b-m,w=v-g;switch(L+=Math.sqrt(k*k+w*w)/Se,r){case mt.TileCut:Zi(Vi,b,v,m,g),Zi(dt,l,c,b,v),E=$m(b,v,T,Vi[0],Vi[1],dt[0],dt[1],f),E.noTurn?bv(N,b,v,T,dt[0],dt[1],L):r5(N,L,E);break;case mt.Butt:case mt.Round:Zi(dt,b,v,m,g),bv(N,b,v,T,dt[0],dt[1],L),r===mt.Round&&fd(N,b,v,T,dt[0],dt[1],-dt[0],-dt[1],L,f);break;default:throw new Error("LoftedLine: unknown Ending Type")}}}function $m(t,e,n,i,o,r,s,a){const l=q8(t,e,n,i,o,r,s,a);if(!l.noTurn&&!l.reverseTurn){p3(Li,i,o,r,s);const c=Li[0],d=Li[1];l.extender[0]=c,l.extender[1]=d,l.faExtender[0]=c-i*2,l.faExtender[1]=d-o*2,l.saExtender[0]=c-r*2,l.saExtender[1]=d-s*2}else l.extender[0]=0,l.extender[1]=0,l.faExtender[0]=0,l.faExtender[1]=0,l.saExtender[0]=0,l.saExtender[1]=0;return l}function Vh(t,e,n,i,o,r,s,a,l,c){p3(Li,o,r,s,a),o*-a+r*s<0?_t(rt,lt,t,e,n,i,-Li[0],-Li[1],-Li[0],-Li[1],l,!1,c):_t(rt,lt,t,e,n,i,Li[0],Li[1],Li[0],Li[1],l,!1,c),ut++}function fd(t,e,n,i,o,r,s,a,l,c){const d=$m(e,n,i,o,r,s,a,c);r5(t,l,d),K8(t,l,d),J8(t,l,d)}function yv(t,e,n,i,o,r){_t(rt,lt,0,t,e,n,-i,-o,-i,-o,r,!1,so),_t(rt,lt,0,t,e,n,i,o,i,o,r,!1,ao),ut=ut+2,fn=1,zn=0}function bv(t,e,n,i,o,r,s){const a=ut+1,l=ut;_t(rt,lt,t,e,n,i,-o,-r,-o,-r,s,!1,so),_t(rt,lt,t,e,n,i,o,r,o,r,s,!1,ao),ut=ut+2,br(fi,hi,zn,l,fn,fn,l,a),fn=a,zn=l}function K8(t,e,n){if(n.noTurn)return;const i=n.sharpTurn?2:1;let o,r;n.reverseTurn||n.patternedLine&&n.sharpTurn?(o=zn,r=fn):n.leftTurn?(o=fn,r=ut+i):(o=ut+i,r=zn);const s=ut;if(jh(fi,hi,fn,zn,s),n.sharpTurn){const l=ut+1;n.leftTurn?br(fi,hi,s,l,o,o,l,r):br(fi,hi,s,r,l,l,r,o)}else n.leftTurn,jh(fi,hi,s,r,o);const a=n.leftTurn?so:ao;n.sharpTurn?(n.leftTurn?Zi(qs,n.xn2,n.yn2,n.xn1,n.yn1):Zi(qs,n.xn1,n.yn1,n.xn2,n.yn2),Vh(t,n.x,n.y,n.z,n.xn2,n.yn2,qs[0],qs[1],e,a),Vh(t,n.x,n.y,n.z,qs[0],qs[1],n.xn1,n.yn1,e,a)):Vh(t,n.x,n.y,n.z,n.xn2,n.yn2,n.xn1,n.yn1,e,a),n.reverseTurn||(n.leftTurn?_t(rt,lt,t,n.x,n.y,n.z,-n.xn1,-n.yn1,-n.xn1,-n.yn1,e,!1,a):_t(rt,lt,t,n.x,n.y,n.z,n.xn1,n.yn1,n.xn1,n.yn1,e,!1,a),ut++),zn=r,fn=o}function r5(t,e,n){if(n.noTurn)return;const i=ut+1,o=ut;if(n.reverseTurn||n.patternedLine&&n.sharpTurn?(_t(rt,lt,t,n.x,n.y,n.z,-n.xn2,-n.yn2,-n.xn2,-n.yn2,e,!1,so),_t(rt,lt,t,n.x,n.y,n.z,n.xn2,n.yn2,n.xn2,n.yn2,e,!1,ao)):n.leftTurn?(_t(rt,lt,t,n.x,n.y,n.z,-n.xn2,-n.yn2,n.faExtender[0],n.faExtender[1],e,!0,so),_t(rt,lt,t,n.x,n.y,n.z,n.xn2,n.yn2,n.extender[0],n.extender[1],e,!0,ao)):(_t(rt,lt,t,n.x,n.y,n.z,-n.xn2,-n.yn2,-n.extender[0],-n.extender[1],e,!0,so),_t(rt,lt,t,n.x,n.y,n.z,n.xn2,n.yn2,-n.faExtender[0],-n.faExtender[1],e,!0,ao)),ut=ut+2,br(fi,hi,zn,o,fn,fn,o,i),zn=o,fn=i,!n.patternedLine&&!n.reverseTurn){const r=ut+1,s=ut;n.leftTurn?(_t(rt,lt,t,n.x,n.y,n.z,-n.xn2,-n.yn2,-n.xn2,-n.yn2,e,!1,0),_t(rt,lt,t,n.x,n.y,n.z,0,0,0,0,e,!1,0),br(fi,hi,i,o,r,r,o,s)):(_t(rt,lt,t,n.x,n.y,n.z,0,0,0,0,e,!1,0),_t(rt,lt,t,n.x,n.y,n.z,n.xn2,n.yn2,n.xn2,n.yn2,e,!1,0),br(fi,hi,o,s,i,i,s,r)),ut=ut+2,zn=s,fn=r}}function J8(t,e,n){if(n.noTurn||n.reverseTurn)return;const i=ut+1,o=ut;if(n.patternedLine&&n.sharpTurn){_t(rt,lt,t,n.x,n.y,n.z,n.xn2,n.yn2,n.xn2,n.yn2,e,!1,so),_t(rt,lt,t,n.x,n.y,n.z,-n.xn2,-n.yn2,-n.xn2,-n.yn2,e,!1,ao),ut=ut+2,zn=o,fn=i;return}else n.leftTurn?(_t(rt,lt,t,n.x,n.y,n.z,-n.xn1,-n.yn1,n.saExtender[0],n.saExtender[1],e,!1,so),_t(rt,lt,t,n.x,n.y,n.z,n.xn1,n.yn1,n.extender[0],n.extender[1],e,!1,ao)):(_t(rt,lt,t,n.x,n.y,n.z,-n.xn1,-n.yn1,-n.extender[0],-n.extender[1],e,!1,so),_t(rt,lt,t,n.x,n.y,n.z,n.xn1,n.yn1,-n.saExtender[0],-n.saExtender[1],e,!1,ao));ut=ut+2,n.leftTurn?br(fi,hi,zn,o,fn,fn,o,i):br(fi,hi,fn,zn,i,i,zn,o),zn=o,fn=i}function _t(t,e,n,i,o,r,s,a,l,c,d,u,f){const h=t.elements.offset*e.offsetMultiplier,_=h>>1,p=h<<1;if(t.views.position[h]=Y+i,t.views.position[h+1]=Y+o,t.views.extender[h]=Math.floor(l*Bt*127+.5),t.views.extender[h+1]=Math.floor(c*Bt*127+.5),e.type===Es.Patterned){const m=t,g=1e-5;m.views.texture[_]=(g+d)*Math.sign(f)}else if(e.type===Es.Striped){const m=t;m.views.texExtender[p]=on(s*Bt),m.views.texExtender[p+1]=on(a*Bt),m.views.vertexDistance[_]=d,m.views.objectLength[_]=e.oLen,"componentDistance"in t.views&&(t.views.componentDistance[_]=e.cDist)}else if(e.type===Es.Entrance){const m=t,{px:g,py:y,count:b}=e,v=n===0,T=n===b-1,x=v?n:n-1,I=v?n+1:n;Wo(Hh,g[x],y[x],g[I],y[I]),m.views.direction[h]=Math.round(Hh[0]*127),m.views.direction[h+1]=Math.round(Hh[1]*127),m.views.type[_]=T?Pc.LineEnding:Pc.Line,m.views.texExtender[p]=on(s*(u||T?-1:1)*Bt),m.views.texExtender[p+1]=on(a*(u||T?-1:1)*Bt),m.views.vertexDistance[_]=d,m.views.objectLength[_]=e.oLen}t.views.localID[_]=e.localID,"height"in t.views&&(t.views.height[_]=r),t.elements.offset++}function jh(t,e,n,i,o){const r=t.buffer,s=t.offset;r[s]=e+n,r[s+1]=e+i,r[s+2]=e+o,t.offset=s+3}function br(t,e,n,i,o,r,s,a){const l=t.buffer,c=t.offset;l[c]=e+n,l[c+1]=e+i,l[c+2]=e+o,l[c+3]=e+r,l[c+4]=e+s,l[c+5]=e+a,t.offset=c+6}function s5(t){return cl*t}function R0(t){return t/cl}const Q8={arrow:!0,buildingModel:!0,custom:!0,dashedLine:!0,embankment:!0,group:!0,heatmap:!0,labelLine:!0,line:!0,lineExtrusion:!0,metricPoint:!0,model:!0,oneWayLine:!0,overpass:!0,point:!0,polygon:!0,polygon3d:!0,polygonExtrusion:!0,raster:!0,shiftedLine:!0,tunnel:!0};function rn(t,e,n){const i=t.getBoundingClientRect();return[e-i.left-t.clientLeft,n-i.top-t.clientTop]}function bs(t,e){const n=[];for(let i=0;i<t.length;i++)n[i]=rn(e,t[i].clientX,t[i].clientY);return n}function $h(t){return t.touches.length>1}const eT=q.toGeo,wv=32,xv=512;function tT(t,e,n,i,o){const r=[t[0][0],t[1][0]],s=Be(90+i),a=[];Sr(a,r,o);const l=q.toGeo(a),c=Wg(l,e),d=Wg(l,n),u=Math.sqrt(c**2+d**2)/2,f=Math.atan(c/-d)+Math.PI+s,h=u*Math.cos(f),_=u*Math.sin(f),p=Math.atan(-c/-d)+Math.PI+s,m=u*Math.cos(p),g=u*Math.sin(p),y=Math.atan(-c/d)+2*Math.PI+s,b=u*Math.cos(y),v=u*Math.sin(y),T=Math.atan(c/d)+s,x=u*Math.cos(T),I=u*Math.sin(T),E=[],L=[],N=[],k=[];return mi(E,[a[0]+h,a[1]+_],o),mi(L,[a[0]+m,a[1]+g],o),mi(N,[a[0]+b,a[1]+v],o),mi(k,[a[0]+x,a[1]+I],o),[[E[0],L[0],N[0],k[0]],[E[1],L[1],N[1],k[1]]]}function Ka(t,e){const n=Math.max(t,e);return n*wv>xv?xv/n:wv}function nT(){let t=new xi(4);return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t}function iT(t,e,n,i,o){return t[0]=e,t[1]=n,t[2]=i,t[3]=o,t}function oT(t){return t[0]*t[3]-t[2]*t[1]}var hd={exports:{}},Xu={exports:{}},rT=Xu.exports,Sv;function sT(){return Sv||(Sv=1,function(t,e){(function(n,i){t.exports=i()})(rT,function(){function n(s,a,l,c,d){i(s,a,l||0,c||s.length-1,d||r)}function i(s,a,l,c,d){for(;c>l;){if(c-l>600){var u=c-l+1,f=a-l+1,h=Math.log(u),_=.5*Math.exp(2*h/3),p=.5*Math.sqrt(h*_*(u-_)/u)*(f-u/2<0?-1:1),m=Math.max(l,Math.floor(a-f*_/u+p)),g=Math.min(c,Math.floor(a+(u-f)*_/u+p));i(s,a,m,g,d)}var y=s[a],b=l,v=c;for(o(s,l,a),d(s[c],y)>0&&o(s,l,c);b<v;){for(o(s,b,v),b++,v--;d(s[b],y)<0;)b++;for(;d(s[v],y)>0;)v--}d(s[l],y)===0?o(s,l,v):(v++,o(s,v,c)),v<=a&&(l=v+1),a<=v&&(c=v-1)}}function o(s,a,l){var c=s[a];s[a]=s[l],s[l]=c}function r(s,a){return s<a?-1:s>a?1:0}return n})}(Xu)),Xu.exports}var Mv;function aT(){if(Mv)return hd.exports;Mv=1,hd.exports=e,hd.exports.default=e;var t=sT();function e(m,g){if(!(this instanceof e))return new e(m,g);this._maxEntries=Math.max(4,m||9),this._minEntries=Math.max(2,Math.ceil(this._maxEntries*.4)),g&&this._initFormat(g),this.clear()}e.prototype={all:function(){return this._all(this.data,[])},search:function(m){var g=this.data,y=[],b=this.toBBox;if(!h(m,g))return y;for(var v=[],T,x,I,E;g;){for(T=0,x=g.children.length;T<x;T++)I=g.children[T],E=g.leaf?b(I):I,h(m,E)&&(g.leaf?y.push(I):f(m,E)?this._all(I,y):v.push(I));g=v.pop()}return y},collides:function(m){var g=this.data,y=this.toBBox;if(!h(m,g))return!1;for(var b=[],v,T,x,I;g;){for(v=0,T=g.children.length;v<T;v++)if(x=g.children[v],I=g.leaf?y(x):x,h(m,I)){if(g.leaf||f(m,I))return!0;b.push(x)}g=b.pop()}return!1},load:function(m){if(!(m&&m.length))return this;if(m.length<this._minEntries){for(var g=0,y=m.length;g<y;g++)this.insert(m[g]);return this}var b=this._build(m.slice(),0,m.length-1,0);if(!this.data.children.length)this.data=b;else if(this.data.height===b.height)this._splitRoot(this.data,b);else{if(this.data.height<b.height){var v=this.data;this.data=b,b=v}this._insert(b,this.data.height-b.height-1,!0)}return this},insert:function(m){return m&&this._insert(m,this.data.height-1),this},clear:function(){return this.data=_([]),this},remove:function(m,g){if(!m)return this;for(var y=this.data,b=this.toBBox(m),v=[],T=[],x,I,E,L;y||v.length;){if(y||(y=v.pop(),I=v[v.length-1],x=T.pop(),L=!0),y.leaf&&(E=n(m,y.children,g),E!==-1))return y.children.splice(E,1),v.push(y),this._condense(v),this;!L&&!y.leaf&&f(y,b)?(v.push(y),T.push(x),x=0,I=y,y=y.children[0]):I?(x++,y=I.children[x],L=!1):y=null}return this},toBBox:function(m){return m},compareMinX:s,compareMinY:a,toJSON:function(){return this.data},fromJSON:function(m){return this.data=m,this},_all:function(m,g){for(var y=[];m;)m.leaf?g.push.apply(g,m.children):y.push.apply(y,m.children),m=y.pop();return g},_build:function(m,g,y,b){var v=y-g+1,T=this._maxEntries,x;if(v<=T)return x=_(m.slice(g,y+1)),i(x,this.toBBox),x;b||(b=Math.ceil(Math.log(v)/Math.log(T)),T=Math.ceil(v/Math.pow(T,b-1))),x=_([]),x.leaf=!1,x.height=b;var I=Math.ceil(v/T),E=I*Math.ceil(Math.sqrt(T)),L,N,k,w;for(p(m,g,y,E,this.compareMinX),L=g;L<=y;L+=E)for(k=Math.min(L+E-1,y),p(m,L,k,I,this.compareMinY),N=L;N<=k;N+=I)w=Math.min(N+I-1,k),x.children.push(this._build(m,N,w,b-1));return i(x,this.toBBox),x},_chooseSubtree:function(m,g,y,b){for(var v,T,x,I,E,L,N,k;b.push(g),!(g.leaf||b.length-1===y);){for(N=k=1/0,v=0,T=g.children.length;v<T;v++)x=g.children[v],E=l(x),L=d(m,x)-E,L<k?(k=L,N=E<N?E:N,I=x):L===k&&E<N&&(N=E,I=x);g=I||g.children[0]}return g},_insert:function(m,g,y){var b=this.toBBox,v=y?m:b(m),T=[],x=this._chooseSubtree(v,this.data,g,T);for(x.children.push(m),r(x,v);g>=0&&T[g].children.length>this._maxEntries;)this._split(T,g),g--;this._adjustParentBBoxes(v,T,g)},_split:function(m,g){var y=m[g],b=y.children.length,v=this._minEntries;this._chooseSplitAxis(y,v,b);var T=this._chooseSplitIndex(y,v,b),x=_(y.children.splice(T,y.children.length-T));x.height=y.height,x.leaf=y.leaf,i(y,this.toBBox),i(x,this.toBBox),g?m[g-1].children.push(x):this._splitRoot(y,x)},_splitRoot:function(m,g){this.data=_([m,g]),this.data.height=m.height+1,this.data.leaf=!1,i(this.data,this.toBBox)},_chooseSplitIndex:function(m,g,y){var b,v,T,x,I,E,L,N;for(E=L=1/0,b=g;b<=y-g;b++)v=o(m,0,b,this.toBBox),T=o(m,b,y,this.toBBox),x=u(v,T),I=l(v)+l(T),x<E?(E=x,N=b,L=I<L?I:L):x===E&&I<L&&(L=I,N=b);return N},_chooseSplitAxis:function(m,g,y){var b=m.leaf?this.compareMinX:s,v=m.leaf?this.compareMinY:a,T=this._allDistMargin(m,g,y,b),x=this._allDistMargin(m,g,y,v);T<x&&m.children.sort(b)},_allDistMargin:function(m,g,y,b){m.children.sort(b);var v=this.toBBox,T=o(m,0,g,v),x=o(m,y-g,y,v),I=c(T)+c(x),E,L;for(E=g;E<y-g;E++)L=m.children[E],r(T,m.leaf?v(L):L),I+=c(T);for(E=y-g-1;E>=g;E--)L=m.children[E],r(x,m.leaf?v(L):L),I+=c(x);return I},_adjustParentBBoxes:function(m,g,y){for(var b=y;b>=0;b--)r(g[b],m)},_condense:function(m){for(var g=m.length-1,y;g>=0;g--)m[g].children.length===0?g>0?(y=m[g-1].children,y.splice(y.indexOf(m[g]),1)):this.clear():i(m[g],this.toBBox)},_initFormat:function(m){var g=["return a"," - b",";"];this.compareMinX=new Function("a","b",g.join(m[0])),this.compareMinY=new Function("a","b",g.join(m[1])),this.toBBox=new Function("a","return {minX: a"+m[0]+", minY: a"+m[1]+", maxX: a"+m[2]+", maxY: a"+m[3]+"};")}};function n(m,g,y){if(!y)return g.indexOf(m);for(var b=0;b<g.length;b++)if(y(m,g[b]))return b;return-1}function i(m,g){o(m,0,m.children.length,g,m)}function o(m,g,y,b,v){v||(v=_(null)),v.minX=1/0,v.minY=1/0,v.maxX=-1/0,v.maxY=-1/0;for(var T=g,x;T<y;T++)x=m.children[T],r(v,m.leaf?b(x):x);return v}function r(m,g){return m.minX=Math.min(m.minX,g.minX),m.minY=Math.min(m.minY,g.minY),m.maxX=Math.max(m.maxX,g.maxX),m.maxY=Math.max(m.maxY,g.maxY),m}function s(m,g){return m.minX-g.minX}function a(m,g){return m.minY-g.minY}function l(m){return(m.maxX-m.minX)*(m.maxY-m.minY)}function c(m){return m.maxX-m.minX+(m.maxY-m.minY)}function d(m,g){return(Math.max(g.maxX,m.maxX)-Math.min(g.minX,m.minX))*(Math.max(g.maxY,m.maxY)-Math.min(g.minY,m.minY))}function u(m,g){var y=Math.max(m.minX,g.minX),b=Math.max(m.minY,g.minY),v=Math.min(m.maxX,g.maxX),T=Math.min(m.maxY,g.maxY);return Math.max(0,v-y)*Math.max(0,T-b)}function f(m,g){return m.minX<=g.minX&&m.minY<=g.minY&&g.maxX<=m.maxX&&g.maxY<=m.maxY}function h(m,g){return g.minX<=m.maxX&&g.minY<=m.maxY&&g.maxX>=m.minX&&g.maxY>=m.minY}function _(m){return{children:m,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function p(m,g,y,b,v){for(var T=[g,y],x;T.length;)y=T.pop(),g=T.pop(),!(y-g<=b)&&(x=g+Math.ceil((y-g)/b/2)*b,t(m,x,g,y,v),T.push(g,x,x,y))}return hd.exports}var lT=aT();const z0=ll(lT),vc=Ke(),Tv=Ke(),cT=Et(),dT=Et(),Iv=nT(),va=64;function a5(t,e){const n=z0();for(let i=0;i<e.length;i+=3){const o=e[i],r=e[i+1],s=e[i+2],a=Wh(t,o),l=Wh(t,r),c=Wh(t,s),d=[a,l,c];n.insert({minX:Math.min(a[0],l[0],c[0]),minY:Math.min(a[1],l[1],c[1]),maxX:Math.max(a[0],l[0],c[0]),maxY:Math.max(a[1],l[1],c[1]),data:d})}return n}function Wh(t,e){const n=t[e*3],i=t[e*3+1],o=t[e*3+2];return[n,i,o]}function l5(t,e){const n=St(vc,e[0],e[1],0),i=E3(t.key),o=Ct(i),r=new Uint16Array(3);mi(r,n,o);const s=t.tree.search({minX:r[0],maxX:r[0],minY:r[1],maxY:r[1]});for(const a of s){const[l,c,d]=a.data,u=uT(l,c,d,r,vc);if(!u)continue;return l[2]*u[0]+c[2]*u[1]+d[2]*u[2]}}function uT(t,e,n,i,o){const r=Zh(t,e,n);if(r===0){if(t[0]===e[0]&&e[0]===n[0]&&t[1]===e[1]&&e[1]===n[1])return t[0]===i[0]&&t[1]===i[1]?(o[0]=1,o[1]=0,o[2]=0,o):null;let c=null;if(Xh(t,e,i)){const d=Yu(t,e,i);c=Nn(vc,t,e,d),o[0]=1-d,o[1]=d,o[2]=0}if(Xh(e,n,i)){const d=Yu(e,n,i),u=Nn(Tv,e,n,d);(!c||u[2]>c[2])&&(o[0]=0,o[1]=1-d,o[2]=d,c||(c=vc),Sa(c,u))}if(Xh(n,t,i)){const d=Yu(n,t,i),u=Nn(Tv,n,t,d);(!c||u[2]>c[2])&&(o[0]=d,o[1]=0,o[2]=1-d,c||(c=vc),Sa(c,u))}if(c)return o}const s=Zh(i,e,n)/r,a=Zh(i,n,t)/r,l=1-s-a;return s<0||a<0||l<0||s>1||a>1||l>1?null:(o[0]=s,o[1]=a,o[2]=l,o)}function Zh(t,e,n){return iT(Iv,e[0]-t[0],n[0]-t[0],e[1]-t[1],n[1]-t[1]),oT(Iv)}function Xh(t,e,n){const i=(e[0]-t[0])*(n[1]-t[1])-(e[1]-t[1])*(n[0]-t[0]);return Math.abs(i)>1e-8?!1:(n[0]-t[0])*(n[0]-e[0])+(n[1]-t[1])*(n[1]-e[1])<=0}function Yu(t,e,n){const i=ti(cT,e,t),o=ti(dT,n,t);return Ls(o,i)/vx(i)}function c5(t,e,n,i,o){const r=R0(o);yr(i.textureImage).forEach(s=>{if(!s.length)return;const a=n.byKey[_l(s)];if(!a){console.error(`Not found raster set with texture ${s}`);return}if(!a.isSvg)return;const l=i.textureSize;let c;if(i.lengthUnits===Vo.Meters){const[u,f=u]=l;c=[u*Ka(u,u),f*Ka(f,f)]}else c=fT(l);c.forEach(u=>{const[f,h]=Array.isArray(u)?u:[u,u];t.atlasPacker.packSvg(a,[{w:f,h}],r),a.rasters.forEach(_=>t.atlasPacker.addRastersToLoad(e,_))})})}function fT(t){return Bs(t)?t.type==="step"?t.steps.map(e=>Array.isArray(e.value)||typeof e.value=="number"?e.value:e.value.type==="literalArray"?e.value.array:(console.warn("textureSize only supports shallow step expression"),[0])):t.type==="literalArray"?[Dn(t)]:(ct(`Unsupported texture size expression of type "${t.type}". Can't resovle.`),[0]):[t]}function Wm(t,e){const{tileAttrs:n,tileProps:i}=t,o=Number.isNaN(n[i.db_begin_nominal_height])?0:n[i.db_begin_nominal_height]??0,r=Number.isNaN(n[i.db_end_nominal_height])?0:n[i.db_end_nominal_height]??0,s=n[i.objectLength]??1,a=n[i.componentDistanceStart]??0,l=n[i.componentDistanceEnd]??0,c=Ra(o,r,a/s),d=Ra(o,r,l/s),u=t.tileInfo?_o(t.tileInfo,[0,0]):1,f=Array.from({length:e.x.length});if(c===d)return f.fill(c*He*u),f;const h=e.x.length;for(let _=0;_<h;_++)f[_]=He*u*Ra(c,d,Yu([e.x[0],e.y[0]],[e.x[h-1],e.y[h-1]],[e.x[_],e.y[_]]));return f}const Ot={symbol:"line",sinks:{solid:{stride:12,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.extender=new Int8Array(e,4),t.views.normal=new Int8Array(e,6),t.views.localID=new Uint32Array(e,8)},packObjectAttributes(t,e,n,i){return Dt([t,e.innerId,n],e,i)},unpackObjectAttributes(t){return{styleId:t[0],layerId:t[1],tiers:t[2],tileData:t.slice(3)}}},solid3d:{stride:16,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.extender=new Int8Array(e,4),t.views.normal=new Int8Array(e,6),t.views.height=new Float32Array(e,8),t.views.localID=new Uint32Array(e,12)},packObjectAttributes(t,e,n,i){return Dt([t,e.innerId,n],e,i)},unpackObjectAttributes(t){return{styleId:t[0],layerId:t[1],tiers:t[2],tileData:t.slice(3)}}},patterned:{stride:16,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.extender=new Int16Array(e,4),t.views.texture=new Float32Array(e,8),t.views.localID=new Uint32Array(e,12)},packObjectAttributes(t,e,n,i){return Dt([t,e.innerId,n],e,i)},unpackObjectAttributes(t){return{styleId:t[0],layerId:t[1],tiers:t[2],tileData:t.slice(3)}}},patterned3d:{stride:20,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.extender=new Int16Array(e,4),t.views.texture=new Float32Array(e,8),t.views.height=new Float32Array(e,12),t.views.localID=new Uint32Array(e,16)},packObjectAttributes(t,e,n,i){return Dt([t,e.innerId,n],e,i)},unpackObjectAttributes(t){return{styleId:t[0],layerId:t[1],tiers:t[2],tileData:t.slice(3)}}}},generate(t,e,n,i,o,r){const s=jm(te(n.style.geometryModifier,i),o,r,i);if(s===null)return;const{tileAttrs:a,tileProps:l}=i,c=n.style.withHeight?Wm(i,s):void 0,d=t.idIndexer.getIndex(i,e,n),u=te(n.ignoreTier,i)?null:i.tileAttrs[l.db_tiers],f=n.style.withHeight?t.getBucket(n.type,"solid3d",Ot.sinks.solid3d.packObjectAttributes(e,n,u,i),Ot.sinks.solid3d.binder):t.getBucket(n.type,"solid",Ot.sinks.solid.packObjectAttributes(e,n,u,i),Ot.sinks.solid.binder),h=Number.isNaN(a[l.beginningIsCut])?!1:a[l.beginningIsCut]!==0,_=Number.isNaN(a[l.endingIsCut])?!1:a[l.endingIsCut]!==0,p=Hn(n.style.startCap,i),m=Hn(n.style.endCap,i);o5(f,s.x,s.y,c,s.x.length,h?mt.TileCut:_d(p),_?mt.TileCut:_d(m),d)},generatePatterned(t,e,n,i,o,r){const s=jm(te(n.style.geometryModifier,i),o,r,i);if(s===null)return;const{tileAttrs:a,tileProps:l}=i,c=te(n.ignoreTier,i)?null:i.tileAttrs[l.db_tiers],d=n.style.withHeight?t.getBucket("line","patterned3d",Ot.sinks.patterned3d.packObjectAttributes(e,n,c,i),Ot.sinks.patterned3d.binder):t.getBucket("line","patterned",Ot.sinks.patterned.packObjectAttributes(e,n,c,i),Ot.sinks.patterned.binder),u=t.idIndexer.getIndex(i,e,n),f=hT(a[l.componentDistanceStart]/Se,a[l.componentDistanceEnd]/Se,a[l.objectLength]/Se,u,n.style.withHeight?Ot.sinks.patterned3d.stride/2:Ot.sinks.patterned.stride/2),h=Number.isNaN(a[l.beginningIsCut])?!1:a[l.beginningIsCut]!==0,_=Number.isNaN(a[l.endingIsCut])?!1:a[l.endingIsCut]!==0,p=Hn(n.style.startCap,i),m=Hn(n.style.endCap,i),g=n.style.withHeight?Wm(i,s):void 0;k0(s.x,s.y,g,s.x.length,h?mt.TileCut:_d(p),_?mt.TileCut:_d(m),a[l.previousPointX],a[l.previousPointY],a[l.nextPointX],a[l.nextPointY],f,d,!0)}},Ks={type:Es.Patterned,cDist:0,sLen:0,oLen:0,localID:0,offsetMultiplier:8,px:[],py:[],count:0};function hT(t,e,n,i,o){return Ks.cDist=t,Ks.sLen=e-t,Ks.oLen=n,Ks.localID=i,Ks.offsetMultiplier=o,Ks}function _d(t){switch(t){case"round":return mt.Round;case"tilecut":return mt.TileCut;case"butt":default:return mt.Butt}}const yf={symbol:"shiftedLine",sinks:{solid:{stride:16,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.extender=new Int8Array(e,4),t.views.normal=new Int8Array(e,6),t.views.shift=new Float32Array(e,8)},packObjectAttributes(t,e,n,i){return Dt([t,e.innerId,n],e,i)},unpackObjectAttributes(t){return{styleId:t[0],layerId:t[1],tiers:t[2],tileData:t.slice(3)}}}},generate(t,e,n,i,o){const{tileAttrs:r,tileProps:s}=i,a=Number.isNaN(r[s.beginningIsCut])?!1:r[s.beginningIsCut]!==0,l=Number.isNaN(r[s.endingIsCut])?!1:r[s.endingIsCut]!==0,c=te(n.ignoreTier,i)?null:i.tileAttrs[s.db_tiers],d=t.getBucket(n.type,"solid",yf.sinks.solid.packObjectAttributes(e,n,c,i),yf.sinks.solid.binder);o5(d,o.x,o.y,void 0,o.x.length,a?mt.TileCut:mt.Round,l?mt.TileCut:mt.Round,0,o.normal_x,o.normal_y)}};function jn(t,e){return t===0?0:Math.min(t*2-1,(e-t)*2)}function d5(t,e,n,i,o,r,s,a,l){let c=t.elements.offset;for(let d=0;d<e;d++){const u=jn(d,e),f=d===e-1;if(o&&o[u]===1||!o&&!f){const h=n[u],_=i[u],p=(d+1)%e,m=jn(p,e),g=n[m],y=i[m];mT(t,c),_T(t,c,h,_,g,y,r),l?Ev(t,c,l[0],l[1],l[0],l[1]):Ev(t,c,h,_,g,y),s!==void 0&&"localID"in t.views&&t.views.localID!==void 0&&Av(t.views.localID,c,s,t.elements.stride),a!==void 0&&"labelingTextureID"in t.views&&t.views.labelingTextureID!==void 0&&Av(t.views.labelingTextureID,c,a,t.elements.stride),c=c+4}}t.elements.offset=c}function _T(t,e,n,i,o,r,s){const a=t.views.position,l=t.elements.stride/a.BYTES_PER_ELEMENT;e=e*l,a[e]=Y+n,a[e+1]=Y+i,a[e+2]=0,e+=l,a[e]=Y+n,a[e+1]=Y+i,a[e+2]=$n(s),e+=l,a[e]=Y+o,a[e+1]=Y+r,a[e+2]=0,e+=l,a[e]=Y+o,a[e+1]=Y+r,a[e+2]=$n(s)}function Ev(t,e,n,i,o,r){const s=t.views.demPosition,a=t.elements.stride/s.BYTES_PER_ELEMENT;e=e*a,n=(n+Y)/8,i=(i+Y)/8,o=(o+Y)/8,r=(r+Y)/8,s[e]=n,s[e+1]=i,e+=a,s[e]=n,s[e+1]=i,e+=a,s[e]=o,s[e+1]=r,e+=a,s[e]=o,s[e+1]=r}function Av(t,e,n,i){const o=i/t.BYTES_PER_ELEMENT;e=e*o,t[e]=n,t[e+=o]=n,t[e+=o]=n,t[e+=o]=n}function mT(t,e){const n=t.indices.buffer;let i=t.indices.offset;n[i++]=e,n[i++]=e+3,n[i++]=e+1,n[i++]=e,n[i++]=e+2,n[i++]=e+3,t.indices.offset=i}const tr=[.5,.5],_r=[.5,.5];function Zm(t,e,n,i,o,r){let s=t.elements.offset;const a=jn(e-1,e);let l=n[a],c=i[a],d=o?o[a]:0;const u=s;for(let f=0;f<e;f++){const h=jn(f,e),_=f===e-1,p=n[h],m=i[h],g=o?o[h]:_?0:1;d!==0&&(Wo(_r,l,c,p,m),u5(t,s,g,_?u:s+4),gT(t,s,l,c,p,m),r?Cv(t,s,r[0],r[1],r[0],r[1]):Cv(t,s,l,c,p,m),Fm(_r),vT(t,s,_r),yT(t,s,_r),s=s+4),l=p,c=m,d=g}t.elements.offset=s}function Xm(t,e,n,i,o,r,s){let a=t.elements.offset;const l=jn(e-2,e),c=jn(e-1,e);let d=n[c],u=i[c],f=o?o[l]:1,h=o?o[c]:0;Zi(tr,n[l],i[l],d,u);let _=tr[0],p=tr[1];for(let m=0;m<e;m++){const g=jn(m,e),y=m===e-1,b=n[g],v=i[g],T=o?o[g]:y?0:1;Wo(_r,d,u,b,v);const x=_r[1],I=-_r[0];f!==0&&(h===0?(tr[0]=_,tr[1]=p):pT(tr,_,p,x,I),bS(_r,_,p,tr[0],tr[1]),u5(t,a,0,0),bT(t,a,d,u,r,s??[d,u]),wT(t,a,Fm(tr),Fm(_r)),xT(t,a),a=a+4),d=b,u=v,f=h,h=T,_=x,p=I}t.elements.offset=a}function pT(t,e,n,i,o){let r,s,a;e*i+n*o>0?(r=e+i,s=n+o,a=1/Math.sqrt(r*r+s*s),t[0]=r*a,t[1]=s*a):(r=o-n,s=e-i,r!==0&&s!==0?(a=1/Math.sqrt(r*r+s*s),t[0]=r*a,t[1]=s*a):(t[0]=0,t[1]=0))}function Cv(t,e,n,i,o,r){const s=t.views.demPosition,a=t.elements.stride/s.BYTES_PER_ELEMENT;e=e*a,n=(n+Y)/8,i=(i+Y)/8,o=(o+Y)/8,r=(r+Y)/8,s[e]=n,s[e+1]=i,e+=a,s[e]=n,s[e+1]=i,e+=a,s[e]=o,s[e+1]=r,e+=a,s[e]=o,s[e+1]=r}function gT(t,e,n,i,o,r){const{position:s,distance:a}=t.views,l=t.elements.stride/s.BYTES_PER_ELEMENT;e=e*l,s[e]=Y+n,s[e+1]=Y+i,s[e+2]=0,a[e]=0,e+=l,s[e]=Y+n,s[e+1]=Y+i,s[e+2]=0,a[e]=-32767,e+=l,s[e]=Y+o,s[e+1]=Y+r,s[e+2]=0,a[e]=-32767,e+=l,s[e]=Y+o,s[e+1]=Y+r,s[e+2]=0,a[e]=0}function vT(t,e,n){const i=t.elements.stride/t.views.normals.BYTES_PER_ELEMENT;e=e*i;for(let o=0;o<4;o++)t.views.normals[e]=n[0],t.views.normals[e+1]=n[1],t.views.normals[e+2]=0,t.views.normals[e+3]=0,e+=i}function yT(t,e,n){const i=t.elements.stride/t.views.direction.BYTES_PER_ELEMENT;e=e*i;for(let o=0;o<4;o++)t.views.direction[e]=n[0],t.views.direction[e+1]=n[1],t.views.direction[e+2]=0,t.views.direction[e+3]=0,e+=i}function bT(t,e,n,i,o,r){const s=t.elements.stride/t.views.position.BYTES_PER_ELEMENT;e=e*s,t.views.position[e]=Y+n,t.views.position[e+1]=Y+i,t.views.position[e+2]=0,t.views.distance[e]=32767,t.views.demPosition[e]=(Y+r[0])/8,t.views.demPosition[e+1]=(Y+r[1])/8,e+=s,t.views.position[e]=Y+n,t.views.position[e+1]=Y+i,t.views.position[e+2]=0,t.views.distance[e]=-32767,t.views.demPosition[e]=(Y+r[0])/8,t.views.demPosition[e+1]=(Y+r[1])/8,e+=s,t.views.position[e]=Y+n,t.views.position[e+1]=Y+i,t.views.position[e+2]=$n(o),t.views.distance[e]=-32767,t.views.demPosition[e]=(Y+r[0])/8,t.views.demPosition[e+1]=(Y+r[1])/8,e+=s,t.views.position[e]=Y+n,t.views.position[e+1]=Y+i,t.views.position[e+2]=$n(o),t.views.distance[e]=32767,t.views.demPosition[e]=(Y+r[0])/8,t.views.demPosition[e+1]=(Y+r[1])/8}function wT(t,e,n,i){const o=t.elements.stride/t.views.normals.BYTES_PER_ELEMENT;e=e*o;for(let r=0;r<4;r++)t.views.normals[e]=n[0],t.views.normals[e+1]=n[1],t.views.normals[e+2]=i[0],t.views.normals[e+3]=i[1],e+=o}function xT(t,e){const n=t.elements.stride/t.views.direction.BYTES_PER_ELEMENT;e=e*n;for(let i=0;i<4;i++)t.views.direction[e]=0,t.views.direction[e+2]=127,e+=n}function u5(t,e,n,i){const o=t.indices.buffer;let r=t.indices.offset;o[r++]=e,o[r++]=e+1,o[r++]=e+3,o[r++]=e+3,o[r++]=e+1,o[r++]=e+2,n!==0&&(o[r++]=e+2,o[r++]=i+1,o[r++]=i+0),t.indices.offset=r}const El=Ke(),Al=Ke(),nr=Ke();function Xc(t,e,n,i,o,r,s,a,l,c,d,u,f){St(El,e,n,i),St(Al,o,r,s),$t(nr,Al,El),Ix(Al,El)||(_n(nr,nr),ni(nr,nr,127)),ST(t,0,1,3,3,1,2),md(t,El,nr,1,a,l,c,u),md(t,El,nr,-1,a,l,c,u),md(t,Al,nr,-1,a,l,d,f),md(t,Al,nr,1,a,l,d,f)}function md(t,e,n,i,o,r,s,a){const l=t.elements.offset*t.elements.stride,c=l/t.views.position.BYTES_PER_ELEMENT;if(t.views.position[c]=r?e[0]:Y+e[0],t.views.position[c+1]=r?e[1]:Y+e[1],"z"in t.views){const d=l/t.views.z.BYTES_PER_ELEMENT;t.views.z[d]=e[2]}else t.views.position[c+2]=r?e[2]:$n(e[2]);if(t.views.directionDistance[l]=n[0],t.views.directionDistance[l+1]=n[1],t.views.directionDistance[l+2]=n[2],t.views.directionDistance[l+3]=i,"demPosition"in t.views){const d=l/t.views.demPosition.BYTES_PER_ELEMENT;o=o??e,t.views.demPosition[d]=(r?o[0]:Y+o[0])/8,t.views.demPosition[d+1]=(r?o[1]:Y+o[1])/8}"absZ"in t.views&&s!==void 0&&(t.views.absZ[l/t.views.absZ.BYTES_PER_ELEMENT]=s),"isPivot"in t.views&&(t.views.isPivot[l/t.views.isPivot.BYTES_PER_ELEMENT]=a??0),t.elements.offset++}function ST(t,e,n,i,o,r,s){const a=t.indices.buffer,l=t.indices.offset,c=t.elements.offset;a[l]=c+e,a[l+1]=c+n,a[l+2]=c+i,a[l+3]=c+o,a[l+4]=c+r,a[l+5]=c+s,t.indices.offset=l+6}const pd=Se/2,Cl=(t,e,n,i,o,r)=>Dt([t,e.innerId,n,i,o],e,r),gd=t=>({styleId:t[0],layerId:t[1],hiddenById:t[2],floorId:t[3],isFloorStack:t[4],tileData:t.slice(5)}),Bo={symbol:"polygonExtrusion",sinks:{sideFill:{stride:20,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.localID=new Uint32Array(e,8),t.views.demPosition=new Int16Array(e,12),t.views.labelingTextureID=new Uint32Array(e,16)},packObjectAttributes:Cl,unpackObjectAttributes:gd},topFill:{stride:20,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.localID=new Uint32Array(e,8),t.views.demPosition=new Int16Array(e,12),t.views.labelingTextureID=new Uint32Array(e,16)},packObjectAttributes:Cl,unpackObjectAttributes:gd},sideStroke:{stride:20,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.distance=new Int16Array(e,6),t.views.normals=new Int8Array(e,8),t.views.direction=new Int8Array(e,12),t.views.demPosition=new Int16Array(e,16)},packObjectAttributes:Cl,unpackObjectAttributes:gd},topStroke:{stride:16,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.directionDistance=new Int8Array(e,8),t.views.demPosition=new Int16Array(e,12)},packObjectAttributes:Cl,unpackObjectAttributes:gd}},generate(t,e,n,i,o){const r=o.x,s=o.y,a=o.cut??[],l=i.tileProps.db_plan_id?i.tileAttrs[i.tileProps.db_plan_id]:"",c=i.tileAttrs[i.tileProps.db_hidden_by_plan_building_id]??"",d=i.tileAttrs[i.tileProps.db_sublayer]==="Floor_ground",u=r.length,f=i.id??"";let h;i.tileProps.db_centroid_x&&i.tileProps.db_centroid_y&&!Number.isNaN(i.tileAttrs[i.tileProps.db_centroid_x])&&!Number.isNaN(i.tileAttrs[i.tileProps.db_centroid_y])?h=[i.tileAttrs[i.tileProps.db_centroid_x],i.tileAttrs[i.tileProps.db_centroid_y]]:h=AT(r,s,a);const _=te(n.style.height,i),p=i.tileInfo?_o(i.tileInfo,[0,0]):1,m=_*He*p,g=t.idIndexer.getIndex(i,e,n,{floorId:Number.isNaN(l)?void 0:l}),y=t.pointIndexer.getIndex(f),b=Cl(e,n,c,l,d,i);if(m>0){const I=t.getBucket("polygonExtrusion","sideFill",b,Bo.sinks.sideFill.binder);let E=I.indices.offset;d5(I,u,r,s,a,m,g,y,h),I.objectsData[E]={objectId:f,size:I.indices.offset-E};const L=t.getBucket("polygonExtrusion","sideStroke",b,Bo.sinks.sideStroke.binder);l||(E=L.indices.offset,Zm(L,u,r,s,a,h),Xm(L,u,r,s,a,m,h),L.objectsData[E]={objectId:f,size:L.indices.offset-E})}const v=t.getBucket("polygonExtrusion","topFill",b,Bo.sinks.topFill.binder);let T=v.indices.offset;MT(v,u,r,s,m,g,y,h),v.objectsData[T]={objectId:f,size:v.indices.offset-T};const x=t.getBucket("polygonExtrusion","topStroke",b,Bo.sinks.topStroke.binder);T=x.indices.offset,TT(x,u,r,s,a,m,h),x.objectsData[T]={objectId:f,size:x.indices.offset-T}}};function MT(t,e,n,i,o,r,s,a){let l=t.elements.offset;const c=l;Yh(t,l++,n[0],i[0],o,r,s,a),Yh(t,l++,n[1],i[1],o,r,s,a);for(let d=2;d<e;d++)IT(t,c,d),Yh(t,l++,n[d],i[d],o,r,s,a);t.elements.offset=l}function TT(t,e,n,i,o,r,s){for(let a=0;a<e;a++){const l=jn(a,e);if(o&&o[l]===1){const c=jn((a+1)%e,e);Xc(t,n[l],i[l],r,n[c],i[c],r,s)}}}function Yh(t,e,n,i,o,r,s,a){const l=t.elements.stride,c=e*(l/t.views.position.BYTES_PER_ELEMENT);t.views.position[c]=Y+n,t.views.position[c+1]=Y+i,t.views.position[c+2]=$n(o),t.views.position[c+3]=1,t.views.demPosition[c]=(Y+a[0])/8,t.views.demPosition[c+1]=(Y+a[1])/8;const d=e*(l/t.views.localID.BYTES_PER_ELEMENT);t.views.localID[d]=r,t.views.labelingTextureID[d]=s}function IT(t,e,n){const i=t.indices.buffer;let o=t.indices.offset;n%2===0?(i[o++]=e+n-2,i[o++]=e+n-1,i[o++]=e+n):(i[o++]=e+n-1,i[o++]=e+n-2,i[o++]=e+n),t.indices.offset=o}function Pv(t){return(pd-Math.abs(t[0]-pd))**2+(pd-Math.abs(t[1]-pd))**2}function ET(t){return t[0]===0||t[0]===Se||t[1]===0||t[1]===Se}function AT(t,e,n){let i,o=Se**2;const r=t.length,s=es();for(let a=0;a<r;a++){i||kr(s,[t[a],e[a]]);const l=jn(a,r);if(n[l]===0){const c=[t[l],e[l]],d=jn((a+1)%r,r),u=[t[d],e[d]];if(ET(c)){const f=Pv(c);f<o&&(i=c,o=f);const h=Pv(u);h<o&&(i=u,o=h)}else i=[(t[l]+t[d])/2,(e[l]+e[d])/2]}}return i||(i=[],th(i,s)),i}const Pl={type:Es.Striped,cDist:0,oLen:0,sLen:0,localID:0,offsetMultiplier:14,px:[],py:[],count:0};function CT(t,e,n,i){return Pl.cDist=t,Pl.oLen=e,Pl.localID=n,Pl.offsetMultiplier=i,Pl}const dr={symbol:"dashedLine",sinks:{stroke:{stride:28,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.extender=new Int16Array(e,4),t.views.texExtender=new Int8Array(e,8),t.views.vertexDistance=new Float32Array(e,12),t.views.componentDistance=new Float32Array(e,16),t.views.objectLength=new Float32Array(e,20),t.views.localID=new Uint32Array(e,24)},packObjectAttributes(t,e,n,i){return Dt([t,e.innerId,n],e,i)},unpackObjectAttributes(t){return{styleId:t[0],layerId:t[1],tiers:t[2],tileData:t.slice(3)}}},stroke3d:{stride:32,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.extender=new Int16Array(e,4),t.views.texExtender=new Int8Array(e,8),t.views.vertexDistance=new Float32Array(e,12),t.views.componentDistance=new Float32Array(e,16),t.views.objectLength=new Float32Array(e,20),t.views.height=new Float32Array(e,24),t.views.localID=new Uint32Array(e,28)},packObjectAttributes(t,e,n,i){return Dt([t,e.innerId,n],e,i)},unpackObjectAttributes(t){return{styleId:t[0],layerId:t[1],tiers:t[2],tileData:t.slice(3)}}}},generate(t,e,n,i,o,r){const s=jm(te(n.style.geometryModifier,i),o,r,i);if(s===null)return;const{tileAttrs:a,tileProps:l}=i,c=te(n.ignoreTier,i)?null:i.tileAttrs[l.db_tiers],d=n.style.withHeight?t.getBucket(n.type,"stroke3d",dr.sinks.stroke3d.packObjectAttributes(e,n,c,i),dr.sinks.stroke3d.binder):t.getBucket(n.type,"stroke",dr.sinks.stroke.packObjectAttributes(e,n,c,i),dr.sinks.stroke.binder),u=t.idIndexer.getIndex(i,e,n),f=CT(a[l.componentDistanceStart]/Se,a[l.objectLength]/Se,u,n.style.withHeight?dr.sinks.stroke3d.stride/2:dr.sinks.stroke.stride/2),h=Number.isNaN(a[l.beginningIsCut])?!1:a[l.beginningIsCut]!==0,_=Number.isNaN(a[l.endingIsCut])?!1:a[l.endingIsCut]!==0,p=n.style.withHeight?Wm(i,s):void 0;k0(s.x,s.y,p,s.x.length,h?mt.TileCut:mt.Butt,_?mt.TileCut:mt.Butt,a[l.previousPointX],a[l.previousPointY],a[l.nextPointX],a[l.nextPointY],f,d)}},bf=[vt/2,vt/2],Bi={symbol:"buildingModel",sinks:{fill:{stride:24,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.texCoords=new Uint16Array(e,8),t.views.localID=new Uint32Array(e,12),t.views.demPosition=new Int16Array(e,16),t.views.labelingTextureID=new Uint32Array(e,20)},packObjectAttributes:(t,e,n,i,o,r)=>Dt([t,e.innerId,n,o,i],e,r),unpackObjectAttributes:t=>({styleId:t[0],layerId:t[1],texture:t[2],id:t[3],matrix:t[4],tileData:t.slice(5)})},stroke:{stride:16,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.directionDistance=new Int8Array(e,8),t.views.demPosition=new Int16Array(e,12)},packObjectAttributes:(t,e,n,i,o)=>Dt([t,e.innerId,i,n],e,o),unpackObjectAttributes:t=>({styleId:t[0],layerId:t[1],id:t[2],matrix:t[3],tileData:t.slice(4)})}},processSubmesh(t,e,n,i,o,r,s,a,l){const c=n.id??"",d=i.idIndexer.getIndex(n,t,e),u=i.pointIndexer.getIndex(c),f=i.getBucket(e.type,"fill",Bi.sinks.fill.packObjectAttributes(t,e,a,l,c,n),Bi.sinks.fill.binder,s);LT(f,r);for(let h=0;h<o.length;h++)PT(f,o,h,d,u)},processOuterEdge(t,e,n,i,o,r,s){const a=n.id??"",l=i.getBucket(e.type,"stroke",Bi.sinks.stroke.packObjectAttributes(t,e,s,a,n),Bi.sinks.stroke.binder);for(let c=0;c<r.length;c+=2){const d=r[c]*5,u=r[c+1]*5;Xc(l,o[d],o[d+1],o[d+2],o[u],o[u+1],o[u+2],bf,!0)}}};function PT(t,e,n,i,o){const r=t.elements.offset,s=Bi.sinks.fill.stride,a=n*5,l=r*(s/t.views.position.BYTES_PER_ELEMENT),c=r*(s/t.views.localID.BYTES_PER_ELEMENT);t.views.position[l]=e[a],t.views.position[l+1]=e[a+1],t.views.position[l+2]=e[a+2],t.views.texCoords[l]=e[a+3],t.views.texCoords[l+1]=e[a+4],t.views.localID[c]=i,t.views.demPosition[l]=bf[0]/8,t.views.demPosition[l+1]=bf[1]/8,t.views.labelingTextureID[c]=o,t.elements.offset++}function LT(t,e){const n=t.elements.offset;let i=t.indices.offset;for(let o=0;o<e.length;o++)t.indices.buffer[i++]=n+e[o];t.indices.offset=i}const Js=Et(),Ll=Et(),Qs={type:Es.Entrance,offsetMultiplier:18,cDist:0,oLen:0,sLen:0,px:[],py:[],count:0,localID:0};function FT(t,e,n,i){return Qs.px=t.x,Qs.py=t.y,Qs.oLen=n/Se,Qs.count=e,Qs.localID=i,Qs}const Lc={symbol:"arrow",sinks:{stroke:{stride:36,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.segmentEnd=new Uint16Array(e,4),t.views.texExtender=new Int8Array(e,8),t.views.arrowExtender=new Int8Array(e,10),t.views.extender=new Int16Array(e,12),t.views.direction=new Int16Array(e,16),t.views.vertexDistance=new Float32Array(e,20),t.views.objectLength=new Float32Array(e,24),t.views.type=new Float32Array(e,28),t.views.localID=new Uint32Array(e,32)},packObjectAttributes(t,e,n,i){return Dt([t,e.innerId,n>2?1:0],e,i)},unpackObjectAttributes(t){return{styleId:t[0],layerId:t[1],isLongArrow:t[2],tileData:t.slice(3)}}}},generate:(t,e,n,i,o)=>{const r=o.x,s=o.y,a=o.x.length,l=kT(r,s,a),c=t.getBucket(n.type,"stroke",Lc.sinks.stroke.packObjectAttributes(e,n,a,i),Lc.sinks.stroke.binder),d=t.idIndexer.getIndex(i,e,n),u=FT(o,a,l,d);k0(o.x,o.y,void 0,a,mt.Butt,mt.Butt,0,0,0,0,u,c);let f=0;Lv(c,Pc.StartBorder,r[0],s[0],r[1],s[1],0,0,f,l,d);for(let h=0;h<a-1;h++){if(h!==0){const _=r[h]-r[h-1],p=s[h]-s[h-1];f+=Math.sqrt(_*_+p*p)}Lv(c,Pc.Arrow,r[h],s[h],r[h+1],s[h+1],-1,0,f,l,d)}}};function kT(t,e,n){let i=0;for(let o=1;o<n;o++){const r=t[o]-t[o-1],s=e[o]-e[o-1];i+=Math.sqrt(r*r+s*s)}return i}function Lv(t,e,n,i,o,r,s,a,l,c,d){RT(t,1,2,0,0,2,3),vd(t,e,n,i,o,r,s,a,-1,-1,l,c,!0,d),vd(t,e,n,i,o,r,s,a,1,-1,l,c,!1,d),vd(t,e,n,i,o,r,s,a,1,1,l,c,!1,d),vd(t,e,n,i,o,r,s,a,-1,1,l,c,!0,d)}function vd(t,e,n,i,o,r,s,a,l,c,d,u,f,h){const _=t.elements,p=_.stride*_.offset,m=p>>1,g=m>>1;Wo(Js,n,i,o,r),Zr(Ll,Js),t.views.position[m]=Y+n,t.views.position[m+1]=Y+i,t.views.segmentEnd[m]=Y+o,t.views.segmentEnd[m+1]=Y+r,t.views.texExtender[p]=on(Ll[0]*c*(f?-1:1)*Bt),t.views.texExtender[p+1]=on(Ll[1]*c*(f?-1:1)*Bt),t.views.arrowExtender[p]=on(l*Bt),t.views.arrowExtender[p+1]=on(c*Bt);const y=l+s,b=c+a,v=Js[0]*y+Ll[0]*b,T=Js[1]*y+Ll[1]*b;t.views.extender[m]=Math.round(v*Bt*127),t.views.extender[m+1]=Math.round(T*Bt*127),t.views.direction[m]=Math.round(Js[0]*127),t.views.direction[m+1]=Math.round(Js[1]*127),t.views.vertexDistance[g]=d/vt,t.views.objectLength[g]=u/vt,t.views.type[g]=e,t.views.localID[g]=h,t.elements.offset++}function RT(t,e,n,i,o,r,s){const{elements:a,indices:l}=t,{buffer:c,offset:d}=l,u=a.offset;c[d]=u+e,c[d+1]=u+n,c[d+2]=u+i,c[d+3]=u+o,c[d+4]=u+r,c[d+5]=u+s,l.offset=d+6}const Ja={symbol:"circle",sinks:{fill:{stride:20,binder:(t,e)=>{t.views.flatPosition=new Uint16Array(e),t.views.ecefPosition=new Int16Array(e,6),t.views.extender=new Int16Array(e,12),t.views.localID=new Uint32Array(e,16)},packObjectAttributes:(t,e,n)=>Dt([t,e.innerId],e,n),unpackObjectAttributes:t=>({styleId:t[0],layerId:t[1],tileData:t.slice(2)})}},generate(t,e,n,i,o){const r=t.getBucket(n.type,"fill",Ja.sinks.fill.packObjectAttributes(e,n,i),Ja.sinks.fill.binder),s=t.idIndexer.getIndex(i,e,n),a=[o.x[0],o.y[0],o.z?o.z[0]:0],l=i.tileInfo?I0(i.tileInfo,a):[0,0,0];zT(r,0,2,1,0,3,2),yd(r,a,l,-1,-1,s),yd(r,a,l,-1,1,s),yd(r,a,l,1,1,s),yd(r,a,l,1,-1,s)}};function yd(t,[e,n,i],o,r,s,a){const c=t.elements.offset*t.elements.stride>>1,d=c>>1;t.views.flatPosition[c]=Y+e,t.views.flatPosition[c+1]=Y+n,t.views.flatPosition[c+2]=$n(i),t.views.ecefPosition[c]=o[0]*Vn,t.views.ecefPosition[c+1]=o[1]*Vn,t.views.ecefPosition[c+2]=o[2]*Vn,t.views.extender[c]=r,t.views.extender[c+1]=s,t.views.localID[d]=a,t.elements.offset++}function zT(t,e,n,i,o,r,s){const{elements:a,indices:l}=t,{buffer:c,offset:d}=l,u=a.offset;c[d]=u+e,c[d+1]=u+n,c[d+2]=u+i,c[d+3]=u+o,c[d+4]=u+r,c[d+5]=u+s,l.offset=d+6}const ea=Et(),ta=Et(),Fv=Et(),kv=Et(),qh=(t,e,n)=>Dt([t,e.innerId],e,n),Kh=t=>({styleId:t[0],layerId:t[1],tileData:t.slice(2)}),Fl=B3(1),ko={symbol:"lineExtrusion",sinks:{fill:{stride:12,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.demPosition=new Int16Array(e,8)},packObjectAttributes:qh,unpackObjectAttributes:Kh},topStroke:{stride:16,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.directionDistance=new Int8Array(e,8),t.views.demPosition=new Int16Array(e,12)},packObjectAttributes:qh,unpackObjectAttributes:Kh},sideStroke:{stride:20,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.distance=new Int16Array(e,6),t.views.normals=new Int8Array(e,8),t.views.direction=new Int8Array(e,12),t.views.demPosition=new Int16Array(e,16)},packObjectAttributes:qh,unpackObjectAttributes:Kh}},generate(t,e,n,i,o){const r=o.x,s=o.y,a=r.length,l=t.getBucket(n.type,"fill",ko.sinks.fill.packObjectAttributes(e,n,i),ko.sinks.fill.binder),c=t.getBucket(n.type,"topStroke",ko.sinks.topStroke.packObjectAttributes(e,n,i),ko.sinks.topStroke.binder),d=t.getBucket(n.type,"sideStroke",ko.sinks.sideStroke.packObjectAttributes(e,n,i),ko.sinks.sideStroke.binder);for(let u=0;u<a-1;u++){const f=r[u],h=s[u],_=r[u+1],p=s[u+1];Yt(ea,f,_),Yt(ta,h,p),Yt(Fv,_,f),Yt(kv,p,h),d5(l,2,ea,ta,void 0,Fl),Xc(c,f,h,Fl,_,p,Fl),Zm(d,2,ea,ta,void 0),Zm(d,2,Fv,kv,void 0),Xm(d,2,ea,ta,void 0,Fl)}Yt(ea,r[a-1],r[0]),Yt(ta,s[a-1],s[0]),Xm(d,2,ea,ta,void 0,Fl)}};function BT(t){const e=Math.log(t)*256;return e+(e<0?-.5:.5)<<16>>16}function qn(t){return t*32768+.5<<16>>>16}function OT(t){return Math.log(t)*256+.5<<16>>16}const wf={symbol:"raster",sinks:{fill:{stride:8,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.txtrCoords=new Uint16Array(e,4)},packObjectAttributes(t,e,n,i,o){return Dt([t,e.innerId,i,o],e,n)},unpackObjectAttributes(t){return{styleId:t[0],layerId:t[1],textureIndex:t[2],tiers:t[3],tileData:t.slice(4)}}}},generate(t,e,n,i,o,r,s){const a=e.x,l=e.y,c=t.getBucket(o.type,"fill",wf.sinks.fill.packObjectAttributes(n,o,i,r,s),wf.sinks.fill.binder);let d=c.elements.offset;DT(c.indices,d,0,1,2,2,1,3),bd(c,d++,a[0],l[0],0,1),bd(c,d++,a[1],l[1],1,1),bd(c,d++,a[2],l[2],0,0),bd(c,d++,a[3],l[3],1,0),c.elements.offset=d}};function bd(t,e,n,i,o,r){e=e*4,t.views.position[e]=Y+n,t.views.position[e+1]=Y+i,t.views.txtrCoords[e]=qn(o),t.views.txtrCoords[e+1]=qn(r)}function DT(t,e,n,i,o,r,s,a){const l=t.buffer,c=t.offset;l[c]=e+n,l[c+1]=e+i,l[c+2]=e+o,l[c+3]=e+r,l[c+4]=e+s,l[c+5]=e+a,t.offset=c+6}function NT(t){return!!t&&t.type==="polygon"}function wd(t){return!!t&&t.type==="line"}function f5(t){return t.reduce((e,n,i)=>(e[n]=i,e),{})}function UT(t){return t===void 0||typeof t=="boolean"?!!t:!!JSON.stringify(t).match(/\["get","(db_)?sublayer"]/)}function Rv(t,e,n,i,o){return Dt([t,e.innerId,n,i],e,o)}const GT=(t,e,n,i,o)=>Dt([t,e.innerId,n,i],e,o),zv=t=>({styleId:t[0],layerId:t[1],tiers:t[2],floorId:t[3],tileData:t.slice(4)}),HT=t=>({styleId:t[0],layerId:t[1],tiers:t[2],floorId:t[3],tileData:t.slice(4)}),Oo={symbol:"polygon",sinks:{fill:{stride:8,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.localID=new Uint32Array(e,4)},packObjectAttributes:Rv,unpackObjectAttributes:zv},stroke:{stride:8,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.directionDistance=new Int8Array(e,4)},packObjectAttributes:Rv,unpackObjectAttributes:zv},shadow:{stride:4,binder:(t,e)=>{t.views.position=new Uint16Array(e)},packObjectAttributes:GT,unpackObjectAttributes:HT}},generate(t,e,n,i,o,r,s){if(i.tileAttrs[i.tileProps.db_geometry_type]==="polyline")return;const l=o.x,c=o.y,d=o.cut,u=i.tileAttrs[i.tileProps.db_plan_id]||"";NT(n)&&s&&c5(t,e,s,n.style,r);const f=t.idIndexer.getIndex(i,e,n,{floorId:u||void 0}),h=i.id??"",_=n.type==="polygon"&&!te(n.ignoreTier,i)?i.tileAttrs[i.tileProps.db_tiers]:null,p=t.getBucket("polygon","fill",Oo.sinks.fill.packObjectAttributes(e,n,_,u,i),Oo.sinks.fill.binder),m=p.indices.offset;h5(p,l.length,l,c,f),p.objectsData[m]={objectId:h,size:p.indices.offset-m};const g=t.getBucket("polygon","stroke",Oo.sinks.stroke.packObjectAttributes(e,n,_,u,i),Oo.sinks.stroke.binder);if(d){const y=g.indices.offset;VT(g,l.length,l,c,d),g.objectsData[y]={objectId:h,size:g.indices.offset-y}}}};function h5(t,e,n,i,o){const r=t.indices.buffer;let s=t.indices.offset,a=t.elements.offset;const l=a;Jh(t,a++,n[0],i[0],o),Jh(t,a++,n[1],i[1],o);for(let c=2;c<e;c++)jT(r,s,l,c),Jh(t,a++,n[c],i[c],o),s=s+3;t.elements.offset=a,t.indices.offset=s}function VT(t,e,n,i,o){for(let r=0;r<e;r++){const s=jn(r,e);if(o[s]===1){const a=jn((r+1)%e,e);Xc(t,n[s],i[s],0,n[a],i[a],0)}}}function Jh(t,e,n,i,o){e=e*t.elements.stride/t.views.position.BYTES_PER_ELEMENT,t.views.position[e]=Y+n,t.views.position[e+1]=Y+i,e=e>>1,"localID"in t.views&&(t.views.localID[e]=o)}function jT(t,e,n,i){i%2===0?(t[e]=n+i-2,t[e+1]=n+i-1,t[e+2]=n+i):(t[e]=n+i-1,t[e+1]=n+i-2,t[e+2]=n+i)}function $T(t,e,n=[],i=[]){return{x:Bv(n,t),y:Bv(i,e)}}function Bv(t,e){const n=t.reduce((o,r)=>o.concat(r),[0]).concat(e),i=n.length-1;return{coords:n.slice(n[0]===n[1]?1:0,n[i-1]===n[i]?i:i+1),isOddStretchable:WT(t)}}function WT(t){var e;return!((e=t==null?void 0:t[0])!=null&&e[0])}function ZT(t,e,n,i,o){return[Ov(t.x,e,i[0],o),Ov(t.y,n,i[1],o)]}function Ov(t,e,n,i){if(t.coords.length<2)throw new Error("The source coords array must have at least two coordinates");return t.coords.map((o,r)=>(e+o+i*(r===0?-1:r===t.coords.length-1?1:0))/n)}function XT(t,e,n,i,o=0,r=0){return[Nv(Dv(t.x,e),i,o),Nv(Dv(t.y,n),i,r)]}function Dv(t,e){const{stretchSize:n,fixSize:i}=YT(t),{coords:o,isOddStretchable:r}=t,s=e<i?i:e,a=[o[0]];for(let l=1;l<o.length;l++){const c=o[l-1],d=o[l],u=l%2===(r?1:0),f=a[a.length-1];if(!u){a.push(f+d-c);continue}a.push(Math.round((s-i)*(d-c)/n)+f)}return a}function YT({coords:t,isOddStretchable:e}){if(t.length<2)throw new Error("An axis must have at least two coordinates");if(t.length===2)return{stretchSize:t[t.length-1],fixSize:0};let n=0;for(let i=e?0:1;i<t.length-1;i=i+2)n+=t[i+1]-t[i];return{stretchSize:n,fixSize:t[t.length-1]-n}}function Nv(t,e,n=0){const i=t[t.length-1]-t[0],o=t.map(r=>Math.round(r-i/2+n));return o.length===2?o[o.length-1]+=2*e:(o[0]-=e,o[o.length-1]+=e),o}function qT(t,e,n,i,o,r,s,a,l){const c=$T(n.w,n.h,a,l),d=ZT(c,n.x,n.y,e,Ng),u=XT(c,i,o,Ng,r,s);t.set(u,d)}function KT(t,e,n,i,o,r,s,a,l,c,d,u){const{textureX:f,textureY:h,stretchedX:_,stretchedY:p,countX:m,countY:g}=o,y=s!==-1/0?s:ox,b=a!==1/0?a:rx,[v,T]=u;for(let x=0;x<m-1;x++){const I=f[x],E=f[x+1],L=_[x],N=_[x+1];for(let k=0;k<g-1;k++){const w=h[k],S=h[k+1],A=p[k],z=p[k+1];_5(r,0,2,1,1,2,3),xd(r,t,e,n,i,L,A,I,w,v,T,y,b,l,c,d),xd(r,t,e,n,i,N,A,E,w,v,T,y,b,l,c,d),xd(r,t,e,n,i,L,z,I,S,v,T,y,b,l,c,d),xd(r,t,e,n,i,N,z,E,S,v,T,y,b,l,c,d)}}}const as=[0,0];function JT(t,e,n,i,o,r,s){const{stretchedX:a,stretchedY:l}=i,c=Math.ceil((a[a.length-1]-a[0])/2),d=Math.ceil((l[l.length-1]-l[0])/2),u=r*u0/2;as[0]=a[0]+c,as[1]=l[0]+d;const f=as[0]-u,h=as[0]+u,_=as[1]-u,p=as[1]+u;return _5(o,0,2,1,1,2,3),Sd(o,t,e,n,f,_,s),Sd(o,t,e,n,h,_,s),Sd(o,t,e,n,f,p,s),Sd(o,t,e,n,h,p,s),as}function xd(t,e,n,i,o,r,s,a,l,c,d,u,f,h,_,p){let m=t.elements.offset*20;t.views.flatPosition[m]=Y+e,t.views.flatPosition[m+1]=Y+n,t.views.flatPosition[m+2]=$n(i),t.views.ecefPosition[m]=o[0]*Vn,t.views.ecefPosition[m+1]=o[1]*Vn,t.views.ecefPosition[m+2]=o[2]*Vn,t.views.cornerOffset[m]=r,t.views.cornerOffset[m+1]=-s,t.views.checkPointOffset[m]=c,t.views.checkPointOffset[m+1]=d,t.views.texCoords[m]=qn(a),t.views.texCoords[m+1]=qn(l),t.views.scales[m]=OT(u),t.views.scales[m+1]=BT(f),m=m>>1,t.views.localID[m]=h,t.views.labelingTextureID[m]=_,t.views.spritePointTextureID[m]=p,t.elements.offset++}function Sd(t,e,n,i,o,r,s){const a=t.elements,l=a.stride*a.offset>>1;t.views.position[l]=Y+e,t.views.position[l+1]=Y+n,t.views.position[l+2]=$n(i),t.views.cornerOffset[l]=o,t.views.cornerOffset[l+1]=-r,t.views.labelingTextureID[l>>1]=s,a.offset++}function _5(t,e,n,i,o,r,s){const{elements:a,indices:l}=t,{buffer:c,offset:d}=l,u=a.offset;c[d]=u+e,c[d+1]=u+n,c[d+2]=u+i,c[d+3]=u+o,c[d+4]=u+r,c[d+5]=u+s,l.offset=d+6}class QT{constructor(){this.countX=0,this.countY=0,this.textureX=[],this.textureY=[],this.stretchedX=[],this.stretchedY=[]}reset(){this.countX=0,this.countY=0}set(e,n){this.countX=n[0].length,this.countY=n[1].length,this.textureX=n[0],this.textureY=n[1],this.stretchedX=e[0],this.stretchedY=e[1]}isEmpty(){return this.countX===0||this.countY===0}}var di=(t=>(t[t.Common=0]="Common",t[t.Commercial=1]="Commercial",t[t.CommercialCity=2]="CommercialCity",t[t.CommercialPremium=3]="CommercialPremium",t[t.Landmark=4]="Landmark",t))(di||{}),qu=(t=>(t[t.Point=0]="Point",t[t.Line=1]="Line",t))(qu||{}),Yc=(t=>(t[t.Tile=0]="Tile",t[t.Floor=1]="Floor",t[t.DynamicObject=2]="DynamicObject",t[t.PersonalPoi=3]="PersonalPoi",t))(Yc||{}),Ln=(t=>(t[t.Dead=0]="Dead",t[t.Alive=1]="Alive",t[t.Unused=2]="Unused",t[t.CommercialAlive=3]="CommercialAlive",t[t.CommercialDead=4]="CommercialDead",t))(Ln||{}),Do=(t=>(t[t.Text=0]="Text",t[t.Icon=1]="Icon",t[t.PoiText=2]="PoiText",t[t.PoiText2=3]="PoiText2",t[t.OneWayLine=4]="OneWayLine",t[t.LineText=5]="LineText",t[t.Box=6]="Box",t))(Do||{});let eI=Math.random;var Qa=(t=>(t[t.Point=0]="Point",t[t.Line=1]="Line",t[t.OneWayLine=2]="OneWayLine",t))(Qa||{});function Un(t,e){return Number.isNaN(t)?e:t}function Ym(t){return t.pointType===di.Commercial||t.pointType===di.CommercialCity||t.pointType===di.CommercialPremium}const Qh=new Map;class B0{constructor(e,n,i,o,r,s,a){if(this.anchorWorld=[0,0,0,0],this.anchorGeo=[0,0],this.groupPriority=0,this.labelingGroup=Yr,this.marginTopBottom=0,this.marginLeftRight=0,this.elevation=0,this.type=n,this.label=e,this.layer=e.layer,this.elevation=e.elevation,this.id=e.id+"_"+n+"_"+Math.floor(i[0]/1e3)+"_"+Math.floor(i[1]/1e3)+this.getIconLabelPriorityToId(e),eh(this.anchorWorld,i),this.anchorGeo=e.geoPoint,o!==0&&(this.anchorWorld[2]*=o),a){const l=Rn.fromGeo(this.anchorGeo);this.anchorScreen=r.ecef.project(l,!1)}else this.anchorScreen=r.flat.project([this.anchorWorld[0],this.anchorWorld[1],this.anchorWorld[2]+this.elevation,0]);switch(this.anchorPosition=0,this.anchorSegmentIndex=0,this.halfLabelWidth=0,this.commPriorityRandomFactor=NaN,this.itemPriority=n===Do.Icon?e.iconPriority:e.labelPriority,this.layer.type){case"labelLine":this.labelingGroup=this.layer.style.labelingGroup,this.groupPriority=e.styleTextPriority;break;case"oneWayLine":this.labelingGroup=this.layer.style.labelingGroup,this.groupPriority=this.layer.style.priority;break;case"point":{if(Ym(e))if(Qh.has(this.label.id))this.commPriorityRandomFactor=Qh.get(this.label.id);else{const l=eI();this.commPriorityRandomFactor=l,Qh.set(this.label.id,l)}n===Do.PoiText?(this.labelingGroup=this.layer.style.allowOverlap?Ts:this.layer.style.textLabelingGroup,this.groupPriority=this.layer.style.iconImage?Math.min(e.styleTextPriority,e.styleIconPriority):e.styleTextPriority,this.marginTopBottom=this.layer.style.textLabelingMargin.topBottom,this.marginLeftRight=this.layer.style.textLabelingMargin.leftRight):n===Do.PoiText2?(this.labelingGroup=this.layer.style.allowOverlap?Ts:this.layer.style.textLabelingGroup2,this.groupPriority=Math.min(e.styleTextPriority,e.styleIconPriority),this.marginTopBottom=this.layer.style.textLabelingMargin.topBottom,this.marginLeftRight=this.layer.style.textLabelingMargin.leftRight):(this.labelingGroup=this.layer.style.allowOverlap?Ts:this.layer.style.iconLabelingGroup,this.groupPriority=e.styleIconPriority,this.marginTopBottom=this.layer.style.iconLabelingMargin.topBottom,this.marginLeftRight=this.layer.style.iconLabelingMargin.leftRight);break}}this.labelingGroupTable=s.labelingGroups.table,this.overflowStyleZoom=-1/0,this.boxes=[],this.placementIndex=0}getIconLabelPriorityToId(e){if(Ym(e))return"";const{layer:n}=e;if(n.type==="point"){const i=e.styleIconPriority.toFixed(0),o=e.styleTextPriority.toFixed(0);return"_"+i+"_"+o}return""}}function Uv(t,e,n,i,o,r){if(!t||o&&!r)return[0,0];if(!r)return[t.w/e,t.h/e];const s=qm(n,i,r),a=Dn(n.style.iconTextPadding);return[a[3]+a[1]+s[0],a[0]+a[2]+s[1]]}function dh(t,e,n){return O0(K(t.style.textFontSize,e),t.style.textLineHeight,n)}function m5(t,e,n){return O0(K(t.style.textFontSize2,e),t.style.textLineHeight,n)}function qm(t,e,n){return O0(K(t.style.iconTextFontSize,e),t.style.iconTextLineHeight,n)}function O0(t,e,n){const o=t/Gi.baseSize*n.maxWidth,r=t*e*n.lines.length;return[o,r]}function Gv(t,e,n){const i=n[0]??0,o=n[1]??0;return[(.5-t.anchorX)*e[0]+i,(.5-t.anchorY)*e[1]+o]}function tI(t,e,n){const i=e[0]??.5,o=e[1]??.5,r=n[0]??0,s=n[1]??0;return[(.5-i)*t[0]+r,(.5-o)*t[1]+s]}function Hv(t,e,n,i,o){const r=n[0]??.5,s=n[1]??.5,a=o[0]??0,l=o[1]??0;return[t[0]/2-r*e[0]-i[3]+a,t[1]/2-s*e[1]-i[0]+l]}function uh(t,e,n,i,o){const r=e[0],s=e[1],a=n[0],l=n[1];let c=0,d=0;const u=l/2+s/2,f=l/2-s/2,h=-u,_=-f,p=a/2+r/2,m=a/2-r/2,g=-p,y=-m;switch(t){case"bottomCenter":d=u+o;break;case"rightCenter":c=p+o;break;case"topCenter":d=h-o;break;case"leftCenter":c=g-o;break;case"bottomRight":c=m,d=u+o;break;case"topRight":c=m,d=h-o;break;case"bottomLeft":c=y,d=u+o;break;case"rightBottom":c=p+o,d=_;break;case"rightTop":c=p+o,d=f;break;case"topLeft":c=y,d=h-o;break;case"leftTop":c=g-o,d=f;break;case"leftBottom":c=g-o,d=_;break}return[c+i[0],d+i[1]]}function Km(t){return!!t&&"stretchX"in t&&Array.isArray(t.stretchX)&&"stretchY"in t&&Array.isArray(t.stretchY)&&"width"in t&&typeof t.width=="number"&&"height"in t&&typeof t.height=="number"}function D0(t,e){const n=e.precomputes;return t.map((i,o)=>{const r=n[o];return r&&r.usage===Fn.Uniform?i:null})}var lo=(t=>(t[t.Icon=0]="Icon",t[t.First=1]="First",t[t.Second=2]="Second",t))(lo||{});const e_=new QT,na=[0,0,0];let kl=[0,0,0];const gr={symbol:"point",sinks:{raster:{stride:40,binder:(t,e)=>{t.views.flatPosition=new Uint16Array(e),t.views.ecefPosition=new Int16Array(e,6),t.views.cornerOffset=new Int16Array(e,12),t.views.checkPointOffset=new Int16Array(e,16),t.views.texCoords=new Uint16Array(e,20),t.views.scales=new Int16Array(e,24),t.views.localID=new Uint32Array(e,28),t.views.labelingTextureID=new Uint32Array(e,32),t.views.spritePointTextureID=new Uint32Array(e,36)},packObjectAttributes:(t,e,n,i,o,r)=>pc([t.styleId,t.layer.innerId,e,n,i,o],r),unpackObjectAttributes:t=>({styleId:t[0],layerId:t[1],animDirection:t[2],atlasIndex:t[3],labelTest:t[4],floorId:t[5],tileData:t.slice(6)})},text:{stride:36,binder:(t,e)=>{t.views.flatPosition=new Uint16Array(e),t.views.ecefPosition=new Int16Array(e,6),t.views.cornerOffset=new Int16Array(e,12),t.views.checkPointOffset=new Int16Array(e,16),t.views.texCoords=new Uint16Array(e,20),t.views.localID=new Uint32Array(e,24),t.views.labelingTextureID=new Uint32Array(e,28),t.views.spritePointTextureID=new Uint32Array(e,32)},packObjectAttributes:(t,e,n,i,o,r,s,a)=>pc([t.styleId,t.layer.innerId,e,n,i[0],-i[1],o,r,s],a),unpackObjectAttributes:t=>({styleId:t[0],layerId:t[1],animDirection:t[2],range:t[3],offsetX:t[4],offsetY:t[5],labelIndex:t[6],fontIndex:t[7],floorId:t[8],tileData:t.slice(9)})},labelingTexture:{stride:16,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.cornerOffset=new Int16Array(e,8),t.views.labelingTextureID=new Uint32Array(e,12)},packObjectAttributes:(t,e=[0,0])=>pc([t.styleId,t.layer.innerId,e[0],-e[1],t.floorId],[]),unpackObjectAttributes:t=>({styleId:t[0],layerId:t[1],offsetX:t[2],offsetY:t[3],floorId:t[4],tileData:t.slice(5)})}},processElement(t,e,n,i,o,r,s){const{layer:a,label:l}=n;if(a.type!=="point")return;const c=qr(r.styleZoom,r.styleState,!0,l.tileData),d=Vv(c,t,o,l),u=t.icons[Hn(a.style.iconImage,c)],f=Km(u),h=Uv(d,o,a,c,f,l.iconTextMetrics),_=Dn(a.style.iconTextOffset),p=Dn(a.style.iconTextPadding);let m,g=[0,0];if(d)if(l.iconTextMetrics){const v=Dn(a.style.iconTextAnchor);m=qm(a,c,l.iconTextMetrics),g=Hv(h,m,v,p,_)}else{const v=Dn(a.style.iconOffset);g=Gv(d,h,v)}mi(na,n.anchorWorld,s);const{globeInterStartZoom:y}=$o;if(!(!(r.globeMode&&r.zoom<y)&&!T0(na)))switch(kl=Rn.fromGeo(n.anchorGeo),n.type){case Do.Icon:if(!d||f&&!l.iconTextMetrics)return;const v=f?u.stretchX:void 0,T=f?u.stretchY:void 0;if(rI(e,l,na,kl,i,d,h[0]*o,h[1]*o,g[0]*o,g[1]*o,o,v==null?void 0:v.map(([I,E])=>[I*o,E*o]),T==null?void 0:T.map(([I,E])=>[I*o,E*o])),!m)return;const x=Dn(a.style.iconTextAnchor);nI(t,e,n.label,na,kl,r,i,tI(m,x,_),a,o);return;case Do.PoiText:iI(t,e,n,na,kl,h,r,i,g,a,o);return;case Do.PoiText2:oI(t,e,n,na,kl,h,r,i,g,a,o);return}},getLabelingInfo(t,e,n,i,o,r){const{layer:s}=t;if(s.type!=="point")return;t.labelingElements.length=0;const a=qr(i.styleZoom,i.styleState,!0,t.tileData),l=Vv(a,n,r,t),c=n.icons[Hn(s.style.iconImage,a)],d=Km(c),u=Uv(l,r,s,a,d,t.iconTextMetrics);let f,h=[0,0];if(l&&(!d||t.iconTextMetrics)){if(t.iconTextMetrics){const g=Dn(s.style.iconTextAnchor),y=Dn(s.style.iconTextOffset),b=Dn(s.style.iconTextPadding);f=qm(s,a,t.iconTextMetrics),h=Hv(u,f,g,b,y)}else{const g=Dn(s.style.iconOffset);h=Gv(l,u,g)}const m=new B0(t,Do.Icon,e,i.buildingHeight,o,n,i.globeMode);m.boxes.push([-u[0]/2+h[0],-u[1]/2+h[1],u[0]/2+h[0],u[1]/2+h[1]]),t.labelingElements.push(m)}const _=Hn(s.style.textFont,a);t.label.length>0&&_.length&&(sI(t,e,n,u,i,o,h,s),t.label2&&aI(t,e,n,u,i,o,h,s))}};function nI(t,e,n,i,o,r,s,a,l,c){const{iconTextMetrics:d}=n;if(!d||!l.style.iconTextFont)return;const u=qr(r.styleZoom,r.styleState,!1,n.tileData),f=Hn(l.style.iconTextFont,u),h=t.fontNameToIndex[f]??t.fontNameToIndex[Ss];N0(e,n,0,d,i,o,s,a,l,h,c)}function iI(t,e,n,i,o,r,s,a,l,c,d){const{label:u}=n,{textMetrics:f}=u,h=qr(s.styleZoom,s.styleState,!1,u.tileData),_=Hn(c.style.textFont,h);if(!_.length)return;const p=dh(c,h,f),m=t.fontNameToIndex[_]??t.fontNameToIndex[Ss],g=n.parent?ch(c.style.textPlacement,h):"centerCenter",y=K(c.style.textOffset,h),b=uh(g,r,p,l,y);N0(e,u,1,u.textMetrics,i,o,a,b,c,m,d)}function oI(t,e,n,i,o,r,s,a,l,c,d){const{label:u}=n,{textMetrics:f,textMetrics2:h}=u;if(!h||!c.style.textFont2)return;const _=qr(s.styleZoom,s.styleState,!1,u.tileData),p=dh(c,_,f),m=m5(c,_,h),g=K(c.style.textOffset,_),y=K(c.style.textOffset2??0,_,0),b=Hn(c.style.textFont2,_),v=t.fontNameToIndex[b]??t.fontNameToIndex[Ss],T=uh(ch(c.style.textPlacement,_),r,[m[0],p[1]],l,g);T[1]+=(p[1]+m[1])/2+y,N0(e,u,2,h,i,o,a,T,c,v,d)}function N0(t,e,n,i,o,r,s,a,l,c,d){if(n===1&&e.labelingElements.length===1){const f=t.getBucket("point","labelingTexture",gr.sinks.labelingTexture.packObjectAttributes(e),gr.sinks.labelingTexture.binder);e.checkPointOffset=cI(f,o,i,l,d,e.labelingTextureIndex)}const u={};for(const f of e.ranges)u[f]=t.getBucket("point","text",gr.sinks.text.packObjectAttributes(e,s,f,a,n,c,e.floorId,D0(e.tileData,l)),gr.sinks.text.binder);lI(u,e,o,r,i,l,n,e.checkPointOffset)}function rI(t,e,n,i,o,r,s,a,l,c,d,u,f){if(s<=0||a<=0)return;const h=e.layer;if(h.type!=="point")return;qT(e_,tn,r,s,a,l,c,u,f),t.atlasPacker.addRastersToLoad(e.styleId,r);const _=t.getBucket("point","labelingTexture",gr.sinks.labelingTexture.packObjectAttributes(e),gr.sinks.labelingTexture.binder);e.checkPointOffset=JT(n[0],n[1],n[2],e_,_,d,e.labelingTextureIndex);const p=t.getBucket("point","raster",gr.sinks.raster.packObjectAttributes(e,o,r.atlasIndex,u!==void 0||f!==void 0,e.floorId,D0(e.tileData,h)),gr.sinks.raster.binder);KT(n[0],n[1],n[2],i,e_,p,-1/0,1/0,e.identifyIndex,e.labelingTextureIndex,e.spritePointTextureIndex,e.checkPointOffset)}function sI(t,e,n,i,o,r,s,a){const{textMetrics:l}=t;if(!l)return;const c=qr(o.styleZoom,o.styleState,!1,t.tileData),d=K(a.style.textOffset,c),u=dh(a,c,l),f=new B0(t,Do.PoiText,e,o.buildingHeight,r,n,o.globeMode);t.labelingElements.length>0&&(f.parent=t.labelingElements[0]);const h=f.parent?ch(a.style.textPlacement,c):"centerCenter",_=uh(h,i,u,s,d);f.boxes.push([_[0]-u[0]/2,_[1]-u[1]/2,_[0]+u[0]/2,_[1]+u[1]/2]),t.labelingElements.push(f)}function aI(t,e,n,i,o,r,s,a){const{textMetrics:l,textMetrics2:c}=t;if(!c)return;const d=qr(o.styleZoom,o.styleState,!1,t.tileData),u=dh(a,d,l),f=m5(a,d,c),h=K(a.style.textOffset,d),_=K(a.style.textOffset2??0,d,0),p=new B0(t,Do.PoiText2,e,o.buildingHeight,r,n,o.globeMode);t.labelingElements.length>1?(p.parent=t.labelingElements[0],p.firstLabel=t.labelingElements[1]):t.labelingElements.length>0&&(p.parent=t.labelingElements[0],p.firstLabel=t.labelingElements[0]);const m=uh(ch(a.style.textPlacement,d),i,[f[0],u[1]],s,h);m[1]+=(u[1]+f[1])/2+_,p.boxes.push([m[0]-f[0]/2,m[1]-f[1]/2,m[0]+f[0]/2,m[1]+f[1]/2]),t.labelingElements.push(p)}function Vv(t,e,n,i){const{rasterSets:o}=e,{layer:r}=i;if(r.type!=="point")return;let s;const a=Ym(i);if(a||i.pointType===di.Landmark)s=o.byKey[A0(i.id,a?"commercial":"landmark")];else{const l=Hn(r.style.iconImage,t);if(l.length){const c=Dn(r.style.iconAnchor);s=o.byKey[hl(l,c[0],c[1])]}}if(s){const l=K(r.style.iconWidth,t),c=ml(s.rasters,l*n,!0);if(c!==void 0)return s.rasters[c]}}const Md=[0,0];function lI(t,e,n,i,o,r,s,a){let{textLineHeight:d,textLetterSpacing:u}=r.style;s===lo.Icon&&(d=r.style.iconTextLineHeight,u=r.style.iconTextLetterSpacing);const{identifyPoiLabelIndex:f,labelingTextureIndex:h,spritePointTextureIndex:_}=e,{lines:p,maxWidth:m}=o,g=d*Gi.baseSize;let y=p5(1,g,p.length);for(let b=0;b<p.length;b++){const v=p[b].width;let T=0;T=-v/2,Md[0]=T,Md[1]=y;const x=p[b].glyphs;for(let I=0;I<x.length;I++){const E=x[I];E.bitmap!==void 0&&fI(t[E.range],n,i,Md,E,f,h,_,a),Md[0]+=E.advance+Gi.baseSize*u}y-=g}}const bo=[0,0];function cI(t,e,n,i,o,r){const{lines:s,maxWidth:a}=n;if(!s.length)return bo[0]=0,bo[1]=0,bo;const{textLineHeight:l}=i.style,c=l*Gi.baseSize,d=-a/2,u=p5(1,c,s.length),f=a/2,h=u-(s.length-1)*c;bo[0]=o*(d+f)/2,bo[1]=o*(u+h)/2;const _=o*u0/2,p=bo[0]-_,m=bo[0]+_,g=bo[1]+_,y=bo[1]-_,b=t.elements.offset;return fh(t.indices,b,1,0,3,2,3,0),Id(t,e,p,g,r),Id(t,e,m,g,r),Id(t,e,p,y,r),Id(t,e,m,y,r),bo}function dI(t,e,n,i,o,r,s){const a=n[1]+i.top,l=n[0]+i.left,c=a-i.height,d=l+i.width,u=Math.sin(o),f=Math.cos(o),h=l*f-a*u,_=l*u+a*f,p=d*f-a*u,m=d*u+a*f,g=l*f-c*u,y=l*u+c*f,b=d*f-c*u,v=d*u+c*f,T=t.elements.offset;Ed(t,e,h,_,i.texLeft,i.texTop,r,s),Ed(t,e,p,m,i.texRight,i.texTop,r,s),Ed(t,e,g,y,i.texLeft,i.texBottom,r,s),Ed(t,e,b,v,i.texRight,i.texBottom,r,s),fh(t.indices,T,1,0,3,2,3,0)}function uI(t,e,n){const i=t.elements.offset,o=on(Math.cos(n)),r=on(Math.sin(n));Ad(t,e,o,r,-1,-1),Ad(t,e,o,r,1,-1),Ad(t,e,o,r,1,1),Ad(t,e,o,r,-1,1),fh(t.indices,i,0,1,2,2,3,0)}function p5(t,e,n){let i;switch(t){case 0:i=e/2+e*(n-1);break;case 2:i=-e/2;break;default:i=n&1?e*(n>>1):e/2+e*(n-1>>1)}return i}function fI(t,e,n,i,o,r,s,a,l){const c=i[1]+o.top,d=i[0]+o.left,u=c-o.height,f=d+o.width,[h,_]=l,p=t.elements.offset;Td(t,e,n,d,c,o.texLeft,o.texTop,h,_,r,s,a),Td(t,e,n,f,c,o.texRight,o.texTop,h,_,r,s,a),Td(t,e,n,d,u,o.texLeft,o.texBottom,h,_,r,s,a),Td(t,e,n,f,u,o.texRight,o.texBottom,h,_,r,s,a),fh(t.indices,p,1,0,3,2,3,0)}function Td(t,e,n,i,o,r,s,a,l,c,d,u){const f=t.elements,h=f.stride*f.offset>>1,_=h>>1;t.views.flatPosition[h]=Y+e[0],t.views.flatPosition[h+1]=Y+e[1],t.views.flatPosition[h+2]=$n(e[2]),t.views.ecefPosition[h]=n[0]*Vn,t.views.ecefPosition[h+1]=n[1]*Vn,t.views.ecefPosition[h+2]=n[2]*Vn,t.views.cornerOffset[h]=i,t.views.cornerOffset[h+1]=o,t.views.checkPointOffset[h]=a,t.views.checkPointOffset[h+1]=l,t.views.texCoords[h]=r,t.views.texCoords[h+1]=s,t.views.localID[_]=c,t.views.labelingTextureID[_]=d,t.views.spritePointTextureID[_]=u,f.offset++}function Id(t,e,n,i,o){const r=t.elements,s=r.stride*r.offset>>1;t.views.position[s]=Y+e[0],t.views.position[s+1]=Y+e[1],t.views.position[s+2]=$n(e[2]),t.views.cornerOffset[s]=n,t.views.cornerOffset[s+1]=i,t.views.labelingTextureID[s>>1]=o,r.offset++}function Ed(t,e,n,i,o,r,s,a){const l=t.elements;let c=l.stride*l.offset>>1;t.views.position[c]=Y+e[0],t.views.position[c+1]=Y+e[1],t.views.position[c+2]=$n(e[2]),t.views.texCoords[c]=o,t.views.texCoords[c+1]=r,c=c>>1,t.views.cornerOffset[c]=n,t.views.cornerOffset[c+1]=i,t.views.styleZoomLimits[c]=s,t.views.styleZoomLimits[c+1]=a,l.offset++}function Ad(t,e,n,i,o,r){const s=t.elements.stride*t.elements.offset,a=s/t.views.position.BYTES_PER_ELEMENT,l=s/t.views.direction.BYTES_PER_ELEMENT;t.views.position[a]=Y+e[0],t.views.position[a+1]=Y+e[1],t.views.direction[l]=n,t.views.direction[l+1]=i,t.views.widenDirection[l]=o,t.views.widenDirection[l+1]=r,t.elements.offset++}function fh(t,e,n,i,o,r,s,a){const l=t.buffer,c=t.offset;l[c]=e+n,l[c+1]=e+i,l[c+2]=e+o,l[c+3]=e+r,l[c+4]=e+s,l[c+5]=e+a,t.offset=c+6}const t_=[0,0,0],Rl=[0,0],Jm={symbol:"labelLine",sinks:{raster:{stride:28,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.texCoords=new Uint16Array(e,8),t.views.cornerOffset=new Float32Array(e,12),t.views.styleZoomLimits=new Float32Array(e,20)},packObjectAttributes:(t,e,n,i,o,r)=>pc([t.styleId,t.layer.innerId,e,n,i,o],r),unpackObjectAttributes(t){return{styleId:t[0],layerId:t[1],animDirection:t[2],range:t[3],fontIndex:t[4],tiers:t[5],tileData:t.slice(6)}}}},processElement(t,e,n,i,o,r,s){const{label:a,anchorPosition:l,anchorSegmentIndex:c,halfLabelWidth:d,layer:u}=n;if(u.type!=="labelLine")return;const{axis:f}=a,{center:h,styleZoom:_}=r,p=qr(_,r.styleState,!1,a.tileData),m=Hn(u.style.textFont,p),g=t.fontNameToIndex[m]??t.fontNameToIndex[Ss],y={},b=te(u.ignoreTier,p)?null:a.tiers;for(const E of a.ranges)y[E]=e.getBucket("labelLine","raster",Jm.sinks.raster.packObjectAttributes(a,i,E,g,b??null,D0(a.tileData,u)),Jm.sinks.raster.binder);const v=a.textMetrics.lines[0],T=K(u.style.textFontSize,p)/Gi.baseSize,x=v.glyphs,I=hI(f,l,d,r.rotation);Rl[0]=-v.width/2,Rl[1]=0;for(let E=0;E<x.length;E++){const L=x[E],N=(Rl[0]+L.left+L.width/2)*T*(I?-1:1),k=oh(N)||1;let w=-1/0,S=1/0;for(let A=c;A>=1&&A<f.vertexCount&&!(S<n.overflowStyleZoom);A+=k,S=w){const z=k===1?A:A-1;w=Ws(_S(N,f.lengths[z]-l),h);const M=f.interpolate(l,A);mi(t_,M,s),T0(t_)&&L.bitmap!==void 0&&dI(y[L.range],t_,Rl,L,M[3]+(I?Math.PI:0),Math.max(w,n.overflowStyleZoom),S)}Rl[0]+=L.advance+Gi.baseSize*u.style.textLetterSpacing}},getLabelingInfo(){}};function hI(t,e,n,i){const o=t.interpolate(e-n,t.getSegmentIndex(e-n)),r=t.interpolate(e+n,t.getSegmentIndex(e+n)),s=Math.atan2(r[1]-o[1],r[0]-o[0])-i;return Math.cos(s)<0}const n_=[0,0,0],Qm={symbol:"oneWayLine",sinks:{raster:{stride:12,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.direction=new Int8Array(e,8),t.views.widenDirection=new Int8Array(e,10)},packObjectAttributes:(t,e,n)=>pc([t.styleId,t.layer.innerId,e,n],t.tileData),unpackObjectAttributes:t=>({styleId:t[0],layerId:t[1],animDirection:t[2],tiers:t[3],tileData:t.slice(4)})}},processElement(t,e,n,i,o,r,s){const{label:a,anchorWorld:l}=n;if(mi(n_,l,s),!T0(n_))return;const c=e.getBucket("oneWayLine","raster",Qm.sinks.raster.packObjectAttributes(a,i,a.tiers??null),Qm.sinks.raster.binder);uI(c,n_,l[3])},getLabelingInfo(){}},Br={symbol:"heatmap",sinks:{fill:{stride:8,binder:(t,e)=>{t.views.position=new Float32Array(e)},packObjectAttributes:(t,e,n,i)=>[t,e.innerId,n,i],unpackObjectAttributes:t=>({styleId:t[0],layerId:t[1],textureIndex:t[2],rampTextureIndex:t[3],tileData:t.slice(4)})},framebuffer:{stride:12,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.weight=new Float32Array(e,4),t.views.widen=new Int8Array(e,8)},packObjectAttributes:(t,e)=>[t,e],unpackObjectAttributes:t=>({styleId:t[0],layerId:t[1],tileData:t.slice(2)})}},generate(t,e,n,i,o){const r=i.x,s=i.y,a=Number(te(n.style.weight,o));if(Number.isNaN(a)){console.error("Can't resolve style.weight to number");return}const l=t.getBucket(n.type,"framebuffer",Br.sinks.framebuffer.packObjectAttributes(e,n.innerId),Br.sinks.framebuffer.binder);for(let c=0;c<r.length;c++)mI(l,0,1,2,2,1,3),Pd(l,r[c],s[c],-1,-1,a),Pd(l,r[c],s[c],1,-1,a),Pd(l,r[c],s[c],-1,1,a),Pd(l,r[c],s[c],1,1,a)},generateTexture(t,e,n,i,o){const r=[-1,1,1,-1],s=[-1,-1,1,1],a=t.getBucket(n.type,"fill",Br.sinks.fill.packObjectAttributes(e,n,i,o),Br.sinks.fill.binder);let l=a.elements.offset;_I(a.indices,l,0,1,2,0,2,3),Cd(a,l++,r[0],s[0]),Cd(a,l++,r[1],s[1]),Cd(a,l++,r[2],s[2]),Cd(a,l++,r[3],s[3]),a.elements.offset=l}};function Cd(t,e,n,i){const o=e*2;t.views.position[o]=n,t.views.position[o+1]=i}function _I(t,e,n,i,o,r,s,a){const l=t.buffer,c=t.offset;l[c]=e+n,l[c+1]=e+i,l[c+2]=e+o,l[c+3]=e+r,l[c+4]=e+s,l[c+5]=e+a,t.offset=c+6}function Pd(t,e,n,i,o,r){const s=t.elements.offset*t.elements.stride,a=s>>1,l=a>>1;t.views.position[a]=Y+e,t.views.position[a+1]=Y+n,t.views.weight[l]=r,t.views.widen[s]=i,t.views.widen[s+1]=o,t.elements.offset++}function mI(t,e,n,i,o,r,s){const{elements:a,indices:l}=t,{buffer:c,offset:d}=l,u=a.offset;c[d]=u+e,c[d+1]=u+n,c[d+2]=u+i,c[d+3]=u+o,c[d+4]=u+r,c[d+5]=u+s,l.offset=d+6}let pI=0;function Fc(){return pI++}const no=Fc(),Gs=Fc(),jv={stride:4,binder:(t,e)=>{},packObjectAttributes(t,e){return[t,e]},unpackObjectAttributes(t){return{styleId:t[0],layerId:t[1],tileData:t.slice(3)}}},i_={stride:20,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.normal=new Float32Array(e,4),t.views.height=new Float32Array(e,16)},packObjectAttributes(t,e){return[t,e]},unpackObjectAttributes(t){return{styleId:t[0],layerId:t[1],tileData:t.slice(2)}}},xn={symbol:"dem",sinks:{mesh:jv,ground:jv,mesh2:i_,ground2:i_,elevation:i_,hillshade:{stride:8,binder:(t,e)=>{},packObjectAttributes(t,e){return[t,e]},unpackObjectAttributes(t){return{styleId:t[0],layerId:t[1],tileData:t.slice(2)}}},flatBottom:{stride:12,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.demPosition=new Int16Array(e,4),t.views.extender=new Int8Array(e,8)},packObjectAttributes(t,e,n){return n?[t,e,n]:[t,e]},unpackObjectAttributes(t){return{styleId:t[0],layerId:t[1],matrix:t[2]?t[2]:void 0,tileData:t.slice(3)}}}},generateMeshElevation(t,e,n,i){const o=t.getBucket("dem","elevation",xn.sinks.elevation.packObjectAttributes(n,i),xn.sinks.elevation.binder),r=t.getBucket("dem","mesh2",xn.sinks.mesh2.packObjectAttributes(n,i),xn.sinks.mesh2.binder),s=t.getBucket("dem","ground2",xn.sinks.ground2.packObjectAttributes(n,i),xn.sinks.ground2.binder);r_(o,e),r_(r,e),r_(s,e)},generateHillshade(t,e,n,i){const o=new Uint16Array(e.reduce((s,a)=>{const[l,c,d,u]=a;return s.push(l*Se,c*Se,qn(d),qn(u)),s},[]));return{symbol:xn.symbol,sink:"hillshade",buffer:o.buffer,generatedObjects:[{drawMode:Vc,attributes:xn.sinks.hillshade.packObjectAttributes(n,i),rangeStart:0,rangeEnd:o.buffer.byteLength,extents:new Uint16Array(6)}]}},generateFloorsBottomFill(t,e,n,i,o,r){const s=n[0],a=n[1],l=n[0].length,c=xn.sinks.flatBottom.packObjectAttributes(e,no,r),d=t.getBucket("dem","flatBottom",c,xn.sinks.flatBottom.binder);gI(d,l,s,a,i,o,!!r)}};function gI(t,e,n,i,o,r,s){let a=t.elements.offset;const l=a;if(!(e<3)){o_(t,a++,n[0],i[0],r,o[0],s),o_(t,a++,n[1],i[1],r,o[1],s);for(let c=2;c<e;c++)vI(t,l,c),o_(t,a++,n[c],i[c],r,o[c],s);t.elements.offset=a}}function o_(t,e,n,i,o,r,s){const a=e*(t.elements.stride/t.views.position.BYTES_PER_ELEMENT),l=e*(t.elements.stride/t.views.extender.BYTES_PER_ELEMENT);t.views.position[a]=s?n:Y+n,t.views.position[a+1]=s?i:Y+i,t.views.demPosition[a]=(s?o[0]:Y+o[0])/8,t.views.demPosition[a+1]=(s?o[1]:Y+o[1])/8,t.views.extender[l]=r[0]*127,t.views.extender[l+1]=r[1]*127}function vI(t,e,n){const i=t.indices.buffer;let o=t.indices.offset;n%2===0?(i[o++]=e+n-2,i[o++]=e+n-1,i[o++]=e+n):(i[o++]=e+n-1,i[o++]=e+n-2,i[o++]=e+n),t.indices.offset=o}function r_(t,e){for(let n=0;n<e.indices.length;n++){const i=e.indices[n],o=t.elements.offset*(t.elements.stride/t.views.position.BYTES_PER_ELEMENT);t.views.position[o]=Y+e.vertices[i*3],t.views.position[o+1]=Y+e.vertices[i*3+1];const r=t.elements.offset*(t.elements.stride/t.views.normal.BYTES_PER_ELEMENT);t.views.normal[r]=e.normals[i*3],t.views.normal[r+1]=e.normals[i*3+1],t.views.normal[r+2]=e.normals[i*3+2];const s=t.elements.offset*(t.elements.stride/t.views.height.BYTES_PER_ELEMENT);t.views.height[s]=e.vertices[i*3+2],t.elements.offset++,t.indices.buffer[t.indices.offset]=n,t.indices.offset++}}const yI=new Set(oS),bI=new Set(r3),wI=new Set(s3),xI=new Set(sS),SI=new Set(aS),MI=new Set(rS);function hh(t){return yI.has(t)}function g5(t){return bI.has(t)}function v5(t){return wI.has(t)}function TI(t){return xI.has(t)}function y5(t){return SI.has(t)}function b5(t){return MI.has(t)}const II=(t,e,n,i,o,r,s,a,l,c,d)=>{const{tileProps:u,tileAttrs:f}=i;if(EI(t,e,n,i,c,d),d)return;let h=di.Common;const _=f[u.db_sublayer];g5(_)?h=di.CommercialCity:v5(_)?h=di.CommercialPremium:hh(_)?h=di.Commercial:y5(_)&&(h=di.Landmark);const p=l.x.length===1?qu.Point:qu.Line;let m=[],g;if(p===qu.Point){if(i&&n.style.allowElevation){const k=K(n.style.elevation,i);if(Number.isNaN(k))typeof l.z<"u"&&(l.z=[r<4?B3(l.z[0]):l.z[0]]);else{const w=k*He*_o(Ct(s),[l.x[0],l.y[0]]);l.z=[w]}}m=[[l.x[0]],[l.y[0]],typeof l.z<"u"?[l.z[0]]:[0]],g=[0,0,0],Sr(g,[m[0][0],m[1][0],m[2][0]],Ct(s))}else m=[l.x,l.y];const y=i.id??"",b=h===di.Commercial||h===di.CommercialCity||h===di.CommercialPremium,v=u.db_plan_id&&!b?f[u.db_plan_id]:"";let T=to,x=to;Number.isNaN(y)||(T=t.idIndexer.getIndex(i,e.id,n,{objectClass:f[u.db_object_class],instanceId:0,metatile:o,center:g,floorId:v,ignoreHover:!0}),x=t.idIndexer.getIndex(i,e.id,n,{objectClass:f[u.db_object_class],instanceId:1,metatile:o,center:g,floorId:v,ignoreHover:!0}));const I=f[u.db_point_building_id],E=t.pointIndexer.getIndex(I),L=t.pointIndexer.getIndex(y),N={type:Qa.Point,pointType:h,geometryType:p,styleId:e.id,layerId:n.innerId,sourceId:a,tileCoords:s,id:i.id??"",floorId:v,identifyIndex:T,identifyPoiLabelIndex:x,labelingTextureIndex:E,spritePointTextureIndex:L,labelPriority:Un(f[u.db_label_priority],0),label2Priority:Un(f[u.db_label2_priority],0),styleIconPriority:K(n.style.iconPriority,i),styleTextPriority:K(n.style.textPriority,i),iconPriority:Un(f[u.db_icon_priority],0),hovered:Un(f[u.hovered],0),componentDistanceStart:Un(f[u.componentDistanceStart],0),componentDistanceEnd:Un(f[u.componentDistanceEnd],0),objectLength:Un(f[u.objectLength],0),vertices:m,demElevation:NaN,tileData:[...i.tileData]};t.addLabel(N)};function EI(t,e,n,i,o,r){const{tileProps:s,tileAttrs:a}=i,{rasterSets:l,icons:c}=e,d=R0(o),u=yr(n.style.iconWidth),f=hh(a[s.db_sublayer]),h=y5(a[s.db_sublayer]),_=Dn(n.style.iconAnchor);if(f||h){if(r)return;const p=f?hc.rasterSizes:lS,m=v8(i.id??"",p,a[s.db_region],_,f?"commercial":"landmark",s.url_src?a[s.url_src]:void 0);t.atlasPacker.addNewRasterSet(e.id,m),t.atlasPacker.pack(m,u,d)}else yr(n.style.iconImage).forEach(p=>{if(!p.length)return;const m=l.byKey[hl(p,_[0],_[1])];if(!m){console.error(`Not found raster set with image ${p}, anchorX: ${_[0]}, anchorY: ${_[1]}`);return}if(!m.isSvg)return;const g=c[p],y=g&&Km(g)?[{w:g.width,h:g.height}]:u.map(b=>({w:b,h:b}));t.atlasPacker.packSvg(m,y,d),r&&m.rasters.forEach(b=>t.atlasPacker.addRastersToLoad(e.id,b))})}const AI=(t,e,n,i,o,r,s)=>{const a={type:Qa.Line,styleId:e,layerId:n.innerId,sourceId:o,tileCoords:i,id:r.id??"",floorId:r.tileAttrs[r.tileProps.db_plan_id]??"",componentDistanceStart:Un(r.tileAttrs[r.tileProps.componentDistanceStart],0),componentDistanceEnd:Un(r.tileAttrs[r.tileProps.componentDistanceEnd],0),objectLength:Un(r.tileAttrs[r.tileProps.objectLength],0),labelPriority:Un(r.tileAttrs[r.tileProps.db_label_priority],0),styleIconPriority:K(n.style.textPriority,r),styleTextPriority:K(n.style.textPriority,r),vertices:[s.x,s.y],tileData:[...r.tileData],tiers:te(n.ignoreTier,r)?void 0:r.tileAttrs[r.tileProps.db_tiers]};t.addLabel(a)},CI=(t,e,n,i,o,r,s)=>{const{tileProps:a,tileAttrs:l}=r,c=te(n.ignoreTier,r)?null:l[a.db_tiers],d={type:Qa.OneWayLine,styleId:e,layerId:n.innerId,sourceId:o,tileCoords:i,id:r.id??"",floorId:r.tileAttrs[r.tileProps.db_plan_id]??"",componentDistanceStart:Un(r.tileAttrs[r.tileProps.componentDistanceStart],0),componentDistanceEnd:Un(r.tileAttrs[r.tileProps.componentDistanceEnd],0),objectLength:Un(r.tileAttrs[r.tileProps.objectLength],0),labelPriority:Un(r.tileAttrs[r.tileProps.db_label_priority],0),styleIconPriority:K(n.style.priority,r),styleTextPriority:0,vertices:[s.x,s.y],tileData:[...r.tileData],tiers:c};t.addLabel(d)};var se=(t=>(t[t.side=0]="side",t[t.top=1]="top",t[t.bottom=2]="bottom",t))(se||{});const zl=[0,0,0],Bl=[0,0,0],Ol=[0,0,0],Ld=[0,0,0],$v=(t,e,n,i,o)=>Dt([t,e.innerId,n,i],e,o),Wv=(t,e,n,i)=>Dt([t,e.innerId,n],e,i),Zv=t=>({styleId:t[0],layerId:t[1],side:t[2],absZ:t[3],tileData:t.slice(4)}),Xv=t=>({styleId:t[0],layerId:t[1],absZ:t[2],tileData:t.slice(3)}),oe={symbol:"mesh",sinks:{fill:{stride:28,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.z=new Float32Array(e,4),t.views.normal=new Int8Array(e,8),t.views.gradient=new Int8Array(e,11),t.views.localID=new Uint32Array(e,12),t.views.demPosition=new Int16Array(e,16),t.views.absZ=new Float32Array(e,16),t.views.isPivot=new Uint8Array(e,20),t.views.labelingTextureID=new Uint32Array(e,24)},packObjectAttributes:$v,unpackObjectAttributes:Zv},inverse:{stride:16,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.z=new Float32Array(e,4),t.views.demPosition=new Int16Array(e,8),t.views.absZ=new Float32Array(e,8),t.views.isPivot=new Uint8Array(e,12)},packObjectAttributes:Wv,unpackObjectAttributes:Xv},depthClear:{stride:16,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.z=new Float32Array(e,4),t.views.demPosition=new Int16Array(e,8),t.views.absZ=new Float32Array(e,8),t.views.isPivot=new Uint8Array(e,12)},packObjectAttributes:Wv,unpackObjectAttributes:Xv},stroke:{stride:20,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.z=new Float32Array(e,4),t.views.directionDistance=new Int8Array(e,8),t.views.demPosition=new Int16Array(e,12),t.views.absZ=new Float32Array(e,12),t.views.isPivot=new Uint8Array(e,16)},packObjectAttributes:$v,unpackObjectAttributes:Zv}},generate(t,e,n,i,o,r,s,a,l,c,d="fill",u=!1){const f=r.x,h=r.y,_=r.signed_z;let p=0;if(n.type==="polygon3d"||n.type==="embankment"){const L=te(n.style.elevation,o),N=o.tileInfo?_o(o.tileInfo,[0,0]):1;p=L*He*N}const m=r.gradient,g=r.abs_z,y=r.is_pivot,b=f.length,v=o.tileAttrs[o.tileProps.hovered],T=o.id??"",x=t.pointIndexer.getIndex(T);let I=hr;switch(n.type){case"polygon3d":{n.interactive?(I=v?to:t.idIndexer.getIndex(o,e,n),!v&&I===to&&(I=hr)):I=n.interactiveOcclusion?hr:to;break}case"overpass":case"tunnel":{I=t.idIndexer.getIndex(o,e,n),I===to&&(I=hr);break}case"embankment":{I=hr;break}default:{const{type:L}=n}}(n.type==="embankment"||n.type==="polygon3d")&&l&&c5(t,e,l,n.style,a);let E;if(d==="inverse")E=t.getBucket("mesh","inverse",oe.sinks.inverse.packObjectAttributes(e,n,!!g,o),oe.sinks.inverse.binder);else if(d==="fill")E=t.getBucket("mesh","fill",oe.sinks.fill.packObjectAttributes(e,n,i,!!g,o),oe.sinks.fill.binder);else if(d==="depthClear")E=t.getBucket("mesh","depthClear",oe.sinks.depthClear.packObjectAttributes(e,n,!!g,o),oe.sinks.depthClear.binder);else return;for(let L=0;L<b-2;L++){const N=!(L%2);PI(E);const k=u?2:1,w=u?1:2,S=N?L+k:L+w,A=N?L+w:L+k,z=Se/s.size;St(zl,f[L],h[L],((_==null?void 0:_[L])??0)*z),St(Bl,f[S],h[S],((_==null?void 0:_[S])??0)*z),St(Ol,f[A],h[A],((_==null?void 0:_[A])??0)*z),m3(Ld,zl,Bl,Ol),zl[2]/=z,Bl[2]/=z,Ol[2]/=z,zl[2]+=p,Bl[2]+=p,Ol[2]+=p;const M=E.elements.offset;s_(E,zl,Ld,m==null?void 0:m[L],I,x,c,g==null?void 0:g[L],y==null?void 0:y[L]),s_(E,Bl,Ld,m==null?void 0:m[S],I,x,c,g==null?void 0:g[S],y==null?void 0:y[S]),s_(E,Ol,Ld,m==null?void 0:m[A],I,x,c,g==null?void 0:g[A],y==null?void 0:y[A]),E.objectsData[M]={objectId:T,size:E.elements.offset-M}}}};function s_(t,e,n,i,o,r,s,a,l){const c=t.elements.stride*t.elements.offset,d=c/t.views.position.BYTES_PER_ELEMENT;t.views.position[d]=Y+e[0],t.views.position[d+1]=Y+e[1],t.views.z[c/t.views.z.BYTES_PER_ELEMENT]=e[2];const u=c/t.views.demPosition.BYTES_PER_ELEMENT;if(t.views.demPosition[u]=(((s==null?void 0:s[0])??e[0])+Y)/8,t.views.demPosition[u+1]=(((s==null?void 0:s[1])??e[1])+Y)/8,a!==void 0&&(t.views.absZ[c/t.views.absZ.BYTES_PER_ELEMENT]=a),t.views.isPivot[c/t.views.isPivot.BYTES_PER_ELEMENT]=l??0,"normal"in t.views){const f=c/t.views.normal.BYTES_PER_ELEMENT,h=c/t.views.localID.BYTES_PER_ELEMENT,_=c/t.views.gradient.BYTES_PER_ELEMENT;t.views.normal[f]=on(n[0]),t.views.normal[f+1]=on(n[1]),t.views.normal[f+2]=on(n[2]),t.views.gradient[_]=on(i??0),t.views.localID[h]=o,t.views.labelingTextureID[h]=r}t.elements.offset++}function PI(t){const e=t.indices.buffer,n=t.indices.offset,i=t.elements.offset;e[n]=i,e[n+1]=i+1,e[n+2]=i+2,t.indices.offset+=3}const Yv=[0,0,0],qv=[0,0,0],Kv=[0,0,0],Fd=[0,0,0],LI=(t,e,n,i,o)=>Dt([t,e.innerId,n,i],e,o),FI=t=>({styleId:t[0],layerId:t[1],meshTier:t[2],absZ:t[3],tileData:t.slice(4)}),el={symbol:"mapMesh",sinks:{fill:{stride:24,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.z=new Float32Array(e,4),t.views.extender=new Int16Array(e,8),t.views.normal=new Int8Array(e,12),t.views.gradient=new Int8Array(e,15),t.views.demPosition=new Int16Array(e,16),t.views.absZ=new Float32Array(e,16),t.views.isPivot=new Uint8Array(e,20)},packObjectAttributes:LI,unpackObjectAttributes:FI}},generate(t,e,n,i,o,r,s,a){const l=o.x,c=o.y,d=o.signed_z??[],u=o.gradient,f=o.is_pivot,h=o.abs_z,_=l.length,p=a==null?void 0:a[0],m=a==null?void 0:a[1];if(_<3)return;const g=Se/s.size,y=t.getBucket("mapMesh","fill",el.sinks.fill.packObjectAttributes(e,n,r,!!h,i),el.sinks.fill.binder),b=y.indices.buffer;let v=y.indices.offset;const T=y.elements.offset;for(let x=2;x<_;x++){const I=!(x%2),E=I?x-2:x-1,L=I?x-1:x-2;kI(b,v,T,(x-2)*3+2),St(Kv,l[E],c[E],d[E]*g),St(qv,l[L],c[L],d[L]*g),St(Yv,l[x],c[x],d[x]*g),m3(Fd,Kv,qv,Yv),a_(y,l[E],c[E],d[E],u==null?void 0:u[E],f==null?void 0:f[E],h==null?void 0:h[E],Fd,p,m),a_(y,l[L],c[L],d[L],u==null?void 0:u[L],f==null?void 0:f[L],h==null?void 0:h[L],Fd,p,m),a_(y,l[x],c[x],d[x],u==null?void 0:u[x],f==null?void 0:f[x],h==null?void 0:h[x],Fd,p,m),v+=3}y.indices.offset=v}};function kI(t,e,n,i){t[e]=n+i-2,t[e+1]=n+i-1,t[e+2]=n+i}function a_(t,e,n,i,o,r,s,a,l=e,c=n){const d=t.elements.offset*t.elements.stride,u=d/t.views.position.BYTES_PER_ELEMENT,f=d/t.views.normal.BYTES_PER_ELEMENT,h=d/t.views.demPosition.BYTES_PER_ELEMENT;t.views.position[u]=Y+e,t.views.position[u+1]=Y+n,t.views.z[d/t.views.z.BYTES_PER_ELEMENT]=i,t.views.normal[f]=on(a[0]),t.views.normal[f+1]=on(a[1]),t.views.normal[f+2]=on(a[2]),t.views.gradient[d/t.views.gradient.BYTES_PER_ELEMENT]=o??0,t.views.isPivot[d/t.views.isPivot.BYTES_PER_ELEMENT]=r??0,t.views.demPosition[h]=(Y+l)/8,t.views.demPosition[h+1]=(Y+c)/8,s!==void 0&&(t.views.absZ[d/t.views.absZ.BYTES_PER_ELEMENT]=s),t.elements.offset++}const RI=1,l_=-1,zI=1.3,Jv=-200,Qv=-300,BI=Math.tan(Be(175/2)),Fi=[0,0,0],Or=[0,0,0],OI=[0,0,0],yc=[0,0,0],c_=[0,0,0],zt=[0,0,0];let Ku=0,Dl=0;const w5={symbol:"overpass",sinks:{},generate(t,e,n,i,o,r,s,a){var D;let l=o.signed_z;if(!l)return;const c=o.abs_z!==void 0&&Array.from(o.abs_z).some(B=>B)?o.abs_z:void 0,d=i.styleState.terrainEnabled===!0,u=i.tileAttrs[i.tileProps.db_road_part],f=i.tileAttrs[i.tileProps.db_geometry_type],h=(D=i.tileAttrs[i.tileProps.db_tiers])==null?void 0:D[0],_=!!i.tileAttrs[i.tileProps.db_is_mountain]&&!!c&&d,p=u==="tunnel_arch"&&_,m=u==="border_tunnel"&&_;if(u==="roadbed_flat"||u==="border_tunnel_descent"&&_)return;const y=i.tileProps,b=i.tileAttrs.slice();i.id=void 0,b[y.db_tiers]=void 0;const v=e.id,T=o.x.length,x=o.x,I=o.y,E=o.cut??[],L=new Uint8Array(T);p||l.forEach((B,U)=>{L[U]=B?0:1}),!!i.tileAttrs[i.tileProps.db_ignore_z]&&!!c&&d&&(l=new Int32Array(l.length));const k=d?zI:1;d&&!_&&(u==="roadbed_tunnel"||u==="roadbed_tunnel_descent"||u==="border_tunnel"||u==="border_tunnel_descent")&&(l=new Int32Array(l).map(B=>B*k)),Yt(yc,0,0);const S=_o(r,yc)*He,A=Se/r.size*S,z=Math.max(K(n.style.borderWidth,i,0),0)*A,M=Math.max(K(n.style.thickness,i,0),0)*S,P=z>0?Math.max(-M,K(n.style.borderHeight,i,0)*S):0,C=Math.max(K(n.style.tunnelHeight,i,0),0)*S;if(f==="polygon"){if(h===void 0)return;const B=[x,I,E,l,new Int8Array(T),L];c&&B.push(c);const U=u==="roadbed_tunnel_descent",G=u==="roadbed_tunnel"||U;el.generate(t,v,n,i,me(B),h,r,void 0);const V=B.map(Z=>Array.from(Z));for(let Z=0;Z<V[3].length;Z++)V[3][Z]-=M,V[4][Z]=0;oe.generate(t,v,n,se.bottom,i,me(V),r,s,a,void 0,G?"inverse":"fill",!0);const ne=[];for(let Z=0;Z<h;Z++)ne.push(Z);const X=t.getBucket("polygon","shadow",Oo.sinks.shadow.packObjectAttributes(v,n,ne,"",i),Oo.sinks.shadow.binder);if(h5(X,B[0].length,B[0],B[1],to),G&&!U){const Z=B.slice();Z[3]=_?new Array(B[0].length).fill(C):Array.from(B[3]).map(Q=>Q+Math.abs(Q/k)-1),oe.generate(t,v,n,se.top,i,me(Z),r,s,a,void 0,_?"fill":"inverse"),_&&oe.generate(t,v,n,se.bottom,i,me(Z),r,s,a,void 0,"fill",!0)}if(U&&d&&!_){const Z=B.slice();Z[3]=new Array(B[0].length).fill(Math.max(0,P)),oe.generate(t,v,n,se.top,i,me(Z),r,s,a,void 0,"depthClear")}}else if(f==="polyline"){const B=oe.sinks.stroke.packObjectAttributes(v,n,se.top,!!c,i),U=oe.sinks.stroke.packObjectAttributes(v,n,se.side,!!c,i),G=oe.sinks.stroke.packObjectAttributes(v,n,se.bottom,!!c,i),V=DI({x,y:I,cut:E,signed_z:l,is_pivot:L,abs_z:c});if(u==="tunnel_arch"&&!_){const ne=Math.max(P,0),X=oc(V),Z=e1(V,z),Q=V.map(re=>{const ee=re.slice();return ee[2]=d?Qv:Jv,ee[4]=0,ee});ze(t,G,Q);const le=Xn(Z,X,z).map(re=>(re[2]=ne,re[4]=1,re)),Ie=Z.map(re=>{const ee=re.slice();return ee[2]=ne,ee[4]=1,ee}),ce=Ce(le,Ie);do oe.generate(t,v,n,se.top,i,me(ce),r,s,a,void 0,ne?"fill":"inverse");while(t.isOverloaded());const Fe=V.map(re=>{const ee=re.slice();return ee[2]=ne,ee[4]=1,ee});ze(t,B,Fe);const Me=Ce(Fe,Q);do oe.generate(t,v,n,se.side,i,me(Me),r,s,a);while(t.isOverloaded());const ye=Ce(le.map(re=>{const ee=re.slice();return ee[2]=d?Qv:Jv,ee[4]=0,ee}),le.map(re=>{const ee=re.slice();return ee[2]=0,ee}));do oe.generate(t,v,n,se.side,i,me(ye),r,s,a,void 0,"inverse");while(t.isOverloaded());if(ne){const re=Xn(Z,X,z).map(Ut=>(Ut[2]=0,Ut[4]=0,Ut));ze(t,G,re),ze(t,B,le);const ee=Ce(re,le);do oe.generate(t,v,n,se.side,i,me(ee),r,s,a,void 0,"fill");while(t.isOverloaded());const de=Z.map(Ut=>{const Jt=Ut.slice();return Jt[2]=0,Jt[4]=0,Jt}),Ee=Ce([Ie[0],de[0]],[le[0],re[0]]);do oe.generate(t,v,n,se.side,i,me(Ee),r,s,a,void 0,"fill");while(t.isOverloaded());ze(t,B,[Ie[0],le[0]]),ze(t,U,[le[0],re[0]]),ze(t,G,[re[0],de[0]]);const Re=Ie.length-1,pn=Ce([de[Re],Ie[Re]],[re[Re],le[Re]]);do oe.generate(t,v,n,se.side,i,me(pn),r,s,a,void 0,"fill");while(t.isOverloaded());if(ze(t,B,[Ie[Re],le[Re]]),ze(t,U,[le[Re],re[Re]]),ze(t,G,[re[Re],de[Re]]),d){do oe.generate(t,v,n,se.top,i,me(ce),r,s,a,void 0,"depthClear");while(t.isOverloaded());do oe.generate(t,v,n,se.side,i,me(ee),r,s,a,void 0,"depthClear");while(t.isOverloaded());do oe.generate(t,v,n,se.side,i,me(Ee),r,s,a,void 0,"depthClear");while(t.isOverloaded());do oe.generate(t,v,n,se.side,i,me(pn),r,s,a,void 0,"depthClear");while(t.isOverloaded())}}}else if(p){if(!C)return;const ne=oc(V),X=e1(V,z),Z=Xn(V,ne,z),Q=Xn(X,ne,z),le=V.map(ce=>{const Fe=ce.slice();return Fe[2]=C,Fe}),Ie=Ce(le,V);do oe.generate(t,v,n,se.side,i,me(Ie),r,s,a,void 0,"depthClear");while(t.isOverloaded());if(z){const ce=[V[0],X[0]],Fe=ce.map(Bn=>{const tt=Bn.slice();return tt[2]=C,tt[4]=C/(C+P),tt}),Me=Ce(ce,Fe);do oe.generate(t,v,n,se.side,i,me(Me),r,s,a);while(t.isOverloaded());const ye=[Z[0],Q[0]],re=ye.map(Bn=>{const tt=Bn.slice();return tt[2]=C,tt[4]=C/(C+P),tt}),ee=Ce(re,ye);do oe.generate(t,v,n,se.side,i,me(ee),r,s,a);while(t.isOverloaded());const de=[Z[0],V[0]],Ee=de.map(Bn=>{const tt=Bn.slice();return tt[2]=C,tt[4]=C/(C+P),tt}),Re=Ce(de,Ee);do oe.generate(t,v,n,se.side,i,me(Re),r,s,a);while(t.isOverloaded());const pn=[X[0],Q[0]],Ut=pn.map(Bn=>{const tt=Bn.slice();return tt[2]=C,tt[4]=C/(C+P),tt}),Jt=Ce(pn,Ut);do oe.generate(t,v,n,se.side,i,me(Jt),r,s,a);while(t.isOverloaded());const Hi=V.length-1,id=[X[Hi],V[Hi]],Sh=id.map(Bn=>{const tt=Bn.slice();return tt[2]=C,tt[4]=C/(C+P),tt}),gn=Ce(id,Sh);do oe.generate(t,v,n,se.side,i,me(gn),r,s,a);while(t.isOverloaded());const je=[Q[Hi],Z[Hi]],I9=je.map(Bn=>{const tt=Bn.slice();return tt[2]=C,tt[4]=C/(C+P),tt}),E9=Ce(I9,je);do oe.generate(t,v,n,se.side,i,me(E9),r,s,a);while(t.isOverloaded());const Rg=[Q[Hi],X[Hi]],A9=Rg.map(Bn=>{const tt=Bn.slice();return tt[2]=C,tt[4]=C/(C+P),tt}),C9=Ce(Rg,A9);do oe.generate(t,v,n,se.side,i,me(C9),r,s,a);while(t.isOverloaded());const zg=[V[Hi],Z[Hi]],P9=zg.map(Bn=>{const tt=Bn.slice();return tt[2]=C,tt[4]=C/(C+P),tt}),L9=Ce(zg,P9);do oe.generate(t,v,n,se.side,i,me(L9),r,s,a);while(t.isOverloaded())}if(P){const ce=V.length-1,Fe=[X[ce],V[ce],V[0],X[0]].map(gn=>{const je=gn.slice();return je[2]=C,je[4]=C/(C+P),je}),Me=Fe.map(gn=>{const je=gn.slice();return je[2]=C+P,je[4]=1,je}),ye=Ce(Fe,Me);do oe.generate(t,v,n,se.side,i,me(ye),r,s,a);while(t.isOverloaded());const re=[Q[ce],Z[ce],Z[0],Q[0]].map(gn=>{const je=gn.slice();return je[2]=C,je[4]=C/(C+P),je}),ee=re.map(gn=>{const je=gn.slice();return je[2]=C+P,je[4]=1,je}),de=Ce(ee,re);do oe.generate(t,v,n,se.side,i,me(de),r,s,a);while(t.isOverloaded());const Ee=Ce(Me,ee);do oe.generate(t,v,n,se.top,i,me(Ee),r,s,a);while(t.isOverloaded());const Re=Ce(re,Fe);do oe.generate(t,v,n,se.bottom,i,me(Re),r,s,a);while(t.isOverloaded());const pn=[X[0],Q[0]].map(gn=>{const je=gn.slice();return je[2]=C,je[4]=C/(C+P),je}),Ut=pn.map(gn=>{const je=gn.slice();return je[2]=C+P,je[4]=1,je}),Jt=Ce(pn,Ut);do oe.generate(t,v,n,se.side,i,me(Jt),r,s,a);while(t.isOverloaded());const Hi=[Q[ce],X[ce]].map(gn=>{const je=gn.slice();return je[2]=C,je[4]=C/(C+P),je}),id=Hi.map(gn=>{const je=gn.slice();return je[2]=C+P,je[4]=1,je}),Sh=Ce(Hi,id);do oe.generate(t,v,n,se.side,i,me(Sh),r,s,a);while(t.isOverloaded())}}else if(u==="border_overpass"||u==="border_flat"){const ne=[b[y.previousPointX],b[y.previousPointY],l[0]??0,0],X=!!b[y.beginningIsCut]&&t1(V[1],V[0],ne);X&&V.splice(0,0,ne);const Z=V.length-1,Q=[b[y.nextPointX],b[y.nextPointY],l[l.length-1]??0,0],le=!!b[y.endingIsCut]&&t1(V[Z-1],V[Z],Q);le&&V.push(Q);const Ie=oc(V);X&&(Ie.shift(),V.shift()),le&&(Ie.pop(),V.pop());const ce=V.map(Ee=>{const Re=Ee.slice();return Re[2]=Math.max(Re[2]-M,0),Re[4]=0,Re});ze(t,U,V);const Fe=Xn(V,Ie,z).map(Ee=>{const Re=Ee.slice();return Re[2]=Math.max(Ee[2]-M,0),Re[4]=0,Re}),Me=Xn(V,Ie,z).map(Ee=>{const Re=Ee.slice();return Re[2]=Math.max(Ee[2]+P,0),Re[4]=1,Re}),ye=V.map(Ee=>{const Re=Ee.slice();return P>0&&(Re[2]=Math.max(Re[2]+P,0)),Re[4]=1,Re});if(P>0){ze(t,B,ye);const Ee=Ce(ye,V.map(Re=>{const pn=Re.slice();return pn[4]=0,pn}));do oe.generate(t,v,n,se.side,i,me(Ee),r,s,a);while(t.isOverloaded())}ze(t,G,Fe),ze(t,B,Me);const re=Ce(Me,ye);do oe.generate(t,v,n,se.top,i,me(re),r,s,a);while(t.isOverloaded());const ee=Ce(ce,Fe);do oe.generate(t,v,n,se.bottom,i,me(ee),r,s,a,void 0,"fill");while(t.isOverloaded());const de=Ce(Fe,Me);do oe.generate(t,v,n,se.side,i,me(de),r,s,a,void 0,"fill");while(t.isOverloaded());if(l[0]===0){const Ee=Ce([ye[0],ce[0]],[Me[0],Fe[0]]);do oe.generate(t,v,n,se.side,i,me(Ee),r,s,a,void 0,"fill");while(t.isOverloaded());ze(t,B,[Me[0],ye[0]]),ze(t,U,[ye[0],ce[0]]),ze(t,U,[Fe[0],Me[0]]),ze(t,G,[ce[0],Fe[0]])}if(l[l.length-1]===0){const Ee=ce.length-1,Re=Ce([ce[Ee],ye[Ee]],[Fe[Ee],Me[Ee]]);do oe.generate(t,v,n,se.side,i,me(Re),r,s,a,void 0,"fill");while(t.isOverloaded());ze(t,B,[ye[Ee],Me[Ee]]),ze(t,U,[ce[Ee],ye[Ee]]),ze(t,U,[Me[Ee],Fe[Ee]]),ze(t,G,[Fe[Ee],ce[Ee]])}}else if(m){const ne=V.map(Z=>{const Q=Z.slice();return Q[2]=C,Q[4]=C/(C+P),Q}),X=Ce(ne,V);do oe.generate(t,v,n,se.side,i,me(X),r,s,a);while(t.isOverloaded());do oe.generate(t,v,n,se.side,i,me(X),r,s,a,void 0,"fill",!0);while(t.isOverloaded())}else{const ne=oc(V),X=u==="border_tunnel_descent",Z=u==="border_tunnel"||X,Q=Z?Math.max(P,0):P,le=V.map(Me=>{const ye=Me.slice();return ye[2]-=M,X?ye[2]=0:Z&&(ye[2]=Math.max(ye[2],l_)),ye[4]=0,ye}),Ie=Xn(V,ne,z).map(Me=>(Me[2]-=M,X&&(Me[2]=0),Me[4]=0,Me)),ce=Xn(V,ne,z).map(Me=>(Me[2]+=Q,X?Me[2]=Q:Z&&(Me[2]=Math.max(Me[2],l_)),Me[4]=1,Me)),Fe=V.map(Me=>{const ye=Me.slice();if(ye[4]=1,X)ye[2]=Q;else if(Z){const re=Math.abs(ye[2]/k),ee=Q-ye[2],de=ye[2]+re-1;ye[4]=(de+Math.abs(ye[2]))/ee,ye[2]=de}else ye[2]+=Q;return ye});if(Z){X&&ze(t,B,Fe);const Me=Ce(Fe,V.map(ee=>{const de=ee.slice();return de[4]=0,de}));do oe.generate(t,v,n,se.side,i,me(Me),r,s,a);while(t.isOverloaded());const ye=Fe.map(ee=>{const de=ee.slice();return de[2]=Math.min(ee[2],l_),de}),re=Ce(ye,V);do oe.generate(t,v,n,se.side,i,me(re),r,s,a,void 0,"inverse",!0);while(t.isOverloaded())}if(P>0&&(!Z||X)){ze(t,G,Ie),ze(t,B,ce);const Me=Ce(ce,Fe);do oe.generate(t,v,n,se.top,i,me(Me),r,s,a);while(t.isOverloaded());if(X&&d)do oe.generate(t,v,n,se.top,i,me(Me),r,s,a,void 0,"depthClear");while(t.isOverloaded())}if(!Z||X){const Me=Ce(le,Ie);do oe.generate(t,v,n,se.bottom,i,me(Me),r,s,a,void 0,"fill");while(t.isOverloaded());const ye=Ce(Ie,ce);do oe.generate(t,v,n,se.side,i,me(ye),r,s,a,void 0,"fill");while(t.isOverloaded());if(X&&d)do oe.generate(t,v,n,se.side,i,me(ye),r,s,a,void 0,"depthClear");while(t.isOverloaded());if(l[0]===0){const re=Ce([Fe[0],le[0]],[ce[0],Ie[0]]);do oe.generate(t,v,n,se.side,i,me(re),r,s,a,void 0,"fill");while(t.isOverloaded());if(X&&d)do oe.generate(t,v,n,se.side,i,me(re),r,s,a,void 0,"depthClear");while(t.isOverloaded());ze(t,B,[ce[0],Fe[0]]),ze(t,U,[Fe[0],le[0]]),ze(t,U,[Ie[0],ce[0]]),ze(t,G,[le[0],Ie[0]])}if(l[l.length-1]===0){const re=le.length-1,ee=Ce([le[re],Fe[re]],[Ie[re],ce[re]]);do oe.generate(t,v,n,se.side,i,me(ee),r,s,a,void 0,"fill");while(t.isOverloaded());if(X&&d)do oe.generate(t,v,n,se.side,i,me(ee),r,s,a,void 0,"depthClear");while(t.isOverloaded());ze(t,B,[Fe[re],ce[re]]),ze(t,U,[le[re],Fe[re]]),ze(t,U,[ce[re],Ie[re]]),ze(t,G,[Ie[re],le[re]])}}}}}};function DI(t){var i,o,r;const e=[],n=t.x.length;for(let s=0;s<n;s++){const a=[t.x[s],t.y[s],((i=t.signed_z)==null?void 0:i[s])??0,((o=t.cut)==null?void 0:o[s])??0,0,((r=t.is_pivot)==null?void 0:r[s])??0];t.abs_z&&a.push(t.abs_z[s]),e.push(a)}return e}function oc(t){const e=[];Wo(Fi,t[0][0],t[0][1],t[1][0],t[1][1]),Ku=0;for(let n=1;n<t.length;n++)NI(e,t,n);return e}function NI(t,e,n){const i=n===e.length-1;if(Yt(OI,e[n-1][0],e[n-1][1]),Yt(yc,e[n][0],e[n][1]),km(zt,Fi),i)Dl=0;else{Yt(c_,e[n+1][0],e[n+1][1]),Wo(Or,yc[0],yc[1],c_[0],c_[1]);const s=Ve(Ls(Fi,Or),-1,1),a=Math.min(Math.sqrt((1-s)/(1+s)),BI),l=oh(Ls(zt,Or));Dl=a*l}let o=zt[0]+Fi[0]*Ku,r=zt[1]+Fi[1]*Ku;t.push([o,r]),i&&(o=zt[0]+Fi[0]*Dl,r=zt[1]+Fi[1]*Dl,t.push([o,r])),i||(h0(Fi,Or),Ku=Dl)}function Xn(t,e,n){const i=[];for(let o=0;o<t.length;o++){const r=t[o].slice();h0(zt,e[o]),Gn(zt,zt,n),Qi(r,r,zt),i.push(r)}return i}function ze(t,e,n){do{const i=t.getBucket("mesh","stroke",e,oe.sinks.stroke.binder),o=n.length;for(let r=0;r<o-1;r++){const s=r+1;Xc(i,n[r][0],n[r][1],n[r][2],n[s][0],n[s][1],n[s][2],void 0,!1,n[r][6],n[s][6],n[r][5],n[s][5])}}while(t.isOverloaded())}function Ce(t,e){return UI([t[0]].concat(t,e.slice().reverse()))}function UI(t){const e=t.length,n=[[],[],[],[],[],[]];t[0][6]!==void 0&&n.push([]);for(let i=0;i<e;i++){const o=jn(i,e),r=t[i];n[0][o]=r[0],n[1][o]=r[1],n[2][o]=r[3],n[3][o]=r[2],n[4][o]=r[4]??0,n[5][o]=r[5]??0,n[6]&&(n[6][o]=r[6]??0)}return n}function me(t){return{x:t[0],y:t[1],cut:t[2],signed_z:t[3],gradient:t[4],is_pivot:t[5],abs_z:t[6]}}function e1(t,e){return t=t.map(n=>n.slice()),$t(zt,t[0],t[1]),_n(zt,zt),ni(zt,zt,e),jt(t[0],t[0],zt),$t(zt,t[t.length-1],t[t.length-2]),_n(zt,zt),ni(zt,zt,e),jt(t[t.length-1],t[t.length-1],zt),t}const t1=function(){const t=Math.cos(Be(RI));return(e,n,i)=>(ti(Fi,n,e),Uo(Fi,Fi),ti(Or,n,i),Uo(Or,Or),Ls(Fi,Or)<=t)}();function GI(t,e,n,i){return Dt([t,e.innerId,n],e,i)}const HI=t=>({styleId:t[0],layerId:t[1],tiers:t[2],tileData:t.slice(3)}),xf={symbol:"metricPoint",sinks:{fill:{stride:8,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.texCoords=new Uint16Array(e,4)},packObjectAttributes:GI,unpackObjectAttributes:HI}},generate(t,e,n,i,o,r,s){jI(t,i,o,n,r);const a=K(o.style.width,r),l=K(o.style.height,r),c=K(o.style.rotation,r),[d,u]=tT([e.x,e.y],a,l,c,s),f=te(o.ignoreTier,r)?null:r.tileAttrs[r.tileProps.db_tiers],h=t.getBucket("metricPoint","fill",xf.sinks.fill.packObjectAttributes(i.id,o,f,r),xf.sinks.fill.binder);let _=h.elements.offset;VI(h.indices,_,0,1,2,0,2,3),kd(h,_++,d[0],u[0],0,0),kd(h,_++,d[1],u[1],1,0),kd(h,_++,d[2],u[2],1,1),kd(h,_++,d[3],u[3],0,1),h.elements.offset=_}};function kd(t,e,n,i,o,r){e=e*4,t.views.position[e]=Y+n,t.views.position[e+1]=Y+i,t.views.texCoords[e]=qn(o),t.views.texCoords[e+1]=qn(r)}function VI(t,e,n,i,o,r,s,a){const l=t.buffer,c=t.offset;l[c]=e+n,l[c+1]=e+i,l[c+2]=e+o,l[c+3]=e+r,l[c+4]=e+s,l[c+5]=e+a,t.offset=c+6}function jI(t,e,n,i,o){const{rasterSets:r}=e,s=R0(i);yr(n.style.iconImage).forEach(a=>{if(!a.length)return;const l=r.byKey[_l(a)];if(!l){console.error(`Not found raster set with texture ${a}`);return}if(!l.isSvg)return;const c=K(n.style.width,o),d=K(n.style.height,o),u=Ka(c,d),f=c*u,h=d*u;t.atlasPacker.packSvg(l,[{w:f,h}],s),l.rasters.forEach(_=>t.atlasPacker.addRastersToLoad(e.id,_))})}const As=1e5,U0=4;function $I(t){return x5(t.lo,t.hi)}function n1(t){return[t%As,Math.floor(t/As)%As,0,0]}function WI(t){let n=0;for(let i=0;i<U0;i++){const o=t[i]*4294967296+n;n=Math.floor(o/As),t[i]=o%As}}function ZI(t,e){let n=0;for(let i=0;i<U0;i++){const o=t[i]+e[i]+n;n=Math.floor(o/As),t[i]=o%As}}function XI(t){const e="00000";let n=!0,i=U0,o="";for(;--i>=0;){const r=String(t[i]);n?t[i]!==0&&(o+=r,n=!1):o+=e.slice(r.length)+r}return o.length||(o="0"),o}function x5(t,e){const n=n1(t),i=n1(e);return WI(i),ZI(i,n),XI(i)}const an=[0,0,0],Rd=[0,0,0],zd=new Float64Array(16),S5={symbol:"tunnel",sinks:{},generate(t,e,n,i,o,r,s,a){var X;const{tileProps:l,tileAttrs:c}=i,d=(X=c[l.db_tiers])==null?void 0:X[0];if($I(c[l.id])!=="70030076221371399"||!d)return;const f=e.id;Yt(an,0,0);const _=_o(r,an)*He,p=Se/r.size*_,m=1/(Se/r.size),g=c[l.objectLength],y=c[l.componentDistanceStart]??0,b=c[l.componentDistanceEnd]??0,v=y===0?0:-5,T=175,x=243,I=b===g?0:-5;if(Number.isNaN(g)||Number.isNaN(y)||g===0)return;const E=x-T,L=T+E*y/g,N=T+E*b/g,k=3.5*p,w=5*p,S=[];let A=0;for(let Z=0;Z<o.x.length;Z++){const Q=[o.x[Z],o.y[Z],0];Z>0&&(A+=Ur(Q,S[Z-1]),Q[2]=A),S.push(Q)}const z=YI(S),M=oc(S);S.forEach(Z=>{const Q=Z[2]/z;Z[2]=(v+Q*(I-v))*_,Z[5]=(L+Q*(N-L))*_});const P=oe.sinks.stroke.packObjectAttributes(f,n,se.side,!0,i),C=Xn(S,M,k),D=Xn(S,M,-k),B=Ce(C,D),U=Xn(S,M,w),G=U.map(Z=>{const Q=Z.slice();return Q[2]=Math.max(0,Q[2]),Q});oe.generate(t,f,n,se.side,i,me(Ce(U,G)),r,s,a,void 0,"inverse");const V=Xn(S,M,-w),ne=V.map(Z=>{const Q=Z.slice();return Q[2]=Math.max(0,Q[2]),Q});oe.generate(t,f,n,se.side,i,me(Ce(ne,V)),r,s,a,void 0,"inverse"),S[0][2]!==0&&S[S.length-1][2]!==0&&oe.generate(t,f,n,se.side,i,me(Ce(G,ne)),r,s,a,void 0,"inverse");do el.generate(t,f,n,i,me(B),d,r,void 0);while(t.isOverloaded());for(let Z=1;Z<S.length;Z++){const Q=[],le=[],Ie=S[Z-1],ce=S[Z],Fe=M[Z-1],Me=M[Z];for(let re=0;re<=181;re+=15){const ee=Be(re),de=Ie.slice();St(an,Fe[0],Fe[1],0),ni(an,an,k),Zr(Rd,an),Gg(zd,-ee,Rd),ii(an,an,zd),an[2]*=m,jt(de,de,an),Q.push(de);const Ee=ce.slice();St(an,Me[0],Me[1],0),ni(an,an,k),Zr(Rd,an),Gg(zd,-ee,Rd),ii(an,an,zd),an[2]*=m,jt(Ee,Ee,an),le.push(Ee)}const ye=Ce(Q,le);if(oe.generate(t,f,n,se.side,i,me(ye),r,s,a,void 0,"fill"),Z===1&&S[0][2]===0){ze(t,P,Q);const re=S[0].slice(),ee=S[0].slice(),de=M[0].slice(),Ee=M[0].slice();Gn(de,de,w),Gn(Ee,Ee,-w),Qi(re,re,de),Qi(ee,ee,Ee);const Re=re.slice(),pn=ee.slice();Re[2]+=w*m,pn[2]+=w*m;const Ut=[re];for(let Jt=0;Jt<5;Jt++)Ut.push(Re);for(let Jt=0;Jt<5;Jt++)Ut.push(pn);Ut.push(ee),ze(t,P,Ut),oe.generate(t,f,n,se.side,i,me(Ce(Ut,Q)),r,s,a,void 0,"fill")}else if(Z===S.length-1&&S[S.length-1][2]===0){ze(t,P,le);const re=S[S.length-1].slice(),ee=S[S.length-1].slice(),de=M[S.length-1].slice(),Ee=M[S.length-1].slice();Gn(de,de,w),Gn(Ee,Ee,-w),Qi(re,re,de),Qi(ee,ee,Ee);const Re=re.slice(),pn=ee.slice();Re[2]+=w*m,pn[2]+=w*m;const Ut=[re];for(let Jt=0;Jt<5;Jt++)Ut.push(Re);for(let Jt=0;Jt<5;Jt++)Ut.push(pn);Ut.push(ee),ze(t,P,Ut),oe.generate(t,f,n,se.side,i,me(Ce(le,Ut)),r,s,a,void 0,"fill")}}if(S[0][2]===0||S[S.length-1][2]===0){const Z=Xn(S,M,w),Q=Xn(S,M,-w),le=Z.map(ye=>{const re=ye.slice();return re[2]=Math.max(0,re[2]+w*m),re}),Ie=Q.map(ye=>{const re=ye.slice();return re[2]=Math.max(0,re[2]+w*m),re});Z.forEach(ye=>{ye[2]=Math.max(0,ye[2])}),Q.forEach(ye=>{ye[2]=Math.max(0,ye[2])});const ce=Ce(Z,le),Fe=Ce(Ie,Q);ze(t,P,Z),ze(t,P,Q),ze(t,P,le),ze(t,P,Ie),oe.generate(t,f,n,se.side,i,me(ce),r,s,a,void 0,"fill"),oe.generate(t,f,n,se.side,i,me(Fe),r,s,a,void 0,"fill");const Me=Ce(le,Ie);oe.generate(t,f,n,se.top,i,me(Me),r,s,a,void 0,"fill")}}};function YI(t){let e=0;for(let n=0;n<t.length-1;n++)e+=eo(t[n],t[n+1]);return e}var ur=(t=>(t[t.Chess=1]="Chess",t[t.DoubleDash=2]="DoubleDash",t[t.Stripe=3]="Stripe",t[t.Triangles=4]="Triangles",t[t.Circle=5]="Circle",t[t.Chevron=6]="Chevron",t[t.None=-1]="None",t))(ur||{});function qI(t){switch(t){case"chess":return 1;case"doubledash":return 2;case"triangles":return 4;case"circle":return 5;case"heart":return 6;case"stripe":return 3;default:return-1}}const KI={symbol:"simpleMesh",sinks:{fill:{stride:24,binder:()=>{},packObjectAttributes(t,e,n){return Dt([t,e.innerId],e,n)},unpackObjectAttributes(t){return{styleId:t[0],layerId:t[1],tileData:t.slice(2)}}}}},JI=32,tl={symbol:"globe",sinks:{fill:{stride:16,binder:(t,e)=>{t.views.ecefPosition=new Int16Array(e),t.views.flatPosition=new Uint16Array(e,6),t.views.texture=new Uint16Array(e,12)},packObjectAttributes(t,e,n){return[t,e.innerId,n]},unpackObjectAttributes(t){return{styleId:t[0],layerId:t[1],tileData:t.slice(2)}},generate(t,e,n,i){const o=i.coords.join("/"),r=t.getBucket("globe","fill",tl.sinks.fill.packObjectAttributes(e.id,n,o),tl.sinks.fill.binder);t7(r,JI,i.coords)}}}},QI=Rn.fromGeo([0,90]),e7=Rn.fromGeo([0,-90]);function t7(t,e,n){const i=Ct(n),o=t.views.ecefPosition,r=t.indices.buffer,s=n[1]===2**n[2]-1,a=n[1]===0,l=t.elements.offset*tl.sinks.fill.stride/Uint16Array.BYTES_PER_ELEMENT;let c=0,d=t.indices.offset;for(let u=0;u<e;u++)for(let f=0;f<e;f++){let h;const _=[u*32768/(e-1),f*32768/(e-1)];s&&f===e-1?h=QI:a&&f===0?h=e7:h=I0(i,_),o[l+c++]=h[0]*Vn,o[l+c++]=h[1]*Vn,o[l+c++]=h[2]*Vn,o[l+c++]=Y+_[0],o[l+c++]=Y+_[1],o[l+c++]=0,o[l+c++]=u/(e-1)*(2**16-1),o[l+c++]=f/(e-1)*(2**16-1)}for(let u=0;u<e-1;u++)for(let f=0;f<e-1;f++){const h=u*e+f,_=h+1,p=h+e,m=p+1;r[d++]=h,r[d++]=p,r[d++]=_,r[d++]=_,r[d++]=p,r[d++]=m}t.indices.offset=d,t.elements.offset=l+c/8}var ep=(t=>(t[t.none=0]="none",t[t.fadeIn=1]="fadeIn",t[t.fadeOut=-1]="fadeOut",t))(ep||{});function io({collector:t,generator:e,args:n}){do e(t,...n);while(t.isOverloaded())}const M5={arrow:Lc,line:Ot,polygon:Oo,embankment:oe,polygon3d:oe,metricPoint:xf,labelLine:Jm,lineExtrusion:ko,polygonExtrusion:Bo,oneWayLine:Qm,dashedLine:dr,shiftedLine:yf,circle:Ja,buildingModel:Bi,gltfModel:Ni,point:gr,raster:wf,heatmap:Br,dem:xn,mesh:oe,mapMesh:el,overpass:w5,tunnel:S5,simpleMesh:KI,globe:tl};function qc(t,e){const n=M5[t];return n?n.sinks[e].stride:0}function vr(t,e){t.precomputes.forEach((n,i)=>{e.tileData[i]=te(n.expr,e)})}function T5(t,e,n,i,o,r,s,a,l,c,d,u,f,h){n.forEach(_=>{if(lM(i,[d.x[0],d.y[0]]),!(s!==void 0&&(_.maxzoom<=s||_.minzoom>=s+1&&s!==qe.maxDetailLevel))&&!(i.tileProps.hovered&&!Number.isNaN(i.tileAttrs[i.tileProps.hovered])&&i.tileAttrs[i.tileProps.hovered]===1&&_.type!=="polygon"&&_.type!=="polygonExtrusion"&&_.type!=="point"&&_.type!=="polygon3d")){vr(_,i);do switch(_.type){case"line":const p=te(_.style.pattern,i);p&&p[0]!==ur.None?Ot.generatePatterned(t,e.id,_,i,l,d):Ot.generate(t,e.id,_,i,l,d);break;case"dashedLine":dr.generate(t,e.id,_,i,l,d);break;case"shiftedLine":yf.generate(t,e.id,_,i,d);break;case"polygon":Oo.generate(t,e.id,_,i,d,c,e.rasterSets);break;case"polygon3d":case"embankment":oe.generate(t,e.id,_,se.top,i,d,l,c,e.rasterSets,void 0,"fill");break;case"metricPoint":{xf.generate(t,d,c,e,_,i,l);break}case"polygonExtrusion":Bo.generate(t,e.id,_,i,d);break;case"labelLine":AI(t,e.id,_,l.coords,a,i,d);break;case"oneWayLine":CI(t,e.id,_,l.coords,a,i,d);break;case"point":{II(t,e,_,i,o,r,l.coords,a,d,c,u);break}case"lineExtrusion":ko.generate(t,e.id,_,i,d);break;case"arrow":Lc.generate(t,e.id,_,i,d);break;case"heatmap":{Br.generate(t,e.id,_,d,i);break}case"gltfModel":{Ni.generateInstances(t,e,_,i,d,l,a,f,h,o,2);break}case"overpass":w5.generate(t,e,_,i,d,l,c,e.rasterSets);break;case"tunnel":S5.generate(t,e,_,i,d,l,c,e.rasterSets);break}while(t.isOverloaded())}})}let n7=1;function mo(){return n7++}let i7=1;const po=()=>++i7,i1=po(),o1=po();class R{constructor(e,n={}){this._buffer=e,this.options=Object.assign({},F.defaultOptions,n)}get isDirty(){return this._buffer.isDirty}set isDirty(e){this._buffer.isDirty=e}bind(e,n,i,o,r){this._buffer.bind(e,n,i||this.options,o,r)}replaceData(e){this._buffer.replaceData(e)}commitData(e){this._buffer.commitData(e)}getData(){return this._buffer.getData()}}function r1(t,e){const n=new Set;return t.forEach(i=>{e.has(i)||n.add(i)}),n}function o7(t,e){if(!t||!e)return t===e;if(t.size!==e.size)return!1;for(const n of t)if(!e.has(n))return!1;return!0}function r7(t,e){const n=new Set;for(const i of e)t.has(i)&&n.add(i);return n}function s7(t,e){if(!t||!e)return t===e;if(t.size!==e.size)return!1;for(const[n,i]of t)if(!e.has(n)||!o7(i,e.get(n)))return!1;return!0}const Yo="default",tp="floor",np="dynamicModel";var Qn=(t=>(t[t.PolygonExtrusion=1]="PolygonExtrusion",t[t.FloorPolygons=2]="FloorPolygons",t[t.All=3]="All",t))(Qn||{});class a7{constructor(e){this.identifier=e,this.tileLayers=[],this.selected=[],this.hidden=new Map,this.parentChildrenMap=new Map,this.childParentMap=new Map,this.parentChildrenMapByTile=new Map,this.selectedIdsByApi=[]}registerTileLayer(e){this.tileLayers.push(e)}unregisterTileLayer(e){this.tileLayers=this.tileLayers.filter(n=>n!==e)}select(e){this.selectedIdsByApi=e.slice(),this.selected=this.getIdsToSelect(e),this.selected.sort();for(const n of this.tileLayers)n.setSelectedIds(this.selected);this.identifier.debouncedFillCache()}getSelected(){return this.selected}show(e){for(const n of e)this.hidden.delete(n);this.triggerIdUpdate(e)}hide(e,n=3){for(const i of e)this.hidden.set(i,n);this.triggerIdUpdate(e)}isHidden(e,n=3){return(this.hidden.get(e)??0)>=n}getHidden(e=3){const n=new Set;return this.hidden.forEach((i,o)=>{i>=e&&n.add(o)}),n}triggerIdUpdate(e){for(const n of this.tileLayers)n.pushIdsToUpdate(e)}removeParentChildrenData(e){let n=!1;e.forEach(i=>{const o=this.parentChildrenMapByTile.delete(i);!n&&o&&(n=!0)}),n&&this.rebuildMaps()}updateParentChildrenData(e,n){this.updateTileParentChildrenData(e,n)&&(this.addParentChildrenData(n),this.select(this.selectedIdsByApi))}addParentChildrenData(e){e&&e.size&&e.forEach((n,i)=>{const o=this.parentChildrenMap.get(i);o?n.forEach(r=>{o.add(r),this.childParentMap.set(r,i)}):(this.parentChildrenMap.set(i,new Set(n)),n.forEach(r=>{this.childParentMap.set(r,i)}))})}rebuildMaps(){this.parentChildrenMap.clear(),this.childParentMap.clear(),this.parentChildrenMapByTile.forEach(e=>this.addParentChildrenData(e))}updateTileParentChildrenData(e,n){const i=this.parentChildrenMapByTile.get(e);return s7(i,n)?!1:(i&&i.forEach((o,r)=>{const s=this.parentChildrenMap.get(r);o.forEach(a=>{s==null||s.delete(a),this.childParentMap.delete(a)})}),this.parentChildrenMapByTile.delete(e),n&&this.parentChildrenMapByTile.set(e,n),!0)}getIdsToSelect(e){const n=new Set(e);return e.forEach(i=>{if(this.parentChildrenMap.has(i)){const r=this.parentChildrenMap.get(i);r!=null&&r.size&&r.forEach(n.add,n)}}),Array.from(n)}}function I5(t,e,n,i){for(const o of e)d7(t,n,o,i)}function l7(t,e,n){const i=e.buffer,o=[];for(const r of e.generatedObjects){const s=new DataView(i,r.rangeStart,r.rangeEnd-r.rangeStart),a=new F(s);a.purpose="instanced",a.drawType=F.StaticDraw,a.prepare(t.getRenderingContext()),r.buffer=a,r.rangeEnd-r.rangeStart===n&&(r.tMatrix3x3=new Float32Array(s.buffer,r.rangeStart+16,9)),o.push(a)}return o}function c7(t,e,n,i,o){const r=new F(n);r.purpose="attributes",r.drawType=F.StaticDraw,r.prepare(t.getRenderingContext());const s=[];let a,l,c;return o&&(c=new F(o,{itemSize:1,dataType:F.UnsignedShort},!0),c.elementsType=F.UnsignedShort),e.forEach(d=>{const u=t.getShaderProgram(d.programName),f=d.vaoCreator(r,u,c);if(d.needsVisibilityBuffer){if(!a||!l){const h=new Uint8Array(new Array(i).fill(1));a=new F(h,void 0,!1,!0),a.purpose="visibility",l=new R(a,{itemSize:1,dataType:F.UnsignedByte})}f.setAttribute("a_float_visibility",l)}s.push(f)}),{buffer:r,visibilityBuffer:a,vaos:s}}function d7(t,e,n,i){const{renderer:o,instanceLinker:r}=t,{symbol:s,sink:a,generatedObjects:l,buffer:c,elementsBuffer:d,elementSize:u}=n;if(o.symbolSettingsList[s]===void 0)return;const h=G0(o,s,a);if(h.length===0)return;const _=qc(s,a);if(h[0].instanceBinder){const b=l7(o,n,_);e.buffers.push(...b),r.enqueue(n,e);return}let p=0;d&&u?p=d.byteLength/u:p=c.byteLength/_;const{buffer:m,vaos:g,visibilityBuffer:y}=c7(o,h,c,p,d);e.pushBuffer(m),y&&e.pushBuffer(y);for(let b=0;b<l.length;b++){const{rangeStart:v,rangeEnd:T,attributes:x,drawMode:I,meta:E,objectsData:L}=l[b],N=M5[s].sinks[a].unpackObjectAttributes(x),k=[];for(let w=0;w<h.length;w++){const S=h[w],A=g[w],z=S.uniformSet||"fill",M={id:mo(),type:ri.Tile,layerSettings:S,start:v/_,count:(T-v)/_,attributes:N,renderingProperties:{},attributesHash:JSON.stringify(x)+"_"+z+"_"+e.detailLevel,vao:A,drawMode:I,tile:e,symbol:s,sink:a,meta:E,canRender:!0};e.push(M),S.needsVisibilityBuffer&&k.push(A)}i&&k.length>0&&L&&e instanceof bi&&u7(L,e,k,i,!!N.floorId)}}function u7(t,e,n,i,o){const r=o?e.floorObjectsMap:e.objectsMap,s=[];for(const a in t){const l=t[a];let c=r[a];c||(c=new Map,r[a]=c);let d=c.get(n);d||(d=[],c.set(n,d));for(const u of l)d.push(u);i.isHidden(a,Qn.PolygonExtrusion)&&s.push(a)}i.triggerIdUpdate(s)}function G0(t,e,n){const i=t.symbolSettingsList[e];if(i===void 0)return[];const o=i[n];return o==null||o.length===0?[]:o}let f7=0;class H0{constructor(e,n){this.isDestroyed=!1,this.id=f7++,this.ids=n,this.tickerName=`tile-fade-${e}-${this.id}`,this.readiness=1,this.needSync=!1,this.modelMatrices=new Map,this.coords=[0,0,0,0],this.bounds=new Map,this.mvpMatrices=new Map,this.demMatrices=new Map,this.flatMapTexMatrices=new Map,this.purpose=e,this.buffers=[],this.children=[],this.identifyChildren=[],this.depthTestChildren=[],this.shadowChildren=[],this.labelTestChildren=[]}get destroyed(){return this.isDestroyed}get empty(){return this.children.length===0}updateMvpMatrix(e,n,i){this.modelMatrices.forEach((o,r)=>{const s=this.mvpMatrices.get(r)??new Float32Array(16);if(Hr(s,e,o),this.mvpMatrices.set(r,s),n){const a=this.demMatrices.get(r)??new Float32Array(16);Hr(a,n,o),this.demMatrices.set(r,a)}if(i){const a=this.flatMapTexMatrices.get(r)??new Float32Array(16);Hr(a,i,o),this.flatMapTexMatrices.set(r,a)}})}setMvpMatrix(e){this.modelMatrices.forEach((n,i)=>{this.mvpMatrices.set(i,new Float32Array(e))})}clean(e){for(const n of this.buffers)n.remove();this.buffers=[],this.children=[],this.labelTestChildren=[],this.identifyChildren=[],this.depthTestChildren=[],this.shadowChildren=[],It(this.tickerName,e),this.isDestroyed=!0}updateTicker(e){xt(this.tickerName,{step:(n,i)=>{this.readiness=i}},e)}startTicker(e,n,i,o,r){At(this.tickerName,{easing:n},e,o,r,i,1)}tickerFinished(e){return!S0(this.tickerName,e)}push(e){const n=e.layerSettings;n.identify?this.identifyChildren.push(e):n.depthTest?this.depthTestChildren.push(e):n.labelTest?e.sink==="raster"&&e.symbol==="point"&&this.labelTestChildren.push(e):n.shadow?this.shadowChildren.push(e):this.children.push(e)}pushBuffer(e){this.buffers.push(e)}}class bi extends H0{constructor(e,n,i,o,r=[0,0,0,0],s,a,l){super(e,a),this.objectsMap={},this.floorObjectsMap={},this.dynamicObject=s,this.sourceId=l,I5(i,n,this,a),this.setTileCoords(r,o)}setTileCoords(e,n){const i=e[2],o=e[3],r=Nt(i);this.coords=e,this.size=r,this.zoomLevel=i,this.detailLevel=o,this.mvpMatrices.clear(),this.demMatrices.clear(),this.flatMapTexMatrices.clear(),this.syncReplicas(n)}syncReplicas(e){let n=[...e.visibleMapReplicas];if(this.purpose==="globe"){const{center:r}=e,s=Nt(this.coords[2]),a=Math.trunc((2**31+r[0])/s);n=[Math.round((a-this.coords[0])/2**this.coords[2])]}if(this.dynamicObject&&this.dynamicObject.isOutOfMainReplica()){const r=n[0],s=n[n.length-1];n.push(r-1,s+1)}const i=Y/Se*this.size,o=Math.pow(2,this.coords[2]);this.bounds.clear(),this.modelMatrices.clear(),n.forEach(r=>{const s=[this.coords[0]+r*o,this.coords[1],this.coords[2],this.coords[3]],a=Di(s);this.bounds.set(r,{min:[a[0],a[1]],max:[a[0]+this.size,a[1]+this.size]});const l=Ui();ro(l,[a[0]-i,a[1]-i,0],yt(this.size/oo,this.size/oo,Ha/oo)),this.modelMatrices.set(r,l)}),this.needSync=!1}updateObjVisibility(e,n,i){const o=i?this.floorObjectsMap[e]:this.objectsMap[e];if(!o)return!1;let r=!1;return o.forEach((s,a)=>{const c=a[0].getBuffer("a_float_visibility").getData();if(!(c instanceof Uint8Array))return;let d=!1;for(const{offset:u,size:f}of s)if(c[u]!==n){for(let h=u;h<u+f;++h)c[h]=n;d=!0}if(d){a[0].rewriteData("a_float_visibility");for(const u of a)u.isDirty=!0;r=!0}}),r}clean(e){for(const n in this.objectsMap)this.objectsMap[n].forEach((i,o)=>{o.forEach(r=>{r.unbind(),r.remove()})});for(const n in this.floorObjectsMap)this.floorObjectsMap[n].forEach((i,o)=>{o.forEach(r=>{r.unbind(),r.remove()})});super.clean(e)}}class Kt{constructor(e){this.defs=e.map(n=>new h7(n))}check(e){const n=this.defs;let i=!1;for(let o=0;o<n.length;o++)i?n[o].update(e):i=!n[o].equal(e);return i}}class h7{constructor(e){this.path=Array.isArray(e.path)?e.path:[e.path],this.type=e.type,this.type==="number"?(this.last=NaN,this.compare=this.primitive,this.updateFn=this.primitiveUpdate):this.type==="boolean"?(this.last=void 0,this.compare=this.primitive,this.updateFn=this.primitiveUpdate):this.type==="vec2"?(this.last=[NaN,NaN],this.compare=this.vec2,this.updateFn=this.vec2Update):this.type==="vec3"?(this.last=[NaN,NaN,NaN],this.compare=this.vec3,this.updateFn=this.vec3Update):this.type==="string"?(this.last="",this.compare=this.primitive,this.updateFn=this.primitiveUpdate):this.type==="padding"?(this.last={left:0,right:0,bottom:0,top:0},this.compare=this.padding,this.updateFn=this.paddingUpdate):this.type==="replicas"&&(this.last={min:0,max:0},this.compare=this.replicas,this.updateFn=this.replicasUpdate)}equal(e){const n=this.take(e),i=this.compare(this.last,n);return this.updateFn(n),i}update(e){this.updateFn(this.take(e))}take(e){const n=this.path;let i=0;do e=e[n[i++]];while(i<n.length);return e}primitive(e,n){return e===n}padding(e,n){return e.top===n.top&&e.bottom===n.bottom&&e.left===n.left&&e.right===n.right}paddingUpdate(e){this.last.top=e.top,this.last.bottom=e.bottom,this.last.right=e.right,this.last.left=e.left}vec2(e,n){return e[0]===n[0]&&e[1]===n[1]}vec3(e,n){return e[0]===n[0]&&e[1]===n[1]&&e[2]===n[2]}primitiveUpdate(e){this.last=e}vec2Update(e){this.last[0]=e[0],this.last[1]=e[1]}vec3Update(e){this.last[0]=e[0],this.last[1]=e[1],this.last[2]=e[2]}replicas(e,n){const i=n[0],o=n[n.length-1];return e.min===i&&e.max===o}replicasUpdate(e){this.last.min=e[0],this.last.max=e[e.length-1]}}const wo=[0,0,0],_7=[0,0,1],m7=[0,-1,0],Bd=[0,0,0],Od=[0,0,0],Dd=[0,0,0],Nd=[0,0,0];let s1;const Nl=[0,0,0],Ul=[0,0,0];let a1;function p7(t,e){const n=[0,0,0];$t(n,e.center,t.position);const i=mr(n);_n(n,n);const o=Ug([0,0,-1],n),r=Math.PI/2-o,s=Ug([1,0,0],[n[0],n[1],0]),a=n[1]<0?-s:s,l=e.size[0]/e.size[1],d=nn.far*Math.tan(nn.fov*.5)*l,u=nn.fov/2,f=Math.atan(d/nn.far);return _a(Nl,_7,wo,u),s1=[Nl[0],Nl[1],-Nl[2]],ma(Ul,m7,wo,f),a1=[Ul[0],-Ul[1],Ul[2]],_a(Dd,s1,wo,r),ma(Dd,Dd,wo,a),_a(Nd,Nl,wo,r),ma(Nd,Nd,wo,a),_a(Od,Ul,wo,r),ma(Od,Od,wo,a),_a(Bd,a1,wo,r),ma(Bd,Bd,wo,a),{near:nn.near,far:nn.far,nearNormal:n,topNormal:Dd,bottomNormal:Nd,leftNormal:Od,rightNormal:Bd,cameraPosition:t.position,stateCenter:e.center,camPosToStateCenterLength:i}}function l1(t,e){return"region"in e?x7(t,e.region):!1}function Ta(t,e){return Fs(t,e)}function g7(t,e,n){return Ta(t,e)-n}function v7(t,e,n){const i=Ta(t,e);return n-i}function E5(t,e,n){const i=[0,0,0];$t(i,t,e.cameraPosition);const o=n!=null&&n.near?0:g7(i,e.nearNormal,e.near),r=n!=null&&n.far?0:v7(i,e.nearNormal,e.far),s=n!=null&&n.top?0:Ta(i,e.topNormal),a=n!=null&&n.bottom?0:Ta(i,e.bottomNormal),l=n!=null&&n.left?0:Ta(i,e.leftNormal),c=n!=null&&n.right?0:Ta(i,e.rightNormal);return{near:o>=0,nearNormalProj:o,far:r>=0,farNormalProj:r,top:s>=0,topNormalProj:s,bottom:a>=0,bottomNormalProj:a,left:l>=0,leftNormalProj:l,right:c>=0,rightNormalProj:c,point:t}}function A5(t){return t.near&&t.far&&t.top&&t.bottom&&t.left&&t.right}function y7(t){return t.some(e=>e===0)}function b7(t,e,n,i){const o=t[0]>=e[0]&&t[1]>=e[1],r=t[0]<=n[0]&&t[1]<=n[1],s=i.camPosToStateCenterLength>=i.near&&i.camPosToStateCenterLength<=i.far;return!!(o&&r&&s)}function ia(...[t,e,n,i,o,r,s,a]){if(n!==i){const l=Math.abs(o/r),c=[(t[0]+l*e[0])/(1+l),(t[1]+l*e[1])/(1+l),0],d=E5(c,a,s);if(A5(d))return!0}return!1}function w7(t,e){const n=t[0],i=t[1],o=[n.point,i.point,n.near,i.near,n.nearNormalProj,i.nearNormalProj,{near:!0},e],r=[n.point,i.point,n.far,i.far,n.farNormalProj,i.farNormalProj,{far:!0},e],s=[n.point,i.point,n.top,i.top,n.topNormalProj,i.topNormalProj,{top:!0},e],a=[n.point,i.point,n.bottom,i.bottom,n.bottomNormalProj,i.bottomNormalProj,{bottom:!0},e],l=[n.point,i.point,n.left,i.left,n.leftNormalProj,i.leftNormalProj,{left:!0},e],c=[n.point,i.point,n.right,i.right,n.rightNormalProj,i.rightNormalProj,{right:!0},e];return!!(ia(...o)||ia(...r)||ia(...s)||ia(...a)||ia(...l)||ia(...c))}function x7(t,e){const n=q.fromGeo(e.slice(0,2)),i=q.fromGeo(e.slice(2,4)),o=n,r=[i[0],n[1],0],s=i,a=[n[0],i[1],0];if(b7(t.stateCenter,o,s,t))return!0;const l=[0,0,0,0,0,0],c=[o,r,s,a].map(d=>{const u=E5(d,t);return l[0]+=+u.near,l[1]+=+u.far,l[2]+=+u.top,l[3]+=+u.bottom,l[4]+=+u.left,l[5]+=+u.right,u});return c.some(A5)?!0:y7(l)?!1:!![[c[0],c[1]],[c[1],c[2]],[c[2],c[3]],[c[3],c[0]]].some(d=>w7(d,t))}const c1=2,S7={geometricError:NaN,refine:"REPLACE",boundingVolume:{region:[0,0,0,0,0,0]}};class M7{constructor(e,n,i){this.id=e,this.modules=n,this.options=i,this.type="c3d",this.displayed=[],this.attributes=Object.assign({sourceName:"c3d"},i.attributes??{}),this.styleLayerId=NaN,this.rootUrl=Ya(this.options.rootUrl??"https://tile.googleapis.com/v1/3dtiles/root.json?key={key}",{key:i.key});const o=new URL(this.rootUrl);this.baseUrl=`${o.protocol}//${o.host}`,this.rootTile=null,this.stateDiffer=new Kt([{path:"center",type:"vec2"},{path:"zoom",type:"number"},{path:"size",type:"vec2"},{path:"rotation",type:"number"},{path:"pitch",type:"number"},{path:"padding",type:"padding"},{path:"demMode",type:"boolean"},{path:"handyStyleId",type:"number"}])}abortTileFetch(e){}deleteTile(e){}fetchTile(e){return Promise.resolve(void 0)}async generateTile(e,n){const i=[],o=[];return Promise.resolve({results:i,transferable:o})}getAttributes(){return this.attributes}setAttributes(e){this.attributes=e}destroy(){}update(e=!1){const n={total:0,loaded:0,onScene:0,added:0,removed:0},{assetManager:i,tileManager:o,camera:r,map:s,collector:a,styleManager:l}=this.modules,c=p7(r,s.state);if(this.rootTile||(this.rootTile=S7,this.fetch(this.rootUrl).then(y=>{this.rootTile=y.root,this.traverse(this.rootTile,s.state,c).then(()=>{console.log("call update"),this.update(!0)})})),this.styleLayerId||this.checkStyleLayer(),!this.stateDiffer.check(s.state)&&!e)return;const u=l.getStyle(s.state.handyStyleId);if(!u||!this.styleLayerId)return;const f=u.layersById[this.styleLayerId];if(!f||f.type!=="gltfModel")return;const h=Zo(s.state.styleState,{},{content:1},[],[]),_=y=>{var I,E;const b=((I=y.content)==null?void 0:I.uri)??"",v=!!b&&((E=y.content)==null?void 0:E.ready),T=l1(c,y.boundingVolume),x=d1(y,s.state,c.cameraPosition)>c1;if(n.total+=1,!!T){if(y.onScene=T&&x,y.contentLoaded=i.isModelLoaded(y.modelIndex??NaN,s.state.handyStyleId),y.onScene&&v&&!y.tileObject){const{tileCoords:L,tileInfo:N,vertices:k}=T7(y.boundingVolume);h.tileAttrs[h.tileProps.content]=b,io({collector:a,generator:Ni.generateInstances,args:[u,f,h,{x:k[0],y:k[1]},N,this.id,this.baseUrl]});const w=a.getAccumulatedData();this.modules.assetManager.fillDataModelUrlMap(w.dataModelsUrls),y.tileObject=new bi("c3d",w.data,this.modules,this.modules.map.state,L),y.modelIndex=w.dataModelsUrls[b],a.reset()}y.onScene&&y.contentLoaded&&y.refine==="REPLACE"&&y.parent&&(y.parent.onScene=!1);for(const L of y.children??[])_(L)}},p=y=>{const b=y.tileObject;if(y.onScene&&(n.onScene+=1),y.contentLoaded&&(n.loaded+=1),b){const v=b.children[0].id??NaN;y.onScene&&!this.displayed[v]?(o.addObject(b),this.displayed[v]=y,n.added+=1):!y.onScene&&this.displayed[v]}for(const v of y.children??[])p(v)},m=()=>{for(const y of this.displayed)if(y&&!y.onScene&&y.tileObject){const b=y.tileObject.children[0].id??NaN;this.displayed[b]=null,o.removeObject(y.tileObject),n.removed+=1}},g=()=>{for(const y of this.displayed)y&&(y.onScene=!1)};this.rootTile&&(g(),_(this.rootTile),p(this.rootTile),m(),(n.added||n.removed)&&this.modules.renderer.addRerenderEvent(),console.log(n))}checkStyleLayer(){const{styleState:e,handyStyleId:n}=this.modules.map.state;let i=null;const o=this.modules.styleManager.getStyle(n);if(!o)return;const r=Zo(e,this.attributes,{},[],[]);for(const s in o.layersById){const a=o.layersById[s];if(a&&a.type==="gltfModel"&&te(a.filter,r)){i=a,console.log("found!",i);break}}i&&i.innerId&&i.innerId!==this.styleLayerId&&(this.styleLayerId=i.innerId)}async traverse(e,n,i){var r;if(!e)return;e.children||(e.children=[]);for(const s of e.children)s.parent=e,await this.traverse(s,n,i);const o=(r=e.content)==null?void 0:r.uri;if(o)if(this.getUrlFileExtension(o)==="json"){const a=d1(e,n,i.cameraPosition)<=c1||!0;if(!l1(i,e.boundingVolume)||a)return}else{const a=o[0]==="/"?`${this.baseUrl}${o}`:o;e.content={ready:!0,uri:a}}}getUrlFileExtension(e){const n=e[0]==="/"?`${this.baseUrl}${e}`:e,o=new URL(n).pathname.match(/\.(\w+)$/);return o?o[1]:""}fetch(e){const n=e[0]==="/"?`${this.baseUrl}${e}`:e;return fetch(n).then(i=>i.json())}}function d1(t,e,n){const{geometricError:i,boundingVolume:o}=t,r=e.size[1];let s=NaN;if("region"in o){const a=C5(t.boundingVolume);s=Qf(n,a)/He}return i*r/(s*2*Math.tan(nn.fov/2))}function T7(t){const n=Nt(15);if("region"in t){const i=C5(t),o=qa(i,15);o[0]=Math.round(o[0]),o[1]=Math.round(o[1]);const r=Ct(o),s=Math.trunc(i[0]%n/n*Se),a=Math.trunc(i[1]%n/n*Se);return{vertices:[[s],[a]],tileCoords:o,tileInfo:r}}throw new Error("not implemented")}function C5(t){if("region"in t){const e=t.region.slice(0,2),n=t.region.slice(2,4),i=[(e[0]+n[0])/2,(e[1]+n[1])/2];return q.fromGeo(i)}throw new Error("not implemented")}var Kn=(t=>(t[t.Stationary=0]="Stationary",t[t.ZoomingIn=1]="ZoomingIn",t[t.ZoomingOut=2]="ZoomingOut",t))(Kn||{}),pi=(t=>(t[t.ByOne=0]="ByOne",t[t.WaitingLayer=1]="WaitingLayer",t[t.GlobalWaiting=2]="GlobalWaiting",t))(pi||{});class I7{constructor(e,n){this.type="c3d",this.id=Rs(),this.modules=e.modules,this.source=new M7(this.id,this.modules,n),this.modules.map.on("update",()=>this.source.update()),this.modules.assetManager.on("modelloaded",()=>this.source.update(!0)),this.modules.sourceStorage.addSource(this)}destroy(){this.modules.sourceStorage.removeSource(this.getId()),this.source.destroy()}getAttributes(){return this.source.getAttributes()}getId(){return this.source.id}setAttributes(e){this.source.setAttributes(e)}isIdentifiedAsDefault(){return!1}getZoomDirection(){return Kn.Stationary}}const E7=(t,e)=>{W.cesiumTiles="cesiumTiles"in V4;let n=null;function i(){n&&(n.destroy(),n=null,window.cesiumSource=null,t.removeLayer("c3d-layer"))}const o={initialize:()=>{i(),W.cesiumTiles=!0,Vt(t,W),t.addLayer({id:"c3d-layer",type:"model",style:{modelSrc:["get","content"],color:"#00f8",offset:["literal",[0,0,20]],linkedIds:["get","linked_ids"]},filter:["match",["sourceAttr","sourceName"],["c3d"],!0,!1],minzoom:1,interactive:!1}),n=new I7(t._impl,{key:"YOUR_KEY",rootUrl:`${self.origin}/assets/tiles/c3d/out.json`}),window.cesiumSource=n},remove:()=>{i(),W.cesiumTiles=!1,Vt(t,W)}};t.on("styleload",()=>{W.cesiumTiles&&o.initialize()});const r=e.addFolder("Cesium 3D tiles");r.add(o,"initialize"),r.add(o,"remove")};let Gl,En,Ii,oa;const d_=v3([{type:"polygon",id:"geojson-polygon",filter:["match",["sourceAttr","demoCase"],["polygon"],!0,!1],style:{strokeWidth:2,strokeColor:"#444444",color:"#00ff00a0"}},{type:"line",id:"geojson-line",filter:["match",["sourceAttr","demoCase"],["line"],!0,!1],style:{color:"#9e02e0",width:5}},{type:"point",id:"geojson-point",filter:["match",["sourceAttr","demoCase"],["point"],!0,!1],style:{iconWidth:16,textFont:["Open_Sans","Open_Sans"],textField:["get","NAME"],textFontSize:[16,16]}}]),u_=t=>`http://localhost:8080/geoserver/tiger/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=tiger%3Apoi&maxFeatures=50&outputFormat=application%2Fjson&bbox=${t}&srcName=EPSG:4326`,Ud=t=>`http://localhost:8080/geoserver/tiger/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=tiger%3Atiger_roads&maxFeatures=50&outputFormat=application%2Fjson&bbox=${t}&srcName=EPSG:4326`,u1=t=>`http://localhost:8080/geoserver/tiger/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=tiger%3Apoly_landmarks&maxFeatures=50&outputFormat=application%2Fjson&bbox=${t}&srcName=EPSG:4326`,A7=t=>`http://localhost:8080/geoserver/tiger/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=tiger%3Apoi&outputFormat=application%2Fjson&bbox=${t}&srcName=EPSG:4326`,C7=t=>`http://localhost:8080/geoserver/tiger/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=tiger%3Atiger_roads&outputFormat=application%2Fjson&bbox=${t}&srcName=EPSG:4326`,P7=t=>`http://localhost:8080/geoserver/tiger/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=tiger%3Apoly_landmarks&outputFormat=application%2Fjson&bbox=${t}&srcName=EPSG:4326`,L7=(t,e)=>{function n(){[En,Ii,oa].forEach(r=>{r&&r.destroy()}),En=void 0,Ii=void 0,oa=void 0}const i={addAndNavigate:async()=>{n(),t.setStyle(d_,xs),En=new mapgl.GeoJsonViewportSource(t,{data:u_,attributes:{demoCase:"point"}}),Ii=new mapgl.GeoJsonViewportSource(t,{data:Ud,attributes:{demoCase:"line"}}),oa=new mapgl.GeoJsonViewportSource(t,{data:u1,attributes:{demoCase:"polygon"}}),t.setCenter([-74.0104611,40.70758763]),t.setStyleZoom(12),t.setPitch(0),t.setRotation(0)},setWrongDataFunction:()=>{En&&En.setData(r=>`wrong-path&bbox=${r}`),Ii&&Ii.setData(r=>`wrong-path&bbox=${r}`),oa&&oa.setData(r=>`wrong-path&bbox=${r}`)},remove:n,setStyle:()=>{t.setStyle(d_,xs)},setPointsToSource1:()=>{En?(En.setData(u_),En.setAttributes({demoCase:"point"})):En=new mapgl.GeoJsonViewportSource(t,{data:u_,attributes:{demoCase:"point"}})},setLinesToSource1:()=>{En&&(En.setData(Ud),En.setAttributes({demoCase:"line"}))},setPolygonsToSource1:()=>{En&&(En.setData(u1),En.setAttributes({demoCase:"polygon"}))},geoJsonSourceCase1:async()=>{i.destroyGeoJsonSource();const s=await(await fetch("http://localhost:8080/geoserver/tiger/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=tiger%3Atiger_roads&outputFormat=application%2Fjson&bbox=-74.20169760086213,40.680783756351005,-73.75862239916096,40.850228280883705&srcName=EPSG:4326")).json();Gl=new mapgl.GeoJsonSource(t,{data:s,attributes:{demoCase:"line"}})},destroyGeoJsonSource:()=>{Gl==null||Gl.destroy(),Gl=void 0},allFeaturesCase:async()=>{n(),t.setStyle(d_,xs),En=new mapgl.GeoJsonViewportSource(t,{data:A7,attributes:{demoCase:"point"}}),Ii=new mapgl.GeoJsonViewportSource(t,{data:C7,attributes:{demoCase:"line"}}),oa=new mapgl.GeoJsonViewportSource(t,{data:P7,attributes:{demoCase:"polygon"}}),t.setCenter([-74.0104611,40.70758763]),t.setStyleZoom(12),t.setPitch(0),t.setRotation(0)},viewportPadding0(){n(),Ii?Ii.setViewportPadding(0):Ii=new mapgl.GeoJsonViewportSource(t,{data:Ud,attributes:{demoCase:"line"},viewportPadding:0}),t.setCenter([-74.0104611,40.70758763]),t.setStyleZoom(19),t.setPitch(0),t.setRotation(0)},viewportPadding500(){n(),Ii?Ii.setViewportPadding(500):Ii=new mapgl.GeoJsonViewportSource(t,{data:Ud,attributes:{demoCase:"line"},viewportPadding:500}),t.setCenter([-74.0104611,40.70758763]),t.setStyleZoom(19),t.setPitch(0),t.setRotation(0)}},o=e.addFolder("WFS");o.add(i,"addAndNavigate"),o.add(i,"setWrongDataFunction"),o.add(i,"remove"),o.add(i,"setStyle"),o.add(i,"setPointsToSource1"),o.add(i,"setLinesToSource1"),o.add(i,"setPolygonsToSource1"),o.add(i,"geoJsonSourceCase1"),o.add(i,"destroyGeoJsonSource"),o.add(i,"allFeaturesCase"),o.add(i,"viewportPadding0"),o.add(i,"viewportPadding500")},F7=(t,e)=>{const n=e.addFolder("Sources & Layers");IS(t,n),TS(t,n),c6(t,n),d6(t,n),E7(t,n),L7(t,n)},k7=(t,e)=>{const n=Math.random,i=[],o=e.addFolder("DashedPolylines"),r={add(){const s=t.getCenter(),a=1+Math.ceil(n()*5),l=[];for(let u=0;u<a;u++)l.push([s[0]+(n()-.05)*.04,s[1]+(n()-.05)*.02]);const c=14,d=new mapgl._J.DashedPolyline(t,{coordinates:l,dashLength:c,dash2Length:4*c,gapLength:2*c,dashColor:"#0000ff",dash2Color:"#ffffff",width:["interpolate",["linear"],["zoom"],8,4,14,12,16,36],width2:["interpolate",["linear"],["zoom"],8,6,14,20,16,40],showAnimation:{easing:"linear",duration:4e3,durationRange:{start:.05,end:.9}}});d.on("click",u=>{console.log(u,d)}),d.on("mouseover",()=>{d.setStyle({dashColor:"#ff0000",dash2Color:"#00ff00"})}),d.on("mouseout",()=>{d.setStyle({dashColor:"#0000ff",dash2Color:"#ffffff"})}),i.push(d)},remove(){const s=i.shift();s&&s.remove()}};o.add(r,"add"),o.add(r,"remove")},R7=(t,e)=>{const n=Math.random,i=[],o=e.addFolder("Polylines"),r={add(){const s=t.getCenter(),a=1+Math.ceil(n()*5),l=[];for(let d=0;d<a;d++)l.push([s[0]+(n()-.05)*.04,s[1]+(n()-.05)*.02]);const c=new mapgl._J.Polyline(t,{coordinates:l,color:"#0000ff",width:["interpolate",["linear"],["zoom"],8,4,14,12,16,36],width2:["interpolate",["linear"],["zoom"],8,6,14,20,16,40],showAnimation:{easing:"linear",duration:4e3,durationRange:{start:.05,end:.9}}});c.on("click",d=>{console.log(d,c)}),c.on("mouseover",()=>{c.setStyle({color:"#ff0000"})}),c.on("mouseout",()=>{c.setStyle({color:"#0000ff"})}),i.push(c)},remove(){const s=i.shift();s&&s.remove()}};o.add(r,"add"),o.add(r,"remove")},z7=(t,e)=>{let n,i;const o={async add(){s(),t.setStyle("e05ac437-fcc2-4845-ad74-b1de9ce07555"),t.setCenter([37.61959264695156,55.75832557338807]),n=new mapgl._J.Heatmap(t,{palette:{0:"rgba(0, 0, 0, 0)",.2:"rgba(172, 32, 135, 1)",.4:"rgba(255, 154, 0, 1)",.6:"rgba(255, 252, 0, 1)",.8:"rgba(255, 255, 0, 1)",1:"rgba(255, 255, 255, 1)"},zIndex:100,pointRadius:["interpolate",["linear"],["zoom"],9,5,16.5,7.5],minZoom:0,maxZoom:20,opacity:["interpolate",["linear"],["zoom"],15,1,16.5,0],intensity:["interpolate",["linear"],["zoom"],9,.2,16.5,1]}),i||(i=(await fetch("assets/moscow.json").then(l=>l.json())).features.map(l=>({coordinates:l.geometry.coordinates}))),n.setPoints(i)},remove:s},r=e.addFolder("Heatmap");r.add(o,"add"),r.add(o,"remove");function s(){n&&(t.setStyle($s),n.destroy(),n=void 0)}};let nl=[];const B7=(t,e)=>{const n={addMarkers:()=>f1(t),setContent(){nl.length||f1(t),nl.forEach((o,r)=>{const s=document.createElement("div");s.innerHTML=`
                    <div style="
                        box-sizing: border-box;
                        box-shadow: 1px 1px 2px rgba(0, 0, 0, .3);
                        background: lightgrey;
                        border-radius: 2px;
                        padding: 12px;
                        font-family: SuisseIntl, Helvetica, Arial, sans-serif;
                        font-size: 12px;
                        line-height: 1.2;
                        width: 180px;
                        height: 80px;
                        color: #5d5d5d;
                        user-select: none;
                        display: flex;
                        align-items: center;
                    ">
                        Маркер №:${r}
                    </div>
                `,o.setContent(s),o.getHtmlElement().addEventListener("click",a=>console.log("Only new click handler on HtmlMarker",{originalEvent:a,m:o}))})},remove:()=>P5()},i=e.addFolder("HtmlMarkers");i.add(n,"addMarkers"),i.add(n,"setContent"),i.add(n,"remove")};function P5(){nl.forEach(t=>t.destroy()),nl=[]}function f1(t){P5(),t.setZoom(11),t.setCenter([82.920412,55.030111]),nl=[Gd({description:"Некликабельный",coordinates:[82.921,55.082],interactive:!1}),Gd({description:"Выше всех, координаты не округляются",coordinates:[82.955,55.022],zIndex:2,disableRounding:!0}),Gd({coordinates:[82.887,54.913]})].map(o=>{const r=new mapgl._J.HtmlMarker(t,o);if(o.interactive){const s=r.getHtmlElement();s.addEventListener("click",l=>console.log("Click HtmlMarker ",{originalEvent:l,marker:r,markerOptions:o}));const a=s.querySelector("button");a&&a.addEventListener("click",l=>{l.stopPropagation(),console.log("Click Button",{originalEvent:l,marker:r,markerOptions:o})})}return r});const e=document.createElement("div");e.style.padding="20px",e.style.background="white",e.style.boxShadow="1px 1px 2px rgba(0, 0, 0, .3)",e.style.borderRadius="2px",e.style.height="100%",e.innerHTML=`<div style="word-wrap: break-word; font-size: 12px;">
        Этот DOM создан клиентом<br>
        карта не реагирует на взаимодействия<br>
        с ним (preventMapInteractions=true)<br>
        ширина задается контентом
    </div>`;const n=Gd({coordinates:[82.937,54.943],html:e,preventMapInteractions:!0}),i=new mapgl._J.HtmlMarker(t,n);nl.push(i),e.onclick=o=>console.log("Click HtmlMarker",{originalEvent:o,marker:i,markerOptions:n})}function Gd({description:t,coordinates:e,...n}){return{html:`
            <div style="
                box-sizing: border-box;
                box-shadow: 1px 1px 2px rgba(0, 0, 0, .3);
                background: white;
                border-radius: 2px;
                padding: 12px;
                margin-bottom: 4px;
                font-family: SuisseIntl, Helvetica, Arial, sans-serif;
                font-size: 12px;
                line-height: 1.2;
                width: 180px;
                height: 80px;
                color: #5d5d5d;
                user-select: none;
                display: flex;
                align-items: center;
            ">
                <div>
                    <div style="font-size: 14px; font-weight: bold;">${e.join(", ")}</div>
                    <div style="margin-bottom: 8px;">${t||"Description"}</div>
                    <button style="display: block;"><span>Button</span></button>
                </div>
            </div>
            <div style="margin-left: 80px; width: 10px; height: 10px; border-radius: 50%; background: white; border: 5px solid red;"></div>
        `,coordinates:e,offset:[-90,-94],zIndex:1,animate:!1,duration:200,interactive:!0,...n}}let kc=[];const O7=(t,e)=>{const n={pinMarker:()=>h1(t),showText(){kc.length||h1(t),kc.forEach(o=>{const r=document.createElement("div");r.innerHTML=`
                    <div class="wrapper">
                        <div class="marker">
                            <div class="substrate"><div class="substrateInner"></div></div>
                            <div class="inner"><div class="icon">
                                <svg width="20px" height="20px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="Слой_1" x="0px" y="0px" viewBox="0 0 400 400" style="enable-background:new 0 0 400 400;" xml:space="preserve">
                                    <path fill="#BC0F0F" d="M64.8,145.4H24.3c-5.1,0-9.3,4.2-9.3,9.3s4.2,9.3,9.3,9.3h3.1v74.8h-3.1c-5.1,0-9.3,4.2-9.3,9.3   c0,5.1,4.2,9.3,9.3,9.3h40.5c31,0,56.1-25,56.1-56.1S95.9,145.4,64.8,145.4z M91.2,227.9c-7,7-16.4,11-26.4,11H46.1v-74.8h18.7   c20.7,0,37.4,16.7,37.4,37.4C102.2,211.5,98.2,220.9,91.2,227.9z"/>
                                    <path fill="#BC0F0F" d="M376.3,241.6c3.6,3.6,3.6,9.6,0,13.2c-1.7,1.7-4.1,2.7-6.6,2.7h-34.3c-5.1,0-9.3-4.2-9.3-9.3   c0-5.1,4.2-9.3,9.3-9.3l0,0h12.5v-56.1l-23.7,46.7h-15l-23.7-46.7v56.1H298c5.1,0,9.3,4.2,9.3,9.3c0,5.1-4.2,9.3-9.3,9.3h-34.3   c-5.1,0-9.3-4.2-9.3-9.3c0-5.1,4.2-9.3,9.3-9.3l0,0h3.1v-74.8h-3.1c-5.1,0-9.3-4.2-9.3-9.3c0-5.1,4.2-9.3,9.3-9.3l0,0h23.8   l14.7,28.9l14.5,28.5l14.5-28.5l14.7-28.9h23.8c5.1,0,9.3,4.2,9.3,9.3s-4.2,9.3-9.3,9.3h-3.1v74.8h3.1   C372.1,238.9,374.5,239.9,376.3,241.6z"/>
                                    <path fill="#BC0F0F" d="M162.6,172.5c-0.1,6.9-1.7,13.6-4.5,19.8c-2.1,5-4.4,9.8-6.2,14.8c-2.4,5.7-3.6,11.7-3.6,17.8   c0,3.1,0.7,6.1,2.1,9c2.7,5,6.6,6.9,12.2,7.4c7.8,0.6,14.3-3.7,16.9-11.3c1.2-3.1,1.5-6.5,0.9-9.7c-0.1-0.7-0.4-1.5-0.7-2.1   c-1.1-2.1-3.6-3.1-5.9-2.2c-1,0.5-1.7,1.4-2,2.5c-0.4,1.4-0.4,2.9-0.1,4.4c0.2,1.6,0.4,3.4,0.2,5c-0.4,2.6-2,5-4.4,6.1   c-4.5,2.5-10.1,0.9-12.6-3.6c-0.5-1-0.9-2-1-3.1c-0.7-5.2-0.1-10.5,1.9-15.3c1.7-4.9,5.1-9,9.6-11.7c7.6-4.2,17.1-3.5,23.8,2   c5.1,4,8.5,9.8,9.5,16.3c2.1,14.1-2.6,25.5-13.5,34.6c-3.6,2.9-7.8,4.9-12.5,5.7c-12.8,2.7-24.2-0.2-33.6-9.5   c-5.4-5.2-8.6-12.3-9.1-19.8c-0.7-10.2,0.9-20.3,4.7-29.8c1.9-4.9,4.1-9.6,6.1-14.3c1.5-3.2,2.5-6.7,3-10.3   c0.5-5.6-0.7-11.2-3.5-16.2c-2-3.5-1.6-7.8,1-11c3.4-3.9,9.2-4.2,13.1-0.7c0.7,0.6,1.4,1.5,1.9,2.4c3.4,5.7,5.4,12.2,5.9,18.8   C162.3,169.5,162.4,171,162.6,172.5z"/>
                                    <path fill="#BC0F0F" d="M203.2,154.5c2.4-4.2,5.4-8.1,8.8-11.5c3.5-3.5,9.1-3.4,12.5,0.1c1.1,1.1,2,2.6,2.4,4.1c0.9,3,0,6.2-2.4,8.3   c-2.9,2.9-5.2,6.1-7,9.6c-0.9,1.6-1.4,3.2-1.7,5c-0.5,3.2,1.9,6.4,5.1,6.7c0.1,0,0.2,0,0.2,0c3.5,0.2,6.5-2.2,6.7-5.6   c0.1-0.7,0-1.6-0.2-2.4c-1.6-4.4,1.6-8.6,4.9-10c4.4-1.9,9.3,0,11.5,4.2c1.7,3.7,2.1,8.1,1,12.1c-2.4,10-10.6,17.3-20.8,18.7   c-8.7,1.1-15.8-2-21.2-8.8C194.3,173.1,200.4,159.4,203.2,154.5z"/>
                                    <path fill="#BC0F0F" d="M212.5,232.3c0.2-7.1,2-14.2,5.1-20.6c1.2-2.6,2.6-5.2,4.2-7.7c2.7-4.2,8.3-5.6,12.7-2.9s5.6,8.3,2.9,12.7   c0,0.1-0.1,0.1-0.1,0.2c-2.7,4.4-4.7,9.1-5.7,14.1c-0.4,2-0.5,4-0.4,6.1c0.2,2.7,1.6,5.4,3.9,7.1c3.9,3.4,4.2,9.2,0.9,13   c-3.2,3.7-8.8,4.2-12.7,1.1c-5.7-4.7-9.5-11.5-10.2-18.8C212.8,235.1,212.6,233.8,212.5,232.3z"/>
                                </svg>
                            </div>
                            <div class="text">Тут рекламный текст</div></div>
                        </div>
                    </div>
                    <style>
                        .wrapper {
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            width: 146px;
                        }
                        .marker {
                            position: relative;
                            width: 26px;
                            height: 26px;
                            border-radius: 2px;
                            transition: width 0.3s ease-in-out;
                            background: rgba(255, 255, 255, .8);
                        }
                        .active .marker {
                            width: 146px;
                        }
                        .substrate {
                            position: absolute;
                            border-radius: 2px;
                            width: 100%;
                            height: 100%;
                            z-index: 0;
                            opacity: .8;
                            box-shadow: 0 2px 4px rgba(0,0,0,.2);
                        }
                        .substrateInner {
                            position: absolute;
                            border-radius: 2px;
                            width: 100%;
                            height: 100%;
                            background: rgb(255, 255, 255);
                        }
                        .substrateInner:after {
                            position: absolute;
                            bottom: -3px;
                            left: 50%;
                            transform: translateX(-50%) rotate(45deg);
                            content: "";
                            display: block;
                            border: 4px solid transparent;
                            border-right-color: rgb(255, 255, 255);
                            border-bottom-color: rgb(255, 255, 255);
                            box-shadow: 2px 2px 1px rgba(0,0,0,.1);
                            width: 0;
                            height: 0;
                        }

                        .inner {
                            padding: 2px;
                            box-sizing: border-box;
                            position: relative;
                            display: flex;
                            align-items:center;
                            justify-content: space-between;
                            z-index: 2;
                            width: 100%;
                            height: 100%;
                            border-radius: 2px;

                        }
                        .icon{
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            transition: margin-left 0.3s ease-in-out;
                            margin-left: 0;
                        }
                        .active .icon {
                            margin-left: 4px;
                        }
                        .text {
                            box-sizing: border-box;
                            padding: 0 8px;
                            color: #3866ed;
                            font: 10px/10px Helvetica;
                            width: 0;
                            opacity: 0;
                            transition: width 0s ease-in-out 0.3s,
                                        opacity .3s ease-in-out .3s;
                            white-space: nowrap;
                        }
                        .active .text {
                            width: auto;
                            opacity: 1;
                        }

                    </style>
                        `,o.setContent(r),o.setLabelingSize(146,26),o.setOffset([-73,-43]),o.getHtmlElement().addEventListener("click",s=>console.log("Only new click handler on HtmlMarker",{originalEvent:s,m:o})),setTimeout(()=>{o.getHtmlElement().classList.add("active")},10)})},remove:()=>L5()},i=e.addFolder("HtmlMarkersPinnedToPoi");i.add(n,"pinMarker"),i.add(n,"showText"),i.add(n,"remove")};function h1(t){L5();const e={id:"141265769407200",coordinates:[82.89306498588856,54.9841537625896],zoom:19};t.setCenter(e.coordinates),t.setZoom(e.zoom),kc.push(new mapgl._J.HtmlMarker(t,{html:`
                <div class="marker">
                    <div class="substrate"><div class="substrateInner"></div></div>
                    <div class="inner">
                        <svg width="20px" height="20px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="Слой_1" x="0px" y="0px" viewBox="0 0 400 400" style="enable-background:new 0 0 400 400;" xml:space="preserve">
                            <path fill="#BC0F0F" d="M64.8,145.4H24.3c-5.1,0-9.3,4.2-9.3,9.3s4.2,9.3,9.3,9.3h3.1v74.8h-3.1c-5.1,0-9.3,4.2-9.3,9.3   c0,5.1,4.2,9.3,9.3,9.3h40.5c31,0,56.1-25,56.1-56.1S95.9,145.4,64.8,145.4z M91.2,227.9c-7,7-16.4,11-26.4,11H46.1v-74.8h18.7   c20.7,0,37.4,16.7,37.4,37.4C102.2,211.5,98.2,220.9,91.2,227.9z"/>
                            <path fill="#BC0F0F" d="M376.3,241.6c3.6,3.6,3.6,9.6,0,13.2c-1.7,1.7-4.1,2.7-6.6,2.7h-34.3c-5.1,0-9.3-4.2-9.3-9.3   c0-5.1,4.2-9.3,9.3-9.3l0,0h12.5v-56.1l-23.7,46.7h-15l-23.7-46.7v56.1H298c5.1,0,9.3,4.2,9.3,9.3c0,5.1-4.2,9.3-9.3,9.3h-34.3   c-5.1,0-9.3-4.2-9.3-9.3c0-5.1,4.2-9.3,9.3-9.3l0,0h3.1v-74.8h-3.1c-5.1,0-9.3-4.2-9.3-9.3c0-5.1,4.2-9.3,9.3-9.3l0,0h23.8   l14.7,28.9l14.5,28.5l14.5-28.5l14.7-28.9h23.8c5.1,0,9.3,4.2,9.3,9.3s-4.2,9.3-9.3,9.3h-3.1v74.8h3.1   C372.1,238.9,374.5,239.9,376.3,241.6z"/>
                            <path fill="#BC0F0F" d="M162.6,172.5c-0.1,6.9-1.7,13.6-4.5,19.8c-2.1,5-4.4,9.8-6.2,14.8c-2.4,5.7-3.6,11.7-3.6,17.8   c0,3.1,0.7,6.1,2.1,9c2.7,5,6.6,6.9,12.2,7.4c7.8,0.6,14.3-3.7,16.9-11.3c1.2-3.1,1.5-6.5,0.9-9.7c-0.1-0.7-0.4-1.5-0.7-2.1   c-1.1-2.1-3.6-3.1-5.9-2.2c-1,0.5-1.7,1.4-2,2.5c-0.4,1.4-0.4,2.9-0.1,4.4c0.2,1.6,0.4,3.4,0.2,5c-0.4,2.6-2,5-4.4,6.1   c-4.5,2.5-10.1,0.9-12.6-3.6c-0.5-1-0.9-2-1-3.1c-0.7-5.2-0.1-10.5,1.9-15.3c1.7-4.9,5.1-9,9.6-11.7c7.6-4.2,17.1-3.5,23.8,2   c5.1,4,8.5,9.8,9.5,16.3c2.1,14.1-2.6,25.5-13.5,34.6c-3.6,2.9-7.8,4.9-12.5,5.7c-12.8,2.7-24.2-0.2-33.6-9.5   c-5.4-5.2-8.6-12.3-9.1-19.8c-0.7-10.2,0.9-20.3,4.7-29.8c1.9-4.9,4.1-9.6,6.1-14.3c1.5-3.2,2.5-6.7,3-10.3   c0.5-5.6-0.7-11.2-3.5-16.2c-2-3.5-1.6-7.8,1-11c3.4-3.9,9.2-4.2,13.1-0.7c0.7,0.6,1.4,1.5,1.9,2.4c3.4,5.7,5.4,12.2,5.9,18.8   C162.3,169.5,162.4,171,162.6,172.5z"/>
                            <path fill="#BC0F0F" d="M203.2,154.5c2.4-4.2,5.4-8.1,8.8-11.5c3.5-3.5,9.1-3.4,12.5,0.1c1.1,1.1,2,2.6,2.4,4.1c0.9,3,0,6.2-2.4,8.3   c-2.9,2.9-5.2,6.1-7,9.6c-0.9,1.6-1.4,3.2-1.7,5c-0.5,3.2,1.9,6.4,5.1,6.7c0.1,0,0.2,0,0.2,0c3.5,0.2,6.5-2.2,6.7-5.6   c0.1-0.7,0-1.6-0.2-2.4c-1.6-4.4,1.6-8.6,4.9-10c4.4-1.9,9.3,0,11.5,4.2c1.7,3.7,2.1,8.1,1,12.1c-2.4,10-10.6,17.3-20.8,18.7   c-8.7,1.1-15.8-2-21.2-8.8C194.3,173.1,200.4,159.4,203.2,154.5z"/>
                            <path fill="#BC0F0F" d="M212.5,232.3c0.2-7.1,2-14.2,5.1-20.6c1.2-2.6,2.6-5.2,4.2-7.7c2.7-4.2,8.3-5.6,12.7-2.9s5.6,8.3,2.9,12.7   c0,0.1-0.1,0.1-0.1,0.2c-2.7,4.4-4.7,9.1-5.7,14.1c-0.4,2-0.5,4-0.4,6.1c0.2,2.7,1.6,5.4,3.9,7.1c3.9,3.4,4.2,9.2,0.9,13   c-3.2,3.7-8.8,4.2-12.7,1.1c-5.7-4.7-9.5-11.5-10.2-18.8C212.8,235.1,212.6,233.8,212.5,232.3z"/>
                        </svg>
                    </div>
                </div>
                <style>
                    .marker {
                        position: relative;
                        width: 26px;
                        height: 26px;
                        border-radius: 2px;
                    }
                    .substrate {
                        position: absolute;
                        border-radius: 2px;
                        width: 100%;
                        height: 100%;
                        z-index: 0;
                        opacity: .8;
                        box-shadow: 0 2px 4px rgba(0,0,0,.2);
                    }
                    .substrateInner {
                        position: absolute;
                        border-radius: 2px;
                        width: 100%;
                        height: 100%;
                        background: rgb(255, 255, 255);
                    }
                    .substrateInner:after {
                        position: absolute;
                        bottom: -3px;
                        left: 50%;
                        transform: translateX(-50%) rotate(45deg);
                        content: "";
                        display: block;
                        border: 4px solid transparent;
                        border-right-color: rgb(255, 255, 255);
                        border-bottom-color: rgb(255, 255, 255);
                        box-shadow: 2px 2px 1px rgba(0,0,0,.1);
                        width: 0;
                        height: 0;
                    }
                    .inner {
                        position: relative;
                        display: flex;
                        align-items:center;
                        justify-content: center;
                        z-index: 1;
                        width: 100%;
                        height: 100%;
                        padding: 2px;
                        box-sizing: border-box;
                        border-radius: 2px;
                    }
                </style>
            `,coordinates:e.coordinates,zIndex:0,labeling:{type:"pinnedToPoi",poiId:e.id,width:26,height:26},offset:[-13,-43],animate:!0,duration:200,interactive:!0}))}function L5(){kc.forEach(t=>t.destroy()),kc=[]}let Ze,f_;const D7=(t,e)=>{const n={add(){i(),Ze=new mapgl._J.Marker(t,{coordinates:t.getCenter(),icon:"assets/images/marker.png",hoverIcon:"assets/images/markerHover.png",anchor:[11,32],hoverAnchor:[11,32]}),Ze.on("click",o=>{console.log(o,Ze)})},changeIcon(){if(!Ze){alert("Вначале создай маркер, а потом меняй ему иконку");return}Ze.setIcon({icon:"assets/images/airport_30_30.png"})},changeHoverIcon(){if(!Ze){alert("Вначале создай маркер, а потом меняй ему иконку");return}Ze.setHoverIcon({icon:"assets/images/markerHoverReverted.png",anchor:[11,0]})},removeHoverIcon(){if(!Ze){alert("Вначале создай маркер, а потом меняй ему иконку");return}Ze.setHoverIcon()},addLabeled(){i(),Ze=new mapgl._J.Marker(t,{coordinates:t.getCenter(),icon:"assets/images/marker.png",hoverIcon:"assets/images/markerHover.png",anchor:[11,32],hoverAnchor:[11,32],label:{text:`The marker's label.
Second Line`,fontSize:16}}),Ze.on("click",o=>{console.log(o,Ze)})},addArabic(){i(),Ze=new mapgl._J.Marker(t,{coordinates:t.getCenter(),icon:"assets/images/marker.png",hoverIcon:"assets/images/markerHover.png",anchor:[11,32],hoverAnchor:[11,32],label:{text:`Привет
لا
раз الله أكبر два`,fontSize:16}}),Ze.on("click",o=>{console.log(o,Ze)})},addLabeledTooltip(){i(),Ze=new mapgl._J.Marker(t,{coordinates:t.getCenter(),icon:"assets/images/marker.png",hoverIcon:"assets/images/markerHover.png",anchor:[11,32],hoverAnchor:[11,32],label:{text:`The marker's label.
Second Line`,fontSize:16,anchor:[.5,0],offset:[0,20],image:{url:"assets/images/tooltip-top-symmetric.svg",size:[100,50],stretchX:[[10,40],[60,90]],stretchY:[[20,40]],padding:[20,10,10,10]}}}),Ze.on("click",o=>{console.log(o,Ze)})},changeLabel(){if(!Ze){alert("Вначале создай маркер, а потом меняй ему подпись");return}Ze.setLabel({text:`Я новая №${Math.round(Math.random()*100)} подпись маркера!`,fontSize:20,color:"#00ff00",haloColor:"#ff0000",haloRadius:1})},removeLabel(){if(!Ze){alert("Вначале создай маркер, а потом меняй ему подпись");return}Ze.setLabel()},addAndChangeLabel(){i(),Ze=new mapgl._J.Marker(t,{coordinates:t.getCenter(),label:{text:"With label",color:"#ff0000"}}),Ze.setLabel({text:"newnewnew",color:"#0000ff"})},addDraggable(){i(),Ze=new mapgl._J.Marker(t,{coordinates:t.getCenter(),icon:"assets/images/marker.png",hoverIcon:"assets/images/markerHover.png",anchor:[11,32],hoverAnchor:[11,32],draggable:!0}),Ze.on("click",o=>{console.log(o,Ze)})},addSpinner(){i(),Ze=new mapgl._J.Marker(t,{coordinates:t.getCenter(),icon:"assets/images/marker.png",hoverIcon:"assets/images/markerHover.png",anchor:[11,32],hoverAnchor:[11,32],draggable:!0});let o=0,r=0;const s=a=>{if(!Ze)return;const l=a-r;r=a,o+=l*.7,Ze.setRotation(o),f_=requestAnimationFrame(s)};f_=requestAnimationFrame(s)},remove:i};Object.keys(n).forEach(o=>e.add(n,o));function i(){Ze&&(cancelAnimationFrame(f_),Ze.destroy(),Ze=void 0)}},N7=(t,e)=>{let n;function i(){n=new mapgl._J.OnlineMarker(t,{coordinates:t.getCenter(),icon:{url:"assets/images/marker.png",anchor:[11,32],size:[22,34]},zIndex:0}),n.on("click",s=>{console.log(s,n)}),n.on("mouseover",()=>{n&&n.setIcon({url:"assets/images/markerHover.png",anchor:[11,32],size:[22,34]})}),n.on("mouseout",()=>{n&&n.setIcon({url:"assets/images/marker.png",anchor:[11,32],size:[22,34]})})}function o(){n&&n.setIcon({url:"assets/images/markerActive.png",anchor:[11,32],size:[22,34]})}function r(){n&&n.destroy()}e.add({add:i},"add"),e.add({changeIcon:o},"changeIcon"),e.add({remove:r},"remove")};let Po=[],ip=[];function Sf(){Po.forEach(t=>t.remove()),Po=[],ip.forEach(t=>t.remove()),ip=[]}const U7=(t,e)=>{const n=e.addFolder("PointLabel");G7(t,n),H7(t,n)},G7=(t,e)=>{const n=e.addFolder("Examples"),i={addLabels(){Sf();const o=t.getCenter();Po.push(new mapgl._J.PointLabel(t,{coordinates:o,text:"Негенерализуемый лейбл №1",color:["interpolate",["linear"],["zoom"],8,"#ff0000",14,"#00ff00",16,"#0000ff"],fontSize:24,font:"Open_Sans",haloRadius:1,zIndex:1,anchor:[.5,.5],offset:[0,0]})),Po.push(new mapgl._J.PointLabel(t,{coordinates:[o[0]-.1,o[1]+.05],text:"Негенерализуемый двухстрочный лейбл с подложкой",color:"#0000ff",fontSize:36,font:"Open_Sans",haloRadius:3,haloColor:["interpolate",["linear"],["zoom"],8,"#ff0000",14,"#00ff00",16,"#0000ff"],zIndex:1,image:{url:"assets/images/stretchable-image-debug.png",size:[500,250],stretchX:[[50,150],[250,450]],stretchY:[[50,150]],padding:[50,50,100,50]}})),Po.push(new mapgl._J.PointLabel(t,{coordinates:[o[0]+.1,o[1]-.05],text:"Tooltip top symmetric",color:"#0000ff",fontSize:36,font:"Open_Sans",haloRadius:1,zIndex:2,image:{url:"assets/images/tooltip-top-symmetric-debug.svg",size:[100,50],stretchX:[[10,40],[60,90]],stretchY:[[20,40]],padding:[20,10,10,10]}})),Po.push(new mapgl._J.PointLabel(t,{coordinates:[o[0]-.2,o[1]-.15],text:"Retina image",fontSize:24,font:"Open_Sans",zIndex:2,image:{url:"assets/images/stretchable-image-debug@2x.png",size:[500,250],stretchX:[[50,150],[250,450]],stretchY:[[50,150]],padding:[50,50,100,50]}}))},hide(){Po.forEach(o=>o.hide())},show(){Po.forEach(o=>o.show())},move(){Po.forEach((o,r)=>o.setCoordinates(o.getCoordinates().map(s=>s+(r%2===0?1:-1)*.01)))},remove:Sf};n.add(i,"addLabels"),n.add(i,"hide"),n.add(i,"show"),n.add(i,"move"),n.add(i,"remove")},H7=(t,e)=>{const n=e.addFolder("Position"),i={textLine1:"First text line",textLine2:"Second text line",textLine3:"Third text line",anchorX:.5,anchorY:0,offsetX:0,offsetY:25},o={addLabel:()=>r(t),remove:Sf};n.add(o,"addLabel"),n.add(o,"remove"),n.add(i,"textLine1",i.textLine1).onChange(()=>r(t)),n.add(i,"textLine2",i.textLine2).onChange(()=>r(t)),n.add(i,"textLine3",i.textLine3).onChange(()=>r(t)),n.add(i,"anchorX",0,1).onChange(()=>r(t)),n.add(i,"anchorY",0,1).onChange(()=>r(t)),n.add(i,"offsetX",-500,500).onChange(()=>r(t)),n.add(i,"offsetY",-500,500).onChange(()=>r(t));function r(s){Sf();const a=s.getCenter();ip.push(new mapgl._J.CircleMarker(s,{coordinates:a,zIndex:2,borderWidth:2,width:4,borderColor:"#ff0000",color:"#000000"})),Po.push(new mapgl._J.PointLabel(s,{coordinates:a,text:[i.textLine1,i.textLine2,i.textLine3].filter(l=>!!l).join(`
`),color:"#0000ff",fontSize:36,font:"Open_Sans",haloRadius:1,anchor:[i.anchorX,i.anchorY],offset:[i.offsetX,i.offsetY],image:{url:"assets/images/tooltip-top-symmetric-debug.svg",size:[100,50],stretchX:[[10,40],[60,90]],stretchY:[[20,40]],padding:[20,10,10,10]}}))}},V7=(t,e)=>{let n;const i={add(){r(),n=new mapgl._J.Rect(t,{center:t.getCenter(),color:"#000000aa",height:1e3,width:2e3,interactive:!0,maxZoom:20}),n.on("click",s=>console.log(s,n))},remove:r},o=e.addFolder("Rect");o.add(i,"add"),o.add(i,"remove");function r(){n&&(n.destroy(),n=void 0)}},j7={type:"FeatureCollection",features:[{id:"fid1",type:"Feature",properties:{demoCase:"polygon",height:5e4,name:"это мультиполигон"},geometry:{type:"MultiPolygon",coordinates:[[[[82.87056163819427,54.99147407819542],[82.87445659831033,54.970951765738526],[82.91364225765977,54.97386481188051],[82.91293408309322,54.99391167553448],[82.87056163819427,54.99147407819542]],[[82.8810662275982,54.98727564679343],[82.88401695495884,54.976709908780535],[82.9051441628611,54.97874199743784],[82.9005410281785,54.9889686155237],[82.8810662275982,54.98727564679343]]],[[[82.83651236047322,54.991092873966544],[82.83408939376993,54.96472529513654],[82.85333059994316,54.96764710792581],[82.85340186366973,54.9874584239116],[82.83651236047322,54.991092873966544]]]]}},{id:"fid2",type:"Feature",properties:{demoCase:"polygon"},geometry:{type:"Polygon",coordinates:[[[82.94231414794922,55.01837852360165],[82.95055389404297,55.01109509211588],[82.97595977783203,55.01227627898974],[82.9848861694336,55.022905395299844],[82.97183990478516,55.03549921776523],[82.94506072998047,55.0404176047949],[82.94231414794922,55.01837852360165]]]}},{id:"fid3",type:"Feature",properties:{demoCase:"line",labelLine:!0,title:"это мультиполилиния",name:"fid3"},geometry:{type:"MultiLineString",coordinates:[[[82.84223556518555,55.04287657188142],[82.825927734375,55.02782532823641],[82.82918930053711,55.016508579590386],[82.84687042236328,55.01257157027201],[82.85768508911133,55.013752713656565],[82.87622451782227,55.02113407160079],[82.88103103637695,55.03520409534168]],[[82.85236358642578,55.040122518600725],[82.84017562866211,55.02753014929055],[82.85133361816406,55.02054361297408],[82.85579681396483,55.02575902996018],[82.86884307861328,55.03963070344663]]]}},{id:"fid4",type:"Feature",properties:{demoCase:"dashedLine",labelLine:!0,name:"fid4"},geometry:{type:"LineString",coordinates:[[82.92205810546875,55.04140120974331],[82.94197082519531,55.05044924210548],[82.97973632812499,55.051235930928875],[82.9965591430664,55.039433975694365],[82.99999237060547,55.02113407160079],[82.99930572509766,55.008535734532586],[82.98694610595703,55.002628901338866],[82.9629135131836,54.99770587584443],[82.92686462402344,54.995145663837185]]}},{id:"fid5",type:"Feature",properties:{demoCase:"point5",size:10,secondLabel1:"это первая подпись",secondLabel_2:"это вторая подпись",customLabel:"точка 5"},geometry:{type:"Point",coordinates:[82.90660858154297,55.060674991347625]}},{id:"fid6",type:"Feature",properties:{demoCase:"point",placement:"topCenter",customLabel:"точка 6",name:"это точка",size:10},geometry:{type:"Point",coordinates:[82.89390563964844,55.03845032244144]}},{id:"fid7",type:"Feature",properties:{demoCase:"point",customLabel:"мультиточка 7",name:"это мультиточка",size:10,placement:"rightCenter"},geometry:{type:"MultiPoint",coordinates:[[82.84223556518555,55.04287657188142],[82.825927734375,55.02782532823641],[82.82918930053711,55.016508579590386]]}},{id:"fid8",type:"Feature",properties:{demoCase:"point8",customLabel:"точка 8",size:30,placement:"rightCenter"},geometry:{type:"Point",coordinates:[82.91991233825682,55.00927402752062]}}]},_1=[[82.79956238806248,55.08045349512293],[82.79750245708543,54.970247042536045],[83.06392090700986,54.96118089857186],[83.07147401484018,55.080846546695035]],$7=(t,e)=>{const n={addPointWithElevation:()=>ln({map:t,layer:{type:"point",id:"demoCase-point-with-elevation",filter:["match",["sourceAttr","demoCase"],["point-with-elevation"],!0,!1],style:{iconPriority:1e3,allowElevation:!0,elevation:["get","elevation"],iconLabelingGroup:"__overlapped",iconImage:"peak",iconWidth:32,iconTextField:"Text inside icon",iconTextFont:"Noto_Sans",iconTextColor:"#ffffff",textFont:"Open_Sans",textField:["get","customLabel"],textColor:"#ff0000",textFontSize:["interpolate",["linear"],["zoom"],6,9.5,14,24],textPlacement:"bottomCenter",textOffset:-5.15,textHaloColor:"hsla(0, 0%, 100%, 0.5)",textHaloWidth:1}},data:{type:"FeatureCollection",features:[{type:"Feature",properties:{demoCase:"point-with-elevation",elevation:150,customLabel:"Custom Label"},geometry:{type:"Point",coordinates:[82.89908737535221,54.978151907217104]}},{type:"Feature",properties:{demoCase:"point-with-elevation",elevation:15},geometry:{type:"Point",coordinates:[33.080775,68.963391]}}]},attrs:{demoCase:"point-with-elevation"}}),addPolygon:()=>ln({map:t,layer:{type:"polygon",id:"demoCase-polygon",filter:["match",["sourceAttr","demoCase"],["polygon"],!0,!1],style:{strokeColor:"#ff0000",strokeWidth:2,color:["interpolate",["linear"],["zoom"],9,"#0000ff40",12,"#0000ff30",14,"#0000ff20",16,"#0000ff10"]}},attrs:{demoCase:"polygon"}}),addPolygonInLayers:()=>ln({map:t,layer:{type:"polygon",id:"demoCase-polygonInsert",filter:["match",["sourceAttr","demoCase"],["polygonInsert"],!0,!1],style:{color:"RGBA(255,0,0,0.2)",strokeColor:"#ff0000",strokeWidth:2}},beforeId:"parking area",attrs:{demoCase:"polygonInsert"}}),addLine:()=>ln({map:t,layer:{type:"line",id:"demoCase-line",filter:["match",["sourceAttr","demoCase"],["line"],!0,!1],style:{color:"#9e02e0",width:5}},attrs:{demoCase:"line"}}),addDashedLine:()=>ln({map:t,layer:{type:"dashedLine",id:"demoCase-dashedLine",filter:["match",["sourceAttr","demoCase"],["dashedLine"],!0,!1],style:{color:"#ff0000",width:3,dashLength:10,gapLength:10}},attrs:{demoCase:"dashedLine"}}),addLineExtrusion:()=>ln({map:t,layer:{type:"lineExtrusion",id:"demoCase-lineExtrustion",filter:["match",["sourceAttr","demoCase"],["lineExtrusion"],!0,!1],style:{sideColor:"#9e02e0",height:["sourceAttr","height"]}},attrs:{demoCase:"lineExtrusion"}}),addOneWayLine:()=>ln({map:t,layer:{type:"oneWayLine",id:"demoCase-oneWayLine",filter:["match",["sourceAttr","demoCase"],["oneWayLine"],!0,!1],style:{color:"#ff0000",lineLength:20,lineWidth:4,duplicationSpacing:70,tipHeight:2,tipWidth:1.4,endingOffsets:20}},attrs:{demoCase:"oneWayLine"}}),addPointWithText:()=>ln({map:t,layer:{type:"point",id:"demoCase-point",filter:["match",["sourceAttr","demoCase"],["point"],!0,!1],style:{iconLabelingGroup:"__overlapped",iconImage:"peak",iconWidth:16,textFont:"Open_Sans",textField:["get","customLabel"],textColor:"#ff0000",textFontSize:["interpolate",["linear"],["zoom"],6,9.5,14,24],textPlacement:"bottomCenter",textOffset:-5.15,textHaloColor:"hsla(0, 0%, 100%, 0.5)",textHaloWidth:1}},attrs:{demoCase:"point"}}),addPointWithoutIcon:()=>ln({map:t,layer:{type:"point",id:"demoCase-pointNoIcon",filter:["match",["sourceAttr","demoCase"],["pointNoIcon"],!0,!1],style:{textLabelingGroup:"__overlapped",textFont:"Open_Sans",textField:["get","customLabel"],textColor:"#ff0000",textFontSize:["interpolate",["linear"],["zoom"],6,9.5,14,24],textPlacement:"bottomCenter",textOffset:-5.15,textHaloColor:"hsla(0, 0%, 100%, 0.5)",textHaloWidth:1}},attrs:{demoCase:"pointNoIcon"}}),addPointWithSizeFromData:()=>ln({map:t,layer:{type:"point",id:"demoCase-pointWithSizeFromData",filter:["match",["sourceAttr","demoCase"],["pointWithSizeFromData"],!0,!1],style:{iconImage:"peak",textFont:"Open_Sans",textField:["get","customLabel"],textFontSize:["get","size"],textPlacement:["get","placement"],allowOverlap:!0}},attrs:{demoCase:"pointWithSizeFromData"}}),addLabelLine:()=>ln({map:t,layer:{type:"labelLine",id:"demoCase-labelLine",filter:["match",["sourceAttr","demoCase"],["labelLine"],!0,!1],style:{textField:["get","name"],textFont:"Open_Sans",textDuplicationSpacing:50,textHaloWidth:2,textColor:"#ff0000",textHaloColor:"#ffffff"}},attrs:{demoCase:"labelLine"}}),addComplexCase:()=>ln({map:t,attrs:{demoCase:"complex"},layer:{type:"polygon",id:"demoCase-complex",filter:["match",["sourceAttr","demoCase"],["complex"],!0,!1],style:{strokeColor:"#ff0000",strokeWidth:2,color:["interpolate",["linear"],["zoom"],9,"#0000ff40",12,"#0000ff30",14,"#0000ff20",16,"#0000ff10"]}}}),addDataDrivenStyling:()=>ln({map:t,layer:[{type:"line",id:"demo-lines",filter:["match",["get","dataDriven"],["lines"],!0,!1],style:{color:["get","colorProp"],width:["match",["get","name"],["line1"],30,15]}},{type:"labelLine",id:"demo-lines-labels",filter:["match",["get","dataDriven"],["lines"],!0,!1],style:{textField:["get","name"],textHaloColor:"#ffffff70",textHaloWidth:1}}],data:{type:"FeatureCollection",features:[{type:"Feature",properties:{dataDriven:"lines",name:"line1",colorProp:[0,255,0,255]},geometry:{type:"LineString",coordinates:[[82.62130737304686,55.0217245215306],[83.06625366210936,54.904250955616085]]}},{type:"Feature",properties:{dataDriven:"lines",name:"line2",colorProp:[255,0,0,255]},geometry:{type:"LineString",coordinates:[[82.69546508789062,55.12315257361454],[83.10745239257812,55.00755132274014]]}}]}}),addAdminBoundaries:async()=>{console.log("Loading big GeoJSON data from server...");const s=await fetch("./assets/excludeArea.geojson").then(a=>a.json());console.log("Loaded."),ln({map:t,layer:{type:"polygon",id:"demoCase-admin-boundaries",filter:["match",["sourceAttr","rev"],[1],!0,!1],style:{strokeColor:"#ff0000",strokeWidth:2,color:["interpolate",["linear"],["zoom"],9,"#0000ff40",12,"#0000ff30",14,"#0000ff20",16,"#0000ff10"]}},data:s})},addSimplefication:async()=>{console.log("Loading big GeoJSON data from server...");const s=await fetch("https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_admin_0_countries.geojson").then(a=>a.json());console.log("Loaded."),ln({map:t,layer:{type:"polygon",id:"demoCase-admin-boundaries",filter:["match",["get","featurecla"],["Admin-0 country"],!0,!1],style:{strokeColor:"#ff0000",strokeWidth:2,color:["interpolate",["linear"],["zoom"],9,"#0000ff40",12,"#0000ff30",14,"#0000ff20",16,"#0000ff10"]}},options:{data:s,tolerance:9}})},"вытянутый полигон"(){Ju(t),t.setCenter([82.92157359932291,55.02763381919914]),t.setZoom(17),ln({map:t,data:{type:"Feature",properties:{db_height:3e4},geometry:{type:"Polygon",coordinates:[[[82.92043087350788,55.02764917050232],[82.92107365742427,55.027976663841855],[82.92157359932291,55.02763381919914],[82.92043087350788,55.02764917050232]]]}},attrs:{type:"my"},layer:{id:"my",type:"polygonExtrusion",filter:["==",["sourceAttr","type"],"my"],style:{topColor:"#0000ffaa",sideColor:"#ff0000aa",strokeColor:"#00ff00"}}})},setData(){const s={type:"FeatureCollection",features:[{type:"Feature",properties:{},geometry:{type:"LineString",coordinates:[[83.07147401484018,55.080846546695035]]}}]},a=ln({map:t,data:s,attrs:{bar:"asd"},layer:{type:"line",id:"geojson-line-setData",filter:["match",["sourceAttr","bar"],["asd"],!0,!1],style:{color:"#9e02e0",width:5}}});let l=0;const c=setInterval(()=>{if(l===_1.length){clearInterval(c);return}s.features[0].geometry.coordinates.push(_1[l++]),a==null||a.setData(s)},1e3)},remove:()=>Ju(t)},i=e.addFolder("GeoJson Source");Object.keys(n).forEach(s=>i.add(n,s));const o={addHeatmap:async()=>{const s=await fetch("assets/moscow.json").then(l=>l.json());ln({map:t,layer:{id:"demo",filter:["match",["sourceAttr","bar"],["asd"],!0,!1],type:"heatmap",style:{weight:["get","weight"],radius:["interpolate",["linear"],["zoom"],9,5,16.5,7.5],opacity:["interpolate",["linear"],["zoom"],15,1,16.5,0],intensity:["interpolate",["linear"],["zoom"],9,.2,16.5,1],color:["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 0, 0)",.2,"rgba(172, 32, 135, 1)",.4,"rgba(255, 154, 0, 1)",.6,"rgba(255, 252, 0, 1)",.8,"rgba(255, 255, 0, 1)",1,"rgba(255, 255, 255, 1)"]}},data:s,attrs:{bar:"asd"}}),t.setCenter([37.61959264695156,55.75832557338807])},removeHeatmap:()=>{Ju(t)}},r=e.addFolder("Heatmap GeoJson Source");Object.keys(o).forEach(s=>r.add(o,s))},op=[];function ln({map:t,styleId:e,layer:n,beforeId:i,data:o,attrs:r,options:s}){return Ju(t),e&&t.setStyle(e),Array.isArray(n)||(n=[n]),n.forEach(a=>{op.push(a.id),t.addLayer(a,i)}),new mapgl._J.GeoJsonSource(t,{data:o||j7,...s,attributes:{...r,rev:1}})}function Ju(t){try{for(;op.length>0;){const e=op.pop();typeof e=="string"&&t.removeLayer(e)}}catch{}}let bc;const W7=(t,e)=>{const n={addBaseDemo:()=>m1(t),addNonInteractiveDemo:()=>m1(t,{preventInteractions:!0}),remove:()=>F5(t)},i=e.addFolder("GeoJsonTile Source");Object.keys(n).forEach(o=>i.add(n,o)),t.on("click",async o=>{o.targetData&&"getFeatureProperties"in o.targetData&&console.log("geoJsonTileSource Feature props:",await o.targetData.getFeatureProperties())})};function m1(t,e={}){bc&&F5(t),t.setStyleZoom(9.5),t.setCenter([39.63181,43.82219]),bc=new mapgl._J.GeoJsonTileSource(t,{url:`${window.location.protocol}//${window.location.host}/assets/tiles/geojson/{z}/{x}/{y}.json`,maxZoom:10,attributes:{type:"hillshade-tiled"},...e}),t.addLayer({id:"point-tiled",type:"point",filter:["match",["sourceAttr","type"],["hillshade-tiled"],!0,!1],maxzoom:12,style:{allowOverlap:!0,textFont:"Noto_Sans",textField:"Текст",textFontSize:16,textColor:"#000000"}}),t.addLayer({id:"line-tiled",type:"line",filter:["match",["sourceAttr","type"],["hillshade-tiled"],!0,!1],maxzoom:13,style:{color:"rgba(0, 0, 0, 1)",width:10}}),t.addLayer({id:"polygon-tiled",type:"polygon",filter:["match",["sourceAttr","type"],["hillshade-tiled"],!0,!1],maxzoom:13,style:{color:"rgba(0, 0, 0, 0.5)",strokeColor:"rgba(0, 0, 0, 5)",strokeWidth:3}})}function F5(t){bc&&(bc.destroy(),bc=void 0,t.removeLayer("point-tiled"),t.removeLayer("line-tiled"),t.removeLayer("polygon-tiled"))}let Hd;const k5="raster-id",R5="rasterTiles",V0=["https://tile.openstreetmap.org/${zoom}/${x}/${y}.png","//tileserver-api.web-staging.2gis.ru/tiles?x=${x}&y=${y}&z=${zoom}&ts=realty_resident_sale","//tileserver-api.web-staging.2gis.ru/tiles?x=${x}&y=${y}&z=${zoom}&ts=realty_resident_rent"],kn={enable:!1,minStyleZoom:6,maxStyleZoom:15,minSourceZoom:6,maxSourceZoom:13,opacity:.8,tilesUrlSelect:V0[0],tilesUrlTpl:""},Z7=(t,e)=>{const n=e.addFolder("Raster Source");n.add(kn,"enable").onChange(()=>Er(t)),n.add(kn,"tilesUrlSelect",V0).onChange(()=>Er(t)),n.add(kn,"tilesUrlTpl").onChange(()=>Er(t)),n.add(kn,"opacity",0,1,.1).onChange(()=>Er(t)),n.add(kn,"minStyleZoom").onChange(()=>Er(t)),n.add(kn,"maxStyleZoom").onChange(()=>Er(t)),n.add(kn,"minSourceZoom").onChange(()=>Er(t)),n.add(kn,"maxSourceZoom").onChange(()=>Er(t))};function X7(){return{type:"raster",id:k5,minzoom:kn.minStyleZoom,maxzoom:kn.maxStyleZoom,filter:["match",["sourceAttr","type"],[R5],!0,!1],style:{opacity:kn.opacity}}}function Y7(t,e){const n=Object.keys(e),i=Object.values(e);return new Function(...n,`return \`${t}\`;`)(...i)}function Er(t){if(Hd){Hd.destroy(),Hd=void 0;try{t.removeLayer(k5)}catch(e){console.log(e)}}kn.enable&&(t.addLayer(X7()),Hd=new mapgl._J.RasterTileSource(t,{url:(e,n,i)=>Y7(kn.tilesUrlTpl||kn.tilesUrlSelect||V0[0],{x:e,y:n,zoom:i}),minZoom:kn.minSourceZoom,maxZoom:kn.maxSourceZoom,attributes:{type:R5}}))}function q7(t,e){$7(t,e),W7(t,e),Z7(t,e)}function K7(t,e){const n=e.addFolder("Test");let i;const o={addMarker(){this.removeMarker(),i=new mapgl._J.Marker(t,{coordinates:t.getCenter()})},removeMarker(){i&&(i.destroy(),i=void 0)}};Object.keys(o).forEach(r=>n.add(o,r))}function p1(t,e,n){const i=(c,d,u)=>{const f=v=>v*Math.PI/180,h=v=>v*180/Math.PI,_=f(c[0]),p=f(c[1]),m=f(u),g=6371e3,y=Math.asin(Math.sin(p)*Math.cos(d/g)+Math.cos(p)*Math.sin(d/g)*Math.cos(m)),b=_+Math.atan2(Math.sin(m)*Math.sin(d/g)*Math.cos(p),Math.cos(d/g)-Math.sin(p)*Math.sin(y));return[h(b),h(y)]},o=(c,d,u,f,h)=>{const _=i(i(c,u,180),d,90),p=i(_,f,90),m=i(p,h,180),g=i(_,h,180),y=1.5,b=i(i(_,y,180),y,90),v=i(b,f-y*2,90),T=i(v,h-y*2,180),x=i(b,h-y*2,180);return[[[[..._,0],[...p,0],[...m,0],[...g,0],[..._,0]]],[[[...b,e],[...v,e],[...T,e],[...x,e],[...b,e]]],[[[..._,0],[...p,0],[...v,e],[...b,e],[..._,0]]],[[[...p,0],[...m,0],[...T,e],[...v,e],[...p,0]]],[[[...m,0],[...g,0],[...x,e],[...T,e],[...m,0]]],[[[...g,0],[..._,0],[...b,e],[...x,e],[...g,0]]]]},r=t.getCenter(),s=Date.now(),a=[[-200,0,100,100,!0,void 0],[0,0,100,100,!1,!0],[200,0,100,100,!1,!1]],l={type:"FeatureCollection",features:a.map(([c,d,u,f],h)=>({type:"Feature",properties:{id:`multipolygon-${s}-${h}`},geometry:{type:"MultiPolygon",coordinates:o(r,c,d,u,f)}}))};return new mapgl._J.GeoJsonSource(t,{data:l,dimensions:3}),a.forEach((c,d)=>{const[,,,,u,f]=c,h={id:`layer-${s}-${d}`,type:n,filter:["match",["get","id"],[`multipolygon-${s}-${d}`],!0,!1],interactive:u,interactiveOcclusion:f,style:{color:"#4682b4",strokeWidth:3,strokeColor:"#FF0000"}};t.addLayer(h)}),"OK"}function J7(t,e){const n=e.addFolder("Interactive Options"),i={addBoxes_polygon3d(){p1(t,200,"polygon3d")},addBoxes_embankment(){p1(t,200,"embankment")},addTrees(){for(const o of[[-200,!0,void 0],[0,!1,!0],[200,!1,!1]])new mapgl._J.GltfModel(t,{coordinates:t.getCenter(),modelSrc:"https://disk.2gis.com/styles/assets/models/pine_d-060ceb840fb075c6c125e04e824fbdeba1fa7a820bb6118d74b6a56bd6b755b1.glb",scale:20,disableAnimation:!0,interactive:o[1],interactiveOcclusion:o[2],offset:[o[0],0,0],rotation:[0,0,0],hover:{color:"#FF0000"}})}};Object.keys(i).forEach(o=>n.add(i,o))}function Q7(t,e){const n=e.addFolder("Jakarta cases"),i=n.addFolder("Dynamic objects"),o=n.addFolder("Sources & Layers");K7(t,n),z7(t,i),B7(t,i),O7(t,i),q7(t,o),V7(t,i),U7(t,i),k7(t,i),R7(t,i),D7(t,i.addFolder("Markers")),N7(t,i.addFolder("OnlineMarkers")),J7(t,n)}let pl=class{constructor(){this.events={}}on(e,n){let i=this.events[e];return i||(i=this.events[e]=[]),i.push(n),this}once(e,n){const i=o=>{this.off(e,i),n.call(this,o)};return this.on(e,i),this}off(e,n){const i=this.events[e];if(!i)return this;const o=i.indexOf(n);return o!==-1&&i.splice(o,1),this}emit(e,n){const i=this.events[e];if(!i)return this;const o=i.slice();for(let r=0;r<o.length;r++)o[r].call(this,n);return this}};class Kc extends pl{constructor(e,n,i){super(),this.interactive=n.interactive??!0,this.uniqId=String(mo()),this.parentObject=i,this.modules=e.modules,this.mapState=e.state,this.tileObjects=[],this.identifyIds=[]}update(){this.mapState.needReplicasUpdate&&this.tileObjects.forEach(e=>{e.needSync=!0})}destroy(){const e=this.modules;this.tileObjects.forEach(n=>{n.clean(this.mapState),e.tileManager.removeObject(n)}),this.tileObjects=[],e.layers.removeLayer(this),e.renderer.addRerenderEvent()}getIdentifyData(){return this.identifyIds.map(e=>({dynamicObjectId:this.uniqId,metatileHash:-1,ids:e}))}isInteractive(){return this.interactive}}function eE(t,e,n){return{key:e,labelsKey:`${t.labelsKey}_${e}`,useful:!0,ready:!1,needGenerate:!1,tile:t,status:0,params:n.clone()}}function z5(t,e,n){t.generatedData=e,n&&t.params.setTileIds(n)}function B5(t){const e=t.generatedData,n=[];if(!e)return n;for(let i=0;i<e.length;i++){const o=e[i];o.collectorOutput.labels&&n.push({metatileHash:o.metatileHash,labels:o.collectorOutput.labels,styleId:o.styleId})}return n}function rp(t,e){t.status=0,t.generatedData=void 0,t.objects!==void 0&&t.objects.forEach(n=>n.clean(e)),t.objects=void 0,t.ready=!1,t.tile.currentMod===t&&(t.tile.currentMod=void 0)}function g1(t){return t.status===0}function v1(t,e,n,i,o){switch(t.status){case 0:t.useful&&(t.status=1);break;case 1:t.useful?t.tile.serverMetadata&&(t.status=2):t.status=0;break;case 2:tE(t,n,i)&&(t.status=3,t.needGenerate=!0);break;case 3:t.generatedData&&(t.status=4,t.ready=!0,t.objects=t.generatedData.map(r=>{const{collectorOutput:{data:s}}=r;return new bi(t.tile.type,s,i,n,t.tile.coords,void 0,o,t.tile.sourceId)}),e.add(t.key,t));break}}function tE(t,e,n){switch(t.tile.type){case"zenith":return!!(t.useful&&t.tile.serverMetadata&&nE(t.tile.serverMetadata,e,n));case"traffic":return!!(t.useful&&t.tile.serverMetadata);case"raster":case"geojson":case"globe":case"dem":return!!t.useful;default:return!1}}function nE(t,e,n){const{assetManager:i,modelLayer:o}=n;for(let r=0;r<t.length;r++){const{regionId:s,metatileHash:a}=t[r];if(!i.getMetatile(a)||e.styleZoom>o3&&!o.isModelsInfoLoaded(s))return!1}return!0}class Rc{constructor(e,n,i,o,r){this.selectedIds=e.slice(),this.styleState={...n},this.tileRevision=i,this.styleRevision=r,this.styleId=o}static equal(e,n){return e.tileRevision===n.tileRevision&&e.styleId===n.styleId&&e.styleRevision===n.styleRevision&&Wr(e.getSelectedIds(),n.getSelectedIds())&&Wr(e.styleState,n.styleState)}clone(){return new Rc(this.selectedIds,this.styleState,this.tileRevision,this.styleId,this.styleRevision)}stringify(){const e=this.selectedIds.join("|");return`sId=${this.styleId}_sRev=${this.styleRevision}_tRev=${this.tileRevision}_sel=${e}_sSt=${JSON.stringify(this.styleState)}`}getSelectedIds(){return this.tileIds?this.selectedIds.filter(e=>{var n;return(n=this.tileIds)==null?void 0:n.has(e)}):this.selectedIds.slice()}setTileIds(e){this.tileIds=e}}var j0=(t=>(t[t.Initial=0]="Initial",t[t.Loading=1]="Loading",t[t.Loaded=2]="Loaded",t))(j0||{});function iE(t,e,n,i){return{type:t,sourceId:n,key:Ge(e),labelsKey:`${t}_${n}_${i}`,coords:e,zoomLevel:e[2],detailLevel:e[3],needFetch:!1,revision:0,needAbortFetch:!1,needGenerate:!1,status:0,oldHoverTileObjects:[]}}function O5(t,e,n,i,o,r){const s=[];if(n.oldHoverTileObjects.forEach(a=>{a.tickerFinished(e)?(t.tileManager.removeObject(a),a.clean(e)):s.push(a)}),n.oldHoverTileObjects=s,o===void 0){sp(t,n,e);return}e.performanceCaveatEmitted||(r||!n.hover||n.hover.id===o)&&rE(t,e,n,o,i)}function oE(t,e){const n=Math.min(Math.floor(t.styleZoom),qe.maxDetailLevel),i=e.coords[3];return n===i}function rE(t,e,n,i,o){if(!n.idSet||!n.idSet.has(i)||!oE(e,n)){sp(t,n,e);return}const r=t.identifier.getIdScope(Yo);r.isHidden(i,Qn.PolygonExtrusion)||sE(t,n,i,o).then(s=>{sp(t,n,e);const a={id:i,tileObjects:[],generatedData:[]},l=[];s.results.forEach(c=>{const d=new bi("hover",c.collectorOutput.data,t,e,n.coords,void 0,r),{packedRasters:u,rastersToLoad:f}=c.collectorOutput;u!==void 0&&t.assetManager.prepareRasters(c.styleId,u),t.assetManager.loadRasters(f),a.tileObjects.push(d),t.tileManager.addObject(d),d.startTicker(e,_f.inAnimationType,_f.inAnimationTime,0,1),c.collectorOutput.labels.length&&l.push({metatileHash:c.metatileHash,labels:c.collectorOutput.labels,styleId:c.styleId})}),a.generatedData=s.results,t.labeler.addLabels("label_hover",Yc.Tile,l),t.identifier.debouncedFillCache(),n.hover=a})}function sp(t,e,n){e.hover&&(e.hover.tileObjects.forEach(i=>{e.oldHoverTileObjects.push(i),i.startTicker(n,_f.outAnimationType,_f.outAnimationTime,1,0)}),e.hover=void 0,t.labeler.removeLabels("label_hover"),t.identifier.debouncedFillCache())}function sE(t,e,n,i){const o=e.newMod||e.currentMod,r=(o==null?void 0:o.params.getSelectedIds())||[],s=t.map.state;return t.defaultSource.generateHoverTile(s,e.coords,s.handyStyleId,r,self.devicePixelRatio,{},n,i)}function D5(t){if(t.newMod&&t.newMod.needGenerate)return t.newMod.needGenerate=!1,t.newMod}function aE(t){return(!t.currentMod||g1(t.currentMod))&&(!t.newMod||g1(t.newMod))}function lE(t,e){t.currentMod&&rp(t.currentMod,e),t.newMod&&rp(t.newMod,e)}function cE(t){t.currentMod=void 0}function _h(t){if(t.currentMod&&t.currentMod.useful)return t.currentMod;if(t.newMod&&t.newMod.useful)return t.newMod}function dE(t){t.currentMod&&(t.currentMod.useful=!1),t.newMod&&(t.newMod.useful=!1)}function uE(t,e,n){if(t.idSet&&e.setTileIds(t.idSet),!t.currentMod&&!t.newMod){h_(t,e,n);return}if(t.currentMod&&Rc.equal(t.currentMod.params,e)){t.currentMod.useful=!0,t.newMod=void 0;return}if(t.newMod){Rc.equal(t.newMod.params,e)?t.newMod.useful=!0:h_(t,e,n);return}h_(t,e,n)}function h_(t,e,n){const i=A6(t.coords,e),o=n.get(i);o?(t.newMod=o,t.newMod.useful=!0):(t.newMod=eE(t,i,e),t.idSet&&t.newMod.params.setTileIds(t.idSet))}function fE(t,e,n,i,o){switch(t.status){case 0:t.newMod&&t.newMod.useful&&(t.status=1,t.needFetch=!0);break;case 1:t.newMod&&t.newMod.useful?t.serverMetadata&&(t.status=2):(t.status=0,t.needAbortFetch=!0);break}t.currentMod&&v1(t.currentMod,e,n,i,o),t.newMod&&(v1(t.newMod,e,n,i,o),t.newMod.needGenerate&&(t.needGenerate=!0))}function hE(t){t.newMod&&t.newMod.ready&&(t.currentMod=t.newMod,t.newMod=void 0)}function _E(t){const e=new Set;return t.forEach(n=>{const{idBuffer:i,orphanIds:o}=n.collectorOutput.identifyIds;for(const r of i)e.add(r);for(const r of o)e.add(r)}),e}function mE(t){t.status===1&&(t.needAbortFetch=!0),t.status=0,t.serverMetadata=void 0,t.revision++}function pE(t){t.revision++}const gE=()=>{};class N5{constructor(e,n=gE){this.queue=[],this.data={},this.size=e,this.onRemove=n}add(e,n){this.data[e]||(this.queue.push(e),this.data[e]=n,this.shrink(this.size))}remove(e){this.data[e]&&(this.queue.splice(this.queue.indexOf(e),1),delete this.data[e])}get(e){const n=this.data[e];return n&&(this.queue.splice(this.queue.indexOf(e),1),this.queue.push(e)),n}reset(){this.shrink(0)}setSize(e){this.size=e,this.shrink(e)}getSize(){return this.size}keys(){return this.queue}getData(){return Object.keys(this.data).map(e=>this.data[e])}shrink(e){for(;this.queue.length>e;){const n=this.queue.shift(),i=this.data[n];delete this.data[n],this.onRemove(n,i)}}}function gl(t){const e=t.viewportTiles;for(const n in t.tiles)dE(t.tiles[n]);for(let n=0;n<e.length;n++){const i=e[n];let o=t.tiles[i];o||(o=t.tiles[i]=iE(t.type,E3(i),t.sourceId,t.tileLayerId));const r=new Rc(t.selectedIds,t.styleState,o.revision,t.styleId,t.styleRevision);uE(o,r,t.tileModsCache)}}function $0(t,e){for(let n=0;n<e.length;n++){const i=t[e[n]],o=_h(i);if(!o||!o.ready)return!1}return!0}function U5(t){const e=[];for(const n in t.tiles){const i=t.tiles[n];i.needFetch&&(i.needFetch=!1,e.push(i))}return e}function G5(t){const e=[];for(const n in t.tiles){const i=t.tiles[n];i.needAbortFetch&&(i.needAbortFetch=!1,e.push(i))}return e}function H5(t){const e=[];for(const n in t.tiles){const i=t.tiles[n];i.needGenerate&&(i.needGenerate=!1,e.push(i))}return e}function V5(t){const e=new Set(t.viewportTiles),n=new Set(t.tileModsCache.getData().map(o=>o.tile)),i=[];for(const o in t.tiles){const r=t.tiles[o];aE(r)&&!e.has(o)&&t.zoomDirection===Kn.Stationary&&!n.has(r)&&i.push(r)}return i}function j5(t,e,n,i,o,r,s,a,l,c,d=0,u=!1){return{type:t,sourceId:e,tileLayerId:n,styleId:l.handyStyleId,styleRevision:a.styleManager.getStyleRevision(l.handyStyleId),styleState:l.styleState,minZoomLevel:i,maxZoomLevel:o,minDetailLevel:r,maxDetailLevel:s,tiles:{},viewportTiles:[],zoomLevel:$5(t,l.zoom,l.styleZoom),zoomDirection:Kn.Stationary,zoomStartZoom:0,tileModsCache:new N5(0,(f,h)=>{var _;a.labeler.removeLabels(h.labelsKey),(_=h.objects)==null||_.forEach(p=>a.tileManager.removeObject(p)),rp(h,l)}),tileModsCacheMaxCount:0,selectedIds:[],displayedMods:{},tilesAppearance:pi.ByOne,mapState:l,stopLabelAnimation:!1,viewportPadding:d,displayStats:{matched:0,shifted:0,parent:0,children:0},requestOddTiles:u,ids:c}}function $5(t,e,n){return t==="raster"?Math.round(e):Math.floor(n)}function wc(t){for(const e in t.tiles)lE(t.tiles[e],t.mapState);t.tiles={},t.viewportTiles=[],t.zoomDirection=Kn.Stationary,t.tileModsCache.reset(),t.displayedMods={},t.tilesAppearance=pi.ByOne}function W5(t,e,n,i,o=!1){const{tileManager:r,renderer:s}=t,a=n.displayedMods,l=Xg(a,i);l.forEach(u=>{if(u.objects!==void 0){let f=!o;for(const h in i)if(G6(u.tile,i[h].tile)){f=!1;break}u.objects.forEach(h=>{r.addObject(h),f&&h.startTicker(e,$g.type,$g.time,0,1)})}});const c=Xg(i,a);c.forEach(u=>{var f;u.objects!==void 0&&(u.objects.forEach(h=>{r.removeObject(h)}),(f=u.tile.hover)==null||f.tileObjects.forEach(h=>r.removeObject(h)))});const d=l.length>0||c.length>0;return d&&(e.needLabeling=!0,s.addRerenderEvent()),d}function ap(t){t.viewportTiles.forEach(e=>hE(t.tiles[e]))}function vE(t){switch(t){case"geojson":return 3;case"raster":return 1/0}return 2}function Mf(t,e,n){yE(t,e.styleZoom,e.zoom),bE(t,e,n),wE(t),gl(t)}function yE(t,e,n){const i=$5(t.type,n,e),o=i-t.zoomLevel;t.zoomDirection===Kn.Stationary&&(o>0?(t.zoomDirection=Kn.ZoomingIn,t.zoomStartZoom=t.zoomLevel):o<0&&(t.zoomDirection=Kn.ZoomingOut,t.zoomStartZoom=t.zoomLevel)),t.zoomLevel=i}function bE(t,e,n){if(t.zoomLevel<t.minZoomLevel){t.viewportTiles=[];return}const i=Ve(t.zoomLevel,t.minZoomLevel,t.maxZoomLevel),o=Ve(t.zoomLevel,t.minDetailLevel,t.maxDetailLevel);switch(t.type){case"globe":t.viewportTiles=P3(e,i,t.minZoomLevel).map(Ge);break;default:t.viewportTiles=F3(e,n,i,t.minZoomLevel,o,t.viewportPadding,t.maxZoomLevel,t.requestOddTiles).map(Ge),e.stats.foundVisibleTilesCount=t.viewportTiles.length}}function wE(t){const e=Math.round((Object.keys(t.displayedMods).length+t.viewportTiles.length)*qe.cacheRatio);t.tileModsCacheMaxCount<e&&(t.tileModsCacheMaxCount=e),e>t.tileModsCacheMaxCount/2&&t.tileModsCache.setSize(e)}function xE(t,e,n,i,o,r,s){const a=EE(t),l={},c=new Set,d=u=>Z5(u,n);for(const u of e){const f=a[u];if(f){Vd(l,f),r.matched++;continue}const h=t[u],_=y1(h,a,1)||y1(h,a,-1);if(_){r.shifted++,Vd(l,_);continue}const p=SE(h,a,i,o,s);if(p){r.parent++,Vd(l,p),c.add(p);continue}const m=z3(a,h,d);for(const g of m)r.children++,Vd(l,g)}return IE(l,c,t),l}function y1(t,e,n){const{coords:i}=t,o=n>0?Math.min(i[3]+n,32):32,r=n<0?Math.max(i[3]+n,0):0;for(let s=i[3]+n;s>=r&&s<=o;s+=n){const a=Ge([i[0],i[1],i[2],s]),l=e[a];if(l)return l}}function SE(t,e,n,i,o){for(let s=t.detailLevel-1;s>=n;s--){const a=Fh(e,t,s,i);if(a)return a}const r=n;for(let s=t.zoomLevel;s>=r;s--){const a=Fh(e,t,t.detailLevel,s);if(a)return a}if(o)for(let s=t.zoomLevel;s>=r;s--)for(let a=t.detailLevel;a>=n;a--){const l=Fh(e,t,a,s);if(l)return l}return null}function ME(t){const e=t.currentMod;return e===void 0?!1:e.ready}function Z5(t,e){const n=t.currentMod;return n===void 0?!1:e[n.key]!==void 0}function Vd(t,e){const n=e.currentMod;t[n.key]=n}function TE(t,e){const n=e.currentMod;n!==void 0&&delete t[n.key]}function IE(t,e,n){const i=o=>Z5(o,t);for(const o of e){const r=z3(n,o,i);for(const s of r)TE(t,s)}}function EE(t){const e={};for(const n in t){const i=t[n];ME(i)&&(e[n]=i)}return e}function X5(t,e,n){AE(t,e,n),CE(t),PE(t,e.globeMode);for(const i in t.displayedMods)t.tileModsCache.get(i);LE(t),FE(t)}function AE(t,e,n){for(const i in t.tiles)fE(t.tiles[i],t.tileModsCache,e,n,t.ids)}function CE(t){switch(t.tilesAppearance){case pi.ByOne:ap(t);break;case pi.WaitingLayer:$0(t.tiles,t.viewportTiles)&&(t.tilesAppearance=pi.ByOne,ap(t));break;case pi.GlobalWaiting:break}}function PE(t,e){const{tiles:n,viewportTiles:i,displayedMods:o,minZoomLevel:r,maxZoomLevel:s,displayStats:a}=t;t.displayedMods=xE(n,i,o,r,s,a,e)}function LE({tiles:t,displayedMods:e,viewportTiles:n}){for(const i in t){if(n.includes(i))continue;const o=t[i],r=o.currentMod;r&&!e[r.key]&&cE(o)}}function FE(t){switch(t.zoomDirection){case Kn.ZoomingIn:(t.zoomLevel<=t.zoomStartZoom||b1(t))&&(t.zoomDirection=Kn.Stationary,t.zoomStartZoom=t.zoomLevel);break;case Kn.ZoomingOut:(t.zoomLevel>=t.zoomStartZoom||b1(t))&&(t.zoomDirection=Kn.Stationary,t.zoomStartZoom=t.zoomLevel);break}}function b1(t){const{tiles:e,viewportTiles:n,displayedMods:i}=t;for(let o=0;o<n.length;o++){const r=e[n[o]],s=_h(r);if(!s||i[s.key]===void 0)return!1}return!0}function kE(t,e,n,i){var o;n.selectedIds=i,n.tilesAppearance=pi.WaitingLayer,gl(n);for(const r in n.tiles){const s=n.tiles[r];O5(t,e,s,n.sourceId,(o=s.hover)==null?void 0:o.id,!0)}}function w1(t,e,n,i){if(!e.disableHoverStyles){for(const o in n.tiles){const r=n.tiles[o];O5(t,e,r,n.sourceId,i)}t.labeler.disableThrottleUpdateOnce()}}function RE(t,e){t.styleState=e,gl(t)}function Y5(t,e,n,i){i?t.tilesAppearance=pi.ByOne:t.tilesAppearance=pi.GlobalWaiting,t.styleId=e,t.styleRevision=n,gl(t)}function q5(t){t.tilesAppearance=pi.ByOne,ap(t)}function zE(t){t.tilesAppearance=pi.WaitingLayer,t.stopLabelAnimation=!0,Object.keys(t.tiles).forEach(e=>{mE(t.tiles[e])}),gl(t)}function BE(t){t.tilesAppearance=pi.WaitingLayer,Object.keys(t.tiles).forEach(e=>{pE(t.tiles[e])}),gl(t)}function OE(t,e,n){for(const i of t.viewportTiles){const o=t.tiles[i],r=_h(o);if(!r)continue;const s=B5(r);if(s.length===0)continue;const a=e.getLabelsDemKey(s);r.demKey!==a&&(r.demKey=a,n.addTileLabels(r.labelsKey,Yc.Tile,s))}}function zc(t){return{_src:t.memSizeJs()}}function Tf(t){return{_texture:t.memSizeGPU()}}function K5(t){return{[String(t.purpose)]:{_initData:t.memSizeJs()}}}function DE(t){return{[String(t.purpose)]:{_glBuffer:t.memSizeGPU()}}}function If(t){var n;const e={};return t.generatedData&&(e.generatedData={collectorOutput:(n=t.generatedData)==null?void 0:n.map(i=>GE(i.collectorOutput))}),t.objects&&(e.objects=t.objects.map(i=>J5(i))),e}function Ef(t){return{objects:t.objects?t.objects.map(e=>W0(e)):0}}function J5(t){return{buffers:t.buffers.map(K5)}}function W0(t){return{children:t.children.map(e=>({[`${e.symbol}_${e.sink}`]:(e.instanceCount??e.count)*qc(e.symbol,e.sink)})),buffers:t.buffers.filter(e=>e.purpose!=="attributes"&&e.purpose!=="instanced").map(e=>({[String(e.purpose)]:e.byteLength}))}}function NE(t){return{buffers:t.buffers.filter(e=>e instanceof F).map(K5).filter(e=>e._initData),textures:t.textures.map(zc)}}function UE(t){return{buffers:t.buffers.filter(e=>e instanceof F).map(DE),textures:t.textures.map(zc)}}function Mn(t){if(typeof t=="number")return t;let e=0;if(Array.isArray(t))for(const n of t)e+=Mn(n);else for(const n in t){const i=t[n];typeof i=="number"?e+=i:e+=Mn(i)}return e}function GE(t){return{data:t.data.reduce((n,i)=>(n[`${i.symbol}_${i.sink}`]=i.buffer.byteLength,n),{}),identifyIds:{centerBuffer:t.identifyIds.centerBuffer.byteLength,instanceIdBuffer:t.identifyIds.instanceIdBuffer.byteLength,layerIdBuffer:t.identifyIds.layerIdBuffer.byteLength,objectClassBuffer:t.identifyIds.objectClassBuffer.byteLength,phaseBuffer:t.identifyIds.phaseBuffer.byteLength,styleIdBuffer:t.identifyIds.styleIdBuffer.byteLength,sublayerBuffer:t.identifyIds.sublayerBuffer.byteLength}}}async function Af(t){return{defaultSource:t.defaultSource.getMemoryFootprint(),tileManager:t.tileManager.getMemoryFootprint(e=>!t.defaultSource.hasLayer(e)),identifier:t.identifier.getMemoryFootprint(),assetManager:t.assetManager.getMemoryFootprint(),trafficTileLayer:t.trafficTileLayer.getMemoryFootprint(),imageManager:t.imageManager.getMemoryFootprint(),parserThread:await t.workers.parser.getMemoryFootprint(),labelingThread:await t.workers.labeling.getMemoryFootprint(),renderer:t.renderer.getMemoryFootprint(),labeler:t.labeler.getMemoryFootprint(),postEffectsManager:t.postEffectsManager.getMemoryFootprint(),shadowManager:t.shadowManager.getMemoryFootprint()}}class Ro{constructor(e,n,i,o,r,s,a,l={}){this.disabledRegions=null,this.generatingCount=0,this.tilesGenerationQueue=[],this.disableTilesAnimation=!1,this.idsToUpdate=new Set,this.destroyed=!1,l=Object.assign({viewportPadding:0,disableTilesAnimation:!1,requestOddTiles:!1},l),this.ids=r.identifier.getIdScope(l.idScope??Yo),this.ids.registerTileLayer(this),this.modules=r,this.mapState=s,this.prevStyleState=s.styleState,this.sourceCore=a,this.id=mo(),this.disableTilesAnimation=!!l.disableTilesAnimation,this.gridState=j5(a.type,a.id,this.id,e,n,i,o,r,this.mapState,this.ids,l.viewportPadding,l.requestOddTiles),this.maxGeneratingCount=vE(a.type)}memSizeJs(){const e=this.gridState;return{gridState:{displayedMods:Object.keys(e.displayedMods).map(n=>If(e.displayedMods[n])),tileModsCache:e.tileModsCache.keys().filter(n=>!e.displayedMods[n]).map(n=>If(e.tileModsCache.get(n)))}}}memSizeGpu(){const e=this.gridState;return{gridState:{displayedMods:Object.keys(e.displayedMods).map(n=>Ef(e.displayedMods[n])),tileModsCache:e.tileModsCache.keys().filter(n=>!e.displayedMods[n]).map(n=>Ef(e.tileModsCache.get(n)))}}}destroy(){this.destroyed=!0,wc(this.gridState),this.modules.modelsScene.clearSourceTileMapBySource(this.sourceCore.id),this.ids.unregisterTileLayer(this)}redraw(){wc(this.gridState),this.modules.modelsScene.clearSourceTileMapBySource(this.sourceCore.id),Mf(this.gridState,this.mapState,this.modules)}getZoomDirection(){return this.gridState.zoomDirection}getDisplayedTileObjects(){const e=[];for(const n in this.gridState.displayedMods){const i=this.gridState.displayedMods[n];i.objects&&e.push(...i.objects)}return e}getDisplayedIdentifyData(){var n,i;const e=[];for(const o in this.gridState.displayedMods){const r=this.gridState.displayedMods[o];(i=r.generatedData)==null||i.concat(((n=r.tile.hover)==null?void 0:n.generatedData)||[]).forEach(s=>e.push({ids:s.collectorOutput.identifyIds,metatileHash:s.metatileHash,sourceId:r.tile.sourceId,tileKey:r.tile.key}))}return e}getLabelingData(){const e={sourceId:this.gridState.sourceId,animate:!this.gridState.stopLabelAnimation,labelsKeys:[]};for(const n in this.gridState.displayedMods){const i=this.gridState.displayedMods[n];e.labelsKeys.push(i.labelsKey)}return this.gridState.stopLabelAnimation&&this.viewportTilesReady()&&(this.gridState.stopLabelAnimation=!1),e}getViewportTiles(){const e=[],n=this.gridState.viewportTiles;for(let i=0;i<n.length;i++){const o=this.gridState.tiles[n[i]];o&&e.push(o)}return e}viewportTilesReady(){return $0(this.gridState.tiles,this.gridState.viewportTiles)}isEmpty(){return this.gridState.viewportTiles.length===0}displayedTilesAnimationFinished(){for(const e in this.gridState.displayedMods){const n=this.gridState.displayedMods[e];if(n.objects){for(const i of n.objects)if(!i.tickerFinished(this.mapState))return!1}}return!0}activateStyleUpdating(){Y5(this.gridState,this.mapState.handyStyleId,this.modules.styleManager.getStyleRevision(this.mapState.handyStyleId),this.modules.map.core.getIsFirstStyleUpdate())}finishStyleUpdating(){q5(this.gridState)}setSelectedIds(e){kE(this.modules,this.mapState,this.gridState,e)}setHoverId(e){w1(this.modules,this.mapState,this.gridState,e)}resetHoverId(){w1(this.modules,this.mapState,this.gridState)}onSourceDataChange(){zE(this.gridState)}onFeatureStateMapChange(){BE(this.gridState)}getTileCount(){let e=0;for(const n in this.gridState.displayedMods){const i=this.gridState.displayedMods[n].objects;i!==void 0&&(e+=i.length)}return e}isBlank(){for(const e of this.gridState.viewportTiles){const n=this.gridState.tiles[e],{serverMetadata:i}=n;if(i===void 0||i.length===0)continue;const o=_h(n);if(o&&o.ready)return!1}return!0}updateViewport(){Mf(this.gridState,this.mapState,this.modules)}update(){this.mapState.needReplicasUpdate&&this.setModObjectsSyncNecessity();const e={...this.gridState.displayedMods};this.mapState.styleState!==this.prevStyleState&&RE(this.gridState,this.mapState.styleState),X5(this.gridState,this.mapState,this.modules);const{demManager:n,labeler:i}=this.modules;OE(this.gridState,n,i),this.fetch(U5(this.gridState)),this.abortFetch(G5(this.gridState)),this.generate(H5(this.gridState)),this.clearTiles(V5(this.gridState)),W5(this.modules,this.mapState,this.gridState,e,this.disableTilesAnimation),this.updateVisibility()}pushIdsToUpdate(e){e.forEach(n=>this.idsToUpdate.add(n))}getSourceType(){return this.sourceCore.type}fetch(e){e.sort((n,i)=>mc(this.mapState.center,n,i)).forEach(n=>{this.sourceCore.fetchTile(n.coords,this.mapState).then(i=>{n.status===j0.Loading&&(n.serverMetadata=i)})})}abortFetch(e){e.forEach(n=>this.sourceCore.abortTileFetch(n.coords))}updateGenerationQueue(){if(this.destroyed||this.generatingCount>this.maxGeneratingCount)return;const e=this.getTileToGenerate();if(!e)return;++this.generatingCount;const{tile:n,mod:i}=e,o={tileCoords:n.coords,selectedIds:i.params.getSelectedIds(),styleId:i.params.styleId},r=this.disabledRegions,s={areTileBoundsVisible:this.mapState.showDefaultTileBounds};this.sourceCore.generateTile(this.mapState,o.tileCoords,o.styleId,o.selectedIds,devicePixelRatio,s).then(a=>{if(!a){$3(this.sourceCore.type);return}if(!Array.isArray(a.results))return;let{results:l}=a;r&&(l=l.filter(d=>!r.includes(d.regionId)));const c=new Map;if(l.forEach(d=>{d.collectorOutput.data.forEach(u=>{u.symbol!=="gltfModel"||u.sink!=="instances"||u.generatedObjects.forEach(f=>{var g;const h=Ni.sinks.instances.unpackObjectAttributes(f.attributes),_=(g=f.meta)==null?void 0:g.childrenIds,p=h.parentId;if(!_||!p)return;let m=c.get(p);m||(m=new Set,c.set(p,m));for(const y of _)m.add(y)})})}),c.size){const d=Ge(o.tileCoords);this.ids.updateParentChildrenData(d,c)}l.forEach(d=>{const{styleId:u,metatileHash:f,regionId:h,collectorOutput:_}=d,{packedRasters:p,rastersToLoad:m,floorHidingMap:g,dataModelsUrls:y}=_;p!==void 0&&this.modules.assetManager.prepareRasters(u,p),this.modules.assetManager.fillDataModelUrlMap(y),this.modules.assetManager.loadRasters(m),this.modules.floorManager.prepareFloors(h,f,g,this.sourceCore.type)}),n.idSet=_E(l),z5(i,l,n.idSet),this.modules.labeler.addTileLabels(i.labelsKey,Yc.Tile,B5(i))}).finally(()=>{this.generatingCount=this.generatingCount-1,this.updateGenerationQueue()})}getTileToGenerate(){this.tilesGenerationQueue.sort((n,i)=>mc(this.mapState.center,n,i));let e=this.tilesGenerationQueue.shift();for(;e;){const n=D5(e);if(n){if(n.useful)return{mod:n,tile:e};e.newMod=void 0}e=this.tilesGenerationQueue.shift()}return null}addTileToGenerationQueue(e){this.tilesGenerationQueue.push(e),this.updateGenerationQueue()}generate(e){e.sort((n,i)=>mc(this.mapState.center,n,i)).forEach(n=>{var i;(i=n.newMod)!=null&&i.needGenerate&&!this.tilesGenerationQueue.includes(n)&&this.addTileToGenerationQueue(n)})}clearTiles(e){if(!e.length)return;const n=[];this.modules.modelsScene.clearSourceTileMapByTiles(this.sourceCore.id,e);for(const i of e)this.sourceCore.deleteTile(i.coords),n.push(i.key),delete this.gridState.tiles[i.key];this.ids.removeParentChildrenData(n)}updateVisibility(){if(this.idsToUpdate.size===0)return;const e=[];this.gridState.tileModsCache.getData().forEach(i=>{i.objects&&i.objects.forEach(o=>{e.push(o)})}),e.length!==0&&this.updateObjectsVisibility(e)}updateObjectsVisibility(e){let n=!1;for(const i of this.idsToUpdate){const o=+!this.ids.isHidden(i,Qn.PolygonExtrusion),r=+!this.ids.isHidden(i,Qn.FloorPolygons);for(const s of e)s.updateObjVisibility(i,o,!1)&&(n=!0),s.updateObjVisibility(i,r,!0)&&(n=!0)}this.idsToUpdate.clear(),n&&(this.modules.renderer.addRerenderEvent(),this.modules.identifier.debouncedFillCache())}setModObjectsSyncNecessity(){this.gridState.tileModsCache.getData().forEach(n=>{var i;(i=n.objects)==null||i.forEach(o=>{o.needSync=!0})})}}class Jc{constructor(e=0){this.index=e,this.keysMap={}}getIndex(){const e=this.index;return this.index+=1,e}getUniqueIndex(e){return this.keysMap[e]===void 0&&(this.keysMap[e]=this.index,this.index+=1),this.keysMap[e]}getIndexedKeys(){return this.keysMap}}function HE(t){const e=VE(t),{groups:n,table:i}=jE(e),o={};for(let s=0;s<i.length;s++){const a=i[s],l=n[s];o[l]={};for(let c=0;c<a.length;c++){const d=n[c];o[l][d]=i[s][c]}}const r=n.reduce((s,a,l)=>(s[a]=l,s),{});return{indexToGroup:n,groupToIndex:r,table:o}}function VE(t){const e=(t.groups||[]).concat(Bh.groups).reduce((i,o)=>(i.includes(o)||i.push(o),i),[]),n=(t.overlay||[]).concat(Bh.overlay).concat(e.reduce((i,o)=>(o===Yr||o===Ts||o===P0||i.push([o,Ts]),i),[])).reduce((i,o)=>{const r=[];for(const s of o)e.includes(s)&&r.push(s);return r.length>1&&i.push(r),o.length===1&&r.length===1&&i.push(r),i},[]);return{groups:e,overlay:n,intersect:Bh.intersect}}function jE(t){const{groups:e,overlay:n,intersect:i}=t,o=e.reduce((s,a,l)=>(s[a]=l,s),{}),r=[];for(let s=0;s<e.length;s++){const a=[];for(let l=0;l<e.length;l++)a.push(!0);r.push(a)}for(let s=0;s<n.length;s++){const a=n[s];for(let l=0;l<a.length;l++)for(let c=l+1;c<a.length;c++){const d=o[a[l]],u=o[a[c]];r[d][u]=!1,r[u][d]=!1}}for(let s=0;s<i.length;s++){const a=i[s];for(let l=0;l<a.length;l++)for(let c=l+1;c<a.length;c++){const d=o[a[l]],u=o[a[c]];r[d][u]=!0,r[u][d]=!0}}return{groups:e,table:r}}const $E={db_id:"id",tech_db_beginning_is_cut:"beginningIsCut",tech_db_ending_is_cut:"endingIsCut",tech_db_previous_point_x:"previousPointX",tech_db_previous_point_y:"previousPointY",tech_db_next_point_x:"nextPointX",tech_db_next_point_y:"nextPointY",tech_db_object_length:"objectLength",tech_db_component_distance_start:"componentDistanceStart",tech_db_component_distance_end:"componentDistanceEnd",tech_db_geometry_type:"db_geometry_type"},WE=t=>$E[t]??t,ZE={objectClass:"db_object_class",sublayer:"db_sublayer",db_id:"id"};function XE(t){return ZE[t]??t}const YE={Class:"db_class",DisputePosition:"db_dispute_position",ObjectClass:"db_object_class",ParkingType:"db_parking_type",Sublayer:"db_sublayer",Subsublayer:"db_subsublayer",Icon:"db_icon",GeometryType:"db_geometry_type",ModelType:"db_model_type",RoadSupportTypes:"tech_db_road_support_type",RoadMarkingColorType:"db_road_marking_color_type",PoiCategory:"L1_Poi_category",RoadPart:"db_road_part",TriangulationMethod:"db_triangulation_method"},qE=t=>{t.enumerationValues=Object.keys(t.enumerationValues??{}).reduce((e,n)=>{const i=YE[n];return i&&(e[i]=t.enumerationValues[n]),e},{})};class Q5{constructor(e,n,i){this.id=e,this.modules=n,this.options=i,this.type="zenith",this.worker=new n.workers.parser.ZenithSource,this.sourceAttrs=ts(i.sourceAttributes??{},M3),this.objectAttributes={},this.dataFilter=i.dataFilter}fetchTile(e,n){const{assetManager:i,map:o}=this.modules,r=this.constructTileUrl(e,n);return this.worker.fetchTile({tileUrl:r,coords:e}).catch(()=>Promise.resolve()).then(s=>{if(!s)return;const{metadata:a,err:l}=s;return a.forEach(c=>{const d=this.constructMetaTileUrl(c);i.loadMetatile(d,c.metatileHash,c.regionId),o.emit("tileload",{tileCoords:e,regionId:c.regionId}),n.shownRegionIds.add(c.regionId)}),(l==null?void 0:l.status)===403&&o.emit("invalidtilekey"),a})}async generateTile(e,n,i,o,r,s={},a,l=this.id,c){const d=await this.worker.generateTile({styleId:i,tileInfo:Ct(n),pixelRatio:r,selectedIds:o,styleState:e.styleState,floorsEnabled:e.floorsEnabled,sourceAttrs:this.sourceAttrs,hoverId:a,sourceId:l,isDefaultSource:this.options.isDefaultSource,modelsPath:this.options.modelsPath,promoteAttributes:this.options.promoteAttributes,promoteId:this.options.promoteId,isCustomZenithSource:!this.options.isDefaultSource,dataFilter:this.dataFilter,...s,modelShowHideEventsSublayers:e.modelShowHideEventsSublayers},c);return d.promotedAttrs&&(this.objectAttributes[Ge(n)]=d.promotedAttrs),d}getObjectAttributes(e,n){var i;return(i=this.objectAttributes[e])==null?void 0:i[n]}generateModel(e){return this.worker.generateModel(e)}abortTileFetch(e){this.worker.abortTileRequest(Ge(e))}deleteTile(e){this.objectAttributes[Ge(e)]=void 0,this.worker.deleteTile(Ge(e))}setAttributes(e){this.sourceAttrs=e}getAttributes(){return this.sourceAttrs}destroy(){this.worker.destroy(),this.sourceAttrs={},this.objectAttributes={}}setFeatureStateMap(e){this.worker.setFeatureStateMap(e)}setDataFilter(e){e?this.dataFilter=O(e,{precomputes:[]},Fn.Generator):this.dataFilter=void 0}constructTileUrl(e,n){return R3(this.options.tileServer,this.options.tileSet,this.options.tileProtocol,this.options.subdomains,e,this.options.tileKey,this.options.appId,n.lang,this.options.tileTemplateUrl,this.options.defaultLang,this.options.sessionId,this.options.dt)}constructMetaTileUrl(e){const n=this.options.metatileTemplateUrl,i={host:this.options.tileServer,tileSet:this.options.tileSet,protocol:this.options.tileProtocol,subdomain:this.options.subdomains[0],hash:M0(e.metatileHash)};return wr(n?{url:n}:"metatile",i)}}const eb=[{id:"__2gis_comm_poi",type:"point",style:{textFont:["Noto_Sans_Semibold",["step",["zoom"],"Noto_Sans",16,"Noto_Sans"]],iconImage:"peak",iconWidth:["interpolate",["linear"],["zoom"],15,22,16.8,30],textColor:"#3A3A3A",visibility:"visible",textFontSize:[["interpolate",["linear"],["zoom"],15.5,11,18,13],["interpolate",["linear"],["zoom"],15.5,10,18,12]],textHaloColor:"rgba(255,255,255,0.5)",textHaloWidth:.9,iconLabelingGroup:P0,iconLabelingMargin:{leftRight:6,topBottom:6}},filter:["all",["match",["get","db_sublayer"],["Commercial_poi_default","Commercial_poi_city","Commercial_poi_premium"],!0,!1],["any",["==",["in",["get","db_building_id"],["global","_activeFloorBuildingIds"]],!1],["in",["get","db_plan_id"],["global","_activeFloorIds"]]]]}];function KE(t){const e={};let n=0;for(const i in t)e[i]=n,n+=1;return e}let JE=Number.MIN_SAFE_INTEGER;function tb(){return JE++}const QE=tb(),eA=tb(),nb="__JAKARTA__DEM__LIGHTING__";class lp extends Error{constructor(e){super(`Unknown expression type '${e[0]}' in '${JSON.stringify(e)}'`),this.name="UnknownExpressionTypeError",Object.setPrototypeOf(this,new.target.prototype)}}function O(t,e,n=Fn.Uniform){if(Y6(t))return V3(t)?Os(t):t;switch(t[0]){case"coalesce":return uA(t,e,n);case"all":return dA(t,e,n);case"any":return fA(t,e,n);case"match":return tA(t,e,n);case"in":return aA(t,e,n);case"interpolate":return ib(t,e,n);case"step":return cA(t,e,n);case"featureState":case"get":case"sourceAttr":return ob(t,e,n);case"objectAttr":return{type:"objectAttr",property:t[1]};case"global":return{type:"global",property:t[1]};case"zoom":return{type:"zoom"};case"distance":return{type:"distance"};case"local-time":return{type:"local-time",offset:O(t[1]||0,e,n)};case"utc-time":return{type:"utc-time",offset:O(t[1]||0,e,n)};case"time":return hA(t,e,n);case"height":return{type:"height"};case"heatmap-density":return{type:"heatmap-density"};case"shading-intensity":return{type:"shading-intensity"};case"to-boolean":case"to-color":case"!":case"log10":case"mappoints-to-meters":case"meters-to-pixels":return nA(t,e,n);case"uint64":return O(t[1],e,n);case"==":case"!=":case"<":case"<=":case">":case">=":return iA(t,e,n);case"+":return oA(t,e,n);case"*":return rA(t,e,n);case"^":return sA(t,e,n);case"random":return _A(t,e,n);case"literal":return Array.isArray(t[1])?mA(t,e,n):typeof t[1]=="object"&&t[1]!==null?pA(t):t[1];case"isBehindObjects":return{type:"isBehindObjects"};case"geometry-modifier":const i=[];return t.slice(1).forEach(o=>{const r=gA(o);r&&i.push(r)}),{type:"geometry-modifier",modifiers:i};case"pattern":return{type:"line-pattern",patternType:qI(t[1]),parameters:t.slice(2).map(o=>O(o,e,n))};case"precompute":{if(!e)throw new lp(t);const o=e.precomputes.length;return e.precomputes.push({expr:O(t[1],void 0,n),usage:n}),{type:"precompute",precomputeIndex:o}}case"gltf-animation":return lA(t,e,n);default:throw new lp(t)}}function ls(t,e,n=Fn.Uniform){return uo(t)||Array.isArray(t)&&t.length===0?t:O(t,e,n)}function cs(t,e,n){return t===void 0?t:O(t,e,n)}function tA(t,e,n){const i={type:"match",input:O(t[1],e,n),cases:[],defaultOutput:O(t[t.length-1],e,n)},o=t.slice(2,-1);for(let r=0;r<o.length;r+=2){const s=o[r].reduce((l,c)=>{typeof c=="boolean"&&l.push(Number(c));const d=O(c,e,n);return Q6(d)?l.push(d):console.warn("MatchExpression supports only simple types: string, number, boolean or null",c),l},[]),a={values:new Set(s),output:O(o[r+1],e,n)};i.cases.push(a)}return i}function ib(t,e,n){const i={type:"interpolate",base:1,argument:O(t[2],e,n),steps:[]};t[1][0]==="exponential"&&t[1][1]!==void 0&&(i.base=t[1][1]);const o=t.slice(3);for(let r=0;r<o.length;r+=2){const s={key:O(o[r],e,n),value:O(o[r+1],e,n)};i.steps.push(s)}return i}function nA(t,e,n){return{type:t[0],value:O(t[1],e,n)}}function iA(t,e,n){const i=O(t[1],e,n),o=O(t[2],e,n);return{type:t[0],leftValue:i,rightValue:o}}function oA(t,e,n){return{type:"+",array:t.slice(1).map(i=>O(i,e,n))}}function rA(t,e,n){return{type:"*",array:t.slice(1).map(i=>O(i,e,n))}}function sA(t,e,n){const i=O(t[1],e,n),o=O(t[2],e,n);return{type:"^",base:i,exponent:o}}function aA(t,e,n){const i=O(t[1],e,n),o=t[2][0];if(o!=="get"&&o!=="global"&&o!=="sourceAttr"&&o!=="literal")throw new Error("InExpression supports only the get, global, source attr and literal expressions as a second argument");const r=O(t[2],e,n);return{type:"in",item:i,collection:r}}function lA(t,e,n){const i={type:"gltf-animation",options:[]},o=t.slice(1);for(let r=0;r<o.length;r++)i.options.push(O(o[r],e,n));return i}function cA(t,e,n){const i={type:"step",steps:[],value:O(t[1],e,n)},o={key:0,value:O(t[2],e,n)};i.steps.push(o);const r=t.slice(3);for(let s=0;s<r.length;s+=2){const a={key:r[s],value:O(r[s+1],e,n)};i.steps.push(a)}return i}function ob(t,e,n){const i=t[0],o=XE(t[1]),r={type:i,property:o};if(n!==Fn.Generator&&e){const s=e.precomputes.length??NaN;return e.precomputes.push({expr:r,usage:n}),o==="selected"&&"selectedIdx"in e&&(e.selectedIdx=s),{type:"precompute",precomputeIndex:s}}else return r}function dA(t,e,n){return{type:"all",array:t.slice(1).map(i=>O(i,e,n))}}function uA(t,e,n){return{type:"coalesce",array:t.slice(1).map(i=>{try{return O(i,e,n)}catch(o){return console.debug(`Unknown expression in coalesce: ${o}`),null}})}}function fA(t,e,n){return{type:"any",array:t.slice(1).map(i=>O(i,e,n))}}function hA(t,e,n){return{type:"time",timeSource:O(t[1],e,n),format:t[2]}}function _A(t,e,n){const i=O(t[1],e,n),o=O(t[2],e,n);return{type:"random",start:i,end:o}}function mA(t,e,n){return{type:"literalArray",array:t[1].map(i=>O(i,e,n))}}function pA(t){return{type:"literalObject",object:{type:"object",value:t[1]}}}function gA(t){if(!(t===void 0||!Array.isArray(t)))switch(t[0]){case"line-to-zigzag":return{type:"zigzag-modifier",step:t[1],width:t[2],stopLines:Number(t[3])}}}function vA(t,e){let n=0;function i(o,r){o.type!=="custom"&&UT(o.filter)&&(n=r)}return t.forEach((o,r)=>{o.type==="group"?o.layers.forEach(s=>i(s,r)):i(o,r)}),e.forEach(o=>{o.type==="point"&&(o.style.iconPriority=Number.MAX_SAFE_INTEGER)}),[...t.slice(0,n+1),...e,...t.slice(n+1)]}function yA(t,e,n,i){var u;const o=Z0(t.terrain??{}),r=lb(t.environment??{}),s=cb(t.light,o),a=xA(t.graphicsPresets),l={id:e,revision:0,background:{color:Os(((u=t.background)==null?void 0:u.color)??RM)},light:s,layers:[],layersById:{[no]:o,[Gs]:r},layerIdToInnerId:{},groupsById:{},iconBaseUrl:"",fontUrlTemplate:"",modelsBaseUrl:"",fonts:ff,fontNameToIndex:f5(ff),rasterSets:{byIndex:{},byKey:{}},icons:t.icons||{},models:Object.values(t.models??{}),modelIndex:KE(t.models||{}),labelingGroups:HE(t.labelingGroups??{}),dem:o,graphicsPresets:a,environment:r},c=new Jc;let d=t.layers??[];n&&(d=vA(t.layers??[],eb));for(const f of d){const h=rb(f);if(!h)continue;h.type==="group"&&(l.groupsById[h.innerId]=h,l.layerIdToInnerId[h.id]=h.innerId),(h.type==="group"?h.layers:[h]).forEach(p=>{const m=p.lightingMode??s.defaultLightMode;s.lightingModes[m]||console.warn(`Не найден режим освещения ${m} для слоя ${p.type}. Будет использован режим освещения по умолчанию.`),l.layers.push(p),l.layersById[p.innerId]=p,l.layerIdToInnerId[p.id]=p.innerId,(p.type==="point"||p.type==="polygon"||p.type==="metricPoint"||p.type==="embankment"||p.type==="polygon3d")&&sb(p,c).forEach(b=>{l.rasterSets.byKey[b.key]||(l.rasterSets.byIndex[b.index]=b,l.rasterSets.byKey[b.key]=b)})})}return l}function rb(t){return t.type==="group"?wA(t):qi(t)}function sb(t,e){const n=[],{image:i,imageType:o,anchor:r}=cp(t);return i&&yr(i).forEach(s=>{typeof s!="string"||!s.length||n.push(ab(s,o,e,r))}),n}function ab(t,e,n,i){const o=e==="icon"?hl(t,i[0],i[1]):_l(t);return{type:Us.Static,index:n.getUniqueIndex(o),key:o,isSvg:!0,name:t,fileName:t,anchorX:i[0],anchorY:i[1],rasters:[]}}function cp(t){if(t.type==="point"){const e=Dn(t.style.iconAnchor);return{image:t.style.iconImage,imageType:"icon",anchor:e}}return t.type==="metricPoint"?{image:t.style.iconImage,imageType:"texture",anchor:[0,0]}:{image:t.style.textureImage,imageType:"texture",anchor:[0,0]}}const dp=new Jc;function bA(t,e){return t.type==="appearance"?{type:t.type,tipMovementAmplitude:O(t.tipMovementAmplitude,e)}:t.type==="repeat"?{type:t.type,tipMovementAmplitude:O(t.tipMovementAmplitude,e),iterationCount:t.iterationCount}:t}function qi(t,e){if(t.type==="custom")return{type:"custom",id:t.id,innerId:Fc(),renderIndex:dp.getIndex(),filter:!1,minzoom:-1/0,maxzoom:1/0,precomputes:[],style:{}};if(!t.style||t.style.visibility==="none")return;let n;try{const i={id:t.id,innerId:Fc(),renderIndex:dp.getIndex(),filter:O(t.filter||!1,void 0),minzoom:x1(t.minzoom,-1/0),maxzoom:x1(t.maxzoom,1/0),precomputes:e?e.precomputes.slice(0):[],webglState:t.webglState,lightingMode:t.lightingMode,castShadows:t.castShadows??!0,receiveShadows:t.receiveShadows??!0};switch(t.type){case"line":{const o=mM(t.style);n={...i,type:t.type,interactive:t.interactive??!0,ignoreTier:O(t.ignoreTier??!1,i),style:{visibility:Qt(o.visibility),color:O(o.color,i),width:O(o.width,i),shift:O(o.shift,i),pattern:O(o.pattern,i),startCap:O(o.startCap,i),endCap:O(o.endCap,i),geometryModifier:O(o.geometryModifier,i),withHeight:o.withHeight,lengthUnits:SA(t.style.pattern)}};break}case"lineExtrusion":{const o=gM(t.style);n={...i,type:t.type,style:{visibility:Qt(o.visibility),sideColor:O(o.sideColor,i),strokeWidth:O(o.strokeWidth,i),strokeColor:O(o.strokeColor,i),sideStrokeColor:O(o.sideStrokeColor,i),height:O(o.height,i),nearCameraFade:O(o.nearCameraFade,i)}};break}case"polygon":{const o=uM(t.style),r=X0(o.textureSize)?o.textureSize[1]:o.textureSize;n={...i,type:t.type,interactive:t.interactive??!0,ignoreTier:O(t.ignoreTier??!1,i),style:{visibility:Qt(o.visibility),color:O(o.color,i),textureImage:O(o.textureImage,i),textureSize:ls(r,i),textureOpacity:O(o.textureOpacity,i),strokeColor:O(o.strokeColor,i),strokeWidth:O(o.strokeWidth,i),lengthUnits:MA(o.textureSize)}};break}case"polygon3d":case"embankment":{const o=fM(t.style),r=t.type==="polygon3d"?{depthFunc:WebGLRenderingContext.LEQUAL}:{};n={...i,type:t.type,interactive:t.interactive??!0,style:{visibility:Qt(o.visibility),color:O(o.color,i),textureImage:O(o.textureImage,i),textureSize:ls(o.textureSize,i),textureOpacity:O(o.textureOpacity,i),strokeColor:O(o.strokeColor,i),strokeWidth:O(o.strokeWidth,i),nearCameraFade:O(o.nearCameraFade,i),elevation:O(o.elevation,i)},webglState:{...r,...i.webglState}},t.type==="polygon3d"&&(n.interactiveOcclusion=t.interactiveOcclusion??!0);break}case"metricPoint":{const o=hM(t.style);n={...i,type:t.type,interactive:t.interactive??!0,ignoreTier:O(t.ignoreTier??!1,i),style:{visibility:Qt(o.visibility),iconImage:O(o.iconImage,i),color:O(o.color,i),rotation:O(o.rotation,i),width:O(o.width,i),height:O(o.height,i)}};break}case"polygonExtrusion":{const o=_M(t.style);n={...i,type:t.type,interactive:t.interactive??!0,style:{visibility:Qt(o.visibility),topColor:O(o.topColor,i),sideColor:O(o.sideColor,i),strokeColor:O(o.strokeColor,i),strokeWidth:O(o.strokeWidth,i),sideStrokeColor:O(o.sideStrokeColor,i),height:O(o.height,i,Fn.Generator),nearCameraFade:O(o.nearCameraFade,i)}};break}case"dashedLine":{const o=bM(t.style);n={...i,type:t.type,interactive:t.interactive??!0,ignoreTier:O(t.ignoreTier??!1,i),style:{visibility:Qt(o.visibility),color:O(o.color,i),gapColor:O(o.gapColor,i),width:O(o.width,i),shift:O(o.shift,i),gapLength:O(o.gapLength,i),dashLength:O(o.dashLength,i),geometryModifier:O(o.geometryModifier,i),withHeight:o.withHeight}};break}case"shiftedLine":{const o=wM(t.style);n={...i,type:t.type,interactive:t.interactive??!0,ignoreTier:O(t.ignoreTier??!1,i),style:{visibility:Qt(o.visibility),color:O(o.color,i),width:O(o.width,i),shift:O(o.shift,i)}};break}case"oneWayLine":{const o=yM(t.style);n={...i,type:t.type,ignoreTier:O(t.ignoreTier??!1,i),interactive:t.interactive??!1,style:{visibility:Qt(o.visibility),color:O(o.color,i),lineWidth:O(o.lineWidth,i),lineLength:O(o.lineLength,i),tipWidth:o.tipWidth,tipHeight:o.tipHeight,roundingRadius:O(o.roundingRadius,i),priority:o.priority,duplicationSpacing:O(o.duplicationSpacing,i),endingOffsets:o.endingOffsets,labelingGroup:o.labelingGroup}};break}case"buildingModel":{const o=pM(t.style);n={...i,type:t.type,interactive:t.interactive??!0,style:{visibility:Qt(o.visibility),color:O(o.color,i),strokeColor:O(o.strokeColor,i),strokeWidth:O(o.strokeWidth,i),nearCameraFade:O(o.nearCameraFade,i)}};break}case"labelLine":{const o=vM(t.style);n={...i,type:t.type,interactive:t.interactive??!1,ignoreTier:O(t.ignoreTier??!1,i),style:{visibility:Qt(o.visibility),textField:O(o.textField,i,Fn.Labeling),textFont:o.textFont,textColor:O(o.textColor,i),textFontSize:O(o.textFontSize,i),textLetterSpacing:o.textLetterSpacing,textHaloColor:O(o.textHaloColor,i),textHaloWidth:o.textHaloWidth,textPriority:O(o.textPriority,i),textLabelingSideMargin:o.textLabelingSideMargin,textDuplicationSpacing:O(o.textDuplicationSpacing,i),labelingGroup:o.labelingGroup,lineEndingOffsets:o.lineEndingOffsets}};break}case"point":{const o=SM(t.style);n={...i,type:t.type,interactive:t.interactive??!0,style:{visibility:Qt(o.visibility),allowOverlap:o.allowOverlap,allowElevation:o.allowElevation,elevation:O(o.elevation,i),iconImage:O(o.iconImage,i),iconAnchor:ls(o.iconAnchor,i),iconOffset:ls(o.iconOffset,i),iconWidth:O(o.iconWidth,i),iconTextField:O(o.iconTextField,i,Fn.Labeling),iconTextFont:cs(o.iconTextFont,i),iconTextAnchor:ls(o.iconTextAnchor,i),iconTextOffset:ls(o.iconTextOffset,i),iconTextColor:O(o.iconTextColor,i),iconTextFontSize:O(o.iconTextFontSize,i),iconTextLineHeight:o.iconTextLineHeight,iconTextLetterSpacing:o.iconTextLetterSpacing,iconTextPadding:ls(o.iconTextPadding,i),iconTextHaloWidth:Ml(sn(o.iconTextHaloWidth)),iconTextHaloColor:O(o.iconTextHaloColor,i),iconOpacity:O(o.iconOpacity,i),iconPriority:O(o.iconPriority,i),iconLabelingMargin:o.iconLabelingMargin,iconLabelingGroup:o.iconLabelingGroup,iconRotation:O(o.iconRotation,i),textField:O(sn(o.textField),i,Fn.Labeling),textFont:O(sn(o.textFont),i),textColor:O(sn(o.textColor),i),textFontSize:O(sn(o.textFontSize),i),textLineHeight:Ml(sn(o.textLineHeight),1.2),textLetterSpacing:Ml(sn(o.textLetterSpacing)),textField2:cs(Qo(o.textField),i,Fn.Labeling),textFont2:cs(Qo(o.textFont),i),textColor2:cs(Qo(o.textColor),i)||O(sn(o.textColor),i),textFontSize2:cs(Qo(o.textFontSize),i)||O(sn(o.textFontSize),i),textMaxLengthPerLine:o.textMaxLengthPerLine,textPlacement:O(o.textPlacement,i),textPriority:O(o.textPriority,i),textOffset:O(sn(o.textOffset),i),textOffset2:cs(Qo(o.textOffset),i),textHaloColor:O(sn(o.textHaloColor),i),textHaloColor2:cs(Qo(o.textHaloColor),i)||O(sn(o.textHaloColor),i),textHaloWidth:Ml(sn(o.textHaloWidth)),textHaloWidth2:Ml(Qo(o.textHaloWidth)||sn(o.textHaloWidth)),textLabelingMargin:sn(o.textLabelingMargin),textLabelingMargin2:Qo(o.textLabelingMargin)||sn(o.textLabelingMargin),textLabelingGroup:sn(o.textLabelingGroup),textLabelingGroup2:Qo(o.textLabelingGroup)||sn(o.textLabelingGroup),duplicationSpacing:O(o.duplicationSpacing,i),endingOffsets:o.endingOffsets}};break}case"arrow":{const o=MM(t.style);n={...i,type:t.type,interactive:!1,ignoreTier:O(t.ignoreTier??!1,i),style:{visibility:Qt(o.visibility),color:O(o.color,i),strokeColor:O(o.strokeColor,i),lineWidth:O(o.lineWidth,i),strokeWidth:O(o.strokeWidth,i),tipWidth:O(o.tipWidth,i),tipHeight:O(o.tipHeight,i),roundingRadius:O(o.roundingRadius,i),animation:bA(o.animation,i)}};break}case"raster":{const o=TM(t.style);n={...i,type:t.type,ignoreTier:O(t.ignoreTier??!1,i),style:{visibility:Qt(o.visibility),opacity:O(o.opacity,i)}};break}case"circle":{const o=xM(t.style);n={...i,type:t.type,interactive:t.interactive??!0,style:{visibility:Qt(o.visibility),color:O(o.color,i),strokeColor:O(o.strokeColor,i),strokeColor2:O(o.strokeColor2,i),width:O(o.width,i),strokeWidth:O(o.strokeWidth,i),strokeWidth2:O(o.strokeWidth2,i)}};break}case"heatmap":{const o=IM(t.style);n={...i,type:t.type,style:{visibility:Qt(o.visibility),color:O(o.color,i),radius:O(o.radius,i),opacity:O(o.opacity,i),intensity:O(o.intensity,i),weight:O(o.weight,i),downscale:o.downscale},framebufferId:{framebuffer:wn}};break}case"model":{const o=AM(t.style);n={...i,interactive:t.interactive??!0,interactiveOcclusion:t.interactiveOcclusion??!0,type:"gltfModel",style:{visibility:Qt(o.visibility),modelSrc:O(o.modelSrc,i),offset:O(o.offset,i,Fn.Generator),scale:O(o.scale,i,Fn.Generator),rotation:O(o.rotation,i,Fn.Generator),color:O(o.color,i),linkedIds:O(o.linkedIds,i),colorTextureUvIndex:o.colorTextureUvIndex,roughness:o.roughness,metallic:o.metallic,preventObjectsHiding:o.preventObjectsHiding,nearCameraFade:O(o.nearCameraFade,i),ignoreGlobalLighting:o.ignoreGlobalLighting,showRatio:O(o.showRatio,i),lightingModel:o.lightingModel,playAnimation:O(o.playAnimation,i)}};break}case"overpass":{const o=CM(t.style);n={...i,type:t.type,style:{visibility:Qt(o.visibility),debug:o.debug,sideColor:O(o.sideColor,i),bottomColor:O(o.bottomColor,i),topColor:O(o.borderTopColor,i),strokeColor:O(o.strokeColor,i),strokeWidth:O(o.strokeWidth,i),thickness:O(o.thickness,i),borderHeight:O(o.borderHeight,i),borderWidth:O(o.borderWidth,i),color:O(o.color,i),nearCameraFade:O(o.nearCameraFade,i),tunnelHeight:O(o.tunnelHeight,i)}};break}case"tunnel":{const o=PM(t.style);n={...i,type:t.type,style:{visibility:Qt(o.visibility),sideColor:O(o.sideColor,i),bottomColor:O(o.bottomColor,i),topColor:O(o.topColor,i),strokeColor:O(o.strokeColor,i),strokeWidth:O(o.strokeWidth,i),color:O(o.color,i),nearCameraFade:O(o.nearCameraFade,i)}};break}}}catch(i){if(i instanceof lp){console.warn(`Problem with layer #${t.id}: ${i}`);return}throw i}return n}function wA(t){var n;const e={id:t.id,innerId:Fc(),renderIndex:dp.getIndex(),type:t.type,layers:[],orderBy:[],precomputes:[]};return e.orderBy=((n=t.orderBy)==null?void 0:n.map(i=>ob(i,e,Fn.Uniform)))??[],t.layers.forEach((i,o)=>{const r=qi(i,e);r&&(r.groupId=e.innerId,r.groupIndex=o,r.renderIndex=e.renderIndex,e.layers.push(r))}),e}function Z0(t){const e=EM(t),n={id:"dem",type:"dem",innerId:no,filter:!0,precomputes:[],minzoom:-1/0,maxzoom:1/0,renderIndex:QE,style:{},framebufferId:{elevation:wn,hillshade:wn,flatBottom:wn},lightingMode:nb};return n.style={visibility:"visible",lightingDirection:typeof e.lightingDirection<"u"?O(e.lightingDirection,n):null,shadingIntensity:O(e.shadingIntensity,n),shadingPalette:ib(e.shadingPalette,n),verticalScale:O(e.verticalScale,n)},n}function lb(t){const e=LM(t),n={id:"sky",type:"custom",innerId:Gs,filter:!0,precomputes:[],minzoom:-1/0,maxzoom:1/0,renderIndex:eA,style:{}};return n.style={visibility:"visible",skyColor:O(e.skyColor,n),fogColor:O(e.fogColor,n),starsIntensity:O(e.starsIntensity,n)},n}function cb(t,e){var r,s;const n=FM(t),i={},o={ambientColor:{type:"color",value:[255,255,255,255]},ambientIntensity:0,dir1Color:{type:"color",value:[255,255,255,255]},dir1Altitude:0,dir1Azimuth:0,dir1Intensity:0,dir2Color:{type:"color",value:[255,255,255,255]},dir2Altitude:0,dir2Azimuth:0,dir2Intensity:0,shadowRadius:(r=n.shadows)==null?void 0:r.radius};for(const a in n.lightingModes){const l={ambientColor:{type:"color",value:[255,255,255,255]},ambientIntensity:0,dir1Color:{type:"color",value:[255,255,255,255]},dir1Altitude:0,dir1Azimuth:0,dir1Intensity:0,dir2Color:{type:"color",value:[255,255,255,255]},dir2Altitude:0,dir2Azimuth:0,dir2Intensity:0,shadowRadius:(s=n.shadows)==null?void 0:s.radius},c=n.lightingModes[a].map(f=>n.sources[f]).filter(Boolean),d=n.shadows?n.sources[n.shadows.source]:void 0;let u=0;c.forEach(f=>{f.color||(f.color="#FFFFFF"),f.type==="ambient"?(l.ambientColor=O(f.color,void 0),l.ambientIntensity=O(f.intensity,void 0),a===n.defaultLightingMode&&(o.ambientColor=l.ambientColor,o.ambientIntensity=l.ambientIntensity)):f.type==="directional"&&(f===d&&(l.shadowLightIndex=u),u===0?(u++,l.dir1Color=O(f.color,void 0),l.dir1Altitude=O(f.altitude,void 0),l.dir1Azimuth=O(f.azimuth,void 0),l.dir1Intensity=O(f.intensity,void 0),a===n.defaultLightingMode&&(o.dir1Color=l.dir1Color,o.dir1Intensity=l.dir1Intensity,o.dir1Azimuth=e.style.lightingDirection===null?l.dir1Azimuth:e.style.lightingDirection,o.dir1Intensity=O(f.intensity,void 0),o.dir1Altitude=l.dir1Altitude)):u===1&&(u++,l.dir2Color=O(f.color,void 0),l.dir2Altitude=O(f.altitude,void 0),l.dir2Azimuth=O(f.azimuth,void 0),l.dir2Intensity=O(f.intensity,void 0)))}),i[a]=l}return i[nb]=o,{defaultLightMode:n.defaultLightingMode,lightingModes:i}}function xA(t){return kM(t)}function x1(t,e){return typeof t=="number"&&!Number.isNaN(t)?t:e}function SA(t){return t&&X0(t[2])?Vo.Meters:Vo.Pixels}function MA(t){return X0(t)?Vo.Meters:Vo.Pixels}function X0(t){return Array.isArray(t)&&t[0]==="meters-to-pixels"}function Qt(t){return t==="none"?"hidden":t}class up{constructor(e,n,i){this.id=e,this.modules=n,this.options=i,this.type="geojson",this.idToIndex={},this.worker=new this.modules.workers.parser.GeoJsonSource(this.options,this.id),this.attributes=i.attributes||{},this.dataFilter=i.dataFilter}fetchTile(e){return this.worker.fetchTile(e).then(()=>[{regionId:0,metatileHash:-2}])}async generateTile(e,n,i,o,r,s){const a=this.options.modelsPath,l=await this.worker.generateTile(e.styleState,n,i,o,r,a,this.dataFilter,e.modelShowHideEventsSublayers);return l.results[0]&&l.results[0].idToIndex&&(this.idToIndex[Ge(n)]=l.results[0].idToIndex),l}async getObjectAttributes(e,n){return this.worker.getObjectAttributes(e,n)}abortTileFetch(e){this.worker.abortTileFetch(e)}deleteTile(e){delete this.idToIndex[Ge(e)],this.worker.deleteTile(e)}setAttributes(e){this.worker.setSourceAttrs(e),this.attributes=e}getAttributes(){return this.attributes}destroy(){this.idToIndex={},this.worker.destroy()}setFeatureStateMap(e){this.worker.setFeatureStateMap(e)}async setData(e){return this.idToIndex={},this.options=typeof e=="string"?this.options={...this.options,url:e}:this.options={...this.options,data:e},await this.worker.setData(e)}getComponentIndex(e,n){var i;return n?(i=this.idToIndex[n])==null?void 0:i[e]:(console.warn("Нет tileKey при идентификации объекта из GeoJsonSource. Пытаемся получить index из id по-старому."),Number.isNaN(+e)?void 0:+e%2**32)}setDataFilter(e){e?this.dataFilter=O(e,{precomputes:[]},Fn.Generator):this.dataFilter=void 0}}function ki(t,e,n){let i,o,r,s;const a=function(){const d=Date.now()-r;d<e&&d>=0?i=setTimeout(a,e-d):(i=null,n||(s=t(...o),i||(o=null)))};function l(){i!==void 0&&(clearTimeout(i),i=null)}function c(...d){o=d,r=Date.now();const u=n&&!i;return i||(i=setTimeout(a,e)),u&&(s=t(...o),o=null),s}return c.cancel=l,c}const db=15,Cf=17;class ub{constructor(e,n,i){this.type="geojson",this.isCustomPromoteId=!1,this.id=Rs(),this.modelsAppearStrategy=n.modelsAppearStrategy??f0,this.modules=e.modules,this.mapglApiSource=i,this.identifiedAsDefault=!!n.identifyAsDefaultSource,n.promoteId&&(this.isCustomPromoteId=!0),this.identifiedAsDefault&&!n.promoteId&&(n.promoteId="db_id"),"generateId"in n&&n.promoteId&&(n.generateId=!1),this.sourceCore=new up(this.id,this.modules,n);const o=n.minZoom??Am.minZoom,r=Math.min(n.maxZoom??db,Cf);this.layer=new Ro(o,r,o,Cf,this.modules,e.state,this.sourceCore,n),this.modules.tileManager.addTileLayer(this.layer)}destroy(){this.modules.tileManager.removeTileLayer(this.layer),this.layer.destroy(),this.modules.sourceStorage.removeSource(this.getId()),this.sourceCore.destroy()}setAttributes(e){this.sourceCore.setAttributes(e),this.layer.redraw(),this.modules.identifier.resetCache()}getAttributes(){return this.sourceCore.getAttributes()}getZoomDirection(){return this.layer.getZoomDirection()}getId(){return this.sourceCore.id}isIdentifiedAsDefault(){return this.identifiedAsDefault}}const fp={type:"FeatureCollection",features:[]};let Y0=class fb extends ub{constructor(e,n,i){n.generateId=!0,super(e,n,i),this.subtype="internal",this.data=n.data,this instanceof fb&&this.modules.sourceStorage.addSource(this)}getFeatureById(e,n){if(this.data.type==="FeatureCollection"){let i;const o=this.sourceCore.getComponentIndex(e,n);return o===void 0?(this.isCustomPromoteId&&(i=this.data.features.find(r=>r.id===e)),i):this.data.features[o]}return this.data}destroy(){super.destroy(),this.data=fp}async setData(e){await this.sourceCore.setData(e)&&(this.data=e,this.layer.onSourceDataChange(),this.modules.identifier.resetCache())}setDataFilter(e){this.sourceCore.setDataFilter(e)}};class TA extends ub{constructor(e,n,i){super(e,n,i),this.subtype="external",n.preventInteractions&&(n.promoteId=void 0),this.modules.sourceStorage.addSource(this)}getObjectAttributes(e,n){return this.sourceCore.getObjectAttributes(e,n)}async setDataUrl(e){await this.sourceCore.setData(e)&&(this.layer.onSourceDataChange(),this.modules.identifier.resetCache())}}let hb=class extends Y0{constructor(e,n,i){super(e,n,i),this.subtype="viewport-internal",this.destroyed=!1,this.viewportDiffer=new Kt([{path:"center",type:"vec3"},{path:"zoom",type:"number"},{path:"size",type:"vec2"},{path:"rotation",type:"number"},{path:"pitch",type:"number"},{path:"padding",type:"padding"},{path:"demMode",type:"boolean"},{path:"elevation",type:"number"},{path:"minElevation",type:"number"}]),this._map=e,this.viewportPadding=n.viewportPadding,this.modules.sourceStorage.addSource(this)}async setDataFn(e){this.setViewportHandler(e)}setViewportPadding(e){this.viewportPadding=e,this.viewportHandler&&this.viewportHandler()}update(){this.viewportDiffer.check(this._map.state)&&this.viewportHandler&&this.viewportHandler()}destroy(){this.destroyed=!0,this.viewportHandler&&(this.viewportHandler.cancel(),this.viewportHandler=void 0),super.destroy()}setViewportHandler(e){if(!e){this.setData(fp),this.viewportHandler=void 0;return}this.viewportHandler=ki(async()=>{const n=this._map.getBounds({sizeExtension:this.viewportPadding}),i=n.southWest,o=n.northEast,r=[i[0],i[1],o[0],o[1]],s=e(r);let a=fp;try{const l=await fetch(s);l.ok||console.error(`Failed to fetch a tile by url "${s}", status: ${l.status}`);const c=l.headers.get("content-type");(!c||!c.includes("application/json"))&&console.error(`Failed to fetch a tile by url "${s}", expected the "application/json" data but got "${c}"`),a=await l.json()}catch(l){console.error(`Failed to fetch a tile by url "${s}", message: ${l.message}`)}this.destroyed||this.setData(a)},500),this.viewportHandler()}},_b=class{constructor(e,n,i){this.options=n,this.type="zenith",this.id=Rs(),this.identifyAsDefaultSource=n.identifyAsDefaultSource??!0,this.identifyAsDefaultSource&&!n.promoteId&&(n.promoteId="id"),this.sourceOptions=n,this.modelsAppearStrategy=n.modelsAppearStrategy??f0,this.state=e.state,this.modules=e.modules,this.sourceCore=new Q5(this.id,this.modules,this.options),this.tileLayer=new Ro(n.minZoom??qe.maxUniverseZoom+1,n.maxZoom??qe.maxRegionalZoom,n.minZoom??qe.maxUniverseZoom+1,n.maxDetailLevel??qe.maxDetailLevel,this.modules,this.state,this.sourceCore,this.options),this.modules.tileManager.addTileLayer(this.tileLayer),this.modules.sourceStorage.addSource(this),this.mapglApiSource=i}getObjectAttributes(e,n){return this.sourceCore.getObjectAttributes(e,n)}getId(){return this.id}getOptions(){return this.sourceOptions}getAttributes(){return this.sourceCore.getAttributes()}getZoomDirection(){return this.tileLayer.getZoomDirection()}setAttributes(e){this.sourceCore.setAttributes(e),this.tileLayer.redraw()}getUrl(e,n){return wr(e,{host:this.options.tileServer,tileSet:this.options.tileSet,protocol:this.options.tileProtocol,subdomain:this.options.subdomains[0],...n})}destroy(){this.modules.tileManager.removeTileLayer(this.tileLayer),this.tileLayer.destroy(),this.modules.sourceStorage.removeSource(this.id),this.sourceCore.destroy()}setFeatureStateMap(e){this.sourceCore.setFeatureStateMap(e),this.tileLayer.onFeatureStateMapChange()}isIdentifiedAsDefault(){return this.identifyAsDefaultSource}};function q0(t,e){const n=new XMLHttpRequest;if(n.open("GET",t.url,!0),n.responseType="arraybuffer",t.headers)for(const i in t.headers)n.setRequestHeader(i,t.headers[i]);return n.onerror=function(){e({status:0,message:"Network error"},new ArrayBuffer(0))},n.onload=function(){n.status>=200&&n.status<300&&n.response?e(void 0,n.response):e({status:n.status,message:n.statusText},new ArrayBuffer(0))},n.send(),n}function IA(t,e){const n=new XMLHttpRequest;if(n.open("GET",t.url,!0),t.headers)for(const i in t.headers)n.setRequestHeader(i,t.headers[i]);return n.onerror=function(){e({status:0,message:"Network error"},{})},n.onload=function(){if(n.status>=200&&n.status<300){if(!n.response||!n.response.length)return e({status:204,message:"No content"},{});let i;try{i=JSON.parse(n.response),e(void 0,i)}catch{e({status:0,message:`Json parse data error from url ${t.url}`},{})}}else e({status:n.status,message:n.statusText},{})},n.send(),n}function mb(t){return t?t>=500&&t<=599:!1}function pb(t){return new Promise(e=>setTimeout(e,t))}class EA{constructor(){this.cache=new Map,this.pendingRequests=new Map}async fetch(e,n=3,i=300){var s;let o=0,r;for(;o<=n;)try{if(r=await this.fetchAttempt(e),!r)return;if(!r.err||!mb((s=r.err)==null?void 0:s.status))return r;throw new Error(`Fetching ${e.coords} attempt ${o} failed.`)}catch{if(o>=n)return{metadata:[]};await pb(Math.pow(2,o)*i),o++}}get(e){return this.cache.get(e)||[]}delete(e){this.cache.delete(e)}abortRequest(e){const n=this.pendingRequests.get(e);n!==void 0&&(n.xhr.abort(),n.resolve(),this.pendingRequests.delete(e))}destroy(){this.cache.clear(),this.pendingRequests.clear()}fetchAttempt({tileUrl:e,coords:n}){return new Promise(i=>{const o=Ge(n),r=q0({url:e},(s,a)=>{if(this.pendingRequests.delete(o),s||a.byteLength===0){s!==void 0&&console.error(s),this.cache.set(o,[]),i({metadata:[],err:s});return}const l=C3(a),c=C6(l);this.cache.set(o,l),i({metadata:c,err:s})});this.pendingRequests.set(o,{xhr:r,resolve:i})})}}class K0 extends Map{constructor(e){super(e),this.featureAttrs=(e==null?void 0:e.featureAttrs)||new Set,this.clearAttrs=!0}set(e,n){return super.set(e,n),Object.keys(n).forEach(i=>this.featureAttrs.add(i)),this}}const Kr=0,hp=1,AA={type:Us.Loaded,index:-1,key:hl("",.5,.5),isSvg:!1,name:"",fileName:"",rasters:[]},CA=["default","marker","markerText","htmlLabel"],PA={default:0,marker:1,markerText:2,htmlLabel:3,pointLabel:4},LA={default:{default:!0,marker:!1,markerText:!0,htmlLabel:!0,pointLabel:!1},marker:{default:!1,marker:!1,markerText:!0,htmlLabel:!1,pointLabel:!1},markerText:{default:!0,marker:!0,markerText:!0,htmlLabel:!1,pointLabel:!1},htmlLabel:{default:!0,marker:!1,markerText:!1,htmlLabel:!1,pointLabel:!1},pointLabel:{default:!1,marker:!1,markerText:!1,htmlLabel:!1,pointLabel:!0}};function mh(t){const e=[],n=Object.keys(Ho).length;for(let i=0;i<n;i++)e[i]=NaN;for(const i in t){if(Ho[i]===void 0)throw new Error(`No such tile prop '${i}'`);e[Ho[i]]=t[i]}return e}class FA{constructor(){this.needRenderIndexRebuild=!1,this.style={id:Kr,revision:0,background:{color:Os("#f6f2de")},light:{defaultLightMode:"global",lightingModes:{}},layers:[],layersById:{},layerIdToInnerId:{},groupsById:{},iconBaseUrl:"",fontUrlTemplate:"",modelsBaseUrl:"",rasterSets:{byIndex:{},byKey:{}},labelingGroups:{indexToGroup:CA,groupToIndex:PA,table:LA},fonts:ff,fontNameToIndex:f5(ff),icons:{},models:[],modelIndex:{},dem:Z0({}),environment:lb({}),graphicsPresets:{light:{},normal:{},immersive:{}}},this.zIndexById={};const e=qi({type:"line",id:"debug-tile-bounds",minzoom:-1/0,maxzoom:1/0,style:{color:"#ff0000",width:1}});e&&this.addLayer(e,0)}get hasDynamicObjects(){return this.style.layers.length>1}getRenderIndexById(e){var n;return((n=this.style.layersById[e])==null?void 0:n.renderIndex)||0}getStyle(){return this.style}appendRasterSet(e,n){this.style.rasterSets.byIndex[e.index]=e,n!==void 0&&(this.style.rasterSets.byKey[n]=e)}removeRasterSet(e){this.style.rasterSets.byIndex[e]=AA}getLabelingGroupIndex(e){const{groupToIndex:n}=this.style.labelingGroups;return n[e]!==void 0?n[e]:n.default}addLayer(e,n){this.style.layersById[e.innerId]||(this.style.layers.push(e),this.style.layersById[e.innerId]=e,n!==void 0&&(this.zIndexById[e.innerId]=n),this.needRenderIndexRebuild=!0)}removeLayer(e){const n=this.style.layersById[e];if(!n)return;const i=this.style.layers.indexOf(n);i!==-1&&this.style.layers.splice(i,1),delete this.style.layersById[e],delete this.zIndexById[e]}updateLayerStyle(e,{style:n,precomputes:i}){const o=this.style.layersById[e];o&&(o.style=n,o.precomputes=i)}update(){this.needRenderIndexRebuild&&(this.rebuildRenderIndex(),this.needRenderIndexRebuild=!1)}rebuildRenderIndex(){this.style.layers.sort((e,n)=>{const i=this.zIndexById[e.innerId]??0,o=this.zIndexById[n.innerId]??0;return i-o});for(let e=0;e<this.style.layers.length;e++)this.style.layers[e].renderIndex=e}}function gb(t,e,n){const o=Se,r={x:new Uint16Array([0,o,o,0,0]),y:new Uint16Array([0,0,o,o,0])},s=mh({}),a=Zo(n,ul,Ho,s,Wc);io({collector:t,generator:Ot.generate,args:[Kr,e,a,Ct([0,0,0,0]),r]})}function J0(){try{return!!localStorage.getItem("debugStatusCompile")}catch(t){return console.warn("Error accessing localStorage in forceGlStatusCheck:",t),!1}}function __(t){for(let e=1;e<t.length;e++)t[e]=t[e]+t[e-1]}function kA(t){let e=0,n=0,i=0;for(let o=0;o<t.length;o+=2)i=n+t[o],n=i>>>0,t[o]=n,e=e+t[o+1]+(i>4294967295?1:0)>>>0,t[o+1]=e}const vb={1:__,2:__,4:__,8:kA};class yb{constructor(e){this.offset=0,this.buffer=e,this.u8=new Uint8Array(e),this.u16=new Uint16Array(e),this.u32=new Uint32Array(e),this.s8=new Int8Array(e),this.s16=new Int16Array(e),this.s32=new Int32Array(e),this.f32=new Float32Array(e)}readS8(){return this.s8[this.offset++]}readU16(){const e=this.u16[this.offset>>1];return this.offset+=2,e}readU32(){const e=this.u32[this.offset>>2];return this.offset+=4,e}readF32(){const e=this.f32[this.offset>>2];return this.offset+=4,e}readU8Vector(e=1){const i=this.readU32()*e,o=-i&3,r=this.u8.subarray(this.offset,this.offset+i);return this.offset+=i+o,r}readU16Vector(e=1){const i=this.readU32()*e*2,o=-i&3,r=this.u16.subarray(this.offset>>1,this.offset+i>>1);return this.offset+=i+o,r}}function Rt(t,e,n,i){const o=e.BYTES_PER_ELEMENT;t.offset+=-t.offset&o-1;const r=new e(t.buffer,t.offset,n);return t.offset+=o*n,i&&vb[o](r),r}function jd(t,e,n){t.offset+=-t.offset&7;const i=new Uint32Array(t.buffer,t.offset,e*2);return t.offset+=8*e,n&&vb[8](i),i}function S1(t,e,n){t.offset+=-t.offset&3;const i=new Uint32Array(t.buffer,t.offset,e),o=new Float32Array(t.buffer,t.offset,e);t.offset+=4*e;let r;if(n){let s=0;for(r=0;r<e;r++)s=s+i[r]>>>0,o[r]=s/1e3}else for(r=0;r<e;r++)o[r]=i[r]/1e3;return o}function M1(t,e,n){t.offset+=-t.offset&3;const i=new Int32Array(t.buffer,t.offset,e),o=new Float32Array(t.buffer,t.offset,e);t.offset+=4*e;let r;if(n){let s=0;for(r=0;r<e;r++)s=s+i[r]>>>0,o[r]=(s|0)/1e3}else for(r=0;r<e;r++)o[r]=i[r]/1e3;return o}function RA(t,e){let n=t.offset;const i=t.u8,o=t.buffer,r=[];for(;e--;)r.push(i[n++]|0);const s=[];for(;++e<r.length;){let a=r[e];a===255&&(a=i[n++]|i[n++]<<8|i[n++]<<16|0),s.push(new Uint8Array(o,n,a)),n=n+a}return t.offset=n,s}function zA(t,e){t.offset+=-t.offset&3;let n=t.offset;const i=t.u32,o=t.buffer,r=[];for(let a=0;a<e;a++)r.push(i[n>>2]),n+=4;const s=[];for(let a=0;a<e;a++){const l=r[a];n+=-n&7,s.push(new Uint8Array(o,n,l)),n+=l}return t.offset=n,s}function BA(t,e,n){switch(n){case 2:return Rt(t,Uint8Array,e);case 3:return Rt(t,Uint8Array,e,!0);case 4:return Rt(t,Uint16Array,e);case 5:return Rt(t,Uint16Array,e,!0);case 6:return Rt(t,Uint32Array,e);case 7:return Rt(t,Uint32Array,e,!0);case 8:return jd(t,e);case 9:return jd(t,e,!0);case 10:return Rt(t,Uint8Array,e);case 11:return RA(t,e);case 12:return zA(t,e);case 13:return Rt(t,Int8Array,e);case 14:return Rt(t,Int8Array,e,!0);case 15:return Rt(t,Int16Array,e);case 16:return Rt(t,Int16Array,e,!0);case 17:return Rt(t,Int32Array,e);case 18:return Rt(t,Int32Array,e,!0);case 19:return jd(t,e);case 20:return jd(t,e,!0);case 21:return S1(t,e);case 22:return S1(t,e,!0);case 23:return M1(t,e);case 24:return M1(t,e,!0);case 25:return Rt(t,Uint32Array,e);default:throw new Error("Unknown stream type "+n)}}function m_(t){let e=0;for(let n=0;n<t.length;n++)e+=t[n];return e}function OA(t,e,n){return new t.constructor(t.buffer,t.byteOffset+e*t.BYTES_PER_ELEMENT,n)}let Dr;const Ba=[],Ki=new Int32Array(256);let _p;const Q0=[],bb=[],wb=[],mp=[0,0,0,0,0];let xb=0,pp=0,gp=0,ya={};function DA(t,e,n,i,o,r,s,a,l=!1,c,d,u,f){const{styleState:h,sourceId:_,sourceAttrs:p,tileInfo:m,pixelRatio:g,selectedIds:y,dataFilter:b,floorsEnabled:v,hoverId:T,generateOnlySelectedPoi:x,generateOnlyHoveredPoi:I,modelsPath:E}=o,{data:L}=r,N=new Set(y),k=P6(L);if(k.byteLength<8)return i.getAccumulatedData();Ba.length=0;const w=new yb(k);if(w.readU32()!==1279676242)return i.getAccumulatedData();const A=w.readU16();if(A!==2&&A!==3&&A!==4)return console.error(`Unsupported tile format version: "${A}"`),i.getAccumulatedData();Dr=A,w.readU16();const z=s5(g);return NA(w),UA(w),GA(Dr,t,e,h,n,i,w,m,z,N,b,s,a,v,_,p,l,T,x,I,E,c,d,u,f),i.getAccumulatedData()}function NA(t){const e=Dr===4?2:1,n=t.u8;let i=t.offset,o=t.u32[i>>2];for(i+=4,xb=o,pp=i;o--;)i=n[i++]*2+i,i=n[i++]*e+i;t.offset=i+(-i&3)}function UA(t){const e=t.u32[t.offset>>2];t.offset+=4,_p=Rt(t,Uint8Array,e);const n=Rt(t,Uint32Array,e);for(let i=0;i<e;i++){const o=_p[i];Ba[i]=BA(t,n[i],o),Ki[i]=0}}function GA(t,e,n,i,o,r,s,a,l,c,d,u,f,h,_,p,m=!1,g,y,b,v,T,x,I,E){const L=Array.from(o.featureAttrs);_c(u,L);const N=xb,k=Rt(s,Int32Array,N),w=m_(k),S=Rt(s,Uint8Array,w,!0),A=Rt(s,Uint8Array,m_(S),!0),z=Rt(s,Uint8Array,w,!0),M=Rt(s,Uint8Array,m_(z),!0),P=Rt(s,Uint16Array,w,!0);let C=0,D=0,B=0,U=!0;for(let G=0;G<N;G++){const V=k[G];$A(s,u,f);for(let ne=0;ne<V;ne++){const X=S[C];X>0&&(HA(f,X,A,D,u,t,m),D+=X);const Z=z[C];if(Z>0&&(VA(f,Z,M,B),B+=Z),!f[u.tileProps.db_geometry_type]){console.error(`Geometry type not specified for data source ${_}. Metatile version ${u.version}`);return}U=X>0||Z>0;const Q=u.tileProps;let le=f[Q[I??""]];Number.isNaN(le)&&(le=void 0);const Ie=Zo(i,p,Q,f,[],le,a),ce=P[C];ce>0&&jA(t,e,n,i,Ie,o,r,ce,a,l,c,d,u,h,_,g,y,b,v,T,U,x,E),C++}}Sb()}function HA(t,e,n,i,o,r,s=!1){var a;for(;e--;){const l=n[i++],c=bb[l],d=Q0[l],u=_p[c];if(u===8||u===9||u===19||u===20)t[d]=x5(Ba[c][Ki[c]],Ba[c][Ki[c]+1]),Ki[c]+=2;else{const f=Ba[c][Ki[c]];switch(d){case o.tileProps.objectLength:case o.tileProps.db_centroid_x:case o.tileProps.db_centroid_y:case o.tileProps.componentDistanceEnd:case o.tileProps.componentDistanceStart:case o.tileProps.previousPointX:case o.tileProps.previousPointY:case o.tileProps.nextPointX:case o.tileProps.nextPointY:t[d]=r===2?f*oo:f;break;case o.tileProps.db_label:t[d]=Rh(f);break;case o.tileProps.db_label2:t[d]=Rh(f);break;case o.tileProps.db_tiers:const h=f.byteLength/Int32Array.BYTES_PER_ELEMENT,_=new DataView(f.buffer,f.byteOffset,f.byteLength),p=_.getInt32(0,!0);if(h===1&&!p)t[d]=void 0;else{const m=new Array(h);m[0]=p;for(let g=1;g<h;g++)m[g]=_.getInt32(g*Int32Array.BYTES_PER_ELEMENT,!0);t[d]=m}break;default:if(s&&u===11)t[d]=Rh(f);else{const m=o.tilePropsByIndex[d];t[d]=((a=o.reverseDictionaries[m])==null?void 0:a[f])??f}}Ki[c]++}}}function VA(t,e,n,i){for(;e--;){const o=n[i++],r=Q0[o];t[r]=NaN}}let $d=[];function jA(t,e,n,i,o,r,s,a,l,c,d,u,f,h,_,p,m,g,y,b=[],v,T,x){const{tileProps:I,defaultProps:E}=f,{tileAttrs:L,featureAttrs:N,id:k}=o,w=l.coords[3],S=I.db_hidden_by_plan_id!==void 0;if(!v&&$d.length===0){for(let M=0;M<gp;M++){const P=mp[M];Ki[P]=Ki[P]+a}return}const A=L[I.db_geometry_type],z=Dr===4?f.vertexProps:f.vertexPropsLegacy[A];if(!z){console.error(`Couldn't get vertex keys for tile ${Ge(l.coords)} source ${_}. Metatile version ${f.version}`);return}for(let M=0;M<gp;M++){const P=Dr===4?wb[M]:M,C=mp[M],D=z[P]??"signed_z";ya[D]=WA(OA(Ba[C],Ki[C],a),M,t),Dr===4&&D==="z"&&(ya.signed_z=ya.z),Ki[C]=Ki[C]+a}if(!(I.db_sublayer!==void 0&&!Number.isNaN(L[I.db_sublayer])&&hh(L[I.db_sublayer]))&&!(S&&i._activeFloorIds&&L[I.db_hidden_by_plan_id]&&i._activeFloorIds.includes(L[I.db_hidden_by_plan_id]))){for(const M in E){const P=E[M];Number.isNaN(L[P.index])&&(L[P.index]=P.value)}if(!(p&&p!==k)){if(k!==void 0){let M=d.has(k);m&&(M=!0);const P=!!g||!!p&&p===k;if(L[I.selected]=M?1:0,L[I.hovered]=P?1:0,b.length>0){const C={};b.forEach(D=>{C[D]=L[I[D]]}),s.addPromotedObjectAttributes(k,C)}h&&w>=Ma.detailLevel&&L[I.db_hidden_by_plan_building_id]&&s.addFloorHidingMap(k,L[I.db_hidden_by_plan_building_id])}else L[I.selected]=0,L[I.hovered]=0;if(r.featureAttrs.size>0){const M=k!==void 0&&r.get(k);if(M)for(const P of r.featureAttrs)r.clearAttrs=!1,N[I[P]]=M[P];else if(r.clearAttrs===!1){r.clearAttrs=!0;for(const P in I)N[I[P]]!==void 0&&(N[I[P]]=void 0)}}if(T){const M=ZA(ya,A,l);if(M){const P=XA(o,Ge(l.coords));s.addFeature({type:"Feature",properties:P,geometry:M})}return}v&&($d=n.getLayers(e.id,I,L).filter(M=>te(M.filter,o)&&(u?te(u,o):!0))),$d.length===0&&o.id&&s.idIndexer.addOrphanId(o.id),T5(s,e,$d,o,f,Dr,w,_,l,c,ya,m||g,y,x)}}}function $A(t,e,n){const i=Object.keys(e.tileProps).length,o=t.u8;let r,s,a=pp;for(s=1;s<i;s++)n[s]=NaN;for(r=o[a++],s=0;s<r;s++)Q0[s]=o[a++],bb[s]=o[a++];for(r=o[a++],s=0;s<r;s++)Dr===4&&(wb[s]=o[a++]),mp[s]=o[a++];gp=r,pp=a,Sb()}function Sb(){ya={}}function WA(t,e,n){if(n===2&&e<3&&t instanceof Uint16Array)for(let i=0;i<t.length;i++)t[i]*=oo;return t}function ZA(t,e,n){const i=[],{x:o,y:r,z:s,signed_z:a}=t;for(let l=0;l<t.x.length;l++){const c=Ac(o[l],r[l],n),d=q.scaleFactor(c[1]),u=s?s[l]*32:void 0;c[2]=u??(a==null?void 0:a[l])??0,c[2]/=He*d,i.push(c)}if(i.length)switch(e){case"point":return{type:"MultiPoint",coordinates:i};case"polyline":return{type:"LineString",coordinates:i};case"polygon":return{type:"Polygon",coordinates:[i.map((l,c)=>i[jn(c,i.length)])]};default:return}}function XA(t,e){const n={tile:e};return Object.keys(t.tileProps).forEach(i=>{const o=t.tileAttrs[t.tileProps[i]];!Number.isNaN(o)&&o!==void 0&&(n[i]=o)}),n}const YA=t=>{if(t.length>2){let e=0;for(let n=t.length-1,i=n,o=0;o<=n;o++){const r=t[i],s=t[o];e+=(r[0]+s[0])*(r[1]-s[1]),i=o}return e/2}else return 0},qA=t=>YA(t)>0;function KA(t){t=t.slice().sort(JA);const e=t.length,n=new Array(e*2);let i=0;for(let r=0;r<e;r++){const s=t[r];for(;i>=2&&T1(n[i-2],n[i-1],s)<=0;)i--;n[i++]=s}const o=i+1;for(let r=e-2;r>=0;r--){const s=t[r];for(;i>=o&&T1(n[i-2],n[i-1],s)<=0;)i--;n[i++]=s}return n.slice(0,i-1)}function T1(t,e,n){return(e[1]-t[1])*(n[0]-t[0])-(e[0]-t[0])*(n[1]-t[1])}function JA(t,e){return t[0]===e[0]?t[1]-e[1]:t[0]-e[0]}function QA(t){const e=[],n=qA(t),i=Mm(t[0],t[t.length-1]),o=i?t.length-1:t.length;for(let r=o-1,s=0,a=1;s<o;s++,r=s-1,a=(s+1)%o){const l=[];wS(l,t[r],t[s],t[a],n),e.push(l)}return i&&e.push(e[0]),e}const Wd=[[0],[0],[0]],I1=[];function eC(t,e,n,i,o,r,s,a,l){const{matrix:c,offset:d,id:u,selected:f}=r,h=new yb(o),_=[];if(!t)return{objects:i.getAccumulatedData(),textures:_};if(h.readU32()!==1296191066||h.readU16()!==1)return{objects:i.getAccumulatedData(),textures:[]};h.readU16();const p=h.readU32();for(let E=0;E<p;E++)_.push(h.readU8Vector());const{tileProps:m}=s,g=[],y=Object.keys(m).length;for(let E=0;E<y;E++)g[E]=NaN;if(g[m.db_sublayer]="Building_model",g[m.selected]=f?1:0,g[m.db_region]=a,l.featureAttrs.size>0){const E=Array.from(l.featureAttrs);_c(s,E)}const b=[],v=typeof u!="number"&&l.get(u);if(v)for(const E of l.featureAttrs)l.clearAttrs=!1,b[m[E]]=v[E];else if(l.clearAttrs===!1){l.clearAttrs=!0;for(const E in m)b[m[E]]!==void 0&&(b[m[E]]=void 0)}const T=h.offset,x=Zo(n,ul,m,g,b,u),I=e.getLayers(t.id,m,g).filter(E=>te(E.filter,x));return I.length===0&&x.id&&i.idIndexer.addOrphanId(x.id),I.forEach(E=>{E.type!=="buildingModel"||(vr(E,x),!te(E.filter,x))||(h.offset=T,tC(t,E,x,i,h,c,d))}),{objects:i.getAccumulatedData(),textures:_}}function tC(t,e,n,i,o,r,s){const a=o.readU32();for(let l=0;l<a;l++){const c=o.readU32(),d=yt(o.readF32(),o.readF32(),o.readF32()),u=yt(o.readF32(),o.readF32(),o.readF32()),f=$t(Ke(),u,d),h=[];Q4(h,r,d),Mc(h,h,f),h[12]+=s[0],h[13]+=s[1];const _=o.readU16Vector(5),p=o.readU32();for(let b=0;b<p;b++){const v=o.readU32()===1?ax:Vc,T=o.readU16Vector();do Bi.processSubmesh(t.id,e,n,i,_,T,v,c,h);while(i.isOverloaded())}const m=o.readU16Vector();do Bi.processOuterEdge(t.id,e,n,i,_,m,h);while(i.isOverloaded());const g=KA(nC(_)),y=QA(g);for(let b=0;b<g.length-2;b++){for(let v=0;v<3;v++){const T=iC(b+v,g.length);Wd[0][v]=g[T][0],Wd[1][v]=g[T][1],Wd[2][v]=0,I1[v]=y[T]}do xn.generateFloorsBottomFill(i,t.id,Wd,I1,bf,h);while(i.isOverloaded())}}}function nC(t){const e=[];for(let n=0;n<t.length;n+=5)e.push([t[n],t[n+1]]);return e}function iC(t,e){return t===0?0:t%2?(t+1)/2:e-t/2}function oC(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var eg={};/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */eg.read=function(t,e,n,i,o){var r,s,a=o*8-i-1,l=(1<<a)-1,c=l>>1,d=-7,u=n?o-1:0,f=n?-1:1,h=t[e+u];for(u+=f,r=h&(1<<-d)-1,h>>=-d,d+=a;d>0;r=r*256+t[e+u],u+=f,d-=8);for(s=r&(1<<-d)-1,r>>=-d,d+=i;d>0;s=s*256+t[e+u],u+=f,d-=8);if(r===0)r=1-c;else{if(r===l)return s?NaN:(h?-1:1)*(1/0);s=s+Math.pow(2,i),r=r-c}return(h?-1:1)*s*Math.pow(2,r-i)};eg.write=function(t,e,n,i,o,r){var s,a,l,c=r*8-o-1,d=(1<<c)-1,u=d>>1,f=o===23?Math.pow(2,-24)-Math.pow(2,-77):0,h=i?0:r-1,_=i?1:-1,p=e<0||e===0&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(a=isNaN(e)?1:0,s=d):(s=Math.floor(Math.log(e)/Math.LN2),e*(l=Math.pow(2,-s))<1&&(s--,l*=2),s+u>=1?e+=f/l:e+=f*Math.pow(2,1-u),e*l>=2&&(s++,l/=2),s+u>=d?(a=0,s=d):s+u>=1?(a=(e*l-1)*Math.pow(2,o),s=s+u):(a=e*Math.pow(2,u-1)*Math.pow(2,o),s=0));o>=8;t[n+h]=a&255,h+=_,a/=256,o-=8);for(s=s<<o|a,c+=o;c>0;t[n+h]=s&255,h+=_,s/=256,c-=8);t[n+h-_]|=p*128};var rC=ot,Zd=eg;function ot(t){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(t)?t:new Uint8Array(t||0),this.pos=0,this.type=0,this.length=this.buf.length}ot.Varint=0;ot.Fixed64=1;ot.Bytes=2;ot.Fixed32=5;var vp=65536*65536,E1=1/vp,sC=12,Mb=typeof TextDecoder>"u"?null:new TextDecoder("utf8");ot.prototype={destroy:function(){this.buf=null},readFields:function(t,e,n){for(n=n||this.length;this.pos<n;){var i=this.readVarint(),o=i>>3,r=this.pos;this.type=i&7,t(o,e,this),this.pos===r&&this.skip(i)}return e},readMessage:function(t,e){return this.readFields(t,e,this.readVarint()+this.pos)},readFixed32:function(){var t=Xd(this.buf,this.pos);return this.pos+=4,t},readSFixed32:function(){var t=C1(this.buf,this.pos);return this.pos+=4,t},readFixed64:function(){var t=Xd(this.buf,this.pos)+Xd(this.buf,this.pos+4)*vp;return this.pos+=8,t},readSFixed64:function(){var t=Xd(this.buf,this.pos)+C1(this.buf,this.pos+4)*vp;return this.pos+=8,t},readFloat:function(){var t=Zd.read(this.buf,this.pos,!0,23,4);return this.pos+=4,t},readDouble:function(){var t=Zd.read(this.buf,this.pos,!0,52,8);return this.pos+=8,t},readVarint:function(t){var e=this.buf,n,i;return i=e[this.pos++],n=i&127,i<128||(i=e[this.pos++],n|=(i&127)<<7,i<128)||(i=e[this.pos++],n|=(i&127)<<14,i<128)||(i=e[this.pos++],n|=(i&127)<<21,i<128)?n:(i=e[this.pos],n|=(i&15)<<28,aC(n,t,this))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var t=this.readVarint();return t%2===1?(t+1)/-2:t/2},readBoolean:function(){return!!this.readVarint()},readString:function(){var t=this.readVarint()+this.pos,e=this.pos;return this.pos=t,t-e>=sC&&Mb?xC(this.buf,e,t):wC(this.buf,e,t)},readBytes:function(){var t=this.readVarint()+this.pos,e=this.buf.subarray(this.pos,t);return this.pos=t,e},readPackedVarint:function(t,e){if(this.type!==ot.Bytes)return t.push(this.readVarint(e));var n=ir(this);for(t=t||[];this.pos<n;)t.push(this.readVarint(e));return t},readPackedSVarint:function(t){if(this.type!==ot.Bytes)return t.push(this.readSVarint());var e=ir(this);for(t=t||[];this.pos<e;)t.push(this.readSVarint());return t},readPackedBoolean:function(t){if(this.type!==ot.Bytes)return t.push(this.readBoolean());var e=ir(this);for(t=t||[];this.pos<e;)t.push(this.readBoolean());return t},readPackedFloat:function(t){if(this.type!==ot.Bytes)return t.push(this.readFloat());var e=ir(this);for(t=t||[];this.pos<e;)t.push(this.readFloat());return t},readPackedDouble:function(t){if(this.type!==ot.Bytes)return t.push(this.readDouble());var e=ir(this);for(t=t||[];this.pos<e;)t.push(this.readDouble());return t},readPackedFixed32:function(t){if(this.type!==ot.Bytes)return t.push(this.readFixed32());var e=ir(this);for(t=t||[];this.pos<e;)t.push(this.readFixed32());return t},readPackedSFixed32:function(t){if(this.type!==ot.Bytes)return t.push(this.readSFixed32());var e=ir(this);for(t=t||[];this.pos<e;)t.push(this.readSFixed32());return t},readPackedFixed64:function(t){if(this.type!==ot.Bytes)return t.push(this.readFixed64());var e=ir(this);for(t=t||[];this.pos<e;)t.push(this.readFixed64());return t},readPackedSFixed64:function(t){if(this.type!==ot.Bytes)return t.push(this.readSFixed64());var e=ir(this);for(t=t||[];this.pos<e;)t.push(this.readSFixed64());return t},skip:function(t){var e=t&7;if(e===ot.Varint)for(;this.buf[this.pos++]>127;);else if(e===ot.Bytes)this.pos=this.readVarint()+this.pos;else if(e===ot.Fixed32)this.pos+=4;else if(e===ot.Fixed64)this.pos+=8;else throw new Error("Unimplemented type: "+e)},writeTag:function(t,e){this.writeVarint(t<<3|e)},realloc:function(t){for(var e=this.length||16;e<this.pos+t;)e*=2;if(e!==this.length){var n=new Uint8Array(e);n.set(this.buf),this.buf=n,this.length=e}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(t){this.realloc(4),ra(this.buf,t,this.pos),this.pos+=4},writeSFixed32:function(t){this.realloc(4),ra(this.buf,t,this.pos),this.pos+=4},writeFixed64:function(t){this.realloc(8),ra(this.buf,t&-1,this.pos),ra(this.buf,Math.floor(t*E1),this.pos+4),this.pos+=8},writeSFixed64:function(t){this.realloc(8),ra(this.buf,t&-1,this.pos),ra(this.buf,Math.floor(t*E1),this.pos+4),this.pos+=8},writeVarint:function(t){if(t=+t||0,t>268435455||t<0){cC(t,this);return}this.realloc(4),this.buf[this.pos++]=t&127|(t>127?128:0),!(t<=127)&&(this.buf[this.pos++]=(t>>>=7)&127|(t>127?128:0),!(t<=127)&&(this.buf[this.pos++]=(t>>>=7)&127|(t>127?128:0),!(t<=127)&&(this.buf[this.pos++]=t>>>7&127)))},writeSVarint:function(t){this.writeVarint(t<0?-t*2-1:t*2)},writeBoolean:function(t){this.writeVarint(!!t)},writeString:function(t){t=String(t),this.realloc(t.length*4),this.pos++;var e=this.pos;this.pos=SC(this.buf,t,this.pos);var n=this.pos-e;n>=128&&A1(e,n,this),this.pos=e-1,this.writeVarint(n),this.pos+=n},writeFloat:function(t){this.realloc(4),Zd.write(this.buf,t,this.pos,!0,23,4),this.pos+=4},writeDouble:function(t){this.realloc(8),Zd.write(this.buf,t,this.pos,!0,52,8),this.pos+=8},writeBytes:function(t){var e=t.length;this.writeVarint(e),this.realloc(e);for(var n=0;n<e;n++)this.buf[this.pos++]=t[n]},writeRawMessage:function(t,e){this.pos++;var n=this.pos;t(e,this);var i=this.pos-n;i>=128&&A1(n,i,this),this.pos=n-1,this.writeVarint(i),this.pos+=i},writeMessage:function(t,e,n){this.writeTag(t,ot.Bytes),this.writeRawMessage(e,n)},writePackedVarint:function(t,e){e.length&&this.writeMessage(t,fC,e)},writePackedSVarint:function(t,e){e.length&&this.writeMessage(t,hC,e)},writePackedBoolean:function(t,e){e.length&&this.writeMessage(t,pC,e)},writePackedFloat:function(t,e){e.length&&this.writeMessage(t,_C,e)},writePackedDouble:function(t,e){e.length&&this.writeMessage(t,mC,e)},writePackedFixed32:function(t,e){e.length&&this.writeMessage(t,gC,e)},writePackedSFixed32:function(t,e){e.length&&this.writeMessage(t,vC,e)},writePackedFixed64:function(t,e){e.length&&this.writeMessage(t,yC,e)},writePackedSFixed64:function(t,e){e.length&&this.writeMessage(t,bC,e)},writeBytesField:function(t,e){this.writeTag(t,ot.Bytes),this.writeBytes(e)},writeFixed32Field:function(t,e){this.writeTag(t,ot.Fixed32),this.writeFixed32(e)},writeSFixed32Field:function(t,e){this.writeTag(t,ot.Fixed32),this.writeSFixed32(e)},writeFixed64Field:function(t,e){this.writeTag(t,ot.Fixed64),this.writeFixed64(e)},writeSFixed64Field:function(t,e){this.writeTag(t,ot.Fixed64),this.writeSFixed64(e)},writeVarintField:function(t,e){this.writeTag(t,ot.Varint),this.writeVarint(e)},writeSVarintField:function(t,e){this.writeTag(t,ot.Varint),this.writeSVarint(e)},writeStringField:function(t,e){this.writeTag(t,ot.Bytes),this.writeString(e)},writeFloatField:function(t,e){this.writeTag(t,ot.Fixed32),this.writeFloat(e)},writeDoubleField:function(t,e){this.writeTag(t,ot.Fixed64),this.writeDouble(e)},writeBooleanField:function(t,e){this.writeVarintField(t,!!e)}};function aC(t,e,n){var i=n.buf,o,r;if(r=i[n.pos++],o=(r&112)>>4,r<128||(r=i[n.pos++],o|=(r&127)<<3,r<128)||(r=i[n.pos++],o|=(r&127)<<10,r<128)||(r=i[n.pos++],o|=(r&127)<<17,r<128)||(r=i[n.pos++],o|=(r&127)<<24,r<128)||(r=i[n.pos++],o|=(r&1)<<31,r<128))return lC(t,o,e);throw new Error("Expected varint not more than 10 bytes")}function ir(t){return t.type===ot.Bytes?t.readVarint()+t.pos:t.pos+1}function lC(t,e,n){return n?e*4294967296+(t>>>0):(e>>>0)*4294967296+(t>>>0)}function cC(t,e){var n,i;if(t>=0?(n=t%4294967296|0,i=t/4294967296|0):(n=~(-t%4294967296),i=~(-t/4294967296),n^4294967295?n=n+1|0:(n=0,i=i+1|0)),t>=18446744073709552e3||t<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");e.realloc(10),dC(n,i,e),uC(i,e)}function dC(t,e,n){n.buf[n.pos++]=t&127|128,t>>>=7,n.buf[n.pos++]=t&127|128,t>>>=7,n.buf[n.pos++]=t&127|128,t>>>=7,n.buf[n.pos++]=t&127|128,t>>>=7,n.buf[n.pos]=t&127}function uC(t,e){var n=(t&7)<<4;e.buf[e.pos++]|=n|((t>>>=3)?128:0),t&&(e.buf[e.pos++]=t&127|((t>>>=7)?128:0),t&&(e.buf[e.pos++]=t&127|((t>>>=7)?128:0),t&&(e.buf[e.pos++]=t&127|((t>>>=7)?128:0),t&&(e.buf[e.pos++]=t&127|((t>>>=7)?128:0),t&&(e.buf[e.pos++]=t&127)))))}function A1(t,e,n){var i=e<=16383?1:e<=2097151?2:e<=268435455?3:Math.floor(Math.log(e)/(Math.LN2*7));n.realloc(i);for(var o=n.pos-1;o>=t;o--)n.buf[o+i]=n.buf[o]}function fC(t,e){for(var n=0;n<t.length;n++)e.writeVarint(t[n])}function hC(t,e){for(var n=0;n<t.length;n++)e.writeSVarint(t[n])}function _C(t,e){for(var n=0;n<t.length;n++)e.writeFloat(t[n])}function mC(t,e){for(var n=0;n<t.length;n++)e.writeDouble(t[n])}function pC(t,e){for(var n=0;n<t.length;n++)e.writeBoolean(t[n])}function gC(t,e){for(var n=0;n<t.length;n++)e.writeFixed32(t[n])}function vC(t,e){for(var n=0;n<t.length;n++)e.writeSFixed32(t[n])}function yC(t,e){for(var n=0;n<t.length;n++)e.writeFixed64(t[n])}function bC(t,e){for(var n=0;n<t.length;n++)e.writeSFixed64(t[n])}function Xd(t,e){return(t[e]|t[e+1]<<8|t[e+2]<<16)+t[e+3]*16777216}function ra(t,e,n){t[n]=e,t[n+1]=e>>>8,t[n+2]=e>>>16,t[n+3]=e>>>24}function C1(t,e){return(t[e]|t[e+1]<<8|t[e+2]<<16)+(t[e+3]<<24)}function wC(t,e,n){for(var i="",o=e;o<n;){var r=t[o],s=null,a=r>239?4:r>223?3:r>191?2:1;if(o+a>n)break;var l,c,d;a===1?r<128&&(s=r):a===2?(l=t[o+1],(l&192)===128&&(s=(r&31)<<6|l&63,s<=127&&(s=null))):a===3?(l=t[o+1],c=t[o+2],(l&192)===128&&(c&192)===128&&(s=(r&15)<<12|(l&63)<<6|c&63,(s<=2047||s>=55296&&s<=57343)&&(s=null))):a===4&&(l=t[o+1],c=t[o+2],d=t[o+3],(l&192)===128&&(c&192)===128&&(d&192)===128&&(s=(r&15)<<18|(l&63)<<12|(c&63)<<6|d&63,(s<=65535||s>=1114112)&&(s=null))),s===null?(s=65533,a=1):s>65535&&(s-=65536,i+=String.fromCharCode(s>>>10&1023|55296),s=56320|s&1023),i+=String.fromCharCode(s),o+=a}return i}function xC(t,e,n){return Mb.decode(t.subarray(e,n))}function SC(t,e,n){for(var i=0,o,r;i<e.length;i++){if(o=e.charCodeAt(i),o>55295&&o<57344)if(r)if(o<56320){t[n++]=239,t[n++]=191,t[n++]=189,r=o;continue}else o=r-55296<<10|o-56320|65536,r=null;else{o>56319||i+1===e.length?(t[n++]=239,t[n++]=191,t[n++]=189):r=o;continue}else r&&(t[n++]=239,t[n++]=191,t[n++]=189,r=null);o<128?t[n++]=o:(o<2048?t[n++]=o>>6|192:(o<65536?t[n++]=o>>12|224:(t[n++]=o>>18|240,t[n++]=o>>12&63|128),t[n++]=o>>6&63|128),t[n++]=o&63|128)}return n}const MC=oC(rC),TC=1,yp={1:({pbf:t})=>t.readBoolean(),2:({pbf:t})=>t.readDouble(),3:({pbf:t})=>t.readString(),5:t=>{const{pbf:e}=t,n=e.readVarint(),i=new Array(n);for(let o=0;o<n;o++)i[o]=bp(t,e.readVarint());return i},4:t=>{const{pbf:e}=t,n=e.readVarint(),i={};for(let r=0;r<n;r++){var o=e.readVarint();i[t.keys[o>>3]]=bp(t,o&7)}return i},6:t=>null};function bp(t,e){const n=t.pbf;if(n.pos<n.length){const i=yp[e];if(!i)throw new Error(`Type ${e} is not supported`);return i(t)}}function P1(t){const e=t.readVarint(),n=[];for(let i=0;i<e;i++){const o=t.readString(),r=t.readVarint();n.push({key:o,type:r})}return n}function IC(t,e){if(!t||!t.byteLength||t.byteLength<4)throw new Error("Bad array or insufficient array length.");const n=new MC(t),i=n.readFixed32(),o=i>>24&255;if(o>TC)throw new Error(`Version ${o} is not supported`);const r=i>>16&255,s=r;if(r===1&&s!==1)throw new Error("Packed with PackMethod.Generic cannot be unpacked with anything than UnpackMethod.Generic");switch(s){case 1:const a=n.readFixed32();if(a>=t.byteLength)return;const l=n.pos;n.pos=a;const c=n.readVarint(),d=new Array(c);for(let f=0;f<c;f++)d[f]=n.readString();n.pos=l;const u=n.readVarint();return bp({keys:d,pbf:n},u);case 2:{const f={keys:[],pbf:n},h=n.readFixed32(),_=P1(n),p={};for(const{key:m,type:g}of _){const y=yp[g],b=[];for(let v=0;v<h;v++)b.push(y(f));p[m]=b}return p}case 3:{const f={keys:[],pbf:n},h=n.readFixed32(),_=P1(n),p=new Array(h);for(let m=0;m<h;m++)p[m]={};for(const{key:m,type:g}of _){const y=yp[g];for(let b=0;b<h;b++)p[b][m]=y(f)}return p}default:throw new Error(`Method ${s} is not supported`)}}function Tb(t){const e=new K0;if(t instanceof ArrayBuffer){const n=IC(t);if(Array.isArray(n))for(const{id:i,...o}of n)e.set(i,o);else for(const i in n)e.set(i,n[i])}else for(const n in t)e.set(n,t[n]);return e}class EC{constructor(e){this.scope=e,this.tileLoader=new EA,this.tileAttrs=[],this.models={},this.featureStateMap=new K0}fetchTile(e,n=3){return this.tileLoader.fetch(e,n)}abortTileRequest(e){this.tileLoader.abortRequest(e)}generateTile(e,n){const{styleManager:i,collector:o,metatiles:r}=this.scope,{tileInfo:s,promoteAttributes:a,promoteId:l,isCustomZenithSource:c,modelShowHideEventsSublayers:d}=e,u=Ge(s.coords),f=this.tileLoader.get(u),h=[],_=[],p=[],m={};return f.forEach(g=>{var x;const{regionId:y,metatileHash:b}=g,v=this.scope.styleManager.getStyle(e.styleId);if(!v)return;if(e.areTileBoundsVisible&&e.isDefaultSource){const E=i.getStyle(Kr).layers.find(L=>L.id==="debug-tile-bounds");gb(o,E,e.styleState)}const T=DA(v,i,this.featureStateMap,o,e,g,r[b],this.tileAttrs,c,a,n,l,d);Object.assign(m,T.promotedObjectAttributes),h.push({regionId:y,metatileHash:b,collectorOutput:T,styleId:v.id}),p.push(...T.transferable),(x=T.debugGeoJsonData)==null||x.forEach(I=>_.push(I))}),this.scope.resetCollector(),this.scope.syncRasterSets(),Promise.resolve({results:h,transferable:p,promotedAttrs:Object.keys(m).length>0?m:void 0,geoJsonData:n?_:void 0})}deleteTile(e){this.tileLoader.delete(e)}setFeatureStateMap(e){this.featureStateMap=Tb(e)}generateModel(e){const{regionId:n,metatileHash:i,styleId:o,url:r,id:s}=e,{styleManager:a}=this.scope;return new Promise(l=>{const c=this.models[s];(c?Promise.resolve(c):new Promise(u=>{q0({url:r},(f,h)=>{if(f||h.byteLength===0){const _=this.models[s]=new ArrayBuffer(0);u(_)}else this.models[s]=h,u(h)})})).then(u=>{if(u.byteLength===0){l({objects:this.scope.collector.getAccumulatedData(),textures:{isBitmap:!1,data:[]}});return}const f=this.scope.styleManager.getStyle(o);if(!f){l({objects:this.scope.collector.getAccumulatedData(),textures:{isBitmap:!1,data:[]}});return}const{objects:h,textures:_}=eC(f,a,e.styleState,this.scope.collector,u,e,this.scope.metatiles[i],n,this.featureStateMap);if(this.scope.createImageBitmap){const p=_.map(m=>{const g=new Blob([m],{type:"image/png"});return createImageBitmap(g)});Promise.all(p).then(m=>{l({objects:h,textures:{isBitmap:!0,data:m},transferable:[...h.transferable,...m]}),this.scope.resetCollector()})}else l({objects:h,textures:{isBitmap:!1,data:_},transferable:[...h.transferable,u]}),this.scope.resetCollector()})})}destroy(){this.tileLoader.destroy(),this.tileAttrs=[],this.models={}}}function Ib(t,e){if(e===void 0)return;if(e.sourceId){const i=t.getSourceById(e.sourceId);if(!(i!=null&&i.isIdentifiedAsDefault()))return}const n={id:e.id,symbol:e.symbol};return e.symbol==="point"&&(n.isText=e.instanceId===1),e.sublayer&&(n.isCityCommercial=g5(e.sublayer),n.isPremiumCommercial=v5(e.sublayer),n.isCommercial=hh(e.sublayer),n.isPersonal=TI(e.sublayer),(e.symbol==="point"&&!n.isCommercial||e.symbol==="gltfModel")&&(n.sysCode=e.objectClass)),e.center&&(n.center=q.toGeo(e.center)),e.symbol==="gltfModel"&&(n.sublayer=e.sublayer,n.isCommercial=!!e.sublayer&&b5(e.sublayer)),n}function AC(t,e){if(e===void 0)return;if(e.sourceId){const i=t.getSourceById(e.sourceId);if(i)switch(i.type){case"geojson":{if(i.subtype==="internal"&&i instanceof Y0||i.subtype==="viewport-internal"&&i instanceof hb)return{type:"geojson",id:i.isCustomPromoteId?e.id:void 0,feature:i.getFeatureById(e.id,e.tileKey),source:i};if(i.subtype==="external"&&i instanceof TA)return{type:"geojsonTile",getFeatureProperties:()=>e.tileKey===void 0?Promise.resolve():i.getObjectAttributes(e.id,e.tileKey),source:i}}case"zenith":if(i instanceof _b)return{type:"zenith",id:e.id,source:i,attributes:i.getObjectAttributes(e.tileKey??"",e.id)}}}const n={type:"default",id:e.id};return e.floorId&&(n.floorId=e.floorId),n}function No(t,e,n,i,o){const r=o.camera,s=[0,0];if(r.unproject(i,s,!0),e&&e.dynamicObjectId!==void 0){const f=t;let h=o.layers.getDynamicObjectLayers().find(p=>p.uniqId===e.dynamicObjectId);if(h!=null&&h.parentObject&&(h=h==null?void 0:h.parentObject),!h)return;const _={lngLat:s,originalEvent:n,point:i,targetData:h};h.emit(f,_);return}const a=Ib(o.sourceStorage,e),l=AC(o.sourceStorage,e);if((t==="mousedown"||t==="click")&&e!==void 0&&(a==null?void 0:a.symbol)==="point"&&l!==void 0){const f=C8(o,e,a)||{};f!==void 0&&(l.poiIcon=f)}if(e){const f=o.styleManager.getStyleLayer(e.styleId,e.layerId);f&&l&&(l.layerId=f.id)}const d={lngLat:s,originalEvent:n,point:i,target:a,targetData:l},u=t;o.map.emit(u,d)}class CC extends Kc{constructor(e,n,i){super(e,n),this.start=o=>{const{modules:r,container:s}=this,{camera:a}=r;if(o.button!==0)return;const l=rn(s,o.clientX,o.clientY);this.contains(l)&&(r.handler.block(),r.mouseMoveHandler.block(),this.dragStartCursorPoint=l,this.dragStartAnchorPoint=a.project(q.toGeo(this.getPosition())),document.addEventListener("mouseup",this.stop),document.addEventListener("mousemove",this.move),this.emitEvent("dragstart",o))},this.move=o=>{const{camera:r}=this.modules,{dragStartAnchorPoint:s,dragStartCursorPoint:a,container:l}=this;if(s===void 0||a===void 0)return;const c=rn(l,o.clientX,o.clientY),d=_x(s);Qi(d,d,c),ti(d,d,a),this.setPosition(q.fromGeo(r.unproject(d))),this.emitEvent("drag",o)},this.stop=o=>{if(o.button!==0)return;this.dragStartCursorPoint=void 0,this.dragStartAnchorPoint=void 0,document.removeEventListener("mouseup",this.stop),document.removeEventListener("mousemove",this.move);const{modules:r}=this;r.handler.unblock(),r.mouseMoveHandler.unblock(),this.emitEvent("dragend",o),this.interactive&&r.identifier.resetCache()},this.container=e.modules.layout.mapContainer,i&&this.container.addEventListener("mousedown",this.start,!0)}destroy(){super.destroy(),this.container.removeEventListener("mousedown",this.start,!0),document.removeEventListener("mouseup",this.stop),document.removeEventListener("mousemove",this.move)}emitEvent(e,n){const i=this.getPosition(),o=q.toGeo(i),r=this.modules.camera.flat.project(i),s=this.modules.identifier.searchSync(r),a=s!==void 0&&s.dynamicObjectId===void 0?Ib(this.modules.sourceStorage,s):void 0;this.emit(e,{originalEvent:n,target:a,targetData:this,lngLat:o,point:r})}}const PC=!1;let LC=class extends CC{constructor(e,n){super(e,n,n.draggable??PC),this.visible=!0,this.options=n;const i=q.fromGeo(this.options.coordinates);this.position={userValue:i,normalizedValue:$r(i)};const{dynamicStyle:o,collector:r,tileManager:s,identifier:a,layers:l}=this.modules;if(this.layer=qi({type:"circle",id:`dynamic-circleMarker-${this.uniqId}`,minzoom:this.options.minZoom,maxzoom:this.options.maxZoom,style:{color:this.options.color,strokeColor:this.options.borderColor,strokeColor2:this.options.border2Color,width:this.options.width,strokeWidth:this.options.borderWidth,strokeWidth2:this.options.border2Width}}),!this.layer)return;o.addLayer(this.layer,this.options.zIndex);const c=i[2]??0,d=Um(this.position.normalizedValue),u=mh({}),f={x:[0],y:[0],z:[c]},h=Ct(d),_=Zo(this.mapState.styleState,ul,Ho,u,Wc,this.interactive?"0":"",h);vr(this.layer,_),io({collector:r,generator:Ja.generate,args:[o.getStyle().id,this.layer,_,f]});const p=r.getAccumulatedData(),m=new bi("dynamicObject",p.data,this.modules,this.mapState,d);s.addObject(m),this.tileObjects.push(m),this.interactive&&this.identifyIds.push(p.identifyIds),l.addLayer(this),r.reset(),this.modules.renderer.addRerenderEvent(),this.interactive&&a.resetCache()}remove(){this.layer&&this.modules.dynamicStyle.removeLayer(this.layer.innerId),this.interactive&&this.modules.identifier.resetCache(),super.destroy()}update(){if(this.mapState.globeMode){const{tileManager:e}=this.modules,n=this.modules.camera.ecef.canSee(this.options.coordinates);this.visible&&!n?this.tileObjects.forEach(i=>e.removeObject(i)):!this.visible&&n&&this.tileObjects.forEach(i=>e.addObject(i)),this.visible=n}}isOutOfMainReplica(){return!1}setPosition(e){const n=this.tileObjects[0];n!==void 0&&(this.position={userValue:e,normalizedValue:$r(e)},n.setTileCoords(Um(this.position.normalizedValue),this.mapState),this.modules.renderer.addRerenderEvent())}getPosition(){return this.position.userValue}contains(e){if(!this.layer)return!1;const{layer:n}=this,{camera:i}=this.modules,o=i.project(q.toGeo(this.position.normalizedValue)),r=K(n.style.width,ht(this.mapState.styleZoom,this.mapState.styleState,[])),s=K(n.style.strokeWidth,ht(this.mapState.styleZoom,this.mapState.styleState,[])),a=r/2+s;return Ur(o,e)<=a}};function FC(t,e,n){const{top:i,right:o,bottom:r,left:s}=t.viewport,{clientWidth:a,clientHeight:l}=e;t.size=[Math.max(1,a-s-o),Math.max(1,l-i-r)],n.updateFrameBuffersSize()}const kC=(t,e,n)=>{xt("viewport",{step:(i,o)=>{i.viewport={top:o[0],right:o[1],bottom:o[2],left:o[3]},FC(i,e,n)}},t)};function RC(t,e){const{top:n,right:i,bottom:o,left:r}=t.padding;t.padding={top:n,right:i,bottom:o,left:r},e.addRerenderEvent(),e.updateFrameBuffersSize()}const zC=(t,e)=>{xt("padding",{step:(n,i)=>{n.padding={top:i[0],right:i[1],bottom:i[2],left:i[3]},RC(n,e)}},t)},ph="inertia",BC=(t,e,n)=>t*Math.pow(1-(n-e)/pr.duration,pr.nonLinearity),OC=(t,e,n,i,o)=>{At(ph,{easing:"inertia"},t,0,o,pr.duration,1,{startPoint:e,startSpeed:n,direction:i,startTime:t.time})},tg=It.bind(null,ph),DC=(t,e)=>{xt(ph,{step:(n,i,o)=>{const{startPoint:r,startSpeed:s,startTime:a,direction:l}=o,c=Fa(l);ni(c,c,i),jt(c,c,r),n.loopWorld?Wx(n.maxBounds,c)||(p_(e,n),$a(c,n.maxBounds,c)):$x(n.maxBounds,c)||(p_(e,n),$a(c,n.maxBounds,c)),n.center=c,n.zoomTypePreserving==="zoom"?n.styleZoom=Ws(n.zoom,c):n.zoom=nh(n.styleZoom,c);const d=BC(s,a,n.time);f3(d,n.zoom)<pr.minSpeed&&p_(e,n)}},t)},p_=(t,e)=>{It(ph,e),t.classList.remove("mapgl-inertia")},Pf="center",Qc=(t,e,n={})=>{if(It(Pf,t),tg(t),$a(e,t.maxBounds,e),n.animate===!1||n.duration===0)t.center=e,t.zoomTypePreserving==="zoom"?t.styleZoom=Ws(t.zoom,e):t.zoom=nh(t.styleZoom,e);else{const i=n.easing!==void 0?n.easing:"linear",o=n.duration!==void 0?n.duration:250;At(Pf,{easing:i},t,t.center,e,o,1)}},NC=It.bind(null,Pf),UC=xt.bind(null,Pf,{step:(t,e)=>{t.center=e,t.zoomTypePreserving==="zoom"?t.styleZoom=Ws(t.zoom,e):t.zoom=nh(t.styleZoom,e)}}),Lf="rotation";function wp(t,e){return t=t-e,t>=Math.PI?t=(t+Math.PI)%(Math.PI*2)-Math.PI:t<-Math.PI&&(t=Math.PI-(Math.PI-t)%(Math.PI*2)),t=t+e,t}function ng(t,e,n={}){if(It(Lf,t),n.animate===!1||n.duration===0)t.rotation=wp(e,0);else{const i=n.normalize!==void 0?n.normalize:!0;At(Lf,{easing:n.easing||"linear"},t,t.rotation,i?wp(e,t.rotation):e,n.duration||250,1)}}const GC=It.bind(null,Lf),HC=xt.bind(null,Lf,{step:(t,e)=>t.rotation=wp(e,0)}),Ff="pitch";function Eb(t,e,n={}){It(Ff,t);const i=Ve(e,t.minPitch,t.maxPitch);n.animate===!1||n.duration===0?t.pitch=i:At(Ff,{easing:n.easing||"linear"},t,t.pitch,i,n.duration||300,1)}const VC=It.bind(null,Ff),jC=xt.bind(null,Ff,{step:(t,e)=>t.pitch=e}),kf="zoom",vl=(t,e,n={})=>{It(kf,t);const i=Ve(e,t.minZoom,t.maxZoom);if(i!==t.zoom)if(n.animate===!1||n.duration===0)n.zoomPoint&&(jt(t.center,t.center,$c(t,n.zoomPoint,{zoom:i})),$a(t.center,t.maxBounds,t.center)),t.zoom=i,t.styleZoom=Ws(i,t.center);else{const o=n.useHeightForAnimation?ks(t.zoom,t.size):t.zoom,r=n.useHeightForAnimation?ks(i,t.size):i,s=n.easing!==void 0?n.easing:"easeOutCubic",a=n.duration!==void 0?n.duration:250;At(kf,{easing:s},t,o,r,a,1,{zoomPoint:n.zoomPoint,useHeightForAnimation:!!n.useHeightForAnimation})}},Ab=It.bind(null,kf),$C=xt.bind(null,kf,{step:(t,e,n={})=>{const i=n&&n.useHeightForAnimation?dS(e,t.size):e;n&&n.zoomPoint&&(jt(t.center,t.center,$c(t,n.zoomPoint,{zoom:i})),$a(t.center,t.maxBounds,t.center)),t.zoom=i,t.styleZoom=Ws(i,t.center)}}),WC=navigator.msPointerEnabled&&navigator.msMaxTouchPoints&&!window.PointerEvent,ZC=window.PointerEvent&&navigator.pointerEnabled&&navigator.maxTouchPoints||WC,XC=ZC||"ontouchstart"in window||window.DocumentTouch&&document instanceof window.DocumentTouch,YC=Hs("webkit"),qC=Hs("chrome")||Hs("crios"),KC="ActiveXObject"in window,JC=!qC&&Hs("safari");Hs("gecko")&&!YC&&window.opera;const Qu=navigator.platform.toUpperCase().indexOf("MAC")>=0,QC=Hs("windows"),eP=Hs("firefox");function Hs(t){return navigator.userAgent.toLowerCase().indexOf(t)>=0}function yl(t,e){let n=!1,i;function o(){n=!1,i&&(r(...i),i=!1)}function r(...s){n?i=s:(t(...s),setTimeout(o,e),n=!0)}return r}function qo(t){Ab(t),NC(t),GC(t),VC(t),tg(t)}class tP{constructor(e,n){this.onWheelScroll=i=>{i.preventDefault(),!(i.deltaMode===void 0&&i.deltaY===void 0)&&(this.state.userHasInteracted=!0,this.screenPoint=rn(this.container,i.clientX,i.clientY),i.ctrlKey?this.deltaAccumulator-=i.deltaY*10:i.deltaMode===1?this.deltaAccumulator-=i.deltaY*20:this.deltaAccumulator-=i.deltaY,this.eventCount+=1)},this.startZooming=()=>{const i=this.state;let o=this.getDelta();Qu?o*=Ri.macWheelDeltaToZoomDelta:Number.isInteger(o)?o=oh(o)*Ri.wheelZoomDelta:o*=Ri.notMacTrackpadDeltaToZoomDelta;const r=i.zoom+o,s=Ve(r,i.minZoom,i.maxZoom);s!==i.zoom&&(qo(i),vl(i,s,{duration:Ri.animDuration,animate:!Qu,zoomPoint:i.keepCenterWhileUserZoomRotate?void 0:this.screenPoint}))},this.stop=()=>{this.state.userHasInteracted=!0,Ab(this.state)},this.state=e,this.container=n,Qu||(this.startZooming=yl(this.startZooming,Ri.throttleDelay)),this.deltaAccumulator=0,this.eventCount=0,this.screenPoint=[0,0],this.container.addEventListener("wheel",this.onWheelScroll),this.container.addEventListener("mousedown",this.stop)}destroy(){this.container.removeEventListener("wheel",this.onWheelScroll),this.container.removeEventListener("mousedown",this.stop)}update(){this.eventCount!==0&&(this.startZooming(),this.state.rerenderEvents.push({type:"coreNeedRerender"}))}getDelta(){const e=this.deltaAccumulator/this.eventCount;return this.deltaAccumulator=0,this.eventCount=0,e}}class nP{constructor(e,n){this.onMouseUp=i=>{i.which===1&&this.start()},this.onTouchEnd=i=>{i.touches.length===0&&this.start()},this.start=()=>{const i=this.state;i.userHasInteracted=!0;const o=this.getCurrentSpeed(i.time),r=Gr(o);if(f3(r,i.zoom)<=pr.minSpeed)return;const a=w0(pr.maxSpeed,i.zoom),l=Math.min(r,a),c=this.calcDistanceByStartSpeed(l),d=Fa(i.center),u=Ke();_n(u,o),OC(i,d,l,u,c),this.container.classList.add("mapgl-inertia")},this.stop=()=>{tg(this.state),this.container.classList.remove("mapgl-inertia"),this.times=[],this.positions=[]},this.state=e,this.container=n,this.container.addEventListener("mouseup",this.onMouseUp),this.container.addEventListener("mousedown",this.stop),XC&&(this.container.addEventListener("touchend",this.onTouchEnd),this.container.addEventListener("touchstart",this.stop)),this.zoomDiffer=new Kt([{path:"zoom",type:"number"}]),this.styleZoomDiffer=new Kt([{path:"styleZoom",type:"number"}]),this.centerDiffer=new Kt([{path:"center",type:"vec2"}]),this.times=[],this.positions=[]}destroy(){this.container.removeEventListener("mouseup",this.onMouseUp),this.container.removeEventListener("mousedown",this.stop),this.container.removeEventListener("touchend",this.onTouchEnd),this.container.removeEventListener("touchstart",this.stop)}update(){const e=this.state;this.centerDiffer.check(e)&&this.rememberTimeAndPosition(e),(e.zoomTypePreserving==="zoom"?this.zoomDiffer.check(e):this.styleZoomDiffer.check(e))&&this.stop()}removeOldRecords(e){for(;e-this.times[0]>100&&this.times.length;)this.times.shift(),this.positions.shift()}rememberTimeAndPosition(e){const n=e.time;this.removeOldRecords(n),this.times.push(n),this.positions.push(Fa(e.center))}getCurrentSpeed(e){if(this.removeOldRecords(e),this.times.length<2)return Ke();const n=Fa(this.positions[this.positions.length-1]);return $t(n,n,this.positions[0]),ni(n,n,1/(this.times[this.times.length-1]-this.times[0])),n}calcDistanceByStartSpeed(e){return e*pr.duration/(pr.nonLinearity+1)}}class iP{constructor(e){this.emitMouseEvent=n=>{const i=rn(this.container,n.clientX,n.clientY);this.emitEvent(n,i)},this.emitTouchEvent=n=>{const i=rn(this.container,n.changedTouches[0].clientX,n.changedTouches[0].clientY);this.emitEvent(n,i)},this.container=e.layout.mapContainer,this.modules=e,this.container.addEventListener("mouseup",this.emitMouseEvent),this.container.addEventListener("touchend",this.emitTouchEvent)}destroy(){this.container.removeEventListener("mouseup",this.emitMouseEvent),this.container.removeEventListener("touchend",this.emitTouchEvent)}update(){}emitEvent(e,n){if(!this.modules.layout.isActionWithCanvas(e))return;const i=e.type;this.modules.identifier.search(i,n).then(o=>{No(i,o,e,n,this.modules)})}}class oP{constructor(e,n,i){this.rotationDetected=!1,this.onGestureStart=o=>{o.preventDefault(),this.startRotation=this.state.rotation,this.rotationDetected=!1,this.gestureRotation=0,this.isGestureStart=!0,this.startZoom=this.state.zoom,this.screenPoint=rn(this.container,o.clientX,o.clientY),this.state.userHasInteracted=!0,this.state.disableRotationByUserInteraction||this.container.classList.add("mapgl-rotating"),this.map.emit("interactionstart",{target:"zoom/rotation"})},this.onGestureEnd=o=>{o.preventDefault(),this.isGestureStart&&(this.isGestureStart=!1,this.state.userHasInteracted=!0,this.container.classList.remove("mapgl-rotating"),this.map.emit("interactionend",{target:"zoom/rotation"}))},this.onGestureChange=o=>{if(o.preventDefault(),this.state.userHasInteracted=!0,o.scale>1?this.gestureZoom=o.scale-1:this.gestureZoom=-1/o.scale+1,this.state.disableRotationByUserInteraction)return;const r=Be(o.rotation);!this.rotationDetected&&Math.abs(r)>this.state.touchRotationThreshold&&(this.rotationDetected=!0,this.startRotation=this.state.rotation-r),this.rotationDetected&&(this.gestureRotation=r)},this.state=e,this.container=n,this.map=i,this.isGestureStart=!1,this.gestureRotation=0,this.gestureZoom=0,this.screenPoint=[0,0],this.startRotation=0,this.startZoom=0,this.container.addEventListener("gesturestart",this.onGestureStart),this.container.addEventListener("gestureend",this.onGestureEnd),this.container.addEventListener("gesturechange",this.onGestureChange)}destroy(){this.container.removeEventListener("gesturestart",this.onGestureStart),this.container.removeEventListener("gestureend",this.onGestureEnd),this.container.removeEventListener("gesturechange",this.onGestureChange)}update(){if(this.gestureRotation===0&&this.gestureZoom===0)return;const e=this.state,n=this.startZoom+this.gestureZoom,i=this.startRotation+this.gestureRotation,o=Ke(),r=e.keepCenterWhileUserZoomRotate?Ke():$c(e,this.screenPoint,{zoom:n,rotation:i});jt(o,e.center,r),qo(e),Qc(e,o,{animate:!1}),vl(e,n,{animate:!1}),e.disableRotationByUserInteraction||ng(e,i,{animate:!1}),this.gestureRotation=0,this.gestureZoom=0}}class rP extends pl{constructor(e,n){super(),this.startRenderTime=0,this.catchNextUpdate=!1,this.durations=[],this.badDurations=[],this.countToCheck=75,this.slowFrameTime=100,this.mapState=e,this.mapModules=n,this.originalMapState={center:this.mapState.center.slice(),zoom:this.mapState.zoom,rotation:this.mapState.rotation,pitch:this.mapState.pitch}}update(){const{time:e,needRerender:n,rerenderEvents:i}=this.mapState,o=e-this.startRenderTime;this.catchNextUpdate&&(this.durations.push(o),o>=this.slowFrameTime&&this.badDurations.push(o),this.catchNextUpdate=!1),(n||i.length>0)&&(this.startRenderTime=e,this.catchNextUpdate=!0),this.durations.length>this.countToCheck&&this.check()}getFpsStats(){const e=this.durations.map(r=>1e3/r),n=this.badDurations.map(r=>1e3/r),i=h3(this.originalMapState.center,this.mapState.center)&&this.originalMapState.pitch===this.mapState.pitch&&this.originalMapState.rotation===this.mapState.rotation&&this.originalMapState.zoom===this.mapState.zoom;return{all:{min:e.length>0?Math.min(...e):0,max:e.length>0?Math.max(...e):0,avg:e.length>0?e.reduce((r,s)=>r+s)/e.length:0,count:e.length},bad:{min:n.length>0?Math.min(...n):0,max:n.length>0?Math.max(...n):0,avg:n.length>0?n.reduce((r,s)=>r+s)/n.length:0,count:n.length},isStatic:i}}async getMemoryStats(){const e=await this.getJsMemoryStats(),n=await this.getGpuMemoryStats();return{cpu:e,gpu:n}}check(){const e=sP(this.durations);this.emit("fps",e),e<nS.fpsCaveat&&(this.mapState.performanceCaveatEmitted=!0,this.emit("performancecaveat")),this.durations=[],this.badDurations=[],this.countToCheck=Math.min(1e3,this.countToCheck*2)}async getJsMemoryStats(){const e=await Af(this.mapModules);return Object.values(e).filter(o=>!!o.js).map(o=>o.js).reduce((o,r)=>o+r["--sum"],0)}async getGpuMemoryStats(){const e=await Af(this.mapModules);return Object.values(e).filter(o=>!!o.gpu).map(o=>o.gpu).reduce((o,r)=>o+r["--sum"],0)}}function sP(t){t.sort((n,i)=>n-i);const e=t[Math.floor(t.length*3/4)];return Math.round(1e3/e)}class aP{constructor(){this.differ=new Kt([{path:"center",type:"vec2"},{path:"zoom",type:"number"},{path:"rotation",type:"number"},{path:"pitch",type:"number"}]),this.debouncedSet=ki(e=>{At("stillness",{},e,e.stillness,1,400,1)},100,!1),this.stillnessTickerUpdate=xt.bind(null,"stillness",{step:(e,n)=>{e.stillness=n}})}update(e){this.differ.check(e)&&(e.stillness=0,It("stillness",e),this.debouncedSet(e)),this.stillnessTickerUpdate(e)}}class lP{constructor(e){this.onTouchStart=()=>{this.isTouchStartEmitted=!0},this.onMouseOut=n=>{if(!this.prevGeo)return;const i=rn(this.container,n.clientX,n.clientY);No("mouseout",this.prevGeo,n,i,this.modules),this.prevGeo=void 0,this.skipIdentifyEvents=!0,this.modules.defaultSource.resetHoverId(),this.container.classList.remove("mapgl-hover")},this.onMouseMove=n=>{if(this.isTouchStartEmitted){this.isTouchStartEmitted=!1;return}if(this.skipIdentifyEvents=!1,this.isBlocked)return;const i=rn(this.container,n.clientX,n.clientY);Promise.resolve().then(()=>this.modules.layout.isActionWithCanvas(n)?this.modules.identifier.search("mouseMove",i):void 0).then(o=>{if(this.skipIdentifyEvents)return;const r=o&&this.prevGeo&&(o.id!==this.prevGeo.id||o.instanceId!==this.prevGeo.instanceId||o.dynamicObjectId!==this.prevGeo.dynamicObjectId||o.symbol!==this.prevGeo.symbol);this.prevGeo&&(!o||r)&&(No("mouseout",this.prevGeo,n,i,this.modules),this.prevGeo=void 0,this.container.classList.remove("mapgl-hover"),this.modules.defaultSource.resetHoverId()),o&&(!this.prevGeo||r)&&(this.prevGeo=o,this.container.classList.add("mapgl-hover"),No("mouseover",o,n,i,this.modules),this.modules.defaultSource.setHoverId(o.id)),No("mousemove",o,n,i,this.modules)})},this.modules=e,this.isTouchStartEmitted=!1,this.skipIdentifyEvents=!1,this.isBlocked=!1,this.prevGeo=void 0,this.container=this.modules.layout.mapContainer,this.container.addEventListener("touchstart",this.onTouchStart),this.container.addEventListener("mousemove",this.onMouseMove),this.container.addEventListener("mouseout",this.onMouseOut)}destroy(){this.container.removeEventListener("touchstart",this.onTouchStart),this.container.removeEventListener("mousemove",this.onMouseMove),this.container.removeEventListener("mouseout",this.onMouseOut)}update(){}block(){this.isBlocked=!0}unblock(){this.isBlocked=!1}}const L1=(t,e,n,i)=>{It("buildingHeight"+i,t),n.animate===!1||n.duration===0?(e.set(i,n.to),t.needLabeling=!0):At("buildingHeight"+i,{easing:n.easing},t,n.from,n.to,n.duration,1)},cP=(t,e,n)=>xt.call(null,"buildingHeight"+n,{step:(i,o)=>e.set(n,o),complete:i=>i.needLabeling=!0},t),dP=16;class uP{constructor(e,n){this.state=e,this.modules=n,this.buildingHeights=new Map,this.minZoomBuildingHeight=1/0}getBuildingHeight(e){return e===-1/0?1:e!==void 0?(this.buildingHeights.has(e)||this.addBuildingHeightZoom(e),this.buildingHeights.get(e)||0):this.getDefaultBuildingHeight()}update(){this.buildingHeights.forEach((e,n)=>{this.updateByZoom(n,e),this.isAnimating()&&cP(this.state,this.buildingHeights,n)})}isAnimating(){return Array.from(this.buildingHeights.keys()).some(e=>Ic("buildingHeight"+e,this.state)!==void 0)}clearBuildingHeights(){this.buildingHeights.clear(),this.minZoomBuildingHeight=1/0}getDefaultBuildingHeight(){const e=this.minZoomBuildingHeight!==1/0?this.minZoomBuildingHeight:dP;return this.state.styleZoom<e?0:1}updateByZoom(e,n){const i=this.state,o=Ic("buildingHeight"+e,i),r=o!==void 0?o.to:n;i.styleZoom>=e&&this.modules.tileManager.viewportTilesReady()&&r!==1?L1(i,this.buildingHeights,{animate:!0,easing:Wa.easing,from:n,to:1,duration:Wa.duration*(1-n)},e):i.styleZoom<e&&r!==0&&L1(i,this.buildingHeights,{animate:!1,to:0},e)}addBuildingHeightZoom(e){const n=e<this.state.styleZoom?0:1;this.buildingHeights.set(e,n),this.minZoomBuildingHeight>e&&(this.minZoomBuildingHeight=e)}}const Rf=.8;class fP{constructor(e,n){this.offset=0,this.stride=n,this.buffer=new ArrayBuffer(e),this.view=new Int32Array(this.buffer),this.comittedOffsets=0,this.maximum=e/n,this.watermark=this.maximum*Rf}extend(){const e=this.buffer.byteLength*2;this.maximum=e/this.stride,this.watermark=this.maximum*Rf;const n=new ArrayBuffer(e),i=new Int32Array(n);return i.set(this.view),this.buffer=n,this.view=i,n}}class hP{constructor(e){this.offset=0,this.buffer=new Int32Array(e),this.comittedOffsets=0,this.watermark=e*Rf}extend(){const e=this.buffer.length*2;this.watermark=e*Rf;const n=new Int32Array(e);n.set(this.buffer),this.buffer=n}}class F1{constructor(e,n,i,o,r,s){this.objectsData={},this.extents=new Uint16Array([vt,vt,vt,0,0,0]),this.maxDiag=0,this.drawMode=r;const a=e!=="buildingModel"?67200:67200*5,l=qc(e,n);this.elements=new fP(a,l),this.indices=new hP(a*2/l),this.views={},this.binder=o,o(this,this.elements.buffer),this.attributes=i,this.key=s}static generateKey(e){return JSON.stringify(e)}resetOffsets(){this.elements.offset=0,this.elements.comittedOffsets=0,this.indices.offset=0,this.indices.comittedOffsets=0}resetBuildingsData(){this.objectsData={}}resetInstancesExtents(){this.extents[0]=vt,this.extents[1]=vt,this.extents[2]=vt,this.extents[3]=0,this.extents[4]=0,this.extents[5]=0,this.maxDiag=0}commit(){this.elements.comittedOffsets=this.elements.offset,this.indices.comittedOffsets=this.indices.offset}rollback(){this.elements.offset=this.elements.comittedOffsets,this.indices.offset=this.indices.comittedOffsets}checkWatermarks(){let e=0;const n=this.elements;n.offset>n.watermark&&(n.offset>=n.buffer.byteLength/n.stride&&(e=1),this.binder(this,n.extend()));const i=this.indices;return i.offset>i.watermark&&(i.offset>=i.buffer.length&&(e=1),i.extend()),e}}function ei(t,e,n){n=n||{},this.w=t||64,this.h=e||64,this.autoResize=!!n.autoResize,this.shelves=[],this.freebins=[],this.stats={},this.bins={},this.maxId=0}ei.prototype.pack=function(t,e){t=[].concat(t),e=e||{};for(var n=[],i,o,r,s,a=0;a<t.length;a++)if(i=t[a].w||t[a].width,o=t[a].h||t[a].height,r=t[a].id,i&&o){if(s=this.packOne(i,o,r),!s)continue;e.inPlace&&(t[a].x=s.x,t[a].y=s.y,t[a].id=s.id),n.push(s)}return this.shrink(),n};ei.prototype.packOne=function(t,e,n){var i={freebin:-1,shelf:-1,waste:1/0},o=0,r,s,a,l;if(typeof n=="string"||typeof n=="number"){if(r=this.getBin(n),r)return this.ref(r),r;typeof n=="number"&&(this.maxId=Math.max(n,this.maxId))}else n=++this.maxId;for(l=0;l<this.freebins.length;l++){if(r=this.freebins[l],e===r.maxh&&t===r.maxw)return this.allocFreebin(l,t,e,n);e>r.maxh||t>r.maxw||e<=r.maxh&&t<=r.maxw&&(a=r.maxw*r.maxh-t*e,a<i.waste&&(i.waste=a,i.freebin=l))}for(l=0;l<this.shelves.length;l++)if(s=this.shelves[l],o+=s.h,!(t>s.free)){if(e===s.h)return this.allocShelf(l,t,e,n);e>s.h||e<s.h&&(a=(s.h-e)*t,a<i.waste&&(i.freebin=-1,i.waste=a,i.shelf=l))}if(i.freebin!==-1)return this.allocFreebin(i.freebin,t,e,n);if(i.shelf!==-1)return this.allocShelf(i.shelf,t,e,n);if(e<=this.h-o&&t<=this.w)return s=new ig(o,this.w,e),this.allocShelf(this.shelves.push(s)-1,t,e,n);if(this.autoResize){var c,d,u,f;return c=d=this.h,u=f=this.w,(u<=c||t>u)&&(f=Math.max(t,u)*2),(c<u||e>c)&&(d=Math.max(e,c)*2),this.resize(f,d),this.packOne(t,e,n)}return null};ei.prototype.allocFreebin=function(t,e,n,i){var o=this.freebins.splice(t,1)[0];return o.id=i,o.w=e,o.h=n,o.refcount=0,this.bins[i]=o,this.ref(o),o};ei.prototype.allocShelf=function(t,e,n,i){var o=this.shelves[t],r=o.alloc(e,n,i);return this.bins[i]=r,this.ref(r),r};ei.prototype.shrink=function(){if(this.shelves.length>0){for(var t=0,e=0,n=0;n<this.shelves.length;n++){var i=this.shelves[n];e+=i.h,t=Math.max(i.w-i.free,t)}this.resize(t,e)}};ei.prototype.getBin=function(t){return this.bins[t]};ei.prototype.ref=function(t){if(++t.refcount===1){var e=t.h;this.stats[e]=(this.stats[e]|0)+1}return t.refcount};ei.prototype.unref=function(t){return t.refcount===0?0:(--t.refcount===0&&(this.stats[t.h]--,delete this.bins[t.id],this.freebins.push(t)),t.refcount)};ei.prototype.clear=function(){this.shelves=[],this.freebins=[],this.stats={},this.bins={},this.maxId=0};ei.prototype.resize=function(t,e){this.w=t,this.h=e;for(var n=0;n<this.shelves.length;n++)this.shelves[n].resize(t);return!0};function ig(t,e,n){this.x=0,this.y=t,this.w=this.free=e,this.h=n}ig.prototype.alloc=function(t,e,n){if(t>this.free||e>this.h)return null;var i=this.x;return this.x+=t,this.free-=t,new _P(n,i,this.y,t,e,t,this.h)};ig.prototype.resize=function(t){return this.free+=t-this.w,this.w=t,!0};function _P(t,e,n,i,o,r,s){this.id=t,this.x=e,this.y=n,this.w=i,this.h=o,this.maxw=r||i,this.maxh=s||o,this.refcount=0}class mP{constructor(){this.packer=new ei(tn[0],tn[1]),this.currentAtlasIndex=0,this.packedRasters=[],this.rastersToLoad=[],this.newRasterSets=new Map}addNewRasterSet(e,n){let i=this.newRasterSets.get(e);i||(i=[],this.newRasterSets.set(e,i)),i.push(n)}pack(e,n,i){e.isSvg?this.packSvg(e,n.map(o=>({w:o,h:o})),i):this.packPng(e,n,i)}packSvg(e,n,i){const{rasters:o}=e,r=new Set;for(const{w:s,h:a}of o)r.add(`${s}_${a}`);for(const s of n){const a=s.w*i,l=s.h*i;if(r.has(`${a}_${l}`))continue;let c=this.packer.packOne(a+2,l+2);c===null&&(this.packer=new ei(tn[0],tn[1]),this.currentAtlasIndex++,c=this.packer.packOne(a+2,l+2));const d=o.length,u={rasterSetIndex:e.index,rasterIndex:d,w:a,h:l,x:c.x+1,y:c.y+1,anchorX:e.anchorX,anchorY:e.anchorY,atlasIndex:this.currentAtlasIndex,isPacked:!0};o.push(u),this.packedRasters.push(e.index,d,u.x,u.y,u.w,u.h,this.currentAtlasIndex)}}addRastersToLoad(e,n){this.rastersToLoad.push(e,n.rasterSetIndex,n.rasterIndex)}getNewRasterSets(){const e=this.newRasterSets;return this.newRasterSets=new Map,e}getPackedRasters(){if(this.packedRasters.length===0)return;const e=new Uint16Array(this.packedRasters);return this.packedRasters=[],e}getRastersToLoad(){const e=new Float64Array(this.rastersToLoad);return this.rastersToLoad=[],e}packPng(e,n,i){const{rasters:o}=e;for(const r of n){const s=r*i,a=ml(o,s,!1);if(a===void 0)continue;const l=e.rasters[a];if(l.isPacked)continue;let c=this.packer.packOne(l.w+2,l.h+2);c===null&&(this.packer=new ei(tn[0],tn[1]),this.currentAtlasIndex++,c=this.packer.packOne(l.w+2,l.h+2)),l.x=c.x+1,l.y=c.y+1,l.atlasIndex=this.currentAtlasIndex,l.isPacked=!0,this.packedRasters.push(e.index,a,l.x,l.y,l.w,l.h,this.currentAtlasIndex)}}}const pP=2**32-1;class gP{constructor(){this.colorById=new Map,this.index=0}getIndex(e){if(!e)return this.nextIndex();const n=this.colorById.get(e);if(n!==void 0)return n;const i=this.nextIndex();return this.colorById.set(e,i),i}nextIndex(){return++this.index%pP}}const k1=2**20,R1=["main","parser","labeling","models"],xp={};for(let t=0;t<R1.length;t++){const e=R1[t];xp[e]={min:1+t*k1,max:(t+1)*k1}}class vP{constructor(e){this.atlasPacker=new mP,this.pointIndexer=new gP,this.floorHidingMap=new Map,this.usedModels=new Set,this.dataModels={},this.promotedObjectAttributes={},this.addedBuckets=[],this.labels=[],this.idIndexer=new m8(e),this.workerName=e,this.dataModelsIndex=xp[e].min,this.buckets={},this.geoJsonData=[],this.reset()}reset(){this.buckets={},this.geoJsonData=[],this.addedBuckets=[],this.floorHidingMap.clear(),this.labels=[],this.usedModels.clear()}getStatsAfterReset(){return{buckets:Object.keys(this.buckets).length,geoJsonData:this.geoJsonData.length,addedBuckets:this.addedBuckets.length,floorHidingMap:this.floorHidingMap.size,labels:this.labels.length,usedModels:this.usedModels.size}}addLabel(e){this.labels.push(e)}addUsedModel(e){this.usedModels.add(e)}getIndexerStats(){return this.idIndexer.getIndexerStats()}getBucketsMemoryFootprint(){return Object.keys(this.buckets).map(e=>{const n=e,i=this.buckets[n];return i?{[e]:Object.keys(i).map(o=>{const r=i[o];if(r&&typeof r=="object"){const s=Object.keys(r).map(a=>{const l=r[a];if(l&&l.elements&&l.elements.buffer)return{elementsBuffer:l.elements.buffer.byteLength,indices:l.indices.buffer.byteLength}});return{[o]:s}}return{[o]:0}})}:{[e]:[]}})}addPromotedObjectAttributes(e,n){this.promotedObjectAttributes[e]=n}addFeature(e){this.geoJsonData.push(e)}addUsedModelByUrl(e){const n=this.dataModels[e];if(n!==void 0)return n;const{min:i,max:o}=xp[this.workerName];this.dataModelsIndex=i+(this.dataModelsIndex+1-i)%(o-i);const r=-this.dataModelsIndex;return this.dataModels[e]=r,r}getDataModelsUrls(){const e={};for(const n in this.dataModels)this.usedModels.has(this.dataModels[n])&&(e[n]=this.dataModels[n]);return e}getBucket(e,n,i,o,r=Vc){let s=this.buckets[e];s===void 0&&(s={},this.buckets[e]=s);let a=s[n];a===void 0&&(a=s[n]={});const l=F1.generateKey(i),c=a[l];if(c)return this.addedBuckets.push(c),c;const d=new F1(e,n,i,o,r,l);return a[l]=d,this.addedBuckets.push(d),d}isOverloaded(){const e=this.addedBuckets;let n=0,i=0;for(;i<e.length;)n=n+e[i++].checkWatermarks();const o=n>0;if(o)for(;i--;)e[i].rollback();else for(;i--;)e[i].commit();return e.length=0,o}addFloorHidingMap(e,n){let i=this.floorHidingMap.get(n);i===void 0&&(i=[],this.floorHidingMap.set(n,i)),i.push(e)}getAccumulatedData(){const e=this.buckets,n=[],i=[];for(const f in e){const h=f,_=e[h];for(const p in _){const m=p,g=_[m],y=qc(h,m)/4;let b=0;for(const I in g)b+=g[I].indices.offset;if(b===0)continue;const v=[],T=new Int32Array(b*y);let x=0;for(const I in g){const E=g[I],{elements:L,indices:N,attributes:k,meta:w,objectsData:S,extents:A,maxDiag:z}=E,{view:M}=L,{buffer:P}=N;if(L.offset===0)continue;const C=x,D={};for(let B=0;B<N.offset;B++){const U=S?S[B]:null;if(U){const V=x/y;yP(U,V,D)}const G=P[B]*y;for(let V=0;V<y;V++)T[x++]=M[G+V]}v.push({attributes:k,drawMode:E.drawMode,rangeStart:C*4,rangeEnd:x*4,meta:w,objectsData:Object.keys(D).length>0?D:void 0,extents:new Uint16Array(A),maxDiag:z}),E.resetOffsets(),E.resetBuildingsData(),E.resetInstancesExtents(),E.meta=void 0}n.push({symbol:h,sink:m,buffer:T.buffer,generatedObjects:v}),i.push(T.buffer)}}const o=this.idIndexer.getPacked();i.push(o.centerBuffer),i.push(o.instanceIdBuffer),i.push(o.layerIdBuffer),i.push(o.objectClassBuffer),i.push(o.phaseBuffer),i.push(o.styleIdBuffer),i.push(o.sublayerBuffer);const r=this.atlasPacker.getPackedRasters();r!==void 0&&i.push(r.buffer);const s=this.atlasPacker.getRastersToLoad();i.push(s.buffer);const a=this.getDataModelsUrls();this.usedModels=new Set;const l=this.floorHidingMap;this.floorHidingMap=new Map;const c=this.labels;this.labels=[];const d=this.promotedObjectAttributes;this.promotedObjectAttributes={};const u=this.geoJsonData.length?this.geoJsonData:void 0;return this.geoJsonData=[],{data:n,labels:c,floorHidingMap:l,packedRasters:r,rastersToLoad:s,dataModelsUrls:a,identifyIds:o,transferable:i,promotedObjectAttributes:d,debugGeoJsonData:u}}}function yP(t,e,n){const i=t.objectId;n[i]||(n[i]=[]);let o=!1;for(const r of n[i]){const s=r.offset+r.size,a=e+t.size;(r.offset<=e&&s>=e||e<=r.offset&&a>=r.offset)&&(r.offset=Math.min(e,r.offset),r.size=Math.max(s,a)-r.offset,o=!0)}o||n[i].push({offset:e,size:t.size})}let bP=class{constructor(e){if(this.webGlExtensions={},this._canvasElement=null,this._size=[1,1],e=e||{},"canvas"in e){this._canvasElement=typeof e.canvas=="string"?document.getElementById(e.canvas):e.canvas;const n={antialias:e.antialias!==void 0?e.antialias:!0,stencil:e.stencil!==void 0?e.stencil:!1,failIfMajorPerformanceCaveat:e.failIfMajorPerformanceCaveat!==void 0?e.failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:e.preserveDrawingBuffer!==void 0?e.preserveDrawingBuffer:!1};this._gl=e.version===2?this._canvasElement.getContext("webgl2",n):this._canvasElement.getContext("webgl",n)||this._canvasElement.getContext("experimental-webgl",n)}else this._gl=e.gl;this._pixelRatio=e.pixelRatio||1,this.clearColor=e.clearColor||[1,1,1,1],this.webGlExtensions={}}setPixelRatio(e){return this._pixelRatio=e,this}getPixelRatio(){return this._pixelRatio}setSize(e,n){return this._size=[e*this._pixelRatio,n*this._pixelRatio],this._canvasElement&&(this._canvasElement.width=this._size[0],this._canvasElement.height=this._size[1],this._canvasElement.style.width=`${e}px`,this._canvasElement.style.height=`${n}px`),this.setViewport(),this}setViewport(e,n){return e!==void 0&&n!==void 0?this._gl.viewport(0,0,e,n):this._gl.viewport(0,0,this._size[0],this._size[1]),this}getSize(){return this._size}addExtension(e){return this.webGlExtensions[e]=this._gl.getExtension(e),this}};const ve=class ve{constructor(e=null,n={}){this._src=null,this._glContext=null,this._texture=null,this._src=e,this.options=Object.assign({},ve.defaultOptions,n)}enable(e,n){return e.activeTexture(e.TEXTURE0+n),this._texture||this.prepare(e),e.bindTexture(e.TEXTURE_2D,this._texture),this}remove(){return this._texture&&this._glContext&&this._glContext.deleteTexture(this._texture),this._glContext=null,this._texture=null,this._src=null,this}getTexture(){return this._texture}subImage(e,n,i,o){e.bindTexture(e.TEXTURE_2D,this._texture),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,this.options.flipY),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.options.premultiplyAlpha);const r=this._toGlParam(e,this.options.format),s=this._toGlParam(e,this.options.type??ve.UnsignedByte);return r===null||s===null?this:(e.texSubImage2D(e.TEXTURE_2D,0,i,o,r,s,n),this)}prepare(e){this._glContext=e,this._texture=e.createTexture(),e.bindTexture(e.TEXTURE_2D,this._texture),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,this.options.flipY),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.options.premultiplyAlpha);const n=this._toGlParam(e,this.options.format),i=this._toGlParam(e,this.options.type??ve.UnsignedByte),o=this._toGlParam(e,this.options.wrapS),r=this._toGlParam(e,this.options.wrapT),s=this._toGlParam(e,this.options.magFilter??ve.LinearFilter),a=this._toGlParam(e,this.options.minFilter??ve.LinearMipMapLinearFilter),l=this.options.compareFunc?this._toGlParam(e,this.options.compareFunc):null;if(n!==null&&i!==null){const c=this.hookInternalFormat(n,i,e);ArrayBuffer.isView(this._src)||this._src===null?this.options.size&&e.texImage2D(e.TEXTURE_2D,0,c,this.options.size[0],this.options.size[1],0,n,i,this._src):this._src&&e.texImage2D(e.TEXTURE_2D,0,n,n,i,this._src)}return o!==null&&r!==null&&(e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,o),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,r)),s!==null&&a!==null&&(e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,s),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,a)),l&&!(e instanceof WebGLRenderingContext)&&e.texParameteri(e.TEXTURE_2D,e.TEXTURE_COMPARE_MODE,e.COMPARE_REF_TO_TEXTURE),this.options.generateMipmaps&&this.options.minFilter!==ve.NearestFilter&&this.options.minFilter!==ve.LinearFilter&&e.generateMipmap(e.TEXTURE_2D),e.bindTexture(e.TEXTURE_2D,null),this}memSizeJs(){const e=this._src;return e===null?0:ArrayBuffer.isView(e)?e.byteLength:e instanceof ImageBitmap?e.height*e.width*4:(console.warn("[Stats] Untracked texture _src size"),0)}memSizeGPU(){var n,i;if(!this._texture)return 0;const e=(((n=this.options.size)==null?void 0:n[0])??0)*(((i=this.options.size)==null?void 0:i[1])??0)*4;return e>0?e:this._src!==null?this.memSizeJs():0}_toGlParam(e,n){return n===ve.ClampToEdgeWrapping?e.CLAMP_TO_EDGE:n===ve.Repeat?e.REPEAT:n===ve.MirroredRepeat?e.MIRRORED_REPEAT:n===ve.NearestFilter?e.NEAREST:n===ve.NearestMipMapNearestFilter?e.NEAREST_MIPMAP_NEAREST:n===ve.NearestMipMapLinearFilter?e.NEAREST_MIPMAP_LINEAR:n===ve.LinearFilter?e.LINEAR:n===ve.LinearMipMapNearestFilter?e.LINEAR_MIPMAP_NEAREST:n===ve.LinearMipMapLinearFilter?e.LINEAR_MIPMAP_LINEAR:n===ve.RgbaFormat?e.RGBA:n===ve.AlphaFormat?e.ALPHA:n===ve.RgbFormat?e.RGB:n===ve.DepthComponentFormat?e.DEPTH_COMPONENT:n===ve.UnsignedByte?e.UNSIGNED_BYTE:n===ve.UnsignedShort?e.UNSIGNED_SHORT:n===ve.Float?e.FLOAT:n===ve.UnsignedInt?e.UNSIGNED_INT:e instanceof WebGLRenderingContext?null:n===ve.RedFormat?e.RED:n===ve.CompareRefToTexture?e.COMPARE_REF_TO_TEXTURE:n===ve.CompareNone?e.NONE:n===ve.DepthComponentFormat32?e.DEPTH_COMPONENT32F:null}hookInternalFormat(e,n,i){return i instanceof WebGLRenderingContext?e:e===i.DEPTH_COMPONENT?i.DEPTH_COMPONENT24:n===i.FLOAT&&e===i.RGBA?i.RGBA32F:n===i.FLOAT&&e===i.RED?i.R32F:n!==i.FLOAT&&e===i.RED?i.R8:e}};ve.ClampToEdgeWrapping=1,ve.Repeat=2,ve.MirroredRepeat=3,ve.NearestFilter=4,ve.NearestMipMapNearestFilter=5,ve.NearestMipMapLinearFilter=6,ve.LinearFilter=7,ve.LinearMipMapNearestFilter=8,ve.LinearMipMapLinearFilter=9,ve.DepthComponentFormat=10,ve.DepthComponentFormat32=11,ve.RgbaFormat=14,ve.AlphaFormat=15,ve.RgbFormat=16,ve.UnsignedByte=17,ve.Float=18,ve.UnsignedShort=19,ve.UnsignedInt=20,ve.RedFormat=21,ve.CompareNone=22,ve.CompareRefToTexture=23,ve.defaultOptions={magFilter:ve.LinearFilter,minFilter:ve.LinearMipMapLinearFilter,wrapS:ve.ClampToEdgeWrapping,wrapT:ve.ClampToEdgeWrapping,format:ve.RgbaFormat,generateMipmaps:!0,flipY:!0,premultiplyAlpha:!0,type:ve.UnsignedByte};let j=ve;function Yd(t){if(t===void 0)return;const e=window.WebGLRenderingContext,i={[e.CLAMP_TO_EDGE]:j.ClampToEdgeWrapping,[e.REPEAT]:j.Repeat,[e.MIRRORED_REPEAT]:j.MirroredRepeat,[e.NEAREST]:j.NearestFilter,[e.NEAREST_MIPMAP_NEAREST]:j.NearestMipMapNearestFilter,[e.NEAREST_MIPMAP_LINEAR]:j.NearestMipMapLinearFilter,[e.LINEAR]:j.LinearFilter,[e.LINEAR_MIPMAP_NEAREST]:j.LinearMipMapNearestFilter,[e.LINEAR_MIPMAP_LINEAR]:j.LinearMipMapLinearFilter,[e.RGBA]:j.RgbaFormat,[e.ALPHA]:j.AlphaFormat,[e.RGB]:j.RgbFormat,[e.UNSIGNED_BYTE]:j.UnsignedByte,[e.FLOAT]:j.Float}[t];return i===void 0?(console.error(`Failed to translate texture parameter ${t}`),NaN):i}const Kf=class Kf{constructor(e={}){this._texture=null,this._glContext=null,this._frameBuffer=null,this._depthAttachment=null,this.options=Object.assign({},Kf.defaultOptions,e),this.options.hasColorOutput&&(this._texture=new j(null,this.options))}bind(e,n){return this._frameBuffer||this._prepare(e),n?e.bindFramebuffer(n,this._frameBuffer):e.bindFramebuffer(e.FRAMEBUFFER,this._frameBuffer),this}unbind(e){return e.bindFramebuffer(e.FRAMEBUFFER,null),this}remove(){return this._unprepare(),this}setSize(e){return this.options.size=e,this._unprepare(),this}getTexture(){return this._texture}getDepthAttachment(){return this._depthAttachment}memSizeGPU(){const{_texture:e,_depthAttachment:n}=this;let i=0;if(this.options.depthTexture||this.options.useHighDepthPrecision)i=4;else switch(this.options.depthInternalFormat){case WebGL2RenderingContext.DEPTH_COMPONENT16:i=2;break;case WebGL2RenderingContext.DEPTH_COMPONENT24:i=3;break;case WebGL2RenderingContext.DEPTH_STENCIL:i=1;break}return{_texture:e?Tf(e):{_texture:0},_depthAttachment:n===null?0:this.options.size[0]*this.options.size[1]*i}}_prepare(e){if(this._glContext=e,!this._texture&&this.options.hasColorOutput&&(this._texture=new j(null,this.options)),this._frameBuffer=e.createFramebuffer(),e.bindFramebuffer(e.FRAMEBUFFER,this._frameBuffer),this._texture&&(this._texture.prepare(e),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this._texture.getTexture(),0)),this.options.depthTexture){const n=this._depthAttachment=new j(null,{magFilter:this.options.magFilter??j.NearestFilter,minFilter:this.options.minFilter??j.NearestFilter,format:j.DepthComponentFormat,size:this.options.size,premultiplyAlpha:!1,generateMipmaps:!1,type:j.UnsignedInt,compareFunc:this.options.compareFunc});n.prepare(e),e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.TEXTURE_2D,n.getTexture(),0)}else{const n=this.options.useHighDepthPrecision?e.DEPTH_STENCIL:this.options.depthInternalFormat,i=this.options.useHighDepthPrecision?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT;this._depthAttachment=e.createRenderbuffer(),e.bindRenderbuffer(e.RENDERBUFFER,this._depthAttachment),e.renderbufferStorage(e.RENDERBUFFER,n,this.options.size[0],this.options.size[1]),e.framebufferRenderbuffer(e.FRAMEBUFFER,i,e.RENDERBUFFER,this._depthAttachment)}this._checkComplete(e),e.bindRenderbuffer(e.RENDERBUFFER,null),e.bindFramebuffer(e.FRAMEBUFFER,null)}_unprepare(){this._texture&&(this._texture.remove(),this._texture=null),this._glContext&&this._depthAttachment&&(this._depthAttachment instanceof j?this._depthAttachment.remove():this._glContext.deleteRenderbuffer(this._depthAttachment),this._depthAttachment=null),this._glContext&&this._frameBuffer&&(this._glContext.deleteFramebuffer(this._frameBuffer),this._frameBuffer=null)}_checkComplete(e){if(J0()){const n=e.checkFramebufferStatus(e.FRAMEBUFFER);if(n===e.FRAMEBUFFER_COMPLETE)return;n===e.FRAMEBUFFER_UNSUPPORTED?console.log("Framebuffer is unsupported"):n===e.FRAMEBUFFER_INCOMPLETE_ATTACHMENT?console.log("Framebuffer incomplete attachment"):n===e.FRAMEBUFFER_INCOMPLETE_DIMENSIONS?console.log("Framebuffer incomplete dimensions"):n===e.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT?console.log("Framebuffer incomplete missing attachment"):console.log(`Unexpected framebuffer status: ${n}`)}}};Kf.defaultOptions=Object.assign({},j.defaultOptions,{size:[0,0],generateMipmaps:!1,depthTexture:!1,hasColorOutput:!0,useHighDepthPrecision:!1,depthInternalFormat:33189});let qt=Kf;const zf={defines:[],hash:""},gs=class gs{constructor(e,n,i=zf,o=zf){this.shader=null,this.type=e==="vertex"?gs.Vertex:gs.Fragment,this.sourceCode=n,this.commonDefinitions=i,this.definitions=o}static createShaderDefinitions(e){return{defines:e,hash:e.map(i=>`${i.type}:${i.value??""}`).join("")}}get(e){return this.shader||this.compile(e),this.shader}remove(e){this.shader&&(e.deleteShader(this.shader),this.shader=null)}getCode(){return this.assembleShaderText().slice()}compile(e){const n=this.type===gs.Vertex?e.VERTEX_SHADER:e.FRAGMENT_SHADER,i=this.shader=e.createShader(n);if(!i||e.isContextLost())throw new Error(`[2gl] Failed to create shader. Shader is null: ${String(!i)}. Context is lost: ${String(e.isContextLost())}`);const o=this.assembleShaderText();if(e.shaderSource(i,o),e.compileShader(i),J0()&&!e.getShaderParameter(i,e.COMPILE_STATUS)){const r=e.getShaderInfoLog(i),s=(o||"").split(`
`);throw new Error(r?r.replace(/^ERROR:\s*(\d+):(\d+):\s*(.*?)\n/,function(a,l,c,d){const u=s[Number(c)-1];return u?`ERROR ${l}:${c}: ${d}
Erroneous line: <<${u}>>
`:a}):"Unknown shader compilation error")}}assembleShaderText(){const e=this.sourceCode,n=[...this.commonDefinitions.defines,...this.definitions.defines].map(r=>r.value!==void 0?"#define "+r.type+" "+r.value:"#define "+r.type),i=Array.isArray(e)?e:[e||""];let o=!0;for(const r of i)o&&r.indexOf("#version")!==-1?n.unshift(r):n.push(r),o=!1;return n.join(`
`)}};gs.Vertex=1,gs.Fragment=2;let Xo=gs;class wP{constructor(e){this.location=null,this.name=e.name,this.type=e.type}getLocation(e,n){return this.location=e.getUniformLocation(n,this.name),this}bind(e,n){switch(this.type){case"1i":e.uniform1i(this.location,n);break;case"1f":e.uniform1f(this.location,n);break;case"2i":e.uniform2i(this.location,n[0],n[1]);break;case"2f":e.uniform2f(this.location,n[0],n[1]);break;case"3i":e.uniform3i(this.location,n[0],n[1],n[2]);break;case"3f":e.uniform3f(this.location,n[0],n[1],n[2]);break;case"4i":e.uniform4i(this.location,n[0],n[1],n[2],n[3]);break;case"4f":e.uniform4f(this.location,n[0],n[1],n[2],n[3]);break;case"1iv":e.uniform1iv(this.location,n);break;case"1fv":e.uniform1fv(this.location,n);break;case"2iv":e.uniform2iv(this.location,n);break;case"2fv":e.uniform2fv(this.location,n);break;case"3iv":e.uniform3iv(this.location,n);break;case"3fv":e.uniform3fv(this.location,n);break;case"4iv":e.uniform4iv(this.location,n);break;case"4fv":e.uniform4fv(this.location,n);break;case"mat2":e.uniformMatrix2fv(this.location,!1,n);break;case"mat3":e.uniformMatrix3fv(this.location,!1,n);break;case"mat4":e.uniformMatrix4fv(this.location,!1,n);break;default:throw new Error(`[2gl] Unsupported uniform type: '${this.type}'`)}return this}isNonFloatType(){return this.type.includes("i")}}class xP{constructor(e,n,i){this.uniformBlocksNames=i,this.uniforms={},this.attributes={},this._webglProgram=null,this._linked=!1,this._located=!1,this._error=!1,this._uniformBlocksIndices={},this._uboBindings={},e=e||{},e.uniforms=e.uniforms||[],e.uniforms.forEach(o=>{this.uniforms[o.name]=new wP(o)}),e.attributes=e.attributes||[],e.attributes.forEach(o=>{this.attributes[o.name]=new N8(o)}),n=n??zf,this._vertexShader=e.buildVertex(n),this._fragmentShader=e.buildFragment(n)}enable(e){return this._error?this:(this.link(e),this.locate(e),this._error?this:(e.useProgram(this._webglProgram),this))}bind(e,n,i){if(this._error)return this;if(n)for(const o in n)this.uniforms[o].bind(e,n[o]);if(i)for(const o in i)this.attributes[o].bind(e,i[o]);return this}disable(e){if(this._error)return this;for(const n in this.attributes)this.attributes[n].disable(e);return this}link(e){if(this._linked||this._error)return this;try{if(this._webglProgram=e.createProgram(),!this._webglProgram)throw new Error("Failed to create shader program");const n=this._vertexShader.get(e),i=this._fragmentShader.get(e);n&&e.attachShader(this._webglProgram,n),i&&e.attachShader(this._webglProgram,i);for(const o in this.attributes)this.attributes[o].bindLocation(e,this._webglProgram);if(e.linkProgram(this._webglProgram),J0()&&!e.getProgramParameter(this._webglProgram,e.LINK_STATUS))throw new Error(e.getProgramInfoLog(this._webglProgram)||"Couldn't get shader program Info Log");this._linked=!0}catch(n){throw this._error=!0,n}return this}locate(e){if(this._located||this._error||!this._webglProgram)return this;for(const n in this.attributes)this.attributes[n].getLocation(e,this._webglProgram);for(const n in this.uniforms)this.uniforms[n].getLocation(e,this._webglProgram);return e instanceof WebGLRenderingContext||this.locateUniformBlocks(e,this._webglProgram),this._located=!0,this}getUniformBlockIndex(e){return this._uniformBlocksIndices[e]}getUboBinding(e){return this._uboBindings[e]}getUniformBlockSize(e,n){let i=this._webglProgram;if(i||(this.link(e),this.locate(e)),i=this._webglProgram,!i)return null;const o=this.getUniformBlockIndex(n);return o===void 0?null:e.getActiveUniformBlockParameter(i,o,e.UNIFORM_BLOCK_DATA_SIZE)}getUniformsIndicesOffsetsInBlock(e,n){let i=this._webglProgram;if(i||(this.link(e),this.locate(e)),i=this._webglProgram,!i)return null;const o=e.getUniformIndices(i,n);if(!o)return console.error("Couldn't get UBO uniforms indices."),null;const r=o.filter(l=>l!==e.INVALID_INDEX),s=e.getActiveUniforms(i,r,e.UNIFORM_OFFSET);if(s===null)return console.error("Couldn't get active UBO uniform offsets."),null;const a={};for(let l=0;l<n.length;++l){const c=o[l];if(c!==e.INVALID_INDEX){const d=r.indexOf(c);a[n[l]]=s[d]}}return a}locateUniformBlocks(e,n){if(!this.uniformBlocksNames)return;let i=0;for(const o of this.uniformBlocksNames){const r=e.getUniformBlockIndex(n,o);r!==e.INVALID_INDEX&&(this._uniformBlocksIndices[o]=r,this._uboBindings[o]=i,e.uniformBlockBinding(n,r,i++))}}}const z1=[1,1,1,1],SP=Ke(),MP=Ke(),B1=Ui(),TP=Ui(),IP=Ke(),EP=yt(0,1,0),Cb=(t,e,n,i,o)=>{Ko(t,e,{u_float_rounding_factor:n.stillness},o)},rc=(t,e,n,i,o)=>{Ko(t,e,{u_float_border_width_offset:1/window.devicePixelRatio},o)},ef=(t,e,n,i,o)=>{const r=(u0-.5)/2,{size:s}=n;Ko(t,e,{u_vec2_depth_test_half_point_size:[r/s[0],r/s[1]]},o)},we=(t,e,n,i,o)=>{if(!i.environmentManager.isFogEnabled())return;const r=i.styleManager.getStyle(n.handyStyleId);let s=z1,a=z1;if(r){const c=ht(n.styleZoom,n.styleState,[]);s=Pt(Le(r.environment.style.skyColor,c)),a=Pt(Le(r.environment.style.fogColor,c))}const l=i.camera;Ko(t,e,{u_sky_color:n.globeMode?[0,0,0,0]:s,u_fog_color:n.globeMode?[0,0,0,0]:a,u_fog_distance:n.globeMode?0:l.fogDistance,u_fog_limits:i.environmentManager.fogLimits,u_fog_horizon_blend:i.environmentManager.fogHorizonBlend,u_fog_horizon_level:i.environmentManager.fogHorizonLevel},o)},xe=(t,e,n,i,o)=>{Ko(t,e,{u_cam_pos:i.camera.position},o)},De=(t,e,n,i,o)=>{i.shadowManager.texture&&Ko(t,e,{u_shadow_map_params:i.shadowManager.shadowMapParams,u_shadow_bias:i.shadowManager.bias,u_mat4_clip_to_shadow:i.shadowManager.clipToShadowMatrix},o)},sc=(t,e,n,i,o)=>{Ko(t,e,{u_vec2_scale_limits:[0,d0]},o)},Pb=(t,e,n,i,o)=>{const r=i.camera.viewMatrixTranspose,s=i.camera.projectionMatrixInverse;Ko(t,e,{u_mat4_view_transposed:r,u_mat4_proj_inverted:s},o)},Sp=(t,e,n,i,o)=>{const r=window.devicePixelRatio,s=i.camera.ecef.pixelRadius*r,{left:a,bottom:l,top:c,right:d}=n.padding,[u,f]=n.size,h=[u*r,f*r],_=[(a-d)*r/2,(l-c)*r/2],p=i.environmentManager.globHaloStops.map(T=>(s+T*r)/h[1]),m=i.styleManager.getStyle(n.handyStyleId);if(!m)return;const g=m==null?void 0:m.environment;if(!g)return;const y=ht(n.styleZoom,n.styleState,[]),b=Le(g.style.fogColor,y),v=Le(m.background.color,y);Ko(t,e,{u_vec2_halo_viewport_size:h,u_vec2_halo_viewport_center_shift:_,u_vec4_halo_radius_stops:p,u_vec4_halo_color:Pt(b),u_float_halo_exp_factor:i.environmentManager.globeHaloExpFactor,u_vec4_default_background_color:Pt(v)},o)},Lb=(t,e,n,i,o)=>{const r=n.size,s=Math.max(r[0],r[1]),a=r[0]/s,l=r[1]/s;n3(B1,-a/2,a/2,-l/2,l/2,.001,1);const c=q.toGeo(n.center),d=St(MP,0,0,0),u=St(SP,0,0,1);Mx(u,u,d,Be(c[1])),_a(u,u,d,Be(c[0]));const f=Tc(TP,IP,u,EP);Sn(f,B1,f);const h=i.styleManager.getStyle(n.handyStyleId);if(!h)return;const _=h==null?void 0:h.environment;if(!_)return;const p=ht(n.styleZoom,n.styleState,[]),m=K(_.style.starsIntensity,p);Ko(t,e,{u_float_pixelratio:window.devicePixelRatio,u_float_stars_intensity:m,u_mat4_stars:f},o)};function Ko(t,e,n,i){i&&!(t instanceof WebGLRenderingContext)?i.updateData(t,e,n):e.bind(t,n)}function Te(...t){return(e,n,i,o,r)=>{t.forEach(s=>s(e,n,i,o,r))}}const AP=Te(Cb,rc,ef,we,xe,De,sc,Pb,Sp,Lb),CP=Te(xe,we),Xt=(t,e,n)=>{const{size:i}=n,o=window.devicePixelRatio;e.bind(t,{u_vec2_vpt_size:[i[0]*o,i[1]*o]})},O1=(t,e,n,i)=>{const{size:o}=n,r=window.devicePixelRatio;if(n.demMode){const s=i.renderer.getFramebuffer(i.demManager.getFlatFramebufferId());if(!s)return;e.bind(t,{u_vec2_vpt_size:[Math.trunc(s.renderTarget.options.size[0]),Math.trunc(s.renderTarget.options.size[1])]})}else e.bind(t,{u_vec2_vpt_size:[o[0]*r,o[1]*r]})},ed=(t,e,n)=>{const i=l3(n.zoom);e.bind(t,{u_vec3_projection_scale_style_scale_dpi:[i,i,cl*window.devicePixelRatio]})},Fb=(t,e,n)=>{const i=l3(n.styleZoom);e.bind(t,{u_vec3_projection_scale_style_scale_dpi:[i,i,cl*window.devicePixelRatio]})},gh=(t,e,n,i)=>{e.bind(t,{u_float_height_factor:i.buildingHeightAnimator.getDefaultBuildingHeight()})},qd=(t,e)=>{e.bind(t,{u_float_z_offset:0})},PP=(t,e)=>{e.bind(t,{u_float_z_offset:-1e-5})},Lo=(t,e)=>{e.bind(t,{u_sr2d_texture:0})},kb=(t,e)=>{e.bind(t,{u_vec4_border_color:[0,0,0,0]})},Rb=(t,e)=>{e.bind(t,{u_vec4_space_color:[0,0,0,0]})},zb=(t,e,n,i)=>{const{renderer:o}=i,{labelingTextureBuffer:r,spriteLabelingTextureBuffer:s}=o;let a=n.isLabelingDepthTestDisabled;if(!a){const c=r.getDepthAttachment(),d=r.getTexture();!(c instanceof j)||!d?a=!0:(d.enable(t,o2),c.enable(t,r2))}const l=s.getTexture();l&&(l.enable(t,s2),e.bind(t,{u_color_text_sprite_labeling:s2})),e.bind(t,{u_bool_depth_test_disable:a}),a||e.bind(t,{u_color_tex_labeling:o2,u_depth_tex_labeling:r2})};function Hl(...t){return(e,n,i,o)=>{t.forEach(r=>r(e,n,i,o))}}const Bb={[Ds.none]:{ambientColorIntensity:new Float32Array([1,1,1,0]),dir1ColorIntensity:new Float32Array([1,1,1,0]),dir1Direction:new Float32Array([0,-1,0]),dir2ColorIntensity:new Float32Array([1,1,1,0]),dir2Direction:new Float32Array([0,-1,0]),shadowLightIndex:-1,shadowRadius:1}};function vn(...t){return(e,n,i,o,r,s)=>{t.forEach(a=>a(e,n,i,o,r,s))}}const LP=1,FP=2,kP=4,Je=(t,e,n,i,o,r)=>{let s=Ds.none,a=Bb[s],l=0;const c=Ob(o,i,n);c&&(a=c.lightConfig,s=c.lightingMode,l=(s===Ds.none||r?0:LP)+(o.receiveShadows!==!1&&a.shadowLightIndex===0?FP:0)+(o.receiveShadows!==!1&&a.shadowLightIndex===1?kP:0));const d=i.renderer.getUbo(s);if(d&&!(t instanceof WebGLRenderingContext)){d.bind(t,e),e.bind(t,{u_int_light_flags:l});return}e.bind(t,{u_int_light_flags:l,u_vec3_light_dir1_direction:a.dir1Direction,u_vec4_light_dir1_color:a.dir1ColorIntensity,u_vec3_light_dir2_direction:a.dir2Direction,u_vec4_light_dir2_color:a.dir2ColorIntensity,u_vec4_ambient_color:a.ambientColorIntensity})},xo=(t,e,n,i,o)=>{const r=ht(n.styleZoom,n.styleState,[],!1),s=K(o.style.nearCameraFade,r);e.bind(t,{u_sdtr_distance:s})},Kd=(t,e,n,i,o)=>{const r=ht(n.styleZoom,n.styleState,[],!1),s=o.style.showRatio,a=te(s,r);e.bind(t,{u_float_show_ratio:a})};function Ob(t,e,n){const i=e.styleManager.getStyle(n.handyStyleId);if(!i||!i.light.lightingModesResolved)return null;let o=t.lightingMode??i.light.defaultLightMode;t.type==="gltfModel"&&t.style.ignoreGlobalLighting&&(o=Ds.none);let r=i.light.lightingModesResolved[o];return r||(r=i.light.lightingModesResolved[i.light.defaultLightMode]),{lightingMode:o,lightConfig:r}}class he{constructor(e,n,i=null){this.isDirty=!1,this._vao=null,this._vaoExt=null,this._gl=null,this.attributesAliases={},this._attributes=n,this._shaderProgram=e,this.indicesBuffer=i}static merge(e){const n=e[0],i={},o={};for(const s of e)Object.assign(i,s._attributes),Object.assign(o,s.attributesAliases);const r=new he(n._shaderProgram,i,n.indicesBuffer);return r.setAttributesAliases(o),r}copy(){const e=new he(this._shaderProgram,{...this._attributes},this.indicesBuffer);return e.setAttributesAliases(this.attributesAliases),e}bind(e){const n=e.extensions.OES_vertex_array_object,i=e.extensions.ANGLE_instanced_arrays;return this._bind(e.gl,n,i),this}unbind(){return this._glBindVertexArray(null),this}setAttribute(e,n){this._attributes[e]=n,this.remove()}remove(){return this._vao&&(this._glDeleteVertexArray(this._vao),this._vao=null),this}getElementsGLType(e){return this.indicesBuffer?this.indicesBuffer.getGLType(e):null}getBuffer(e){return this._attributes[e]}rewriteData(e,n){this._attributes[e].replaceData(n),this.isDirty=!0}setAttributesAliases(e){Object.assign(this.attributesAliases,e),this.remove()}setAttributes(e,n){const i=this._shaderProgram.attributes,o=this._attributes;for(const r in i){const a=this.attributesAliases[r]||r,l=o[a];if(!l)continue;const c=i[r];if(c.index!==!0)for(let d=0;d<c.locationsCount;d++)e.enableVertexAttribArray(c.location+d);l.bind(e,c.location,void 0,n,c.locationsCount)}this.indicesBuffer&&this.indicesBuffer.bind(e)}_bind(e,n,i){this._vao?(this.isDirty&&this.updateDirtyBuffers(e),this._glBindVertexArray(this._vao)):this._prepare(e,n,i)}_prepare(e,n,i){this._gl=e,n&&(this._vaoExt=n),this._vao=this._glCreateVertexArray(),this._glBindVertexArray(this._vao),this.setAttributes(e,i)}_glCreateVertexArray(){const e=this._gl,n=this._vaoExt;return e&&this._isWebGL2(e)?e.createVertexArray():n?n.createVertexArrayOES():null}_glBindVertexArray(e){const n=this._gl,i=this._vaoExt;n&&this._isWebGL2(n)?n.bindVertexArray(e):i?i.bindVertexArrayOES(e):n&&this._shaderProgram.bind(n,void 0,this._attributes)}_glDeleteVertexArray(e){const n=this._gl,i=this._vaoExt;n&&this._isWebGL2(n)?n.deleteVertexArray(e):i&&i.deleteVertexArrayOES(e)}_isWebGL2(e){return typeof window<"u"&&"WebGL2RenderingContext"in window&&e instanceof WebGL2RenderingContext}updateDirtyBuffers(e){const n=this._shaderProgram.attributes,i=this._attributes,o=this.attributesAliases;for(const r in n){const s=o[r]||r,a=i[s];a!=null&&a.isDirty&&a.commitData(e)}this.isDirty=!1}}const RP=(t,e)=>{const n=Oo.sinks.fill.stride,i=new R(t,{itemSize:2,dataType:F.UnsignedShort,stride:n,offset:0,normalized:!0});return new he(e,{a_vec2_vertex:i})},zP=(t,e)=>{const n=Oo.sinks.shadow.stride,i=new R(t,{itemSize:2,dataType:F.UnsignedShort,stride:n,offset:0,normalized:!0});return new he(e,{a_vec2_vertex:i})},BP=(t,e)=>{const i=new R(t,{itemSize:2,dataType:F.UnsignedShort,stride:8,offset:0,normalized:!0}),o=new R(t,{itemSize:2,dataType:F.UnsignedShort,stride:8,offset:4,normalized:!1});return new he(e,{a_vec2_vertex:i,a_vec2_texcoord:o})},OP=(t,e)=>{const i=new R(t,{itemSize:2,dataType:F.UnsignedShort,stride:8,offset:0,normalized:!0}),o=new R(t,{itemSize:4,dataType:F.UnsignedByte,stride:8,offset:4,normalized:!0});return new he(e,{a_vec2_vertex:i,a_vec4_identifier:o})},DP=(t,e)=>{const i=new R(t,{itemSize:2,dataType:F.UnsignedShort,stride:12,offset:0,normalized:!0}),o=new R(t,{itemSize:4,dataType:F.Byte,stride:12,offset:4,normalized:!1});return new he(e,{a_vec2_vertex:i,a_vec4_normals:o})},NP=(t,e)=>{const n=Ot.sinks.solid3d.stride,i=new R(t,{itemSize:2,dataType:F.UnsignedShort,stride:n,offset:0,normalized:!0}),o=new R(t,{itemSize:4,dataType:F.Byte,stride:n,offset:4,normalized:!1}),r=new R(t,{itemSize:1,dataType:F.Float,stride:n,offset:8,normalized:!1});return new he(e,{a_vec2_vertex:i,a_vec4_normals:o,a_float_height:r})},UP=(t,e)=>{const n=Ot.sinks.solid3d.stride,i=new R(t,{itemSize:2,dataType:F.UnsignedShort,stride:n,offset:0,normalized:!0}),o=new R(t,{itemSize:4,dataType:F.Byte,stride:n,offset:4,normalized:!1}),r=new R(t,{itemSize:1,dataType:F.Float,stride:n,offset:8,normalized:!1}),s=new R(t,{itemSize:4,dataType:F.UnsignedByte,stride:n,offset:12,normalized:!0});return new he(e,{a_vec2_vertex:i,a_vec4_normals:o,a_float_height:r,a_vec4_identifier:s})},GP=(t,e)=>{const i=new R(t,{itemSize:2,dataType:F.UnsignedShort,stride:16,offset:0,normalized:!0}),o=new R(t,{itemSize:4,dataType:F.Byte,stride:16,offset:4,normalized:!1}),r=new R(t,{itemSize:2,dataType:F.Float,stride:16,offset:8,normalized:!1});return new he(e,{a_vec2_vertex:i,a_vec4_normals:o,a_vec2_shift:r})},HP=(t,e)=>{const i=new R(t,{itemSize:2,dataType:F.UnsignedShort,stride:12,offset:0,normalized:!0}),o=new R(t,{itemSize:4,dataType:F.Byte,stride:12,offset:4,normalized:!1}),r=new R(t,{itemSize:4,dataType:F.UnsignedByte,stride:12,offset:8,normalized:!0});return new he(e,{a_vec2_vertex:i,a_vec4_normals:o,a_vec4_identifier:r})},VP=(t,e)=>{const n=Ot.sinks.patterned.stride,i=new R(t,{itemSize:2,dataType:F.UnsignedShort,stride:n,offset:0,normalized:!0}),o=new R(t,{itemSize:2,dataType:F.Short,stride:n,offset:4,normalized:!1}),r=new R(t,{itemSize:1,dataType:F.Float,stride:n,offset:8}),s=new R(t,{itemSize:4,dataType:F.UnsignedByte,stride:n,offset:12,normalized:!0});return new he(e,{a_vec2_vertex:i,a_vec2_widen:o,a_float_texture:r,a_vec4_identifier:s})},jP=(t,e)=>{const n=Ot.sinks.patterned3d.stride,i=new R(t,{itemSize:2,dataType:F.UnsignedShort,stride:n,offset:0,normalized:!0}),o=new R(t,{itemSize:2,dataType:F.Short,stride:n,offset:4,normalized:!1}),r=new R(t,{itemSize:1,dataType:F.Float,stride:n,offset:8}),s=new R(t,{itemSize:1,dataType:F.Float,stride:n,offset:12,normalized:!1}),a=new R(t,{itemSize:4,dataType:F.UnsignedByte,stride:n,offset:16,normalized:!0});return new he(e,{a_vec2_vertex:i,a_vec2_widen:o,a_float_texture:r,a_float_height:s,a_vec4_identifier:a})},D1=(t,e)=>{const i=new R(t,{itemSize:2,dataType:F.UnsignedShort,stride:28,offset:0,normalized:!0}),o=new R(t,{itemSize:2,dataType:F.Short,stride:28,offset:4,normalized:!1}),r=new R(t,{itemSize:2,dataType:F.Byte,stride:28,offset:8,normalized:!1}),s=new R(t,{itemSize:1,dataType:F.Float,stride:28,offset:12,normalized:!1}),a=new R(t,{itemSize:1,dataType:F.Float,stride:28,offset:16,normalized:!1}),l=new R(t,{itemSize:1,dataType:F.Float,stride:28,offset:20,normalized:!1}),c=new R(t,{itemSize:4,dataType:F.UnsignedByte,stride:28,offset:24,normalized:!0});return new he(e,{a_vec2_vertex:i,a_vec2_texture_widen:r,a_vec2_widen:o,a_float_vertex_distance:s,a_float_component_distance:a,a_float_object_length:l,a_vec4_identifier:c})},N1=(t,e)=>{const n=dr.sinks.stroke3d.stride,i=new R(t,{itemSize:2,dataType:F.UnsignedShort,stride:n,offset:0,normalized:!0}),o=new R(t,{itemSize:2,dataType:F.Short,stride:n,offset:4,normalized:!1}),r=new R(t,{itemSize:2,dataType:F.Byte,stride:n,offset:8,normalized:!1}),s=new R(t,{itemSize:1,dataType:F.Float,stride:n,offset:12,normalized:!1}),a=new R(t,{itemSize:1,dataType:F.Float,stride:n,offset:16,normalized:!1}),l=new R(t,{itemSize:1,dataType:F.Float,stride:n,offset:20,normalized:!1}),c=new R(t,{itemSize:1,dataType:F.Float,stride:n,offset:24,normalized:!1}),d=new R(t,{itemSize:4,dataType:F.UnsignedByte,stride:n,offset:28,normalized:!0});return new he(e,{a_vec2_vertex:i,a_vec2_texture_widen:r,a_vec2_widen:o,a_float_vertex_distance:s,a_float_component_distance:a,a_float_object_length:l,a_float_height:c,a_vec4_identifier:d})},U1=(t,e)=>{const i=new R(t,{itemSize:3,dataType:F.UnsignedShort,stride:36,offset:0,normalized:!0}),o=new R(t,{itemSize:3,dataType:F.Short,stride:36,offset:6,normalized:!0}),r=new R(t,{itemSize:2,dataType:F.Short,stride:36,offset:12,normalized:!1}),s=new R(t,{itemSize:2,dataType:F.Short,stride:36,offset:16,normalized:!1}),a=new R(t,{itemSize:2,dataType:F.UnsignedShort,stride:36,offset:20,normalized:!1}),l=new R(t,{itemSize:4,dataType:F.UnsignedByte,stride:36,offset:28,normalized:!0}),c=new R(t,{itemSize:4,dataType:F.UnsignedByte,stride:36,offset:32,normalized:!0});return new he(e,{a_vec3_flat_position:i,a_vec3_ecef_position:o,a_vec2_check_offset:s,a_vec2_offset:r,a_vec2_texcoord:a,a_vec4_tex_identifier:l,a_vec4_sprite_identifier:c})},$P=(t,e)=>{const i=new R(t,{itemSize:3,dataType:F.UnsignedShort,stride:36,offset:0,normalized:!0}),o=new R(t,{itemSize:3,dataType:F.Short,stride:36,offset:6,normalized:!0}),r=new R(t,{itemSize:2,dataType:F.Short,stride:36,offset:12,normalized:!1}),s=new R(t,{itemSize:4,dataType:F.UnsignedByte,stride:36,offset:24,normalized:!0});return new he(e,{a_vec3_flat_position:i,a_vec3_ecef_position:o,a_vec2_offset:r,a_vec4_identifier:s})},Jd=(t,e)=>{const i=new R(t,{itemSize:3,dataType:F.UnsignedShort,stride:28,offset:0,normalized:!0}),o=new R(t,{itemSize:2,dataType:F.UnsignedShort,stride:28,offset:8,normalized:!1}),r=new R(t,{itemSize:2,dataType:F.Float,stride:28,offset:12,normalized:!1}),s=new R(t,{itemSize:2,dataType:F.Float,stride:28,offset:20,normalized:!1});return new he(e,{a_vec4_position:i,a_vec2_offset:r,a_vec2_texcoord:o,a_vec2_style_zoom_limits:s})},G1=(t,e)=>{const n=oe.sinks.fill.stride,i=new R(t,{itemSize:2,dataType:F.UnsignedShort,stride:n,offset:0,normalized:!0}),o=new R(t,{itemSize:1,dataType:F.Float,stride:n,offset:4,normalized:!1}),r=new R(t,{itemSize:3,dataType:F.Byte,stride:n,offset:8,normalized:!1}),s=new R(t,{itemSize:1,dataType:F.Byte,stride:n,offset:11,normalized:!1}),a=new R(t,{itemSize:2,dataType:F.Short,stride:n,offset:16,normalized:!1}),l=new R(t,{itemSize:1,dataType:F.Float,stride:n,offset:16,normalized:!1}),c=new R(t,{itemSize:4,dataType:F.UnsignedByte,stride:n,offset:12,normalized:!0}),d=new R(t,{itemSize:1,dataType:F.UnsignedByte,stride:n,offset:20,normalized:!1});return new he(e,{a_vec2_vertex:i,a_float_z:o,a_vec3_normal:r,a_float_gradient:s,a_vec2_dem_position:a,a_float_abs_z:l,a_vec4_identifier:c,a_float_is_pivot:d})},WP=(t,e)=>{const n=oe.sinks.fill.stride,i=new R(t,{itemSize:2,dataType:F.UnsignedShort,stride:n,offset:0,normalized:!0}),o=new R(t,{itemSize:1,dataType:F.Float,stride:n,offset:4,normalized:!1}),r=new R(t,{itemSize:3,dataType:F.Byte,stride:n,offset:8,normalized:!1}),s=new R(t,{itemSize:1,dataType:F.Byte,stride:n,offset:11,normalized:!1}),a=new R(t,{itemSize:2,dataType:F.Short,stride:n,offset:16,normalized:!1}),l=new R(t,{itemSize:1,dataType:F.Float,stride:n,offset:16,normalized:!1}),c=new R(t,{itemSize:1,dataType:F.UnsignedByte,stride:n,offset:20,normalized:!1}),d=new R(t,{itemSize:4,dataType:F.UnsignedByte,stride:n,offset:24,normalized:!0});return new he(e,{a_vec2_vertex:i,a_float_z:o,a_vec3_normal:r,a_float_gradient:s,a_vec2_dem_position:a,a_float_abs_z:l,a_vec4_identifier:d,a_float_is_pivot:c})},H1=(t,e)=>{const n=oe.sinks.fill.stride,i=new R(t,{itemSize:2,dataType:F.UnsignedShort,stride:n,offset:0,normalized:!0}),o=new R(t,{itemSize:1,dataType:F.Float,stride:n,offset:4,normalized:!1}),r=new R(t,{itemSize:2,dataType:F.Short,stride:n,offset:16,normalized:!1}),s=new R(t,{itemSize:1,dataType:F.Float,stride:n,offset:16,normalized:!1}),a=new R(t,{itemSize:1,dataType:F.UnsignedByte,stride:n,offset:20,normalized:!1});return new he(e,{a_vec2_vertex:i,a_float_z:o,a_vec2_dem_position:r,a_float_abs_z:s,a_float_is_pivot:a})},Qd=(t,e)=>{const n=oe.sinks.inverse.stride,i=new R(t,{itemSize:2,dataType:F.UnsignedShort,stride:n,offset:0,normalized:!0}),o=new R(t,{itemSize:1,dataType:F.Float,stride:n,offset:4,normalized:!1}),r=new R(t,{itemSize:2,dataType:F.Short,stride:n,offset:8,normalized:!1}),s=new R(t,{itemSize:1,dataType:F.Float,stride:n,offset:8,normalized:!1}),a=new R(t,{itemSize:1,dataType:F.UnsignedByte,stride:n,offset:12,normalized:!1});return new he(e,{a_vec2_vertex:i,a_float_z:o,a_vec2_dem_position:r,a_float_abs_z:s,a_float_is_pivot:a})},ZP=(t,e)=>{const n=oe.sinks.stroke.stride,i=new R(t,{itemSize:2,dataType:F.UnsignedShort,stride:n,offset:0,normalized:!0}),o=new R(t,{itemSize:1,dataType:F.Float,stride:n,offset:4,normalized:!1}),r=new R(t,{itemSize:4,dataType:F.Byte,stride:n,offset:8,normalized:!1}),s=new R(t,{itemSize:2,dataType:F.Short,stride:n,offset:12,normalized:!1}),a=new R(t,{itemSize:1,dataType:F.Float,stride:n,offset:12,normalized:!1}),l=new R(t,{itemSize:1,dataType:F.UnsignedByte,stride:n,offset:16,normalized:!1});return new he(e,{a_vec2_vertex:i,a_float_z:o,a_vec4_direction_distance:r,a_vec2_dem_position:s,a_float_abs_z:a,a_float_is_pivot:l})},eu=(t,e)=>{const n=Bo.sinks.sideFill.stride,i=new R(t,{itemSize:4,dataType:F.UnsignedShort,stride:n,offset:0,normalized:!0}),o=new R(t,{itemSize:2,dataType:F.Short,stride:n,offset:12,normalized:!1});return new he(e,{a_vec4_vertex:i,a_vec2_dem_position:o})},V1=(t,e)=>{const n=Bo.sinks.sideFill.stride,i=new R(t,{itemSize:4,dataType:F.UnsignedShort,stride:n,offset:0,normalized:!0}),o=new R(t,{itemSize:4,dataType:F.UnsignedByte,stride:n,offset:8,normalized:!0}),r=new R(t,{itemSize:2,dataType:F.Short,stride:n,offset:12,normalized:!1});return new he(e,{a_vec4_vertex:i,a_vec4_identifier:o,a_vec2_dem_position:r})},j1=(t,e)=>{const n=Bo.sinks.sideFill.stride,i=new R(t,{itemSize:4,dataType:F.UnsignedShort,stride:n,offset:0,normalized:!0}),o=new R(t,{itemSize:2,dataType:F.Short,stride:n,offset:12,normalized:!1}),r=new R(t,{itemSize:4,dataType:F.UnsignedByte,stride:n,offset:16,normalized:!0});return new he(e,{a_vec4_vertex:i,a_vec4_identifier:r,a_vec2_dem_position:o})},$1=(t,e)=>{const n=Bo.sinks.sideFill.stride,i=new R(t,{itemSize:3,dataType:F.UnsignedShort,stride:n,offset:0,normalized:!0}),o=new R(t,{itemSize:2,dataType:F.Short,stride:n,offset:12,normalized:!1});return new he(e,{a_vec3_vertex:i,a_vec2_dem_position:o})},XP=(t,e)=>{const n=ko.sinks.fill.stride,i=new R(t,{itemSize:4,dataType:F.UnsignedShort,stride:n,offset:0,normalized:!0}),o=new R(t,{itemSize:2,dataType:F.Short,stride:n,offset:8,normalized:!1});return new he(e,{a_vec4_vertex:i,a_vec2_dem_position:o})},YP=(t,e)=>{const n=ko.sinks.fill.stride,i=new R(t,{itemSize:3,dataType:F.UnsignedShort,stride:n,offset:0,normalized:!0}),o=new R(t,{itemSize:2,dataType:F.Short,stride:n,offset:8,normalized:!1});return new he(e,{a_vec3_vertex:i,a_vec2_dem_position:o})},W1=(t,e)=>{const i=new R(t,{itemSize:4,dataType:F.UnsignedShort,stride:20,offset:0,normalized:!0}),o=new R(t,{itemSize:1,dataType:F.Short,stride:20,offset:6,normalized:!0}),r=new R(t,{itemSize:2,dataType:F.Byte,stride:20,offset:8,normalized:!1}),s=new R(t,{itemSize:2,dataType:F.Byte,stride:20,offset:10,normalized:!1}),a=new R(t,{itemSize:3,dataType:F.Byte,stride:20,offset:12,normalized:!1}),l=new R(t,{itemSize:2,dataType:F.Short,stride:20,offset:16,normalized:!1});return new he(e,{a_vec4_vertex:i,a_vec2_normal:r,a_vec2_normal_delta:s,a_vec3_direction:a,a_float_distance:o,a_vec2_dem_position:l})},qP=(t,e)=>{const i=new R(t,{itemSize:3,dataType:F.UnsignedShort,stride:40,offset:0,normalized:!0}),o=new R(t,{itemSize:3,dataType:F.Short,stride:40,offset:6,normalized:!0}),r=new R(t,{itemSize:2,dataType:F.Short,stride:40,offset:12,normalized:!1}),s=new R(t,{itemSize:2,dataType:F.Short,stride:40,offset:16,normalized:!1}),a=new R(t,{itemSize:2,dataType:F.UnsignedShort,stride:40,offset:20,normalized:!1}),l=new R(t,{itemSize:2,dataType:F.Short,stride:40,offset:24,normalized:!1}),c=new R(t,{itemSize:4,dataType:F.UnsignedByte,stride:40,offset:32,normalized:!0});return new he(e,{a_vec3_flat_position:i,a_vec3_ecef_position:o,a_vec2_offset:r,a_vec2_check_offset:s,a_vec2_texcoord:a,a_vec2_range:l,a_vec4_tex_identifier:c})},KP=(t,e)=>{const i=new R(t,{itemSize:3,dataType:F.UnsignedShort,stride:40,offset:0,normalized:!0}),o=new R(t,{itemSize:3,dataType:F.Short,stride:40,offset:6,normalized:!0}),r=new R(t,{itemSize:2,dataType:F.Short,stride:40,offset:12,normalized:!1}),s=new R(t,{itemSize:2,dataType:F.UnsignedShort,stride:40,offset:20,normalized:!1}),a=new R(t,{itemSize:2,dataType:F.Short,stride:40,offset:24,normalized:!1}),l=new R(t,{itemSize:4,dataType:F.UnsignedByte,stride:40,offset:36,normalized:!0});return new he(e,{a_vec3_flat_position:i,a_vec3_ecef_position:o,a_vec2_offset:r,a_vec2_texcoord:s,a_vec2_range:a,a_vec4_identifier:l})},JP=(t,e)=>{const i=new R(t,{itemSize:3,dataType:F.UnsignedShort,stride:40,offset:0,normalized:!0}),o=new R(t,{itemSize:3,dataType:F.Short,stride:40,offset:6,normalized:!0}),r=new R(t,{itemSize:2,dataType:F.Short,stride:40,offset:12,normalized:!1}),s=new R(t,{itemSize:2,dataType:F.UnsignedShort,stride:40,offset:20,normalized:!1}),a=new R(t,{itemSize:2,dataType:F.Short,stride:40,offset:24,normalized:!1}),l=new R(t,{itemSize:4,dataType:F.UnsignedByte,stride:40,offset:28,normalized:!0});return new he(e,{a_vec3_flat_position:i,a_vec3_ecef_position:o,a_vec2_offset:r,a_vec2_texcoord:s,a_vec2_range:a,a_vec4_identifier:l})},QP=(t,e)=>{const i=new R(t,{itemSize:3,dataType:F.UnsignedShort,stride:16,offset:0,normalized:!0}),o=new R(t,{itemSize:2,dataType:F.Short,stride:16,offset:8,normalized:!1}),r=new R(t,{itemSize:4,dataType:F.UnsignedByte,stride:16,offset:12,normalized:!0});return new he(e,{a_vec4_position:i,a_vec2_offset:o,a_vec4_identifier:r})},Z1=(t,e)=>{const i=new R(t,{itemSize:2,dataType:F.UnsignedShort,stride:12,offset:0,normalized:!0}),o=new R(t,{itemSize:2,dataType:F.Byte,stride:12,offset:8,normalized:!1}),r=new R(t,{itemSize:2,dataType:F.Byte,stride:12,offset:10,normalized:!1});return new he(e,{a_vec2_position:i,a_vec2_direction:o,a_vec2_widen_direction:r})},eL=(t,e)=>{const n=Bi.sinks.fill.stride,i=new R(t,{itemSize:3,dataType:F.UnsignedShort,stride:n,offset:0,normalized:!0}),o=new R(t,{itemSize:2,dataType:F.UnsignedShort,stride:n,offset:8,normalized:!1}),r=new R(t,{itemSize:2,dataType:F.Short,stride:n,offset:16,normalized:!1});return new he(e,{a_vec3_vertex:i,a_vec2_texcoord:o,a_vec2_dem_position:r})},tL=(t,e)=>{const n=Bi.sinks.fill.stride,i=new R(t,{itemSize:3,dataType:F.UnsignedShort,stride:n,offset:0,normalized:!0}),o=new R(t,{itemSize:4,dataType:F.UnsignedByte,stride:n,offset:12,normalized:!0}),r=new R(t,{itemSize:2,dataType:F.Short,stride:n,offset:16,normalized:!1});return new he(e,{a_vec3_vertex:i,a_vec4_identifier:o,a_vec2_dem_position:r})},nL=(t,e)=>{const n=Bi.sinks.fill.stride,i=new R(t,{itemSize:3,dataType:F.UnsignedShort,stride:n,offset:0,normalized:!0}),o=new R(t,{itemSize:2,dataType:F.Short,stride:n,offset:16,normalized:!1}),r=new R(t,{itemSize:4,dataType:F.UnsignedByte,stride:n,offset:20,normalized:!0});return new he(e,{a_vec3_vertex:i,a_vec4_identifier:r,a_vec2_dem_position:o})},iL=(t,e)=>{const n=Bi.sinks.fill.stride,i=new R(t,{itemSize:3,dataType:F.UnsignedShort,stride:n,offset:0,normalized:!0}),o=new R(t,{itemSize:2,dataType:F.Short,stride:n,offset:16,normalized:!1});return new he(e,{a_vec3_vertex:i,a_vec2_dem_position:o})},oL=(t,e)=>{const i=new R(t,{itemSize:2,dataType:F.UnsignedShort,stride:8,offset:0,normalized:!0}),o=new R(t,{itemSize:4,dataType:F.Byte,stride:8,offset:4,normalized:!1});return new he(e,{a_vec3_vertex:i,a_vec4_direction_distance:o})},g_=(t,e)=>{const i=new R(t,{itemSize:3,dataType:F.UnsignedShort,stride:16,offset:0,normalized:!0}),o=new R(t,{itemSize:1,dataType:F.Float,stride:16,offset:4,normalized:!1}),r=new R(t,{itemSize:4,dataType:F.Byte,stride:16,offset:8,normalized:!1}),s=new R(t,{itemSize:2,dataType:F.Short,stride:16,offset:12,normalized:!1}),a=new R(t,{itemSize:1,dataType:F.Float,stride:16,offset:12,normalized:!1});return new he(e,{a_vec3_vertex:i,a_float_z:o,a_vec4_direction_distance:r,a_vec2_dem_position:s,a_float_abs_z:a})},X1=(t,e)=>{const i=new R(t,{itemSize:2,dataType:F.UnsignedShort,stride:36,offset:0,normalized:!0}),o=new R(t,{itemSize:2,dataType:F.UnsignedShort,stride:36,offset:4,normalized:!0}),r=new R(t,{itemSize:4,dataType:F.Byte,stride:36,offset:8,normalized:!1}),s=new R(t,{itemSize:2,dataType:F.Short,stride:36,offset:12,normalized:!1}),a=new R(t,{itemSize:2,dataType:F.Short,stride:36,offset:16,normalized:!1}),l=new R(t,{itemSize:1,dataType:F.Float,stride:36,offset:20,normalized:!1}),c=new R(t,{itemSize:1,dataType:F.Float,stride:36,offset:24,normalized:!1}),d=new R(t,{itemSize:1,dataType:F.Float,stride:36,offset:28,normalized:!1}),u=new R(t,{itemSize:4,dataType:F.UnsignedByte,stride:36,offset:32,normalized:!0});return new he(e,{a_vec2_vertex:i,a_vec2_segment_end:o,a_vec4_texture_widen_arrow_widen:r,a_vec2_widen:s,a_vec2_direction:a,a_float_distance_from_start:l,a_float_object_length:c,a_float_type:d,a_vec4_identifier:u})},v_=(t,e)=>{const n=Ja.sinks.fill.stride,i=new R(t,{itemSize:3,dataType:F.UnsignedShort,stride:n,offset:0,normalized:!0}),o=new R(t,{itemSize:3,dataType:F.Short,stride:n,offset:6,normalized:!0}),r=new R(t,{itemSize:2,dataType:F.Short,stride:n,offset:12,normalized:!1});return new he(e,{a_vec3_flat_position:i,a_vec3_ecef_position:o,a_vec2_widen:r})},rL=(t,e)=>{const n=Ja.sinks.fill.stride,i=new R(t,{itemSize:3,dataType:F.UnsignedShort,stride:n,offset:0,normalized:!0}),o=new R(t,{itemSize:3,dataType:F.Short,stride:n,offset:6,normalized:!0}),r=new R(t,{itemSize:2,dataType:F.Short,stride:n,offset:12,normalized:!1}),s=new R(t,{itemSize:4,dataType:F.UnsignedByte,stride:n,offset:16,normalized:!0});return new he(e,{a_vec3_flat_position:i,a_vec3_ecef_position:o,a_vec2_widen:r,a_vec4_identifier:s})},sL=(t,e)=>{const n=wf.sinks.fill.stride,i=new R(t,{itemSize:2,dataType:F.UnsignedShort,stride:n,offset:0,normalized:!0}),o=new R(t,{itemSize:2,dataType:F.UnsignedShort,stride:n,offset:4,normalized:!1});return new he(e,{a_vec2_vertex:i,a_vec2_texcoord:o})},aL=(t,e)=>{const n=Br.sinks.framebuffer.stride,i=new R(t,{itemSize:2,dataType:F.UnsignedShort,stride:n,offset:0,normalized:!0}),o=new R(t,{itemSize:1,dataType:F.Float,stride:n,offset:4,normalized:!1}),r=new R(t,{itemSize:2,dataType:F.Byte,stride:n,offset:8,normalized:!1});return new he(e,{a_vec2_position:i,a_vec2_widen:r,a_float_weight:o})},lL=(t,e)=>{const n=new R(t,{itemSize:2,dataType:F.Float,stride:0,offset:0,normalized:!1});return new he(e,{a_vec2_position:n})},Y1=(t,e)=>{const i=new R(t,{itemSize:3,dataType:F.Float,stride:12,offset:0});return new he(e,{a_vec3_position:i})},Ia=(t,e)=>new he(e,{a_vec2_position:t}),y_=(t,e)=>{const n=xn.sinks.elevation.stride,i=new R(t,{itemSize:2,dataType:F.UnsignedShort,stride:n,offset:0,normalized:!0}),o=new R(t,{itemSize:3,dataType:F.Float,stride:n,offset:4,normalized:!1}),r=new R(t,{itemSize:1,dataType:F.Float,stride:n,offset:16,normalized:!1});return new he(e,{a_vec2_vertex:i,a_vec3_normal:o,a_float_height:r})},cL=(t,e)=>{const n=xn.sinks.flatBottom.stride,i=new R(t,{itemSize:2,dataType:F.UnsignedShort,stride:n,offset:0,normalized:!0}),o=new R(t,{itemSize:2,dataType:F.Short,stride:n,offset:4,normalized:!1}),r=new R(t,{itemSize:2,dataType:F.Byte,stride:n,offset:8,normalized:!0});return new he(e,{a_vec2_vertex:i,a_vec2_centroid:o,a_vec2_extender:r})},Mp=(t,e)=>{const n=xn.sinks.hillshade.stride,i=new R(t,{itemSize:2,dataType:F.UnsignedShort,stride:n,offset:0,normalized:!0}),o=new R(t,{itemSize:2,dataType:F.UnsignedShort,stride:n,offset:4,normalized:!1});return new he(e,{a_vec2_vertex:i,a_vec2_texcoord:o})},tu=t=>(e,n,i,o)=>{const r=Ni.sinks.instances.stride,s=new R(e,{itemSize:3,dataType:F.UnsignedShort,stride:r,offset:0,normalized:!0,instanceDivisor:1}),a=new R(e,{itemSize:3,dataType:F.Short,stride:r,offset:8,normalized:!0,instanceDivisor:1}),l=new R(e,{itemSize:9,dataType:F.Float,stride:r,offset:16,instanceDivisor:1}),c=new R(e,{itemSize:4,dataType:F.UnsignedByte,stride:r,offset:t?56:52,normalized:!0,instanceDivisor:1}),d=new R(e,{itemSize:1,dataType:F.Float,stride:r,offset:60,normalized:!1,instanceDivisor:1});return new he(n,{a_vec3_instance_position:s,a_vec3_instance_ecef_position:a,a_mat3_instance_matrix:l,a_vec4_instance_localid:c,a_float_abs_z:d,...o},i)},b_=(t,e)=>{const n=el.sinks.fill.stride,i=new R(t,{itemSize:2,dataType:F.UnsignedShort,stride:n,offset:0,normalized:!0}),o=new R(t,{itemSize:1,dataType:F.Float,stride:n,offset:4,normalized:!1}),r=new R(t,{itemSize:2,dataType:F.Short,stride:n,offset:8,normalized:!1}),s=new R(t,{itemSize:3,dataType:F.Byte,stride:n,offset:12,normalized:!1}),a=new R(t,{itemSize:1,dataType:F.Byte,stride:n,offset:15,normalized:!1}),l=new R(t,{itemSize:2,dataType:F.Short,stride:n,offset:16,normalized:!1}),c=new R(t,{itemSize:1,dataType:F.Float,stride:n,offset:16,normalized:!1}),d=new R(t,{itemSize:1,dataType:F.UnsignedByte,stride:n,offset:20,normalized:!1});return new he(e,{a_vec2_vertex:i,a_float_z:o,a_vec2_extender:r,a_vec3_normal:s,a_float_gradient:a,a_vec2_dem_position:l,a_float_abs_z:c,a_float_is_pivot:d})},dL=(t,e)=>{const n=new R(t,{itemSize:2,dataType:F.Float,stride:0,offset:0,normalized:!1});return new he(e,{a_vec2_vertex:n})},Db=(t,e)=>{const n=new R(t,{itemSize:2,dataType:F.Byte,stride:0,offset:0,normalized:!1});return new he(e,{a_vec2_vertex:n})},uL=(t,e)=>{const n=new R(t,{itemSize:2,dataType:F.Byte,stride:0,offset:0,normalized:!1});return new he(e,{a_vec2_vertex:n})},q1=(t,e,n)=>{const i=tl.sinks.fill.stride;return new he(e,{a_vec3_ecef_position:new R(t,{itemSize:3,dataType:F.Short,stride:i,normalized:!0,offset:0}),a_vec3_flat_position:new R(t,{itemSize:3,dataType:F.UnsignedShort,stride:i,normalized:!0,offset:6}),a_vec2_texture:new R(t,{itemSize:2,dataType:F.UnsignedShort,stride:i,normalized:!0,offset:12})},n)},fL=(t,e)=>new he(e,{a_vec3_position:new R(t,{itemSize:3,dataType:F.Float,stride:16,offset:0,normalized:!0}),a_fade_opacity:new R(t,{itemSize:1,dataType:F.Float,stride:16,offset:12,normalized:!1})}),Oa=32,K1=1/0,hL="raster";class Tp extends H0{constructor(e,n,i,o){var s,a;super(hL),this.children=[],this.identifyChildren=[];const r=this;this.setTileCoords(e,n.map.state),(a=(s=n.renderer.symbolSettingsList.dem)==null?void 0:s[o])==null||a.forEach(l=>{const c={id:mo(),type:ri.Tile,symbol:"dem",sink:o,tile:this,attributes:{layerId:no,styleId:n.map.state.handyStyleId,tileData:[]},start:0,count:Oa*Oa*6,attributesHash:"",layerSettings:l,vao:i[o],canRender:!0,renderingProperties:{flatTexture:null,hillshadeTexture:null,flatIdentifyTexture:null}};l.identify?r.identifyChildren.push(c):l.depthTest?r.depthTestChildren.push(c):l.shadow?r.shadowChildren.push(c):r.children.push(c)})}setTileCoords(e,n){const i=e[2],o=e[3],r=Nt(i);this.coords=e,this.size=r,this.zoomLevel=i,this.detailLevel=o,this.mvpMatrices.clear(),this.demMatrices.clear(),this.flatMapTexMatrices.clear(),this.syncReplicas(n)}syncReplicas({visibleMapReplicas:e}){const n=Math.pow(2,this.coords[2]),i=this.size/Oa;this.bounds.clear(),this.modelMatrices.clear(),e.forEach(o=>{const r=[this.coords[0]+o*n,this.coords[1],this.coords[2],this.coords[3]],s=Di(r);s[0]-=i,s[1]-=i,this.bounds.set(o,{min:[s[0],s[1]],max:[s[0]+this.size,s[1]+this.size]});const a=Ui();ro(a,s,yt(this.size+i,this.size+i,Ha)),this.modelMatrices.set(o,a)}),this.needSync=!1}}class _L{constructor(e,n){this.meshTiles=new Map,this.groundTiles=new Map,this.destroyed=!1,this.modules=e.modules,this.maxZoom=(n==null?void 0:n.maxZoom)??K1;const i=[];for(let r=0;r<Oa;r++)for(let s=0;s<Oa;s++)i.push(s,r,s+1,r,s,r+1),i.push(s,r+1,s+1,r,s+1,r+1);const o=vt/Oa;for(let r=0;r<i.length;r++)i[r]*=o;this.buffer=new F(new Uint16Array(i),{itemSize:2,dataType:F.UnsignedShort,stride:0,offset:0,normalized:!0}),this.buffer.drawType=F.StaticDraw,this.vaos={mesh:Ia(this.buffer,this.modules.renderer.getShaderProgram("demMesh")),ground:Ia(this.buffer,this.modules.renderer.getShaderProgram("demGround"))},this.update()}destroy(){this.destroyed||(this.meshTiles=new Map,this.groundTiles=new Map,Object.values(this.vaos).forEach(e=>{e.unbind(),e.remove()}),this.buffer.remove(),this.destroyed=!0)}setMaxZoom(e=K1){e!==this.maxZoom&&(this.maxZoom=e,this.update())}update(){if(this.destroyed)return;const e=this.modules.map.state;e.needReplicasUpdate&&(this.meshTiles.forEach(r=>{r.needSync=!0}),this.groundTiles.forEach(r=>{r.needSync=!0}));const n=Math.trunc(e.styleZoom),i=Math.min(n,Math.min(this.maxZoom,n)),o=F3(this.modules.map.state,this.modules,i,0,i).reduce((r,s)=>(r.set(Ge(s),s),r),new Map);this.meshTiles.forEach((r,s)=>{o.has(s)||(this.meshTiles.delete(s),this.groundTiles.delete(s))}),o.forEach((r,s)=>{this.meshTiles.has(s)||(this.meshTiles.set(s,new Tp(r,this.modules,this.vaos,"mesh")),this.groundTiles.set(s,new Tp(r,this.modules,this.vaos,"ground")))})}updateStyleId(){this.meshTiles.forEach(e=>this.updateTileStyleId(e)),this.groundTiles.forEach(e=>this.updateTileStyleId(e))}updateTileStyleId(e){e.children.forEach(n=>{n.attributes.styleId=this.modules.map.state.handyStyleId}),e.identifyChildren.forEach(n=>{n.attributes.styleId=this.modules.map.state.handyStyleId}),e.depthTestChildren.forEach(n=>{n.attributes.styleId=this.modules.map.state.handyStyleId}),e.shadowChildren.forEach(n=>{n.attributes.styleId=this.modules.map.state.handyStyleId})}}class og{constructor(e,n=!1){this.dataType=e,this.pendingRequests=new Map,this.ignoredStatusCodes=n?[204,404]:[204]}async fetch(e,n,i=3,o=300){var s;let r=0;for(;r<=i;)try{const a=await this.fetchAttempt(e,n);if(!a.error||!mb((s=a.error)==null?void 0:s.status))return a;throw new Error(`Fetching ${e} attempt ${r} failed.`)}catch{if(r>=i)return{rejected:!0};await pb(Math.pow(2,r)*o),r++}return{rejected:!0}}destroy(){this.pendingRequests.forEach((e,n)=>{this.abortRequest(n)})}abortRequest(e){const n=this.pendingRequests.get(e);n!==void 0&&(n.xhr.abort(),n.resolve({rejected:!0}),this.pendingRequests.delete(e))}fetchAttempt(e,n){return new Promise(i=>{const o=n(e),r=Ge(e),a=(this.dataType==="json"?IA:q0)({url:o},(l,c)=>{if(this.pendingRequests.delete(r),l!==void 0){this.ignoredStatusCodes.includes(l.status)||console.error(`Failed to fetch a tile by url "${o}" Error: status "${l.status}", message: ${l.message}`),i({error:l});return}i({data:c})});this.pendingRequests.set(r,{xhr:a,resolve:i})})}}class mL{constructor(e,n,i){this.id=e,this.modules=n,this.options=i,this.type="dem",this.tree=z0(),this.tileSize=va,this.minElevation=0,this.revision=0,this.tileLoader=new og("arrayBuffer"),this.attributes={},this.tiles=new Map,this.textureIndices=new Map,this.url=o=>{const[r,s,a]=ah(o);return this.options.url(r,s,a)}}abortTileFetch(e){this.tileLoader.abortRequest(Ge(e))}deleteTile(e){const n=Ge(e);if(this.tiles.get(n)){const o=Xr(e);this.tree.remove({minX:o.min[0],minY:o.min[1],maxX:o.max[0],maxY:o.max[1]},(r,s)=>n===s.key),this.updateRevision()}this.tiles.delete(n);const i=this.textureIndices.get(n);i!==void 0&&this.modules.imageManager.deleteTexture(i),this.updateMinElevation()}fetchTile(e){const n=Ge(e),i=[{regionId:0,metatileHash:-1}];if(this.tiles.has(n))return Promise.resolve(i);const o=this.url(e);return this.tileLoader.fetch(e,()=>o).then(r=>(r.rejected||(this.tiles.set(n,r.data&&r.data.byteLength?this.unpackRaw(r.data,e):void 0),this.updateRevision()),i),()=>Promise.resolve(void 0))}async generateTile(e,n,i,o,r,s){const a=[],l=[],c=Ge(n),d=this.tiles.get(c);if(!d)return Promise.resolve({results:a,transferable:l});const u=this.modules.map.state.handyStyleId,{collector:f}=this.modules,h=Nt(n[2]),_=d.bounds;this.tree.insert({key:c,minX:_.min[0],minY:_.min[1],maxX:_.max[0],maxY:_.max[1],cellSize:h/va,...d}),this.updateMinElevation();do xn.generateMeshElevation(f,d.mesh,u,no);while(f.isOverloaded());const p=f.getAccumulatedData();return a.push({regionId:0,metatileHash:-1,styleId:u,collectorOutput:p}),l.push(...p.transferable),Promise.resolve({results:a,transferable:l})}unpackRaw(e,n){const[i,o,r,s]=n,a=new Uint8Array(e),l=new Float32Array(this.tileSize**2);let c=1/0,d=-1/0;const u=this.tileSize;for(let _=0;_<u;_++){const p=q.toGeo(Di([i,o+_*(1/va),r,s])),m=q.scaleFactor(p[1]);for(let g=0;g<u;g++){const y=g+_*u,b=(a[y]+a[u**2+y]*256-1e4)*m;c=Math.min(b,c),d=Math.max(b,d),l[y]=b}}const f=this.getMesh(l),h=a5(f.vertices,f.indices);return{data:l,mesh:f,tree:h,minZ:c,maxZ:d,bounds:{min:Di(n),max:Di([i+1,o+1,r,s])}}}getAttributes(){return this.attributes}setAttributes(e){this.attributes=e}getId(){return this.id}destroy(){const{imageManager:e}=this.modules;this.tileLoader.destroy(),this.tiles.clear(),this.tree.clear(),this.textureIndices.forEach(n=>e.deleteTexture(n)),this.textureIndices.clear()}getElevation(e){const n=this.getElevationTile(e);if(n)return l5(n,e)}getElevationTile(e){const n=$r(e);return this.tree.search({minX:n[0],minY:n[1],maxX:n[0],maxY:n[1]}).reduce((o,r)=>!o||o.cellSize>r.cellSize?r:o,void 0)}getMinElevation(){return this.minElevation}updateMinElevation(){const e=this.modules.map.state;if(!e.demMode)return;const n=this.modules.camera.position[2],i=fl(e.tilesBounds);if(e.elevation!==void 0){const r=e.elevation*He/n+1,s=Math.max(e.pitch/e.maxPitch*30,4);i3(i,Math.min(r,s))}const o=this.tree.search({minX:i.min[0],minY:i.min[1],maxX:i.max[0],maxY:i.max[1]});e.styleZoom-sg>1?this.minElevation=o.reduce((r,s)=>{if(s.data){const a=Zx(i,s.bounds);ti(a.min,a.min,s.bounds.min),ti(a.max,a.max,s.bounds.min),Gn(a.min,a.min,1/s.cellSize),Gn(a.max,a.max,1/s.cellSize);for(let l=Math.trunc(a.min[0]);l<a.max[0];l++)for(let c=Math.trunc(a.min[1]);c<a.max[1];c++){const d=l+(va-1-c)*va,u=s.data[d];r=r===void 0?u:Math.min(r,u)}}return r},void 0):this.minElevation=o.reduce((r,s)=>r===void 0?s.minZ:Math.min(r,s.minZ),void 0)}getRevision(){return this.revision}updateRevision(){this.revision++}getMesh(e){const n=this.tileSize,i=[],o=[];let r=0;for(let s=0;s<n;s++)for(let a=0;a<n;a++){const l=s*n+a;i[3*l+0]=a/(n-1)*Se,i[3*l+1]=(1-s/(n-1))*Se,i[3*l+2]=e[l],a<n-1&&s<n-1&&(o[r++]=l+1,o[r++]=l,o[r++]=l+n,o[r++]=l+1,o[r++]=l+n,o[r++]=l+n+1)}return{vertices:i,indices:o,normals:new Float32Array(n*n*3)}}}var w_,J1;function pL(){if(J1)return w_;J1=1,w_=i;var t=128,e=-128,n=Math.pow(2,31);function i(o,r,s){if(Number.MAX_SAFE_INTEGER&&o>Number.MAX_SAFE_INTEGER)throw i.bytes=0,new RangeError("Could not encode varint");r=r||[],s=s||0;for(var a=s;o>=n;)r[s++]=o&255|t,o/=128;for(;o&e;)r[s++]=o&255|t,o>>>=7;return r[s]=o|0,i.bytes=s-a+1,r}return w_}var x_,Q1;function gL(){if(Q1)return x_;Q1=1,x_=n;var t=128,e=127;function n(i,s){var r=0,s=s||0,a=0,l=s,c,d=i.length;do{if(l>=d||a>49)throw n.bytes=0,new RangeError("Could not decode varint");c=i[l++],r+=a<28?(c&e)<<a:(c&e)*Math.pow(2,a),a+=7}while(c>=t);return n.bytes=l-s,r}return x_}var S_,ey;function vL(){if(ey)return S_;ey=1;var t=Math.pow(2,7),e=Math.pow(2,14),n=Math.pow(2,21),i=Math.pow(2,28),o=Math.pow(2,35),r=Math.pow(2,42),s=Math.pow(2,49),a=Math.pow(2,56),l=Math.pow(2,63);return S_=function(c){return c<t?1:c<e?2:c<n?3:c<i?4:c<o?5:c<r?6:c<s?7:c<a?8:c<l?9:10},S_}var M_,ty;function yL(){return ty||(ty=1,M_={encode:pL(),decode:gL(),encodingLength:vL()}),M_}var bL=yL();const ny=ll(bL);class wL{constructor(e){const n=ArrayBuffer.isView(e)?e.buffer:e;this.buf=new Uint8Array(n),this.view=new DataView(n),this.pos=0}readBytes(e){const n=this.buf.subarray(this.pos,this.pos+e);return this.pos+=e,n}readUint16(){const e=this.view.getUint16(this.pos,!0);return this.pos+=2,e}readUint32(){const e=this.view.getUint32(this.pos,!0);return this.pos+=4,e}readInt32(){const e=this.view.getInt32(this.pos,!0);return this.pos+=4,e}readVarint(){const e=ny.decode(this.buf,this.pos);return this.pos+=ny.decode.bytes??0,e}readSVarint(){const e=this.readVarint();return e%2===1?(e+1)/-2:e/2}}function xL(t){const e=new wL(t);e.readUint32(),e.readUint16(),e.readUint16(),e.readUint16(),e.readUint16();const n=T_(e.readInt32()),i=T_(e.readInt32()),o=e.readUint32(),r=[];for(let s=0;s<o;s++){const a=e.readUint32(),l=new Uint16Array(a*2);for(let m=0;m<a;m++)l[m*2]=e.readUint16(),l[m*2+1]=e.readUint16();const c=[];iy(e,c,a,T_);const d=[];for(let m=0;m<a;m++)d.push(l[m*2]),d.push(l[m*2+1]),d.push(c[m]);const u=e.readUint32(),f=[];iy(e,f,u);const h={vertices:d,indices:f},_=e.readUint32();if(_>0){const m=[];new Int8Array(e.readBytes(_*3)).forEach(g=>m.push(SL(g))),h.normals=m}const p=e.readUint32();if(p>0){const m={};for(let g=0;g<p;g++){const y=e.readUint16(),b=e.readInt32();m[y]=b}h.attributes=m}r.push(h)}return{dataGroups:r,minZ:n,maxZ:i}}function iy(t,e,n,i){let o=0;for(let r=0;r<n;r++){const a=t.readSVarint()+o;e.push(i?i(a):a),o=a}}function T_(t){return t/He}function SL(t){return t/127}function ML(t){const e=new rh(t),n=I_(e.readFixed32()),i=I_(e.readFixed32()),o=e.readFixed32(),r=e.readBytes(),s=new Uint16Array(r.buffer.slice(r.byteOffset,r.byteOffset+r.byteLength)),a=[];let l=0;for(let u=0;u<o;u++)a.push(s[u*2]),a.push(s[u*2+1]),a.push(I_(e.readSVarint()));const c=[];l=0;const d=e.readFixed32();for(let u=0;u<d;u++){const f=e.readSVarint(),h=l+f;l+=f,c.push(h)}return{dataGroups:[{vertices:a,indices:c}],minZ:n,maxZ:i}}function I_(t){return t/100}class TL{constructor(e,n,i){this.id=e,this.modules=n,this.options=i,this.type="dem",this.tree=z0(),this.minElevation=0,this.revision=0,this.tileLoader=new og("arrayBuffer"),this.attributes={},this.tiles=new Map,this.textureIndices=new Map,this.url=o=>{const[r,s,a]=ah(o);return this.options.url(r,s,a)}}abortTileFetch(e){this.tileLoader.abortRequest(Ge(e))}deleteTile(e){const n=Ge(e);if(this.tiles.get(n)){const o=Xr(e);this.tree.remove({minX:o.min[0],minY:o.min[1],maxX:o.max[0],maxY:o.max[1]},(r,s)=>n===s.key),this.updateRevision()}this.tiles.delete(n);const i=this.textureIndices.get(n);i!==void 0&&this.modules.imageManager.deleteTexture(i),this.updateMinElevation()}fetchTile(e){const n=Ge(e),i=[{regionId:0,metatileHash:-1}];if(this.tiles.has(n))return Promise.resolve(i);const o=this.url(e),r=Ct(e);return this.tileLoader.fetch(e,()=>o).then(s=>(s.rejected||(this.tiles.set(n,s.data&&s.data.byteLength?this.tileDataToMesh(this.precomputeNormalsAndMinMaxZ(s.data,r),e):void 0),this.updateRevision()),i),()=>Promise.resolve(void 0))}async generateTile(e,n,i,o,r,s){const a=[],l=[],c=Ge(n),d=this.tiles.get(c);if(!d)return Promise.resolve({results:a,transferable:l});const u=this.modules.map.state.handyStyleId,{collector:f}=this.modules,h=Nt(n[2]),_=d.bounds;this.tree.insert({key:c,minX:_.min[0],minY:_.min[1],maxX:_.max[0],maxY:_.max[1],cellSize:h/va,...d}),this.updateMinElevation();do xn.generateMeshElevation(f,d.mesh,u,no);while(f.isOverloaded());const p=f.getAccumulatedData();return f.reset(),a.push({regionId:0,metatileHash:-1,styleId:u,collectorOutput:p}),l.push(...p.transferable),Promise.resolve({results:a,transferable:l})}tileDataToMesh(e,n){const[i,o,r,s]=n,a=a5(e.vertices,e.indices);return{data:void 0,mesh:e,minZ:e.minZ,maxZ:e.maxZ,tree:a,bounds:{min:Di(n),max:Di([i+1,o+1,r,s])}}}getAttributes(){return this.attributes}setAttributes(e){this.attributes=e}getId(){return this.id}destroy(){const{imageManager:e}=this.modules;this.tileLoader.destroy(),this.tiles.clear(),this.tree.clear(),this.textureIndices.forEach(n=>e.deleteTexture(n)),this.textureIndices.clear()}getElevation(e){const n=this.getElevationTile(e);if(n)return l5(n,e)}getElevationTile(e){const n=$r(e);return this.tree.search({minX:n[0],minY:n[1],maxX:n[0],maxY:n[1]}).reduce((o,r)=>!o||o.cellSize>r.cellSize?r:o,void 0)}getMinElevation(){return this.minElevation}updateMinElevation(){const e=this.modules.map.state;if(!e.demMode)return;const n=this.modules.camera.position[2],i=fl(e.tilesBounds);if(e.elevation!==void 0){const r=e.elevation*He/n+1,s=Math.max(e.pitch/e.maxPitch*30,4);i3(i,Math.min(r,s))}const o=this.tree.search({minX:i.min[0],minY:i.min[1],maxX:i.max[0],maxY:i.max[1]});e.styleZoom-ag>1?this.minElevation=o.reduce((r,s)=>r===void 0?s.minZ:Math.min(r,s.minZ),void 0):this.minElevation=o.reduce((r,s)=>r===void 0?s.minZ:Math.min(r,s.minZ),void 0)}getRevision(){return this.revision}precomputeNormalsAndMinMaxZ(e,n){var y,b;if(e.byteLength===0)return{vertices:[],indices:[],normals:new Float32Array(0),maxZ:0,minZ:0};const i=new Uint32Array(e.slice(0,4))[0]===777275726,{dataGroups:o,minZ:r,maxZ:s}=i?xL(e):ML(e),{vertices:a,indices:l}=o[0],c=Array(),d=new Map,u=[[],[],[]],f=[],h=[],_=[],p=!this.modules.map.state.useFlatDemIrregularMeshNormals,m=He*Se/n.size;for(let v=0;v<l.length;v+=3){for(let T=0;T<3;T++){const x=l[v+T];u[T][0]=a[x*3],u[T][1]=a[x*3+1],u[T][2]=a[x*3+2]*m}_n(f,ka(f,$t(h,u[1],u[0]),$t(_,u[2],u[0])));for(let T=0;T<3;T++){const x=l[v+T],I=a[x*3],E=a[x*3+1],L=a[x*3+2];if(p){d.has(I)||d.set(I,new Map),d.get(I).has(E)||d.get(I).set(E,new Map);let N=d.get(I).get(E).get(L);N===void 0?(N=[...f],d.get(I).get(E).set(L,N)):jt(N,N,f)}}}if(p){d.forEach(v=>v.forEach(T=>T.forEach(x=>_n(x,x))));for(let v=0;v<a.length/3;v++){const T=(b=(y=d==null?void 0:d.get(a[v*3]))==null?void 0:y.get(a[v*3+1]))==null?void 0:b.get(a[v*3+2]);T?(c.push(T[0]),c.push(T[1]),c.push(T[2])):(console.log("no normal"),c.push(0,0,0))}}return{vertices:a,indices:l,normals:new Float32Array(c),maxZ:s,minZ:r}}updateRevision(){this.revision++}}const Zn=new Float64Array(16);class E_{constructor(e,n,i){this.detailLevel=0,this.mvpMatrix=new Float64Array(16),this.texMatrix=new Float64Array(16),ja(this.mvpMatrix,e),Sn(this.texMatrix,Wu,e),this.detailLevel=i,this.viewport=[[0,0,0,1],[1,0,0,1],[1,1,0,1],[0,1,0,1]],Go(Zn,this.texMatrix),this.viewport.forEach(o=>{ii(o,o,Zn),o[0]-=n[0],o[1]-=n[1],o[2]-=n[2],o[2]>=0&&(o[2]=-1),_n(o,o);const r=-n[2]/o[2];o[0]=n[0]+o[0]*r,o[1]=n[1]+o[1]*r,o[2]=n[2]+o[2]*r})}}class IL{constructor(e){this.destroyed=!1,this.modules=e.modules,this.textures=[]}update(){if(this.destroyed)return;const{center:e,padding:n,rotation:i,size:o,viewport:r,extendedTilesBounds:s,zoom:a,cameraConfig:l,globeMode:c}=this.modules.map.state,d=zr(s[0],s[1]),u=Zu(s[2],d);this.textures=[];const f=Be(45),h=Math.min(this.modules.map.state.pitch,f),_=new dl({pitch:h,center:e,padding:n,rotation:i,size:o,viewport:r,zoom:a,cameraConfig:l,globeMode:c,styleState:{}}),p=Ve(Math.pow(this.modules.map.state.pitch/f,3),0,1),[m,g]=this.modules.camera.position,y=Va([],[m,g,0,1],_.viewProjectionMatrix),b=Math.min(y[1]/y[3]+1,-.5);let v=Math.max(b,-1);if(ro(Zn,[0,-v,0],[1/Yn[0],1/Yn[1],1]),Sn(Zn,Zn,_.viewProjectionMatrix),this.textures.push(new E_(Zn,_.position,0)),Zu(this.textures[0].viewport[2],d)>=u)return!0;if(b<v){const x=Math.max(Math.abs(b-v)/2,1);ro(Zn,[0,2/x+1,0],[1/Yn[0],Yn[1]/x,1]),Sn(Zn,Zn,_.viewProjectionMatrix),this.textures.push(new E_(Zn,_.position,1))}v+=1;const T=Math.pow(o[1]/749,2);[1.4,3.2,12,31].some((x,I)=>{x=(x-1)*p*T+1,ro(Zn,[0,-(v*x+1),0],[1/Yn[0],x/Yn[1],1]),Sn(Zn,Zn,_.viewProjectionMatrix),v+=2/x;const E=this.textures.push(new E_(Zn,_.position,I));if(Zu(this.textures[E-1].viewport[2],d)>=u)return!0})}destroy(){this.textures=[]}}const Oe=(window==null?void 0:window.WebGLRenderingContext)??{},Nb={depthMask:!0,depthTest:!0,depthFunc:Oe.LESS,cullFace:!0,cullFaceMode:Oe.BACK,blend:!1,blendFunc:{sfactor:Oe.ONE,dfactor:Oe.ZERO},blendEquation:Oe.FUNC_ADD,colorMask:[!0,!0,!0,!0],polygonOffsetFill:!1,polygonOffset:{factor:1,units:2}},Tt=t=>Object.assign({},Nb,t),Oi=(t,e,n,i)=>{var s,a,l,c,d,u,f,h,_,p,m,g,y,b,v,T,x,I,E;const o=n.webglState;if(o.state===e&&o.layerState===(i==null?void 0:i.webglState))return;if(t.depthMask(((s=i==null?void 0:i.webglState)==null?void 0:s.depthMask)??e.depthMask),((a=i==null?void 0:i.webglState)==null?void 0:a.depthTest)??e.depthTest?(t.enable(t.DEPTH_TEST),t.depthFunc(((l=i==null?void 0:i.webglState)==null?void 0:l.depthFunc)??e.depthFunc)):t.disable(t.DEPTH_TEST),((c=i==null?void 0:i.webglState)==null?void 0:c.cullFace)??e.cullFace?(t.enable(t.CULL_FACE),t.cullFace(((d=i==null?void 0:i.webglState)==null?void 0:d.cullFaceMode)??e.cullFaceMode)):t.disable(t.CULL_FACE),((u=i==null?void 0:i.webglState)==null?void 0:u.blend)??e.blend){t.enable(t.BLEND),t.blendEquation(((f=i==null?void 0:i.webglState)==null?void 0:f.blendEquation)??e.blendEquation);const L=((h=i==null?void 0:i.webglState)==null?void 0:h.blendFuncSeparate)??e.blendFuncSeparate;L?t.blendFuncSeparate(L.srcRgb,L.dstRgb,L.srcAlpha,L.dstAlpha):t.blendFunc(((p=(_=i==null?void 0:i.webglState)==null?void 0:_.blendFunc)==null?void 0:p.sfactor)??e.blendFunc.sfactor,((g=(m=i==null?void 0:i.webglState)==null?void 0:m.blendFunc)==null?void 0:g.dfactor)??e.blendFunc.dfactor)}else t.disable(t.BLEND);const r=((y=i==null?void 0:i.webglState)==null?void 0:y.colorMask)??e.colorMask;t.colorMask(r[0],r[1],r[2],r[3]),((b=i==null?void 0:i.webglState)==null?void 0:b.polygonOffsetFill)??e.polygonOffsetFill?(t.enable(t.POLYGON_OFFSET_FILL),t.polygonOffset(((T=(v=i==null?void 0:i.webglState)==null?void 0:v.polygonOffset)==null?void 0:T.factor)??e.polygonOffset.factor,((I=(x=i==null?void 0:i.webglState)==null?void 0:x.polygonOffset)==null?void 0:I.units)??e.polygonOffset.units)):t.disable(t.POLYGON_OFFSET_FILL),(E=e.customStateBinder)==null||E.call(e,t),o.state=e,o.layerState=i==null?void 0:i.webglState},Lt=Tt({}),A_=Tt({blend:!0,blendFunc:{sfactor:Oe.ONE,dfactor:Oe.ONE_MINUS_SRC_ALPHA}}),EL=Tt({blend:!0,blendFunc:{sfactor:Oe.ONE,dfactor:Oe.ONE_MINUS_SRC_ALPHA},depthFunc:Oe.GREATER,depthMask:!1,cullFace:!1,polygonOffsetFill:!0,polygonOffset:{factor:1,units:2}}),sa=Tt({depthMask:!1,blend:!0,blendFunc:{sfactor:Oe.ONE,dfactor:Oe.ONE_MINUS_SRC_ALPHA}}),AL=Tt({blend:!0,blendFunc:{sfactor:Oe.ONE,dfactor:Oe.ONE_MINUS_SRC_ALPHA},cullFace:!1}),yn=Tt({depthMask:!1,depthTest:!1,blend:!0,blendFunc:{sfactor:Oe.ONE,dfactor:Oe.ONE_MINUS_SRC_ALPHA}}),CL=Tt({depthMask:!1,depthTest:!1,blend:!0,blendFunc:{sfactor:Oe.SRC_ALPHA,dfactor:Oe.ONE}}),Ub=Tt({depthMask:!1,depthTest:!1,colorMask:[!0,!1,!1,!0]}),PL=Tt({depthMask:!1,depthTest:!1}),lr=Tt({depthMask:!1,depthTest:!1}),oy=Tt({depthMask:!1}),nu=Tt({colorMask:[!1,!1,!1,!1]}),LL=Tt({colorMask:[!1,!1,!1,!1],depthFunc:Oe.ALWAYS}),ry=Tt({blend:!0,blendFunc:{sfactor:Oe.ONE,dfactor:Oe.ONE_MINUS_SRC_ALPHA}}),sy=Tt({depthFunc:Oe.EQUAL,blend:!0,blendFunc:{sfactor:Oe.ONE,dfactor:Oe.ONE_MINUS_SRC_ALPHA}}),C_=Tt({depthMask:!1,depthTest:!1,blend:!0,blendFunc:{sfactor:Oe.ONE,dfactor:Oe.ONE_MINUS_SRC_ALPHA}}),P_=Tt({depthMask:!1,depthTest:!0,depthFunc:Oe.LEQUAL,blend:!0,blendFunc:{sfactor:Oe.ONE,dfactor:Oe.ONE_MINUS_SRC_ALPHA}}),L_=Tt({depthMask:!1,depthTest:!0,depthFunc:Oe.GREATER,blend:!0,blendFunc:{sfactor:Oe.ONE,dfactor:Oe.ONE_MINUS_SRC_ALPHA}}),ay=Tt({polygonOffsetFill:!0,polygonOffset:{factor:1,units:2},blend:!0,blendFunc:{sfactor:Oe.ONE,dfactor:Oe.ONE_MINUS_SRC_ALPHA}}),iu=Tt({cullFaceMode:Oe.BACK}),ou=Tt({cullFace:!1}),FL=Tt({depthMask:!1,depthTest:!1,blend:!0,blendFunc:{sfactor:Oe.ONE,dfactor:Oe.ONE}}),kL=Tt({depthTest:!1,cullFace:!1}),RL=Tt({depthTest:!1,depthMask:!1,blend:!0,blendFuncSeparate:{srcRgb:Oe.SRC_ALPHA,dstRgb:Oe.ONE_MINUS_SRC_ALPHA,srcAlpha:Oe.ONE,dstAlpha:Oe.ONE_MINUS_SRC_ALPHA}}),Gb=Tt({colorMask:[!0,!0,!0,!0],depthMask:!0}),zL=Tt({colorMask:[!0,!0,!0,!0],depthMask:!1});function rg(t){const e=document.createElement("canvas"),n={antialias:!1,stencil:!0,failIfMajorPerformanceCaveat:t};if("WebGLRenderingContext"in window)return e.getContext("webgl",n)||e.getContext("experimental-webgl",n)}function BL(){const t=new Float32Array([-1,-1,1,-1,-1,1]),e=2,n=rg(!1);if(!n)return!1;for(const _ of["OES_element_index_uint","OES_standard_derivatives","OES_vertex_array_object","OES_texture_float","OES_texture_float_linear"])if(!n.getExtension(_))return!1;const i=new qt({size:[e,e]});i.bind(n);const o=new j(new Float32Array([1,0,1,0]),{size:[2,2],format:j.AlphaFormat,type:j.Float,magFilter:j.LinearFilter,minFilter:j.LinearFilter}).prepare(n),r=`attribute vec2 pos;
    void main () {
        gl_Position = vec4(pos, 0, 1);
    }`,s=`precision mediump float;
    uniform sampler2D tex;
    void main () {
        gl_FragColor = vec4(texture2D(tex, vec2(0.4, 0.4)).a, 0, 0, 0);
    }`,a=n.createShader(n.VERTEX_SHADER),l=n.createShader(n.FRAGMENT_SHADER);if(!a||!l||n.isContextLost())return!1;n.shaderSource(a,r),n.compileShader(a),n.shaderSource(l,s),n.compileShader(l);const c=n.createProgram();if(!c)return!1;n.attachShader(c,a),n.attachShader(c,l),n.linkProgram(c),n.useProgram(c);const d=n.createBuffer();if(!d)return!1;n.bindBuffer(n.ARRAY_BUFFER,d),n.bufferData(n.ARRAY_BUFFER,t,n.STATIC_DRAW);const u=n.getAttribLocation(c,"pos");n.vertexAttribPointer(u,2,n.FLOAT,!1,0,0),n.enableVertexAttribArray(u),o.enable(n,0);const f=n.getUniformLocation(c,"tex");n.uniform1i(f,0),n.viewport(0,0,e,e),n.drawArrays(n.TRIANGLES,0,3);const h=new Uint8Array(4);return n.readPixels(0,0,1,1,n.RGBA,n.UNSIGNED_BYTE,h),i.unbind(n),h[0]!==255}function tf(t){return t instanceof WebGLRenderingContext?!!t.getExtension("WEBGL_depth_texture"):!0}let ru=null;const Hb=(()=>{let t=null;return()=>{if(t!==null)return t;if(ru!==null)return ru;const e=rg(!1);if(!e)return ru=!0,ru;const n=`
    attribute vec2 pos;
    varying float v1, v2, v3, v4, v5, v6, v7, v8, v9, v10;
    void main () {
        v1 = pos.x;
        v2 = pos.y;
        v3 = pos.x * 2.0;
        v4 = pos.y * 2.0;
        v5 = pos.x + pos.y;
        v6 = pos.x - pos.y;
        v7 = pos.x * pos.x;
        v8 = pos.y * pos.y;
        v9 = pos.x * pos.y;
        v10 = (pos.x + pos.y) / 2.0;

        gl_Position = vec4(pos, 0, 1);
    }`,i=`
    precision mediump float;
    varying float v1, v2, v3, v4, v5, v6, v7, v8, v9, v10;
    void main () {
        float result = v1 + v2 + v3 + v4 + v5 + v6 + v7 + v8 + v9 + v10;
        gl_FragColor = vec4(result / 10.0, 0, 0, 1); // усредняем результат
    }`,o=e.createShader(e.VERTEX_SHADER),r=e.createShader(e.FRAGMENT_SHADER);if(!o||!r||e.isContextLost())return t=!0,t;e.shaderSource(o,n),e.compileShader(o),e.shaderSource(r,i),e.compileShader(r);const s=e.createProgram();return!s||(e.attachShader(s,o),e.attachShader(s,r),e.linkProgram(s),!s||!e.getProgramParameter(s,e.LINK_STATUS))?(t=!0,t):(t=!1,t)}})(),OL=()=>{const t=rg(!1);if(!t)return!1;if(!QC)return!0;const e=t.getExtension("WEBGL_debug_renderer_info");return e?!(e?t.getParameter(e.UNMASKED_RENDERER_WEBGL):null).toUpperCase().includes("INTEL"):!1},DL=async()=>{if(!navigator)return!1;try{const t=navigator.gpu;if(typeof(t==null?void 0:t.requestAdapter)!="function"||!await t.requestAdapter({powerPreference:"high-performance"})||!document.createElement("canvas").getContext("webgpu",{}))return!1}catch{return!1}return!0},Ip=po(),Ep=po(),Ap=po(),Cp=po(),cr=64,ly=5,sg=12,NL=5,ag=15,UL=18,GL=12,HL=18,Bf=.001,VL=.1,jL=.3,Yn=[1.7,1],lg="relief",$L=300,cy=.001,dy=1,uy=(t,e,n,i,o)=>{const r=Zc(t.tileServer,{subdomain:t.subdomains[Math.abs(e+n)%t.subdomains.length]});return`${t.tileProtocol}://${r}/v2/ald?ts=${o}&x=${e}&y=${n}&z=${i}`},su=Ke(),An=new Float64Array(16);class WL{constructor(e){this.demTextureMatrix=new Float64Array(16),this.demCorrectedFbVpToDemTex=new Float32Array(16),this.demTexToCorrectedTex=new Float32Array(16),this.correctedTexToDemTex=new Float32Array(16),this.isDemCorrectionEnabled=!1,this.demCorrectedScale=1,this.demFbVpMatrix=new Float64Array(16),this.demCorrectedFbVpMatrix=new Float64Array(16),this.demFramebufferId=wn,this.correctedDemFramebufferId=wn,this.flatFramebufferId=wn,this.identifyFlatFramebufferId=wn,this.hillshadeRampTextureId=NaN,this.hillshadeFramebufferId=wn,this.groundFramebufferId=wn,this.isGroundBufferValid=!1,this.lastStyleId=NaN,this.tilesRevision=0,this.tileSet=lg,this.modules=e,this.enabled=!1,this.sources=[],this.sourcesRevision=[],this.tileLayers=[],this.terrainAnimationScaleCoef=cy,this.reliefTileType="raster",this.elevationSourceType="regular",this.groundBuffer=new Float32Array,this.differ=new Kt([])}enable(){if(this.isTerrainSupported===void 0&&(this.isTerrainSupported=BL()),this.enabled||!this.isTerrainSupported)return;this.differ=new Kt([{path:"center",type:"vec2"},{path:"zoom",type:"number"},{path:"size",type:"vec2"},{path:"rotation",type:"number"},{path:"pitch",type:"number"},{path:"demMode",type:"boolean"},{path:"elevation",type:"number"},{path:"minElevation",type:"number"}]),this.demFramebufferId=this.createDemFramebuffer(),this.correctedDemFramebufferId=this.createCorrectedDemFramebuffer(),this.hillshadeFramebufferId=this.createHillshadeFramebuffer(),this.flatFramebufferId=this.createFlatFramebuffer(),this.identifyFlatFramebufferId=this.createFlatIdentifyFramebuffer(),this.groundFramebufferId=this.createGroundFramebuffer(),this.fullscreenBuffer=new F(new Uint16Array([[0,0,0,0],[1,0,1,0],[0,1,0,1],[0,1,0,1],[1,0,1,0],[1,1,1,1]].reduce((n,i)=>{const[o,r,s,a]=i;return n.push(o*vt,r*vt,qn(s),qn(a)),n},[]))),this.hillshadeVao=Mp(this.fullscreenBuffer,this.modules.renderer.getShaderProgram("demHillshade"));const e=this.modules.renderer.getShaderProgram("demElevationCopy");this.copyDemVao=Mp(this.fullscreenBuffer,e),this.addDefaultSources(),this.modules.styleManager.setFramebufferId(this.modules.map.state.handyStyleId,no,{elevation:this.demFramebufferId,hillshade:this.hillshadeFramebufferId,flatBottom:this.correctedDemFramebufferId,ground:this.groundFramebufferId,ground2:this.groundFramebufferId}),this.updateRampTextureId(),this.enabled=!0,this.startAnimationVerticalScale()}setAnimationTerrain(e){this.modules.demManager.disableAnimation=!e}getAnimationTerrainStatus(){return this.modules.demManager.disableAnimation}onTerrainStyleChange(){this.updateRampTextureId()}disable(){var e,n,i,o,r;this.enabled&&((e=this.meshSource)==null||e.destroy(),this.meshSource=void 0,(n=this.flatMapSource)==null||n.destroy(),this.flatMapSource=void 0,this.tileLayers.forEach(s=>{this.modules.tileManager.removeTileLayer(s)}),this.tileLayers=[],this.sources.forEach(s=>{s.destroy()}),this.sources=[],this.sourcesRevision=[],this.hillshadeTile&&(this.modules.tileManager.removeObject(this.hillshadeTile),this.hillshadeTile=void 0),(i=this.hillshadeVao)==null||i.unbind(),(o=this.hillshadeVao)==null||o.remove(),(r=this.fullscreenBuffer)==null||r.remove(),this.modules.styleManager.removeLayer("demo_raster_layer"),this.modules.styleManager.setFramebufferId(this.modules.map.state.handyStyleId,no,{elevation:wn,hillshade:wn,flatBottom:wn,ground:wn,ground2:wn}),this.modules.renderer.removeFramebuffer(this.hillshadeFramebufferId),this.modules.renderer.removeFramebuffer(this.demFramebufferId),this.modules.renderer.removeFramebuffer(this.correctedDemFramebufferId),this.modules.renderer.removeFramebuffer(this.flatFramebufferId),this.modules.renderer.removeFramebuffer(this.groundFramebufferId),this.enabled=!1)}update(){var o,r,s,a;if(!this.enabled)return;const e=this.modules.map.state;this.lastStyleId!==e.handyStyleId&&(this.updateRampTextureId(),(o=this.meshSource)==null||o.updateStyleId(),(r=this.hillshadeTile)==null||r.children.forEach(l=>{l.attributes.styleId=e.handyStyleId}),this.modules.styleManager.setFramebufferId(this.modules.map.state.handyStyleId,no,{elevation:this.demFramebufferId,hillshade:this.hillshadeFramebufferId,flatBottom:this.correctedDemFramebufferId,ground:this.groundFramebufferId,ground2:this.groundFramebufferId}),this.updateClearColor(),this.lastStyleId=e.handyStyleId);const n=this.updateTilesRevision(),i=this.differ.check(this.modules.map.state);(n||i)&&(this.isGroundBufferValid=!1),i&&(this.updateMinElevation(),(s=this.flatMapSource)==null||s.update(),(a=this.meshSource)==null||a.update(),this.updateDemFramebufferMatrix(),this.modules.renderer.addRerenderEvent()),this.disableAnimation||xt("changeScale",{step:(l,c)=>{c===dy&&It("changeScale",e),this.terrainAnimationScaleCoef=c}},e)}isEnabled(){return this.enabled}getDemFramebufferId(){return this.demFramebufferId}getCorrectedDemFramebufferId(){return this.correctedDemFramebufferId}getFlatFramebufferId(){return this.flatFramebufferId}getIdentifyFlatFramebufferId(){return this.identifyFlatFramebufferId}getHillshadeFramebufferId(){return this.hillshadeFramebufferId}getHillshadeRampTextureId(){return this.hillshadeRampTextureId}getElevation(e){if(this.enabled)for(let n=this.sources.length-1;n>=0;n--){const o=this.sources[n].getElevation(e);if(o!==void 0)return o}}getLabelsDemKey(e){if(!this.enabled||e.length===0)return;let n;for(const o of e)if(n=o.labels.find(r=>r.type===Qa.Point),n)break;if(!n)return;lv(su,n.vertices,0,Ct(n.tileCoords));let i;for(let o=this.sources.length-1;o>=0;o--){const s=this.sources[o].getElevationTile(su);if(s!==void 0){i=s;break}}if(i)return i.key}enrichWithElevation(e){if(this.enabled)for(const n of e){let i=null;for(const o of n.labels)o.type===Qa.Point&&(i||(i=Ct(o.tileCoords)),lv(su,o.vertices,0,i),o.demElevation=this.getElevation(su)??NaN)}}getMinElevation(){return this.sources.reduce((e,n)=>{const i=n.getMinElevation();return i===void 0?e:e===void 0?i:Math.min(e,i)},void 0)}updateMinElevation(){this.sources.forEach(e=>e.updateMinElevation())}getMeshTiles(){return this.reliefTileType==="raster"?this.elevationSourceType==="regular"&&this.meshSource?Array.from(this.meshSource.meshTiles.values()):[]:this.tileLayers.reduce((e,n)=>{const i=n.getDisplayedTileObjects();return e.push(...i),e},[])}getGroundTiles(){return this.reliefTileType==="raster"&&this.elevationSourceType==="regular"&&this.meshSource?Array.from(this.meshSource.groundTiles.values()):[]}getReliefTileType(){return this.reliefTileType}getElevationSourceType(){return this.elevationSourceType}setReliefTileType(e){this.reliefTileType!==e&&(this.reliefTileType=e,this.dangerouslyDestroySourcesAndLayers(),this.elevationSourceType==="regular"?this.addRegularElevationSources():this.addIrregularElevationSources(),this.modules.renderer.addRerenderEvent())}setElevationSourceType(e){this.elevationSourceType!==e&&(this.elevationSourceType=e,this.dangerouslyDestroySourcesAndLayers(),this.elevationSourceType==="regular"?this.addRegularElevationSources():this.addIrregularElevationSources(),this.modules.renderer.addRerenderEvent())}getFlatMapTextures(){return this.flatMapSource?this.flatMapSource.textures.slice():[]}clearTextureBindings(){const e=this.modules.renderer.getRenderingContext();e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,null),e.activeTexture(e.TEXTURE0+Ip),e.bindTexture(e.TEXTURE_2D,null),e.activeTexture(e.TEXTURE0+Cp),e.bindTexture(e.TEXTURE_2D,null),e.activeTexture(e.TEXTURE0+Ep),e.bindTexture(e.TEXTURE_2D,null),e.activeTexture(e.TEXTURE0+Ap),e.bindTexture(e.TEXTURE_2D,null)}setMeshMaxZoom(e){var n;this.meshMaxZoom=e,(n=this.meshSource)==null||n.setMaxZoom(e)}getVerticalScale(){const e=this.modules.map.state,n=this.modules.styleManager.getStyle(e.handyStyleId);if(!n)return 0;const i=n.dem.style,o=ht(e.styleZoom,e.styleState,[]);return this.disableAnimation?K(i.verticalScale,o):K(i.verticalScale,o)*this.terrainAnimationScaleCoef}startAnimationVerticalScale(){const e=this.modules.map.state;if(!this.modules.styleManager.getStyle(e.handyStyleId))return 0;At("changeScale",{easing:"linear"},e,cy,dy,$L,1)}getTilesRevision(){return this.tilesRevision}setTileSet(e){this.tileSet=e,this.enabled&&(this.disable(),this.enable())}getGroundPoint(e){if(!this.enabled||(this.updateGround(),!this.isGroundBufferValid))return;const n=this.modules.renderer.getFramebuffer(this.groundFramebufferId);if(!n)return;const i=n.renderTarget.options.size,o=e[0]-this.modules.map.state.viewport.left,r=e[1]-this.modules.map.state.viewport.top;if(o<0||o>i[0]-1||r<0||r>i[1]-1)return;const a=((i[1]-r-1)*i[0]+o)*4;if(this.groundBuffer[a+3]===0)return;const[c,d]=q.toGeo([this.groundBuffer[a],this.groundBuffer[a+1]]);return[c,d,this.groundBuffer[a+2]]}dangerouslyDestroySourcesAndLayers(){this.sources.forEach(e=>e.destroy()),this.sources=[],this.sourcesRevision=[],this.tileLayers.forEach(e=>{this.modules.tileManager.removeTileLayer(e),e.destroy()}),this.tileLayers=[]}updateRampTextureId(){const e=this.modules.styleManager.getStyle(this.modules.map.state.handyStyleId);if(e!=null&&e.dem){const n=Vb(this.modules.map.state,e.dem.style.shadingPalette,256);Number.isNaN(this.hillshadeRampTextureId)?this.hillshadeRampTextureId=this.modules.imageManager.addPreparedTexture(n):this.modules.imageManager.updatePreparedTexture(this.hillshadeRampTextureId,n)}}updateClearColor(){const e=this.modules.styleManager.getStyle(this.modules.map.state.handyStyleId);if(e!=null&&e.dem){const n=this.modules.renderer.getFramebuffer(this.flatFramebufferId);n&&(n.clearColor=Pt(e.background.color))}}updateGround(){if(this.enabled&&!this.isGroundBufferValid){const e=this.modules.renderer.getFramebuffer(this.groundFramebufferId);if(!e)return;const n=this.modules.renderer.getRenderingContext(),i=e.renderTarget.options.size;this.validateGroundBufferSize(i),e.renderTarget.bind(n),n.readPixels(0,0,i[0],i[1],n.RGBA,n.FLOAT,this.groundBuffer),e.renderTarget.unbind(n),this.isGroundBufferValid=!0}}addDefaultSources(){var e;if(!this.enabled){this.elevationSourceType==="irregular"?this.addIrregularElevationSources():this.addRegularElevationSources(),this.flatMapSource=new IL(this.modules.map),this.meshSource=new _L(this.modules.map,{maxZoom:this.meshMaxZoom});const n=this.hillshadeVao,i=(e=this.modules.renderer.symbolSettingsList.dem.hillshade)==null?void 0:e[0];if(n&&i){this.hillshadeTile=new bi("raster",[],this.modules,this.modules.map.state);const o={id:mo(),type:ri.Tile,symbol:"dem",sink:"hillshade",tile:this.hillshadeTile,attributes:{layerId:no,styleId:this.modules.map.state.handyStyleId,tileData:[]},start:0,count:6,attributesHash:"",layerSettings:i,vao:n,canRender:!0,renderingProperties:{}};this.hillshadeTile.children.push(o),this.modules.tileManager.addObject(this.hillshadeTile)}}}addRegularElevationSources(){const e=this.modules.map.state,n=(o,r,s)=>uy(e,o,r,s,this.tileSet),i=this.reliefTileType==="raster";i&&this.addElevationSource({url:n,minZoom:ly,maxZoom:8,attributes:{}}),this.addElevationSource({url:n,minZoom:i?9:ly,maxZoom:sg,attributes:{}})}addIrregularElevationSources(){const e=(n,i,o)=>uy({tileServer:"tileserver.web-staging.2gis.ru",tileProtocol:"https",subdomains:["0","1","2"]},n,i,o,"relief_test");this.addIrregularElevationSource({url:e,minZoom:NL,maxZoom:ag,attributes:{}})}updateTilesRevision(){let e=!1;return this.sources.forEach((n,i)=>{const o=n.getRevision();o!==this.sourcesRevision[i]&&(this.sourcesRevision[i]=o,e=!0)}),e&&this.tilesRevision++,e}addElevationSource(e){const n=new mL(Rs(),this.modules,e);this.sources.push(n),this.sourcesRevision.push(n.getRevision());const{minZoom:i,maxZoom:o}=e,r=new Ro(i,o,i,o,this.modules,this.modules.map.state,n);this.modules.tileManager.addTileLayer(r),this.tileLayers.push(r)}addIrregularElevationSource(e){const n=new TL(Rs(),this.modules,e);this.sources.push(n),this.sourcesRevision.push(n.getRevision());const{minZoom:i,maxZoom:o}=e,r=new Ro(i,o,i,o,this.modules,this.modules.map.state,n);this.modules.tileManager.addTileLayer(r),this.tileLayers.push(r)}getDemTextureSize(){const e=this.modules.map.state.cameraConfig,n=this.modules.map.state.size[1]*e.viewportLimitRatio;return Math.min(Math.ceil(Math.hypot(n,n)/yi),cr)}createGroundFramebuffer(){const e=this.modules.renderer.getRenderingContext(),n=this.modules.map.state.size,i=[0,0,0,0],o=new qt({size:n,magFilter:j.NearestFilter,minFilter:j.NearestFilter,wrapS:j.ClampToEdgeWrapping,wrapT:j.ClampToEdgeWrapping,flipY:!0,type:j.Float});return o.bind(e),this.modules.renderer.clearWithColor(i,!0),o.unbind(e),this.modules.renderer.addFramebuffer({clearColor:i,useDem:!0,clearDepth:!0,onResize:()=>{const r=this.modules.renderer.getRenderingContext(),s=this.modules.map.state.size;o.setSize(s),o.bind(r),this.modules.renderer.clearWithColor(i,!0),o.unbind(r)},renderTarget:o,renderIndex:5,onRenderStart:()=>{this.clearTextureBindings()},onRenderEnd:()=>{}})}createDemFramebuffer(){const e=this.modules.renderer.getRenderingContext();let n=this.getDemTextureSize()*cr;const i=new qt({size:[n,n],magFilter:j.LinearFilter,minFilter:j.LinearFilter,wrapS:j.ClampToEdgeWrapping,wrapT:j.ClampToEdgeWrapping,flipY:!0,type:j.Float,format:Jr.webglVersion===2?j.RedFormat:j.RgbaFormat});return i.bind(e),this.modules.renderer.clearWithColor([0,0,0,1]),i.unbind(e),this.modules.renderer.addFramebuffer({clearColor:[0,0,0,0],onResize:()=>{const o=this.getDemTextureSize()*cr;o!==n&&(n=o,i.setSize([n,n]),i.bind(e),this.modules.renderer.clearWithColor([0,0,0,1]),i.unbind(e))},renderTarget:i,getViewProjectionMatrix:()=>this.demFbVpMatrix,renderIndex:0,onRenderStart:()=>{this.clearTextureBindings()},onRenderEnd:()=>{this.isDemCorrectionEnabled=!1}})}createCorrectedDemFramebuffer(){const e=this.modules.renderer,n=e.getRenderingContext(),i=e.webGlExtensions;let o=this.getDemTextureSize()*cr;const r=new qt({size:[o,o],magFilter:j.LinearFilter,minFilter:j.LinearFilter,wrapS:j.ClampToEdgeWrapping,wrapT:j.ClampToEdgeWrapping,flipY:!0,type:j.Float});r.bind(n),this.modules.renderer.clearWithColor([0,0,0,1]),r.unbind(n);const s=this.modules.renderer.lastAppliedGlState;return this.modules.renderer.addFramebuffer({onResize:()=>{const a=this.getDemTextureSize()*cr;a!==o&&(o=a,r.setSize([o,o]),r.bind(n),this.modules.renderer.clearWithColor([0,0,0,1]),r.unbind(n))},renderTarget:r,getViewProjectionMatrix:()=>this.demCorrectedFbVpMatrix,renderIndex:1,onRenderStart:()=>{var d;const a=(d=this.modules.renderer.getFramebuffer(this.demFramebufferId))==null?void 0:d.renderTarget.getTexture();if(!a||!this.copyDemVao)return;this.clearTextureBindings(),r.bind(n),n.viewport(0,0,r.options.size[0],r.options.size[1]),Oi(n,Ub,s);const l=0;a.enable(n,l);const c=this.modules.renderer.getShaderProgram("demElevationCopy");c.enable(n),c.bind(n,{u_mat4_mvp:xl,u_sr2d_texture:l,u_mat4_dem_corrected:this.correctedTexToDemTex}),this.copyDemVao.bind({gl:n,extensions:i}),n.drawArrays(n.TRIANGLES,0,6),r.unbind(n),this.isDemCorrectionEnabled=!0},useDem:!0})}createHillshadeFramebuffer(){const e=this.modules.renderer.getRenderingContext();let n=this.getDemTextureSize()*cr;const i=new qt({size:[n,n],magFilter:j.LinearFilter,minFilter:j.LinearFilter,wrapS:j.ClampToEdgeWrapping,wrapT:j.ClampToEdgeWrapping,format:j.RgbFormat,flipY:!0});return this.modules.renderer.addFramebuffer({clearColor:[0,0,0,0],onResize:()=>{const o=this.getDemTextureSize()*cr;o!==n&&(n=o,i.setSize([n,n]),i.bind(e),i.unbind(e))},renderTarget:i,getViewProjectionMatrix:()=>this.demFbVpMatrix,renderIndex:2,onRenderStart:()=>{this.clearTextureBindings()},useDem:!0})}createFlatFramebuffer(){const e=this.modules.renderer.getRenderingContext(),n=this.modules.renderer.getPixelRatio(),i=this.modules.map.state.size,o=new qt({size:[Math.trunc(i[0]*Yn[0]*n),Math.trunc(i[1]*Yn[1]*n)],magFilter:j.LinearFilter,minFilter:j.LinearFilter,wrapS:j.ClampToEdgeWrapping,wrapT:j.ClampToEdgeWrapping});return this.modules.renderer.addFramebuffer({clearColor:this.modules.renderer.clearColor,onResize:()=>{const r=this.modules.map.state.size;o.setSize([Math.trunc(r[0]*Yn[0]*n),Math.trunc(r[1]*Yn[1]*n)]),o.bind(e),o.unbind(e)},renderTarget:o,renderIndex:3,onRenderStart:()=>{e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,null)}})}createFlatIdentifyFramebuffer(){const e=this.modules.renderer.getRenderingContext(),n=this.modules.map.state.size,i=new qt({size:[Math.trunc(n[0]*Yn[0]*zi.pixelDensity),Math.trunc(n[1]*Yn[1]*zi.pixelDensity)],magFilter:j.NearestFilter,minFilter:j.NearestFilter,wrapS:j.ClampToEdgeWrapping,wrapT:j.ClampToEdgeWrapping});return this.modules.renderer.addFramebuffer({clearColor:zo,onResize:()=>{const o=this.modules.map.state.size;i.setSize([Math.trunc(o[0]*Yn[0]*zi.pixelDensity),Math.trunc(o[1]*Yn[1]*zi.pixelDensity)]),i.bind(e),i.unbind(e)},renderTarget:i,renderIndex:4,onRenderStart:()=>{e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,null)}})}updateDemFramebufferMatrix(){const e=this.modules.map.state,n=Math.trunc(e.styleZoom),i=Math.min(n,this.getReliefTileType()==="raster"?GL:UL),o=Nt(i),r=o*this.getDemTextureSize(),s=o/cr,a=[Math.trunc(e.center[0]/s)*s+s/2,Math.trunc(e.center[1]/s)*s+s/2],l=[a[0]-r/2,a[1]-r/2,0],c=[];ti(c,this.modules.camera.position,e.center);const d=X4(c);Uo(c,c);const u=(r/2-d-s)*Math.sin(e.pitch/e.maxPitch*(Math.PI/2));u>0&&(Gn(c,c,u),c[0]=Math.trunc(c[0]/s)*s,c[1]=Math.trunc(c[1]/s)*s,ti(l,l,c)),ro(An,l,[r,r,Ha]),Go(this.demTextureMatrix,An),Sn(this.demFbVpMatrix,xl,this.demTextureMatrix);const f=Math.min(n,HL);this.demCorrectedScale=2**(f-i);const _=Nt(f)*this.getDemTextureSize(),p=[a[0]-_/2,a[1]-_/2,0];ro(An,p,[_,_,Ha]),Go(An,An),Sn(this.demCorrectedFbVpMatrix,xl,An),$u(An,[1/this.demCorrectedScale,1/this.demCorrectedScale,1]),Sn(this.demCorrectedFbVpToDemTex,Wu,An),$u(An,[1/this.demCorrectedScale,1/this.demCorrectedScale,1]),Sn(An,An,xl),Sn(this.correctedTexToDemTex,Wu,An),$u(An,[this.demCorrectedScale,this.demCorrectedScale,1]),Sn(An,An,xl),Sn(this.demTexToCorrectedTex,Wu,An)}validateGroundBufferSize(e){const n=e[0]*e[1]*4;this.groundBuffer.length!==n&&(this.groundBuffer=new Float32Array(n))}}function Vb(t,e,n){const i=ht(t.styleZoom,t.styleState,[]),o=[],r=n-1;for(let s=0;s<n;s++){const a=s/r,l=L0(e,a,i)*256;o.push(l)}return new j(new Uint8Array(o),{size:[n,1],format:j.AlphaFormat,magFilter:j.LinearFilter,minFilter:j.LinearFilter,wrapS:j.ClampToEdgeWrapping,wrapT:j.ClampToEdgeWrapping})}const fy=new Float32Array(16),ba=(t,e,n,i)=>{n=ug(n,t,e),n.length>0&&t.metrics.firstcontent===void 0&&(t.metrics.firstcontent=performance.now()-t.metrics.start),Wb(n,i),t.globeMode&&t.globeReady?ZL(t,e,n,i):cg(t,e,n,i)},ZL=(t,e,n,i)=>{const o=[],{environmentManager:r}=e,s=e.styleManager.getStyle(t.handyStyleId);if(!s||!s.environment)return;const l=ht(t.styleZoom,t.styleState,[]),c=Pt(Le(s.background.color,l)),d=e.renderer.getRenderingContext();r.renderStars(d),r.renderGlobeHaloBackground(d),eF(n).forEach(u=>{if(!u.globeTile){Pp(u.children,t).forEach(f=>o.push(f));return}i.useGlobeTile(u.globeTile),e.renderer.clearWithColor(c),u.children.forEach(f=>{if(f.type===ri.Custom||!u.globeTile)return;const h=u.globeTile.coords,_=f.tile.coords,m=2**(_[2]-h[2]),g=(_[0]-h[0]*m)/m,y=(_[1]-h[1]*m)/m,b=1/m,v=1-b-2;ro(fy,[2*g+v,2*y+v,0],[4*b,4*b,1]),f.tile.setMvpMatrix(fy)}),Pp(u.children,t).forEach(f=>nf(t,e,f,i)),i.useCanvas(),nf(t,e,u.globeTile.children,i)}),r.renderGlobeHalo(d),o.forEach(u=>{nf(t,e,u,i)})},cg=(t,e,n,i)=>{Pp(n,t).forEach(o=>nf(t,e,o,i))},nf=(t,e,n,i)=>{oF(e.styleManager,n,t).forEach(o=>{$b(e.styleManager,o[0])?XL(t,e,o,i):jb(t,e,o,i)})},XL=(t,e,n,i)=>{const o=$b(e.styleManager,n[0]);if(!o)return;const r=(s,a)=>{a>=o.orderBy.length?jb(t,e,s,i):sF(o.orderBy[a],s,t).forEach(l=>r(l,a+1))};r(n,0)},jb=(t,e,n,i)=>{n.sort((o,r)=>o.tile.zoomLevel-r.tile.zoomLevel),iF(e.styleManager,n,t).forEach(o=>YL(t,e,o,i))},YL=(t,e,n,i)=>{rF(n,t).forEach(o=>qL(t,e,o,i))},qL=(t,e,n,i)=>{var a;const o=n[0],r=uF(e.styleManager,o);if(!r||((a=r==null?void 0:r.style)==null?void 0:a.visibility)==="hidden")return;const s=r.selectedIdx;s!==void 0&&n.sort((l,c)=>{const d=Number(l.attributes.tileData[s]??0),u=Number(c.attributes.tileData[s]??0);return d-u}),o.type===ri.Custom?(i.useCustomLayerState(r),e.styleManager.callCustomLayerRender(o.attributes.layerId)):aF(n,t).forEach(l=>KL(t,e,l,i,r))},KL=(t,e,n,i,o)=>{i.useProgram(n[0],o),lF(n,t).forEach(r=>{JL(t,e,r,i,o)})},JL=(t,e,n,i,o)=>{i.useState(n[0],o),cF(n,t).forEach(r=>{i.drawSymbol(r,o,t,e)})};function $b(t,e){const n=t.getStyle(e.attributes.styleId);if(!n)return;const i=n.layersById[e.attributes.layerId];if(!i||i.groupId===void 0)return;const o=n.groupsById[i.groupId];if(o&&o.type!=="group"){ct(`Expecting layer with type 'group' but got '${o.type}'`);return}return o}const QL=(t,e)=>Number(t)-Number(e),bl=t=>(e,n)=>{const i={};for(let s=0;s<e.length;s++){const a=e[s],l=t(a,n),c=i[l];c===void 0?i[l]=[a]:c.push(a)}const o=Object.keys(i);o.sort(QL);const r=[];for(let s=0;s<o.length;s++)r.push(i[o[s]]);return r},dg=t=>(e,n)=>{const i=new Map;for(let o=0;o<e.length;o++){const r=e[o],s=t(r,n);i.has(s)?i.get(s).push(r):i.set(s,[r])}return i},eF=t=>{const e=[],n={globeTile:null,children:[]},i=[];for(const o of t)o.type!==ri.Custom&&(o.tile.purpose==="globe"?i.push({globeTile:o.tile,children:[]}):e.push(o));for(const o of e)if(o.layerSettings.is3dMapAware)n.children.push(o);else for(const r of i)r.globeTile&&L6(r.globeTile.coords,o.tile.coords)&&r.children.push(o);return i.push(n),i},Pp=bl(t=>{const{styleId:e}=t.attributes;return e===Kr?1:-e}),tF=(t,e,n)=>{const i=t.getStyle(e);if(!i)return ct(`Cannot get style with id=${e} for renderIndex`),NaN;const o=i.layersById[n];return o?o.renderIndex:NaN},nF=(t,e,n)=>{const i=t.getStyle(e);if(!i)return ct(`Cannot get style with id=${e} for renderIndex`),NaN;const o=i.layersById[n];return o?o.groupIndex||0:NaN},iF=(t,e,n)=>bl(i=>nF(t,i.attributes.styleId,i.attributes.layerId))(e,n),oF=(t,e,n)=>bl(i=>tF(t,i.attributes.styleId,i.attributes.layerId))(e,n),rF=bl(t=>t.type===ri.Custom?0:t.layerSettings.subRenderIndex||0),Wb=(t,e)=>{const n=new Set;t.forEach(i=>{if(i.type===ri.Custom)return;const o=i.layerSettings.programName;n.has(i.layerSettings.programName)||(n.add(o),e.setProgramBinder(i))})},sF=(t,e,n)=>bl((i,o)=>{const r=ht(o.styleZoom,o.styleState,i.attributes.tileData);return K(t,r,0)})(e,n),aF=dg(t=>{var e;return(e=t.shaderDefinitions)!=null&&e.hash?t.layerSettings.programName+"_"+t.shaderDefinitions.hash:t.layerSettings.programName}),lF=dg(t=>t.layerSettings.webglState),cF=dg(t=>t.sink+"_"+t.attributesHash+"_"+t.tile.readiness),dF=bl(t=>t.tile.zoomLevel);function uF(t,e){const n=t.getStyle(e.attributes.styleId);if(n)return n.layersById[e.attributes.layerId]}function ug(t,e,n){for(const i of t)i.type!==ri.Custom&&(i.canRender=fF(i,n,e));return t.filter(i=>i.canRender)}function fF(t,e,n){var o;if(!t.layerSettings.cullMethod)return!0;const i=e.styleManager.getStyleLayerForObject(t);return!(!i||((o=i==null?void 0:i.style)==null?void 0:o.visibility)==="hidden"||!t.layerSettings.cullMethod(t,e,n,i))}const Nr=(t,e,n,i,o,r)=>{const s=e.renderer.getRenderingContext(),a=e.renderer.lastAppliedGlState,l={terrain3d:!!o,noEffects:!!r,drawSymbol:(c,d,u,f)=>{const h=c[0];if(h)if(mF(h)&&(d.type==="overpass"||d.type==="tunnel"||d.type==="gltfModel")&&!h.layerSettings.shadow){let _;d.type==="gltfModel"&&(_=[0,0,0,0]),l.renderTierTexture(h,d,!1,_),l.useProgram(h,d),l.useState(h),F_(c,d,u,f,l),u.hiddenImmersiveRoutesEnabled&&!h.layerSettings.identify&&d.type!=="gltfModel"&&(l.renderTierTexture(h,d,!0),l.useProgram(h,d),Oi(s,EL,a,d),F_(c,d,u,f,l))}else F_(c,d,u,f,l)},useProgram:(c,d)=>{const{layerBinder:u,programName:f,programBinder:h,commonBinder:_}=c.layerSettings,p=e.renderer.getShaderProgram(f,c.shaderDefinitions);p.enable(s),_&&s instanceof WebGLRenderingContext&&_(s,p,t,e),h==null||h(s,p,t,e,o,r),u==null||u(s,p,t,e,d,r)},setProgramBinder:c=>{const d=c.layerSettings.programBinder,u=s instanceof WebGLRenderingContext?c.layerSettings.commonBinder:void 0;if(c.layerSettings.programBinder||u){const f=e.renderer.getShaderProgram(c.layerSettings.programName,c.shaderDefinitions);f.enable(s),u==null||u(s,f,t,e),d==null||d(s,f,t,e,o,r)}},useState:(c,d)=>{Oi(s,c.layerSettings.webglState,a,d)},useCustomLayerState:c=>{Oi(s,kL,a,c)},useGlobeTile:c=>{const d=e.renderer.getGlobeRenderTarget(d3(t.zoom,c));d&&e.renderer.setRenderTarget(d)},useCanvas:()=>{e.renderer.setRenderTarget(i)},renderTierTexture:(c,d,u,f)=>{const{viewport:h,size:_}=t,p=window.devicePixelRatio,m=!!c.layerSettings.identify,g=m?e.renderer.getMapMeshIdFramebufferId():e.renderer.getMapMeshFramebufferId(),y=e.renderer.getFramebuffer(g);if(!y)return;const b=Nr(t,e,void 0,i,!1,!0);if(s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,null),y.renderTarget.bind(s),s.viewport(0,0,y.renderTarget.options.size[0],y.renderTarget.options.size[1]),u)s.clearDepth(-1),m?s.clearColor(zo[0],zo[1],zo[2],zo[3]):s.clearColor(0,0,0,0),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT);else if(m)e.renderer.clearWithColor(zo,!0);else{const x=ht(t.styleZoom,t.styleState,c.attributes.tileData),I=f??Le(d.style.color,x).value;e.renderer.clearWithColor([I[0]/255,I[1]/255,I[2]/255,I[3]/255],!0)}const v=c.attributes.meshTier,T=n==null?void 0:n[v];if(T){T.tileObjects.forEach(E=>{var L;E.updateMvpMatrix(((L=y.getViewProjectionMatrix)==null?void 0:L.call(y))??e.camera.viewProjectionMatrix,void 0)});const x=u?T.objects.filter(E=>{var L;if(E.type!==ri.Custom){if(E.layerSettings.webglState.depthTest&&!E.layerSettings.isOverlappedObject)return!0;const N=e.styleManager.getStyleLayer(E.attributes.styleId,E.attributes.layerId);if(N)return((L=N.webglState)==null?void 0:L.depthTest)===!0}return!1}):T.objects,I=ug(x,t,e);cg(t,e,I,b),T.tileObjects.forEach(E=>E.updateMvpMatrix(e.camera.viewProjectionMatrix)),Wb(T.objects,l)}i?(i.bind(s),s.viewport(0,0,i.options.size[0],i.options.size[1])):(y.renderTarget.unbind(s),s.viewport(h.left*p,h.bottom*p,_[0]*p,_[1]*p))},copy:(c,d,u)=>Nr(t,e,n,c,d,u)};return l},F_=(t,e,n,i,o)=>{const r=i.renderer.getRenderingContext(),s=t[0],a=s.layerSettings,l=i.renderer.getShaderProgram(a.programName,s.shaderDefinitions);a.objectBinder(r,l,n,i,s,e,o.terrain3d),s.layerSettings.zoomBinder?dF(t,n).forEach(c=>{var d,u;l&&((u=(d=s.layerSettings).zoomBinder)==null||u.call(d,r,l,n,i,c[0],e,o.terrain3d)),c.forEach(f=>hy(f,i,l,n,o,r,e))}):t.forEach(c=>hy(c,i,l,n,o,r,e))},hy=(t,e,n,i,o,r,s)=>{const a=e.renderer.webGlExtensions,l=a.ANGLE_instanced_arrays,c=t.tile;for(const d of c.modelMatrices.keys()){if(c.renderModelMatrix=c.modelMatrices.get(d),c.renderMvpMatrix=c.mvpMatrices.get(d),c.renderDemMatrix=c.demMatrices.get(d),c.renderFlatMapTexMatrix=c.flatMapTexMatrices.get(d),!t.layerSettings.tileBinder(r,n,i,e,t,s,o))continue;t.vao.bind({gl:r,extensions:a});const{start:f,count:h,instanceCount:_}=t,p=t.drawMode??Vc,m=t.vao.getElementsGLType(r);if(m!==null?_?hF(r,p,h,m,f,_,l):r.drawElements(p,h,m,f):_?_F(r,p,f,h,_,l):r.drawArrays(p,f,h),i.collectStats){i.stats.drawCount++,i.stats.vertexCount+=(_??1)*h,i.stats.drawCountBySymbol[t.symbol]?i.stats.drawCountBySymbol[t.symbol]++:i.stats.drawCountBySymbol[t.symbol]=1;let g=0;switch(p){case r.TRIANGLES:g=h/3;break;case r.TRIANGLE_FAN:case r.TRIANGLE_STRIP:g=h-2;break}i.stats.triangleCount+=(_??1)*g}}};function hF(t,e,n,i,o,r,s){if(t instanceof WebGLRenderingContext){if(!s)return;s.drawElementsInstancedANGLE(e,n,i,o,r)}else t.drawElementsInstanced(e,n,i,o,r)}function _F(t,e,n,i,o,r){if(t instanceof WebGLRenderingContext){if(!r)return;r.drawArraysInstancedANGLE(e,n,i,o)}else t.drawArraysInstanced(e,n,i,o)}function mF(t){return t.symbol==="mapMesh"||t.symbol==="gltfModel"&&t.attributes.meshTier!==void 0}const _y=Ke(),pF=Ke(),my=Ui(),k_=Ke(),gF=yt(0,0,1),vF=Ke(),yF=.3,bF=1/2e7,wF=.01,py=po();class xF{constructor(e,n){this.clipToShadowMatrix=new Float32Array(16),this.baseBias=od.bias,this.bias=0,this.shadowMapParams=new Float32Array([od.textureSize[0],od.textureSize[1],od.shadowRadius,1]),this.volumeMultiplier=2.5,this.volumeMinSize=25e3,this.discreteVolume=!1,this.volumeSizeStep=2**15,this.adaptiveVerticalSize=!0,this.debugDraw=!1,this.shadowMatrix=new Float64Array(16),this.orthoMath=new Float64Array(16),this.renderTarget=null,this.debugSize=400,this.shadowLightDir=null,this.modules=n,this.mapState=e;const i=new F(new Uint8Array([-1,-1,1,-1,1,1,-1,1]));this.copyProgram=this.createDebugProgram(),this.debugVao=Db(i,this.copyProgram)}get texture(){if(!this.renderTarget)return null;const e=this.renderTarget.getDepthAttachment();return e instanceof j?e:this.renderTarget.getTexture()}setShadowResolution(e,n){this.shadowMapParams[0]=e,this.shadowMapParams[1]=n,this.renderTarget&&this.renderTarget.setSize([e,n])}update(){this.shadowLightDir=null;const{handyStyleId:e}=this.mapState,n=this.modules.styleManager.getStyle(e),i=this.modules.map.state.demMode;if(!n||!n.light.lightingModesResolved||i){this.renderTarget&&this.renderTarget.remove();return}const o=n.light.lightingModesResolved;for(const L in o){const N=o[L];if(N.shadowLightIndex===0){this.shadowLightDir=N.dir1Direction,this.shadowMapParams[2]=N.shadowRadius;break}else if(N.shadowLightIndex===1){this.shadowLightDir=N.dir2Direction,this.shadowMapParams[2]=N.shadowRadius;break}}const r=this.shadowLightDir&&!this.modules.map.getFeatureFlag("shadowsOff");if(r?this.renderTarget||(this.renderTarget=this.createRenderTarget()):this.renderTarget&&this.renderTarget.remove(),!r||!this.shadowLightDir||!this.renderTarget||this.modules.renderCacheManager.hasReadyCache())return;const s=this.modules.map.state.center,a=this.modules.camera.position[2];let l=Math.max(this.volumeMultiplier*a);this.discreteVolume&&(l=l-l%this.volumeSizeStep),l=Math.max(l,this.volumeMinSize);const c=this.modules.renderer.getRenderingContext();let d=this.baseBias;!(c instanceof WebGLRenderingContext)&&tf(c)&&(d*=.5),this.shadowMapParams[3]=d/l,this.bias=d*bF*Math.sqrt(l),this.bias=Math.min(this.bias,wF);let u=1;if(this.adaptiveVerticalSize){const L=Math.abs(Fs(this.shadowLightDir,gF));u=Math.max(L,yF)}const f=l,h=u*l,_=3*l;n3(this.orthoMath,-f,f,-h,h,-_,_);const p=yt(this.shadowLightDir[1],-this.shadowLightDir[0],0);_n(p,p),ka(k_,p,this.shadowLightDir);const m=my;Tc(m,vF,this.shadowLightDir,k_);const g=ii(_y,s,m),y=2*f/this.shadowMapParams[0],b=2*h/this.shadowMapParams[1],v=yt(g[0]-g[0]%y,g[1]-g[1]%b,g[2]),T=Go(m,m),x=ii(pF,v,T??p0(my)),I=jt(_y,x,this.shadowLightDir);Tc(this.shadowMatrix,x,I,k_),Sn(this.shadowMatrix,this.orthoMath,this.shadowMatrix);const E=this.modules.camera.viewProjectionMatrixInverse;Sn(this.clipToShadowMatrix,this.shadowMatrix,E)}drawShadowMap(e){if(!this.shadowLightDir||!this.renderTarget||this.modules.renderCacheManager.hasReadyCache())return;const n=this.modules.map.state.demMode,i=Nr(this.mapState,this.modules,void 0,this.renderTarget,n),o=new Set,r=[];for(const l of e)for(const c of l.shadowChildren){const d=this.modules.styleManager.getStyleLayerForObject(c);if(!d||d.castShadows===!1)continue;const u=Ob(d,this.modules,this.mapState);!u||u.lightConfig.shadowLightIndex===-1||(r.push(c),o.add(l))}const s=this.modules.renderer.getRenderingContext(),a=n?this.modules.demManager.demTextureMatrix:void 0;o.forEach(l=>{l.updateMvpMatrix(this.shadowMatrix,a)}),this.renderTarget.bind(s),Oi(s,Gb,this.modules.renderer.lastAppliedGlState),s.clearColor(1,1,1,1),s.clearDepth(1),s.clear(s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT),s.viewport(0,0,this.renderTarget.options.size[0],this.renderTarget.options.size[1]),ba(this.mapState,this.modules,r,i),this.renderTarget.unbind(s)}drawDebugFbIfNeeded(){if(!this.debugDraw)return;const e=this.texture;if(!e)return;const n=this.mapState.viewport,i=this.modules.renderer.getViewportSize(),o=this.debugSize,r=this.modules.renderer.getRenderingContext();r.bindFramebuffer(r.FRAMEBUFFER,null),r.viewport(i[0]+n.left-o,n.bottom,o,o);const s=this.modules.renderer.webGlExtensions;Oi(r,lr,this.modules.renderer.lastAppliedGlState),this.copyProgram.enable(r),this.copyProgram.bind(r,{u_texture:1}),e.enable(r,1),this.debugVao.bind({gl:r,extensions:s}),r.drawArrays(r.TRIANGLE_FAN,0,4)}getMemoryFootprint(){var n;const e={renderTarget:((n=this.renderTarget)==null?void 0:n.memSizeGPU())??0};return{gpu:{...e,"--sum":Mn(e)}}}createRenderTarget(){const e=[this.shadowMapParams[0],this.shadowMapParams[1]],n=this.modules.renderer.getRenderingContext();return tf(n)?new qt({size:e,magFilter:j.LinearFilter,minFilter:j.LinearFilter,depthTexture:!0,hasColorOutput:!1,compareFunc:j.CompareRefToTexture}):new qt({size:e,magFilter:j.NearestFilter,minFilter:j.NearestFilter,wrapS:j.ClampToEdgeWrapping,wrapT:j.ClampToEdgeWrapping,flipY:!1,type:j.UnsignedByte,useHighDepthPrecision:!0})}createDebugProgram(){const e=this.modules.renderer.getRenderingContext(),n=[];tf(e)&&n.push({type:"IS_DEPTH_TEXTURE"});const i=Xo.createShaderDefinitions(n);return this.modules.renderer.getShaderProgram("copy",i)}}class SF{constructor(e,n,i){this.output=e,this.input=n,this.modules=i,this.enabled=!0}}var Zb=(t=>(t.TAA="TAA",t.NO_AA="NO_AA",t))(Zb||{});class MF extends SF{constructor(e,n,i,o){super(e,n,i),this.name=fg.TAA,this.jitter=[0,0],this.numMixedFrames=0,this.samples=16;const r=i.renderer.getShaderProgram("antialias");this.jitterSequence=this.generateJitterSequence(this.samples),this.vao=Db(o,r)}onBeforeRender(e){if(this.jitter[0]=0,this.jitter[1]=0,e.disableAntiAliasing||e.globeMode||!this.canRender()){this.enabled=!1,this.numMixedFrames=0;return}if(this.numMixedFrames>=this.samples)return;this.modules.renderer.addRerenderEvent(),this.enabled=!0;const n=window.devicePixelRatio,i=e.size,o=this.jitterSequence[this.numMixedFrames];this.jitter[0]=o[0]/Math.ceil(i[0]*n),this.jitter[1]=o[1]/Math.ceil(i[1]*n)}render(e){var s;this.output.bind(e);const n=this.modules.renderer.webGlExtensions,i=1/(this.numMixedFrames+1);this.vao.bind({gl:e,extensions:n});const o=(s=this.input)==null?void 0:s.getTexture();o==null||o.enable(e,0);const r=this.modules.renderer.getShaderProgram("antialias");r.enable(e),r.bind(e,{u_texture:0,u_float_mix_coef:i}),e.drawArrays(e.TRIANGLE_FAN,0,4),this.numMixedFrames++}onAfterRender(){}resize(e){this.output.setSize(e),this.numMixedFrames=0}isReady(){return this.numMixedFrames>=this.samples}canRender(){return!this.modules.renderer.isNeedRerender()}generateJitterSequence(e){const n=[],i=cM(e),o=i.base2,r=i.base3;n.push([0,0]);for(let s=0;s<o.length;++s)n.push([2*o[s]-1,2*r[s]-1]);return n}}var fg=(t=>(t[t.TAA=0]="TAA",t))(fg||{});class TF{constructor(e,n){this.renderGraph=[],this.effectsByType={},this.state=e,this.modules=n,this.renderTargetSize=this.modules.renderer.getViewportSize();const i=n.renderer.webglContextState.MAX_TEXTURE_SIZE;if(Math.max(...this.renderTargetSize)>i){ct(`Disabling post-effects as viewport size ${this.renderTargetSize[0]}x${this.renderTargetSize[1]} exceeds hardware limits of ${i}x${i}`);return}const r=new F(new Uint8Array([-1,-1,1,-1,1,1,-1,1])),s=this.createRenderTarget(this.renderTargetSize,{useHighDepthPrecision:!0});if(this.mainFrameBufferWrapper={renderTarget:s,onResize:()=>{},clearColor:Pt(e.defaultBackgroundColor),clearDepth:!0},!e.disableAntiAliasing){const a=new MF(this.createRenderTarget(this.renderTargetSize),s,n,r);this.effectsByType[0]=a,this.renderGraph.push(a)}}update(){this.renderGraph.forEach(e=>e.onBeforeRender(this.state))}render(e){const n=this.modules.renderer.lastAppliedGlState;Oi(e,RL,n),this.renderGraph.forEach(o=>o.render(e));const i=this.renderGraph[this.renderGraph.length-1].output;this.copyRenderTargetToCanvas(e,i),this.renderGraph.forEach(o=>o.onAfterRender(this.state))}invalidateSize(){this.mainFrameBufferWrapper&&(this.renderTargetSize=this.modules.renderer.getViewportSize(),this.mainFrameBufferWrapper.renderTarget.setSize(this.renderTargetSize),this.renderGraph.forEach(e=>e.resize(this.renderTargetSize)))}getEffectByName(e){return this.effectsByType[e]}setClearColor(e){this.mainFrameBufferWrapper&&(this.mainFrameBufferWrapper.clearColor=Pt(e))}hasActiveEffects(){if(!this.modules.postEffectsManager.mainFrameBufferWrapper)return!1;for(const e of this.renderGraph)if(e.enabled)return!0;return!1}isReady(){for(const e of this.renderGraph)if(!e.isReady())return!1;return!0}getMemoryFootprint(){var n;const e={mainFrameBufferWrapper:{renderTarget:((n=this.mainFrameBufferWrapper)==null?void 0:n.renderTarget.memSizeGPU())??0}};return{gpu:{...e,"--sum":Mn(e)}}}copyRenderTargetToCanvas(e,n){const{viewport:i}=this.state,o=window.devicePixelRatio,r=this.modules.renderer.clearColor;e.bindFramebuffer(e.FRAMEBUFFER,null),e.viewport(i.left*o,i.bottom*o,this.renderTargetSize[0],this.renderTargetSize[1]),e.clearColor(r[0],r[1],r[2],r[3]),e.clear(e.COLOR_BUFFER_BIT);const s=n.getTexture();s==null||s.enable(e,0);const a=this.modules.renderer.getShaderProgram("copy");a.enable(e),a.bind(e,{u_texture:0}),e.drawArrays(e.TRIANGLE_FAN,0,4)}createRenderTarget(e,n){return new qt(Object.assign({minFilter:j.NearestFilter,magFilter:j.NearestFilter,size:e},n))}}const IF=[0,0];function ft(...t){return(e,n,i,o,r,s)=>{t.forEach(a=>a(e,n,i,o,r,s))}}const Qe=(t,e,n,i,o)=>{var p,m;if(!o){vy(t,e);return}const r=(p=i.renderer.getFramebuffer(i.demManager.getDemFramebufferId()))==null?void 0:p.renderTarget.getTexture(),s=(m=i.renderer.getFramebuffer(i.demManager.getCorrectedDemFramebufferId()))==null?void 0:m.renderTarget.getTexture(),a=i.imageManager.getTexture(i.demManager.getHillshadeRampTextureId()),l=r==null?void 0:r.options.size,c=i.styleManager.getStyle(n.handyStyleId);if(!r||!s||!a||!c||!l){vy(t,e);return}const d=ht(n.styleZoom,n.styleState,[],!1),u=K(c.dem.style.shadingIntensity,d),f=i.demManager.getElevationSourceType(),h=y0/(Math.pow(2,Math.min(Math.trunc(n.styleZoom),f==="regular"?sg:ag))*cr);r.enable(t,Ip),a.enable(t,Ap),s.enable(t,Cp);const _=i.demManager.demCorrectedScale;e.bind(t,{u_float_dem_resolution:l[0],u_float_dem_cell_size:h,u_float_dem_shading_intensity:u,u_tex_dem:Ip,u_tex_corrected_dem:Cp,u_tex_hillshade_ramp:Ap,u_float_corrected_interval:i.demManager.isDemCorrectionEnabled&&_!==1?.5/_:0,u_mat4_dem_corrected:i.demManager.demTexToCorrectedTex,u_float_map_center_elevation:n.elevation??0})},gy=(t,e)=>{e.bind(t,{u_float_dem_shading_intensity:0})},vy=(t,e)=>{e.bind(t,{u_float_dem_scale:0})},au=ft(Xt,Qe),lu=ft(Lo,gh),yy=ft(Xt,ed),EF=ft(Xt,Fb,gh,Lo,zb,Qe),by=ft(Xt,Fb,gh,Qe),wy=ft(Lo,gh,Xt,zb,Qe),AF=Xt,CF=ft(Xt,ed),ho=(t,e,n,i,o,r)=>{const s=i.postEffectsManager.getEffectByName(fg.TAA),a=!r&&(s!=null&&s.jitter)?s.jitter:IF;e.bind(t,{u_vec2_camera_jitter:a})},oi=(t,e,n,i)=>{const o=i.shadowManager.texture;o&&(o.enable(t,py),e.bind(t,{u_texture_shadow:py}))},PF=ft(Qe,ho,oi),Vl=ft(Qe,ho,oi),LF=ft(Xt,ed),FF=ft(Qe,ho,oi),kF=ft(ho,oi),ji=ft(Qe,ho,oi),xy=ft(Xt,Qe,oi),jl=ft(Qe,ho,oi),Xb=ft(Xt,ed,kb,Rb),Yb=ft(Xt,ed,kb,Rb,oi),RF=ft(Qe,Yb),zF=ft(Qe,Xb),R_=ft(Xt,oi),BF=ft(Qe,ho,oi),OF=ft(ho,oi),qb=ft(ho,oi),DF=ft(Qe,qb),$l=new Float32Array(2),Wl=new Float32Array(2),NF=[0,0],UF=[0,0,0,0],cn=(t,e)=>{e.bind(t,{u_float_opacity:1})},Sy=(t,e,n,i,o,r)=>{const s=Tn(n,o),a=K(r.style.textureOpacity,s);e.bind(t,{u_float_texture_opacity:o.tile.readiness*a})},pt=(t,e,n,i,o)=>{if(!o.renderingProperties.color)return;const r=Pt(o.renderingProperties.color);jr(r,r,o.tile.readiness),e.bind(t,{u_vec4_color:r})},Zl=(t,e,n,i,o)=>{e.bind(t,{u_mat4_gradient:o.renderingProperties.mat4_gradient})},GF=(t,e,n,i,o,r)=>{const s=Pt(Le(r.style.strokeColor,Tn(n,o)));jr(s,s,o.tile.readiness),e.bind(t,{u_vec4_border_color:s})},Cn=(t,e,n,i,o)=>{const r=o.renderingProperties.widthResolved||0;e.bind(t,{u_float_width:r*window.devicePixelRatio})},My=(t,e,n,i,o,r)=>{e.bind(t,{u_float_shift:K(r.style.shift,Tn(n,o))*window.devicePixelRatio})},HF=(t,e,n,i,o,r)=>{const s=o.renderingProperties.opacityResolved||0,a=ht(n.styleZoom,n.styleState,o.attributes.tileData,!1),l=r.style.iconOpacity,c=K(l,a);a.isBehind=!0;const d=n.styleState.graphicsPreset==="light"?1:K(l,a);e.bind(t,{u_vec2_opacity:[s*c,s*d]})},Ar=(t,e,n,i,o)=>{const r=o.renderingProperties.opacityResolved||0;e.bind(t,{u_float_opacity:r})},z_=(t,e,n,i,o,r)=>{const s=K(r.style.iconRotation,Tn(n,o));e.bind(t,{u_vec2_rotation:[Math.cos(s),Math.sin(s)]})},VF=(t,e,n,i,o,r)=>{const s=K(r.style.opacity,Tn(n,o));e.bind(t,{u_float_opacity:o.tile.readiness*s})},jF=(t,e,n,i,o,r)=>{const s=K(r.style.opacity,Tn(n,o));e.bind(t,{u_float_opacity:s})},B_=(t,e,n,i,o)=>{i.assetManager.textures[o.attributes.atlasIndex].enable(t,0)},aa=(t,e,n,i,o)=>{const r=o.renderingProperties.fontTexture;r&&r.enable(t,0)},Ty=(t,e,n,i,o)=>{const r=o.renderingProperties.texture;r&&r.enable(t,0)},$F=(t,e,n,i,o)=>{const r=o.renderingProperties.rampTexture;r&&(r.enable(t,1),e.bind(t,{u_sr2d_ramp_texture:1}))},cu=(t,e,n,i,o,r)=>{const{tile:s}=o,a=Le(r.style.gapColor,Tn(n,o));if(!a)return;const l=Pt(Le(a,Tn(n,o)));jr(l,l,s.readiness),e.bind(t,{u_vec4_space_color:l})},du=(t,e,n,i,o,r)=>{const{styleZoom:s}=n,a=Tn(n,o),{tile:l}=o,c=Pt(Le(r.style.color,a));jr(c,c,l.readiness),a.styleZoom=Math.floor(s);const d=Math.pow(2,yS(s)),u=K(r.style.dashLength,a)*d,f=K(r.style.gapLength,a)*d;e.bind(t,{u_vec4_dash_color:c,u_vec2_scaler_params:[0,d0],u_float_dash_length:Ms(u,l.size),u_float_dash2_length:Ms(u,l.size),u_float_space_length:Ms(f,l.size)})},st=jc(),Iy=(t,e,n,i,o,r)=>{const s=Tn(n,o),{tile:a}=o,{pattern:l,width:c}=o.renderingProperties;if(!l||!c)return;const d=Pt(Le(r.style.color,s));switch(jr(d,d,a.readiness),l[0]){case ur.Chess:{const u=l[1];st[0]=u,st[1]=.5,st[2]=.25,st[3]=-.25;break}case ur.DoubleDash:{const u=l[1];st[0]=u,st[1]=l[2]/c,st[2]=.5*l[3]/u,st[3]=.5*l[4]/u,st[2]>=.5-Number.EPSILON&&(st[2]=.6),st[3]>=.5-Number.EPSILON&&(st[3]=.6);break}case ur.Stripe:{const u=l[1]+l[2];st[0]=u,st[1]=.55,st[2]=.5*l[1]/u,st[3]=.5*l[1]/u,st[2]>=.5-Number.EPSILON&&(st[2]=.6),st[3]>=.5-Number.EPSILON&&(st[3]=.6);break}case ur.Circle:{const u=l[1]+l[2];st[0]=u,st[1]=.5*l[1]/u;break}case ur.Triangles:{const u=l[1]+l[2];st[0]=u,st[1]=l[1]/u,st[2]=String(l[3])==="right"?-1:1;break}case ur.Chevron:{const u=l[1]+l[2];st[0]=u,st[1]=l[1]/u,st[2]=l[3]/u,st[3]=l[4]/c;break}}e.bind(t,{u_vec4_color:d,u_int_pattern_type:l[0],u_vec4_pattern_params:st})},uu=(t,e,n,i,o,r)=>{const s=Tn(n,o),a=K(r.style.tipWidth,s),l=K(r.style.tipHeight,s),c=a,d=0;$l[0]=-c,$l[1]=-0,Uo($l,$l),Wl[0]=a,Wl[1]=l,Uo(Wl,Wl);const u=K(r.style.roundingRadius,s);e.bind(t,{u_vec2_wing_normal:$l,u_vec2_tip_normal:Wl,u_float_tip_height_multiplier:l,u_float_wing_height_multiplier:d,u_float_wing_width_multiplier:c,u_float_size_factor:Ms(oo,o.tile.size)/2,u_float_tip_radius_zpt:u,u_float_wing_radius_zpt:u,u_float_tail_radius_zpt:u})},Ey=(t,e,n,i,o,r)=>{const s=Tn(n,o),a=K(r.style.lineLength,s),l=K(r.style.lineWidth,s);e.bind(t,{u_float_length:a,u_float_width:l,u_float_border_width:0})},Ay=(t,e,n,i,o,r)=>{const s=Tn(n,o),{tile:a,attributes:l}=o,c=l.isLongArrow,d=o.tile.dynamicObject;let u=0,f=1;d&&(c?f=d.growPosition:u=d.bouncePosition);let h=0;const _=r.style.animation.type;(_==="appearance"||_==="repeat")&&(h=K(r.style.animation.tipMovementAmplitude,s));const p=K(r.style.roundingRadius,s);e.bind(t,{u_float_width_zpt:K(r.style.lineWidth,s),u_float_border_width_zpt:K(r.style.strokeWidth,s),u_float_tip_movement_amplitude:Ms(h,a.size),u_float_vertex_shift:u,u_float_relative_end_position:f,u_float_tip_radius_zpt:p,u_float_wing_radius_zpt:p,u_float_tail_radius_zpt:p})},WF=(t,e,n,i,o)=>{const r=o.renderingProperties.modelTexture;r&&r.enable(t,0)},ZF=(t,e,n,i,o)=>(e.bind(t,{u_int_gltf_dem_pos:o.attributes.demPosition,u_vec2_anchor:o.attributes.centroid??NF,u_vec4_axis:o.attributes.axis??UF}),!0),XF=(t,e,n,i,o)=>{const{styleId:r}=o.attributes,{renderingProperties:s}=o,{resolvedColorTexture:a,resolvedAoTexture:l,resolvedPbrTexture:c,resolvedMetallic:d,resolvedRoughness:u}=s,{modelId:f}=s,h=i.assetManager.getModel(f??NaN,r);if(!h)return;const _={},p=a!==void 0&&h.textures[a];p&&(p.enable(t,0),_.u_sr2d_texture_0=0);const m=l!==void 0&&h.textures[l];m&&(m.enable(t,1),_.u_ao_texture=1);const g=c!==void 0&&h.textures[c];g?(g.enable(t,i1),_.u_pbr_texture=i1):(_.u_float_metallic=d,_.u_float_roughness=u),e.bind(t,_)},Cy=(t,e,n,i,o,r)=>{const{renderer:s}=i,l=s.getGlobeRenderTarget(d3(n.zoom,o.tile)).getTexture();return l?(l.enable(t,Rp),e.bind(t,{u_sr2d_flatmap_texture:Rp}),!0):!1},fu=(t,e,n,i,o,r)=>{e.bind(t,{u_float_height_factor:o.renderingProperties.resolvedHeightFactor})},O_=(t,e,n,i,o,r)=>{if(o.attributes.id===void 0)return;const s=i.modelLayer.getOpacity(o.attributes.id,r.minzoom),l=i.modelLayer.getBuildingHeight(o.attributes.id)===1?1:s;e.bind(t,{u_float_height_factor:l})},hu=(t,e,n,i,o,r)=>{const s=Tn(n,o),a=K(r.style.height,s);e.bind(t,{u_float_height_factor:$n(a)})},Ei=(t,e,n,i,o,r)=>{if(o.symbol==="polygonExtrusion"&&o.attributes.floorId&&o.attributes.isFloorStack){e.bind(t,{u_float_height_factor:i.floorManager.getFloorStackObjectHeight(o.attributes.floorId)});return}let s=i.buildingHeightAnimator.getBuildingHeight(r.minzoom);i.map.state.demMode&&(s=Bf+(1-Bf)*s);const a=i.modelsScene.objectIdToKey(o.id);a&&i.modelLayer.setBuildingHeight(a,s),e.bind(t,{u_float_height_factor:s})};function Tn(t,e){return ht(t.styleZoom,t.styleState,e.attributes.tileData,!1,e.tile.dynamicObject)}const _u=(t,e,n,i,o)=>{const{tile:r}=o,s=o.renderingProperties.widthResolved||0;e.bind(t,{u_float_width:Ms(s,r.size)/2*oo,u_float_width_offset:Ms(oo/window.devicePixelRatio,r.size)/2})},YF=(t,e,n,i,o)=>{const r=o.renderingProperties.resolvedRadius;e.bind(t,{u_float_radius:r*window.devicePixelRatio})},qF=(t,e,n,i,o,r)=>{const s=K(r.style.intensity,Tn(n,o));e.bind(t,{u_float_intensity:s})},ds=(t,e,n,i,o,r)=>{const s=Tn(n,o);let a=K(r.style.textFontSize,s);if(o.symbol==="point"){const l=o.attributes.labelIndex;l===lo.Second&&r.style.textFontSize2?a=K(r.style.textFontSize2,s):l===lo.Icon&&r.style.iconTextFontSize&&(a=K(r.style.iconTextFontSize,s))}e.bind(t,{u_float_scale:a*window.devicePixelRatio/Gi.baseSize})},mu=(t,e,n,i,o,r)=>{const s=ht(n.styleZoom,n.styleState,o.attributes.tileData,!!o.layerSettings.isOverlappedObject),{textFontSize:a,textColor:l,textHaloWidth:c,textHaloColor:d}=r.style,u=K(a,s)/Gi.baseSize,f=u*window.devicePixelRatio,h=Gi.gamma/f,_=o.layerSettings.uniformSet,p=_==="fontHalo"?(6-K(c,s)/u)/8:.75;let m;_==="fontHalo"?m=Pt(Le(d,s)):m=Pt(Le(l,s)),e.bind(t,{u_float_buffer:p,u_float_gamma:h,u_vec4_color:m})},Py=(t,e,n,i,o,r)=>{const{layerSettings:s}=o,{uniformSet:a}=s,l=o.attributes.labelIndex,c=r.style;let{textFontSize:d,textHaloWidth:u,textColor:f,textHaloColor:h}=c;switch(l){case lo.Icon:d=c.iconTextFontSize,u=c.iconTextHaloWidth,f=c.iconTextColor,h=c.iconTextHaloColor;break;case lo.Second:d=c.textFontSize2,u=c.textHaloWidth2,f=c.textColor2,h=c.textHaloColor2;break}KF(t,e,n,o,d,f,u,h,l,a)},KF=(t,e,n,i,o,r,s,a,l,c)=>{const d=ht(n.styleZoom,n.styleState,i.attributes.tileData,!1,i.tile.dynamicObject),u=K(o,d)/Gi.baseSize,f=u*window.devicePixelRatio,h=Gi.gamma/f,_=c==="fontHalo"?(6-K(s,d)/u)/8:.75;let p,m;c==="fontHalo"?(p=Pt(Le(a,d)),d.isBehind=!0,m=Pt(Le(a,d))):(p=Pt(Le(r,d)),d.isBehind=!0,m=Pt(Le(r,d))),e.bind(t,{u_float_buffer:_,u_float_gamma:h,u_vec4_color:p,u_vec4_hidden_color:m,u_float_label_index:l})},pu=(t,e,n,i,o)=>{const{attributes:r}=o,{offsetX:s,offsetY:a}=r,l=window.devicePixelRatio;e.bind(t,{u_vec2_offset:[s*l,a*l]})},gu=(t,e,n)=>{e.bind(t,{u_float_style_zoom:n.styleZoom})},So=(t,e,n,i,o)=>{const{tile:r}=o,{zoom:s}=n,a=yi*Math.pow(2,s-r.zoomLevel)*window.devicePixelRatio;e.bind(t,{u_float_tile_to_pixel_ratio:oo/a})},Ly=(t,e,n,i,o,r)=>{const{tile:s}=o,{zoom:a,styleZoom:l}=n,c=r.style.lengthUnits===Vo.Meters,d=_o(Ct(s.coords),[Se/2,Se/2]),u=oo/(yi*Math.pow(2,a-s.zoomLevel)*window.devicePixelRatio),f=c?l:Math.floor(l),h=yi*Math.pow(2,f-s.zoomLevel)*window.devicePixelRatio/(oo*d);e.bind(t,{u_vec2_scales:[h,u]})},Fy=(t,e,n,i,o)=>{const r=o.renderingProperties.flatTexture;r&&r.enable(t,0),e.bind(t,{u_flat_tex:0})},ky=(t,e,n,i,o)=>{const r=o.renderingProperties.flatIdentifyTexture;r&&r.enable(t,0),e.bind(t,{u_flat_tex:0})},Ry=(t,e,n,i,o)=>{const r=o.renderingProperties.hillshadeTexture;r&&(r.enable(t,Ep),e.bind(t,{u_hillshade_tex:Ep}))},JF=(t,e,n,{map:i})=>{const o=i.modules.demManager.getElevationSourceType()==="regular"?1:Number(i.state.useFlatDemIrregularMeshNormals);return e.bind(t,{u_use_flat_dem_mesh_normals:o}),!0},QF=(t,e,n,i,o)=>{const r=o.renderingProperties.demTexture;r&&(r.enable(t,0),e.bind(t,{u_tex_dem:0,u_mat4_dem_corrected:i.demManager.demCorrectedFbVpToDemTex}))},Xl=(t,e,n,i,o,r)=>{let s=!0;n.globeMode||(s=!!K(r.style.elevation,Tn(n,o))),e.bind(t,{u_bool_skip_height_factor:s})},si=(t,e,n,i,o,r)=>{let s=i.buildingHeightAnimator.getBuildingHeight(r.minzoom);i.map.state.demMode&&(s=Bf+(1-Bf)*s),e.bind(t,{u_float_height_factor:s})},$i=(t,e,n,i,o)=>{e.bind(t,{u_int_abs_z:o.attributes.absZ?1:0})},D_=(t,e)=>{e.bind(t,{u_int_abs_z:!1})},ek=(t,e)=>{e.bind(t,{u_int_signed_z:1})},vu=(t,e)=>{e.bind(t,{u_int_signed_z:0})},N_=(t,e,n,i,o)=>{e.bind(t,{u_float_tile_size:Nt(o.tile.zoomLevel)})},pe=(t,e,n,i,o,r,s)=>{e.bind(t,{u_float_dem_scale:s?n.elevationScale:0})},U_=(t,e,n,i,o)=>{if(!o.attributes.meshTier)return;const r=o.layerSettings.identify?i.renderer.getMapMeshIdFramebufferId():i.renderer.getMapMeshFramebufferId(),s=i.renderer.getFramebuffer(r),a=s==null?void 0:s.renderTarget.getTexture(),l=s==null?void 0:s.scale;a&&(a.enable(t,o1),e.bind(t,{u_sampler_map_tex:o1,u_vec2_tex_scale:l,u_float_tex_shift_scale:1-Math.cos(n.pitch)}))},Mo=(t,e,n,i,o)=>{e.bind(t,{u_int_identify:o.layerSettings.identify||o.layerSettings.depthTest?1:0})};function J(...t){return(e,n,i,o,r,s,a)=>{t.forEach(l=>l(e,n,i,o,r,s,a))}}const la=(t,e,n,i,o)=>(e.bind(t,{u_bool_is_3d_line:o.symbol==="line"&&o.sink==="solid3d"||o.symbol==="line"&&o.sink==="patterned3d"||o.symbol==="dashedLine"&&o.sink==="stroke3d"}),!0),gt=(t,e,n,i,o)=>{if(!o.attributes.floorId||!o.tile.renderModelMatrix){e.bind(t,{u_float_floor_elevation:0});return}if(o.symbol==="polygonExtrusion"&&o.attributes.isFloorStack){e.bind(t,{u_float_floor_elevation:i.floorManager.getFloorStackObjectElevation(o.attributes.floorId)/o.tile.renderModelMatrix[10]});return}e.bind(t,{u_float_floor_elevation:i.floorManager.getFloorObjectElevation(o.attributes.floorId)/o.tile.renderModelMatrix[10]})},yu=(t,e)=>{e.bind(t,{u_float_floor_elevation:0})},tk={value:[0,0,0]};function Mt(t,e){return ht(t.styleZoom,t.styleState,e.attributes.tileData,!1,e.tile.dynamicObject)}const nk=(t,e,n,i)=>{switch(t.attributes.side){case se.top:if(!i.style.strokeColor)return!1;break;case se.side:if(!i.style.sideColor)return!1;break;case se.bottom:if(!i.style.bottomColor)return!1;break;default:return!1}return!0},G_=(t,e)=>{const n=e.assetManager.textures[t.attributes.atlasIndex];return n?(t.renderingProperties.atlasTexture=n,!0):!1},zy=(t,e)=>{const n=e.imageManager.getTexture(t.attributes.textureIndex);return n?(t.renderingProperties.texture=n,!0):!1},ca=(t,e)=>{const{range:n,fontIndex:i,styleId:o}=t.attributes,r=e.styleManager.getStyle(o);if(!r)return!1;const s=r.fonts[i],a=e.assetManager.getFontTextureByName(s,n);return a?(t.renderingProperties.fontTexture=a,!0):!1},Lp=(t,e)=>{const n=t.layerSettings.identify?e.renderer.getMapMeshIdFramebufferId():e.renderer.getMapMeshFramebufferId(),i=e.renderer.getFramebuffer(n),o=i==null?void 0:i.renderTarget.getTexture(),r=i==null?void 0:i.scale;return!(!o||!r)},ik=(t,{imageManager:e})=>{const n=e.getTexture(t.attributes.rampTextureIndex);return n?(t.renderingProperties.rampTexture=n,!0):!1},ok=(t,e)=>{var o;const n=e.demManager.getDemFramebufferId(),i=(o=e.renderer.getFramebuffer(n))==null?void 0:o.renderTarget.getTexture();return i?(t.renderingProperties.demTexture=i,!0):!1},By=(t,{demManager:e,renderer:n,map:i})=>{var s;if(!i.state.demMode)return!1;const o=e.getHillshadeFramebufferId(),r=(s=n.getFramebuffer(o))==null?void 0:s.renderTarget.getTexture();return r?(t.renderingProperties.hillshadeTexture=r,!0):!1},Oy=(t,{demManager:e,renderer:n,map:i})=>{if(!i.state.demMode)return!1;const o=e.getFlatFramebufferId(),r=n.getFramebuffer(o);if(!r)return!1;const s=r.renderTarget.getTexture();return s?(t.renderingProperties.flatTexture=s,!0):!1},Dy=(t,{demManager:e,renderer:n,map:i})=>{if(!i.state.demMode)return!1;const o=e.getIdentifyFlatFramebufferId(),r=n.getFramebuffer(o);if(!r)return!1;const s=r.renderTarget.getTexture();return s?(t.renderingProperties.flatIdentifyTexture=s,!0):!1},rk=(t,e,n,i)=>{var a;const{renderingProperties:o}=t,{resolvedUvIndex:r}=o,{colorTextureUvIndex:s}=i.style;return s!==void 0&&r!==s&&((((a=t.meta)==null?void 0:a.availableTextureCoords)??[])[s]&&t.vao.setAttributesAliases({texcoord_color:`texcoord_${s}`}),o.resolvedUvIndex=s),!0},sk=(t,e,n,i)=>{const{styleId:o,colorTexture:r,aoTexture:s,pbrTexture:a,meshTier:l}=t.attributes,{renderingProperties:c}=t,{modelId:d}=c,u=e.assetManager.getModel(d??NaN,o);return!u||(r!==void 0&&u.textures[r]&&(c.resolvedColorTexture=r),s!==void 0&&u.textures[s]&&(c.resolvedAoTexture=s),a!==void 0&&u.textures[a]?c.resolvedPbrTexture=a:(c.resolvedMetallic=t.attributes.metallic??i.style.metallic,c.resolvedRoughness=t.attributes.roughness??i.style.roughness),!c.resolvedColorTexture&&!c.color)?!1:l?Lp(t,e):!0},Kb=(t,{modelsScene:e})=>{const n=e.getModelOpacity(t);return t.renderingProperties.resolvedOpacity=n,n!==0},Jb=(t,{modelsScene:e})=>{const n=e.getModelHeightFactor(t);return t.renderingProperties.resolvedHeightFactor=n,n!==0},ak=(t,e,n,i)=>{const o=Mt(n,t),r=K(i.style.width,o);if(r===0)return!1;const s=te(i.style.pattern,o);return!s||s[0]===ur.None?!1:(t.renderingProperties.width=r,t.renderingProperties.pattern=s,!0)},lk=(t,e,n)=>hg(n,t.attributes.animDirection)!==0,Ny=(t,e,n,i)=>{const o=Mt(n,t);return K(i.style.iconOpacity,o)*hg(n,t.attributes.animDirection)!==0},be=(t,e,n,i)=>ck(t.tile,n,i),Qb=(t,e,n)=>{var o,r,s,a,l,c;if((o=t.meta)!=null&&o.planId&&(!n.styleState._activeFloorIds||!n.styleState._activeFloorIds.includes(t.meta.planId))||(s=(r=t.meta)==null?void 0:r.linkedIds)!=null&&s.length&&!((a=t.meta)!=null&&a.planId)&&e.floorManager.hasDisplayedFloorBuilding(t.meta.linkedIds))return!1;const i=(l=t.meta)==null?void 0:l.buildingId;return!(i&&((c=t.tile.ids)!=null&&c.isHidden(i)))},ck=(t,e,n)=>{const{purpose:i,detailLevel:o}=t,{styleZoom:r}=e;switch(i){case"zenith":case"traffic":case"geojson":const s=o<Tk(i)?Ve(r,o,o+.99999):r;return n.minzoom<=s&&s<n.maxzoom;case"dynamicObject":return n.minzoom<=r&&r<=n.maxzoom;default:return n.minzoom<=r&&r<n.maxzoom}},dk=(t,e,n)=>{const{styleZoom:i}=n,{tile:o}=t;if(o.purpose!=="zenith"||i>qe.maxUniverseZoom)return!0;let r=qe.maxUniverseZoom;if(o.sourceId){const s=e.sourceStorage.getSourceById(o.sourceId);r=(s==null?void 0:s.type)==="zenith"?s.getOptions().strokeMinZoom??qe.maxUniverseZoom:qe.maxUniverseZoom}return i>r},ai=(t,e,n,i)=>{const{styleZoom:o}=n;return o>=i.minzoom&&o<i.maxzoom},Uy=(t,e)=>t.attributes.id===void 0?!0:!e.modelLayer.isHidden(t.attributes.id),H_=(t,e,n,i)=>{const o=Mt(n,t);return K(i.style.iconWidth,o)>0},Gy=(t,e,n,i)=>{const{layerSettings:o}=t,{uniformSet:r}=o,s=t.attributes.labelIndex,a=i.style;if(r==="fontHalo"){let{textHaloColor:l}=a;switch(s){case lo.Icon:l=a.iconTextHaloColor;break;case lo.Second:l=a.textHaloColor2;break}if(!l)return!1}return!0},bu=(t,e,n,i)=>!(t.layerSettings.uniformSet==="fontHalo"&&!i.style.textHaloColor),V_=(t,e,n,i)=>{const o=Mt(n,t),r=i.style;if(t.symbol==="point")switch(t.attributes.labelIndex){case lo.Second:return(K(r.textHaloWidth2??null,o)??0)>0&&!!r.textHaloColor2;case lo.Icon:return(K(r.iconTextHaloWidth??null,o)??0)>0&&!!r.iconTextHaloColor;case lo.First:break}return(K(r.textHaloWidth??null,o)??0)>0&&!!r.textHaloColor},uk=(t,{modelLayer:e})=>{const{texture:n,id:i}=t.attributes;if(i===void 0)return!1;const o=e.getTexture(i,n);return o?(t.renderingProperties.modelTexture=o,!0):!1},us=(t,e,n,i)=>{const o=K(i.style.width,Mt(n,t));return t.renderingProperties.widthResolved=o,o!==0},Yl=(t,e,n,i)=>{const o=Mt(n,t),r=K(i.style.strokeWidth,o);return t.renderingProperties.widthResolved=r,r!==0},fk=(t,e,n,i)=>{const o=Mt(n,t),r=K(i.style.strokeWidth,o);if(r===0)return!1;const s=K(i.style.width,o);return t.renderingProperties.widthResolved=s+r*2,!0},hk=(t,e,n,i)=>{const o=Mt(n,t),r=K(i.style.strokeWidth2,o);if(r===0)return!1;const s=K(i.style.width,o),a=K(i.style.strokeWidth,o);return t.renderingProperties.widthResolved=s+a*2+r*2,!0},_k=(t,e,n,i)=>{const o=Mt(n,t),r=K(i.style.width,o),s=K(i.style.strokeWidth,o),a=K(i.style.strokeWidth2,o),l=r+s*2+a*2;return t.renderingProperties.widthResolved=l,l!==0},or=(t,e,n)=>{const i=hg(n,t.attributes.animDirection);return t.renderingProperties.opacityResolved=i,i!==0},mk=(t,e,n,i)=>(t.renderingProperties.resolvedRadius=K(i.style.radius,Mt(n,t)),t.renderingProperties.resolvedRadius>0),pk=(t,e,n,i)=>{t.renderingProperties.mat4_gradient||(t.renderingProperties.mat4_gradient=new Float32Array(16));let o;switch(t.attributes.side){case se.top:o=i.style.topColor??i.style.color;break;case se.side:o=i.style.sideColor;break;case se.bottom:o=i.style.bottomColor;break}const r=Mt(n,t),s=te(o,r);return t.renderingProperties.mat4_gradient[0]=0,Cc(s)?gi(t,s):C0(s)&&_g(s,t.tile.readiness,t.renderingProperties.mat4_gradient),!0},Hy=(t,e,n,i)=>{if(t.renderingProperties.mat4_gradient||(t.renderingProperties.mat4_gradient=new Float32Array(16)),!t.renderingProperties.color)return!1;const o=Y3(i.style.sideColor,Mt(n,t));return o?(eh(t.renderingProperties.color.value,o.values[0].value),_g(o,t.tile.readiness,t.renderingProperties.mat4_gradient),t.renderingProperties.color.value[3]!==0):(t.renderingProperties.mat4_gradient[0]=0,!0)},Vy=(t,e,n,i)=>{const o=t.renderingProperties.color;if(!o)return!1;t.renderingProperties.mat4_gradient||(t.renderingProperties.mat4_gradient=new Float32Array(16));const r=Mt(n,t),s=Le(i.style.sideColor,r).value,a=m0(o.value,s),l=a?i.style.sideColor:i.style.sideStrokeColor,c=Y3(l,Mt(n,t));return c?(eh(o.value,c.values[0].value),_g(c,t.tile.readiness,t.renderingProperties.mat4_gradient)):t.renderingProperties.mat4_gradient[0]=0,a&&(o.value[3]*=n.stillness),o.value[3]!==0},Ai=(t,e)=>{const{floorManager:n}=e,i=t.attributes.hiddenById;return i?!n.hasDisplayedFloorBuilding([i]):!0},Ye=(t,e)=>t.attributes.floorId?t.symbol==="polygonExtrusion"&&t.attributes.isFloorStack?e.floorManager.isVisibleFloorStackObject(t.attributes.floorId):e.floorManager.isVisibleFloorObject(t.attributes.floorId):!0,gk=t=>{const e=t.renderingProperties.color;return e?Px(e.value,0,0,0,.05*255):t.renderingProperties.color=fo([0,0,0,.05*255]),!0},jy=(t,e,n,i)=>{const o=ht(n.styleZoom,n.styleState,t.attributes.tileData,!!t.layerSettings.isOverlappedObject);return gi(t,Le(i.style.color,o)),t.renderingProperties.color.value[3]!==0},$y=(t,e,n,i)=>(gi(t,Le(i.style.topColor,Mt(n,t))),t.renderingProperties.color.value[3]!==0),j_=(t,e,n,i)=>(gi(t,Le(i.style.sideColor,Mt(n,t))),t.renderingProperties.color.value[3]!==0),ql=(t,e,n,i)=>(gi(t,Le(i.style.strokeColor,Mt(n,t))),t.renderingProperties.color.value[3]!==0),vk=(t,e,n,i)=>{switch(t.attributes.side){case se.top:gi(t,Le(i.style.strokeColor,Mt(n,t)));break;case se.side:gi(t,Le(i.style.sideColor,Mt(n,t)));break;case se.bottom:gi(t,Le(i.style.bottomColor,Mt(n,t)));break;default:gi(t,tk);break}return t.renderingProperties.color.value[3]!==0},yk=(t,e,n,i)=>(gi(t,Le(i.style.strokeColor2,Mt(n,t))),t.renderingProperties.color.value[3]!==0),Wy=(t,e,n,i)=>{if(t.attributes.id===void 0)return!1;const o=t.renderingProperties.color;return o?(o.value[3]*=e.modelLayer.getOpacity(t.attributes.id,i.minzoom),o.value[3]!==0):!1},Zy=(t,e,n,i)=>{const o=t.renderingProperties.color;if(!o)return!1;const r=Mt(n,t),s=Le(i.style.strokeColor,r).value,a=K(i.style.strokeWidth,r);return m0(o.value,s)&&o.value[3]===1&&a<=1&&(o.value[3]*=n.stillness),o.value[3]!==0},bk=(t,e,n,i)=>{const o=t.renderingProperties.color;if(!o)return!1;const r=Mt(n,t),s=Le(i.style.topColor,r).value,a=K(i.style.strokeWidth,r);return m0(o.value,s)&&o.value[3]===1&&a<=1&&(o.value[3]*=n.stillness),o.value[3]!==0},Xy=(t,e,n,i)=>{const o=Le(i.style.sideStrokeColor,Mt(n,t));return gi(t,o),t.renderingProperties.color.value[3]!==0},Cr=(t,e,n,i)=>(gi(t,Le(i.style.color,Mt(n,t))),t.renderingProperties.color.value[3]!==0),wk=(t,e,n,i)=>{gi(t,Le(i.style.color,Mt(n,t)));const{color:o,resolvedOpacity:r}=t.renderingProperties;return Rx(o.value,o.value,t.attributes.colorFactor),o.value[3]*=r??0,o.value[3]!==0},ew=(t,e)=>{const n=t==null?void 0:t.attributes.parentId;if(!n)return!0;const{floorManager:i}=e;if(i.hasDisplayedFloorBuilding([n]))return!0;const r=t==null?void 0:t.tile.ids;return!(r!=null&&r.isHidden(n,Qn.PolygonExtrusion))},xk=(t,e)=>{if(!t.bboxWorld||t.tile.dynamicObject||t.renderingProperties.animationStack&&t.renderingProperties.animationStack.length>0)return!0;if(e.environmentManager.isAABBInFog(t.bboxWorld))return!1;const n=e.camera.getViewportVertices();return zs(n,t.bboxWorld)},$_=_e(be,ew,xk,Ye,Qb,Kb,Jb,wk),Sk=_e(be,ew,Qb,Kb,Jb),Mk=_e(rk,sk);function _e(...t){return(e,n,i,o)=>{for(const r of t)if(!r(e,n,i,o))return!1;return!0}}function Tk(t){switch(t){case"zenith":return qe.maxDetailLevel;case"traffic":return ci.maxDetailLevel;case"geojson":return Cf}}function hg(t,e){return e===ep.none?1:e===ep.fadeIn?t.labelingOpacity:1-t.labelingOpacity}function _g(t,e,n){if(!t.steps.length){n[0]=0;return}n[0]=Ve(t.values.length,0,3);for(let i=0;i<n[0];i++){const o=t.values[i],r=Pt(o);jr(r,r,e),n[i+1]=t.steps[i];const s=(i+1)*4;n[s]=r[0],n[s+1]=r[1],n[s+2]=r[2],n[s+3]=r[3]}}function gi(t,e){t.renderingProperties.color||(t.renderingProperties.color=fo([255,255,255,255])),eh(t.renderingProperties.color.value,e.value)}function Yy(t,e,n){const i=document.createElement("img");return i.width=e,i.height=n,new Promise(o=>{i.onload=()=>o(i),i.src=t})}function qy(t){let e;try{e={url:`data:image/svg+xml;base64,${btoa(t)}`}}catch{const i=URL.createObjectURL(new Blob([t],{type:"image/svg+xml"}));e={url:i,revokeURL:()=>URL.revokeObjectURL(i)}}return e}function vh(t,e="image/png"){const n=new Blob([t],{type:e}),i=URL.createObjectURL(n),o=document.createElement("img");return new Promise(r=>{o.onload=()=>{URL.revokeObjectURL(i),r(o)},t.byteLength===0?o.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=":o.src=i})}function tw(t,e){if(e[0]===t.width&&e[1]===t.height)return t;const n=document.createElement("canvas"),i=n.getContext("2d");return n.width=e[0],n.height=e[1],i.shadowColor="transparent",i.shadowBlur=0,i.drawImage(t,0,0,e[0],e[1]),n}const Ik="FRAGMENT",Ek="VERTEX",Ak="FOG",Ck="SKY",Pk="METALLIC_ROUGHNESS_DEBUG",Lk="PBR_TEXTURE",Fk="AO_TEXTURE",kk="MAP_MESH_TEXTURE",Rk="COLOR_TEXTURE",Ky="LIGHT_MODEL",zk="1",Bk="2",Ok="DEPTH_TEXTURE_SHADOW",Dk="RENDER_SHADOWS",Nk="UBO",Uk="SCREENDOOR",Gk="ENTRANCE_ARROWS_ROUNDING",Hk="MALI_GPU";function nw(t,e,n,i,o){const r=Array();o&&e.forEach(s=>{const a=i[s.outputBufferView],l=Math.round(o.get(s.actionId)||-1);if(a&&o.size>0&&l>=0){const c=new Float32Array(mg(a),s.outputBufferOffset,s.outputBufferLength);s.outputType==="VEC4"&&(n[s.targetMatIndex[0]][s.targetMatIndex[1]]=Jy(c,l,4)),s.outputType==="VEC3"&&(n[s.targetMatIndex[0]][s.targetMatIndex[1]]=Jy(c,l,3))}});for(let s=0;s<n.length;s++){const a=n[s];if(a.length===3){const l=Ui();Vx(l,a[1],a[0],a[2]),r.push(l)}else r.push(a)}Jk(t,r)}function Jy(t,e,n){if(n!==3&&n!==4)return console.warn("Invalid animation transform size"),[];const i=[];for(let o=0;o<n;o++)i.push(t[e*n+o]);return i}function Vk(t,e,n,i,o){t.animations.forEach((r,s)=>{r.channels.forEach((a,l)=>{if(a.target.node===n){const c=r.samplers[a.sampler],d=r.name||"default",u=t.accessors[c.input];if(u.bufferView===void 0||t.bufferViews[u.bufferView]===void 0)return;Qy(e,t,u.bufferView,u.componentType);const h=t.accessors[c.output];if(h.bufferView===void 0)return;const _=t.bufferViews[h.bufferView];if(_===void 0)return;Qy(e,t,h.bufferView,h.componentType);const p=jk(a.target.path);i.push({min:u.min,max:u.max,frameCount:u.count,keyFrameType:"SCALAR",outputType:p.outputType,outputBufferView:h.bufferView,outputBufferOffset:_.byteOffset||0,outputBufferLength:_.byteLength/p.bufferStride,targetMatIndex:[o.length-1,p.targetindex],actionId:`${r.name}_${s}_${l}`,animationIndex:s,animationName:d})}})})}function jk(t){let e=0,n="VEC3";const i=4;switch(t){case"translation":e=0;break;case"rotation":e=1,n="VEC4";break;case"scale":e=2;break;case"weights":e=3}return{targetindex:e,outputType:n,bufferStride:i}}function Qy(t,e,n,i){const o=e.bufferViews[n];if(o===void 0)return;if(!t.buffers[n]){const s=e.buffers[o.buffer].buffer;if(!s)return;t.buffers[n]=mg(s)}const r=t.buffers[n];if(!(r instanceof F))return r}function $k(t,e){for(let n=t.length-1;n>=0;n--){const i=t[n];if(e(i,n,t))return i}}const Wk=new Set(["position","texcoord_0","texcoord_1","texcoord_2","texcoord_3","normal","tangent"]),Zk=Array.from(Ui()),Xk={pbrMetallicRoughness:{baseColorFactor:[1,1,1,1],metallicFactor:1,roughnessFactor:1},emissiveFactor:[0,0,0],alphaMode:"OPAQUE",alphaCutoff:.5,doubleSided:!1};function Yk(t){return iw(t,Xk),t}function iw(t,e){for(const n in e)t[n]===void 0?t[n]=e[n]:typeof t[n]=="object"&&iw(t[n],e[n])}var ui=(t=>(t[t.Pending=1]="Pending",t[t.Loaded=2]="Loaded",t[t.Failed=3]="Failed",t))(ui||{});function qk(t){return{buffers:[],objects:[],textures:[],status:1,preserve:t}}function Kk(t,e,n,i,o){const r=[],s=[];return ow(t,n.scenes[n.scene].nodes,n,r,s,e,i,o),t}function ow(t,e,n,i,o,r,s,a){var c;if(!e)return;const l=r.symbolSettingsList.gltfModel.instances;if(!(!l||l.length===0))for(const d of e){const u=[...i],f=[...o],h=n.nodes[d];if(h.matrix&&u.push(h.matrix),h.translation&&h.rotation&&h.scale){const _=[];_.push(h.translation,h.rotation,h.scale),u.push(_),Vk(n,t,d,f,u)}if(h.mesh!==void 0){const _=n.meshes[h.mesh];let p=_3(h.extras)&&h.extras.dem==="flat"?ic.flat:ic.default;const m=new Float32Array(16);nw(m,f,u,t.buffers);let g,y;if(h.children){const b=[];for(const v of h.children){const T=n.nodes[v];tR(T)&&b.push(T)}if(b.length){const v=b[0];if(v.extras.dem==="centroid")p=ic.centroid,g=[v.translation[0],v.translation[2]];else if(v.extras.dem==="axis"){p=ic.axis;const T=$k(b,x=>x.extras.dem==="axis");y=[v.translation[0],v.translation[2],(T??v).translation[0],(T??v).translation[2]]}}}for(const b of _.primitives){const v=[],T={};let x=0,I,E;for(const C in b.attributes){const D=/TEXCOORD_(\d+)/.exec(C);D&&(v[parseInt(D[1],10)]=!0);const B=C.toLowerCase();if(!Wk.has(B))continue;const U=b.attributes[C],G=n.accessors[U];if(G.bufferView===void 0)continue;const V=n.bufferViews[G.bufferView];if(V===void 0)continue;const ne=e2(t,n,G.bufferView,G.componentType);if(ne){if(B==="position"&&(I=G.min,E=G.max),ne.purpose="gltfMesh",T[C.toLowerCase()]=new R(ne,{itemSize:Qk(G.type),dataType:i5(G.componentType),stride:V.byteStride??0,offset:G.byteOffset??0,normalized:!!G.normalized}),!g&&C.toLowerCase()==="position"){const X=G.min,Z=G.max;X&&Z&&(g=[(Z[0]+X[0])/2,(Z[2]+X[2])/2])}x===0&&(x=G.count)}}I||(I=[0,0,0]),E||(E=[0,0,0]);let L;if(b.indices!==void 0){const C=n.accessors[b.indices];if(C.bufferView===void 0||(L=e2(t,n,C.bufferView,C.componentType,!0),!L))continue;L.purpose="gltfIndices",x=C.count}const N=b.material!==void 0?n.materials[b.material]:{},k=Yk(N),w={},S={localMatrix:m,animationStack:f,transformStack:u,availableTextureCoords:v,attributesAliases:w,colorFactor:[...k.pbrMetallicRoughness.baseColorFactor],colorTexture:NaN,aoTexture:NaN,pbrTexture:NaN,centroid:g,axis:y,demPosition:p},A=[],z=k.pbrMetallicRoughness.baseColorTexture;z&&(A.push({type:Rk}),w.texcoord_color=`texcoord_${z.texCoord??0}`,W_(t,n,z),S.colorTexture=z.index);const M=k.pbrMetallicRoughness.metallicRoughnessTexture;if(M){A.push({type:Lk}),W_(t,n,M),S.pbrTexture=M.index;const C=typeof M.texCoord=="number"?M.texCoord:0;w.texcoord_pbr=`texcoord_${C}`,v[C]=!1}else S.roughness=k.pbrMetallicRoughness.roughnessFactor??1,S.metallic=k.pbrMetallicRoughness.metallicFactor??1;Number.isNaN(a.style.roughness)||A.push({type:Pk}),((c=h.extras)==null?void 0:c.tier)!==void 0&&(S.meshTier=h.extras.tier,A.push({type:kk})),a.style.lightingModel==="pbr"?A.push({type:Ky,value:Bk}):A.push({type:Ky,value:zk});const P=k.occlusionTexture;if(P){A.push({type:Fk}),W_(t,n,P),S.aoTexture=P.index;const C=typeof P.texCoord=="number"?P.texCoord:0;w.texcoord_ao=`texcoord_${C}`,v[C]=!1}t.objects.push({start:0,count:x,attributes:S,drawMode:b.mode,accessors:T,elementsBuffer:L,shaderDefinitions:A,bbox:{min:I,max:E}})}}h.children&&ow(t,h.children,n,u,f,r,s,a)}}function W_(t,e,n){const i=n.index??0,o=e.textures[i];if(!o||o.source===void 0||o.sampler===void 0)return;const r=e.images[o.source],s=e.samplers[o.sampler];if(!s||!r)return;const a={flipY:!1};if(s.magFilter&&(a.magFilter=Yd(s.magFilter)),s.minFilter&&(a.minFilter=Yd(s.minFilter)),s.wrapS&&(a.wrapS=Yd(s.wrapS)),s.wrapT&&(a.wrapT=Yd(s.wrapT)),n.texCoord!==void 0&&(a.texcoord=n.texCoord),!r.image&&r.bufferView){eR(e,r).then(l=>{l&&(r.image=l,t.textures[i]=new j(r.image,a))});return}t.textures[i]=new j(r.image,a)}function e2(t,e,n,i,o=!1){const r=e.bufferViews[n];if(r===void 0)return;if(!t.buffers[n]){const a=e.buffers[r.buffer].buffer;if(!a)return;const l=new DataView(mg(a),r.byteOffset,r.byteLength),c=new F(l,{dataType:i5(i)},o);t.buffers[n]=c}const s=t.buffers[n];if(!(s instanceof ArrayBuffer))return s}function Jk(t=[],e){if(e.length===0)return Array.from(Zk);ja(t,e[0]);for(let n=1;n<e.length;n++)Hr(t,t,e[n]);return t}function Qk(t){switch(t[0]){case"S":return 1;case"V":return Number(t[3]);case"M":return Number(t[3])**2}return console.error(`Failed to determine channels count from accessor type = ${t}`),0}function mg(t){return t instanceof ArrayBuffer?t:t.buffer}async function eR(t,e){if(!e.bufferView)return!1;const n=t.bufferViews[e.bufferView];if(n===void 0)return!1;const i=t.buffers[n.buffer].buffer;return i?vh(new Uint8Array(i,n.byteOffset,n.byteLength),e.mimeType):!1}function tR(t){return t.mesh===void 0&&_3(t.extras)&&(t.extras.dem==="centroid"||t.extras.dem==="axis")}const nR=mr([1,1,1]),ps=Ke(),Fp=Ke(),iR=Ui();function oR(t,e){Go(t,e);const n=Ui();n[12]+=t[12],n[13]+=t[13],Hr(t,t,n)}function kp(t){return t.symbol==="gltfModel"&&t.sink==="instances"}function rR(t,e,n,i,o){const r=t.modelMatrices.get(0);if(!r)return;const s=[n[0]/vt,n[1]/vt,n[2]/vt],a=[n[3]/vt,n[4]/vt,n[5]/vt],l={min:[0,0,0],max:[0,0,0]};if(ii(l.min,s,r),ii(l.max,a,r),o)if(i.tMatrix3x3){const c=sR(o,i.tMatrix3x3,e);jt(l.min,l.min,c.min),jt(l.max,l.max,c.max)}else{let c=Math.max(mr(o.max),mr(o.min));if(e){const d=ps,u=Fp;SS(e,d,u);const f=mr(d)/nR;c*=f,c+=mr(u)}c*=i.maxDiag??1,St(ps,-c,-c,-c),jt(l.min,l.min,ps),St(ps,c,c,c),jt(l.max,l.max,ps)}return l}function sR(t,e,n){const i=Gx(iR,e[0],e[1],e[2],0,e[3],e[4],e[5],0,e[6],e[7],e[8],0,0,0,0,1);n&&Hr(i,i,n);const o=Nn(ps,t.min,t.max,.5),r=ni(Fp,$t(Fp,t.max,t.min),.5),s=ii(ps,o,i),a=yt(Math.abs(i[0])*r[0]+Math.abs(i[4])*r[1]+Math.abs(i[8])*r[2],Math.abs(i[1])*r[0]+Math.abs(i[5])*r[1]+Math.abs(i[9])*r[2],Math.abs(i[2])*r[0]+Math.abs(i[6])*r[1]+Math.abs(i[10])*r[2]),l=$t(Ke(),s,a),c=jt(Ke(),s,a);return{min:l,max:c}}class aR{constructor(e){this.modules=e,this.queue=new Map}enqueue(e,n){this.queue.set(n.id,{batch:e,tile:n,state:void 0})}update(){const{renderer:e,tileManager:n}=this.modules;for(const i of n.getTileObjects()){const o=this.queue.get(i.id);if(!o)continue;const{batch:r}=o,{symbol:s,sink:a}=r,l=G0(e,s,a);if(!l){console.error(`Cannot happen! Symbol ${s} does not have sink ${a}!`);continue}const c=l[0].instanceBinder;if(!c){console.error("Cannot happen! No instanceBinder for batch inside instanceLinker queue.");continue}const d=c(this.modules,r,i,o.state);if(!d){this.queue.delete(i.id);continue}o.state=d}}}function lR(t,e,n,i,o,r,s,a,l,c,d,u){const f=qc(r,s),h=G0(e,r,s),{accessors:_,elementsBuffer:p,count:m,drawMode:g,bbox:y}=i,b=Xo.createShaderDefinitions(i.shaderDefinitions);d.linkId=n;for(const v of h){const T=v.uniformSet||"fill",x=JSON.stringify(l)+"_"+T+"_"+o.detailLevel,I=e.getShaderProgram(v.programName,b),E=a.buffer;if(!E){console.error(`Expected existing buffer while linking instance, but ${E} found.`);continue}const L=v.vaoCreator(E,I,p,_);d.attributesAliases&&L.setAttributesAliases(d.attributesAliases);const N={id:mo(),type:ri.Tile,layerSettings:v,start:0,count:m,attributes:l,shaderDefinitions:b,renderingProperties:c,meta:d,attributesHash:x,vao:L,drawMode:g,tile:o,bbox:y,bboxWorld:u,symbol:r,sink:s,canRender:!0,instanceCount:(a.rangeEnd-a.rangeStart)/f};o.push(N),t.push(N)}t.length&&e.addRerenderEvent({type:"instanceLink"})}function t2(t,e,n){cR(e,i=>{var r;const o=((r=i.meta)==null?void 0:r.linkId)===n;return o&&t.push(i),!o})}function cR(t,e){t.children=t.children.filter(e),t.identifyChildren=t.identifyChildren.filter(e),t.depthTestChildren=t.depthTestChildren.filter(e),t.labelTestChildren=t.labelTestChildren.filter(e),t.shadowChildren=t.shadowChildren.filter(e)}const dR={min:[0,0,0],max:[0,0,0]},wu=(t,e,n,i)=>{const{assetManager:o,modelsScene:r,renderer:s}=t;if(i||(i={}),n.destroyed){const l=[];for(const c in i){const d=i[+c];Number.isNaN(d.linkId)||t2(l,n,d.linkId)}for(const c of l)r.removeSceneObject(c.id);return}const a=[];for(let l=0;l<e.generatedObjects.length;l++){const c=e.generatedObjects[l],d=Ni.sinks.instances.unpackObjectAttributes(c.attributes),{extents:u}=c;i[l]||(i[l]={modelId:NaN,linkId:NaN});const f=i[l];let h;const _=!!f.referenceBbox;f.referenceBbox?h=f.referenceBbox:(h=dR,h.min[0]=u[0]/vt,h.min[1]=u[1]/vt,h.min[2]=u[2]/vt,h.max[0]=u[3]/vt,h.max[1]=u[4]/vt,h.max[2]=u[5]/vt);const{styleId:p}=d,m=f.modelId;r.updateModelId(f,d,h,n,_);const g=f.modelId;if(g===void 0||Number.isNaN(g)||m===g)continue;const y=o.getModel(g,p);if(!y||y.status!==ui.Loaded||y.objects.length===0)continue;const b=f.linkId;if(!Number.isNaN(b)){const T=[];t2(T,n,b);for(const x of T)r.removeSceneObject(x.id)}const v=mo();f.linkId=v;for(const T of y.objects){const x=n.modelMatrices.get(0),I=new Float32Array(16);oR(I,x);const{attributesAliases:E,availableTextureCoords:L,colorTexture:N,colorFactor:k,aoTexture:w,pbrTexture:S,metallic:A,roughness:z,meshTier:M,animationStack:P,transformStack:C,localMatrix:D,demPosition:B,axis:U,centroid:G}=T.attributes,V=rR(n,D,u,c,T.bbox);!f.referenceBbox&&V&&(f.referenceBbox=V),lR(a,s,v,T,n,e.symbol,e.sink,c,{colorTexture:N,colorFactor:k,aoTexture:w,pbrTexture:S,metallic:A,roughness:z,meshTier:M,demPosition:B,axis:U,centroid:G,...d},{modelId:g,animationStack:P,transformStack:C,localMatrix:new Float32Array(D??[]),transformMatrix:I},{...c.meta,attributesAliases:E,availableTextureCoords:L},V)}}return a.forEach(l=>{r.addSceneObject(l)}),i},Of=new Float32Array(16);let en;function ie(...t){return(n,i,o,r,s,a,l)=>{for(const c of t)if(!c(n,i,o,r,s,a,l))return!1;return!0}}const ae=(t,e,n,i,o)=>(e.bind(t,{u_mat4_mvp:o.tile.renderMvpMatrix}),!0),Pn=(t,e,n,i,o)=>{const{camera:r,styleManager:s}=i,a=s.getStyle(n.handyStyleId);return!(a==null?void 0:a.environment)||!o.tile.renderModelMatrix?!1:(e.bind(t,{u_mat4_flat_mvp:o.tile.renderMvpMatrix,u_mat4_ecef_mvp:r.ecefMvpMatrix,u_float_crossfade:r.globeRatio}),!0)},xu=(t,e,n,i,o)=>(e.bind(t,{u_mat4_flat_map_mvp:o.tile.renderFlatMapTexMatrix}),!0),ke=(t,e,n,i,o)=>o.tile.renderModelMatrix?(ja(Of,o.tile.renderModelMatrix),e.bind(t,{u_mat4_model:Of}),!0):!1,Su=(t,e,n,i,o)=>(e.bind(t,{u_int_abs_z:o.attributes.absZ?1:0}),!0),ge=(t,e,n,i,o,r,s)=>{if(s.terrain3d){if(!o.tile.renderModelMatrix)return!1;e.bind(t,{u_mat4_dem_mvp:o.tile.renderDemMatrix,u_float_vertical_scale:1/o.tile.renderModelMatrix[10]})}return!0};function pg(t,e){return ht(t.styleZoom,t.styleState,e.attributes.tileData)}const Z_=(t,e,n,i,o,r)=>{var p;en=void 0;const s=pg(n,o),a=Hn(r.style.textureImage,s);let l=!1,c;r.type==="polygon"&&(l=r.style.lengthUnits===Vo.Meters);const d=i.styleManager.getStyle(o.attributes.styleId);if(!d)return!0;const u=(p=d.rasterSets.byKey[_l(a)])==null?void 0:p.rasters;if(!u)return!0;if(l){const[m,g=m]=te(r.style.textureSize,s),y=m*Ka(m,m),b=g*Ka(g,g);c=[y,b]}else c=te(r.style.textureSize,s);const[f,h]=Array.isArray(c)?c:[c,c];if(f<=0||h<=0)return!0;const _=ml(u,f*window.devicePixelRatio,!0);return _===void 0||(en=u[_]),!0},X_=(t,e,n,{assetManager:i},o,r)=>{if(!en)return e.bind(t,{u_int_is_textured:0}),!0;let s,a,l,c;const{tile:d}=o,{zoom:u}=n,f=i.textures[en.atlasIndex];let h=!1;if(!f)return e.bind(t,{u_int_is_textured:0}),!0;r.type==="polygon"&&(h=r.style.lengthUnits===Vo.Meters),f.enable(t,0);let _;if(h){const p=pg(n,o),[m,g=m]=te(r.style.textureSize,p),y=q.toGeo(Di(d.coords)),b=q.scaleFactor(y[1]),v=Nt(d.zoomLevel)/He/b;l=v/m,c=v/g,s=d.coords[0]*l%1,a=d.coords[1]*c%1}else _=yi*Math.pow(2,Math.round(u)-d.zoomLevel)*window.devicePixelRatio,s=d.coords[0]*_%en.w/en.w,a=d.coords[1]*_%en.h/en.h,l=_/en.w,c=_/en.h;return e.bind(t,{u_int_is_textured:1,u_float_texture_params:[s,a,l,c],u_float_sprite_texture_coords:[(en.x+.5)/tn[0],(en.y+en.h-1)/tn[1],(en.x+en.w-1)/tn[0],(en.y+.5)/tn[1]]}),!0},uR=(t,e,n,i,o)=>{if(!en)return e.bind(t,{u_int_is_textured:0}),!0;const{tile:r}=o,{zoom:s}=n,a=i.assetManager.textures[en.atlasIndex];if(!a)return e.bind(t,{u_int_is_textured:0}),!0;a.enable(t,0);const l=yi*Math.pow(2,Math.round(s)-r.zoomLevel)*window.devicePixelRatio;return e.bind(t,{u_int_is_textured:1,u_float_texture_vertical_scale:en.h*r.size/l}),!0},fR=(t,e,n,{styleManager:i,assetManager:o},r,s)=>{var b;const a=pg(n,r),l=Hn(s.style.iconImage,a),c=i.getStyle(r.attributes.styleId);if(!c)return!1;const d=(b=c.rasterSets.byKey[_l(l)])==null?void 0:b.rasters;if(!d)return!1;const u=K(s.style.width,a),f=K(s.style.height,a),h=Ka(u,f),_=u*h,p=f*h;if(_<=0||p<=0)return!1;const m=ml(d,_*window.devicePixelRatio,!0);if(m===void 0)return!1;const g=d[m],y=o.textures[g.atlasIndex];return y?(y.enable(t,0),e.bind(t,{u_float_sprite_texture_coords:[(g.x+.5)/tn[0],(g.y+g.h-1)/tn[1],(g.x+g.w-1)/tn[0],(g.y+.5)/tn[1]]}),!0):!1},rw=new Float32Array(16);$u(rw,[1/et,1/et,1/et]);const Mu=(t,e,n,{animationManager:i,assetManager:o},r,s)=>{const{styleId:a}=r.attributes,{localMatrix:l,transformMatrix:c,modelId:d}=r.renderingProperties;if(d===void 0)return!1;const u=o.getModel(d,a);return u===void 0?!1:(i.animateGltfObject(r,s,u),e.bind(t,{u_mat4_localmatrix:l,u_mat4_instance:n.globeMode?rw:c}),!0)},hR=(t,e,n,i,o)=>o.tile.renderModelMatrix?(ja(Of,o.tile.renderModelMatrix),e.bind(t,{u_mat4_model:Of}),!0):!1,_R=(t,e,n,i)=>!i.shadowManager.texture;function mR(){return{line:{solid:[{programName:"road",vaoCreator:DP,webglState:yn,needsVisibilityBuffer:!1,commonBinder:Te(xe,we,De),programBinder:OF,objectBinder:J(My,pt,Cn),layerBinder:Je,zoomBinder:So,tileBinder:ie(ke,ae),cullMethod:_e(be,us,Cr)},{identify:!0,programName:"roadIdentify",vaoCreator:HP,webglState:lr,needsVisibilityBuffer:!1,objectBinder:J(Cn),zoomBinder:So,tileBinder:ae,cullMethod:_e(be,us)}],patterned:[{programName:"patternedLine",vaoCreator:VP,webglState:yn,needsVisibilityBuffer:!1,commonBinder:Te(xe,we,De),programBinder:qb,layerBinder:Je,objectBinder:J(Iy,Cn,cn,la),zoomBinder:Ly,tileBinder:ie(ke,ae),cullMethod:_e(be,us,ak)}],solid3d:[{programName:"line3D",vaoCreator:NP,webglState:A_,needsVisibilityBuffer:!1,commonBinder:Te(xe,we,De),programBinder:PF,objectBinder:J(pt,Cn,pe),layerBinder:Je,zoomBinder:So,tileBinder:ie(ke,ae,ge),cullMethod:_e(be,Cr)},{identify:!0,programName:"line3DIdentify",vaoCreator:UP,webglState:Lt,needsVisibilityBuffer:!1,programBinder:Qe,objectBinder:J(Cn,pe),zoomBinder:So,tileBinder:ie(ae,ge),cullMethod:be}],patterned3d:[{programName:"patternedLine3D",vaoCreator:jP,webglState:A_,needsVisibilityBuffer:!1,commonBinder:Te(xe,we,De),programBinder:DF,layerBinder:Je,objectBinder:J(Iy,Cn,cn,la,pe),zoomBinder:Ly,tileBinder:ie(ke,ae,ge),cullMethod:be}]},polygon:{fill:[{programName:"vtxColor",vaoCreator:RP,webglState:yn,needsVisibilityBuffer:!0,commonBinder:Te(xe,we,De),programBinder:kF,layerBinder:vn(Je,Lo),objectBinder:J(pt,cn,Sy,gt),tileBinder:ie(Z_,X_,ae,ke),cullMethod:_e(be,Ye,Cr)},{identify:!0,programName:"vtxColorIdentify",vaoCreator:OP,webglState:lr,needsVisibilityBuffer:!0,programBinder:O1,objectBinder:J(gt),tileBinder:ae,cullMethod:_e(be,Ye)}],stroke:[{programName:"simpleLine",vaoCreator:oL,webglState:yn,needsVisibilityBuffer:!0,commonBinder:Te(xe,we,De),programBinder:Vl,layerBinder:vn(O1,qd,Je),objectBinder:J(pt,Cn,vu,gt),tileBinder:ie(ke,ae),cullMethod:_e(dk,be,Ye,Yl,ql,Zy),subRenderIndex:1}],shadow:[{programName:"vtxColor",vaoCreator:zP,webglState:yn,needsVisibilityBuffer:!0,commonBinder:Te(xe,we),programBinder:ho,layerBinder:Lo,objectBinder:J(pt,cn,gt),tileBinder:ie(_R,Z_,X_,ae,ke),cullMethod:_e(be,Ye,gk)}]},metricPoint:{fill:[{programName:"metricPoint",vaoCreator:BP,webglState:yn,needsVisibilityBuffer:!1,commonBinder:Te(xe,De,we),programBinder:oi,layerBinder:vn(Je,Lo),objectBinder:J(pt,gt),tileBinder:ie(fR,ae,ke),cullMethod:_e(be,Ye,Cr)}]},mesh:{fill:[{programName:"mesh",vaoCreator:G1,webglState:ry,needsVisibilityBuffer:!0,commonBinder:Te(xe,we,De),programBinder:ji,layerBinder:vn(Je,xo),objectBinder:J(pt,Zl,cn,si,pe,$i,Mo,Sy),tileBinder:ie(Z_,X_,uR,ke,ae,ge),cullMethod:_e(be,pk),subRenderIndex:1,is3dMapAware:!0},{identify:!0,programName:"mesh",vaoCreator:G1,webglState:Lt,needsVisibilityBuffer:!0,commonBinder:Te(xe,we,De),programBinder:ji,objectBinder:J(si,pe,$i,Mo),tileBinder:ie(ae,ge),cullMethod:be,subRenderIndex:1,is3dMapAware:!0},{depthTest:!0,programName:"mesh",vaoCreator:WP,webglState:Lt,needsVisibilityBuffer:!0,commonBinder:Te(xe,we,De),programBinder:ji,objectBinder:J(si,pe,$i,Mo),tileBinder:ie(ae,ge),cullMethod:be,subRenderIndex:1,is3dMapAware:!0},{programName:"meshShadow",shadow:!0,vaoCreator:H1,webglState:ou,needsVisibilityBuffer:!0,programBinder:Qe,objectBinder:J(si,pe,$i),tileBinder:ie(ae,ge),cullMethod:be,is3dMapAware:!0}],inverse:[{programName:"mesh",vaoCreator:Qd,webglState:nu,needsVisibilityBuffer:!0,commonBinder:Te(xe,we,De),programBinder:ji,objectBinder:J(si,pe,Mo),tileBinder:ie(ae,ge),subRenderIndex:-1,is3dMapAware:!0},{identify:!0,programName:"mesh",vaoCreator:Qd,webglState:nu,needsVisibilityBuffer:!1,commonBinder:Te(xe,we,De),programBinder:ji,objectBinder:J(si,pe,Mo),tileBinder:ie(ae,ge),subRenderIndex:-1,is3dMapAware:!0},{programName:"meshShadow",shadow:!0,vaoCreator:Qd,webglState:ou,needsVisibilityBuffer:!0,programBinder:Qe,objectBinder:J(si,pe,$i),tileBinder:ie(ae,ge),cullMethod:be,is3dMapAware:!0}],depthClear:[{programName:"meshDepthClear",vaoCreator:Qd,webglState:LL,needsVisibilityBuffer:!0,commonBinder:Te(xe,we,De),programBinder:ji,objectBinder:J(si,pe,Mo,$i),tileBinder:ie(ae,ge),subRenderIndex:-2,is3dMapAware:!0}],stroke:[{programName:"meshStroke",vaoCreator:ZP,webglState:sa,needsVisibilityBuffer:!0,commonBinder:Te(xe,we,De),programBinder:Vl,layerBinder:vn(Xt,qd,Je),objectBinder:J(pt,Cn,si,ek,pe,$i),tileBinder:ie(ke,ae,ge),cullMethod:_e(be,Yl,nk,vk,Zy),subRenderIndex:2,is3dMapAware:!0}]},polygonExtrusion:{sideFill:[{programName:"diffuse",vaoCreator:eu,webglState:nu,needsVisibilityBuffer:!0,commonBinder:Te(xe,we,De),programBinder:jl,tileBinder:ie(ke,ae,ge),layerBinder:vn(Je,xo),objectBinder:J(pt,Ei,cn,pe,gt),cullMethod:_e(be,Ye,j_,Ai),is3dMapAware:!0},{programName:"gradientDiffuse",vaoCreator:eu,webglState:sy,needsVisibilityBuffer:!0,commonBinder:Te(xe,we,De),programBinder:jl,layerBinder:vn(Je,xo),objectBinder:J(pt,Zl,Ei,cn,pe,gt),tileBinder:ie(ke,ae,ge),cullMethod:_e(be,Ye,Ai,j_,Hy),subRenderIndex:1,is3dMapAware:!0},{identify:!0,programName:"buildingIdentify",vaoCreator:V1,webglState:Lt,needsVisibilityBuffer:!0,programBinder:au,objectBinder:J(Ei,pe,gt),tileBinder:ie(ae,ge),cullMethod:_e(be,Ye,Ai),is3dMapAware:!0},{depthTest:!0,programName:"buildingIdentify",vaoCreator:j1,webglState:Lt,needsVisibilityBuffer:!0,programBinder:au,objectBinder:J(Ei,pe,gt),tileBinder:ie(ae,ge),cullMethod:_e(be,Ye,Ai),is3dMapAware:!0},{programName:"buildingShadow",shadow:!0,vaoCreator:$1,webglState:iu,needsVisibilityBuffer:!0,programBinder:Qe,objectBinder:J(Ei,pe,gt),tileBinder:ie(ae,ge),cullMethod:_e(be,Ye,Ai),is3dMapAware:!0}],topFill:[{programName:"diffuse",vaoCreator:eu,webglState:nu,needsVisibilityBuffer:!0,commonBinder:Te(xe,we,De),programBinder:jl,layerBinder:Je,objectBinder:J(pt,Ei,cn,pe,gt),tileBinder:ie(ke,ae,ge),cullMethod:_e(be,Ye,Ai,$y),is3dMapAware:!0},{programName:"diffuse",vaoCreator:eu,webglState:sy,needsVisibilityBuffer:!0,commonBinder:Te(xe,we,De),programBinder:jl,layerBinder:vn(Je,xo),objectBinder:J(pt,Ei,cn,pe,gt),tileBinder:ie(ke,ae,ge),cullMethod:_e(be,Ye,Ai,$y),subRenderIndex:1,is3dMapAware:!0},{identify:!0,programName:"buildingIdentify",vaoCreator:V1,webglState:Lt,needsVisibilityBuffer:!0,programBinder:au,objectBinder:J(Ei,pe,gt),tileBinder:ie(ae,ge),cullMethod:_e(be,Ye,Ai),is3dMapAware:!0},{depthTest:!0,programName:"buildingIdentify",vaoCreator:j1,webglState:Lt,needsVisibilityBuffer:!0,programBinder:au,objectBinder:J(Ei,pe,gt),tileBinder:ie(ae,ge),cullMethod:_e(be,Ye,Ai),is3dMapAware:!0},{programName:"buildingShadow",shadow:!0,vaoCreator:$1,webglState:iu,needsVisibilityBuffer:!0,programBinder:Qe,objectBinder:J(Ei,pe,gt),tileBinder:ie(ae,ge),cullMethod:_e(be,Ye,Ai),is3dMapAware:!0}],sideStroke:[{programName:"line",vaoCreator:W1,webglState:sa,needsVisibilityBuffer:!0,commonBinder:Te(xe,De,we),programBinder:xy,layerBinder:Je,objectBinder:J(pt,Zl,Ei,cn,pe,gt),tileBinder:ie(ke,ae,ge),cullMethod:_e(be,Ye,Ai,Xy,Vy),subRenderIndex:3,is3dMapAware:!0}],topStroke:[{programName:"simpleLine",vaoCreator:g_,webglState:sa,needsVisibilityBuffer:!0,commonBinder:Te(xe,we,De),programBinder:Vl,layerBinder:vn(Je,Xt,PP),objectBinder:J(pt,Cn,Ei,vu,pe,gt,D_),tileBinder:ie(ke,ae,ge),cullMethod:_e(be,Ye,Ai,Yl,ql,bk),subRenderIndex:4,is3dMapAware:!0}]},labelLine:{raster:[{programName:"labelLine",vaoCreator:Jd,webglState:P_,needsVisibilityBuffer:!1,commonBinder:Te(xe,we),programBinder:lu,objectBinder:J(Ar,aa,ds,mu,gu),tileBinder:ie(ae,ke),zoomBinder:So,cullMethod:_e(Ye,or,ai,ca,bu,V_),uniformSet:"fontHalo"},{programName:"labelLine",vaoCreator:Jd,webglState:L_,needsVisibilityBuffer:!1,commonBinder:Te(xe,we),programBinder:lu,objectBinder:J(Ar,aa,ds,mu,gu),tileBinder:ie(ae,ke),zoomBinder:So,cullMethod:_e(Ye,or,V_,ai,ca,bu),uniformSet:"fontHalo",isOverlappedObject:!0},{programName:"labelLine",vaoCreator:Jd,webglState:P_,needsVisibilityBuffer:!1,commonBinder:Te(xe,we),programBinder:lu,objectBinder:J(Ar,aa,ds,mu,gu),zoomBinder:So,tileBinder:ie(ae,ke),cullMethod:_e(Ye,or,ai,ca,bu),uniformSet:"fontFill",subRenderIndex:1},{programName:"labelLine",vaoCreator:Jd,webglState:L_,needsVisibilityBuffer:!1,commonBinder:Te(xe,we),programBinder:lu,objectBinder:J(Ar,aa,ds,mu,gu),zoomBinder:So,tileBinder:ie(ae,ke),cullMethod:_e(Ye,or,ai,ca,bu),uniformSet:"fontFill",subRenderIndex:1,isOverlappedObject:!0}]},dashedLine:{stroke:[{programName:"stripedLine",vaoCreator:D1,webglState:yn,needsVisibilityBuffer:!1,commonBinder:Te(De,xe,we),programBinder:Yb,layerBinder:Je,objectBinder:J(du,_u,cu,cn,la),tileBinder:ie(ke,ae),cullMethod:_e(be,us)},{identify:!0,programName:"stripedLineIdentify",vaoCreator:D1,webglState:oy,needsVisibilityBuffer:!1,programBinder:Xb,objectBinder:J(du,_u,cn,cu,la),tileBinder:ae,cullMethod:_e(be,us)}],stroke3d:[{programName:"stripedLine3D",vaoCreator:N1,webglState:A_,needsVisibilityBuffer:!1,commonBinder:Te(De,xe,we),programBinder:RF,layerBinder:Je,objectBinder:J(du,_u,cu,cn,la,pe),tileBinder:ie(ke,ae,ge),cullMethod:be},{identify:!0,programName:"stripedLine3DIdentify",vaoCreator:N1,webglState:Lt,needsVisibilityBuffer:!1,programBinder:zF,objectBinder:J(du,_u,cn,cu,la,pe),tileBinder:ie(ae,ge),cullMethod:be}]},oneWayLine:{raster:[{programName:"oneWayLine",vaoCreator:Z1,webglState:P_,needsVisibilityBuffer:!1,commonBinder:Te(sc,rc),programBinder:yy,objectBinder:J(Ar,pt,uu,Ey),tileBinder:ae,cullMethod:_e(or,ai,jy)},{programName:"oneWayLine",vaoCreator:Z1,webglState:L_,commonBinder:Te(sc,rc),programBinder:yy,needsVisibilityBuffer:!1,objectBinder:J(Ar,pt,uu,Ey),tileBinder:ae,cullMethod:_e(or,ai,jy),isOverlappedObject:!0}]},point:{raster:[{programName:"pointSprite",vaoCreator:qP,webglState:C_,needsVisibilityBuffer:!1,commonBinder:Hl(xe,we,Cb,ef),programBinder:EF,layerBinder:Lo,objectBinder:J(HF,B_,z_,Xl,pe,gt),cullMethod:_e(ai,Ye,H_,G_,or),tileBinder:ie(Pn,ke,ge),is3dMapAware:!0},{identify:!0,programName:"pointSpriteIdentify",vaoCreator:JP,webglState:lr,needsVisibilityBuffer:!1,programBinder:by,objectBinder:J(B_,z_,Xl,pe,gt),tileBinder:ie(Pn,ge),cullMethod:_e(ai,Ye,H_,G_,Ny),is3dMapAware:!0},{labelTest:!0,programName:"pointSpriteIdentify",vaoCreator:KP,webglState:lr,needsVisibilityBuffer:!1,programBinder:by,objectBinder:J(B_,z_,Xl,pe,gt),tileBinder:ie(Pn,ge),cullMethod:_e(ai,Ye,H_,G_,Ny),is3dMapAware:!0}],text:[{programName:"labelPoint",vaoCreator:U1,webglState:C_,needsVisibilityBuffer:!1,commonBinder:Hl(xe,we,ef),programBinder:wy,objectBinder:J(Ar,aa,ds,Py,pu,Xl,pe,gt),tileBinder:ie(Pn,ke,ge),cullMethod:_e(ai,Ye,or,ca,Gy,V_),uniformSet:"fontHalo",subRenderIndex:1,is3dMapAware:!0},{programName:"labelPoint",vaoCreator:U1,webglState:C_,needsVisibilityBuffer:!1,commonBinder:Te(xe,we,ef),programBinder:wy,objectBinder:J(Ar,aa,ds,Py,pu,Xl,pe,gt),tileBinder:ie(Pn,ke,ge),cullMethod:_e(ai,Ye,or,ca,Gy),uniformSet:"fontFill",subRenderIndex:2,is3dMapAware:!0},{identify:!0,programName:"labelPointIdentify",vaoCreator:$P,webglState:lr,needsVisibilityBuffer:!1,programBinder:ft(Xt,Qe),objectBinder:J(ds,pu,pe,gt),tileBinder:ie(Pn,ge),cullMethod:_e(ai,Ye,lk),subRenderIndex:1,is3dMapAware:!0}],labelingTexture:[{depthTest:!0,programName:"pointDepthTest",vaoCreator:QP,webglState:oy,needsVisibilityBuffer:!1,programBinder:ft(Xt,Qe),objectBinder:J(pu,pe,gt),tileBinder:ie(ae,ge),cullMethod:_e(ai,Ye),is3dMapAware:!0}]},buildingModel:{fill:[{programName:"zbmModel",vaoCreator:eL,webglState:ay,needsVisibilityBuffer:!1,commonBinder:Te(xe,we,De),programBinder:BF,layerBinder:vn(Je,Lo,xo),objectBinder:J(pt,O_,WF,pe),tileBinder:ie(ke,ae,ge),cullMethod:_e(Uy,be,uk,Cr,Wy),subRenderIndex:2,is3dMapAware:!0},{programName:"zbmModelIdentify",vaoCreator:tL,webglState:Lt,needsVisibilityBuffer:!1,programBinder:Xt,objectBinder:J(pe),tileBinder:ie(ae,ge),cullMethod:be,subRenderIndex:2,identify:!0,is3dMapAware:!0},{programName:"zbmModelIdentify",vaoCreator:nL,webglState:Lt,needsVisibilityBuffer:!1,programBinder:Xt,objectBinder:J(pe),tileBinder:ie(ae,ge),cullMethod:be,depthTest:!0,is3dMapAware:!0},{programName:"zbmShadow",vaoCreator:iL,webglState:iu,needsVisibilityBuffer:!1,programBinder:Qe,objectBinder:J(O_,pe),tileBinder:ie(ae,ge),cullMethod:be,shadow:!0,is3dMapAware:!0}],stroke:[{programName:"simpleLine",vaoCreator:g_,webglState:sa,needsVisibilityBuffer:!0,commonBinder:Te(xe,we,De),programBinder:Vl,layerBinder:vn(Xt,Je,qd),objectBinder:J(pt,Cn,O_,vu,pe,D_),tileBinder:ie(ae,ke,ge),cullMethod:_e(be,Uy,Yl,ql,Wy),subRenderIndex:5,is3dMapAware:!0}]},shiftedLine:{solid:[{programName:"road",commonBinder:Te(xe,we,De),programBinder:ft(ho,oi),vaoCreator:GP,webglState:yn,needsVisibilityBuffer:!1,layerBinder:Je,objectBinder:J(pt,Cn,My),tileBinder:ie(ke,ae),zoomBinder:So,cullMethod:_e(be,us,Cr)}]},circle:{fill:[{programName:"circleMarker",vaoCreator:v_,webglState:yn,needsVisibilityBuffer:!1,commonBinder:Te(xe,De,we),programBinder:R_,layerBinder:Je,objectBinder:J(pt,Cn),cullMethod:_e(be,us,Cr),tileBinder:ie(Pn,ke),subRenderIndex:2,is3dMapAware:!0},{programName:"circleMarker",vaoCreator:v_,webglState:yn,needsVisibilityBuffer:!1,commonBinder:Te(xe,De,we),programBinder:R_,layerBinder:Je,objectBinder:J(pt,Cn),cullMethod:_e(be,fk,ql),tileBinder:ie(Pn,ke),subRenderIndex:1,is3dMapAware:!0},{programName:"circleMarker",vaoCreator:v_,webglState:yn,needsVisibilityBuffer:!1,commonBinder:Te(xe,De,we),programBinder:R_,layerBinder:Je,objectBinder:J(pt,Cn),cullMethod:_e(be,hk,yk),tileBinder:ie(Pn,ke),is3dMapAware:!0},{identify:!0,programName:"circleMarkerIdentify",vaoCreator:rL,webglState:lr,needsVisibilityBuffer:!1,programBinder:AF,objectBinder:J(Cn),cullMethod:_e(be,_k),tileBinder:ie(Pn),is3dMapAware:!0}]},arrow:{stroke:[{programName:"entrance",vaoCreator:X1,webglState:yn,needsVisibilityBuffer:!1,commonBinder:Te(sc,rc,xe,we),programBinder:LF,objectBinder:J(pt,uu,GF,Ay,cn),tileBinder:ie(ae,ke),cullMethod:_e(be,Cr)},{identify:!0,programName:"entranceIdentify",vaoCreator:X1,webglState:lr,needsVisibilityBuffer:!1,commonBinder:Te(sc,rc),programBinder:CF,objectBinder:J(uu,Ay,cn),tileBinder:ae,cullMethod:be}]},lineExtrusion:{fill:[{programName:"gradientDiffuse",vaoCreator:XP,webglState:AL,needsVisibilityBuffer:!0,commonBinder:Te(xe,we,De),programBinder:jl,layerBinder:vn(Je,xo),objectBinder:J(hu,pt,Zl,cn,pe,yu),tileBinder:ie(ke,ae,ge),cullMethod:_e(be,Ye,j_,Hy),subRenderIndex:9,is3dMapAware:!0},{programName:"buildingShadow",shadow:!0,vaoCreator:YP,webglState:ou,needsVisibilityBuffer:!0,programBinder:Qe,objectBinder:J(hu,pe,yu),tileBinder:ie(ae,ge),cullMethod:_e(be,Ye),is3dMapAware:!0}],sideStroke:[{programName:"line",vaoCreator:W1,webglState:sa,needsVisibilityBuffer:!0,commonBinder:Te(xe,De,we),programBinder:xy,layerBinder:Je,objectBinder:J(hu,pt,Zl,cn,pe,yu),tileBinder:ie(ke,ae,ge),cullMethod:_e(be,Ye,Xy,Vy),subRenderIndex:10,is3dMapAware:!0}],topStroke:[{programName:"simpleLine",vaoCreator:g_,webglState:sa,needsVisibilityBuffer:!0,commonBinder:Te(xe,we,De),programBinder:Vl,layerBinder:vn(Je,Xt,qd),objectBinder:J(hu,pt,Cn,vu,pe,yu,D_),tileBinder:ie(ke,ae,ge),cullMethod:_e(be,Ye,Yl,ql),subRenderIndex:11,is3dMapAware:!0}]},gltfModel:{instances:[{programName:"gltfModel",vaoCreator:tu(!1),instanceBinder:wu,commonBinder:Te(xe,we,De),programBinder:FF,layerBinder:vn(Je,xo,Kd),webglState:ay,needsVisibilityBuffer:!1,objectBinder:J(pt,XF,U_,ZF,pe,fu,gt),tileBinder:ie(Pn,Mu,hR,ge,Su),cullMethod:_e($_,Mk),is3dMapAware:!0},{identify:!0,programName:"gltfModelIdentify",instanceBinder:wu,vaoCreator:tu(!1),webglState:Lt,needsVisibilityBuffer:!1,layerBinder:Kd,commonBinder:Hl(xe,we),programBinder:Qe,objectBinder:J(pe,fu,Mo,gt),tileBinder:ie(Pn,Mu,ge,Su),cullMethod:$_,is3dMapAware:!0},{depthTest:!0,programName:"gltfModelIdentify",instanceBinder:wu,vaoCreator:tu(!0),webglState:Lt,needsVisibilityBuffer:!1,commonBinder:Hl(xe,we),programBinder:Qe,layerBinder:Kd,objectBinder:J(pe,fu,gt),tileBinder:ie(Pn,Mu,ge,Su),cullMethod:$_,is3dMapAware:!0},{shadow:!0,programName:"gltfModelShadow",instanceBinder:wu,vaoCreator:tu(!1),webglState:iu,needsVisibilityBuffer:!1,programBinder:Qe,layerBinder:Kd,objectBinder:J(pe,fu),tileBinder:ie(Pn,Mu,ge,Su),cullMethod:Sk,is3dMapAware:!0}]},raster:{fill:[{programName:"rectWithTexture",vaoCreator:sL,webglState:yn,needsVisibilityBuffer:!1,commonBinder:Hl(xe,we),layerBinder:Lo,objectBinder:J(Ty,VF),tileBinder:ie(ae,ke),cullMethod:_e(zy,be)}]},heatmap:{framebuffer:[{programName:"heatmap",vaoCreator:aL,webglState:FL,needsVisibilityBuffer:!1,commonBinder:CP,objectBinder:J(YF,qF),zoomBinder:So,tileBinder:ie(ae,ke),cullMethod:_e(be,mk)}],fill:[{programName:"heatmapTexture",vaoCreator:lL,webglState:yn,needsVisibilityBuffer:!1,layerBinder:Lo,objectBinder:J(Ty,$F,jF),tileBinder:ke,cullMethod:_e(be,zy,ik),subRenderIndex:1}]},dem:{mesh:[{programName:"demMesh",vaoCreator:Ia,commonBinder:Te(xe,we,De),programBinder:ji,layerBinder:Je,webglState:Lt,needsVisibilityBuffer:!1,objectBinder:J(pe,Fy,Ry),tileBinder:ie(ae,ke,xu,ge),cullMethod:_e(By,Oy),is3dMapAware:!0},{identify:!0,programName:"demMesh",vaoCreator:Ia,programBinder:ft(Qe,gy),webglState:Lt,needsVisibilityBuffer:!1,objectBinder:J(ky,pe),tileBinder:ie(ae,xu,ge),cullMethod:Dy,is3dMapAware:!0}],ground:[{programName:"demGround",vaoCreator:Ia,programBinder:Qe,tileBinder:ie(ae,ke,ge),webglState:Lt,needsVisibilityBuffer:!1,objectBinder:J(pe)}],elevation:[{programName:"demElevation",vaoCreator:y_,webglState:PL,needsVisibilityBuffer:!1,tileBinder:ae,objectBinder:J()}],mesh2:[{programName:"demMesh2",vaoCreator:y_,commonBinder:Te(xe,we,De),programBinder:ji,layerBinder:Je,webglState:Lt,needsVisibilityBuffer:!1,objectBinder:J(Fy,Ry,pe,JF),tileBinder:ie(ae,ke,xu,ge),cullMethod:_e(By,Oy)},{identify:!0,programName:"demMesh2",vaoCreator:y_,programBinder:ft(Qe,gy),webglState:Lt,needsVisibilityBuffer:!1,objectBinder:J(ky,pe),tileBinder:ie(ae,xu,ge),cullMethod:Dy}],ground2:[{programName:"demGround2",vaoCreator:Ia,programBinder:Qe,tileBinder:ie(ae,ke,ge),webglState:Lt,needsVisibilityBuffer:!1,objectBinder:J(pe)}],hillshade:[{programName:"demHillshade",vaoCreator:Mp,webglState:lr,needsVisibilityBuffer:!1,programBinder:Qe,objectBinder:J(pe),tileBinder:ie(ae,ge)}],flatBottom:[{programName:"demFlatBottom",vaoCreator:cL,webglState:Ub,needsVisibilityBuffer:!1,objectBinder:J(QF,pe),tileBinder:ie(ae,ge),cullMethod:ok}]},mapMesh:{fill:[{programName:"mapMesh",vaoCreator:b_,webglState:ry,zoomBinder:J(N_),commonBinder:Te(xe,we,De),programBinder:ji,layerBinder:vn(Je,xo),objectBinder:J(U_,si,pe,$i,Mo),tileBinder:ie(ke,ae,ge),cullMethod:Lp,subRenderIndex:Number.MAX_SAFE_INTEGER,is3dMapAware:!0},{identify:!0,programName:"mapMesh",vaoCreator:b_,webglState:Lt,zoomBinder:J(N_),commonBinder:Te(xe,we,De),programBinder:ji,layerBinder:vn(Je,xo),objectBinder:J(U_,si,pe,$i,Mo),tileBinder:ie(ae,ge),cullMethod:Lp,subRenderIndex:Number.MAX_SAFE_INTEGER,is3dMapAware:!0},{depthTest:!0,programName:"mapMesh",vaoCreator:b_,webglState:Lt,zoomBinder:J(N_),commonBinder:Te(xe,we,De),programBinder:ji,layerBinder:vn(Je,xo),objectBinder:J(si,pe,$i,Mo),tileBinder:ie(ae,ge),subRenderIndex:Number.MAX_SAFE_INTEGER,is3dMapAware:!0},{programName:"meshShadow",shadow:!0,vaoCreator:H1,webglState:ou,needsVisibilityBuffer:!1,programBinder:Qe,objectBinder:J(si,pe,$i),tileBinder:ie(ae,ge),is3dMapAware:!0}]},globe:{fill:[{programName:"globe",vaoCreator:q1,webglState:Lt,objectBinder:J(Cy),tileBinder:Pn,needsVisibilityBuffer:!1,is3dMapAware:!0},{identify:!0,programName:"globe",vaoCreator:q1,webglState:Lt,objectBinder:J(Cy),tileBinder:Pn,needsVisibilityBuffer:!1,is3dMapAware:!0}]}}}class pR{constructor(e){this.gl=e,this.ext=e.getExtension("EXT_disjoint_timer_query"),this.queries=[]}addTimer(){if(!this.ext)return;const e=this.ext.createQueryEXT();this.queries.push(e),this.ext.beginQueryEXT(this.ext.TIME_ELAPSED_EXT,e)}stopTimer(){!this.ext||!this.queries.length||this.ext.endQueryEXT(this.ext.TIME_ELAPSED_EXT)}tryToGetFirstTimerValue(){if(!this.ext)return;const e=this.queries[0];if(!e)return;const n=this.ext,i=n.getQueryObjectEXT(e,n.QUERY_RESULT_AVAILABLE_EXT),o=this.gl.getParameter(n.GPU_DISJOINT_EXT);if(!i||o)return;const r=n.getQueryObjectEXT(e,n.QUERY_RESULT_EXT);return n.deleteQueryEXT(e),this.queries.shift(),Number(r)}}const gR=`
float affine_step(const float edge0, const float edge1, const float x)
{
    return clamp((x - edge0) / (edge1 - edge0), 0., 1.);
}
`,sw=`
vec4 apply_opacity(const vec4 color, const float opacity)
{
return color * opacity;
}
`,vR=`struct ArrowDistanceParameters
{
    vec2 wing_normal;
    vec2 tip_normal;
    vec2 mirrored_wing_normal;
    vec2 mirrored_tip_normal;
    float width;
    float full_length;
    float arrow_height;
    float tip_radius;
    vec2 tip_circle_center;
    float wing_radius;
    vec2 wing_circle_center;
    float border_width;
};
ArrowDistanceParameters calculate_arrow_distance_parameters(
    const vec2 wing_normal,
    const vec2 tip_normal,
    const float width_zpt,
    const float length_zpt,
    const float tip_height_multiplier,
    const float wing_height_multiplier,
    const float tip_radius_zpt,
    const float wing_radius_zpt,
    const float border_width_zpt,
    const vec2 tip_circle_center,
    const vec2 wing_circle_center)
{
    vec2 mirrored_wing_normal = vec2(wing_normal.x, -wing_normal.y);
    vec2 mirrored_tip_normal = vec2(tip_normal.x, -tip_normal.y);
    float width = 0.5 * width_zpt;
    float length = 0.5 * length_zpt;
    float arrow_height = width_zpt * (tip_height_multiplier - wing_height_multiplier);
    return ArrowDistanceParameters(
        wing_normal,
        tip_normal,
        mirrored_wing_normal,
        mirrored_tip_normal,
        width,
        length,
        arrow_height,
        tip_radius_zpt,
        tip_circle_center,
        wing_radius_zpt,
        wing_circle_center,
        border_width_zpt);
}
struct ArrowDistances
{
    float top_tip_cut;
    float bottom_tip_cut;
    float line;
    float bottom_left_wing;
    float bottom_right_wing;
    float top_left_wing;
    float top_right_wing;
    float tip_circle;
    float tip_circle_cut;
    float left_wing_circle;
    float left_wing_circle_cut;
    float right_wing_circle;
    float right_wing_circle_cut;
};
ArrowDistances calculate_arrow_distances(
    const ArrowDistanceParameters arrow_parameters,
    const vec2 texcoord,
    const float offset,
    const mat2 derivatives)
{
    float derivatives_x_multiplier = 1. / max(abs(derivatives[0].x), abs(derivatives[1].x));
    float dt = ( texcoord.x - arrow_parameters.full_length - offset) * derivatives_x_multiplier;
    float d0 = (-texcoord.x - arrow_parameters.full_length - offset) * derivatives_x_multiplier;
    float d1 = (abs(texcoord.y) - arrow_parameters.width - offset) / max(abs(derivatives[0].y), abs(derivatives[1].y));
    float d2 = (dot(texcoord - vec2(arrow_parameters.full_length - arrow_parameters.arrow_height, 0.), arrow_parameters.wing_normal) - offset) / max(abs(dot(derivatives[0], arrow_parameters.wing_normal)), abs(dot(derivatives[1], arrow_parameters.wing_normal)));
    float d3 = (dot(texcoord - vec2(arrow_parameters.full_length - arrow_parameters.arrow_height, 0.), arrow_parameters.mirrored_wing_normal) - offset) / max(abs(dot(derivatives[0], arrow_parameters.mirrored_wing_normal)), abs(dot(derivatives[1], arrow_parameters.mirrored_wing_normal)));
    float d4 = (dot(texcoord - vec2(arrow_parameters.full_length, 0.), arrow_parameters.tip_normal) - offset) / max(abs(dot(derivatives[0], arrow_parameters.tip_normal)), abs(dot(derivatives[1], arrow_parameters.tip_normal)));
    float d5 = (dot(texcoord - vec2(arrow_parameters.full_length, 0.), arrow_parameters.mirrored_tip_normal) - offset) / max(abs(dot(derivatives[0], arrow_parameters.mirrored_tip_normal)), abs(dot(derivatives[1], arrow_parameters.mirrored_tip_normal)));
    
    float tip_circle_cut = sdf_half_planes_cut(
        texcoord,
        arrow_parameters.tip_normal,
        -arrow_parameters.mirrored_tip_normal,
        arrow_parameters.tip_circle_center,
        derivatives);
    float tip_circle = sdf_circle(
        texcoord - arrow_parameters.tip_circle_center,
        arrow_parameters.tip_radius + offset - arrow_parameters.border_width);
    vec2 tip_circle_normal = normalize(texcoord - arrow_parameters.tip_circle_center);
    tip_circle = tip_circle / max(abs(dot(derivatives[0], tip_circle_normal)), abs(dot(derivatives[1], tip_circle_normal)));
    
    vec2 right_wing_circle_center = vec2(arrow_parameters.wing_circle_center.x, -arrow_parameters.wing_circle_center.y);
    vec2 left_wing_circle_normal = normalize(texcoord - arrow_parameters.wing_circle_center);
    vec2 right_wing_circle_normal = normalize(texcoord - right_wing_circle_center);
    float left_wing_circle = sdf_circle(texcoord - arrow_parameters.wing_circle_center,
        arrow_parameters.wing_radius + offset - arrow_parameters.border_width);
        left_wing_circle = left_wing_circle / max(abs(dot(derivatives[0], left_wing_circle_normal)), abs(dot(derivatives[1], left_wing_circle_normal)));
    float right_wing_circle = sdf_circle(texcoord - right_wing_circle_center,
        arrow_parameters.wing_radius + offset - arrow_parameters.border_width);
        right_wing_circle = right_wing_circle / max(abs(dot(derivatives[0], right_wing_circle_normal)), abs(dot(derivatives[1], right_wing_circle_normal)));
    float left_wing_circle_cut = sdf_half_planes_cut(
        texcoord,
        -arrow_parameters.tip_normal,
        arrow_parameters.wing_normal,
        arrow_parameters.wing_circle_center,
        derivatives);
    float right_wing_circle_cut = sdf_half_planes_cut(
        texcoord,
        arrow_parameters.mirrored_tip_normal,
        -arrow_parameters.mirrored_wing_normal,
        right_wing_circle_center,
        derivatives);
    return ArrowDistances(
        dt,
        d0,
        d1,
        d2,
        d3,
        d4,
        d5,
        tip_circle,
        tip_circle_cut,
        left_wing_circle,
        left_wing_circle_cut,
        right_wing_circle,
        right_wing_circle_cut);
}
`,yR=`
#ifdef WEBGL2
#define UNPACK_BOOL1(packedValue) ((packedValue & 0x1) != 0)
#define UNPACK_BOOL2(packedValue) ((packedValue & 0x2) != 0)
#define UNPACK_BOOL3(packedValue) ((packedValue & 0x4) != 0)
#else
#define UNPACK_BOOL1(packedValue) (int(mod(float(packedValue), 2.0)) == 1)
#define UNPACK_BOOL2(packedValue) (int(mod(float(packedValue) / 2.0, 2.0)) == 1)
#define UNPACK_BOOL3(packedValue) (int(mod(float(packedValue) / 4.0, 2.0)) == 1)
#endif
`,aw=`#ifndef UBO
uniform highp vec3 u_cam_pos;
#endif
`,bR=`
const float g_distance_precision_limit = 1e-4;
struct CircleDistance
{
    float distance;
    float width;
};
CircleDistance circle_color_distance(
    const mat2 derivatives,
    const vec2 circle,
    const float circle_width)
{
    float circle_length = length(circle);
    float distance = circle_length - circle_width;
    
    
    
    vec2 circle_dx = derivatives[0];
    vec2 circle_dy = derivatives[1];
    
    float distance_dx = dot(circle, circle_dx);
    float distance_dy = dot(circle, circle_dy);
    
    float derivative_denominator = circle_length;
    float width = max(abs(distance_dx), abs(distance_dy));
    return CircleDistance(
        distance * derivative_denominator,
        width);
}
vec4 distance_to_color(
    const float fill_distance,
    const float border_distance,
    const vec4 fill_color,
    const vec4 border_color)
{
    float fill_factor = affine_step(-1., 0., fill_distance);
    float border_factor = affine_step(0., 1., border_distance);
    return
        mix(mix(fill_color, border_color, fill_factor), vec4(.0), border_factor);
}
vec4 distance_to_color(
    const CircleDistance circle_distance,
    const vec4 fill_color)
{
    
    
    float fill_factor = circle_distance.distance < g_distance_precision_limit
        ? 0.
        : affine_step(0., circle_distance.width, circle_distance.distance);
    return mix(fill_color, vec4(0.), fill_factor);
}
`,wR=`#ifdef WEBGL1
#extension GL_OES_standard_derivatives: enable
#endif
`,xR=`
#define LINEAR 0
#define EXP 1
#define FOG_EQUATION (LINEAR)
#define EPSILON (0.0001)
#ifndef UBO
# ifdef FOG
uniform vec4 u_fog_color;
uniform vec2 u_fog_limits;
uniform float u_fog_horizon_blend;
uniform float u_fog_horizon_level;
# endif
#endif 
#if defined(FOG) || defined(SKY)
# ifndef UBO
uniform vec4 u_sky_color;
# endif
varying vec3 v_fog_pos;
#endif
#ifdef FOG
float fog_horizon_blending(vec3 camera_dir, float blend) {
    blend = EPSILON + blend;
    float t = max(camera_dir.z / blend, 0.0);
    
    return exp(-3.0 * t * t);
}
float fog_exponential(float t) {
    const float decay = 6.0;
    float falloff = 1.0 - min(1.0, exp(-decay * t));
    
    falloff *= falloff * falloff;
    
    return min(1.0, 1.00747 * falloff);
}
float fog_depth(float depth) {
    float start = u_fog_limits.x;
    float end = u_fog_limits.y;
    float range = end - start;
    float fac = (depth - start) / range;
#if (FOG_EQUATION == LINEAR)
    
    fac = clamp(fac, 0.0, 1.0);
#elif (FOG_EQUATION == EXP)
    fac = fog_exponential(fac);
#endif
    return fac;
}
float calc_depth_fog() {
    float depth = length(v_fog_pos);
    float fac = fog_depth(depth);
    return fac;
}
vec3 calc_fog_color() {
    float depth = length(v_fog_pos);
    vec3 dir = v_fog_pos / depth;
    
    dir.z -= u_fog_horizon_level;
    float fog_blend = fog_horizon_blending(dir, u_fog_horizon_blend);
    if (u_sky_color.a <= 0.01) {
        return u_fog_color.rgb / u_fog_color.a;
    } else {
        
        return mix(u_sky_color.rgb / u_sky_color.a, u_fog_color.rgb / u_fog_color.a, min(fog_blend + (1.0 - u_sky_color.a), 1.0));
    }
}
#endif 
vec4 apply_fog(vec4 color) {
#ifdef FOG
    if (u_fog_color.a <= 0.01) {
        return color;
    }
    float alpha = EPSILON + color.a;
    float fac = calc_depth_fog();
    vec3 fog_color = calc_fog_color();
    color.rgb /= alpha;
    color.rgb = mix(color.rgb, fog_color, fac * u_fog_color.a);
    color.rgb *= alpha;
#endif
    return color;
}
vec4 apply_fog_alpha(vec4 color) {
#ifdef FOG
    if (u_fog_color.a <= 0.01) {
        return color;
    }
    color *= 1.0 - calc_depth_fog();
#endif
    return color;
}
vec4 apply_fog_sky(vec4 color) {
#ifdef FOG
    float alpha = EPSILON + color.a;
    float depth = length(v_fog_pos);
    vec3 dir = v_fog_pos / depth;
    
    dir.z -= u_fog_horizon_level;
    float fac = fog_horizon_blending(dir, u_fog_horizon_blend);
    color.rgb /= alpha;
    color.rgb = mix(color.rgb, u_fog_color.rgb, fac * u_fog_color.a);
    color.rgb *= alpha;
#endif
    return color;
}`,SR=`#define FRAGMENT_NORMAL
vec3 calc_fragment_normal(vec3 vertex) {
    vec3 dx = dFdx(vertex);
    vec3 dy = dFdy(vertex);
    return normalize(cross(dx, dy));
}`,MR=`precision highp float;
`,TR=`#ifdef UBO
uniform LightSettings
{
    vec3 u_vec3_light_dir1_direction;
    vec4 u_vec4_light_dir1_color;
    vec3 u_vec3_light_dir2_direction;
    vec4 u_vec4_light_dir2_color;
    vec4 u_vec4_ambient_color;
};
#else
uniform vec3 u_vec3_light_dir1_direction;
uniform vec4 u_vec4_light_dir1_color;
uniform vec3 u_vec3_light_dir2_direction;
uniform vec4 u_vec4_light_dir2_color;
uniform vec4 u_vec4_ambient_color;
#endif
uniform int u_int_light_flags;
vec4 light_factor(vec3 normal) {
    bool use_light = UNPACK_BOOL1(u_int_light_flags);
    if (!use_light) { 
        return vec4(1.);
    }
    float light_1_factor = max(dot(normal, -u_vec3_light_dir1_direction), 0.0);
    float light_2_factor = max(dot(normal, -u_vec3_light_dir2_direction), 0.0);
    if (UNPACK_BOOL2(u_int_light_flags)) {
        light_1_factor *= compute_shadow_factor();
    } else if (UNPACK_BOOL3(u_int_light_flags)) {
        light_2_factor *= compute_shadow_factor();
    }
    vec3 direct_light_contrib = u_vec4_light_dir1_color[3] * light_1_factor * u_vec4_light_dir1_color.rgb;
    vec3 shading_light_contrib = u_vec4_light_dir2_color[3] * light_2_factor * u_vec4_light_dir2_color.rgb;
    return vec4(u_vec4_ambient_color[3] * u_vec4_ambient_color.rgb + direct_light_contrib + shading_light_contrib, 1.0);
}
float light_factor_dem(vec3 normal) {
    bool use_light = UNPACK_BOOL1(u_int_light_flags);
    if (!use_light) { 
        return 1.;
    }
    float light_1_factor = dot(normal, -u_vec3_light_dir1_direction);
    
    
    
    
    return light_1_factor;
}
vec4 light_factor(vec3 normal, vec3 pos_world) {
    
    if (dot(u_cam_pos - pos_world, normal) < 0.) {
        normal *= vec3(-1.);
    }
    return light_factor(normal);
}
vec4 light_factor_surface() {
    bool use_light = UNPACK_BOOL1(u_int_light_flags);
    if (!use_light) {
        return vec4(1.);
    }
    vec3 normal = vec3(0., 0., 1.);
    float light_1_factor = max(dot(normal, -u_vec3_light_dir1_direction), 0.0);
    float light_2_factor = max(dot(normal, -u_vec3_light_dir2_direction), 0.0);
    if (UNPACK_BOOL2(u_int_light_flags)) {
        light_1_factor *= compute_shadow_factor();
    } else if (UNPACK_BOOL3(u_int_light_flags)) {
        light_2_factor *= compute_shadow_factor();
    }
     return vec4(u_vec4_ambient_color[3] * u_vec4_ambient_color.rgb
         + u_vec4_light_dir1_color[3] * light_1_factor * u_vec4_light_dir1_color.rgb
         + u_vec4_light_dir2_color[3] * light_2_factor * u_vec4_light_dir2_color.rgb, 1.0);
}
`,IR=`
#define LIGHT_MODEL_PBR 2
#ifdef LIGHT_MODEL
#if LIGHT_MODEL == LIGHT_MODEL_PBR
    const float PI = 3.14159265359;
    
    float D(float alpha, vec3 N, vec3 H) {
        float numerator = alpha * alpha;
        float NdotH = max(dot(N, H), 0.);
        float denominator = PI * pow(
            NdotH * NdotH * (alpha * alpha - 1.) + 1.,
            2.
        );
        return numerator / max(denominator, 0.000001);
    }
    
    float G1(float alpha, vec3 N, vec3 X) {
        float numerator = max(dot(N, X), 0.);
        float k = alpha / 2.;
        float denominator = max(dot(N, X), 0.) * (1. - k) + k;
        return numerator / max(denominator, 0.000001);
    }
    
    float G(float alpha, vec3 N, vec3 V, vec3 L) {
        return G1(alpha, N, V) * G1(alpha, N, L);
    }
    
    vec3 F(vec3 F0, vec3 V, vec3 H) {
        return F0 + (vec3(1.) - F0) * pow(1. - max(dot(V, H), 0.), 5.);
    }
    vec3 color_pbr(vec3 fragment_normal, vec3 fragment_pos_world, vec3 albedo, float roughness, float metallic) {
        float alpha = roughness * roughness;
        vec3 F0 = vec3(0.04);
        F0 = mix(F0, vec3(1.), metallic);
        
        vec3 emitted_light = u_vec4_ambient_color.rgb * u_vec4_ambient_color[3];
        vec3 N = fragment_normal;
        
        vec3 V = normalize(u_cam_pos - fragment_pos_world);
        
        vec3 L = -u_vec3_light_dir1_direction;
        
        vec3 H = normalize(V + L);
        float shadow_factor = compute_shadow_factor();
        vec3 Ks = F(F0, V, H);
        vec3 Kd = (vec3(1.0) - Ks) * (1. - metallic);
        vec3 lambert = albedo / PI;
        vec3 cookTorranceNumerator = D(alpha, N, H) * G(alpha, N, V, L) * Ks;
        float cookTorranceDenominator = 4.0 * max(dot(V, N), 0.) * max(dot(L, N), 0.);
        cookTorranceDenominator = max(cookTorranceDenominator, 0.000001);
        vec3 cookTorrance = cookTorranceNumerator / cookTorranceDenominator;
        vec3 BRDF = Kd * lambert + cookTorrance;
        vec3 outgoingLight = BRDF * u_vec4_light_dir1_color.rgb * u_vec4_light_dir1_color[3] * max(dot(L, N), 0.);
        vec3 ambient = u_vec4_ambient_color.rgb * u_vec4_ambient_color[3] * albedo;
        return ambient + outgoingLight * shadow_factor;
    }
#endif
#endif
`,ER=`#define LIGHT_MODEL_PHONG 1
#ifdef LIGHT_MODEL
#if LIGHT_MODEL == LIGHT_MODEL_PHONG
const float g_specular_power_max = 32.0;
const float g_specular_power_min = 2.0;
vec2 pbr_to_gloss(vec3 material_attributes)
{
    float weight = material_attributes.x;
    float roughness = material_attributes.y;
    float metallic = material_attributes.z;
    
    
    float specular_strength = weight * metallic;
    float specular_power = roughness * (g_specular_power_min - g_specular_power_max) + g_specular_power_max;
    return vec2(specular_strength, specular_power);
}
vec3 color_phong(vec3 fragment_normal, vec3 fragment_pos_world, vec3 albedo, float roughness, float metallic) {
    vec2 specular_values = pbr_to_gloss(vec3(1., roughness, metallic));
    float specular_strength = specular_values.x;
    float specular_power = specular_values.y;
    
    float shadow_factor = compute_shadow_factor();
    
    vec3 ambient = u_vec4_ambient_color.rgb * u_vec4_ambient_color[3];
    
    float diff = max(dot(fragment_normal, -u_vec3_light_dir1_direction), 0.0);
    vec3 diffuse = u_vec4_light_dir1_color.rgb * u_vec4_light_dir1_color[3] * diff * shadow_factor;
    
    
    vec3 view_dir = normalize(u_cam_pos - fragment_pos_world);
    
    vec3 reflect_dir = reflect(u_vec3_light_dir1_direction, fragment_normal);
    float spec = pow(max(dot(view_dir, reflect_dir), 0.0), specular_power);
    vec3 specular = u_vec4_light_dir1_color.rgb * u_vec4_light_dir1_color[3] * spec * specular_strength;
    return albedo * (ambient + diffuse) + specular;
}
#endif
#endif
`,AR=`precision lowp float;
`,CR=`precision mediump float;
`,PR=`vec4 pack_float_to_vec4(float depth)
{
    const vec4 bit_shift = vec4(255.0 * 255.0 * 255.0, 255.0 * 255.0, 255.0, 1.0);
    const vec4 bit_mask = vec4(0.0, 1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0);
    vec4 res = fract(depth * bit_shift);
    res -= res.xxyz * bit_mask;
    return res;
}
float unpack_float_from_vec4(vec4 color)
{
    const vec4 bit_shift = vec4(1.0 / (255.0 * 255.0 * 255.0), 1.0 / (255.0 * 255.0), 1.0 / 255.0, 1.0);
    return dot(color, bit_shift);
}`,LR=`#ifdef WEBGL2
#define varying in
#define attribute in
#define texture2D texture
#define gl_FragColor fragColor
out vec4 gl_FragColor;
#endif
#ifdef UBO
uniform CommonSettings
{
    mediump float u_float_rounding_factor;
    mediump float u_float_border_width_offset;
    mediump vec2 u_vec2_scale_limits;
    mediump vec2 u_vec2_depth_test_half_point_size;
    
    mediump vec4 u_fog_color;
    mediump vec2 u_fog_limits;
    mediump float u_fog_horizon_blend;
    mediump float u_fog_horizon_level;
    mediump float u_fog_distance;
    mediump vec4 u_sky_color;
    highp vec3 u_cam_pos; 
    
    
    
    
    
    
    mediump vec4 u_shadow_map_params; 
    highp mat4 u_mat4_clip_to_shadow;
    mediump float u_shadow_bias;
    mediump mat4 u_mat4_view_transposed;
    mediump mat4 u_mat4_proj_inverted;
    
    mediump vec2 u_vec2_halo_viewport_size;
    mediump vec2 u_vec2_halo_viewport_center_shift;
    mediump vec4 u_vec4_halo_radius_stops;
    mediump vec4 u_vec4_halo_color;
    mediump float u_float_halo_exp_factor;
    mediump vec4 u_vec4_default_background_color;
    
    mediump mat4 u_mat4_stars;
    mediump float u_float_pixelratio;
    mediump float u_float_stars_intensity;
};
#endif
`,FR=`#ifdef WEBGL1
#extension GL_EXT_frag_depth : require
#endif`,kR=`uniform float u_sdtr_distance;
#ifdef SCREENDOOR
varying vec3 v_clipspace_pos;
#endif
float interleaved_gradient_noise()
{
    const vec3 m = vec3(0.06711056, 0.00583715, 52.9829189);
    return fract(m.z * fract(dot(gl_FragCoord.xy, m.xy)));
}
void apply_screendoor() {
    #ifdef SCREENDOOR
    if (u_sdtr_distance == 0.) {
        return;
    }
    float factor = smoothstep(0., u_sdtr_distance, v_clipspace_pos.z);
    float patternValue = interleaved_gradient_noise();
    float shaped = factor - patternValue;
    if (shaped <= 0.) {
        discard;
    }
    #endif
    return;
}
`,RR=`#ifdef RENDER_SHADOWS
# if defined(WEBGL2) && defined(DEPTH_TEXTURE_SHADOW)
uniform mediump sampler2DShadow u_texture_shadow;
# else
uniform sampler2D u_texture_shadow;
# endif
# ifndef UBO
uniform mediump vec4 u_shadow_map_params;
# endif 
varying float v_depth_metric;
varying vec4 v_pos_from_light;
float get_shadow(vec3 coords) {
# if defined(WEBGL2) && defined(DEPTH_TEXTURE_SHADOW)
    
    return texture2D( u_texture_shadow, coords );
# else
# ifdef DEPTH_TEXTURE_SHADOW
    
    float shadow_depth = texture2D(u_texture_shadow, coords.xy, 0.).r;
# else
    
    
    float shadow_depth = unpack_float_from_vec4(texture2D(u_texture_shadow, coords.xy, 0.));
# endif
    float depth_diff = v_depth_metric - shadow_depth;
    if (depth_diff <= 0.) {
        return 1.0;
    }
    return 0.0;
# endif
}
float sample_shadow_texture(vec3 shadow_coord) {
    vec2 shadow_map_size = u_shadow_map_params.xy;
    float radius = u_shadow_map_params.z;
    vec2 texelSize = vec2( 1.0 ) / shadow_map_size;
    float dx0 = - texelSize.x * radius;
    float dy0 = - texelSize.y * radius;
    float dx1 = + texelSize.x * radius;
    float dy1 = + texelSize.y * radius;
    float dx2 = dx0 / 2.0;
    float dy2 = dy0 / 2.0;
    float dx3 = dx1 / 2.0;
    float dy3 = dy1 / 2.0;
    
    
    return (
        get_shadow( shadow_coord + vec3( dx0, dy0, 0.0 ) ) +
        get_shadow( shadow_coord + vec3( 0.0, dy0, 0.0 ) ) +
        get_shadow( shadow_coord + vec3( dx1, dy0, 0.0 ) ) +
        get_shadow( shadow_coord + vec3( dx2, dy2, 0.0 ) ) +
        get_shadow( shadow_coord + vec3( 0.0, dy2, 0.0 ) ) +
        get_shadow( shadow_coord + vec3( dx3, dy2, 0.0 ) ) +
        get_shadow( shadow_coord + vec3( dx0, 0.0, 0.0 ) ) +
        get_shadow( shadow_coord + vec3( dx2, 0.0, 0.0 ) ) +
        get_shadow( shadow_coord) +
        get_shadow( shadow_coord + vec3( dx3, 0.0, 0.0 ) ) +
        get_shadow( shadow_coord + vec3( dx1, 0.0, 0.0 ) ) +
        get_shadow( shadow_coord + vec3( dx2, dy3, 0.0 ) ) +
        get_shadow( shadow_coord + vec3( 0.0, dy3, 0.0 ) ) +
        get_shadow( shadow_coord + vec3( dx3, dy3, 0.0 ) ) +
        get_shadow( shadow_coord + vec3( dx0, dy1, 0.0 ) ) +
        get_shadow( shadow_coord + vec3( 0.0, dy1, 0.0 ) ) +
        get_shadow( shadow_coord + vec3( dx1, dy1, 0.0 ) )
    ) * ( 1.0 / 17.0 );
}
float compute_shadow_factor()
{
    vec4 light_pos = v_pos_from_light;
# ifdef FRAGMENT_NORMAL
    
    
    float normal_bias = u_shadow_map_params[3];
    vec3 norm_from_light = calc_fragment_normal(light_pos.xyz);
    light_pos.xyz -= normal_bias * norm_from_light;
# endif
    vec3 clip_space = light_pos.xyz / light_pos.w;
    
    float clip_factor = smoothstep(0.5, 1.0, length(clip_space));
    if (clip_factor >= 1.0) {
        return 1.0;
    }
# if defined(DEPTH_TEXTURE_SHADOW) && defined(WEBGL2)
    vec3 lightPovPositionInTexture = 0.5 * light_pos.xyz + 0.5;
    float shadow_factor = sample_shadow_texture(lightPovPositionInTexture);
# else
    vec3 uv = 0.5 * clip_space + vec3(0.5);
    float shadow_factor = sample_shadow_texture(uv);
# endif
    
    shadow_factor = mix(shadow_factor, 1.0, clip_factor);
    return shadow_factor;
}
#else  
float compute_shadow_factor()
{
    return 1.0;
}
#endif `,lw=`#ifndef SIGNED_DISTANCE_FUNCTIONS_FSH
#define SIGNED_DISTANCE_FUNCTIONS_FSH
float sdf_intersect(const float distance1, const float distance2)
{
    return max(distance1, distance2);
}
float sdf_merge(const float distance1, const float distance2)
{
    return min(distance1, distance2);
}
float sdf_difference(const float distance1, const float distance2)
{
    return max(distance1, -distance2);
}
float sdf_half_plane(const vec2 coords, const vec2 normal)
{
    return dot(coords, normal);
}
float sdf_circle(const vec2 coords, const float radius)
{
    return length(coords) - radius;
}
float sdf_half_planes_cut(const vec2 coords, const vec2 normal1, const vec2 normal2, const vec2 cut_point, const mat2 derivatives)
{
    vec2 cut_normal1 = vec2(normal1.y, -normal1.x);
    float cut1 = sdf_half_plane(coords - cut_point, cut_normal1) /
        max(abs(dot(derivatives[0], cut_normal1)), abs(dot(derivatives[1], cut_normal1)));
    vec2 cut_normal2 = vec2(normal2.y, -normal2.x);
    float cut2 = sdf_half_plane(coords - cut_point, cut_normal2) /
        max(abs(dot(derivatives[0], cut_normal2)), abs(dot(derivatives[1], cut_normal2)));
    return sdf_merge(cut1, cut2);
}
float sdf_box( in vec2 p, in vec2 b )
{
    vec2 d = abs(p)-b;
    return length(max(d,0.0)) + min(max(d.x,d.y),0.0);
}
float sdf_triangle(in vec2 p, in float width) {
    return abs(p.x) - (p.y + .5) * width * .5;
}
float dot2(in vec2 p) {
    return dot(p, p);
}
float sdf_chevron(in vec2 p, float width, float skew, float rounding)
{
    p.x = abs(p.x);
    if (p.y + p.x > 1.0) {
        return sqrt(dot2(p - vec2(0.25, 0.75))) - sqrt(2.0)/4.0;
    }
    return sqrt(min(dot2(p - vec2(0.00, 1.00)),
                    dot2(p - 0.5 * max(p.x + p.y, 0.0)))) * sign(p.x - p.y);
}
#endif
`,zR=`#ifdef TAA
uniform float u_float_mix_coef;
vec4 taa(sampler2D tex, vec2 texcoord) {
    vec4 texColor = texture2D(tex, texcoord);
    return vec4(texColor.rgb, texColor.a * u_float_mix_coef);
}
#endif`,BR=`#include <mediump_float>
#include <prelude>
#include <taa>
uniform sampler2D u_texture;
varying vec2 v_vec2_texcoord;
void main()
{
#ifdef TAA
    vec4 color = taa(u_texture, v_vec2_texcoord);
#else 
    vec4 color = texture2D(u_texture, v_vec2_texcoord);
#endif
    gl_FragColor = color;
}
`,OR=`#include <enable_standard_derivatives>
#include <highp_float>
#include <prelude>
#include <affine_step>
#include <signed_distance_functions>
#include <arrow_functions>
#include <circle_functions>
#include <fog>
uniform float u_float_tip_height_multiplier;
uniform float u_float_wing_height_multiplier;
uniform float u_float_wing_width_multiplier;
varying vec2 v_vec2_line_type_arrow_tail;
varying vec4 v_vec4_arrow_width_length_border_outer;
varying vec4 v_vec4_texcoord_arrow_line;
varying vec4 v_vec4_distance_vertex_hiding;
#ifdef ENTRANCE_ARROWS_ROUNDING
varying vec3 v_vec3_radius_tip_wing_tail;
#endif
varying vec4 v_vec4_circle_center_tip_wing;
varying vec4 v_vec4_color;
varying vec4 v_vec4_border_color;
const float g_type_arrow = 1.;
const float g_type_start_border = 2.;
bool lookalike(const float a, const float b)
{
    return abs(a - b) < 1e-4;
}
float filter_border(const float start, const float value)
{
    return step(start, value) * 2. - 1.;
}
float arrow_distance(
    const ArrowDistanceParameters arrow_parameters,
    const vec2 texcoord,
    const float offset,
    const mat2 derivatives,
    const float line_distance,
    const float line_distance_no_offset,
    
    
    const float border_width,
    const vec2 wing_normal)
{
    ArrowDistances ad = calculate_arrow_distances(arrow_parameters, texcoord, offset, derivatives);
    float derivatives_x_multiplier = 1. / max(abs(derivatives[0].x), abs(derivatives[1].x));
    
    
    float intersection_point = arrow_parameters.full_length - arrow_parameters.arrow_height
        - arrow_parameters.width * wing_normal.y / wing_normal.x;
    float tail_arrow_intersection = filter_border(-1., (texcoord.x - intersection_point) * derivatives_x_multiplier);
    
    float top_wings;
    float bottom_wings;
    #ifdef ENTRANCE_ARROWS_ROUNDING
    top_wings = sdf_intersect(sdf_intersect(ad.top_left_wing, ad.top_right_wing), ad.tip_circle_cut);
    top_wings = sdf_merge(top_wings, ad.tip_circle);
    top_wings = sdf_intersect(top_wings, ad.top_tip_cut);
    float wings_circles = sdf_merge(ad.left_wing_circle, ad.right_wing_circle);
    float wings_radius_cut = sdf_intersect(ad.left_wing_circle_cut, ad.right_wing_circle_cut);
    bottom_wings = sdf_merge(ad.bottom_left_wing, ad.bottom_right_wing);
    bottom_wings = sdf_intersect(bottom_wings, wings_radius_cut);
    bottom_wings = sdf_merge(bottom_wings, wings_circles);
    #else
    top_wings = sdf_intersect(ad.top_left_wing, ad.top_right_wing);
    bottom_wings = sdf_merge(ad.bottom_left_wing, ad.bottom_right_wing);
    #endif
    float line_without_offset = filter_border(0., line_distance_no_offset);
    float bottom_wings_with_tail = sdf_merge(bottom_wings, line_without_offset);
    float wings_with_tail = sdf_intersect(bottom_wings_with_tail, top_wings);
    
    float tail_hide_part = v_vec2_line_type_arrow_tail.y;
    float tail_hide_mask = (-texcoord.x - tail_hide_part) * derivatives_x_multiplier;
    float clipped_tail = sdf_intersect(tail_hide_mask, sdf_intersect(line_distance, top_wings));
    return (v_vec4_distance_vertex_hiding.x < v_vec4_distance_vertex_hiding.y)
        ? sdf_intersect(-sdf_intersect(tail_arrow_intersection, line_without_offset), wings_with_tail)
        : sdf_merge(clipped_tail, sdf_intersect(-sdf_intersect(tail_arrow_intersection, line_without_offset), wings_with_tail));
}
vec4 distance_to_arrow_line_color(
    const float fill_distance,
    const float border_distance)
{
    return distance_to_color(fill_distance, border_distance, v_vec4_color, v_vec4_border_color);
}
vec4 arrow_color(
    const vec2 texcoord,
    const ArrowDistanceParameters arrow_parameters,
    const float line_fill_distance,
    const float line_border_distance,
    const vec2 wing_normal)
{
    mat2 derivatives = mat2(dFdx(texcoord), dFdy(texcoord));
    
    float border_clipping = (abs(texcoord.y) - v_vec4_arrow_width_length_border_outer.w) / max(abs(derivatives[0].y), abs(derivatives[1].y));
    float border_width = v_vec4_arrow_width_length_border_outer.z;
    float arrow_border_distance = arrow_distance(
        arrow_parameters,
        texcoord,
        v_vec4_arrow_width_length_border_outer.z,
        derivatives,
        line_border_distance,
        line_fill_distance,
        border_width,
        wing_normal);
    float border_factor = max(border_clipping, affine_step(0., 1., arrow_border_distance));
    return distance_to_arrow_line_color(
        arrow_distance(arrow_parameters, texcoord, 0., derivatives, line_fill_distance, line_fill_distance, border_width, wing_normal),
        border_factor);
}
float line_start_distance(
    const vec2 texcoord,
    const float offset,
    const mat2 derivatives,
    const float line_distance,
    const float half_width,
    const float border_width,
    const float tail_radius)
{
    float derivatives_x_multiplier = 1. / max(abs(derivatives[0].x), abs(derivatives[1].x));
    
    float tail_hide_part = v_vec2_line_type_arrow_tail.y;
    float d0 = (-texcoord.x - offset) * derivatives_x_multiplier;
    float dh = (texcoord.x - tail_hide_part) * derivatives_x_multiplier;
    float rect = max(d0, max(line_distance, dh));
    
    float radius_offset = tail_radius - border_width;
    float circle_radius = radius_offset + offset;
    vec2 left_circle_center = vec2(radius_offset, half_width - radius_offset);
    vec2 right_circle_center = vec2(radius_offset, -half_width + radius_offset);
    vec2 left_circle_normal = normalize(texcoord - left_circle_center);
    vec2 right_circle_normal = normalize(texcoord - right_circle_center);
    float cut_x = (-texcoord.x + radius_offset) * derivatives_x_multiplier;
    float cut_y = (abs(texcoord.y) - half_width + radius_offset) / max(abs(derivatives[0].y), abs(derivatives[1].y));
    float circles_cut = min(cut_x, cut_y);
    float left_circle = length(texcoord - left_circle_center) - circle_radius;
    left_circle = left_circle / max(abs(dot(derivatives[0], left_circle_normal)), abs(dot(derivatives[1], left_circle_normal)));
    float right_circle = length(texcoord - right_circle_center) - circle_radius;
    right_circle = right_circle / max(abs(dot(derivatives[0], right_circle_normal)), abs(dot(derivatives[1], right_circle_normal)));
    float circles = min(left_circle, right_circle);
    rect = min(max(rect, circles_cut), circles);
    return rect;
}
vec4 line_color(
    const float line_fill_distance,
    const float line_border_distance,
    const float line_half_width,
    const float border_width,
    const float tail_radius)
{
    float type = v_vec2_line_type_arrow_tail.x;
    float fill_distance = line_fill_distance;
    float border_distance = line_border_distance;
    if (lookalike(type, g_type_start_border))
    {
        vec2 texcoord = v_vec4_texcoord_arrow_line.xy;
        mat2 derivatives = mat2(dFdx(texcoord), dFdy(texcoord));
        fill_distance = line_start_distance(
            texcoord, 0.,
            derivatives,
            line_fill_distance,
            line_half_width,
            border_width,
            tail_radius);
        border_distance = line_start_distance(
            texcoord,
            v_vec4_arrow_width_length_border_outer.z,
            derivatives,
            line_border_distance,
            line_half_width,
            border_width,
            tail_radius);
    }
    return distance_to_arrow_line_color(fill_distance, border_distance);
}
vec4 arrow_line_color()
{
    if (lookalike(min(v_vec4_distance_vertex_hiding.y, 1.), 1.)
        || lookalike(v_vec4_distance_vertex_hiding.w, 1.)
        || !lookalike(v_vec2_line_type_arrow_tail.x, g_type_arrow) && (v_vec4_distance_vertex_hiding.x < v_vec4_distance_vertex_hiding.y || v_vec4_distance_vertex_hiding.x > v_vec4_distance_vertex_hiding.z))
    {
        discard;
    }
    vec2 wing_normal = -normalize(vec2(u_float_wing_width_multiplier, u_float_wing_height_multiplier));
    vec2 tip_normal = normalize(vec2(u_float_wing_width_multiplier, u_float_tip_height_multiplier));
    float tip_radius;
    float wing_radius;
    float tail_radius;
    #ifdef ENTRANCE_ARROWS_ROUNDING
    tip_radius = v_vec3_radius_tip_wing_tail.x;
    wing_radius = v_vec3_radius_tip_wing_tail.y;
    tail_radius = v_vec3_radius_tip_wing_tail.z;
    #else
    tip_radius = 0.;
    wing_radius = 0.;
    tail_radius = 0.;
    #endif
    ArrowDistanceParameters arrow_parameters = calculate_arrow_distance_parameters(
        wing_normal,
        tip_normal,
        v_vec4_arrow_width_length_border_outer.x,
        v_vec4_arrow_width_length_border_outer.y,
        u_float_tip_height_multiplier,
        u_float_wing_height_multiplier,
        tip_radius,
        wing_radius,
        v_vec4_arrow_width_length_border_outer.z,
        v_vec4_circle_center_tip_wing.xy,
        v_vec4_circle_center_tip_wing.zw);
    float line_width = arrow_parameters.width;
    float line_border = v_vec4_arrow_width_length_border_outer.z;
    
    vec2 line_texcoord = v_vec4_texcoord_arrow_line.zw;
    mat2 line_derivatives = mat2(dFdx(line_texcoord), dFdy(line_texcoord));
    CircleDistance circle_fill_distance = circle_color_distance(line_derivatives, line_texcoord, line_width);
    CircleDistance circle_border_distance = circle_color_distance(line_derivatives, line_texcoord, line_width + line_border);
    float line_fill_distance = affine_step(-1., 0., circle_fill_distance.distance / circle_fill_distance.width) - 1.;
    float line_border_distance = affine_step(0., circle_border_distance.width, circle_border_distance.distance);
    return lookalike(v_vec2_line_type_arrow_tail.x, g_type_arrow)
        ? arrow_color(v_vec4_texcoord_arrow_line.xy, arrow_parameters, line_fill_distance, line_border_distance, wing_normal)
        : line_color(line_fill_distance, line_border_distance, line_width, line_border, tail_radius);
}
void main()
{
    vec4 color = arrow_line_color();
    gl_FragColor = apply_fog(color);
}
`,DR=`#include <highp_float>
#include <prelude>
varying vec2 v_vec2_line_type_arrow_tail;
varying vec4 v_vec4_distance_vertex_hiding;
varying vec4 v_vec4_identifier;
const float g_type_arrow = 1.;
bool lookalike(const float a, const float b)
{
    return abs(a - b) < 1e-5;
}
void main()
{
    if (lookalike(min(v_vec4_distance_vertex_hiding.y, 1.), 1.)
        || lookalike(v_vec4_distance_vertex_hiding.w, 1.)
        || !lookalike(v_vec2_line_type_arrow_tail.x, g_type_arrow) && (v_vec4_distance_vertex_hiding.x < v_vec4_distance_vertex_hiding.y || v_vec4_distance_vertex_hiding.x > v_vec4_distance_vertex_hiding.z))
    {
        discard;
    }
    gl_FragColor = v_vec4_identifier;
}
`,NR=`#include <highp_float>
#include <prelude>
#include <cam_pos>
#include <affine_step>
#include <fog>
#include <bit_mask>
#include <pack_depth>
#include <shadow>
#include <light>
uniform vec4 u_vec4_color;
varying vec2 v_vec2_circle;
varying float v_float_width;
void main() {
    float center_distance = dot(v_vec2_circle, v_vec2_circle);
    vec4 light = light_factor_surface();
    vec4 color = u_vec4_color * affine_step(1.0, 1.0 - 4.0 / v_float_width, center_distance) * light;
    gl_FragColor = apply_fog_alpha(color);
}
`,UR=`#include <lowp_float>
#include <prelude>
#include <fog>
varying vec4 v_vec4_color;
void main()
{
    gl_FragColor = apply_fog(v_vec4_color);
}
`,GR=`#include <lowp_float>
#include <prelude>
varying vec4 v_vec4_identifier;
void main()
{
    gl_FragColor = v_vec4_identifier;
}
`,HR=`#include <enable_standard_derivatives>
#include <highp_float>
#include <prelude>
#include <cam_pos>
#include <fog>
#include <screendoor_transparency>
#include <fragment_normal>
#include <bit_mask>
#include <pack_depth>
#include <shadow>
#include <light>
varying vec4 v_vec4_color;
varying vec4 v_vec4_rotated_scaled_vertex;
void main()
{
    apply_screendoor();
    vec3 normal = calc_fragment_normal(v_vec4_rotated_scaled_vertex.xyz);
    vec4 light = light_factor(normal);
    vec4 color = v_vec4_color * light;
    gl_FragColor = apply_fog(color);
}
`,VR=`#include <mediump_float>
#include <prelude>
#if defined(IS_DEPTH_TEXTURE) && defined(WEBGL2)
uniform mediump sampler2DShadow u_texture;
#else
uniform sampler2D u_texture;
#endif
varying vec2 v_vec2_texcoord;
void main()
{
#if defined(IS_DEPTH_TEXTURE) && defined(WEBGL2)
    gl_FragColor = vec4(vec3(texture2D(u_texture, vec3(v_vec2_texcoord, 1.0))), 1.0);
#else
    gl_FragColor = texture2D(u_texture, v_vec2_texcoord);
#endif
}
`,jR=`#include <require_frag_depth>
#include <mediump_float>
#include <prelude>
#include <apply_opacity>
uniform sampler2D u_texture;
uniform sampler2D u_depth;
varying vec2 v_vec2_texcoord;
void main()
{
    float depthR = texture2D(u_depth, v_vec2_texcoord).r;
    vec4 color = texture2D(u_texture, v_vec2_texcoord);
    gl_FragColor = color;
    #ifdef WEBGL1
    gl_FragDepthEXT = depthR;
    #else
    gl_FragDepth = depthR;
    #endif
}
`,$R=`#include <mediump_float>
#include <prelude>
varying float v_float_height;
void main()
{
  gl_FragColor = vec4(v_float_height, 0., 0., 1.);
}
`,WR=`#include <mediump_float>
#include <prelude>
uniform sampler2D u_sr2d_texture;
varying vec2 v_vec2_texcoord;
void main()
{
  gl_FragColor = texture2D(u_sr2d_texture, v_vec2_texcoord);
}
`,ZR=`#include <mediump_float>
#include <prelude>
varying vec4 v_vec4_color;
void main()
{
    gl_FragColor = v_vec4_color;
}
`,XR=`#include <mediump_float>
#include <prelude>
varying vec4 v_vec4_coords;
void main()
{
    gl_FragColor = v_vec4_coords;
}
`,YR=`#include <mediump_float>
#include <prelude>
varying vec4 v_vec4_coords;
void main()
{
    gl_FragColor = v_vec4_coords;
}
`,qR=`#include <enable_standard_derivatives>
#include <mediump_float>
#include <prelude>
#include <cam_pos>
#include <fog>
#include <bit_mask>
#include <pack_depth>
#include <shadow>
#include <light>
uniform sampler2D u_flat_tex;
uniform sampler2D u_hillshade_tex;
uniform sampler2D u_tex_hillshade_ramp;
uniform float u_float_dem_shading_intensity;
varying vec4 v_vec4_texcoord;
varying vec2 hs_tex_pos;
void main()
{
    
    if (v_vec4_texcoord.z > 0.) {
        discard;
    }
    vec4 vec4_texcoord = v_vec4_texcoord / v_vec4_texcoord.w;
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
     
    if (vec4_texcoord.x < 0. || vec4_texcoord.x > 1. || vec4_texcoord.y < 0. || vec4_texcoord.y > 1.) {
        discard;
    } else {
        vec4 flatMapColor = texture2D(u_flat_tex, vec4_texcoord.xy);
        
        if (u_float_dem_shading_intensity > 0.) {
            
            vec3 normal = texture2D(u_hillshade_tex, hs_tex_pos).rgb * 2. - vec3(1.);
            
            float light_raw = light_factor_dem(normal);
            float dir1_intensity = u_vec4_light_dir1_color[3];
            float amb_intensity = u_vec4_ambient_color[3];
            float total_intensity = dir1_intensity + amb_intensity;
            
            
            float amb_intensity_shifted = u_vec4_ambient_color[3];
            float dir_intensity_shifted = dir1_intensity;
            
            float horizonatal_surface_light_dir_dot = light_factor_dem(vec3(0, 0, 1));
            float horizonatal_surface_light_intensity = amb_intensity + dir1_intensity * horizonatal_surface_light_dir_dot;
            if (u_float_dem_shading_intensity > 0.5) { 
                amb_intensity_shifted = mix(amb_intensity, 0., (u_float_dem_shading_intensity - 0.5) / 0.5);
                dir_intensity_shifted = (horizonatal_surface_light_intensity - amb_intensity_shifted) / horizonatal_surface_light_dir_dot;
            } else if (u_float_dem_shading_intensity < 0.5) { 
                dir_intensity_shifted = mix(0., dir1_intensity, u_float_dem_shading_intensity / 0.5);
                amb_intensity_shifted = horizonatal_surface_light_intensity - dir_intensity_shifted * horizonatal_surface_light_dir_dot;
            } 
            
            float tex_coord = clamp(dir_intensity_shifted * light_raw * 0.5 + 0.5, 0., 0.99);
            
            float dir_light_factor = 2. * (texture2D(u_tex_hillshade_ramp, vec2(tex_coord, 0.5)).a - 0.5);
            vec3 light_color = amb_intensity_shifted * u_vec4_ambient_color.rgb + dir_light_factor * u_vec4_light_dir1_color.rgb;
            
            gl_FragColor.rgb = light_color * flatMapColor.rgb;
            
            
            gl_FragColor.a = flatMapColor.a;
        } else {
            gl_FragColor = flatMapColor * light_factor_surface();
        }
        gl_FragColor = apply_fog(gl_FragColor);
    }
}
`,KR=`#include <enable_standard_derivatives>
#include <mediump_float>
#include <prelude>
#include <cam_pos>
#include <fog>
#include <bit_mask>
#include <pack_depth>
#include <shadow>
#include <light>
#include <fragment_normal>
uniform sampler2D u_flat_tex;
uniform sampler2D u_hillshade_tex;
uniform sampler2D u_tex_hillshade_ramp;
uniform mediump float u_use_flat_dem_mesh_normals;
varying vec4 v_vec4_texcoord;
varying vec3 v_vec3_position;
varying vec3 v_vec3_normal;
void main() {
    vec4 vec4_texcoord = v_vec4_texcoord / v_vec4_texcoord.w;
    if(vec4_texcoord.x < 0. || vec4_texcoord.x > 1. || vec4_texcoord.y < 0. || vec4_texcoord.y > 1.) {
        discard;
    }
    vec4 flatMapColor = texture2D(u_flat_tex, vec4_texcoord.xy);
    vec3 normal = u_use_flat_dem_mesh_normals == 1.0 ? calc_fragment_normal(v_vec3_position) : v_vec3_normal;
    vec4 lf = light_factor(normal);
    gl_FragColor = vec4(lf.rgb * flatMapColor.rgb, flatMapColor.a);
    
    
}
`,JR=`#include <lowp_float>
#include <prelude>
uniform sampler2D u_tex_dem;
const float DEM_INVALID_VALUE = -9999.;
uniform float u_float_dem_resolution;
uniform float u_float_dem_cell_size;
uniform float u_float_dem_scale;
const float M_PI = 3.1415926535897932384626433832795;
varying vec2 v_vec2_texcoord;
mat3 get_kernel(vec2 pos, float step, float defval) {
    mat3 kernel;
    for (int x = 0; x < 3; x++) {
        vec3 col;
        for (int y = 0; y < 3; y++) {
            col[y] = texture2D(u_tex_dem, vec2(pos.x + float(x - 1) * step, pos.y + float(y - 1) * step)).r;
            if (col[y] == DEM_INVALID_VALUE) {
                col[y] = defval;
            }
        }
        kernel[x] = col;
    }
    return kernel;
}
float calc_aspect(mat3 kernel) {
    float dzdx = ((kernel[2].z + 2.0 * kernel[2].y + kernel[2].x) - (kernel[0].z + 2.0 * kernel[0].y + kernel[0].x)) / 8.;
    float dzdy = ((kernel[0].x + 2.0 * kernel[1].x + kernel[2].x) - (kernel[0].z + 2.0 * kernel[1].z + kernel[2].z)) / 8.;
    
    if (dzdx == 0. && dzdy == 0.) {
        return 0.;
    }
    
    return atan(-dzdx, dzdy);
}
float calc_slope(mat3 kernel, float cell_size) {
    float dzdx = ((kernel[2].z + 2. * kernel[2].y + kernel[2].x) - (kernel[0].z + 2. * kernel[0].y + kernel[0].x)) / (8. * cell_size);
    float dzdy = ((kernel[0].x + 2. * kernel[1].x + kernel[2].x) - (kernel[0].z + 2. * kernel[1].z + kernel[2].z)) / (8. * cell_size);
    float rise_run = sqrt(dzdx * dzdx + dzdy * dzdy);
    return atan(rise_run);
}
vec3 dem_normal(const vec2 tex_pos)
{
    
    float tex_step = 1. / u_float_dem_resolution;
    
    if (u_float_dem_scale == 0.) {
        return vec3(0.);
    }
    
    vec4 e = texture2D(u_tex_dem, tex_pos);
    if (e.a == 0. || e.r == DEM_INVALID_VALUE) {
        
        return vec3(0.);
    }
    mat3 kernel = get_kernel(tex_pos.xy, tex_step, e.r);
    
    float aspect = calc_aspect(kernel);
    
    
    float slope = calc_slope(kernel, u_float_dem_cell_size);
    
    slope = M_PI * 0.5 - slope; 
    aspect = aspect - M_PI * 0.5; 
    float cosSlope = cos(slope);
    vec3 normal = normalize(vec3(cosSlope * cos(aspect), -1. * cosSlope * sin(aspect), sin(slope)));
    
    return normal * 0.5 + vec3(0.5);
}
void main() {
    gl_FragColor = vec4(dem_normal(v_vec2_texcoord), 1);
}
`,QR=`#include <require_frag_depth>
#include <highp_float>
void main()
{
    
    
    
    #ifdef WEBGL1
        gl_FragDepthEXT = 1.0;
    #else
        gl_FragDepth = 1.0;
    #endif
}
`,ez=`#include <mediump_float>
#include <prelude>
uniform sampler2D u_sr2d_flatmap_texture;
varying vec2 v_vec2_texture;
void main() {
    gl_FragColor = texture2D(u_sr2d_flatmap_texture, v_vec2_texture);
}
`,tz=`#include <mediump_float>
#include <prelude>
#ifndef UBO
uniform mediump vec4 u_vec4_halo_color;
uniform mediump vec2 u_vec2_halo_viewport_size;
uniform mediump vec2 u_vec2_halo_viewport_center_shift;
uniform mediump vec4 u_vec4_halo_radius_stops;
uniform mediump float u_float_halo_exp_factor;
#endif
varying vec2 v_vec2_uv;
void main() {
    float dist = length(v_vec2_uv);
    float halo_alpha = u_vec4_halo_color.a;
    vec4 halo_color = vec4(u_vec4_halo_color.rgb, 0.);
    vec4 empty_color = vec4(0.0);
    vec4 white_color1 = vec4(1., 1., 1., halo_alpha);
    vec4 white_color2 = vec4(white_color1.rgb, halo_alpha * 0.9);
    float r0 = u_vec4_halo_radius_stops[0];
    float r1 = u_vec4_halo_radius_stops[1];
    float r2 = u_vec4_halo_radius_stops[2];
    float r3 = u_vec4_halo_radius_stops[3];
    float t0 = max(0.0, (dist - r1) / (r3 - r1));
    float t0e = 1.0 - exp(u_float_halo_exp_factor * t0);
    
    vec4 color = mix(white_color2, halo_color, t0e);
    
    color = mix(white_color1, color, smoothstep(r1, r2, dist));
    
    color = mix(empty_color, color, smoothstep(r0, r1, dist));
    gl_FragColor = color;
}
`,nz=`#include <mediump_float>
#include <prelude>
#ifndef UBO
uniform mediump vec4 u_vec4_default_background_color;
uniform mediump vec4 u_vec4_halo_radius_stops;
#endif
varying vec2 v_vec2_uv;
void main() {
    float dist = length(v_vec2_uv);
    float r1 = u_vec4_halo_radius_stops[1];
    if(dist > r1) {
        discard;
    }
    gl_FragColor = u_vec4_default_background_color;
}
`,iz=`#include <enable_standard_derivatives>
#include <highp_float>
#include <prelude>
#include <cam_pos>
#include <fog>
#include <screendoor_transparency>
#include <bit_mask>
#include <pack_depth>
#include <shadow>
#include <light>
#include <light_pbr>
#include <light_phong>
uniform vec4 u_vec4_color;
#ifdef MAP_MESH_TEXTURE
uniform sampler2D u_sampler_map_tex;
#endif
#ifdef COLOR_TEXTURE
uniform sampler2D u_sr2d_texture_0;
#endif
#ifdef AO_TEXTURE
uniform sampler2D u_ao_texture;
#endif
#ifdef PBR_TEXTURE
uniform sampler2D u_pbr_texture;
#endif
#ifdef LIGHT_MODEL
#if  (LIGHT_MODEL == LIGHT_MODEL_PBR || LIGHT_MODEL == LIGHT_MODEL_PHONG)
uniform float u_float_metallic;
uniform float u_float_roughness;
#endif
#endif
varying vec3 v_vec3_normal;
varying vec3 v_vec3_fragment_pos_world;
#ifdef MAP_MESH_TEXTURE
uniform vec2 u_vec2_tex_scale;
uniform float u_float_tex_shift_scale;
varying vec4 v_tex_coord;
#endif
#ifdef COLOR_TEXTURE
varying vec2 v_vec2_texcoord_color;
#endif
#ifdef AO_TEXTURE
varying vec2 v_vec2_texcoord_ao;
#endif
#ifdef PBR_TEXTURE
varying vec2 v_vec2_texcoord_pbr;
#endif
varying float v_float_opacity;
void main()
{
    apply_screendoor();
    vec4 color = u_vec4_color;
    #ifdef COLOR_TEXTURE
        color *= texture2D(u_sr2d_texture_0, v_vec2_texcoord_color);
    #endif
    #ifdef MAP_MESH_TEXTURE
        
        vec2 coord = v_tex_coord.xy / v_tex_coord.w;
        
        coord = coord / u_vec2_tex_scale;
        
        coord.y += u_float_tex_shift_scale / u_vec2_tex_scale.y;
        
        coord = (coord / 2.) + vec2(0.5, 0.5);
        vec4 texture_color = texture2D(u_sampler_map_tex, coord);
        
        color.rgb = mix(color.rgb, texture_color.rgb, texture_color.a);
    #endif
    #ifdef AO_TEXTURE
        
        
        vec4 ao_tex_color = texture2D(u_ao_texture, v_vec2_texcoord_ao);
        color *= ao_tex_color;
    #endif
    vec3 fragment_normal = normalize(v_vec3_normal);
    color *= v_float_opacity;
    bool use_light = UNPACK_BOOL1(u_int_light_flags);
    if (!use_light) {
        gl_FragColor = apply_fog(color);
        return;
    }
    #ifdef LIGHT_MODEL
        float metallic = max(u_float_metallic, 0.1);
        float roughness = max(u_float_roughness, 0.1);
        #ifndef METALLIC_ROUGHNESS_DEBUG
            #ifdef PBR_TEXTURE
                vec4 pbr_tex_color = texture2D(u_pbr_texture, v_vec2_texcoord_pbr);
                roughness = max(pbr_tex_color.g, 0.1);
                metallic = max(pbr_tex_color.b, 0.1);
            #endif
        #endif
        #if (LIGHT_MODEL == LIGHT_MODEL_PBR)
            color.rgb = color_pbr(fragment_normal, v_vec3_fragment_pos_world, color.rgb, roughness, metallic);
        #elif (LIGHT_MODEL == LIGHT_MODEL_PHONG)
            color.rgb = color_phong(fragment_normal, v_vec3_fragment_pos_world, color.rgb, roughness, metallic);
        #endif
    #endif
    gl_FragColor = apply_fog(color);
}
`,oz=`#include <enable_standard_derivatives>
#include <highp_float>
#include <prelude>
#include <cam_pos>
#include <fog>
#include <screendoor_transparency>
#include <fragment_normal>
#include <bit_mask>
#include <pack_depth>
#include <shadow>
#include <light>
varying mat4 v_mat4_gradient;
varying vec4 v_vec4_color;
varying vec4 v_vec4_rotated_scaled_vertex;
void main()
{
    apply_screendoor();
    vec4 color = v_vec4_color;
    if (v_mat4_gradient[0][0] != 0.) {
        float height_gradient = v_vec4_rotated_scaled_vertex.w;
        color = mix(v_mat4_gradient[1], v_mat4_gradient[2], smoothstep(v_mat4_gradient[0][1], v_mat4_gradient[0][2], height_gradient));
    }
    vec3 normal = calc_fragment_normal(v_vec4_rotated_scaled_vertex.xyz);
    color *= light_factor(normal);
    gl_FragColor = apply_fog(color);
}`,rz=`#include <mediump_float>
#include <prelude>
#include <fog>
uniform highp float u_float_intensity;
varying float v_float_weight;
varying vec2 v_vec2_extrude;
#define GAUSS_COEF 0.3989422804014327
void main() {
    float d = -0.5 * 3.0 * 3.0 * dot(v_vec2_extrude, v_vec2_extrude);
    float val = v_float_weight * u_float_intensity * GAUSS_COEF * exp(d);
    float fog_alpha = apply_fog_alpha(vec4(1)).r;
    gl_FragColor = vec4(val, fog_alpha, 1.0, 1.0);
}
`,sz=`#include <mediump_float>
#include <prelude>
#include <cam_pos>
uniform sampler2D u_sr2d_texture;
uniform sampler2D u_sr2d_ramp_texture;
uniform float u_float_opacity;
varying vec2 v_vec2_position;
void main() {
    vec2 color_and_alpha = texture2D(u_sr2d_texture, v_vec2_position).rg;
    vec4 color = texture2D(u_sr2d_ramp_texture, vec2(color_and_alpha.r, 0.5));
    gl_FragColor = color * u_float_opacity;
    
    
    #ifdef FOG
        gl_FragColor *= color_and_alpha.g;
    #endif
}
`,az=`#include <mediump_float>
#include <prelude>
#include <apply_opacity>
#include <fog>
uniform sampler2D u_sr2d_texture;
uniform float u_float_buffer;
uniform float u_float_gamma;
uniform vec4 u_vec4_color;
uniform vec4 u_vec4_hidden_color;
uniform float u_float_opacity;
uniform sampler2D u_color_text_sprite_labeling;
uniform float u_float_label_index;
varying vec2 v_vec2_texcoord;
varying float v_float_behind_factor;
varying vec4 v_vec4_text_identifier;
varying vec2 v_vec2_labeling_texcoord;
void main() {
    float dist = texture2D(u_sr2d_texture, v_vec2_texcoord).a;
    float alpha = smoothstep(
        u_float_buffer - u_float_gamma,
        u_float_buffer + u_float_gamma,
        dist
    );
    vec4 color = mix(u_vec4_hidden_color, u_vec4_color, v_float_behind_factor);
    color = apply_fog_alpha(color);
    vec4 clearColor = vec4(1, 1, 1, 1);
    vec4 text_sprite_color = texture2D(u_color_text_sprite_labeling, v_vec2_labeling_texcoord);
    if (u_float_label_index < 0.0000001 && text_sprite_color != v_vec4_text_identifier && text_sprite_color != clearColor) {
        discard;
    }
    gl_FragColor = apply_opacity(color * alpha, u_float_opacity);
}
`,lz=`#include <highp_float>
#include <prelude>
#include <apply_opacity>
#include <fog>
uniform sampler2D u_sr2d_texture;
uniform float u_float_buffer;
uniform float u_float_gamma;
uniform vec4 u_vec4_color;
uniform float u_float_opacity;
varying vec2 v_vec2_texcoord;
void main() {
    float dist = texture2D(u_sr2d_texture, v_vec2_texcoord).a;
    float alpha = smoothstep(
        u_float_buffer - u_float_gamma,
        u_float_buffer + u_float_gamma,
        dist
    );
    vec4 color = apply_fog_alpha(u_vec4_color);
    gl_FragColor = apply_opacity(color * alpha, u_float_opacity);
}
`,cz=`#include <mediump_float>
#include <prelude>
#include <cam_pos>
#include <fog>
#include <bit_mask>
#include <pack_depth>
#include <shadow>
#include <light>
varying vec4 v_vec4_color;
varying mat4 v_mat4_gradient;
varying vec3 v_vec3_normal;
varying vec2 v_vec2_height_gradient;
uniform mat4 u_mat4_gradient;
void main()
{ 
    vec4 color = v_vec4_color;
    if (u_mat4_gradient[0][0] != 0.) {
        color = mix(v_mat4_gradient[1], v_mat4_gradient[2], smoothstep(v_mat4_gradient[0][1], v_mat4_gradient[0][2], v_vec2_height_gradient[0]));
    }
    color *= (1. - abs(v_vec2_height_gradient[1] * gl_FragCoord.w));
    gl_FragColor = apply_fog(color * light_factor(v_vec3_normal));
}
`,dz=`#include <highp_float>
#include <prelude>
#include <pack_depth>
varying float v_depth_metric;
void main()
{
#ifdef DEPTH_TEXTURE_SHADOW
return;
#endif
gl_FragColor = pack_float_to_vec4(v_depth_metric);
}`,uz=`#include <highp_float>
#include <prelude>
#include <cam_pos>
#include <fog>
#include <screendoor_transparency>
#include <bit_mask>
#include <pack_depth>
#include <shadow>
#include <light>
uniform sampler2D u_sampler_map_tex;
uniform vec2 u_vec2_tex_scale;
uniform float u_float_tex_shift_scale;
uniform mediump float u_float_light_intensity;
uniform int u_int_identify;
varying vec4 v_tex_coord;
varying vec4 v_vec4_normal_gradient;
void main()
{
vec2 coord = v_tex_coord.xy / v_tex_coord.w;
coord = coord / u_vec2_tex_scale;
coord.y += u_float_tex_shift_scale / u_vec2_tex_scale.y;
coord = (coord / 2.) + vec2(0.5, 0.5);
if (coord.x < 0. || coord.x > 1. || coord.y < 0. || coord.y > 1.) {
gl_FragColor = vec4(0, 0, 0, 0);
} else {
gl_FragColor = texture2D(u_sampler_map_tex, coord);
if (u_int_identify == 0) {
apply_screendoor();
gl_FragColor.rgb *= 1. - u_float_light_intensity * smoothstep(0.85, 1., abs(v_vec4_normal_gradient.w));
gl_FragColor *= light_factor(v_vec4_normal_gradient.xyz);
gl_FragColor = apply_fog(gl_FragColor);
}
}
}
`,fz=`#include <highp_float>
#include <prelude>
#include <cam_pos>
#include <apply_opacity>
#include <fog>
#include <screendoor_transparency>
#include <bit_mask>
#include <pack_depth>
#include <shadow>
#include <light>
uniform sampler2D u_sr2d_texture;
uniform float u_float_texture_opacity;
uniform vec4 u_float_sprite_texture_coords;
uniform lowp int u_int_is_textured;
uniform mediump vec4 u_vec4_color;
uniform mediump mat4 u_mat4_gradient;
uniform mediump float u_float_opacity;
uniform mediump int u_int_identify;
varying vec4 v_vec4_color;
varying mat4 v_mat4_gradient;
varying vec2 v_vec2_tex_coord;
varying vec4 v_vec4_normal_gradient;
varying vec4 v_vec4_identifier;
void main()
{
    if (u_int_identify != 0) {
        gl_FragColor = v_vec4_identifier;
    } else {
        apply_screendoor();
        vec4 light = light_factor(v_vec4_normal_gradient.xyz);
        if (u_int_is_textured != 0)  {
            vec2 spritecoord = mix(u_float_sprite_texture_coords.xy, u_float_sprite_texture_coords.zw, fract(v_vec2_tex_coord));
            vec4 color = texture2D(u_sr2d_texture, spritecoord);
            vec4 texcolor = apply_opacity(color, u_float_texture_opacity);
            gl_FragColor = texcolor + v_vec4_color * (1. - texcolor.a);
        } else if (u_mat4_gradient[0][0] != 0.) {
    gl_FragColor = mix(v_mat4_gradient[1], v_mat4_gradient[2], smoothstep(v_mat4_gradient[0][1], v_mat4_gradient[0][2], v_vec4_normal_gradient.w));
        } else {
            gl_FragColor = v_vec4_color;
        }
        gl_FragColor = apply_fog(gl_FragColor * light);
    }
}
`,hz=`#include <mediump_float>
#include <prelude>
#include <cam_pos>
#include <apply_opacity>
#include <fog>
#include <bit_mask>
#include <pack_depth>
#include <shadow>
#include <light>
uniform vec4 u_vec4_color;
uniform sampler2D u_sr2d_texture;
uniform vec4 u_float_sprite_texture_coords;
varying vec2 v_vec2_texcoord;
void main()
{
    vec2 spritecoord = mix(u_float_sprite_texture_coords.xy, u_float_sprite_texture_coords.zw, v_vec2_texcoord);
    vec4 color = texture2D(u_sr2d_texture, spritecoord) * u_vec4_color;
    gl_FragColor = apply_fog(color * light_factor_surface());
}
`,_z=`#include <enable_standard_derivatives>
#include <highp_float>
#include <prelude>
#include <affine_step>
#include <apply_opacity>
#include <signed_distance_functions>
#include <arrow_functions>
#include <fog>
uniform vec2 u_vec2_wing_normal;
uniform vec2 u_vec2_tip_normal;
uniform mediump float u_float_width;
uniform mediump float u_float_length;
uniform mediump vec2 u_vec2_vpt_size;
uniform float u_float_tip_height_multiplier;
uniform float u_float_wing_height_multiplier;
varying vec4 v_vec4_color;
varying vec4 v_vec4_border_color;
varying vec2 v_vec2_texcoord;
varying float v_float_border_width;
varying float v_float_zpt_to_texcoord_factor;
varying float v_float_outer_width;
varying float v_float_opacity;
float one_way_line_distance(const ArrowDistances ad)
{
    return max(max(max(ad.top_tip_cut, ad.bottom_tip_cut), max(ad.top_left_wing, ad.top_right_wing)), min(ad.line, min(ad.bottom_left_wing, ad.bottom_right_wing)));
}
void main()
{
    mat2 derivatives = mat2(dFdx(v_vec2_texcoord), dFdy(v_vec2_texcoord));
    ArrowDistanceParameters arrow_parameters = calculate_arrow_distance_parameters(
        u_vec2_wing_normal,
        u_vec2_tip_normal,
        u_float_width * v_float_zpt_to_texcoord_factor,
        u_float_length * v_float_zpt_to_texcoord_factor,
        u_float_tip_height_multiplier,
        u_float_wing_height_multiplier,
        0.,
        0.,
        0.,
        vec2(0., 0.),
        vec2(0., 0.));
    
    float border_clipping = (abs(v_vec2_texcoord.y) - v_float_outer_width) / max(abs(derivatives[0].y), abs(derivatives[1].y));
    float fill_factor = affine_step(-1., 0., one_way_line_distance(calculate_arrow_distances(arrow_parameters, v_vec2_texcoord, 0., derivatives)));
    float border_factor = max(border_clipping, affine_step(0., 1., one_way_line_distance(calculate_arrow_distances(arrow_parameters, v_vec2_texcoord, v_float_border_width, derivatives))));
    gl_FragColor = apply_opacity(mix(mix(v_vec4_color, v_vec4_border_color, fill_factor), vec4(0.), border_factor), v_float_opacity);
}
`,mz=`#include <highp_float>
#include <prelude>
#include <cam_pos>
#include <affine_step>
#include <fog>
#include <bit_mask>
#include <pack_depth>
#include <shadow>
#include <light>
#include <signed_distance_functions>
uniform int u_int_pattern_type;
varying vec4 v_vec4_color;
varying vec2 v_vec2_uv;
varying float v_float_width;
varying vec4 v_vec4_pattern_parameters;
void main()
{
    float pattern_length = v_vec4_pattern_parameters.x;
    float full_width = v_float_width + 1.;
    
    float smooth_base = max(15., max(v_float_width, pattern_length));
    float smooth_scale = (smooth_base + 1.) / smooth_base;
    float smooth_factor = smooth_scale - 1.;
    
    vec2 sdf_pos = vec2(mod(v_vec2_uv.x, 1.) - 0.5, v_vec2_uv.y * smooth_scale);
float sdf = 1.;
    
    if (u_int_pattern_type < 4) {
        
        float width = v_vec4_pattern_parameters.y;
        float left  = v_vec4_pattern_parameters.z;
        float right = v_vec4_pattern_parameters.w;
        
        
        vec2 offset;
        if (right < 0.) {
            offset = vec2(.25, .5);
        } else {
            offset = vec2(.0, .5);
        }
        
        if (width > EPSILON) {
            float leftSdf = 1.;
            if (left > EPSILON) {
                leftSdf = sdf_box(sdf_pos + offset, vec2(left, width));
            }
            float rightSdf = 1.;
            if (abs(right) > EPSILON) {
                rightSdf = sdf_box(sdf_pos - offset, vec2(abs(right), width));
            }
            sdf = min(leftSdf, rightSdf);
        }
    } else if (u_int_pattern_type == 5) {
        
        float radius = v_vec4_pattern_parameters.y;
        
        if (radius > EPSILON) {
            sdf = sdf_circle(sdf_pos, radius);
        }
    } else if (u_int_pattern_type == 4) {
        
        float width = v_vec4_pattern_parameters.y;
        float orientation = v_vec4_pattern_parameters.z;
        
        if (width > EPSILON) {
            sdf = sdf_triangle(sdf_pos * vec2(1., orientation), width);
        }
    } else if (u_int_pattern_type == 6) {
        
        sdf = sdf_chevron(sdf_pos.yx, 0., 0., 0.);
    }
    
    sdf = max(sdf, abs(sdf_pos.y) - 0.5);
    
    vec4 color = mix(
        v_vec4_color,
        vec4(0.),
        affine_step(-smooth_factor, smooth_factor, sdf)
    );
    color *= light_factor_surface();
    gl_FragColor = apply_fog(color);
}
`,pz=`#include <mediump_float>
#include <prelude>
#include <apply_opacity>
#include <fog>
uniform sampler2D u_sr2d_texture;
uniform vec2 u_vec2_opacity;
varying vec2 v_vec2_texcoord;
varying float v_float_behind_factor;
void main()
{
    vec4 color = texture2D(u_sr2d_texture, v_vec2_texcoord);
    float opacity = mix(u_vec2_opacity[1], u_vec2_opacity[0], v_float_behind_factor);
    color = apply_fog_alpha(color);
    gl_FragColor = apply_opacity(color, opacity);
}
`,gz=`#include <mediump_float>
#include <prelude>
uniform sampler2D u_sr2d_texture;
varying vec2 v_vec2_texcoord;
varying vec4 v_vec4_identifier;
void main()
{
    vec4 color = texture2D(u_sr2d_texture, v_vec2_texcoord);
    if (color.a < 0.3) {
        discard;
    } else {
        gl_FragColor = v_vec4_identifier;
    }
}
`,vz=`#include <lowp_float>
#include <prelude>
#include <fog>
uniform vec4 u_vec4_color;
void main()
{
    gl_FragColor = u_vec4_color;
}
`,yz=`#include <mediump_float>
#include <prelude>
#include <apply_opacity>
#include <fog>
uniform sampler2D u_sr2d_texture;
uniform float u_float_opacity;
varying vec2 v_vec2_texcoord;
void main()
{
    vec4 color = texture2D(u_sr2d_texture, v_vec2_texcoord);
    color = apply_fog_alpha(color);
    gl_FragColor = apply_opacity(color, u_float_opacity);
}
`,bz=`#include <enable_standard_derivatives>
#include <highp_float>
#include <prelude>
#include <cam_pos>
#include <affine_step>
#include <fog>
#include <bit_mask>
#include <pack_depth>
#include <shadow>
#include <light>
uniform vec4 u_vec4_color;
varying vec2 v_vec2_normal;
varying float v_float_half_width;
void main()
{
    
    float opacity = 1.0 - affine_step(
        v_float_half_width - length(fwidth(v_vec2_normal)),
        v_float_half_width,
        length(v_vec2_normal)
    );
    vec4 color = light_factor_surface() * u_vec4_color;
    color = apply_fog(color);
    gl_FragColor = color * opacity;
}
`,wz=`#include <enable_standard_derivatives>
#include <lowp_float>
#include <prelude>
varying vec4 v_vec4_identifier;
varying vec2 v_vec2_normal;
varying float v_float_half_width;
void main()
{
    if (dot(v_vec2_normal, v_vec2_normal) > v_float_half_width * v_float_half_width) {
        discard;
    }
    gl_FragColor = v_vec4_identifier;
}
`,xz=`#include <lowp_float>
#include <prelude>
#include <cam_pos>
#include <fog>
#include <bit_mask>
#include <pack_depth>
#include <shadow>
#include <light>
uniform vec4 u_vec4_color;
varying float v_float_distance;
varying float v_float_distance_offset;
void main()
{
    vec4 light = light_factor_surface();
    vec4 color = u_vec4_color * clamp(
        1. + v_float_distance_offset - abs(v_float_distance * gl_FragCoord.w),
        0.,
        1.) * light;
    gl_FragColor = apply_fog(color);
}
`,Sz=`#include <highp_float>
#include <prelude>
#include <enable_standard_derivatives>
varying vec3 v_position;
void main() {
    vec3 dx = dFdx(v_position);
    vec3 dy = dFdy(v_position);
    vec3 normal = normalize(cross(dx, dy));
    vec3 lightDir = normalize(vec3(1.0, 1.0, 1.0));
    float diffuse = max(dot(normal, lightDir), 0.0);
    
    gl_FragColor = vec4(normal * (0.2 + 0.8 * diffuse), 1.0);
}
`,Mz=`#include <mediump_float>
#include <prelude>
#include <fog>
#define SKY_ALPHA_HORIZON_BLEND (6.0)
#define DEFAULT_SKY_COLOR (vec4(0.0))
vec4 add_sky_alpha_blend(vec4 color) {
#ifdef SKY
    
    float depth = length(v_fog_pos);
    vec3 dir = v_fog_pos / depth;
    float alpha_dir = dir.z + 0.15; 
    float alpha = clamp(1.0 + SKY_ALPHA_HORIZON_BLEND * alpha_dir, 0.0, 1.0);
    color *= alpha;
#endif
    return color;
}
void main() {
#ifdef SKY
    vec4 color = add_sky_alpha_blend(u_sky_color);
#else
    vec4 color = DEFAULT_SKY_COLOR;
#endif
    gl_FragColor = apply_fog_sky(color);
}
`,Tz=`#include <mediump_float>
#include <prelude>
varying mediump float v_intensity;
void main() {
    gl_FragColor = vec4(v_intensity);
}
`,Iz=`#include <enable_standard_derivatives>
#include <highp_float>
#include <prelude>
#include <cam_pos>
#include <affine_step>
#include <fog>
#include <bit_mask>
#include <pack_depth>
#include <shadow>
#include <light>
varying vec4 v_vec4_dash_color;
varying vec4 v_vec4_space_color;
varying vec4 v_vec4_border_color;
varying vec2 v_vec2_circle;
varying float v_float_width;
varying float v_float_part_color_swap_threshold;
varying float v_float_distance_in_parts;
vec4 distance_func_smooth(in vec4 main_color, in vec4 border_color, in vec2 circle)
{
    float circle_length = length(circle);
    float distance = circle_length - v_float_width;
    mat2 derivatives = mat2(dFdx(v_vec2_circle), dFdy(v_vec2_circle));
    
    
    
    vec2 circle_dx = derivatives[0];
    vec2 circle_dy = derivatives[1];
    
    float distance_dx = dot(v_vec2_circle, circle_dx);
    float distance_dy = dot(v_vec2_circle, circle_dy);
    
    float derivative_denominator = circle_length;
    float width = max(abs(distance_dx), abs(distance_dy));
    vec4 from_main_to_border = mix(
        main_color,
        border_color,
        affine_step(-width, 0., distance * derivative_denominator));
    vec4 from_color_to_fade = mix(
        from_main_to_border,
        vec4(0.),
        affine_step(0., +width, distance * derivative_denominator));
    return from_color_to_fade;
}
float calculate_segment_color_factor(in float distance_in_parts, in float threshold)
{
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    float color_factor = abs(fract(distance_in_parts + 0.5 - 0.5 * threshold) - 0.5);
    
    float parts_affine_step_width = fwidth(distance_in_parts);
    
    float smoothed_color_factor = affine_step(
        0.5 * threshold - 0.5 * parts_affine_step_width,
        0.5 * threshold + 0.5 * parts_affine_step_width,
        color_factor);
    return smoothed_color_factor;
}
void main()
{
    vec4 current_segment_color = mix(
        v_vec4_dash_color,
        v_vec4_space_color,
        calculate_segment_color_factor(
            v_float_distance_in_parts,
            v_float_part_color_swap_threshold));
    
    vec4 final_border_color = (1.0 - v_vec4_border_color.a) * current_segment_color + v_vec4_border_color;
    vec4 color = distance_func_smooth(current_segment_color, final_border_color, v_vec2_circle);
    vec4 light = light_factor_surface();
    gl_FragColor = apply_fog(light * color);
}
`,Ez=`#include <mediump_float>
#include <prelude>
#include <cam_pos>
#include <apply_opacity>
#include <fog>
#include <bit_mask>
#include <pack_depth>
#include <shadow>
#include <light>
uniform sampler2D u_sr2d_texture;
uniform float u_float_texture_opacity;
uniform vec4 u_float_texture_params;
uniform vec4 u_float_sprite_texture_coords;
uniform int u_int_is_textured;
varying vec4 v_vec4_color;
varying vec2 v_vec2_texcoord;
void main()
{
    vec4 light = light_factor_surface();
    vec4 color;
    if (u_int_is_textured == 0) {
        color = v_vec4_color * light;
    } else {
        vec2 texcoord = fract(v_vec2_texcoord * u_float_texture_params.zw + u_float_texture_params.xy);
        vec2 spritecoord = mix(u_float_sprite_texture_coords.xy, u_float_sprite_texture_coords.zw, texcoord);
        color = texture2D(u_sr2d_texture, spritecoord);
        vec4 texcolor = apply_opacity(color, u_float_texture_opacity);
        color = texcolor + v_vec4_color * (1. - texcolor.a) * light;
    }
    gl_FragColor = apply_fog(color);
}
`,Az=`#include <enable_standard_derivatives>
#include <highp_float>
#include <prelude>
#include <cam_pos>
#include <fog>
#include <screendoor_transparency>
#include <fragment_normal>
#include <bit_mask>
#include <pack_depth>
#include <shadow>
#include <light>
uniform sampler2D u_sr2d_texture;
uniform vec4 u_vec4_color;
varying vec3 v_vec3_rotated_scaled_vertex;
varying vec2 v_vec2_texcoord;
void main()
{
    apply_screendoor();
    vec3 normal = calc_fragment_normal(v_vec3_rotated_scaled_vertex);
    vec4 light = light_factor(normal);
    vec4 color = texture2D(u_sr2d_texture, v_vec2_texcoord) * u_vec4_color * light;
    gl_FragColor = apply_fog(color);
}
`,Cz={affine_step:gR,apply_opacity:sw,arrow_functions:vR,bit_mask:yR,cam_pos:aw,circle_functions:bR,enable_standard_derivatives:wR,fog:xR,fragment_normal:SR,highp_float:MR,light:TR,light_pbr:IR,light_phong:ER,lowp_float:AR,mediump_float:CR,pack_depth:PR,prelude:LR,require_frag_depth:FR,screendoor_transparency:kR,shadow:RR,signed_distance_functions:lw,taa:zR},Pz={antialias:BR,arrow_line:OR,arrow_line_identify:DR,circle_marker:NR,color:UR,color_identify:GR,color_with_z_fade:HR,copy:VR,copy_depth:jR,dem_elevation:$R,dem_elevation_copy:WR,dem_flat_bottom:ZR,dem_ground:XR,dem_ground2:YR,dem_mesh:qR,dem_mesh2:KR,dem_normal:JR,depth_clear:QR,globe:ez,globe_halo:tz,globe_halo_background:nz,gltf_model:iz,gradient_with_z_fade:oz,heatmap:rz,heatmap_texture:sz,label:az,label_directional:lz,line:cz,main_shadow:dz,map_mesh:uz,mesh:fz,metric_point:hz,one_way_line:_z,patterned_line:mz,pointsprite:pz,pointsprite_identify:gz,rect:vz,rect_with_texture:yz,road:bz,road_identify:wz,simple_line:xz,simple_mesh:Sz,sky:Mz,stars:Tz,striped_line:Iz,textured_color:Ez,zbm_model:Az},Lz=`vec4 apply_height_factor(in vec3 vertex, const float height_factor)
{
    vertex.z *= height_factor;
    return vec4(vertex, 1.0);
}
`,Fz=`
vec2 multiply_complex(const vec2 lhs, const vec2 rhs)
{
    return vec2(lhs.x * rhs.x - lhs.y * rhs.y, lhs.x * rhs.y + lhs.y * rhs.x);
}
struct ArrowParameters
{
    float zpt_to_texcoord_factor;
    float final_size;
    float outer_width;
    vec2 widen_size;
    vec2 wing_normal;
    vec2 tip_normal;
};
ArrowParameters calculate_arrow_parameters(
    const float calculation_scale,
    const float width_zpt,
    const float border_width_zpt,
    const float segment_length_zpt,
    const float wing_width_multiplier,
    const float wing_height_multiplier,
    const float tip_height_multiplier,
    const float size_factor)
{
    float quad_width = 2.0 * border_width_zpt + 2.0 * wing_width_multiplier * width_zpt;
    float quad_height = 2.0 * border_width_zpt + segment_length_zpt;
    float max_quad_dimension = max(quad_width, quad_height);
    float zpt_to_texcoord_factor = 2.0 / max_quad_dimension;
    float final_size = calculation_scale * size_factor * max_quad_dimension;
    vec2 widen_size = 0.5 * vec2(quad_height, quad_width) * zpt_to_texcoord_factor;
    float outer_width = (width_zpt * wing_width_multiplier + border_width_zpt) * zpt_to_texcoord_factor;
    vec2 wing_normal = -normalize(vec2(wing_width_multiplier, wing_height_multiplier));
    vec2 tip_normal = normalize(vec2(wing_width_multiplier, tip_height_multiplier));
    return ArrowParameters(
        zpt_to_texcoord_factor,
        final_size,
        outer_width,
        widen_size,
        wing_normal,
        tip_normal);
}
struct VertexShiftParameters
{
    vec4 clip_space_vertex;
    float limited_factor;
};
VertexShiftParameters calculate_vertex_shift_parameters(
    const mat4 mvp,
    const vec2 vpt_size,
    const vec2 vertex,
    const vec2 widen,
    const float shift_pixels)
{
    vec2 widen_perp = vec2(-widen.y, widen.x);
    
    vec4 clip_space_widen = mvp * vec4(widen, 0., 0.);
    vec4 clip_space_widen_perp = mvp * vec4(widen_perp, 0., 0.);
    vec2 half_viewport = vpt_size / 2.;
    
    vec4 clip_space_vertex = mvp * vec4(vertex, 0.0, 1.0) + clip_space_widen;
    
    float limited_factor = calculate_multiplication_factor(
        half_viewport,
        clip_space_widen,
        clip_space_widen_perp,
        clip_space_vertex,
        shift_pixels);
    return VertexShiftParameters(
        clip_space_vertex + clip_space_widen * limited_factor,
        limited_factor);
}
`,kz=`struct Scale
{
    float projection;
    float style;
    float style_clamped;
    float calculation;
};
Scale calculate_scale(const vec3 projection_scale_style_scale_dpi, const vec2 scale_limits)
{
    float style_scale_clamped = clamp(projection_scale_style_scale_dpi.y, scale_limits.x, scale_limits.y);
    float scale_ratio = projection_scale_style_scale_dpi.x / projection_scale_style_scale_dpi.y;
    float calculation_scale = style_scale_clamped * scale_ratio;
    return Scale(
        projection_scale_style_scale_dpi.x,
        projection_scale_style_scale_dpi.y,
        style_scale_clamped,
        calculation_scale);
}
const float g_min_scale_factor = 1e-2;
const float g_max_scale_factor = 1e2;
const float g_base_scale_numerator = 1e2;
float normalize_scale_to_tile(const float scale, const float tile_size)
{
    return clamp(
        (scale - g_min_scale_factor) / (tile_size - g_min_scale_factor),
        g_min_scale_factor,
        g_max_scale_factor);
}
`,Rz=`
#ifdef SCREENDOOR
varying vec3 v_clipspace_pos;
#endif
void save_clipspace_pos () {
    #ifdef SCREENDOOR
    v_clipspace_pos = gl_Position.xyz;
    #endif
}
`,zz=`
uniform sampler2D u_tex_dem;
uniform sampler2D u_tex_corrected_dem;
uniform float u_float_corrected_interval;
uniform mat4 u_mat4_dem_corrected;
uniform mat4 u_mat4_dem_mvp;
uniform float u_float_dem_scale;
uniform float u_float_map_center_elevation;
uniform float u_float_vertical_scale;
const float DEM_INVALID_VALUE = -9999.;
const float UNPACK_CENTROID = 8. / 65535.;
const float MAP_POINTS_IN_METER = 107.17318796639701;
float dem_height_direct_meters(vec2 tex_pos) {
    
    if (u_float_dem_scale == 0.) {
        return 0.;
    }
    if (tex_pos.x < 0. || tex_pos.x > 1. || tex_pos.y < 0. || tex_pos.y > 1.) {
        return DEM_INVALID_VALUE;
    }
    vec4 elevation;
    
    if (u_float_corrected_interval == 0.) {
        elevation = texture2D(u_tex_dem, tex_pos);
    }
    else {
        vec2 test_tex_pos = abs(tex_pos - vec2(0.5, 0.5));
        if (test_tex_pos.x < u_float_corrected_interval && test_tex_pos.y < u_float_corrected_interval) {
            elevation = texture2D(u_tex_corrected_dem, (u_mat4_dem_corrected * vec4(tex_pos, 0, 1)).xy);
        } else {
            elevation = texture2D(u_tex_dem, tex_pos);
        }
    }
    
    if (elevation.a == 0.) {
        
        return DEM_INVALID_VALUE;
    } else {
        return elevation.r;
    }
}
float meters_to_tile_height(float height) {
    return (height - u_float_map_center_elevation) * MAP_POINTS_IN_METER * u_float_vertical_scale * u_float_dem_scale;
}
float dem_height_direct(vec2 tex_pos) {
    float height = dem_height_direct_meters(tex_pos);
    if (height == DEM_INVALID_VALUE) {
        return DEM_INVALID_VALUE;
    } else {
        return meters_to_tile_height(height);  
    }  
}
 
float dem_height(const vec2 coords) {
    
    if (u_float_dem_scale == 0.) {
        return 0.;
    }
    vec4 tex_pos = u_mat4_dem_mvp * vec4(coords, 0.0, 1.0);
    return dem_height_direct(tex_pos.xy);
}
float abs_height(float height) {
    return (height - u_float_map_center_elevation * MAP_POINTS_IN_METER) * u_float_dem_scale * u_float_vertical_scale;
}
vec2 unpack_dem_position(const vec2 pos) {
    return pos * UNPACK_CENTROID;
}
`,Bz=`#ifndef UBO
uniform vec2 u_vec2_depth_test_half_point_size;
#endif
uniform bool u_bool_depth_test_disable;
uniform sampler2D u_color_tex_labeling;
uniform sampler2D u_depth_tex_labeling;
float color_test(const vec2 pos, const vec4 color)
{
    vec2 halfPointSize = u_vec2_depth_test_half_point_size;
    float result = 0.;
    
    if (texture2D(u_color_tex_labeling, (vec2(pos.x - halfPointSize.x, pos.y + halfPointSize.y) + 1.) / 2.) == color) {
        result++;
    }
    if (texture2D(u_color_tex_labeling, (pos + halfPointSize + 1.) / 2.) == color) {
        result++;
    }
    if (texture2D(u_color_tex_labeling, (pos - halfPointSize + 1.) / 2.) == color) {
        result++;
    }
    if (texture2D(u_color_tex_labeling, (vec2(pos.x + halfPointSize.x, pos.y - halfPointSize.y) + 1.) / 2.) == color) {
        result++;
    }
    
    return step(3., result);
}
float depth_test(const vec2 pos, const float depth, const vec4 color)
{
    if (u_bool_depth_test_disable == true) {
        return 1.;
    }
    float colorCheck = color_test(pos, color);
    if (colorCheck == 1.) {
        return 1.;
    }
    float d = (depth + 1.) / 2.;
    float delta = 0.001;
    float texDepth = texture2D(u_depth_tex_labeling, (pos + 1.) / 2.).r;
    if (d <= texDepth) {
        return 1.;
    }
    if (d - texDepth > delta) {
        return 0.;
    }
    return 1. - (d - texDepth) / delta;
}
`,Oz=`uniform mat4 u_mat4_flat_mvp;
uniform mat4 u_mat4_ecef_mvp;
uniform float u_float_crossfade;
const float ECEF_CF_E = 2e-16;
const float ECEF_WORLD = 4294967296.;
vec4 get_clipspace(const vec3 fpos) {
    return u_mat4_flat_mvp * vec4(fpos, 1.);
}
vec4 get_clipspace(const vec3 fpos, const vec3 epos) {
    if (u_float_crossfade < ECEF_CF_E) {
        return u_mat4_flat_mvp * vec4(fpos, 1.);
    } else if (u_float_crossfade > (1. - ECEF_CF_E)) {
        return u_mat4_ecef_mvp * vec4(epos * ECEF_WORLD, 1.);
    }
    vec4 fclip = u_mat4_flat_mvp * vec4(fpos, 1.);
    vec4 eclip = u_mat4_ecef_mvp * vec4(epos * ECEF_WORLD, 1.);
    return mix(fclip, eclip, u_float_crossfade);
}
vec4 get_clipspace(const vec3 fpos, const vec3 epos, const float elevation) {
    float R = ECEF_WORLD + elevation;
    if (u_float_crossfade < ECEF_CF_E) {
        return u_mat4_flat_mvp * vec4(fpos, 1.);
    } else if (u_float_crossfade > (1. - ECEF_CF_E)) {
        return u_mat4_ecef_mvp * vec4(epos * R, 1.);
    }
    vec4 fclip = u_mat4_flat_mvp * vec4(fpos, 1.);
    vec4 eclip = u_mat4_ecef_mvp * vec4(epos * R, 1.);
    return mix(fclip, eclip, u_float_crossfade);
}
`,Dz=`#ifndef UBO
# ifdef FOG
uniform float u_fog_distance;
# endif
# ifdef SKY
uniform mat4 u_mat4_view_transposed;
uniform mat4 u_mat4_proj_inverted;
# endif
#endif 
#if defined(FOG) || defined(SKY)
varying vec3 v_fog_pos;
#endif
void calc_fog_pos(vec3 world_pos) {
#ifdef FOG
    v_fog_pos = (world_pos - u_cam_pos) / u_fog_distance;
#endif
}
void calc_fog_pos_sky(vec4 pos) {
#ifdef SKY
    v_fog_pos = mat3(u_mat4_view_transposed) * (u_mat4_proj_inverted * pos).xyz;
#endif
}`,Nz=`#ifdef TAA
uniform vec2 u_vec2_camera_jitter;
void apply_vertex_jitter(inout vec4 clipPos) {
    clipPos.xy += clipPos.w * u_vec2_camera_jitter;
}
#endif`,Uz=`float calculate_final_width(
    const Scale scale,
    const float width,
    const float width_offset)
{
    
    float final_width = max(0., scale.calculation * width - scale.projection * width_offset);
    return final_width;
}
`,Gz=`uniform mat4 u_mat4_mvp;
`,Hz=`
vec2 normalize_s08(vec2 value)
{
    return value * (1. / 127.);
}
vec3 normalize_s08(vec3 value)
{
    return value * (1. / 127.);
}
float normalize_s16(float value)
{
    return value * (1. / 32767.);
}
vec2 normalize_s16(vec2 value)
{
    return value * (1. / 32767.);
}
vec3 normalize_s16(vec3 value)
{
    return value * (1. / 32767.);
}
vec2 unpack_widen(vec2 widen_packed)
{
    
    return normalize_s08(widen_packed) * sqrt(2.);
}
vec2 unpack_texcoord(vec2 texcoord)
{
    return texcoord * (1. / 32768.);
}
vec2 unpack_model_texcoord(vec2 texcoord)
{
    const float min_value = -3.0;
    const float max_value = 5.0;
    return texcoord * (max_value - min_value) / 65536.0 + min_value;
}
`,Vz=`
const float g_min_denominator = 1e-7;
const float g_max_factor = 10000.;
float calculate_multiplication_factor(
    vec2 half_viewport,
    
    vec4 clip_space_widen,
    vec4 clip_space_widen_perp,
    
    vec4 clip_space_vertex,
    float shift_pixels)
{
    float limited_factor = 0.;
    {
        
        vec2 screen_space_widen = (clip_space_widen.xy * clip_space_vertex.w - clip_space_vertex.xy * clip_space_widen.w) * half_viewport;
        vec2 screen_space_widen_perp = (clip_space_widen_perp.xy * clip_space_vertex.w - clip_space_vertex.xy * clip_space_widen_perp.w) * half_viewport;
        
        vec2 perp = vec2(screen_space_widen_perp.y, -screen_space_widen_perp.x);
        
        float perp_length = length(perp);
        vec4 v = clip_space_vertex;
        vec4 n = clip_space_widen;
        float denominator = dot(perp, screen_space_widen) / shift_pixels - n.w * v.w * perp_length;
        if (abs(denominator) > g_min_denominator)
        {
            float factor = v.w * v.w * perp_length / denominator;
            
            
            
            
            
            
            
            
            
            if (factor != factor){
                return limited_factor;
            }
            limited_factor = sign(factor) * min(g_max_factor, abs(factor));
        }
    }
    return limited_factor;
}
`,jz=`uniform mat4 u_mat4_model;
vec3 calc_pos_world(vec4 pos) {
    
    
    
    return (u_mat4_model * pos).xyz;
}
vec3 calc_pos_world(vec3 pos) {
    return calc_pos_world(vec4(pos, 1.0));
}
vec3 calc_pos_world(vec2 pos) {
    return calc_pos_world(vec4(pos, 0.0, 1.0));
}`,$z=`
const float g_circle_scale_precision_factor = 1e8;
`,Wz=`#ifdef WEBGL2
#define varying out
#define attribute in
#define texture2D texture
#endif
#ifdef UBO
uniform CommonSettings
{
    mediump float u_float_rounding_factor;
    mediump float u_float_border_width_offset;
    mediump vec2 u_vec2_scale_limits;
    mediump vec2 u_vec2_depth_test_half_point_size;
    
    mediump vec4 u_fog_color;
    mediump vec2 u_fog_limits;
    mediump float u_fog_horizon_blend;
    mediump float u_fog_horizon_level;
    mediump float u_fog_distance;
    mediump vec4 u_sky_color;
    highp vec3 u_cam_pos;
    
    
    
    
    
    
    mediump vec4 u_shadow_map_params;
    highp mat4 u_mat4_clip_to_shadow;
    mediump float u_shadow_bias;
    mediump mat4 u_mat4_view_transposed;
    mediump mat4 u_mat4_proj_inverted;
    
    mediump vec2 u_vec2_halo_viewport_size;
    mediump vec2 u_vec2_halo_viewport_center_shift;
    mediump vec4 u_vec4_halo_radius_stops;
    mediump vec4 u_vec4_halo_color;
    mediump float u_float_halo_exp_factor;
    mediump vec4 u_vec4_default_background_color;
    
    mediump mat4 u_mat4_stars;
    mediump float u_float_pixelratio;
    mediump float u_float_stars_intensity;
};
#endif
`,Zz=`
float unpack_scale(float value)
{
    return exp(abs(value) / 256.) * sign(value);
}
float unpack_positive_value(float value)
{
    return exp(value / 256.);
}
vec2 make_position(const vec2 position, const float w, const vec2 inv_half_size, const float rounding_factor)
{
    vec2 non_rounded_position = (position + w) / (w * inv_half_size);
    vec2 rounded_position = floor(non_rounded_position + 0.5);
    vec2 rounding_delta = rounded_position - non_rounded_position;
    vec2 pixel_coord = non_rounded_position + rounding_factor * rounding_delta - 0.5;
    return (pixel_coord * inv_half_size) * w - w;
}
vec2 overlay_transform(const vec2 position, const vec2 inv_half_size)
{
    
    
    return position * inv_half_size;
}
float clipw(const float w, const vec2 range, const float scale)
{
    return w * (step(unpack_scale(range.x), scale) - step(unpack_positive_value(range.y), scale));
}
vec2 rescale(const vec2 corner, const vec2 rescale, const vec2 scale_range, const float style_scale)
{
    
    
    if (scale_range.x < 0.)
    {
        float default_scale_denominator = unpack_positive_value(rescale.x);
        float rescale_coeff = unpack_positive_value(rescale.y);
        float min_scale = unpack_positive_value(-scale_range.x);
        float stretch_exponent = floor(0.5 + log2(
            max(1., 1. + rescale_coeff * (1. / max(min_scale, style_scale) - default_scale_denominator))));
        return corner.xy * exp2(stretch_exponent);
    }
    return corner;
}
`,Xz=`
vec4 round_position(const vec4 position, const vec2 half_viewport)
{
    if (
        position.w < 0.
        || position.x < -position.w
        || position.x > position.w
        || position.y < -position.w
        || position.y > position.w
        || position.z < -position.w
        || position.z > position.w)
    {
        return position;
    }
    else
    {
        
        return vec4(
            sign(position.xy) * floor(abs(position.xy) * half_viewport / position.w + .5)
                * position.w / half_viewport,
            position.zw);
    }
}
`,Yz=`#ifdef RENDER_SHADOWS
varying vec4 v_pos_from_light;
varying float v_depth_metric;
#ifndef UBO
uniform mat4 u_mat4_clip_to_shadow;
uniform mediump vec4 u_shadow_map_params;
uniform mediump float u_shadow_bias;
#endif
void compute_shadow_vertex(vec4 clip_pos)
{
    v_pos_from_light = u_mat4_clip_to_shadow * clip_pos;
    v_pos_from_light.z -= u_shadow_bias;
    v_depth_metric = 0.5 * v_pos_from_light.z + 0.5;
}
void compute_shadow_vertex(vec4 clip_pos, vec3 normal, mat4 mvp_mat)
{
    
    float normal_bias = u_shadow_map_params[3];
    vec3 norm_from_light = (u_mat4_clip_to_shadow * mvp_mat * vec4(normal, 0.0)).xyz;
    v_pos_from_light = u_mat4_clip_to_shadow * clip_pos;
    v_pos_from_light.xyz += normal_bias * normalize(norm_from_light);
    v_pos_from_light.z -= u_shadow_bias;
    v_depth_metric = 0.5 * v_pos_from_light.z + 0.5;
}
#else 
void compute_shadow_vertex(vec4 clip_pos) { }
void compute_shadow_vertex(vec4 clip_pos, vec3 normal, mat4 mvp_mat) { }
#endif `,qz=`struct PolylineDistance
{
    
    float vertex_distance_from_start;
    
    float segment_distance_from_start;
    
    float total_length;
};
struct StripedLineInParams
{
    float dash_length;
    float space_length;
    float dash2_length;
    float line_width;
};
struct StripedLineOutParams
{
    
    float part_color_swap_threshold;
    float distance_in_parts;
};
void calculate_line_params(in PolylineDistance polyline_distance, in StripedLineInParams striped_line_params, out StripedLineOutParams line_params)
{
    
    float requested_part_length =
        striped_line_params.dash_length
        + striped_line_params.space_length;
    
    float space2_length = requested_part_length - striped_line_params.dash2_length;
    
    float part_count = max(
        floor(polyline_distance.total_length / requested_part_length + 0.5),
        1.0);
    
    float part_length = polyline_distance.total_length / part_count;
    
    float dash_length = (part_length / requested_part_length) * striped_line_params.dash2_length;
    float part_color_swap_threshold = dash_length / part_length;
    
    
    float segment_start = fract((polyline_distance.segment_distance_from_start + 0.5 * dash_length) / part_length);
    float vertex_normalized_distance = segment_start + polyline_distance.vertex_distance_from_start / part_length;
    line_params = StripedLineOutParams(
        part_color_swap_threshold,
        vertex_normalized_distance);
}
`,Kz=`#include <prelude>
#include <mvp_mat>
#include <packed_attributes>
#include <pixel_offset>
#include <signed_distance_functions>
#include <arrow_functions>
#include <calculate_scale>
#include <apply_opacity>
#include <pos_world>
#include <cam_pos>
#include <fog>
#ifndef UBO
uniform float u_float_border_width_offset;
uniform vec2 u_vec2_scale_limits;
#endif
uniform vec4 u_vec4_color;
uniform vec4 u_vec4_border_color;
uniform mediump vec2 u_vec2_vpt_size;
uniform vec3 u_vec3_projection_scale_style_scale_dpi;
uniform float u_float_width_zpt;
uniform float u_float_wing_height_multiplier;
uniform float u_float_wing_width_multiplier;
uniform float u_float_border_width_zpt;
uniform float u_float_size_factor;
uniform float u_float_tip_height_multiplier;
uniform float u_float_relative_end_position;
uniform float u_float_tip_movement_amplitude;
uniform float u_float_vertex_shift; 
uniform float u_float_opacity;
uniform float u_float_tip_radius_zpt;
uniform float u_float_wing_radius_zpt;
uniform float u_float_tail_radius_zpt;
attribute vec2 a_vec2_vertex;
attribute vec2 a_vec2_segment_end;
attribute vec4 a_vec4_texture_widen_arrow_widen;
attribute vec2 a_vec2_widen;
attribute vec2 a_vec2_direction; 
attribute float a_float_distance_from_start;
attribute float a_float_object_length;
attribute float a_float_type;
attribute vec4 a_vec4_identifier; 
varying vec2 v_vec2_line_type_arrow_tail;
varying vec4 v_vec4_arrow_width_length_border_outer;
varying vec4 v_vec4_texcoord_arrow_line;
varying vec4 v_vec4_distance_vertex_hiding;
varying vec4 v_vec4_identifier;
varying vec4 v_vec4_color;
varying vec4 v_vec4_border_color;
#ifdef ENTRANCE_ARROWS_ROUNDING
varying vec3 v_vec3_radius_tip_wing_tail;
#endif
varying vec4 v_vec4_circle_center_tip_wing;
const float g_w_factor = 1e-7;
const float g_type_line = 0.;
const float g_type_arrow = 1.;
const float g_type_start_border = 2.;
const float g_type_line_ending = 3.;
const float g_type_line_cut = 4.;
const float g_shift_pixels = 2.;
const float g_line_overlapping_part = .2;
struct ArrowLineViewParameters
{
    float vertex_type;
    float width_zpt;
    float border_width_zpt;
    float border_width_offset;
    float tip_radius_zpt;
    float wing_radius_zpt;
    float tail_radius_zpt;
    float arrow_segment_length_zpt;
    float tip_height_multiplier;
    float wing_height_multiplier;
    float wing_width_multiplier;
    float size_factor;
    vec2 vertex_position;
    vec2 vertex_widen;
    vec2 line_texture_widen;
    vec2 arrow_texture_widen;
    vec2 segment_direction;
    float segment_length;
    float distance_to_end;
};
struct DistanceShiftParameters
{
    float shift;
    bool invisible;
};
vec2 perp(const vec2 vector)
{
    return vec2(-vector.y, vector.x);
}
vec2 vertex_shift(const Scale scale)
{
    return u_float_vertex_shift * u_float_tip_movement_amplitude * normalize_s08(a_vec2_direction) * scale.calculation;
}
vec2 arrow_shift(const ArrowLineViewParameters view)
{
    
    
    
    return view.segment_direction * view.distance_to_end;
}
float erase_length_end()
{
    return clamp(u_float_relative_end_position, 0., 1.) * a_float_object_length;
}
void set_texcoord_varyings(const vec2 arrow_texcoord, const vec2 line_texcoord)
{
    v_vec4_texcoord_arrow_line = vec4(arrow_texcoord, line_texcoord);
}
void set_arrow_varyings(
    const float arrow_width,
    const float arrow_length,
    const float arrow_border,
    const float arrow_outer_width,
    const float arrow_tail_hide_part,
    const float arrow_tip_radius,
    const float arrow_wing_radius,
    const float tail_radius,
    const vec2 tip_circle_center,
    const vec2 wing_circle_center)
{
    v_vec4_arrow_width_length_border_outer = vec4(
        arrow_width,
        arrow_length,
        arrow_border,
        arrow_outer_width);
    v_vec2_line_type_arrow_tail = vec2(
        a_float_type,
        arrow_tail_hide_part);
    #ifdef ENTRANCE_ARROWS_ROUNDING
    v_vec3_radius_tip_wing_tail = vec3(
        arrow_tip_radius,
        arrow_wing_radius,
        tail_radius);
    #endif
    v_vec4_circle_center_tip_wing = vec4(tip_circle_center.xy, wing_circle_center.xy);
}
DistanceShiftParameters calculate_entrance_arrow_distances(
    const ArrowLineViewParameters view,
    const float signed_distance_shift,
    const float arrow_final_size,
    const float entrance_arrow_distance_shift)
{
    DistanceShiftParameters line_distance_parameters = DistanceShiftParameters(
        signed_distance_shift + entrance_arrow_distance_shift,
        false);
    if (a_float_type == g_type_arrow)
    {
        
        
        bool outside_of_current_segment = view.distance_to_end > view.segment_length + entrance_arrow_distance_shift;
        
        bool inside_end_hide = a_float_distance_from_start + entrance_arrow_distance_shift > erase_length_end();
        return DistanceShiftParameters(
            
            line_distance_parameters.shift + view.distance_to_end,
            outside_of_current_segment || inside_end_hide
        );
    }
    else
    {
        return line_distance_parameters;
    }
}
void set_distance_varyings(
    const ArrowLineViewParameters view,
    const float arrow_final_size,
    const float signed_shift_distance)
{
    float entrance_arrow_distance_shift = arrow_final_size * (2. - g_line_overlapping_part);
    DistanceShiftParameters distance_shift_parameters = calculate_entrance_arrow_distances(
        view,
        signed_shift_distance,
        arrow_final_size,
        entrance_arrow_distance_shift);
    v_vec4_distance_vertex_hiding =
        vec4(
            a_float_distance_from_start + distance_shift_parameters.shift,
            0.,
            erase_length_end(),
            distance_shift_parameters.invisible
                ? a_float_object_length
                : 0.
        ) / a_float_object_length;
}
ArrowLineViewParameters decode_arrow_line_view_parameters()
{
    float width_zpt = u_float_width_zpt;
    float border_width_zpt = u_float_border_width_zpt;
    float arrow_segment_length_zpt = width_zpt * u_float_tip_height_multiplier + border_width_zpt;
    float vertex_type = a_float_type;
    
    vec2 segment_direction = (vertex_type == g_type_line_ending || vertex_type == g_type_line_cut)
        ? normalize(a_vec2_vertex - a_vec2_segment_end)
        : normalize(a_vec2_segment_end - a_vec2_vertex);
    float segment_length = length(a_vec2_segment_end - a_vec2_vertex);
    float distance_to_end = erase_length_end() - a_float_distance_from_start;
    return ArrowLineViewParameters(
        vertex_type,
        width_zpt,
        border_width_zpt,
        u_float_border_width_offset,
        u_float_tip_radius_zpt,
        u_float_wing_radius_zpt,
        u_float_tail_radius_zpt,
        arrow_segment_length_zpt,
        u_float_tip_height_multiplier,
        u_float_wing_height_multiplier,
        u_float_wing_width_multiplier,
        u_float_size_factor,
        a_vec2_vertex,
        unpack_widen(a_vec2_widen),
        unpack_widen(a_vec4_texture_widen_arrow_widen.xy),
        unpack_widen(a_vec4_texture_widen_arrow_widen.zw),
        segment_direction,
        segment_length,
        distance_to_end);
}
vec4 process_arrow_line_vertex(const Scale scale, const mat4 mvp, const vec2 vpt_size)
{
    ArrowLineViewParameters view = decode_arrow_line_view_parameters();
    
    ArrowParameters arrow_parameters = calculate_arrow_parameters(
        scale.calculation,
        view.width_zpt,
        view.border_width_zpt,
        view.arrow_segment_length_zpt,
        view.wing_width_multiplier,
        view.wing_height_multiplier,
        view.tip_height_multiplier,
        view.size_factor);
    vec2 vertex_widen = view.vertex_widen;
    vec2 texture_widen_with_sign = view.line_texture_widen;
    
    
    float shift_sign = sign(dot(vertex_widen, texture_widen_with_sign));
    vec2 line_texture_widen = shift_sign * texture_widen_with_sign;
    
    float line_final_size = (view.width_zpt + 2. * view.border_width_zpt) * view.size_factor * scale.calculation;
    float final_size = (view.vertex_type == g_type_arrow)
        ? arrow_parameters.final_size
        : line_final_size;
    
    
    
    
    vec2 line_texture_widen_perp = perp(line_texture_widen);
    float shift_distance = abs(dot(vertex_widen, line_texture_widen_perp)) * final_size;
    vec2 shift_direction = line_texture_widen_perp * sign(dot(vertex_widen, line_texture_widen_perp));
    vec2 line_vertex_shift = vertex_widen * final_size - shift_direction * max(0., shift_distance - .5 * view.segment_length);
    
    vec2 arrow_vertex_widen = vertex_widen * arrow_parameters.final_size;
    vec2 scene_vertex_shift = (view.vertex_type == g_type_arrow)
        ? arrow_vertex_widen
        : line_vertex_shift;
    vec2 arrow_position_shift = (view.vertex_type == g_type_arrow)
        ? arrow_shift(view)
        : vec2(0.);
    
    float shift_pixels = g_shift_pixels * sqrt(2.);
    VertexShiftParameters line_shift_parameters = calculate_vertex_shift_parameters(
        mvp,
        vpt_size,
        view.vertex_position + (vertex_shift(scale) + arrow_position_shift),
        scene_vertex_shift,
        shift_pixels);
    float arrow_line_texcoord_scale = line_final_size / arrow_parameters.final_size;
    float line_texcoord_scale = (view.vertex_type != g_type_arrow)
        ? arrow_line_texcoord_scale
        : 1.;
    vec2 line_texcoord = line_texture_widen * (1. + line_shift_parameters.limited_factor) * line_texcoord_scale;
    
    float arrow_texcoord_scale = (view.vertex_type == g_type_start_border)
        ? arrow_line_texcoord_scale
        : 1.;
    vec2 arrow_texcoord = view.arrow_texture_widen * (1. + line_shift_parameters.limited_factor) * arrow_texcoord_scale;
    set_texcoord_varyings(arrow_texcoord, line_texcoord);
    float arrow_width = view.width_zpt * arrow_parameters.zpt_to_texcoord_factor;
    float arrow_length = view.arrow_segment_length_zpt * arrow_parameters.zpt_to_texcoord_factor;
    float arrow_tip_radius = view.tip_radius_zpt * arrow_parameters.zpt_to_texcoord_factor;
    float arrow_wing_radius = view.wing_radius_zpt * arrow_parameters.zpt_to_texcoord_factor;
    float tail_radius = view.tail_radius_zpt * arrow_parameters.zpt_to_texcoord_factor;
    
    float texcoord_border_width = view.border_width_zpt * arrow_parameters.zpt_to_texcoord_factor;
    float border_width_texcoord_offset = view.border_width_offset * arrow_parameters.zpt_to_texcoord_factor;
    float arrow_border = max(0., texcoord_border_width - scale.style / scale.style_clamped * border_width_texcoord_offset);
    
    float tail_shift_direction = (view.vertex_type == g_type_line_ending || view.vertex_type == g_type_start_border) ? 1. : -1.;
    float tail_hide_shift = dot(arrow_vertex_widen, tail_shift_direction * view.segment_direction);
    float arrow_tail_hide_part = (view.distance_to_end - tail_hide_shift) * arrow_parameters.zpt_to_texcoord_factor / view.size_factor;
    
    
    float half_length = arrow_length / 2.;
    float arrow_height = arrow_width * (view.tip_height_multiplier - view.wing_height_multiplier);
    float A1 = arrow_parameters.tip_normal.x;
    float B1 = arrow_parameters.tip_normal.y;
    float C1 = -half_length * A1 - arrow_border + arrow_wing_radius;
    float A2 = arrow_parameters.wing_normal.x;
    float B2 = arrow_parameters.wing_normal.y;
    float C2 = (arrow_height - half_length) * A2 - arrow_border + arrow_wing_radius;
    float denominator = A1 * B2 - A2 * B1;
    float wing_circle_center_x = (C2 * B1 - C1 * B2) / denominator;
    float wing_circle_center_y = (A2 * C1 - A1 * C2) / denominator;
    vec2 wing_circle_center = vec2(wing_circle_center_x, wing_circle_center_y);
    vec2 tip_circle_center = vec2(half_length - (arrow_tip_radius - arrow_border) / arrow_parameters.tip_normal.x, 0.);
    set_arrow_varyings(
        arrow_width,
        arrow_length,
        arrow_border,
        arrow_parameters.outer_width,
        arrow_tail_hide_part,
        arrow_tip_radius,
        arrow_wing_radius,
        tail_radius,
        tip_circle_center,
        wing_circle_center);
    set_distance_varyings(
        view,
        arrow_parameters.final_size,
        shift_sign * shift_distance);
    
    
    return line_shift_parameters.clip_space_vertex / final_size;
}
void main()
{
    v_vec4_identifier = a_vec4_identifier; 
    Scale scale = calculate_scale(u_vec3_projection_scale_style_scale_dpi, u_vec2_scale_limits);
    vec4 processed_vertex = process_arrow_line_vertex(scale, u_mat4_mvp, u_vec2_vpt_size);
    gl_Position = processed_vertex * g_w_factor;
    v_vec4_color = apply_opacity(u_vec4_color, u_float_opacity);
    v_vec4_border_color = apply_opacity(u_vec4_border_color, u_float_opacity);
    
    vec3 pos_world = calc_pos_world(a_vec2_vertex);
    calc_fog_pos(pos_world);
}
`,Jz=`#include <prelude>
#include <mvp_mat>
#include <dem>
#include <apply_height_factor>
uniform float u_float_height_factor;
uniform float u_float_floor_elevation;
attribute vec3 a_vec3_vertex;
attribute vec2 a_vec2_dem_position;
attribute float a_float_visibility;
varying float v_depth_metric;
void main()
{
    float height = dem_height(unpack_dem_position(a_vec2_dem_position));
    
    
    
    if (height == DEM_INVALID_VALUE || a_float_visibility == 0.0) {
        gl_Position = vec4(0, 0, 1, 1);
        return;
    }
    height += u_float_floor_elevation;
    vec4 vertex_hf = apply_height_factor(a_vec3_vertex, u_float_height_factor);
    vertex_hf.z += height;
    
    vertex_hf.z = max(vertex_hf.z, height);
    gl_Position = u_mat4_mvp * vertex_hf;
    v_depth_metric = (gl_Position.z + 1.0) / 2.0;
}`,Qz=`#include <prelude>
#include <ecef_mvp_mat>
#include <pos_world>
#include <cam_pos>
#include <shadow>
#include <fog>
attribute vec3 a_vec3_flat_position;
attribute vec3 a_vec3_ecef_position;
attribute vec2 a_vec2_widen;
uniform vec2 u_vec2_vpt_size;
uniform float u_float_width;
varying vec2 v_vec2_circle;
varying float v_float_width;
void main() {
    vec4 pos = get_clipspace(a_vec3_flat_position, a_vec3_ecef_position);
    vec4 ndc_position = pos / pos.w;
    ndc_position.xy += a_vec2_widen * u_float_width / u_vec2_vpt_size;
    gl_Position = ndc_position;
    v_vec2_circle = a_vec2_widen;
    v_float_width = u_float_width;
    vec3 pos_world = calc_pos_world(a_vec3_flat_position);
    calc_fog_pos(pos_world);
}
`,eB=`#include <prelude>
#include <ecef_mvp_mat>
attribute vec3 a_vec3_flat_position;
attribute vec3 a_vec3_ecef_position;
attribute vec2 a_vec2_widen;
attribute vec4 a_vec4_identifier;
uniform vec2 u_vec2_vpt_size;
uniform float u_float_width;
varying vec2 v_vec2_circle;
varying vec4 v_vec4_identifier;
void main() {
    v_vec2_circle = a_vec2_widen;
    v_vec4_identifier = a_vec4_identifier;
    if (vec4(1., 1., 1., 1.) != a_vec4_identifier)
    {
        vec4 pos = get_clipspace(a_vec3_flat_position, a_vec3_ecef_position);
        vec4 ndc_position = pos / pos.w;
        ndc_position.xy += a_vec2_widen * u_float_width / u_vec2_vpt_size;
        gl_Position = ndc_position;
    }
    else
    {
        gl_Position = vec4(1., 1., 1., 1.);
    }
}
`,tB=`#include <prelude>
#include <mvp_mat>
#include <apply_opacity>
#include <pos_world>
#include <cam_pos>
#include <fog>
#include <jitter>
#include <shadow>
uniform vec4 u_vec4_color;
uniform float u_float_opacity;
uniform float u_float_floor_elevation;
attribute vec2 a_vec2_vertex;
attribute float a_float_visibility;
varying vec4 v_vec4_color;
varying vec2 v_vec2_texcoord;
void main()
{
    if (a_float_visibility == 0.0) {
        gl_Position = vec4(0, 0, 0, 1);
        return;
    }
    v_vec4_color = apply_opacity(u_vec4_color, u_float_opacity);
    gl_Position = u_mat4_mvp * vec4(a_vec2_vertex, u_float_floor_elevation, 1.0);
    vec3 pos_world = calc_pos_world(a_vec2_vertex);
    calc_fog_pos(pos_world);
    
    
    
    
    
    
    v_vec2_texcoord = fract(abs((a_vec2_vertex - 0.25) * 2.));
#ifdef TAA
    apply_vertex_jitter(gl_Position);
#endif
    compute_shadow_vertex(gl_Position, vec3(0.0, 0.0, 1.0), u_mat4_mvp);
}
`,nB=`#include <prelude>
#include <mvp_mat>
#include <round_position>
uniform vec2 u_vec2_vpt_size;
uniform float u_float_floor_elevation;
attribute vec2 a_vec2_vertex;
attribute vec4 a_vec4_identifier;
attribute float a_float_visibility;
varying vec4 v_vec4_identifier;
void main()
{
    v_vec4_identifier = a_vec4_identifier;
    if (vec4(1., 1., 1., 1.) != a_vec4_identifier && a_float_visibility != 0.0)
    {
        gl_Position = round_position(u_mat4_mvp * vec4(a_vec2_vertex, u_float_floor_elevation, 1.), .5 * u_vec2_vpt_size);
    }
    else
    {
        gl_Position = vec4(1., 1., 1., 1.);
    }
}
`,iB=`#include <prelude>
#include <mvp_mat>
#include <packed_attributes>
attribute vec2 a_vec2_vertex;
attribute float a_float_height;
varying float v_float_height;
void main()
{
    gl_Position = u_mat4_mvp * vec4(a_vec2_vertex, 0.0, 1.0);
    v_float_height = a_float_height;
}
`,oB=`#include <prelude>
#include <mvp_mat>
#include <packed_attributes>
uniform mat4 u_mat4_dem_corrected;
attribute vec2 a_vec2_vertex;
attribute vec2 a_vec2_texcoord;
varying vec2 v_vec2_texcoord;
void main()
{
    gl_Position = u_mat4_mvp * vec4(a_vec2_vertex, 0.0, 1.0);
    v_vec2_texcoord = (u_mat4_dem_corrected * vec4(unpack_texcoord(a_vec2_texcoord), 0, 1)).xy;
}
`,rB=`#include <prelude>
#include <mvp_mat>
#include <dem>
attribute vec2 a_vec2_vertex;
attribute vec2 a_vec2_centroid;
attribute vec2 a_vec2_extender;
varying vec4 v_vec4_color;
void main()
{
    vec4 tex_pos = u_mat4_dem_corrected * u_mat4_mvp * vec4(unpack_dem_position(a_vec2_centroid), 0.0, 1.0);
    v_vec4_color = texture2D(u_tex_dem, tex_pos.xy);
    gl_Position = u_mat4_mvp * vec4(a_vec2_vertex + a_vec2_extender * 1./64., 0.0, 1.0);
}
`,sB=`#include <prelude>
#include <mvp_mat>
#include <dem>
uniform mat4 u_mat4_model;
attribute vec2 a_vec2_position;
varying vec4 v_vec4_coords;
void main()
{
    vec4 tex_pos = u_mat4_dem_mvp * vec4(a_vec2_position, 0.0, 1.0);
    float height = dem_height_direct_meters(tex_pos.xy / tex_pos.w);
    if (height == DEM_INVALID_VALUE) {
        gl_Position = u_mat4_mvp * vec4(a_vec2_position, 0.0, 1.0);
        v_vec4_coords = vec4(0);
    } else {
        float tile_height = meters_to_tile_height(height);
        gl_Position = u_mat4_mvp * vec4(a_vec2_position, tile_height, 1.0);
        v_vec4_coords = u_mat4_model * vec4(a_vec2_position, 0, 1.0);
        
        v_vec4_coords[2] = height;
    }
}
`,aB=`#include <prelude>
#include <mvp_mat>
#include <dem>
uniform mat4 u_mat4_model;
attribute vec2 a_vec2_vertex;
attribute float a_float_height;
varying vec4 v_vec4_coords;
void main()
{
    float tile_height = meters_to_tile_height(a_float_height);
    gl_Position = u_mat4_mvp * vec4(a_vec2_vertex, tile_height, 1.0);
    v_vec4_coords = u_mat4_model * vec4(a_vec2_vertex, 0, 1.0);
    
    v_vec4_coords[2] = a_float_height;
}
`,lB=`#include <prelude>
#include <mvp_mat>
#include <dem>
#include <pos_world>
#include <cam_pos>
#include <shadow>
#include <fog>
#include <jitter>
uniform mat4 u_mat4_flat_map_mvp;
attribute vec2 a_vec2_position;
varying vec4 v_vec4_texcoord;
varying vec2 hs_tex_pos;
void main()
{
    vec4 coords = u_mat4_mvp * vec4(a_vec2_position, 0.0, 1.0);
    vec4 tex_pos = u_mat4_dem_mvp * vec4(a_vec2_position, 0.0, 1.0);
    float height = dem_height_direct(tex_pos.xy / tex_pos.w);
    if (height == DEM_INVALID_VALUE) {
        gl_Position = coords;
        v_vec4_texcoord = vec4(a_vec2_position, 1., 0);
    } else {
        gl_Position = u_mat4_mvp * vec4(a_vec2_position, height, 1.0);
        vec4 flat_coord = u_mat4_flat_map_mvp * vec4(a_vec2_position, 0.0, 1.0);
        v_vec4_texcoord = vec4(flat_coord.xy, 0., flat_coord.w);
        hs_tex_pos = tex_pos.xy;
    }
    vec3 pos_world = calc_pos_world(vec4(a_vec2_position, height, 1.0));
    calc_fog_pos(pos_world);
#ifdef TAA
    apply_vertex_jitter(gl_Position);
#endif
    
    compute_shadow_vertex(gl_Position, vec3(0.0, 0.0, 1.0), u_mat4_mvp);
}
`,cB=`#include <prelude>
#include <mvp_mat>
#include <dem>
#include <pos_world>
#include <cam_pos>
#include <shadow>
#include <fog>
#include <jitter>
uniform mat4 u_mat4_flat_map_mvp;
attribute vec2 a_vec2_vertex;
attribute float a_float_height;
attribute vec3 a_vec3_normal;
varying vec4 v_vec4_texcoord;
varying vec3 v_vec3_position;
varying vec3 v_vec3_normal;
uniform mediump float u_use_flat_dem_mesh_normals;
void main() {
    
    
    v_vec3_normal = a_vec3_normal;
    float height_tile = meters_to_tile_height(a_float_height);
    vec4 tex_pos = u_mat4_dem_mvp * vec4(a_vec2_vertex, 0.0, 1.0);
    gl_Position = u_mat4_mvp * vec4(a_vec2_vertex, height_tile, 1.0);
    vec4 flat_coord = u_mat4_flat_map_mvp * vec4(a_vec2_vertex, 0., 1.0);
    v_vec4_texcoord = vec4(flat_coord.xy, 1., flat_coord.w);
    vec3 pos_world = calc_pos_world(vec4(a_vec2_vertex, height_tile, 1.0));
    
    
    mat4 rotation_scale_mat = u_mat4_model;
    rotation_scale_mat[3].xyz = vec3(0);
    v_vec3_position = (rotation_scale_mat * vec4(a_vec2_vertex, height_tile, 1)).xyz;
    calc_fog_pos(pos_world);
#ifdef TAA
    apply_vertex_jitter(gl_Position);
#endif
    
    compute_shadow_vertex(gl_Position, vec3(0.0, 0.0, 1.0), u_mat4_mvp);
}
`,dB=`#include <prelude>
#include <mvp_mat>
#include <packed_attributes>
attribute vec2 a_vec2_vertex;
attribute vec2 a_vec2_texcoord;
varying vec2 v_vec2_texcoord;
void main()
{
    gl_Position = vec4((a_vec2_vertex * 2. - vec2(1, 1)), 0.0, 1.0);
    v_vec2_texcoord = unpack_texcoord(a_vec2_texcoord);
}
`,uB=`#include <prelude>
#include <mvp_mat>
#include <dem>
#include <packed_attributes>
#include <apply_height_factor>
#include <apply_opacity>
#include <pos_world>
#include <cam_pos>
#include <fog>
#include <clipspace_pos>
#include <jitter>
#include <shadow>
uniform vec4 u_vec4_color;
uniform mat4 u_mat4_gradient;
uniform float u_float_height_factor;
uniform float u_float_opacity;
uniform float u_float_floor_elevation;
attribute vec4 a_vec4_vertex; 
attribute vec2 a_vec2_dem_position;
attribute float a_float_visibility;
varying vec4 v_vec4_color;
varying mat4 v_mat4_gradient;
varying vec4 v_vec4_rotated_scaled_vertex;
const float g_wall_offset_isometric = .001;
const float g_wall_offset_perspective = 8.;
void main()
{
    float height = dem_height(unpack_dem_position(a_vec2_dem_position));
    
    
    
    if (height == DEM_INVALID_VALUE || a_float_visibility == 0.0) {
        gl_Position = vec4(0, 0, 1, 1);
        return;
    }
    height += u_float_floor_elevation;
    vec4 vertex_hf = apply_height_factor(a_vec4_vertex.xyz, u_float_height_factor);
    vertex_hf.z += height;
    
    vertex_hf.z = max(vertex_hf.z, height);
    vec4 clip_pos = u_mat4_mvp * vertex_hf;
    gl_Position = clip_pos;
    
    
    
    if (a_vec4_vertex.w == .0)
    {
        
        if ((u_mat4_mvp[0][3] == 0.) && (u_mat4_mvp[1][3] == 0.) && (u_mat4_mvp[2][3] == 0.))
        {
            gl_Position.z += g_wall_offset_isometric;
        }
        else
        {
            
            
            
            if (height == 0.) {
                gl_Position.z += g_wall_offset_perspective;
            } else {
                gl_Position.z += g_wall_offset_isometric;
            }
        }
    }
    vec3 pos_world = calc_pos_world(vertex_hf);
    calc_fog_pos(pos_world);
    save_clipspace_pos();
#ifdef TAA
    apply_vertex_jitter(gl_Position);
#endif
    
    
    mat4 rotation_scale_mat = u_mat4_model;
    rotation_scale_mat[3].xyz = vec3(0);
    v_vec4_rotated_scaled_vertex.xyz = (rotation_scale_mat * a_vec4_vertex).xyz;
    v_vec4_color = apply_opacity(u_vec4_color, u_float_opacity);
    if (u_mat4_gradient[0][0] !=0.)
    {
        
        if (a_vec4_vertex.z > 0.0)
        {
            v_vec4_rotated_scaled_vertex.w = 1.;
        } else {
            v_vec4_rotated_scaled_vertex.w = 0.;
        }
        v_mat4_gradient = u_mat4_gradient;
        for (int i = 1; i <= 2; i++) {
            v_mat4_gradient[i] = apply_opacity(v_mat4_gradient[i], u_float_opacity);
        }
    }
    
    compute_shadow_vertex(clip_pos);
}
`,fB=`#include <prelude>
#include <mvp_mat>
#include <dem>
#include <round_position>
#include <apply_height_factor>
uniform vec2 u_vec2_vpt_size;
uniform float u_float_height_factor;
uniform float u_float_floor_elevation;
attribute vec3 a_vec4_vertex;
attribute vec4 a_vec4_identifier;
attribute vec2 a_vec2_dem_position;
attribute float a_float_visibility;
varying vec4 v_vec4_identifier;
void main()
{
    float height = dem_height(unpack_dem_position(a_vec2_dem_position));
    
    
    
    
    if (height == DEM_INVALID_VALUE || a_float_visibility == 0.0 || a_vec4_identifier == vec4(1., 1., 1., 1.)) {
        gl_Position = vec4(0, 0, 1, 1);
        return;
    }
    height += u_float_floor_elevation;
    v_vec4_identifier = a_vec4_identifier;
    vec4 vertex_hf = apply_height_factor(a_vec4_vertex.xyz, u_float_height_factor);
    vertex_hf.z += height;
    
    vertex_hf.z = max(vertex_hf.z, height);
    gl_Position = round_position(
        u_mat4_mvp * vertex_hf,
        .5 * u_vec2_vpt_size);
}
`,hB=`#include <prelude>
#include <ecef_mvp_mat>
attribute vec3 a_vec3_ecef_position;
attribute vec3 a_vec3_flat_position;
attribute vec2 a_vec2_texture;
uniform vec4 u_vec4_extent;
varying vec2 v_vec2_texture;
void main()
{
    v_vec2_texture = a_vec2_texture;
    vec4 pos = get_clipspace(a_vec3_flat_position, a_vec3_ecef_position);
    gl_Position = pos;
}`,_B=`#include <prelude>
#ifndef UBO
uniform mediump vec2 u_vec2_halo_viewport_size;
uniform mediump vec2 u_vec2_halo_viewport_center_shift;
uniform mediump vec4 u_vec4_halo_radius_stops;
uniform mediump float u_float_halo_exp_factor;
#endif
attribute vec2 a_vec2_vertex;
varying vec2 v_vec2_uv;
void main() {
    
    
    
    
    
    
    
    float globe_halo_padding_factor = log(0.005) / u_float_halo_exp_factor;
    
    vec4 pixel_radius_stops = u_vec4_halo_radius_stops * u_vec2_halo_viewport_size.y;
    
    
    
    
    float maxR = pixel_radius_stops[1] + (pixel_radius_stops[3] - pixel_radius_stops[1]) * globe_halo_padding_factor;
    
    float scale = maxR / u_vec2_halo_viewport_size.y;
    v_vec2_uv = a_vec2_vertex * scale;
    vec2 center = u_vec2_halo_viewport_size / 2.0 + u_vec2_halo_viewport_center_shift;
    vec2 p = center - a_vec2_vertex * maxR;
    vec2 p_result = 2.0 * (p - 0.5 * u_vec2_halo_viewport_size) / u_vec2_halo_viewport_size;
    gl_Position = vec4(p_result, 0.0, 1.0);
}
`,mB=`#include <prelude>
#include <ecef_mvp_mat>
#include <dem>
#include <packed_attributes>
#include <pos_world>
#include <cam_pos>
#include <fog>
#include <clipspace_pos>
#include <jitter>
#include <shadow>
#define EPSILON (0.0001)
#define DEM_POS_INSTANCE 0
#define DEM_POS_FLAT 1
#define DEM_POS_AXIS 2
#define DEM_POS_CENTROID 3
uniform mat4 u_mat4_instance;
uniform vec2 u_vec2_anchor;
uniform vec4 u_vec4_axis;
uniform int u_int_gltf_dem_pos;
uniform mat4 u_mat4_localmatrix;
uniform float u_float_height_factor;
uniform float u_float_show_ratio;
uniform mediump int u_int_identify;
uniform float u_float_floor_elevation;
attribute vec3 a_position;
attribute vec3 a_normal;
attribute vec2 a_tangent;
attribute vec3 a_vec3_instance_position;
#ifndef MALI_GPU
attribute vec3 a_vec3_instance_ecef_position;
#endif
attribute mat3 a_mat3_instance_matrix;
attribute vec4 a_vec4_instance_localid;
attribute float a_float_abs_z;
#ifdef COLOR_TEXTURE
attribute vec2 texcoord_color;
#endif
#ifdef AO_TEXTURE
attribute vec2 texcoord_ao;
#endif
#ifdef PBR_TEXTURE
attribute vec2 texcoord_pbr;
#endif
varying vec4 v_vec4_identifier;
varying vec3 v_vec3_normal;
varying vec3 v_vec3_fragment_pos_world;
#ifdef MAP_MESH_TEXTURE
varying vec4 v_tex_coord;
#endif
#ifdef COLOR_TEXTURE
varying vec2 v_vec2_texcoord_color;
#endif
#ifdef AO_TEXTURE
varying vec2 v_vec2_texcoord_ao;
#endif
#ifdef PBR_TEXTURE
varying vec2 v_vec2_texcoord_pbr;
#endif
varying float v_float_opacity;
void calc_texcoords(vec4 vh) {
    #ifdef MAP_MESH_TEXTURE
    v_tex_coord = u_mat4_mvp * vec4(vh.xy, 0, 1.0);
    #endif
    #if defined(COLOR_TEXTURE)
    v_vec2_texcoord_color = texcoord_color;
    #endif
    #ifdef AO_TEXTURE
    v_vec2_texcoord_ao = texcoord_ao;
    #endif
    #ifdef PBR_TEXTURE
    v_vec2_texcoord_pbr = texcoord_pbr;
    #endif
}
float interleaved_gradient_noise(vec3 coords)
{
    const vec3 m = vec3(0.06711056, 0.00583715, 52.9829189);
    return fract(m.z * fract(dot(coords.xy, m.xy)));
}
const float FADE_AMMOUNT = 0.12;
void main()
{
    if (u_int_identify != 0 && a_vec4_instance_localid == vec4(1., 1., 1., 1.)) {
        gl_Position = vec4(0, 0, 0, 0);
        return;
    }
    mat4 instance_matrix = mat4(
        vec4(a_mat3_instance_matrix[0], 0),
        vec4(a_mat3_instance_matrix[1], 0),
        vec4(a_mat3_instance_matrix[2], 0),
        vec4(0, 0, 0, 1)
    );
    float height = 0.;
    
    if (u_int_gltf_dem_pos == DEM_POS_CENTROID) {
        vec4 center = (instance_matrix * u_mat4_localmatrix) * vec4(u_vec2_anchor.x, 0, u_vec2_anchor.y, 1);
        center *= u_mat4_instance;
        center.xy += a_vec3_instance_position.xy;
        height = dem_height(center.xy);
    } else if (u_int_gltf_dem_pos == DEM_POS_AXIS)  {
        vec2 a = a_position.xz - u_vec4_axis.xy;
        vec2 b = u_vec4_axis.zw - u_vec4_axis.xy;
        float b_length = length(b);
        a /= b_length;
        b /= b_length;
        float coef = clamp(dot(a, b), 0., 1.);
        vec4 axis_start = (instance_matrix * u_mat4_localmatrix) * vec4(u_vec4_axis.x, 0, u_vec4_axis.y, 1);
        axis_start *= u_mat4_instance;
        axis_start.xy += a_vec3_instance_position.xy;
        float height_start = dem_height(axis_start.xy);
        vec4 axis_end = (instance_matrix * u_mat4_localmatrix) * vec4(u_vec4_axis.z, 0, u_vec4_axis.w, 1);
        axis_end *= u_mat4_instance;
        axis_end.xy += a_vec3_instance_position.xy;
        float height_end = dem_height(axis_end.xy);
        height = mix(height_start, height_end, coef);
    } else if (u_int_gltf_dem_pos == DEM_POS_FLAT) {
        vec4 pos = (instance_matrix * u_mat4_localmatrix) * vec4(a_position, 1);
        pos *= u_mat4_instance;
        pos.xy += a_vec3_instance_position.xy;
        height = dem_height(pos.xy);
    } else {
        height = dem_height(a_vec3_instance_position.xy);
    }
    
    if (height == DEM_INVALID_VALUE) {
        gl_Position = vec4(0, 0, 1, 1);
        return;
    }
    height += u_float_floor_elevation;
    if (u_float_show_ratio < 1.0) {
        vec3 instance_wp = a_mat3_instance_matrix * a_vec3_instance_position;
        float noise = interleaved_gradient_noise(instance_wp);
        if (noise > u_float_show_ratio) {
            gl_Position = vec4(0,0,0,0);
            return;
        }
        v_float_opacity = clamp(u_float_show_ratio - noise, 0., FADE_AMMOUNT) / FADE_AMMOUNT;
    } else {
        v_float_opacity = 1.;
    }
    v_vec4_identifier = a_vec4_instance_localid;
    vec4 vertex = (instance_matrix * u_mat4_localmatrix) * vec4(a_position, 1.);
    vertex *= u_mat4_instance;
    vertex.xyz *= v_float_opacity;
    vertex.z *= u_float_height_factor;
    vec4 vflat = vec4(a_vec3_instance_position, 1.);
    vflat.z += height;
    vflat.xyz += vertex.xyz;
    vec3 pos_world = calc_pos_world(vflat);
    calc_fog_pos(pos_world);
#ifdef MALI_GPU
    
    
    
    gl_Position = get_clipspace(vflat.xyz);
#else
    vec4 vecef = vec4(a_vec3_instance_ecef_position, 1.);
    vecef.xyz += vertex.xyz;
    gl_Position = get_clipspace(vflat.xyz, vecef.xyz, a_float_abs_z);
#endif
    calc_texcoords(vflat);
    
    v_vec3_normal = ((instance_matrix * u_mat4_localmatrix) * vec4(a_normal, 0)).xyz;
    v_vec3_fragment_pos_world = pos_world;
#ifdef TAA
    apply_vertex_jitter(gl_Position);
#endif
    save_clipspace_pos();
    compute_shadow_vertex(gl_Position, v_vec3_normal, u_mat4_flat_mvp);
}
`,pB=`#include <prelude>
#include <ecef_mvp_mat>
#include <dem>
#include <packed_attributes>
uniform mat4 u_mat4_instance;
uniform mat4 u_mat4_localmatrix;
uniform float u_float_height_factor;
uniform float u_float_show_ratio;
attribute vec3 a_position;
attribute vec3 a_vec3_instance_position;
#ifndef MALI_GPU
attribute vec3 a_vec3_instance_ecef_position;
#endif
attribute mat3 a_mat3_instance_matrix;
attribute float a_float_abs_z;
varying float v_depth_metric;
const float FADE_AMMOUNT = 0.12;
float interleaved_gradient_noise(vec3 coords)
{
    const vec3 m = vec3(0.06711056, 0.00583715, 52.9829189);
    return fract(m.z * fract(dot(coords.xy, m.xy)));
}
void main()
{
    float height = dem_height(a_vec3_instance_position.xy);
    
    if (height == DEM_INVALID_VALUE) {
        gl_Position = vec4(0, 0, 1, 1);
        return;
    }
    float opacity = 1.0;
    if (u_float_show_ratio < 1.0) {
        vec3 instance_wp = a_mat3_instance_matrix * a_vec3_instance_position;
        float noise = interleaved_gradient_noise(instance_wp);
        if (noise > u_float_show_ratio) {
            gl_Position = vec4(0,0,0,0);
            return;
        }
        opacity = clamp(u_float_show_ratio - noise, 0., FADE_AMMOUNT) / FADE_AMMOUNT;
    }
    mat4 instance_matrix = mat4(
        vec4(a_mat3_instance_matrix[0], 0),
        vec4(a_mat3_instance_matrix[1], 0),
        vec4(a_mat3_instance_matrix[2], 0),
        vec4(0, 0, 0, 1)
    );
    vec4 vertex = (instance_matrix * u_mat4_localmatrix) * vec4(a_position, 1);
    vertex *= u_mat4_instance;
    vertex.xyz *= opacity;
    vertex.z *= u_float_height_factor;
    vec4 vflat = vec4(a_vec3_instance_position, 1.);
    vflat.z += height;
    vflat.xyz += vertex.xyz;
#ifdef MALI_GPU
    
    
    
    gl_Position = get_clipspace(vflat.xyz);
#else
    vec4 vecef = vec4(a_vec3_instance_ecef_position, 1.);
    vecef.xyz += vertex.xyz;
    gl_Position = get_clipspace(vflat.xyz, vecef.xyz, a_float_abs_z);
#endif
    v_depth_metric = (gl_Position.z + 1.0) / 2.0;
}
`,gB=`#include <prelude>
#include <mvp_mat>
#include <pos_world>
#include <cam_pos>
#include <fog>
attribute vec2 a_vec2_position;
attribute vec2 a_vec2_widen;
attribute float a_float_weight;
varying vec2 v_vec2_extrude;
varying float v_float_weight;
uniform float u_float_radius;
uniform float u_float_intensity;
uniform float u_float_tile_to_pixel_ratio;
const highp float ZERO = 1.0 / 255.0 / 16.0;
#define GAUSS_COEF 0.3989422804014327
void main(void) {
    float S = sqrt(-2.0 * log(ZERO / a_float_weight / u_float_intensity / GAUSS_COEF)) / 3.0;
    v_vec2_extrude = S * a_vec2_widen;
    v_float_weight = a_float_weight;
    vec2 pos = a_vec2_position + a_vec2_widen * u_float_radius * u_float_tile_to_pixel_ratio;
    calc_fog_pos(calc_pos_world(pos));
    gl_Position = u_mat4_mvp * vec4(pos, 0.0, 1.0);
}
`,vB=`#include <prelude>
#include <pos_world>
#include <cam_pos>
#include <fog>
attribute vec2 a_vec2_position;
varying vec2 v_vec2_position;
void main() {
    gl_Position = vec4(a_vec2_position, 0.0, 1.0);
    v_vec2_position = clamp(a_vec2_position, vec2(0,0), vec2(1,1));
}
`,yB=`#include <prelude>
#include <mvp_mat>
#include <packed_attributes>
#include <pos_world>
#include <cam_pos>
#include <fog>
attribute vec4 a_vec4_position;
attribute vec2 a_vec2_offset;
attribute vec2 a_vec2_texcoord;
attribute vec2 a_vec2_style_zoom_limits;
uniform float u_float_style_zoom;
uniform float u_float_scale;
uniform float u_float_tile_to_pixel_ratio;
varying vec2 v_vec2_texcoord;
float clipw(const float w, const vec2 range, const float zoom) {
    return w * (step(range.x, zoom) - step(range.y, zoom));
}
void main() {
    vec4 newPosition = a_vec4_position;
    newPosition.xy += a_vec2_offset * u_float_scale * u_float_tile_to_pixel_ratio;
    vec3 pos_world = calc_pos_world(newPosition);
    calc_fog_pos(pos_world);
    newPosition = u_mat4_mvp * newPosition;
    gl_Position = vec4(newPosition.xyz, clipw(newPosition.w, a_vec2_style_zoom_limits, u_float_style_zoom));
    v_vec2_texcoord = unpack_texcoord(a_vec2_texcoord);
}
`,bB=`#include <prelude>
#include <ecef_mvp_mat>
#include <dem>
#include <packed_attributes>
#include <apply_height_factor>
#include <depth_test>
#include <pos_world>
#include <cam_pos>
#include <fog>
attribute vec3 a_vec3_flat_position;
attribute vec3 a_vec3_ecef_position;
attribute vec2 a_vec2_offset;
attribute vec2 a_vec2_texcoord;
attribute vec2 a_vec2_check_offset;
attribute vec4 a_vec4_tex_identifier;
attribute vec4 a_vec4_sprite_identifier;
uniform vec2 u_vec2_offset;
uniform float u_float_scale;
uniform float u_float_height_factor;
uniform bool u_bool_skip_height_factor;
uniform vec2 u_vec2_vpt_size;
uniform float u_float_floor_elevation;
varying vec2 v_vec2_texcoord;
varying vec2 v_vec2_labeling_texcoord;
varying float v_float_behind_factor;
varying vec4 v_vec4_text_identifier;
void main() {
    float height = dem_height(a_vec3_flat_position.xy);
    
    if (height == DEM_INVALID_VALUE) {
        gl_Position = vec4(0, 0, 1, 1);
        return;
    }
    height += u_float_floor_elevation;
    vec4 pos;
    
    
    
    if (u_bool_skip_height_factor == true) {
        pos = vec4(a_vec3_flat_position, 1.0);
    } else {
        pos = apply_height_factor(a_vec3_flat_position, u_float_height_factor);
    }
    pos.z += height;
    vec3 pos_world = calc_pos_world(a_vec3_flat_position);
    calc_fog_pos(pos_world);
    pos = get_clipspace(pos.xyz, a_vec3_ecef_position);
    pos.xyz = pos.xyz / pos.w;
    pos.w = 1.0;
    v_float_behind_factor = depth_test(pos.xy + a_vec2_check_offset / u_vec2_vpt_size, pos.z, a_vec4_tex_identifier);
    pos.xy += (a_vec2_offset * u_float_scale + u_vec2_offset) / u_vec2_vpt_size * 2.0;
    gl_Position = pos;
    v_vec2_texcoord = unpack_texcoord(a_vec2_texcoord);
    v_vec4_text_identifier = a_vec4_sprite_identifier;
    v_vec2_labeling_texcoord = (pos.xy + 1.) / 2.;
}
`,wB=`#include <prelude>
#include <ecef_mvp_mat>
#include <dem>
attribute vec3 a_vec3_flat_position;
attribute vec3 a_vec3_ecef_position;
attribute vec2 a_vec2_offset;
attribute vec4 a_vec4_identifier;
uniform vec2 u_vec2_offset;
uniform vec2 u_vec2_vpt_size;
uniform float u_float_scale;
uniform float u_float_floor_elevation;
varying vec4 v_vec4_identifier;
void main() {
    float height = dem_height(a_vec3_flat_position.xy);
    
    if (height == DEM_INVALID_VALUE) {
        gl_Position = vec4(0, 0, 1, 1);
        return;
    }
    height += u_float_floor_elevation;
    v_vec4_identifier = a_vec4_identifier;
    if (vec4(1., 1., 1., 1.) != a_vec4_identifier)
    {
        
        vec4 pos = get_clipspace(a_vec3_flat_position, a_vec3_ecef_position);
        pos.xyz = pos.xyz / pos.w;
        pos.w = 1.0;
        pos.xy += (a_vec2_offset * u_float_scale + u_vec2_offset) / u_vec2_vpt_size * 2.0;
        gl_Position = pos;
    }
    else
    {
        gl_Position = vec4(1., 1., 1., 1.);
    }
}
`,xB=`#include <prelude>
#include <mvp_mat>
#include <dem>
#include <packed_attributes>
#include <apply_height_factor>
#include <apply_opacity>
#include <pos_world>
#include <cam_pos>
#include <fog>
#include <jitter>
#include <shadow>
uniform vec2 u_vec2_vpt_size;
uniform vec4 u_vec4_color;
uniform float u_float_height_factor;
uniform float u_float_opacity;
uniform mediump mat4 u_mat4_gradient;
uniform float u_float_floor_elevation;
attribute vec4 a_vec4_vertex;
attribute vec2 a_vec2_normal;
attribute vec2 a_vec2_normal_delta;
attribute vec3 a_vec3_direction;
attribute float a_float_distance;
attribute vec2 a_vec2_dem_position;
attribute float a_float_visibility;
varying vec4 v_vec4_color;
varying mat4 v_mat4_gradient;
varying vec3 v_vec3_normal;
varying vec2 v_vec2_height_gradient;
const float g_shift_pixels = 1.;
const float g_min_denominator = 1e-4;
const float g_w_factor = 1e-6;
vec2 multiply_complex(vec2 lhs, vec2 rhs)
{
    return vec2(lhs.x * rhs.x - lhs.y * rhs.y, lhs.x * rhs.y + lhs.y * rhs.x);
}
void main()
{
    float height = dem_height(unpack_dem_position(a_vec2_dem_position));
    
    
    
    if (height == DEM_INVALID_VALUE || a_float_visibility == 0.0) {
        gl_Position = vec4(0, 0, 1, 1);
        return;
    }
    height += u_float_floor_elevation;
    vec2 half_viewport = u_vec2_vpt_size / vec2(2.);
    
    if (a_vec4_vertex.z > 0.0)
    {
        v_vec2_height_gradient[0] = 1.;
    } else {
        v_vec2_height_gradient[0] = 0.;
    }
    
    vec4 clip_space_direction = u_mat4_mvp * vec4(normalize_s08(vec3(a_vec3_direction.xy, a_vec3_direction.z + height)), 0.);
    vec4 vertex_hf = apply_height_factor(a_vec4_vertex.xyz, u_float_height_factor);
    vertex_hf.z += height;
    
    vertex_hf.z = max(vertex_hf.z, height);
    vec4 clip_space_vertex = u_mat4_mvp * vertex_hf;
    vec2 screen_space_direction = (clip_space_direction.xy * clip_space_vertex.w - clip_space_vertex.xy * clip_space_direction.w) * half_viewport;
    vec2 screen_space_perp = vec2(-screen_space_direction.y, screen_space_direction.x);
    float denominator = max(g_min_denominator, length(screen_space_perp));
    vec2 bevel_normal = normalize_s08(a_vec2_normal);
    vec2 normal_delta = normalize_s08(a_vec2_normal_delta);
    vec4 clip_space_bevel_normal = u_mat4_mvp * vec4(bevel_normal, 0., 0.);
    vec2 screen_space_bevel_normal = (clip_space_bevel_normal.xy * clip_space_vertex.w - clip_space_vertex.xy * clip_space_bevel_normal.w) * half_viewport;
    float bevel_denominator = max(g_min_denominator, length(screen_space_bevel_normal));
    
    float normal_factor = -dot(screen_space_bevel_normal, screen_space_perp) / denominator / bevel_denominator;
    vec2 wall_normal = multiply_complex(bevel_normal, vec2(normal_delta.x, sign(normal_factor) * normal_delta.y));
    gl_Position = g_w_factor * (clip_space_vertex + vec4(screen_space_perp / half_viewport, 0., 0.) * g_shift_pixels * a_float_distance / denominator * clip_space_vertex.w);
    vec3 pos_world = calc_pos_world(vertex_hf);
    v_vec4_color = u_vec4_color;
    v_vec3_normal = vec3(wall_normal, 0.0);
    if (u_mat4_gradient[0][0] !=0.)
    {
        v_mat4_gradient = u_mat4_gradient;
        for (int i = 1; i <= 2; i++) {
            v_mat4_gradient[i] = apply_opacity(v_mat4_gradient[i], u_float_opacity);
        }
    }
    v_vec2_height_gradient.y = a_float_distance * gl_Position.w;
    calc_fog_pos(pos_world);
#ifdef TAA
    apply_vertex_jitter(gl_Position);
#endif
    
    
    compute_shadow_vertex(clip_space_vertex);
}
`,SB=`#include <prelude>
#include <mvp_mat>
#include <pos_world>
#include <cam_pos>
#include <fog>
#include <jitter>
#include <shadow>
#include <dem>
attribute vec2 a_vec2_vertex;
attribute vec4 a_vec4_normals;
attribute float a_float_height;
uniform float u_float_width;
uniform float u_float_tile_to_pixel_ratio;
varying vec2 v_vec2_normal;
varying float v_float_half_width;
const float g_w_factor = 1e-6;
const float normal_unpack_multiplier = 0.011135539861205473;
void main()
{
    float height = dem_height(a_vec2_vertex);
    if (height == DEM_INVALID_VALUE) {
        gl_Position = vec4(0, 0, 1, 1);
        return;
    }
    
    float half_width = 0.5 * (u_float_width + 1.0);
    
    vec4 normals = a_vec4_normals * normal_unpack_multiplier * half_width;
    vec2 extender = normals.xy;
    vec2 normal = normals.zw;
    
    vec4 shifted_vertex = vec4(
        a_vec2_vertex + extender * u_float_tile_to_pixel_ratio,
        height + a_float_height / (65535. * 32.),
        1.0
    );
    vec4 clip_pos = u_mat4_mvp * shifted_vertex;
    gl_Position = g_w_factor * clip_pos;
    v_vec2_normal = normal;
    v_float_half_width = half_width;
    vec3 pos_world = calc_pos_world(shifted_vertex);
    calc_fog_pos(pos_world);
#ifdef TAA
    apply_vertex_jitter(gl_Position);
#endif
    compute_shadow_vertex(clip_pos, vec3(0.0, 0.0, 1.0), u_mat4_mvp);
}
`,MB=`#include <prelude>
#include <mvp_mat>
#include <dem>
attribute vec2 a_vec2_vertex;
attribute vec4 a_vec4_normals;
attribute float a_float_height;
attribute vec4 a_vec4_identifier;
uniform float u_float_width;
uniform float u_float_tile_to_pixel_ratio;
varying vec2 v_vec2_normal;
varying vec4 v_vec4_identifier;
varying float v_float_half_width;
const float g_w_factor = 1e-6;
const float normal_unpack_multiplier = 0.011135539861205473;
void main()
{
    float height = dem_height(a_vec2_vertex);
    if (height == DEM_INVALID_VALUE) {
        gl_Position = vec4(0, 0, 1, 1);
        return;
    }
    
    float half_width = 0.5 * (u_float_width + 1.0);
    
    vec4 normals = a_vec4_normals * normal_unpack_multiplier * half_width;
    vec2 extender = normals.xy;
    vec2 normal = normals.zw;
    if (vec4(1., 1., 1., 1.) != a_vec4_identifier) {
        
        vec4 shifted_vertex = vec4(
            a_vec2_vertex + extender * u_float_tile_to_pixel_ratio,
            height + a_float_height / (65535. * 32.),
            1.0
        );
        gl_Position = g_w_factor * u_mat4_mvp * shifted_vertex;
    } else {
        gl_Position = vec4(1., 1., 1., 1.);
    }
    v_vec2_normal = normal;
    v_vec4_identifier = a_vec4_identifier;
    v_float_half_width = half_width;
}
`,TB=`#include <prelude>
#include <mvp_mat>
#include <dem>
#include <packed_attributes>
#include <pos_world>
#include <cam_pos>
#include <shadow>
#include <fog>
#include <clipspace_pos>
#include <jitter>
attribute vec2 a_vec2_vertex;
attribute float a_float_z;
attribute vec2 a_vec2_extender;
attribute vec3 a_vec3_normal;
attribute float a_float_gradient;
attribute vec2 a_vec2_dem_position;
attribute float a_float_abs_z;
attribute float a_float_is_pivot;
uniform float u_float_tile_size;
uniform float u_float_height_factor;
uniform int u_int_abs_z;
varying vec4 v_tex_coord;
varying vec4 v_vec4_normal_gradient;
void main()
{
    float height = 0.;
    if (u_int_abs_z == 0) {
        height = dem_height(unpack_dem_position(a_vec2_dem_position));
    } else {
        if (a_float_is_pivot == 1.) {
            height = dem_height(a_vec2_vertex);
        } else {
            height = abs_height(a_float_abs_z);
        }
    }
    
    if (height == DEM_INVALID_VALUE) {
        gl_Position = vec4(0, 0, 1, 1);
        return;
    }
    
    vec3 vec3_vertex = vec3(a_vec2_vertex, a_float_z / (65535. * 32.));
    v_tex_coord = u_mat4_mvp * vec4(vec3_vertex.xy, 0, 1.0);
    v_vec4_normal_gradient.xyz = normalize_s08(a_vec3_normal);
    v_vec4_normal_gradient.w = a_float_gradient;
    vec4 pos = vec4(vec3_vertex.xy, vec3_vertex.z * u_float_height_factor + height, 1.0);
    vec3 world_pos = calc_pos_world(pos);
    calc_fog_pos(world_pos);
    gl_Position = u_mat4_mvp * pos;
#ifdef TAA
    apply_vertex_jitter(gl_Position);
#endif
    save_clipspace_pos();
    compute_shadow_vertex(gl_Position, v_vec4_normal_gradient.xyz, u_mat4_mvp);
}`,IB=`#include <prelude>
#include <mvp_mat>
#include <dem>
#include <packed_attributes>
#include <apply_height_factor>
#include <apply_opacity>
#include <pos_world>
#include <cam_pos>
#include <shadow>
#include <fog>
#include <clipspace_pos>
#include <jitter>
uniform mediump vec4 u_vec4_color;
uniform mediump mat4 u_mat4_gradient;
uniform float u_float_height_factor;
uniform int u_int_abs_z;
uniform lowp int u_int_is_textured;
uniform mediump float u_float_opacity;
uniform vec4 u_float_texture_params;
uniform float u_float_texture_vertical_scale;
uniform mediump int u_int_identify;
attribute vec2 a_vec2_vertex;
attribute float a_float_z;
attribute vec3 a_vec3_normal;
attribute float a_float_gradient;
attribute vec2 a_vec2_dem_position;
attribute float a_float_abs_z;
attribute vec4 a_vec4_identifier;
attribute float a_float_visibility;
attribute float a_float_is_pivot;
varying vec4 v_vec4_color;
varying mat4 v_mat4_gradient;
varying vec2 v_vec2_tex_coord;
varying vec4 v_vec4_normal_gradient;
varying vec4 v_vec4_identifier;
void main()
{
    if (u_int_identify != 0 && a_vec4_identifier == vec4(1., 1., 1., 1.)) {
        gl_Position = vec4(0, 0, 0, 0);
        return;
    }
    float height = 0.;
    if (u_int_abs_z == 0) {
        height = dem_height(unpack_dem_position(a_vec2_dem_position));
    } else {
        if (a_float_is_pivot == 1.) {
            height = dem_height(a_vec2_vertex);
        } else {
            height = abs_height(a_float_abs_z);
        }
    }
    
    if (height == DEM_INVALID_VALUE || a_float_visibility == 0.0) {
        gl_Position = vec4(0, 0, 1, 1);
        v_vec4_color = vec4(0, 0, 0, 0);
        return;
    }
    v_vec4_identifier = a_vec4_identifier;
    
    vec4 vec4_pos = apply_height_factor(vec3(a_vec2_vertex.xy, a_float_z / (65535. * 32.)), u_float_height_factor);
    vec4_pos.z += height;
    vec3 pos_world = calc_pos_world(vec4_pos);
    calc_fog_pos(pos_world);
    gl_Position = u_mat4_mvp * vec4_pos;
    vec3 vec3_normal = normalize(a_vec3_normal);
    v_vec4_normal_gradient.xyz = vec3_normal;
    v_vec4_normal_gradient.w = a_float_gradient / 127.; 
    if (u_int_is_textured != 0) {
        
        vec2 vec2_vertex = a_vec2_vertex * 2. - 0.5;
        
        
        vec3 tex_coord = abs(vec3(
            vec2_vertex * u_float_texture_params.zw + u_float_texture_params.xy,
            a_float_z / u_float_texture_vertical_scale
        ));
        
        if (vec3_normal.x == 0. && vec3_normal.y == 0.) {
            v_vec2_tex_coord = tex_coord.xy;
        } else {
            float scale = abs(vec3_normal.z);
            tex_coord.z /= sqrt(1.0 - vec3_normal.z * vec3_normal.z);;
            if (abs(vec3_normal).y > abs(vec3_normal).x) {
                v_vec2_tex_coord = tex_coord.xz;
            } else {
                v_vec2_tex_coord = tex_coord.yz;
            }
        }
        v_vec4_color = apply_opacity(u_vec4_color, u_float_opacity);
    }
    
    else if (u_mat4_gradient[0][0] != 0.)
    {
        v_mat4_gradient = u_mat4_gradient;
        for (int i = 1; i <= 2; i++) {
            v_mat4_gradient[i] = apply_opacity(v_mat4_gradient[i], u_float_opacity);
        }
    } else {
        v_vec4_color = apply_opacity(u_vec4_color, u_float_opacity);
    }
#ifdef TAA
    apply_vertex_jitter(gl_Position);
#endif
    save_clipspace_pos();
    compute_shadow_vertex(gl_Position, vec3_normal, u_mat4_mvp);
}
`,EB=`#include <prelude>
#include <mvp_mat>
#include <dem>
#include <apply_height_factor>
attribute vec2 a_vec2_vertex;
attribute float a_float_z;
attribute vec2 a_vec2_dem_position;
attribute float a_float_abs_z;
attribute float a_float_visibility;
attribute float a_float_is_pivot;
uniform float u_float_height_factor;
uniform int u_int_abs_z;
varying float v_depth_metric;
void main()
{
    float height = 0.;
    if (u_int_abs_z == 0) {
        height = dem_height(unpack_dem_position(a_vec2_dem_position));
    } else {
        if (a_float_is_pivot == 1.) {
            height = dem_height(a_vec2_vertex);
        } else {
            height = abs_height(a_float_abs_z);
        }
    }
    
    if (height == DEM_INVALID_VALUE || a_float_visibility == 0.0) {
        gl_Position = vec4(0, 0, 1, 1);
        return;
    }
    
    vec4 vec4_pos = apply_height_factor(vec3(a_vec2_vertex.xy, a_float_z / (65535. * 32.)), u_float_height_factor);
    vec4_pos.z += height;
    gl_Position = u_mat4_mvp * vec4_pos;
    v_depth_metric = 0.5 * gl_Position.z + 0.5;
}`,AB=`#include <prelude>
#include <mvp_mat>
#include <dem>
#include <packed_attributes>
#include <apply_height_factor>
#include <pos_world>
#include <cam_pos>
#include <fog>
#include <jitter>
#include <shadow>
uniform vec2 u_vec2_vpt_size;
uniform float u_float_width;
uniform float u_float_height_factor;
uniform int u_int_signed_z;
uniform int u_int_abs_z;
uniform float u_float_z_offset;
attribute vec2 a_vec2_vertex;
attribute float a_float_z;
attribute vec4 a_vec4_direction_distance;
attribute vec2 a_vec2_dem_position;
attribute float a_float_abs_z;
attribute float a_float_visibility;
attribute float a_float_is_pivot;
varying float v_float_distance;
varying float v_float_distance_offset;
const float g_smooth_width = 1.;
const float g_min_denominator = 1e-4;
const float g_w_factor = 1e-6;
void main()
{
    float height = 0.;
    if (u_int_abs_z == 0) {
        height = dem_height(unpack_dem_position(a_vec2_dem_position));
    } else {
        if (a_float_is_pivot == 1.) {
            height = dem_height(a_vec2_vertex);
        } else {
            height = abs_height(a_float_abs_z);
        }
    }
    
    
    
    if (height == DEM_INVALID_VALUE || a_float_visibility == 0.0) {
        gl_Position = vec4(0, 0, 1, 1);
        return;
    }
    float shift_pixels = 0.5 * max(u_float_width - 1., 0.);
    float shift_pixels_added = shift_pixels + g_smooth_width;
    vec3 direction = a_vec4_direction_distance.xyz;
    float distance = a_vec4_direction_distance.w;
    vec2 half_viewport = u_vec2_vpt_size / vec2(2.);
    
    
    vec4 clip_space_direction = normalize(u_mat4_mvp * vec4(normalize_s08(direction), 0.));
    vec3 a_vec3_vertex = vec3(a_vec2_vertex, a_float_z / (65535. * 32.));
    
    vec4 vertex_hf = apply_height_factor(a_vec3_vertex, u_float_height_factor);
    vertex_hf.z += height;
    vec4 clip_space_vertex = u_mat4_mvp * vertex_hf;
    vec2 screen_space_direction =
        (clip_space_direction.xy * clip_space_vertex.w - clip_space_vertex.xy * clip_space_direction.w) * half_viewport;
    vec2 screen_space_perp = vec2(-screen_space_direction.y, screen_space_direction.x);
    float denominator = max(g_min_denominator, length(screen_space_perp));
    gl_Position = g_w_factor * (clip_space_vertex + vec4(screen_space_perp / half_viewport, 0., 0.)
        * distance * shift_pixels_added / denominator * clip_space_vertex.w);
    gl_Position.z += u_float_z_offset;
    v_float_distance = shift_pixels_added * distance * gl_Position.w;
    v_float_distance_offset = shift_pixels;
    vec3 pos_world = calc_pos_world(vertex_hf.xyz);
    calc_fog_pos(pos_world);
#ifdef TAA
    apply_vertex_jitter(gl_Position);
#endif
    
    
    compute_shadow_vertex(clip_space_vertex);
}
`,CB=`#include <prelude>
#include <mvp_mat>
#include <apply_opacity>
#include <packed_attributes>
#include <pos_world>
#include <cam_pos>
#include <shadow>
#include <fog>
uniform float u_float_floor_elevation;
attribute vec2 a_vec2_vertex;
attribute vec2 a_vec2_texcoord;
varying vec2 v_vec2_texcoord;
void main()
{
    gl_Position = u_mat4_mvp * vec4(a_vec2_vertex, u_float_floor_elevation, 1.0);
    vec3 pos_world = calc_pos_world(a_vec2_vertex);
    calc_fog_pos(pos_world);
    compute_shadow_vertex(gl_Position, vec3(0,0,1), u_mat4_mvp);
    v_vec2_texcoord = unpack_texcoord(a_vec2_texcoord);
}
`,PB=`#include <prelude>
#include <mvp_mat>
#include <packed_attributes>
#include <pixel_offset>
#include <signed_distance_functions>
#include <arrow_functions>
#include <apply_opacity>
#include <pos_world>
#include <cam_pos>
#include <fog>
#include <jitter>
#ifndef UBO
uniform float u_float_border_width_offset;
uniform vec2 u_vec2_scale_limits;
#endif
uniform vec4 u_vec4_color;
uniform vec4 u_vec4_border_color;
uniform mediump vec2 u_vec2_vpt_size;
uniform vec3 u_vec3_projection_scale_style_scale_dpi;
uniform float u_float_border_width;
uniform float u_float_size_factor;
uniform mediump float u_float_width;
uniform mediump float u_float_length;
uniform float u_float_wing_width_multiplier;
uniform float u_float_wing_height_multiplier;
uniform float u_float_tip_height_multiplier;
uniform float u_float_opacity;
attribute vec2 a_vec2_position;
attribute vec2 a_vec2_direction;
attribute vec2 a_vec2_widen_direction;
varying vec4 v_vec4_color;
varying vec4 v_vec4_border_color;
varying vec2 v_vec2_texcoord;
varying float v_float_border_width;
varying float v_float_zpt_to_texcoord_factor;
varying float v_float_outer_width;
varying float v_float_opacity;
const float g_shift_pixels = 2.;
const float g_w_factor = 1e-7;
void main()
{
    float style_scale_clamped = clamp(u_vec3_projection_scale_style_scale_dpi.y, u_vec2_scale_limits.x, u_vec2_scale_limits.y);
    float scale_ratio = u_vec3_projection_scale_style_scale_dpi.x / u_vec3_projection_scale_style_scale_dpi.y;
    float calculation_scale = style_scale_clamped * scale_ratio;
    ArrowParameters arrow_parameters = calculate_arrow_parameters(
        calculation_scale,
        u_float_width,
        u_float_border_width,
        u_float_length,
        u_float_wing_width_multiplier,
        u_float_wing_height_multiplier,
        u_float_tip_height_multiplier,
        u_float_size_factor);
    v_float_zpt_to_texcoord_factor = arrow_parameters.zpt_to_texcoord_factor;
    v_float_outer_width = arrow_parameters.outer_width;
    vec2 direction = normalize_s08(a_vec2_direction);
    vec2 untransformed_widen = a_vec2_widen_direction * arrow_parameters.widen_size;
    vec2 widen = multiply_complex(untransformed_widen * arrow_parameters.final_size, direction);
    
    float shift_pixels = g_shift_pixels * sqrt(2.) / min(abs(untransformed_widen.x), abs(untransformed_widen.y));
    VertexShiftParameters shift_parameters = calculate_vertex_shift_parameters(
        u_mat4_mvp,
        u_vec2_vpt_size,
        a_vec2_position,
        widen,
        shift_pixels);
    
    
    gl_Position = shift_parameters.clip_space_vertex / arrow_parameters.final_size * g_w_factor;
    v_vec2_texcoord = untransformed_widen * (1. + shift_parameters.limited_factor);
    
    float border_width = u_float_border_width * v_float_zpt_to_texcoord_factor;
    float border_width_offset = u_float_border_width_offset * v_float_zpt_to_texcoord_factor;
    v_float_border_width = max(0., border_width - u_vec3_projection_scale_style_scale_dpi.y / style_scale_clamped * border_width_offset);
    v_vec4_color = apply_opacity(u_vec4_color, u_float_opacity);
    v_vec4_border_color = apply_opacity(u_vec4_border_color, u_float_opacity);
    v_float_opacity = u_float_opacity;
    vec3 pos_world = calc_pos_world(a_vec2_position);
    calc_fog_pos(pos_world);
}
`,LB=`#include <prelude>
#include <mvp_mat>
#include <packed_attributes>
#include <pixel_offset>
#include <calculate_scale>
#include <line_width>
#include <apply_opacity>
#include <precision_constants>
#include <striped_line_functions>
#include <pos_world>
#include <cam_pos>
#include <shadow>
#include <fog>
#include <jitter>
#include <dem>
attribute vec2 a_vec2_vertex;
attribute vec2 a_vec2_widen;
attribute float a_float_texture;
attribute float a_float_height;
uniform vec2 u_vec2_scales;
uniform float u_float_width;
uniform vec4 u_vec4_color;
uniform float u_float_opacity;
uniform vec4 u_vec4_pattern_params;
uniform bool u_bool_is_3d_line;
varying vec2 v_vec2_uv;
varying float v_float_period;
varying float v_float_width;
varying vec4 v_vec4_color;
varying vec4 v_vec4_pattern_parameters;
const float g_w_factor = 1e-6;
void main() {
    float height = 0.;
    if (u_bool_is_3d_line == true) {
        height = dem_height(a_vec2_vertex);
    }
    if (height == DEM_INVALID_VALUE) {
        gl_Position = vec4(0, 0, 1, 1);
        return;
    }
    if (u_bool_is_3d_line == true) {
        height += a_float_height / (65535. * 32.);
    }
    
    v_float_width = u_float_width;
    v_vec4_color = apply_opacity(u_vec4_color, u_float_opacity);
    v_vec2_uv = vec2(abs(a_float_texture), sign(a_float_texture) / 2.);
    v_vec2_uv.x *= u_vec2_scales.x / u_vec4_pattern_params.x;
    v_vec4_pattern_parameters = u_vec4_pattern_params;
    
    float full_width = u_float_width + 1.;
    
    vec2 widen = unpack_widen(a_vec2_widen);
    vec2 extender = widen * full_width * 0.5;
    
    
    vec2 shift = vec2(0.);
    vec4 shifted_vertex = vec4(a_vec2_vertex + (shift + extender) * u_vec2_scales.y, height, 1.0);
    vec3 pos_world = calc_pos_world(shifted_vertex); 
    calc_fog_pos(pos_world);
    gl_Position = u_mat4_mvp * shifted_vertex;
#ifdef TAA
    apply_vertex_jitter(gl_Position);
#endif
    compute_shadow_vertex(gl_Position, vec3(0.0, 0.0, 1.0), u_mat4_mvp);
    gl_Position *= g_w_factor;
}
`,FB=`#include <prelude>
#include <mvp_mat>
#include <dem>
attribute vec4 a_vec4_position;
attribute vec2 a_vec2_offset;
attribute vec4 a_vec4_identifier;
uniform vec2 u_vec2_offset;
uniform vec2 u_vec2_vpt_size;
uniform float u_float_floor_elevation;
varying vec4 v_vec4_identifier;
void main() {
    float height = dem_height(a_vec4_position.xy);
    
    if (height == DEM_INVALID_VALUE) {
        gl_Position = vec4(0, 0, 1, 1);
        return;
    }
    height += u_float_floor_elevation;
    vec4 ndcPosition = u_mat4_mvp * vec4(a_vec4_position.xy, a_vec4_position.z + height, a_vec4_position.w);
    ndcPosition.xyz = ndcPosition.xyz / ndcPosition.w;
    ndcPosition.w = 1.0;
    ndcPosition.xy += (a_vec2_offset + u_vec2_offset) / u_vec2_vpt_size * 2.0;
    gl_Position = ndcPosition;
    v_vec4_identifier = a_vec4_identifier;
}
`,kB=`#include <prelude>
#include <ecef_mvp_mat>
#include <pos_world>
#include <cam_pos>
#include <fog>
#include <dem>
#include <packed_attributes>
#include <apply_height_factor>
#include <raster_functions>
#include <depth_test>
#ifndef UBO
uniform float u_float_rounding_factor;
#endif
uniform vec3 u_vec3_projection_scale_style_scale_dpi;
uniform float u_float_height_factor;
uniform vec2 u_vec2_rotation; 
uniform bool u_bool_skip_height_factor;
uniform vec2 u_vec2_vpt_size;
uniform float u_float_floor_elevation;
attribute vec3 a_vec3_flat_position;
attribute vec3 a_vec3_ecef_position;
attribute vec2 a_vec2_offset;
attribute vec2 a_vec2_check_offset;
attribute vec2 a_vec2_texcoord;
attribute vec2 a_vec2_range;
attribute vec2 a_vec2_rescale;
attribute vec4 a_vec4_tex_identifier;
varying vec2 v_vec2_texcoord;
varying float v_float_behind_factor;
void main()
{
    float height = dem_height(a_vec3_flat_position.xy);
    
    if (height == DEM_INVALID_VALUE) {
        gl_Position = vec4(0, 0, 1, 1);
        return;
    }
    height += u_float_floor_elevation;
    mat2 rotation_matrix = mat2(
        u_vec2_rotation.x, -u_vec2_rotation.y,
        u_vec2_rotation.y, u_vec2_rotation.x
    );
    vec2 inv_half_size = 2.0 / u_vec2_vpt_size;
    vec4 anchor;
    
    
    
    if (u_bool_skip_height_factor == true) {
        anchor = vec4(a_vec3_flat_position, 1.0);
    } else {
        anchor = apply_height_factor(a_vec3_flat_position, u_float_height_factor);
    }
    anchor.z += height;
    vec3 pos_world = calc_pos_world(anchor);
    calc_fog_pos(pos_world);
    anchor = get_clipspace(anchor.xyz, a_vec3_ecef_position);
    vec2 offset = rescale(rotation_matrix * a_vec2_offset, a_vec2_rescale, a_vec2_range, u_vec3_projection_scale_style_scale_dpi.y);
    vec2 pos_2d = anchor.xy + overlay_transform(offset, inv_half_size) * anchor.w;
    vec2 corner = make_position(pos_2d, anchor.w, inv_half_size, u_float_rounding_factor);
    v_float_behind_factor = depth_test(anchor.xy / anchor.w + a_vec2_check_offset / u_vec2_vpt_size, anchor.z / anchor.w, a_vec4_tex_identifier);
    gl_Position = vec4(corner, anchor.z, clipw(anchor.w, a_vec2_range, u_vec3_projection_scale_style_scale_dpi.y));
    v_vec2_texcoord = unpack_texcoord(a_vec2_texcoord);
}
`,RB=`#include <prelude>
#include <ecef_mvp_mat>
#include <dem>
#include <packed_attributes>
#include <apply_height_factor>
#include <raster_functions>
uniform vec2 u_vec2_vpt_size;
uniform vec3 u_vec3_projection_scale_style_scale_dpi;
uniform float u_float_height_factor;
uniform vec2 u_vec2_rotation; 
uniform bool u_bool_skip_height_factor;
uniform float u_float_floor_elevation;
attribute vec3 a_vec3_flat_position;
attribute vec3 a_vec3_ecef_position;
attribute vec2 a_vec2_offset;
attribute vec2 a_vec2_texcoord;
attribute vec2 a_vec2_range;
attribute vec2 a_vec2_rescale;
attribute vec4 a_vec4_identifier;
varying vec2 v_vec2_texcoord;
varying vec4 v_vec4_identifier;
void main()
{
    if (vec4(1., 1., 1., 1.) != a_vec4_identifier)
    {
        float height = dem_height(a_vec3_flat_position.xy);
        
        if (height == DEM_INVALID_VALUE) {
            gl_Position = vec4(0, 0, 1, 1);
            return;
        }
        height += u_float_floor_elevation;
        
        mat2 rotation_matrix = mat2(
            u_vec2_rotation.x, -u_vec2_rotation.y,
            u_vec2_rotation.y, u_vec2_rotation.x
        );
        vec2 inv_half_size = 2.0 / u_vec2_vpt_size;
        vec4 anchor;
        
        
        
        if (u_bool_skip_height_factor == true) {
            anchor = vec4(a_vec3_flat_position, 1.0);
        } else {
            anchor = apply_height_factor(a_vec3_flat_position, u_float_height_factor);
        }
        anchor.z += height;
        anchor = get_clipspace(anchor.xyz, a_vec3_ecef_position);
        vec2 offset = rescale(rotation_matrix * a_vec2_offset, a_vec2_rescale, a_vec2_range, u_vec3_projection_scale_style_scale_dpi.y);
        vec2 pos_2d = anchor.xy + overlay_transform(offset, inv_half_size) * anchor.w;
        vec2 corner = make_position(pos_2d, anchor.w, inv_half_size, 1.0);
        gl_Position = vec4(corner, anchor.z, clipw(anchor.w, a_vec2_range, u_vec3_projection_scale_style_scale_dpi.y));
    }
    else
    {
        gl_Position = vec4(1., 1., 1., 1.);
    }
    v_vec2_texcoord = unpack_texcoord(a_vec2_texcoord);
    v_vec4_identifier = a_vec4_identifier;
}
`,zB=`#include <prelude>
attribute vec2 a_vec2_vertex;
varying vec2 v_vec2_texcoord;
void main()
{
    gl_Position = vec4(a_vec2_vertex, 0.0, 1.0);
    v_vec2_texcoord = 0.5 * a_vec2_vertex + 0.5;
}
`,BB=`#include <prelude>
#include <mvp_mat>
#include <pos_world>
#include <cam_pos>
#include <fog>
attribute vec2 a_vec2_vertex;
void main()
{
    gl_Position = u_mat4_mvp * vec4(a_vec2_vertex, 0.0, 1.0);
}
`,OB=`#include <prelude>
#include <mvp_mat>
#include <packed_attributes>
#include <apply_opacity>
#include <raster_functions>
#include <pos_world>
#include <cam_pos>
#include <fog>
attribute vec2 a_vec2_vertex;
attribute vec2 a_vec2_texcoord;
varying vec2 v_vec2_texcoord;
void main()
{
    gl_Position = u_mat4_mvp * vec4(a_vec2_vertex, 0.0, 1.0);
    calc_fog_pos(calc_pos_world(a_vec2_vertex));
    v_vec2_texcoord = unpack_texcoord(a_vec2_texcoord);
}
`,DB=`#include <prelude>
#include <mvp_mat>
#include <pos_world>
#include <cam_pos>
#include <fog>
#include <jitter>
#include <shadow>
attribute vec2 a_vec2_vertex;
attribute vec4 a_vec4_normals;
attribute vec2 a_vec2_shift;
uniform float u_float_width;
uniform float u_float_tile_to_pixel_ratio;
uniform float u_float_shift;
varying vec2 v_vec2_normal;
varying float v_float_half_width;
const float g_w_factor = 1e-6;
const float normal_unpack_multiplier = 0.011135539861205473;
void main()
{
    
    float half_width = 0.5 * (u_float_width + 1.0);
    
    vec4 normals = a_vec4_normals * normal_unpack_multiplier * half_width;
    vec2 extender = normals.xy;
    vec2 normal = normals.zw;
    vec2 shift = a_vec2_shift * u_float_shift;
    
    vec4 shifted_vertex = vec4(a_vec2_vertex + (shift + extender) * u_float_tile_to_pixel_ratio, 0.0, 1.0);
    vec4 clip_pos = u_mat4_mvp * shifted_vertex;
    gl_Position = g_w_factor * clip_pos;
    v_vec2_normal = normal;
    v_float_half_width = half_width;
    vec3 pos_world = calc_pos_world(shifted_vertex);
    calc_fog_pos(pos_world);
#ifdef TAA
    apply_vertex_jitter(gl_Position);
#endif
    compute_shadow_vertex(clip_pos, vec3(0.0, 0.0, 1.0), u_mat4_mvp);
}
`,NB=`#include <prelude>
#include <mvp_mat>
attribute vec2 a_vec2_vertex;
attribute vec4 a_vec4_normals;
attribute vec4 a_vec4_identifier;
uniform float u_float_width;
uniform float u_float_tile_to_pixel_ratio;
varying vec2 v_vec2_normal;
varying vec4 v_vec4_identifier;
varying float v_float_half_width;
const float g_w_factor = 1e-6;
const float normal_unpack_multiplier = 0.011135539861205473;
void main()
{
    
    float half_width = 0.5 * (u_float_width + 1.0);
    
    vec4 normals = a_vec4_normals * normal_unpack_multiplier * half_width;
    vec2 extender = normals.xy;
    vec2 normal = normals.zw;
    if (vec4(1., 1., 1., 1.) != a_vec4_identifier) {
        
        vec4 shifted_vertex = vec4(a_vec2_vertex + extender * u_float_tile_to_pixel_ratio, 0.0, 1.0);
        gl_Position = g_w_factor * u_mat4_mvp * shifted_vertex;
    } else {
        gl_Position = vec4(1., 1., 1., 1.);
    }
    v_vec2_normal = normal;
    v_vec4_identifier = a_vec4_identifier;
    v_float_half_width = half_width;
}
`,UB=`#include <prelude>
#include <mvp_mat>
#include <dem>
#include <packed_attributes>
#include <apply_height_factor>
#include <pos_world>
#include <cam_pos>
#include <fog>
#include <jitter>
#include <shadow>
uniform vec2 u_vec2_vpt_size;
uniform float u_float_width;
uniform float u_float_height_factor;
uniform int u_int_signed_z;
uniform int u_int_abs_z;
uniform float u_float_z_offset;
uniform float u_float_floor_elevation;
attribute vec3 a_vec3_vertex;
attribute float a_float_z;
attribute vec4 a_vec4_direction_distance;
attribute vec2 a_vec2_dem_position;
attribute float a_float_abs_z;
attribute float a_float_visibility;
varying float v_float_distance;
varying float v_float_distance_offset;
const float g_smooth_width = 1.;
const float g_min_denominator = 1e-4;
const float g_w_factor = 1e-6;
void main()
{
    float height = 0.;
    if (u_int_abs_z == 0) {
        height = dem_height(unpack_dem_position(a_vec2_dem_position));
    } else {
        height = abs_height(a_float_abs_z);
    }
    
    
    
    if (height == DEM_INVALID_VALUE || a_float_visibility == 0.0) {
        gl_Position = vec4(0, 0, 1, 1);
        return;
    }
    height += u_float_floor_elevation;
    float shift_pixels = 0.5 * max(u_float_width - 1., 0.);
    float shift_pixels_added = shift_pixels + g_smooth_width;
    vec3 direction = a_vec4_direction_distance.xyz;
    float distance = a_vec4_direction_distance.w;
    vec2 half_viewport = u_vec2_vpt_size / vec2(2.);
    
    
    vec4 clip_space_direction = normalize(u_mat4_mvp * vec4(normalize_s08(direction), 0.));
    vec3 a_vec3_vertex_copy = vec3(a_vec3_vertex);
    
    if (u_int_signed_z == 1) {
        a_vec3_vertex_copy.z = a_float_z / (65535. * 32.);
    }
    
    vec4 vertex_hf = apply_height_factor(a_vec3_vertex_copy, u_float_height_factor);
    vertex_hf.z += height;
    vec4 clip_space_vertex = u_mat4_mvp * vertex_hf;
    vec2 screen_space_direction =
        (clip_space_direction.xy * clip_space_vertex.w - clip_space_vertex.xy * clip_space_direction.w) * half_viewport;
    vec2 screen_space_perp = vec2(-screen_space_direction.y, screen_space_direction.x);
    float denominator = max(g_min_denominator, length(screen_space_perp));
    gl_Position = g_w_factor * (clip_space_vertex + vec4(screen_space_perp / half_viewport, 0., 0.)
        * distance * shift_pixels_added / denominator * clip_space_vertex.w);
    gl_Position.z += u_float_z_offset;
    v_float_distance = shift_pixels_added * distance * gl_Position.w;
    v_float_distance_offset = shift_pixels;
    vec3 pos_world = calc_pos_world(vertex_hf.xyz);
    calc_fog_pos(pos_world);
#ifdef TAA
    apply_vertex_jitter(gl_Position);
#endif
    
    
    compute_shadow_vertex(clip_space_vertex);
}
`,GB=`#include <prelude>
#include <mvp_mat>
uniform float u_float_scale;
uniform vec3 u_vec3_transform;
attribute vec3 a_vec3_position;
varying vec3 v_position;
void main() {
    vec3 scaled_transformed = u_vec3_transform + a_vec3_position * u_float_scale;
    v_position = scaled_transformed;
    gl_Position = u_mat4_mvp * vec4(scaled_transformed, 1.0);
}
`,HB=`#include <prelude>
#include <pos_world>
#include <cam_pos>
#include <fog>
attribute vec2 a_vec2_vertex;
void main()
{
    gl_Position = vec4(a_vec2_vertex, 1.0, 1.0);
    calc_fog_pos_sky(gl_Position);
}
`,VB=`#include <prelude>
attribute vec3 a_vec3_position;
attribute float a_fade_opacity;
#ifndef UBO
uniform mat4 u_mat4_stars;
uniform float u_float_stars_intensity;
uniform float u_float_pixelratio;
#endif
varying mediump float v_intensity;
void main() {
    v_intensity = a_fade_opacity * u_float_stars_intensity;
    gl_PointSize = u_float_pixelratio;
    gl_Position = u_mat4_stars * vec4(a_vec3_position, 1.0);
}
`,jB=`#include <prelude>
#include <mvp_mat>
#include <packed_attributes>
#include <pixel_offset>
#include <calculate_scale>
#include <line_width>
#include <apply_opacity>
#include <precision_constants>
#include <striped_line_functions>
#include <pos_world>
#include <cam_pos>
#include <fog>
#include <jitter>
#include <shadow>
#include <dem>
uniform vec4 u_vec4_dash_color;
uniform vec4 u_vec4_space_color;
uniform vec4 u_vec4_border_color;
uniform mediump vec2 u_vec2_vpt_size;
uniform vec3 u_vec3_projection_scale_style_scale_dpi;
uniform float u_float_width;
uniform float u_float_width_offset;
uniform vec2 u_vec2_scaler_params;
uniform float u_float_dash_length;
uniform float u_float_space_length;
uniform float u_float_dash2_length;
uniform float u_float_opacity;
uniform bool u_bool_is_3d_line;
attribute vec2 a_vec2_vertex;
attribute vec2 a_vec2_texture_widen;
attribute vec2 a_vec2_widen;
attribute float a_float_vertex_distance;
attribute float a_float_component_distance;
attribute float a_float_object_length;
attribute float a_float_height;
varying vec4 v_vec4_dash_color;
varying vec4 v_vec4_space_color;
varying vec4 v_vec4_border_color;
varying vec2 v_vec2_circle;
varying float v_float_width;
varying float v_float_part_color_swap_threshold;
varying float v_float_distance_in_parts;
const float g_shift_pixels = 2.;
const float g_w_factor = 1e-7;
PolylineDistance decode_line_distance()
{
    return PolylineDistance(
        a_float_vertex_distance,
        a_float_component_distance,
        a_float_object_length);
}
StripedLineInParams decode_line_params(const Scale scale)
{
    float width = calculate_final_width(scale, u_float_width, u_float_width_offset);
    float dash_length  = scale.calculation * u_float_dash_length;
    float space_length = scale.calculation * u_float_space_length;
    float dash2_length = scale.calculation * u_float_dash2_length;
    return StripedLineInParams(
        dash_length,
        space_length,
        dash2_length,
        width);
}
void main()
{
    float height = 0.;
    if (u_bool_is_3d_line == true) {
        height = dem_height(a_vec2_vertex);
    }
    if (height == DEM_INVALID_VALUE) {
        gl_Position = vec4(0, 0, 1, 1);
        return;
    }
    if (u_bool_is_3d_line == true) {
        height += a_float_height / (65535. * 32.);
    }
    Scale scale = calculate_scale(u_vec3_projection_scale_style_scale_dpi, u_vec2_scaler_params);
    StripedLineInParams params = decode_line_params(scale);
    vec2 widen = unpack_widen(a_vec2_widen);
    vec2 widen_perp = vec2(-widen.y, widen.x);
    
    vec4 clip_space_widen = u_mat4_mvp * vec4(widen, 0., 0.);
    vec4 clip_space_widen_perp = u_mat4_mvp * vec4(widen_perp, 0., 0.);
    
    vec4 clip_space_vertex = u_mat4_mvp * vec4(a_vec2_vertex, height, 1.0) + clip_space_widen * params.line_width;
    vec2 half_viewport = 0.5 * u_vec2_vpt_size;
    
    float limited_factor = calculate_multiplication_factor(
        half_viewport,
        clip_space_widen,
        clip_space_widen_perp,
        clip_space_vertex,
        g_shift_pixels);
    PolylineDistance distance_decoded = decode_line_distance();
    StripedLineOutParams output_params;
    calculate_line_params(distance_decoded, params, output_params);
    
    
    vec2 texture_widen_with_shift_sign = unpack_widen(a_vec2_texture_widen);
    float shift_sign = sign(dot(widen, texture_widen_with_shift_sign));
    vec2 texture_widen = shift_sign * texture_widen_with_shift_sign;
    vec2 texture_widen_perp = vec2(-texture_widen.y, texture_widen.x);
    float distance_shift = shift_sign * abs(dot(widen, texture_widen_perp)) * params.line_width;
    float circle_factor = g_circle_scale_precision_factor / scale.calculation;
    v_vec2_circle = texture_widen * (params.line_width + limited_factor) * circle_factor;
    v_float_width = params.line_width * circle_factor;
    v_float_part_color_swap_threshold = output_params.part_color_swap_threshold;
    v_float_distance_in_parts = output_params.distance_in_parts;
    v_vec4_dash_color = apply_opacity(u_vec4_dash_color, u_float_opacity);
    v_vec4_space_color = apply_opacity(u_vec4_space_color, u_float_opacity);
    v_vec4_border_color = apply_opacity(u_vec4_border_color, u_float_opacity);
    gl_Position = clip_space_vertex + clip_space_widen * limited_factor;
    vec3 pos_world = calc_pos_world(a_vec2_vertex);
    calc_fog_pos(pos_world);
#ifdef TAA
    apply_vertex_jitter(gl_Position);
#endif
    gl_Position *= g_w_factor;
    compute_shadow_vertex(clip_space_vertex, vec3(0.0, 0.0, 1.0), u_mat4_mvp);
}
`,$B=`#include <prelude>
#include <mvp_mat>
#include <packed_attributes>
#include <pixel_offset>
#include <calculate_scale>
#include <line_width>
#include <apply_opacity>
#include <precision_constants>
#include <striped_line_functions>
#include <dem>
uniform vec4 u_vec4_dash_color;
uniform vec4 u_vec4_space_color;
uniform vec4 u_vec4_border_color;
uniform mediump vec2 u_vec2_vpt_size;
uniform vec3 u_vec3_projection_scale_style_scale_dpi;
uniform float u_float_width;
uniform float u_float_width_offset;
uniform vec2 u_vec2_scaler_params;
uniform float u_float_dash_length;
uniform float u_float_space_length;
uniform float u_float_dash2_length;
uniform float u_float_opacity;
uniform bool u_bool_is_3d_line;
attribute vec2 a_vec2_vertex;
attribute vec2 a_vec2_texture_widen;
attribute vec2 a_vec2_widen;
attribute float a_float_vertex_distance;
attribute float a_float_component_distance;
attribute float a_float_object_length;
attribute vec4 a_vec4_identifier;
attribute float a_float_height;
varying vec4 v_vec4_identifier;
const float g_shift_pixels = 2.;
const float g_w_factor = 1e-7;
PolylineDistance decode_line_distance()
{
    return PolylineDistance(
        a_float_vertex_distance,
        a_float_component_distance,
        a_float_object_length);
}
StripedLineInParams decode_line_params(const Scale scale)
{
    float width = calculate_final_width(scale, u_float_width, u_float_width_offset);
    float dash_length  = scale.calculation * u_float_dash_length;
    float space_length = scale.calculation * u_float_space_length;
    float dash2_length = scale.calculation * u_float_dash2_length;
    return StripedLineInParams(
        dash_length,
        space_length,
        dash2_length,
        width);
}
void main()
{
    float height = 0.;
    if (u_bool_is_3d_line == true) {
        height = dem_height(a_vec2_vertex);
    }
    if (height == DEM_INVALID_VALUE) {
        gl_Position = vec4(0, 0, 1, 1);
        return;
    }
    if (u_bool_is_3d_line == true) {
        height += a_float_height / (65535. * 32.);
    }
    Scale scale = calculate_scale(u_vec3_projection_scale_style_scale_dpi, u_vec2_scaler_params);
    StripedLineInParams params = decode_line_params(scale);
    vec2 widen = unpack_widen(a_vec2_widen);
    vec2 widen_perp = vec2(-widen.y, widen.x);
    
    vec4 clip_space_widen = u_mat4_mvp * vec4(widen, 0., 0.);
    vec4 clip_space_widen_perp = u_mat4_mvp * vec4(widen_perp, 0., 0.);
    
    vec4 clip_space_vertex = u_mat4_mvp * vec4(a_vec2_vertex, height, 1.0) + clip_space_widen * params.line_width;
    vec2 half_viewport = 0.5 * u_vec2_vpt_size;
    
    float limited_factor = calculate_multiplication_factor(
        half_viewport,
        clip_space_widen,
        clip_space_widen_perp,
        clip_space_vertex,
        g_shift_pixels);
    PolylineDistance distance_decoded = decode_line_distance();
    StripedLineOutParams output_params;
    calculate_line_params(distance_decoded, params, output_params);
    v_vec4_identifier = a_vec4_identifier;
    if (vec4(1., 1., 1., 1.) != a_vec4_identifier)
    {
        gl_Position = (clip_space_vertex + clip_space_widen * limited_factor) * g_w_factor;
    }
    else
    {
        gl_Position = vec4(1., 1., 1., 1.);
    }
}
`,WB=`#include <prelude>
#include <mvp_mat>
#include <dem>
#include <packed_attributes>
#include <apply_height_factor>
#include <pos_world>
#include <cam_pos>
#include <fog>
#include <clipspace_pos>
#include <jitter>
#include <shadow>
uniform float u_float_height_factor;
attribute vec3 a_vec3_vertex;
attribute vec2 a_vec2_texcoord;
attribute vec2 a_vec2_dem_position;
varying vec2 v_vec2_texcoord;
varying vec3 v_vec3_rotated_scaled_vertex;
void main()
{
    float height = dem_height(unpack_dem_position(a_vec2_dem_position));
    
    if (height == DEM_INVALID_VALUE) {
        gl_Position = vec4(0, 0, 1, 1);
        return;
    }
    v_vec2_texcoord = unpack_model_texcoord(a_vec2_texcoord);
    vec4 vh = apply_height_factor(a_vec3_vertex, u_float_height_factor);
    vh.z += height;
    vec3 pos_world = calc_pos_world(vh);
    calc_fog_pos(pos_world);
    gl_Position = u_mat4_mvp * vh;
    
    
    mat4 rotation_scale_mat = u_mat4_model;
    rotation_scale_mat[3].xyz = vec3(0);
    v_vec3_rotated_scaled_vertex = (rotation_scale_mat * vec4(a_vec3_vertex, 1)).xyz;
    save_clipspace_pos();
#ifdef TAA
    apply_vertex_jitter(gl_Position);
#endif
    
    compute_shadow_vertex(gl_Position);
}
`,ZB=`#include <prelude>
#include <mvp_mat>
#include <dem>
#include <round_position>
uniform vec2 u_vec2_vpt_size;
attribute vec3 a_vec3_vertex;
attribute vec4 a_vec4_identifier;
attribute vec2 a_vec2_dem_position;
varying vec4 v_vec4_identifier;
void main()
{
    float height = dem_height(unpack_dem_position(a_vec2_dem_position));
    
    if (height == DEM_INVALID_VALUE) {
        gl_Position = vec4(0, 0, 1, 1);
        return;
    }
    v_vec4_identifier = a_vec4_identifier;
    if (vec4(1., 1., 1., 1.) != a_vec4_identifier)
    {
        gl_Position = round_position(u_mat4_mvp * vec4(a_vec3_vertex.xy, a_vec3_vertex.z + height, 1.), .5 * u_vec2_vpt_size);
    }
    else
    {
        gl_Position = vec4(1., 1., 1., 1.);
    }
}
`,XB=`#include <prelude>
#include <mvp_mat>
#include <dem>
#include <apply_height_factor>
uniform float u_float_height_factor;
attribute vec3 a_vec3_vertex;
attribute vec2 a_vec2_dem_position;
varying float v_depth_metric;
void main()
{
    float height = dem_height(unpack_dem_position(a_vec2_dem_position));
    
    if (height == DEM_INVALID_VALUE) {
        gl_Position = vec4(0, 0, 1, 1);
        return;
    }
    vec4 vh = apply_height_factor(a_vec3_vertex, u_float_height_factor);
    vh.z += height;
    gl_Position = u_mat4_mvp * vh;
    v_depth_metric = (gl_Position.z + 1.0) / 2.0;
}
`,YB={apply_height_factor:Lz,apply_opacity:sw,arrow_functions:Fz,calculate_scale:kz,cam_pos:aw,clipspace_pos:Rz,dem:zz,depth_test:Bz,ecef_mvp_mat:Oz,fog:Dz,jitter:Nz,line_width:Uz,mvp_mat:Gz,packed_attributes:Hz,pixel_offset:Vz,pos_world:jz,precision_constants:$z,prelude:Wz,raster_functions:Zz,round_position:Xz,shadow:Yz,signed_distance_functions:lw,striped_line_functions:qz},qB={arrow_line_entrance:Kz,building_shadow:Jz,circle_marker:Qz,circle_marker_identify:eB,color:tB,color_identify:nB,dem_elevation:iB,dem_elevation_copy:oB,dem_flat_bottom:rB,dem_ground:sB,dem_ground2:aB,dem_mesh:lB,dem_mesh2:cB,dem_normal:dB,diffuse:uB,diffuse_identify:fB,globe:hB,globe_halo:_B,gltf_model:mB,gltf_shadow:pB,heatmap:gB,heatmap_texture:vB,label_directional:yB,label_fixed_anchor:bB,label_fixed_anchor_identify:wB,line:xB,line3d:SB,line3d_identify:MB,map_mesh:TB,mesh:IB,mesh_shadow:EB,mesh_stroke:AB,metric_point:CB,one_way_line:PB,patterned_line:LB,point_anchor:FB,pointsprite:kB,pointsprite_identify:RB,posteffect:zB,rect:BB,rect_with_texture:OB,road:DB,road_identify:NB,simple_line:UB,simple_mesh:GB,sky:HB,stars:VB,striped_line:jB,striped_line_identify:$B,zbm_model:WB,zbm_model_identify:ZB,zbm_shadow:XB},KB=/^\s*#include\s+<(.+)>.*$/gim,JB=(t,e)=>(n,i)=>{const o=i.trim(),r=t==="vertex"?YB[o]:Cz[o];if(!r)throw new Error(`Cannot resolve "include <${o}>" in ${t} shader "${e}"`);return r+`
`};function cw(t,e){return[(t==="vertex"?qB[e]:Pz[e]).replace(KB,JB(t,e))]}function ue(t){const e=Jr.webglVersion===2?["#version 300 es"]:[],n=Xo.createShaderDefinitions([{type:`WEBGL${Jr.webglVersion}`,value:""},{type:Ek,value:""}]);return i=>new Xo("vertex",e.concat(cw("vertex",t)),n,i)}function fe(t){const e=Jr.webglVersion===2?["#version 300 es"]:[],n=Xo.createShaderDefinitions([{type:`WEBGL${Jr.webglVersion}`,value:""},{type:Ik,value:""}]);return i=>new Xo("fragment",e.concat(cw("fragment",t)),n,i)}const Pe={name:"u_mat4_mvp",type:"mat4"},To=[{name:"u_mat4_flat_mvp",type:"mat4"},{name:"u_mat4_ecef_mvp",type:"mat4"},{name:"u_float_crossfade",type:"1f"}],$e={name:"u_mat4_model",type:"mat4"},Y_=[{name:"u_vec2_anchor",type:"2f"},{name:"u_vec4_axis",type:"4f"},{name:"u_int_gltf_dem_pos",type:"1i"}],Xe=[{name:"u_tex_dem",type:"1i"},{name:"u_tex_corrected_dem",type:"1i"},{name:"u_float_corrected_interval",type:"1f"},{name:"u_mat4_dem_corrected",type:"mat4"},{name:"u_tex_hillshade_ramp",type:"1i"},{name:"u_mat4_dem_mvp",type:"mat4"},{name:"u_float_dem_scale",type:"1f"},{name:"u_float_vertical_scale",type:"1f"},{name:"u_float_dem_resolution",type:"1f"},{name:"u_float_dem_cell_size",type:"1f"},{name:"u_float_dem_shading_intensity",type:"1f"},{name:"u_float_map_center_elevation",type:"1f"}],rr=[{name:"u_int_abs_z",type:"1i"}],nt=[{name:"u_cam_pos",type:"3f"}],Ft=[{name:"u_int_light_flags",type:"1i"},{name:"u_vec4_ambient_color",type:"4fv"},{name:"u_vec3_light_dir1_direction",type:"3fv"},{name:"u_vec4_light_dir1_color",type:"4fv"},{name:"u_vec3_light_dir2_direction",type:"3fv"},{name:"u_vec4_light_dir2_color",type:"4fv"}],kt=[{name:"u_texture_shadow",type:"1i"},{name:"u_mat4_clip_to_shadow",type:"mat4"},{name:"u_shadow_map_params",type:"4f"},{name:"u_shadow_bias",type:"1f"}],it=[{name:"u_fog_color",type:"4f"},{name:"u_sky_color",type:"4f"},{name:"u_fog_limits",type:"2f"},{name:"u_fog_horizon_blend",type:"1f"},{name:"u_fog_horizon_level",type:"1f"},{name:"u_mat4_model",type:"mat4"},{name:"u_fog_distance",type:"1f"},{name:"u_mat4_proj_inverted",type:"mat4"},{name:"u_mat4_view_transposed",type:"mat4"}],Wt=[{name:"u_vec2_camera_jitter",type:"2f"}];function QB(){return{simpleMesh:{buildFragment:fe("simple_mesh"),buildVertex:ue("simple_mesh"),attributes:[{name:"a_vec3_position",location:0},{name:"a_vec3_normal",location:1}],uniforms:[Pe,{name:"u_float_scale",type:"1f"},{name:"u_vec3_transform",type:"3fv"}]},diffuse:{buildVertex:ue("diffuse"),buildFragment:fe("color_with_z_fade"),uniforms:[Pe,$e,{name:"u_vec4_color",type:"4fv"},{name:"u_float_height_factor",type:"1f"},{name:"u_float_opacity",type:"1f"},{name:"u_sdtr_distance",type:"1f"},{name:"u_float_floor_elevation",type:"1f"},...nt,...Ft,...kt,...Xe,...it,...Wt],attributes:[{name:"a_vec4_vertex",location:0},{name:"a_vec2_dem_position",location:1},{name:"a_float_visibility",location:2}]},gradientDiffuse:{buildVertex:ue("diffuse"),buildFragment:fe("gradient_with_z_fade"),uniforms:[Pe,$e,{name:"u_vec4_color",type:"4fv"},{name:"u_float_height_factor",type:"1f"},{name:"u_float_opacity",type:"1f"},{name:"u_mat4_gradient",type:"mat4"},{name:"u_sdtr_distance",type:"1f"},{name:"u_float_floor_elevation",type:"1f"},...nt,...Ft,...kt,...Xe,...it,...Wt],attributes:[{name:"a_vec4_vertex",location:0},{name:"a_vec2_dem_position",location:1},{name:"a_float_visibility",location:2}]},labelLine:{buildVertex:ue("label_directional"),buildFragment:fe("label_directional"),uniforms:[Pe,$e,{name:"u_float_tile_to_pixel_ratio",type:"1f"},{name:"u_sr2d_texture",type:"1i"},{name:"u_float_buffer",type:"1f"},{name:"u_float_gamma",type:"1f"},{name:"u_float_scale",type:"1f"},{name:"u_vec4_color",type:"4fv"},{name:"u_float_style_zoom",type:"1f"},{name:"u_float_height_factor",type:"1f"},{name:"u_float_opacity",type:"1f"},...nt,...it],attributes:[{name:"a_vec4_position",location:0},{name:"a_vec2_offset",location:1},{name:"a_vec2_texcoord",location:2},{name:"a_vec2_style_zoom_limits",location:3}]},labelPoint:{buildVertex:ue("label_fixed_anchor"),buildFragment:fe("label"),uniforms:[...To,$e,{name:"u_vec2_vpt_size",type:"2f"},{name:"u_sr2d_texture",type:"1i"},{name:"u_float_buffer",type:"1f"},{name:"u_float_gamma",type:"1f"},{name:"u_float_scale",type:"1f"},{name:"u_vec4_color",type:"4fv"},{name:"u_vec4_hidden_color",type:"4fv"},{name:"u_float_label_index",type:"1f"},{name:"u_float_opacity",type:"1f"},{name:"u_vec2_offset",type:"2f"},{name:"u_float_height_factor",type:"1f"},{name:"u_depth_tex_labeling",type:"1i"},{name:"u_color_tex_labeling",type:"1i"},{name:"u_color_text_sprite_labeling",type:"1i"},{name:"u_vec2_depth_test_half_point_size",type:"2f"},{name:"u_bool_skip_height_factor",type:"1i"},{name:"u_bool_depth_test_disable",type:"1i"},{name:"u_float_floor_elevation",type:"1f"},...nt,...Xe,...it],attributes:[{name:"a_vec3_flat_position",location:0},{name:"a_vec3_ecef_position",location:1},{name:"a_vec2_offset",location:2},{name:"a_vec2_texcoord",location:3},{name:"a_vec2_check_offset",location:4},{name:"a_vec4_tex_identifier",location:5},{name:"a_vec4_sprite_identifier",location:6}]},labelPointIdentify:{buildVertex:ue("label_fixed_anchor_identify"),buildFragment:fe("color_identify"),uniforms:[...To,{name:"u_vec2_vpt_size",type:"2f"},{name:"u_float_scale",type:"1f"},{name:"u_vec2_offset",type:"2f"},{name:"u_float_floor_elevation",type:"1f"},...Xe],attributes:[{name:"a_vec3_flat_position",location:0},{name:"a_vec3_ecef_position",location:1},{name:"a_vec2_offset",location:2},{name:"a_vec4_identifier",location:3}]},line:{buildVertex:ue("line"),buildFragment:fe("line"),uniforms:[Pe,$e,{name:"u_vec2_vpt_size",type:"2fv"},{name:"u_vec4_color",type:"4fv"},{name:"u_float_height_factor",type:"1f"},{name:"u_float_opacity",type:"1f"},{name:"u_mat4_gradient",type:"mat4"},{name:"u_float_floor_elevation",type:"1f"},...nt,...Ft,...kt,...Xe,...it,...Wt],attributes:[{name:"a_vec4_vertex",location:0},{name:"a_vec2_normal",location:1},{name:"a_vec2_normal_delta",location:2},{name:"a_vec3_direction",location:3},{name:"a_float_distance",location:4},{name:"a_vec2_dem_position",location:5},{name:"a_float_visibility",location:6}]},pointSprite:{buildVertex:ue("pointsprite"),buildFragment:fe("pointsprite"),uniforms:[...To,$e,{name:"u_vec2_vpt_size",type:"2fv"},{name:"u_vec3_projection_scale_style_scale_dpi",type:"3fv"},{name:"u_sr2d_texture",type:"1i"},{name:"u_float_rounding_factor",type:"1f"},{name:"u_float_height_factor",type:"1f"},{name:"u_vec2_opacity",type:"2f"},{name:"u_vec2_rotation",type:"2fv"},{name:"u_depth_tex_labeling",type:"1i"},{name:"u_color_tex_labeling",type:"1i"},{name:"u_color_text_sprite_labeling",type:"1i"},{name:"u_vec2_depth_test_half_point_size",type:"2f"},{name:"u_bool_skip_height_factor",type:"1i"},{name:"u_bool_depth_test_disable",type:"1i"},{name:"u_float_floor_elevation",type:"1f"},...nt,...Xe,...it],attributes:[{name:"a_vec3_flat_position",location:0},{name:"a_vec3_ecef_position",location:1},{name:"a_vec2_offset",location:2},{name:"a_vec2_check_offset",location:3},{name:"a_vec2_texcoord",location:4},{name:"a_vec2_range",location:5},{name:"a_vec2_rescale",location:6},{name:"a_vec4_tex_identifier",location:7}]},pointSpriteIdentify:{buildVertex:ue("pointsprite_identify"),buildFragment:fe("pointsprite_identify"),uniforms:[...To,{name:"u_vec2_vpt_size",type:"2fv"},{name:"u_vec3_projection_scale_style_scale_dpi",type:"3fv"},{name:"u_sr2d_texture",type:"1i"},{name:"u_float_height_factor",type:"1f"},{name:"u_vec2_rotation",type:"2fv"},{name:"u_bool_skip_height_factor",type:"1i"},{name:"u_float_floor_elevation",type:"1f"},...Xe],attributes:[{name:"a_vec3_flat_position",location:0},{name:"a_vec3_ecef_position",location:1},{name:"a_vec2_offset",location:2},{name:"a_vec2_texcoord",location:3},{name:"a_vec2_range",location:4},{name:"a_vec2_rescale",location:5},{name:"a_vec4_identifier",location:6}]},pointDepthTest:{buildVertex:ue("point_anchor"),buildFragment:fe("color_identify"),uniforms:[Pe,{name:"u_vec2_vpt_size",type:"2f"},{name:"u_vec2_offset",type:"2f"},{name:"u_float_floor_elevation",type:"1f"},...Xe],attributes:[{name:"a_vec4_position",location:0},{name:"a_vec2_offset",location:1},{name:"a_vec4_identifier",location:2}]},stripedLine:{buildVertex:ue("striped_line"),buildFragment:fe("striped_line"),uniforms:[Pe,$e,{name:"u_vec2_vpt_size",type:"2fv"},{name:"u_vec3_projection_scale_style_scale_dpi",type:"3fv"},{name:"u_vec2_scaler_params",type:"2fv"},{name:"u_float_dash_length",type:"1f"},{name:"u_float_space_length",type:"1f"},{name:"u_float_dash2_length",type:"1f"},{name:"u_vec4_dash_color",type:"4fv"},{name:"u_vec4_space_color",type:"4fv"},{name:"u_vec4_border_color",type:"4fv"},{name:"u_float_width",type:"1f"},{name:"u_float_width_offset",type:"1f"},{name:"u_float_opacity",type:"1f"},{name:"u_bool_is_3d_line",type:"1i"},...nt,...it,...Wt,...Ft,...kt],attributes:[{name:"a_vec2_vertex",location:0},{name:"a_vec2_texture_widen",location:1},{name:"a_vec2_widen",location:2},{name:"a_float_vertex_distance",location:3},{name:"a_float_component_distance",location:4},{name:"a_float_object_length",location:5},{name:"a_vec4_identifier",location:6}]},stripedLine3D:{buildVertex:ue("striped_line"),buildFragment:fe("striped_line"),uniforms:[Pe,$e,{name:"u_vec2_vpt_size",type:"2fv"},{name:"u_vec3_projection_scale_style_scale_dpi",type:"3fv"},{name:"u_vec2_scaler_params",type:"2fv"},{name:"u_float_dash_length",type:"1f"},{name:"u_float_space_length",type:"1f"},{name:"u_float_dash2_length",type:"1f"},{name:"u_vec4_dash_color",type:"4fv"},{name:"u_vec4_space_color",type:"4fv"},{name:"u_vec4_border_color",type:"4fv"},{name:"u_float_width",type:"1f"},{name:"u_float_width_offset",type:"1f"},{name:"u_float_opacity",type:"1f"},{name:"u_bool_is_3d_line",type:"1i"},...Xe,...nt,...it,...Wt,...Ft,...kt],attributes:[{name:"a_vec2_vertex",location:0},{name:"a_vec2_texture_widen",location:1},{name:"a_vec2_widen",location:2},{name:"a_float_vertex_distance",location:3},{name:"a_float_component_distance",location:4},{name:"a_float_object_length",location:5},{name:"a_vec4_identifier",location:6},{name:"a_float_height",location:7}]},patternedLine:{buildVertex:ue("patterned_line"),buildFragment:fe("patterned_line"),uniforms:[Pe,{name:"u_vec2_scales",type:"2fv"},{name:"u_vec4_color",type:"4fv"},{name:"u_float_width",type:"1f"},{name:"u_float_opacity",type:"1f"},{name:"u_int_pattern_type",type:"1i"},{name:"u_vec4_pattern_params",type:"4fv"},{name:"u_bool_is_3d_line",type:"1i"},$e,...nt,...it,...Wt,...Ft,...kt],attributes:[{name:"a_vec2_vertex",location:0},{name:"a_vec2_widen",location:1},{name:"a_float_texture",location:2},{name:"a_vec4_identifier",location:3}]},patternedLine3D:{buildVertex:ue("patterned_line"),buildFragment:fe("patterned_line"),uniforms:[Pe,{name:"u_vec2_scales",type:"2fv"},{name:"u_vec4_color",type:"4fv"},{name:"u_float_width",type:"1f"},{name:"u_float_opacity",type:"1f"},{name:"u_int_pattern_type",type:"1i"},{name:"u_vec4_pattern_params",type:"4fv"},{name:"u_bool_is_3d_line",type:"1i"},$e,...Xe,...nt,...it,...Wt,...Ft,...kt],attributes:[{name:"a_vec2_vertex",location:0},{name:"a_vec2_widen",location:1},{name:"a_float_texture",location:2},{name:"a_vec4_identifier",location:3},{name:"a_float_height",location:4}]},stripedLineIdentify:{buildVertex:ue("striped_line_identify"),buildFragment:fe("color_identify"),uniforms:[Pe,{name:"u_vec2_vpt_size",type:"2fv"},{name:"u_vec3_projection_scale_style_scale_dpi",type:"3fv"},{name:"u_vec2_scaler_params",type:"2fv"},{name:"u_float_dash_length",type:"1f"},{name:"u_float_space_length",type:"1f"},{name:"u_float_dash2_length",type:"1f"},{name:"u_vec4_dash_color",type:"4fv"},{name:"u_vec4_space_color",type:"4fv"},{name:"u_vec4_border_color",type:"4fv"},{name:"u_float_width",type:"1f"},{name:"u_float_width_offset",type:"1f"},{name:"u_float_opacity",type:"1f"},{name:"u_bool_is_3d_line",type:"1i"}],attributes:[{name:"a_vec2_vertex",location:0},{name:"a_vec2_texture_widen",location:1},{name:"a_vec2_widen",location:2},{name:"a_float_vertex_distance",location:3},{name:"a_float_component_distance",location:4},{name:"a_float_object_length",location:5},{name:"a_vec4_identifier",location:6}]},stripedLine3DIdentify:{buildVertex:ue("striped_line_identify"),buildFragment:fe("color_identify"),uniforms:[Pe,{name:"u_vec2_vpt_size",type:"2fv"},{name:"u_vec3_projection_scale_style_scale_dpi",type:"3fv"},{name:"u_vec2_scaler_params",type:"2fv"},{name:"u_float_dash_length",type:"1f"},{name:"u_float_space_length",type:"1f"},{name:"u_float_dash2_length",type:"1f"},{name:"u_vec4_dash_color",type:"4fv"},{name:"u_vec4_space_color",type:"4fv"},{name:"u_vec4_border_color",type:"4fv"},{name:"u_float_width",type:"1f"},{name:"u_float_width_offset",type:"1f"},{name:"u_float_opacity",type:"1f"},{name:"u_bool_is_3d_line",type:"1i"},...Xe],attributes:[{name:"a_vec2_vertex",location:0},{name:"a_vec2_texture_widen",location:1},{name:"a_vec2_widen",location:2},{name:"a_float_vertex_distance",location:3},{name:"a_float_component_distance",location:4},{name:"a_float_object_length",location:5},{name:"a_vec4_identifier",location:6},{name:"a_float_height",location:7}]},vtxColor:{buildVertex:ue("color"),buildFragment:fe("textured_color"),uniforms:[Pe,$e,{name:"u_vec4_color",type:"4fv"},{name:"u_float_opacity",type:"1f"},{name:"u_sr2d_texture",type:"1i"},{name:"u_float_texture_opacity",type:"1f"},{name:"u_float_texture_params",type:"4fv"},{name:"u_float_sprite_texture_coords",type:"4fv"},{name:"u_int_is_textured",type:"1i"},{name:"u_float_floor_elevation",type:"1f"},...nt,...Ft,...kt,...it,...Wt],attributes:[{name:"a_vec2_vertex",location:0},{name:"a_float_visibility",location:1}]},vtxColorIdentify:{buildVertex:ue("color_identify"),buildFragment:fe("color_identify"),uniforms:[Pe,{name:"u_vec2_vpt_size",type:"2fv"},{name:"u_float_floor_elevation",type:"1f"}],attributes:[{name:"a_vec2_vertex",location:0},{name:"a_vec4_identifier",location:1},{name:"a_float_visibility",location:2}]},metricPoint:{buildVertex:ue("metric_point"),buildFragment:fe("metric_point"),uniforms:[Pe,$e,{name:"u_vec4_color",type:"4fv"},{name:"u_sr2d_texture",type:"1i"},{name:"u_float_sprite_texture_coords",type:"4fv"},{name:"u_float_floor_elevation",type:"1f"},...nt,...it,...Ft,...kt],attributes:[{name:"a_vec2_vertex",location:0},{name:"a_vec2_texcoord",location:1}]},zbmModelIdentify:{buildVertex:ue("zbm_model_identify"),buildFragment:fe("color_identify"),uniforms:[Pe,{name:"u_vec2_vpt_size",type:"2fv"},...Xe],attributes:[{name:"a_vec3_vertex",location:0},{name:"a_vec4_identifier",location:1},{name:"a_vec2_dem_position",location:2}]},buildingIdentify:{buildVertex:ue("diffuse_identify"),buildFragment:fe("color_identify"),uniforms:[Pe,{name:"u_vec2_vpt_size",type:"2fv"},{name:"u_float_height_factor",type:"1f"},{name:"u_float_floor_elevation",type:"1f"},...Xe],attributes:[{name:"a_vec4_vertex",location:0},{name:"a_vec4_identifier",location:1},{name:"a_vec2_dem_position",location:2},{name:"a_float_visibility",location:3}]},oneWayLine:{buildVertex:ue("one_way_line"),buildFragment:fe("one_way_line"),uniforms:[Pe,$e,{name:"u_vec2_vpt_size",type:"2f"},{name:"u_vec3_projection_scale_style_scale_dpi",type:"3fv"},{name:"u_vec4_color",type:"4f"},{name:"u_vec4_border_color",type:"4f"},{name:"u_vec2_wing_normal",type:"2f"},{name:"u_vec2_tip_normal",type:"2f"},{name:"u_float_width",type:"1f"},{name:"u_float_length",type:"1f"},{name:"u_float_tip_radius_zpt",type:"1f"},{name:"u_float_wing_radius_zpt",type:"1f"},{name:"u_float_tail_radius_zpt",type:"1f"},{name:"u_float_border_width",type:"1f"},{name:"u_float_border_width_offset",type:"1f"},{name:"u_float_size_factor",type:"1f"},{name:"u_vec2_scale_limits",type:"2fv"},{name:"u_float_tip_height_multiplier",type:"1f"},{name:"u_float_wing_height_multiplier",type:"1f"},{name:"u_float_wing_width_multiplier",type:"1f"},{name:"u_float_opacity",type:"1f"},...nt,...it,...Wt],attributes:[{name:"a_vec2_position",location:0},{name:"a_vec2_direction",location:1},{name:"a_vec2_widen_direction",location:2}]},zbmModel:{buildVertex:ue("zbm_model"),buildFragment:fe("zbm_model"),uniforms:[Pe,$e,{name:"u_vec4_color",type:"4fv"},{name:"u_sr2d_texture",type:"1i"},{name:"u_float_height_factor",type:"1f"},{name:"u_sdtr_distance",type:"1f"},...nt,...Xe,...it,...Wt,...Ft,...kt],attributes:[{name:"a_vec3_vertex",location:0},{name:"a_vec2_texcoord",location:1},{name:"a_vec2_dem_position",location:2}]},zbmShadow:{buildVertex:ue("zbm_shadow"),buildFragment:fe("main_shadow"),uniforms:[Pe,{name:"u_float_height_factor",type:"1f"},...Xe],attributes:[{name:"a_vec3_vertex",location:0},{name:"a_vec2_dem_position",location:1}]},gltfModel:{buildVertex:ue("gltf_model"),buildFragment:fe("gltf_model"),uniforms:[...To,$e,{name:"u_mat4_instance",type:"mat4"},{name:"u_mat4_localmatrix",type:"mat4"},{name:"u_vec4_color",type:"4fv"},{name:"u_sr2d_texture_0",type:"1i"},{name:"u_ao_texture",type:"1i"},{name:"u_pbr_texture",type:"1i"},{name:"u_float_identify",type:"1f"},{name:"u_sdtr_distance",type:"1f"},{name:"u_float_height_factor",type:"1f"},{name:"u_float_show_ratio",type:"1f"},{name:"u_float_metallic",type:"1f"},{name:"u_float_roughness",type:"1f"},{name:"u_sampler_map_tex",type:"1i"},{name:"u_vec2_tex_scale",type:"2f"},{name:"u_float_tex_shift_scale",type:"1f"},{name:"u_float_floor_elevation",type:"1f"},...nt,...Wt,...it,...Xe,...Ft,...kt,...rr,...Y_],attributes:[{name:"position",location:0},{name:"normal",location:1},{name:"tangent",location:2},{name:"a_vec3_instance_position",location:3},{name:"a_vec3_instance_ecef_position",location:4},{name:"a_mat3_instance_matrix",location:5,locationsCount:3},{name:"a_vec4_instance_localid",location:8},{name:"texcoord_color",location:9},{name:"texcoord_ao",location:10},{name:"texcoord_pbr",location:11},{name:"a_float_abs_z",location:12}]},gltfModelIdentify:{buildVertex:ue("gltf_model"),buildFragment:fe("color_identify"),uniforms:[...To,$e,{name:"u_mat4_instance",type:"mat4"},{name:"u_mat4_localmatrix",type:"mat4"},{name:"u_vec4_color",type:"4fv"},{name:"u_sr2d_texture_0",type:"1i"},{name:"u_float_identify",type:"1f"},{name:"u_float_height_factor",type:"1f"},{name:"u_float_show_ratio",type:"1f"},{name:"u_int_identify",type:"1i"},{name:"u_float_floor_elevation",type:"1f"},...nt,...it,...Xe,...rr,...Y_],attributes:[{name:"position",location:0},{name:"normal",location:1},{name:"tangent",location:2},{name:"a_vec3_instance_position",location:3},{name:"a_vec3_instance_ecef_position",location:4},{name:"a_mat3_instance_matrix",location:5,locationsCount:3},{name:"a_vec4_instance_localid",location:8},{name:"a_float_abs_z",location:12}]},gltfModelShadow:{buildVertex:ue("gltf_shadow"),buildFragment:fe("main_shadow"),uniforms:[...To,{name:"u_mat4_instance",type:"mat4"},{name:"u_mat4_localmatrix",type:"mat4"},{name:"u_float_height_factor",type:"1f"},{name:"u_float_show_ratio",type:"1f"},...Xe,...rr,...Y_],attributes:[{name:"position",location:0},{name:"a_vec3_instance_position",location:3},{name:"a_vec3_instance_ecef_position",location:4},{name:"a_mat3_instance_matrix",location:5,locationsCount:3},{name:"a_float_abs_z",location:12}]},simpleLine:{buildVertex:ue("simple_line"),buildFragment:fe("simple_line"),uniforms:[Pe,$e,{name:"u_vec2_vpt_size",type:"2fv"},{name:"u_vec4_color",type:"4fv"},{name:"u_float_width",type:"1f"},{name:"u_float_height_factor",type:"1f"},{name:"u_int_signed_z",type:"1i"},{name:"u_float_z_offset",type:"1f"},{name:"u_float_floor_elevation",type:"1f"},...nt,...Wt,...Ft,...it,...kt,...Xe,...rr],attributes:[{name:"a_vec3_vertex",location:0},{name:"a_float_z",location:1},{name:"a_vec4_direction_distance",location:2},{name:"a_vec2_dem_position",location:3},{name:"a_float_abs_z",location:4},{name:"a_float_visibility",location:5}]},road:{buildVertex:ue("road"),buildFragment:fe("road"),uniforms:[Pe,$e,{name:"u_vec4_color",type:"4fv"},{name:"u_float_width",type:"1f"},{name:"u_float_tile_to_pixel_ratio",type:"1f"},{name:"u_float_shift",type:"1f"},...nt,...Ft,...it,...Wt,...kt],attributes:[{name:"a_vec2_vertex",location:0},{name:"a_vec4_normals",location:1},{name:"a_vec2_shift",location:2}]},roadIdentify:{buildVertex:ue("road_identify"),buildFragment:fe("road_identify"),uniforms:[Pe,{name:"u_float_width",type:"1f"},{name:"u_float_tile_to_pixel_ratio",type:"1f"}],attributes:[{name:"a_vec2_vertex",location:0},{name:"a_vec4_normals",location:1},{name:"a_vec4_identifier",location:2}]},line3D:{buildVertex:ue("line3d"),buildFragment:fe("road"),uniforms:[Pe,$e,{name:"u_vec4_color",type:"4fv"},{name:"u_float_width",type:"1f"},{name:"u_float_tile_to_pixel_ratio",type:"1f"},...Xe,...nt,...Ft,...it,...Wt,...kt],attributes:[{name:"a_vec2_vertex",location:0},{name:"a_vec4_normals",location:1},{name:"a_float_height",location:2}]},line3DIdentify:{buildVertex:ue("line3d_identify"),buildFragment:fe("road_identify"),uniforms:[Pe,{name:"u_float_width",type:"1f"},{name:"u_float_tile_to_pixel_ratio",type:"1f"},...Xe],attributes:[{name:"a_vec2_vertex",location:0},{name:"a_vec4_normals",location:1},{name:"a_float_height",location:2},{name:"a_vec4_identifier",location:3}]},entrance:{buildVertex:ue("arrow_line_entrance"),buildFragment:fe("arrow_line"),uniforms:[Pe,$e,{name:"u_vec2_vpt_size",type:"2f"},{name:"u_vec3_projection_scale_style_scale_dpi",type:"3fv"},{name:"u_vec2_scale_limits",type:"2fv"},{name:"u_vec4_color",type:"4f"},{name:"u_vec4_border_color",type:"4f"},{name:"u_vec2_wing_normal",type:"2f"},{name:"u_vec2_tip_normal",type:"2f"},{name:"u_float_width_zpt",type:"1f"},{name:"u_float_tip_radius_zpt",type:"1f"},{name:"u_float_wing_radius_zpt",type:"1f"},{name:"u_float_tail_radius_zpt",type:"1f"},{name:"u_float_tip_height_multiplier",type:"1f"},{name:"u_float_wing_width_multiplier",type:"1f"},{name:"u_float_wing_height_multiplier",type:"1f"},{name:"u_float_border_width_zpt",type:"1f"},{name:"u_float_size_factor",type:"1f"},{name:"u_float_border_width_offset",type:"1f"},{name:"u_float_total_line_length",type:"1f"},{name:"u_float_relative_end_position",type:"1f"},{name:"u_float_vertex_shift",type:"1f"},{name:"u_float_tip_movement_amplitude",type:"1f"},{name:"u_vec2_bounce_direction",type:"2f"},{name:"u_float_opacity",type:"1f"},...nt,...it],attributes:[{name:"a_vec2_vertex",location:0},{name:"a_vec2_segment_end",location:1},{name:"a_vec4_texture_widen_arrow_widen",location:2},{name:"a_vec2_widen",location:3},{name:"a_vec2_direction",location:4},{name:"a_float_distance_from_start",location:5},{name:"a_float_object_length",location:6},{name:"a_float_type",location:7},{name:"a_vec4_identifier",location:8}]},entranceIdentify:{buildVertex:ue("arrow_line_entrance"),buildFragment:fe("arrow_line_identify"),uniforms:[Pe,$e,{name:"u_vec2_vpt_size",type:"2f"},{name:"u_vec3_projection_scale_style_scale_dpi",type:"3fv"},{name:"u_vec2_scale_limits",type:"2fv"},{name:"u_vec4_color",type:"4f"},{name:"u_vec4_border_color",type:"4f"},{name:"u_vec2_wing_normal",type:"2f"},{name:"u_vec2_tip_normal",type:"2f"},{name:"u_float_width_zpt",type:"1f"},{name:"u_float_tip_radius_zpt",type:"1f"},{name:"u_float_wing_radius_zpt",type:"1f"},{name:"u_float_tail_radius_zpt",type:"1f"},{name:"u_float_tip_height_multiplier",type:"1f"},{name:"u_float_wing_width_multiplier",type:"1f"},{name:"u_float_wing_height_multiplier",type:"1f"},{name:"u_float_border_width_zpt",type:"1f"},{name:"u_float_size_factor",type:"1f"},{name:"u_float_border_width_offset",type:"1f"},{name:"u_float_total_line_length",type:"1f"},{name:"u_float_relative_end_position",type:"1f"},{name:"u_float_vertex_shift",type:"1f"},{name:"u_float_tip_movement_amplitude",type:"1f"},{name:"u_vec2_bounce_direction",type:"2f"},{name:"u_float_opacity",type:"1f"}],attributes:[{name:"a_vec2_vertex",location:0},{name:"a_vec2_segment_end",location:1},{name:"a_vec4_texture_widen_arrow_widen",location:2},{name:"a_vec2_widen",location:3},{name:"a_vec2_direction",location:4},{name:"a_float_distance_from_start",location:5},{name:"a_float_object_length",location:6},{name:"a_float_type",location:7},{name:"a_vec4_identifier",location:8}]},circleMarker:{buildVertex:ue("circle_marker"),buildFragment:fe("circle_marker"),uniforms:[...To,$e,{name:"u_vec2_vpt_size",type:"2fv"},{name:"u_vec4_color",type:"4fv"},{name:"u_float_width",type:"1f"},...nt,...it,...Ft,...kt],attributes:[{name:"a_vec3_flat_position",location:0},{name:"a_vec3_ecef_position",location:1},{name:"a_vec2_widen",location:2}]},rect:{buildVertex:ue("rect"),buildFragment:fe("rect"),uniforms:[Pe,{name:"u_vec4_color",type:"4fv"}],attributes:[{name:"a_vec2_vertex",location:0}]},rectWithTexture:{buildVertex:ue("rect_with_texture"),buildFragment:fe("rect_with_texture"),uniforms:[Pe,$e,{name:"u_sr2d_texture",type:"1i"},{name:"u_float_opacity",type:"1f"},...it,...nt],attributes:[{name:"a_vec2_vertex",location:0},{name:"a_vec2_texcoord",location:1}]},circleMarkerIdentify:{buildVertex:ue("circle_marker_identify"),buildFragment:fe("color_identify"),uniforms:[...To,{name:"u_vec2_vpt_size",type:"2fv"},{name:"u_float_width",type:"1f"}],attributes:[{name:"a_vec3_flat_position",location:0},{name:"a_vec3_ecef_position",location:1},{name:"a_vec2_widen",location:2},{name:"a_vec4_identifier",location:3}]},heatmap:{buildVertex:ue("heatmap"),buildFragment:fe("heatmap"),uniforms:[Pe,$e,...nt,{name:"u_float_radius",type:"1f"},{name:"u_float_intensity",type:"1f"},{name:"u_float_tile_to_pixel_ratio",type:"1f"},...it],attributes:[{name:"a_vec2_position",location:0},{name:"a_vec2_widen",location:1},{name:"a_float_weight",location:2}]},heatmapTexture:{buildVertex:ue("heatmap_texture"),buildFragment:fe("heatmap_texture"),uniforms:[$e,{name:"u_sr2d_texture",type:"1i"},{name:"u_sr2d_ramp_texture",type:"1i"},{name:"u_float_opacity",type:"1f"},...nt,...it],attributes:[{name:"a_vec2_position",location:0}]},demMesh:{buildVertex:ue("dem_mesh"),buildFragment:fe("dem_mesh"),uniforms:[Pe,$e,{name:"u_mat4_flat_map_mvp",type:"mat4"},{name:"u_flat_tex",type:"1i"},{name:"u_hillshade_tex",type:"1i"},...nt,...Xe,...it,...Wt,...Ft,...kt],attributes:[{name:"a_vec2_position",location:0}]},demGround:{buildVertex:ue("dem_ground"),buildFragment:fe("dem_ground"),uniforms:[Pe,$e,...Xe],attributes:[{name:"a_vec2_position",location:0}]},demMesh2:{buildVertex:ue("dem_mesh2"),buildFragment:fe("dem_mesh2"),uniforms:[Pe,$e,{name:"u_mat4_flat_map_mvp",type:"mat4"},{name:"u_flat_tex",type:"1i"},{name:"u_hillshade_tex",type:"1i"},...nt,...Xe,...it,...Wt,...Ft,...kt,{name:"u_use_flat_dem_mesh_normals",type:"1f"}],attributes:[{name:"a_vec2_vertex",location:0},{name:"a_vec3_normal",location:1},{name:"a_float_height",location:2}]},demGround2:{buildVertex:ue("dem_ground2"),buildFragment:fe("dem_ground2"),uniforms:[Pe,$e,...Xe],attributes:[{name:"a_vec2_vertex",location:0},{name:"a_float_height",location:1}]},demElevationCopy:{buildVertex:ue("dem_elevation_copy"),buildFragment:fe("dem_elevation_copy"),uniforms:[Pe,{name:"u_sr2d_texture",type:"1i"},{name:"u_mat4_dem_corrected",type:"mat4"}],attributes:[{name:"a_vec2_vertex",location:0},{name:"a_vec2_texcoord",location:1}]},demElevation:{buildVertex:ue("dem_elevation"),buildFragment:fe("dem_elevation"),uniforms:[Pe],attributes:[{name:"a_vec2_vertex",location:0},{name:"a_float_height",location:1}]},demHillshade:{buildVertex:ue("dem_normal"),buildFragment:fe("dem_normal"),uniforms:[...Xe,...Ft,...kt,Pe,{name:"u_sr2d_texture",type:"1i"}],attributes:[{name:"a_vec2_vertex",location:0},{name:"a_vec2_texcoord",location:1}]},demFlatBottom:{buildVertex:ue("dem_flat_bottom"),buildFragment:fe("dem_flat_bottom"),uniforms:[Pe,...Xe],attributes:[{name:"a_vec2_vertex",location:0},{name:"a_vec2_centroid",location:1},{name:"a_vec2_extender",location:2}]},mesh:{buildVertex:ue("mesh"),buildFragment:fe("mesh"),uniforms:[Pe,$e,...nt,...Xe,...rr,...Ft,...kt,...it,...Wt,{name:"u_float_opacity",type:"1f"},{name:"u_vec4_color",type:"4fv"},{name:"u_float_height_factor",type:"1f"},{name:"u_sdtr_distance",type:"1f"},{name:"u_mat4_gradient",type:"mat4"},{name:"u_int_identify",type:"1i"},{name:"u_sr2d_texture",type:"1i"},{name:"u_float_texture_opacity",type:"1f"},{name:"u_float_texture_params",type:"4fv"},{name:"u_float_sprite_texture_coords",type:"4fv"},{name:"u_int_is_textured",type:"1i"},{name:"u_float_texture_vertical_scale",type:"1f"}],attributes:[{name:"a_vec2_vertex",location:0},{name:"a_float_z",location:1},{name:"a_vec3_normal",location:2},{name:"a_float_gradient",location:3},{name:"a_vec2_dem_position",location:4},{name:"a_float_abs_z",location:5},{name:"a_vec4_identifier",location:6},{name:"a_float_visibility",location:7},{name:"a_float_is_pivot",location:8}]},meshDepthClear:{buildVertex:ue("mesh"),buildFragment:fe("depth_clear"),uniforms:[Pe,$e,...nt,...Xe,...rr,...Ft,...kt,...it,...Wt,{name:"u_float_opacity",type:"1f"},{name:"u_vec4_color",type:"4fv"},{name:"u_float_height_factor",type:"1f"},{name:"u_sdtr_distance",type:"1f"},{name:"u_mat4_gradient",type:"mat4"},{name:"u_int_identify",type:"1i"},{name:"u_float_texture_params",type:"4fv"},{name:"u_int_is_textured",type:"1i"},{name:"u_float_texture_vertical_scale",type:"1f"}],attributes:[{name:"a_vec2_vertex",location:0},{name:"a_float_z",location:1},{name:"a_vec3_normal",location:2},{name:"a_float_gradient",location:3},{name:"a_vec2_dem_position",location:4},{name:"a_float_abs_z",location:5},{name:"a_vec4_identifier",location:6},{name:"a_float_visibility",location:7},{name:"a_float_is_pivot",location:8}]},meshStroke:{buildVertex:ue("mesh_stroke"),buildFragment:fe("simple_line"),uniforms:[Pe,$e,{name:"u_vec2_vpt_size",type:"2fv"},{name:"u_vec4_color",type:"4fv"},{name:"u_float_width",type:"1f"},{name:"u_float_height_factor",type:"1f"},{name:"u_int_signed_z",type:"1i"},{name:"u_float_z_offset",type:"1f"},...nt,...Wt,...Ft,...it,...kt,...Xe,...rr],attributes:[{name:"a_vec2_vertex",location:0},{name:"a_float_z",location:1},{name:"a_vec4_direction_distance",location:2},{name:"a_vec2_dem_position",location:3},{name:"a_float_abs_z",location:4},{name:"a_float_visibility",location:5},{name:"a_float_is_pivot",location:6}]},mapMesh:{buildVertex:ue("map_mesh"),buildFragment:fe("map_mesh"),uniforms:[Pe,$e,...nt,...Xe,...Ft,...kt,...rr,...it,...Wt,{name:"u_float_tile_size",type:"1f"},{name:"u_sampler_map_tex",type:"1i"},{name:"u_vec2_tex_scale",type:"2f"},{name:"u_float_tex_shift_scale",type:"1f"},{name:"u_float_height_factor",type:"1f"},{name:"u_sdtr_distance",type:"1f"},{name:"u_int_identify",type:"1i"}],attributes:[{name:"a_vec2_vertex",location:0},{name:"a_float_z",location:1},{name:"a_vec2_extender",location:2},{name:"a_vec3_normal",location:3},{name:"a_float_gradient",location:4},{name:"a_vec2_dem_position",location:5},{name:"a_float_abs_z",location:6},{name:"a_float_is_pivot",location:7}]},sky:{buildVertex:ue("sky"),buildFragment:fe("sky"),uniforms:[$e,...nt,...it,{name:"u_sky_color",type:"4f"}],attributes:[{name:"a_vec2_vertex",location:0}]},antialias:{buildVertex:ue("posteffect"),buildFragment:fe("antialias"),uniforms:[{name:"u_texture",type:"1i"},{name:"u_float_mix_coef",type:"1f"}],attributes:[{name:"a_vec2_vertex",location:0}]},copy:{buildVertex:ue("posteffect"),buildFragment:fe("copy"),uniforms:[{name:"u_texture",type:"1i"}],attributes:[{name:"a_vec2_vertex",location:0}]},copyDepth:{buildVertex:ue("posteffect"),buildFragment:fe("copy_depth"),uniforms:[{name:"u_texture",type:"1i"},{name:"u_depth",type:"1i"}],attributes:[{name:"a_vec2_vertex",location:0}]},buildingShadow:{buildVertex:ue("building_shadow"),buildFragment:fe("main_shadow"),uniforms:[...Xe,Pe,{name:"u_float_height_factor",type:"1f"},{name:"u_float_floor_elevation",type:"1f"}],attributes:[{name:"a_vec3_vertex",location:0},{name:"a_vec2_dem_position",location:1},{name:"a_float_visibility",location:2}]},meshShadow:{buildVertex:ue("mesh_shadow"),buildFragment:fe("main_shadow"),uniforms:[Pe,{name:"u_float_height_factor",type:"1f"},...Xe,...rr],attributes:[{name:"a_vec2_vertex",location:0},{name:"a_float_z",location:1},{name:"a_vec2_dem_position",location:2},{name:"a_float_abs_z",location:3},{name:"a_float_visibility",location:4},{name:"a_float_is_pivot",location:5}]},globe:{buildVertex:ue("globe"),buildFragment:fe("globe"),uniforms:[...To,{name:"u_sr2d_flatmap_texture",type:"1i"},{name:"u_vec4_extent",type:"4f"}],attributes:[{name:"a_vec3_ecef_position",location:0},{name:"a_vec3_flat_position",location:1},{name:"a_vec2_texture",location:2}]},globeHalo:{buildVertex:ue("globe_halo"),buildFragment:fe("globe_halo"),uniforms:[{name:"u_vec2_halo_viewport_size",type:"2f"},{name:"u_vec2_halo_viewport_center_shift",type:"2f"},{name:"u_vec4_halo_radius_stops",type:"4f"},{name:"u_vec4_halo_color",type:"4f"},{name:"u_float_halo_exp_factor",type:"1f"},{name:"u_vec4_default_background_color",type:"4f"}],attributes:[{name:"a_vec2_vertex",location:0}]},stars:{buildVertex:ue("stars"),buildFragment:fe("stars"),uniforms:[{name:"u_mat4_stars",type:"mat4"},{name:"u_float_pixelratio",type:"1f"},{name:"u_float_stars_intensity",type:"1f"}],attributes:[{name:"a_vec3_position",location:0},{name:"a_fade_opacity",location:1}]},globeHaloBackground:{buildVertex:ue("globe_halo"),buildFragment:fe("globe_halo_background"),uniforms:[{name:"u_vec2_halo_viewport_size",type:"2f"},{name:"u_vec2_halo_viewport_center_shift",type:"2f"},{name:"u_vec4_halo_radius_stops",type:"4f"},{name:"u_vec4_halo_color",type:"4f"},{name:"u_float_halo_exp_factor",type:"1f"},{name:"u_vec4_default_background_color",type:"4f"}],attributes:[{name:"a_vec2_vertex",location:0}]}}}function eO(t,e){if(window.requestIdleCallback){const n=t.getRenderingContext();for(const i in e){const o=i;window.requestIdleCallback(()=>{if(n.isContextLost())return;const r=t.getShaderProgram(o);r.link(n),setTimeout(()=>{window.requestIdleCallback(()=>{n.isContextLost()||r.locate(n)})},2e3)})}}}class n2{constructor(e){this.params=e,this._uniformsMap={},this._buffer=null,this._data=null}prepare(e,n){this._buffer||(this._buffer=e.createBuffer());const i=n.getUniformBlockSize(e,this.params.blockName);if(i===null){console.error("Failed to initialize UBO. Invalid UBO block is provided.");return}this._data=new Float32Array(new ArrayBuffer(i));const o=n.getUniformsIndicesOffsetsInBlock(e,this.params.uniformNames);if(!o){console.error("Failed to initialize UBO. Couldn't retrieve uniforms information.");return}this._uniformsMap=o}bind(e,n){const i=n.getUboBinding(this.params.blockName);i!==void 0&&(this._buffer||this.prepare(e,n),e.bindBufferBase(e.UNIFORM_BUFFER,i,this._buffer))}updateData(e,n,i){this._buffer||this.prepare(e,n);const o=this._data;for(const r in i){const s=i[r],a=this._uniformsMap[r]/4,l=n.uniforms[r];if(l!=null&&l.isNonFloatType()&&ct(`[UBO Warn]: Currenty only float uniform types are supported. Uniform "${r}" has unsupported type`),L8(s)||uo(s))for(let c=0;c<s.length;++c)o[a+c]=s[c];else o[a]=s}}commitData(e){this._data&&(e.bindBuffer(e.UNIFORM_BUFFER,this._buffer),e.bufferData(e.UNIFORM_BUFFER,this._data,e.DYNAMIC_DRAW),e.bindBuffer(e.UNIFORM_BUFFER,null))}cleanup(e){this._buffer&&e.deleteBuffer(this._buffer)}}const tO=["CommonSettings","LightSettings"],i2={CommonSettings:["u_float_rounding_factor","u_float_border_width_offset","u_vec2_scale_limits","u_vec2_depth_test_half_point_size","u_sky_color","u_fog_color","u_fog_distance","u_fog_limits","u_fog_horizon_blend","u_fog_horizon_level","u_cam_pos","u_shadow_map_params","u_shadow_bias","u_mat4_clip_to_shadow","u_mat4_view_transposed","u_mat4_proj_inverted","u_vec2_halo_viewport_size","u_vec2_halo_viewport_center_shift","u_vec4_halo_radius_stops","u_vec4_halo_color","u_float_halo_exp_factor","u_vec4_default_background_color","u_float_pixelratio","u_mat4_stars","u_float_stars_intensity"],LightSettings:["u_vec4_ambient_color","u_vec3_light_dir1_direction","u_vec4_light_dir1_color","u_vec3_light_dir2_direction","u_vec4_light_dir2_color"]},nO=1.3,iO=2,o2=po(),r2=po(),s2=po(),oO=16,rO=0,zo=[1,1,1,1],a2=new Float64Array(16),Rp=po(),Pa=class Pa extends bP{constructor(e,n){const i=n.layout.canvas,o=e.webglVersion,r={antialias:!1,stencil:o!==2,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:e.preserveDrawingBuffer};let s=null;if((!o||o===2)&&(s=i.getContext("webgl2",r),Pa.webglVersion=2),(s===null||o===1)&&(s=i.getContext("webgl",r)||i.getContext("experimental-webgl",r),Pa.webglVersion=1),s===null||!(s instanceof WebGLRenderingContext||s instanceof WebGL2RenderingContext))throw new Error("Failed to obtain WebGL context");super({gl:s,clearColor:Pt(e.defaultBackgroundColor)}),this.commonShaderDefines=zf,this.lastAppliedGlState={webglState:{state:null}},this.framebuffers=[],this.globeRenderTargets=[],this.lastRenderedFramebuffers=[],this.mapMeshMvpMatrix=new Float64Array(16),this.ubosMap={},this.trackContextLost=l=>{l.preventDefault(),this.modules.map.destroy()},this.state=e,this.modules=n;const a=s.getExtension("WEBGL_debug_renderer_info");this.webglContextState={MAX_TEXTURE_SIZE:s.getParameter(s.MAX_TEXTURE_SIZE),MAX_VIEWPORT_DIMS:s.getParameter(s.MAX_VIEWPORT_DIMS),MAX_UNIFORM_BUFFER_BINDINGS:s instanceof WebGLRenderingContext?0:s.getParameter(s.MAX_UNIFORM_BUFFER_BINDINGS),MAX_COMBINED_UNIFORM_BLOCKS:s instanceof WebGLRenderingContext?0:s.getParameter(s.MAX_COMBINED_UNIFORM_BLOCKS),RENDERER:a?s.getParameter(a.UNMASKED_RENDERER_WEBGL):s.getParameter(s.RENDERER),VENDOR:a?s.getParameter(a.UNMASKED_VENDOR_WEBGL):s.getParameter(s.VENDOR)},this.identifyBuffer=new qt({minFilter:j.NearestFilter,magFilter:j.NearestFilter}),this.labelingTextureBuffer=new qt({size:this.getViewportSize(),magFilter:j.NearestFilter,minFilter:j.NearestFilter,depthTexture:!0}),this.spriteLabelingTextureBuffer=new qt({size:this.getViewportSize(),magFilter:j.NearestFilter,minFilter:j.NearestFilter,depthTexture:!1}),this.shaderProgramOptions=QB(),this.shaderPrograms={},n.map.once("idle",()=>eO(this,this.shaderProgramOptions)),this.symbolSettingsList=mR(),this.addExtension("OES_vertex_array_object").addExtension("OES_element_index_uint").addExtension("OES_standard_derivatives").addExtension("OES_texture_float").addExtension("OES_texture_float_linear").addExtension("ANGLE_instanced_arrays").addExtension("WEBGL_depth_texture").addExtension("EXT_frag_depth"),Pa.webglVersion===2&&this.addExtension("EXT_color_buffer_float").addExtension("EXT_frag_depth"),this.setPixelRatio(window.devicePixelRatio).setSize(n.layout.mapContainer.clientWidth,n.layout.mapContainer.clientHeight),e.collectStats&&(this.timers=new pR(this._gl)),n.layout.canvas.addEventListener("webglcontextlost",this.trackContextLost)}getViewportSize(e=1){const n=this.getPixelRatio();return this.state.size.map(i=>Math.floor(i*n/e))}setClearColor(e){const n=Pt(e);if(!Wr(n,this.clearColor))return this.clearColor=n,this.addRerenderEvent(),this}setSize(e,n){return this.modules.layout.setCanvasSize(e,n),this.updateFrameBuffersSize(),this}updateFrameBuffersSize(){var i;this.framebuffers.forEach(o=>{o&&o.onResize()});const e=this.getPixelRatio(),n=this.state.size.map(o=>Math.ceil(o*e));(i=this.modules.postEffectsManager)==null||i.invalidateSize(),this.identifyBuffer.setSize(n.map(o=>Math.ceil(o*zi.pixelDensity))),this.labelingTextureBuffer.setSize(n),this.spriteLabelingTextureBuffer.setSize(n)}clear(e=!0){return this.clearWithColor(this.clearColor,e),this}addRerenderEvent(e){this.state.rerenderEvents.push(e||{type:"coreNeedRerender"})}isNeedRerender(){return this.state.needRerender||this.state.rerenderEvents.length>0}clearWithColor(e,n=!0){const i=this._gl,o=n===!0?i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT:i.COLOR_BUFFER_BIT;Oi(i,n?Gb:zL,this.modules.renderer.lastAppliedGlState),i.clearDepth(1),i.clearColor(e[0],e[1],e[2],e[3]),i.clear(o)}getGlobeRenderTarget(e){if(e=Ve(Math.trunc(e),1,4),!this.globeRenderTargets[e]){const n=this._gl,i=Ve(self.devicePixelRatio,1,2),o=Math.min(this.webglContextState.MAX_TEXTURE_SIZE,cx*e*i),r=new qt({size:[o,o],magFilter:j.LinearFilter,minFilter:j.LinearFilter,wrapS:j.ClampToEdgeWrapping,wrapT:j.ClampToEdgeWrapping});this.addFramebuffer({clearColor:[0,0,0,0],renderTarget:r,renderIndex:0,onResize:()=>{},onRenderStart:()=>{n.activeTexture(n.TEXTURE0+Rp),n.bindTexture(n.TEXTURE_2D,null)}}),this.globeRenderTargets[e]=r}return this.globeRenderTargets[e]}renderTileObjects(e){this.state.collectStats&&this.timers&&this.timers.addTimer();let n=!1;const i=this.getRenderObjectsByGroups(e,!1);if(this.lastRenderedFramebuffers.forEach(o=>{i.groups.some(r=>r.framebuffer===o)||this.clearFramebuffer(o)}),this.lastRenderedFramebuffers=[],i.groups.forEach(({objects:o,tileObjects:r,framebuffer:s})=>{var _,p,m;const a=this.modules.map.state.demMode&&(s===void 0||s.useDem===!0),l=!s,c=(s==null?void 0:s.isCacheFramebuffer)&&!this.modules.renderCacheManager.hasReadyCache(),d=!s&&this.modules.postEffectsManager.hasActiveEffects();d&&(s=this.modules.postEffectsManager.mainFrameBufferWrapper);const u=Nr(this.state,this.modules,i.tiers,s==null?void 0:s.renderTarget,a);if(s)(_=s.onRenderStart)==null||_.call(s),this.lastRenderedFramebuffers.push(s),s.renderTarget.bind(this._gl),this._gl.viewport(0,0,s.renderTarget.options.size[0],s.renderTarget.options.size[1]),s.clearColor&&this.clearWithColor(s.clearColor,!!s.clearDepth);else{const{size:g,viewport:y}=this.state,b=window.devicePixelRatio;this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,null),this._gl.viewport(y.left*b,y.bottom*b,g[0]*b,g[1]*b),this.clear(!0)}(l||c)&&(this.modules.environmentManager.renderSky(this._gl),a&&i.flatObjectsGroup&&!this.modules.renderCacheManager.hasReadyCache()&&!n&&(n=!0,this.renderDemMesh(u,i.flatObjectsGroup,!1,s))),l&&this.modules.renderCacheManager.render();const f=((p=s==null?void 0:s.getViewProjectionMatrix)==null?void 0:p.call(s))??this.modules.camera.viewProjectionMatrix,h=a?this.modules.demManager.demTextureMatrix:void 0;r.forEach(g=>{g.updateMvpMatrix(f,h)}),ba(this.state,this.modules,o,u),s==null||s.renderTarget.unbind(this._gl),(m=s==null?void 0:s.onRenderEnd)==null||m.call(s),d&&this.modules.postEffectsManager.render(this._gl)}),this.state.collectStats&&this.timers){this.timers.stopTimer();const o=this.timers.tryToGetFirstTimerValue();o&&this.modules.map.emit("gpuRenderTime",o)}return this}renderSpriteLabelingTexture(e){if(this.modules.renderCacheManager.hasReadyCache())return;const n=this._gl,i=[],o=Nr(this.state,this.modules,void 0,this.spriteLabelingTextureBuffer),r=e.filter(s=>s.labelTestChildren[0]);r.forEach(s=>{s.updateMvpMatrix(this.modules.camera.viewProjectionMatrix)}),r.forEach(s=>{s.labelTestChildren.forEach(a=>{a.attributes.labelTest===!0&&i.push(a)})}),this.spriteLabelingTextureBuffer.bind(n),this.clearWithColor([1,1,1,1]),n.viewport(0,0,this.spriteLabelingTextureBuffer.options.size[0],this.spriteLabelingTextureBuffer.options.size[1]),ba(this.state,this.modules,i,o),this.spriteLabelingTextureBuffer.unbind(n)}renderLabelingTexture(e){if(this.modules.renderCacheManager.hasReadyCache()||(this.state.isLabelingDepthTestDisabled=!0,this.state.styleZoom<oO||this.state.pitch===rO||this.state.disableHidingPois))return;const n=this._gl,i=[],o=Nr(this.state,this.modules,void 0,this.labelingTextureBuffer),r=e.filter(s=>s.depthTestChildren[0]);r.forEach(s=>{s.updateMvpMatrix(this.modules.camera.viewProjectionMatrix)}),r.forEach(s=>{s.depthTestChildren.forEach(a=>{const l=this.modules.styleManager.getStyleLayer(a.attributes.styleId,a.attributes.layerId);(l&&l.type!=="gltfModel"||!(l!=null&&l.style.preventObjectsHiding))&&i.push(a)})}),this.state.isLabelingDepthTestDisabled=!1,this.labelingTextureBuffer.bind(n),this.clearWithColor([1,1,1,1]),n.viewport(0,0,this.labelingTextureBuffer.options.size[0],this.labelingTextureBuffer.options.size[1]),ba(this.state,this.modules,i,o),this.labelingTextureBuffer.unbind(n)}renderIdentify(e){const n=this._gl,i=this.getRenderObjectsByGroups(e,!0);i.groups.forEach(({objects:o,tileObjects:r,framebuffer:s})=>{var f,h;const a=this.modules.map.state.demMode&&(s===void 0||s.useDem===!0),l=s?s.renderTarget:this.identifyBuffer,c=Nr(this.state,this.modules,i.tiers,l,a);l.bind(n),this.clearIdentify(),a&&i.flatObjectsGroup&&this.renderDemMesh(c,i.flatObjectsGroup,!0),l.bind(n),n.viewport(0,0,l.options.size[0],l.options.size[1]);const d=((f=s==null?void 0:s.getViewProjectionMatrix)==null?void 0:f.call(s))??this.modules.camera.viewProjectionMatrix,u=a?this.modules.demManager.demTextureMatrix:void 0;r.forEach(_=>{_.updateMvpMatrix(d,u)}),ba(this.state,this.modules,o,c),l.unbind(n),s==null||s.renderTarget.unbind(this._gl),(h=s==null?void 0:s.onRenderEnd)==null||h.call(s)}),this.addRerenderEvent()}readIdentifyPixels(){const e=this._gl,n=this.identifyBuffer.options.size,i=new Uint8Array(n[0]*n[1]*4);return this.identifyBuffer.bind(e),e.readPixels(0,0,n[0],n[1],e.RGBA,e.UNSIGNED_BYTE,i),this.identifyBuffer.unbind(e),i}getRenderingContext(){return this._gl}getShaderProgram(e,n){let i=this.shaderPrograms[e];i||(i={},this.shaderPrograms[e]=i);let o=i[this.commonShaderDefines.hash];o||(o={},i[this.commonShaderDefines.hash]=o);const r=(n==null?void 0:n.hash)??"",s=(n==null?void 0:n.defines)??[];let a=o[r];return a||(a=new xP(this.shaderProgramOptions[e],Xo.createShaderDefinitions([...this.commonShaderDefines.defines,...s]),tO),o[r]=a),a}destroy(){this.lastRenderedFramebuffers=[],this.framebuffers.forEach(n=>{n==null||n.renderTarget.remove()}),this.modules.layout.canvas.removeEventListener("webglcontextlost",this.trackContextLost);const e=this._gl.getExtension("WEBGL_lose_context");e&&e.loseContext(),this.modules.layout.destroy(),this.mapMeshFramebufferId=void 0,this.mapMeshIdFramebufferId=void 0}addFramebuffer(e){return this.framebuffers.push(e),this.framebuffers.length-1}getFramebuffer(e){if(e!==wn)return this.framebuffers[e]}removeFramebuffer(e){var n;(n=this.framebuffers[e])==null||n.renderTarget.remove(),this.framebuffers[e]=void 0}setRenderTarget(e){this.currentTarget=e;const n=this._gl;if(e)e.bind(n),n.viewport(0,0,e.options.size[0],e.options.size[1]);else{n.bindFramebuffer(n.FRAMEBUFFER,null);const{size:i,viewport:o}=this.state,r=window.devicePixelRatio;n.viewport(o.left*r,o.bottom*r,i[0]*r,i[1]*r)}}getRenderTarget(){return this.currentTarget}renderDemMesh(e,n,i=!1,o){const{framebuffer:r,tiles:s}=n;if(!r)return;let a=this.modules.demManager.getFlatMapTextures();if(i&&(a=a.filter(E=>E.detailLevel===0)),!a.length)return;const l=this.modules.demManager.getMeshTiles();if(!l.length)return;const c=l[0],u=(i?c.identifyChildren:c.children).filter(({sink:E})=>E==="mesh"||E==="mesh2")[0];if(!u)return;const f=this.state.handyStyleId,h=this.modules.styleManager.getStyleLayer(f,no);if(!h||kp(u))return;const{size:_,viewport:p}=this.state,m=window.devicePixelRatio,{commonBinder:g,programBinder:y,layerBinder:b,programName:v}=u.layerSettings,T=this.modules.renderer.getShaderProgram(v),x=[];s.forEach((E,L)=>{x.push({objects:E,tile:L})});const I=e.copy(r.renderTarget,!1,!0);a.forEach(E=>{var k,w;const N=x.filter(S=>l2(E.viewport,S.tile.bounds.values())).reduce((S,A)=>(A.tile.updateMvpMatrix(E.mvpMatrix,this.modules.demManager.demTextureMatrix),S.concat(A.objects)),[]);if((k=r.onRenderStart)==null||k.call(r),r.renderTarget.bind(this._gl),this._gl.viewport(0,0,r.renderTarget.options.size[0],r.renderTarget.options.size[1]),r.clearColor&&this.clearWithColor(r.clearColor,!1),ba(this.state,this.modules,N,I),r.renderTarget.unbind(this._gl),(w=r.onRenderEnd)==null||w.call(r),i){this.identifyBuffer.bind(this._gl);const S=this.identifyBuffer.options.size;this._gl.viewport(0,0,S[0],S[1])}else o?(this._gl.viewport(0,0,o.renderTarget.options.size[0],o.renderTarget.options.size[1]),o.renderTarget.bind(this._gl)):this._gl.viewport(p.left*m,p.bottom*m,_[0]*m,_[1]*m);T.enable(this._gl),this._gl instanceof WebGLRenderingContext&&(g==null||g(this._gl,T,this.state,this.modules)),y==null||y(this._gl,T,this.state,this.modules,!0),b==null||b(this._gl,T,this.state,this.modules,h),e.useState(u,h),l.forEach(S=>{if(S instanceof Tp&&S.needSync&&S.syncReplicas(this.state),l2(E.viewport,S.bounds.values())){S.updateMvpMatrix(this.modules.camera.viewProjectionMatrix,this.modules.demManager.demTextureMatrix,E.texMatrix);const A=(i?S.identifyChildren:S.children).filter(({sink:z})=>z==="mesh"||z==="mesh2");ug(A,this.state,this.modules),e.drawSymbol(A,h,this.state,this.modules)}}),i&&this.identifyBuffer.unbind(this._gl)})}getMapMeshFramebufferId(){return this.mapMeshFramebufferId===void 0&&(this.mapMeshFramebufferId=this.createMapMeshFramebuffer()),this.mapMeshFramebufferId}getMapMeshIdFramebufferId(){return this.mapMeshIdFramebufferId===void 0&&(this.mapMeshIdFramebufferId=this.createMapMeshFramebuffer(!0)),this.mapMeshIdFramebufferId}prerenderUpdate(){const e=this.rebuildExternalShaderDefinitions();this.updateUbos(e)}getRenderObjectsByGroups(e,n){const{demManager:i,map:o}=this.modules,{demMode:r}=o.state,s={},a={framebuffer:void 0,objects:[],tileObjects:new Set},l={};let c;if(r){const u=n?i.getIdentifyFlatFramebufferId():i.getFlatFramebufferId(),f=this.getFramebuffer(u);f&&(c={framebuffer:f,tiles:new Map})}n||a.objects.push(...this.modules.styleManager.getCustomSceneObjects()),e.forEach(u=>{(n?u.identifyChildren:u.children).forEach(h=>{var g;const _=this.modules.demManager.getReliefTileType();if(_==="raster"&&h.sink==="ground2"||_==="vector"&&h.sink==="ground"||h.sink==="mesh2")return;const p=this.modules.styleManager.getFramebufferId(h.attributes.styleId,h.attributes.layerId),m=p?p[h.sink]:void 0;if(m!==wn){if(m===void 0){const y=h.attributes.tiers;if(this.state.immersiveLevel.tiers&&y){let v=!1;if(y.forEach(T=>{if(!T){v=!0;return}l[T]||(l[T]={objects:[],tileObjects:new Set}),l[T].objects.push(h),l[T].tileObjects.add(u)}),!v)return}if(r&&!h.layerSettings.is3dMapAware)c!=null&&c.tiles.has(u)?(g=c==null?void 0:c.tiles.get(u))==null||g.push(h):c==null||c.tiles.set(u,[h]),this.modules.renderCacheManager.checkFlatObjectAnimation(h);else{if(!n&&this.modules.renderCacheManager.tryToCacheObjects(s,h,u))return;a.objects.push(h),a.tileObjects.add(u)}return}s[m]||(s[m]={framebuffer:this.getFramebuffer(m),objects:[],tileObjects:new Set}),s[m].objects.push(h),s[m].tileObjects.add(u)}})});const d=Object.values(s).filter(u=>!!u.framebuffer);return d.sort((u,f)=>{var p,m;const h=((p=u.framebuffer)==null?void 0:p.renderIndex)??0,_=((m=f.framebuffer)==null?void 0:m.renderIndex)??0;return h-_}),d.push(a),{flatObjectsGroup:c,groups:d,tiers:l}}getUbo(e){return this.ubosMap[e]}getMemoryFootprint(){const e={framebuffers:this.framebuffers.filter(n=>n!==void 0).map(n=>n.renderTarget.memSizeGPU()),identifyBuffer:this.identifyBuffer.memSizeGPU(),labelingTextureBuffer:this.labelingTextureBuffer.memSizeGPU()};return{gpu:{...e,"--sum":Mn(e)}}}updateUbos(e=!1){const n=this._gl;if(n instanceof WebGLRenderingContext)return;e&&this.cleanupUbos(n);const i=this.getShaderProgram("diffuse");i.link(n),i.locate(n);let o=this.ubosMap.CommonSettings;(!o||e)&&(o=new n2({blockName:"CommonSettings",uniformNames:i2.CommonSettings}),this.ubosMap.CommonSettings=o,o.bind(n,i)),AP(n,i,this.state,this.modules,o),o.commitData(n);const r=this.modules.map.state,s=!isNaN(r.handyStyleId)&&this.modules.styleManager.getStyle(r.handyStyleId)||void 0,a=(s==null?void 0:s.light.lightingModesResolved)??Bb;for(const l in a){let c=this.ubosMap[l];(!c||e)&&(c=new n2({blockName:"LightSettings",uniformNames:i2.LightSettings}));const d=a[l];c.updateData(n,i,{u_vec3_light_dir1_direction:d.dir1Direction,u_vec4_light_dir1_color:d.dir1ColorIntensity,u_vec3_light_dir2_direction:d.dir2Direction,u_vec4_light_dir2_color:d.dir2ColorIntensity,u_vec4_ambient_color:d.ambientColorIntensity}),this.ubosMap[l]=c,c.commitData(n)}}cleanupUbos(e){for(const n in this.ubosMap)this.ubosMap[n].cleanup(e);this.ubosMap={};for(let n=0;n<this.webglContextState.MAX_UNIFORM_BUFFER_BINDINGS;n++)e.bindBufferBase(e.UNIFORM_BUFFER,n,null)}rebuildExternalShaderDefinitions(){const e=this.prepareExternalShaderDefinitions();return this.commonShaderDefines.hash!==e.hash?(this.commonShaderDefines=e,!0):!1}clearIdentify(){const e=this._gl;e.depthMask(!0),e.clearColor(zo[0],zo[1],zo[2],zo[3]),e.clearDepth(1),e.clearStencil(0),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT|e.STENCIL_BUFFER_BIT)}clearFramebuffer(e){e.clearColor&&(e.renderTarget.bind(this._gl),this._gl.viewport(0,0,e.renderTarget.options.size[0],e.renderTarget.options.size[1]),this.clearWithColor(e.clearColor,!1),e.renderTarget.unbind(this._gl))}createMapMeshFramebuffer(e){const n=this.modules.renderer.getRenderingContext(),i=e?j.NearestFilter:j.LinearFilter,{scale:o,size:r}=this.calculateMapMeshParams(e),s=new qt({size:r,magFilter:i,minFilter:i,wrapS:j.ClampToEdgeWrapping,wrapT:j.ClampToEdgeWrapping}),a={getViewProjectionMatrix:()=>{const l=1-Math.cos(this.modules.map.state.pitch),c=a.scale??this.calculateMapMeshParams(e).scale;return ro(a2,[0,l/c[1],0],[1/c[0],1/c[1],1]),Sn(this.mapMeshMvpMatrix,a2,this.modules.camera.viewProjectionMatrix),this.mapMeshMvpMatrix},onResize:()=>{const l=this.calculateMapMeshParams(e);a.scale=l.scale,s.setSize(l.size),s.bind(n),s.unbind(n)},renderTarget:s,scale:o};return this.modules.renderer.addFramebuffer(a)}calculateMapMeshParams(e){const n=e?zi.pixelDensity:1,i=window.devicePixelRatio,o=Gn([],this.modules.map.state.size,i),r=Math.min(nO,Math.min(this.webglContextState.MAX_TEXTURE_SIZE,this.webglContextState.MAX_VIEWPORT_DIMS[0])/o[0]),s=Math.min(iO,Math.min(this.webglContextState.MAX_TEXTURE_SIZE,this.webglContextState.MAX_VIEWPORT_DIMS[1])/o[1]),a=[Math.trunc(o[0]*n*r),Math.trunc(o[1]*n*s)];return{scale:[r,s],size:a}}prepareExternalShaderDefinitions(){const e=[];return this.modules.environmentManager.isFogEnabled()&&e.push({type:Ak}),this.modules.environmentManager.isSkyEnabled()&&e.push({type:Ck}),this.modules.shadowManager.texture&&e.push({type:Dk}),this.state.disableAntiAliasing||e.push({type:Zb.TAA}),tf(this._gl)&&e.push({type:Ok}),this.webglContextState.MAX_UNIFORM_BUFFER_BINDINGS>0&&e.push({type:Nk}),this.state.isDeprecatedSystem||(e.push({type:Uk}),e.push({type:Gk})),this.webglContextState.RENDERER.toLowerCase().includes("mali")&&this.webglContextState.VENDOR.toLowerCase().includes("arm")&&e.push({type:Hk}),Xo.createShaderDefinitions(e)}};Pa.webglVersion=NaN;let Jr=Pa;function l2(t,e){for(const n of e)if(zs(t,n))return!0;return!1}class sO{constructor(e,n){this.idScopes={},this.isIdle=()=>this.searchQueue.size===0,this.state=e,this.modules=n,this.identifyData=[],this.needsUpdate=!1,this.forceUpdate=!1,this.searchQueue=new Map,this.stateDiffer=new Kt([{path:"center",type:"vec2"},{path:"zoom",type:"number"},{path:"size",type:"vec2"},{path:"rotation",type:"number"},{path:"pitch",type:"number"},{path:"padding",type:"padding"},{path:"demMode",type:"boolean"}]),this.debouncedFillCache=ki(()=>{this.needsUpdate=!0},zi.cacheDebounceTime),this.throttledFillCache=yl(()=>{this.needsUpdate=!0},zi.cacheThrottleTime)}getMemoryFootprint(){var n;const e={colorBuffer:((n=this.colorBuffer)==null?void 0:n.byteLength)??0};return{js:{...e,"--sum":Mn(e)}}}resetCache(){this.colorBuffer=void 0,this.debouncedFillCache()}search(e,n,i=!1){return this.colorBuffer===void 0&&i&&(this.needsUpdate=!0),this.forceUpdate=i,new Promise(o=>{this.searchQueue.set(e,{point:n,resolve:o})})}searchSync(e){return this.searchHigherPriority(e)}update(){this.stateDiffer.check(this.state)&&(this.resetCache(),this.searchQueue.size>0&&this.searchQueue.clear()),this.needsUpdate&&(this.forceUpdate||this.modules.dynamicStyle.hasDynamicObjects||this.modules.tileManager.isIdle()&&this.modules.labeler.isIdle()&&this.modules.layers.entranceAnimationFinished()&&this.modules.modelLayer.isIdle()&&!this.modules.buildingHeightAnimator.isAnimating()&&this.modules.assetManager.isIdle())&&(this.fillCache(),this.needsUpdate=!1,this.forceUpdate=!1),this.colorBuffer!==void 0&&this.searchQueue.size>0&&(this.searchQueue.forEach(e=>{e.resolve(this.searchHigherPriority(e.point))}),this.searchQueue.clear())}getIdScope(e){return this.idScopes[e]||(this.idScopes[e]=new a7(this)),this.idScopes[e]}searchHigherPriority(e){const{viewport:n}=this.state,i=Sm(e[0]-n.left,e[1]-n.top),o=this.state.identifyPickDistance*window.devicePixelRatio;let r=1/0,s,a=!1;const l=Et();for(l[0]=i[0]-o;l[0]<i[0]+o;l[0]++)for(l[1]=i[1]-o;l[1]<i[1]+o;l[1]++){const c=this.searchPointInCache(l);if(!c)continue;const d=c.dynamicObjectId!==void 0;if(d&&(c.phase=this.modules.dynamicStyle.getRenderIndexById(c.layerId)),a&&!d)continue;const u=eo(i,l);(!s||!a&&d||c.phase>s.phase||c.phase===s.phase&&u<r)&&(s=c,r=u,d&&(a=!0))}return s}searchPointInCache(e){if(this.colorBuffer===void 0)return;const n=zi.pixelDensity*window.devicePixelRatio,i=this.modules.renderer.identifyBuffer.options.size,o=this.state.size;if(e[0]<0||e[0]>o[0]-1||e[1]<0||e[1]>o[1]-1)return;const r=Math.floor(e[0]*n),a=((i[1]-1-Math.floor(e[1]*n))*i[0]+r)*4,l=(this.colorBuffer[a+3]<<24|this.colorBuffer[a+2]<<16|this.colorBuffer[a+1]<<8|this.colorBuffer[a])>>>0;return this.indexToIdentifierResponse(l)}fillCache(){const e=this.modules.tileManager.getTileObjects();this.modules.renderer.renderIdentify(e),this.colorBuffer=this.modules.renderer.readIdentifyPixels();const n=this.state.metrics;n.interactive===void 0&&(n.interactive=performance.now()-n.start),this.identifyData=this.modules.tileManager.getDisplayedIdentifyData(),this.modules.modelLayer.getDisplayedIdentifyData().forEach(o=>this.identifyData.push(o));const i=this.modules.personalPoiManager.getIdentifyDataChunk();i!==void 0&&this.identifyData.push(i),this.modules.layers.getDynamicObjectLayers().forEach(o=>{o.getIdentifyData().forEach(r=>this.identifyData.push(r))})}indexToIdentifierResponse(e){var n,i;for(let o=0;o<this.identifyData.length;o++){const r=this.identifyData[o],{dynamicObjectId:s,ids:a,metatileHash:l,sourceId:c,tileKey:d}=r,{startIndex:u,endIndex:f,idBuffer:h,floorIdBuffer:_,phaseBuffer:p,sublayerBuffer:m,styleIdBuffer:g,layerIdBuffer:y,instanceIdBuffer:b,objectClassBuffer:v,centerBuffer:T,strings:x}=a;if(e<u||e>f)continue;const I=e-u,E=h[I],L=new Uint32Array(m)[I],N=new Uint8Array(b)[I],k=new Uint32Array(v)[I];let w,S="";const A=_[I],z=this.modules.assetManager.getMetatile(l);if(z){(n=z.reverseDictionaries.db_sublayer)!=null&&n[L]&&(w=z.reverseDictionaries.db_sublayer[L]);const B=x[e];B!==void 0?S=B.objectClass:S=((i=z==null?void 0:z.reverseDictionaries.db_object_class)==null?void 0:i[k])??""}const M=new Uint16Array(g)[I],P=new Uint32Array(y)[I],C=this.modules.styleManager.getStyleLayer(M,P);if(!C||C.type==="custom")return;const D=new Int32Array(T,I*Int32Array.BYTES_PER_ELEMENT*2,2);return{id:E,styleId:M,layerId:P,floorId:A,phase:new Float32Array(p)[I],dynamicObjectId:s,sourceId:c,tileKey:d,sublayer:w,symbol:C.type,instanceId:N,objectClass:S,center:D[0]!==hf||D[1]!==hf?[D[0],D[1]]:void 0}}}}class c2{constructor(e){this.map=(e==null?void 0:e.map)||{}}set(e,n,i){this.map[e]===void 0&&(this.map[e]={}),this.map[e][n]=i}get(e,n){const i=this.map[e];if(i!==void 0)return i[n]}has(e,n){const i=this.map[e];return i===void 0?!1:i[n]!==void 0}reduce(e,n){return Object.values(this.map).reduce((i,o)=>Object.values(o).reduce((r,s,a,l)=>e(r,s,a,l),i),n)}}const aO=17,Tu=6;class lO{constructor(){this.name="",this.range="",this.glyphs={}}}class cO{constructor(){this.id=0,this.range=0,this.bitmap=null,this.top=0,this.left=0,this.advance=0,this.x=0,this.y=0,this.width=0,this.height=0,this.texTop=0,this.texLeft=0,this.texRight=0,this.texBottom=0}}class dO{constructor(e,n){this.stacks=e.readFields(uO,[],n)}}function uO(t,e,n){if(t===1){const i=n.readMessage(fO,new lO);e.push(i)}}function fO(t,e,n){switch(t){case 1:e.name=n.readString();break;case 2:e.range=n.readString();break;case 3:{const i=n.readMessage(hO,new cO);e.glyphs[i.id]=i;break}}}function hO(t,e,n){switch(t){case 1:e.id=n.readVarint(),e.range=rM(e.id);break;case 2:e.bitmap=n.readBytes();break;case 3:e.width=n.readVarint()+Tu;break;case 4:e.height=n.readVarint()+Tu;break;case 5:e.left=n.readSVarint()-Tu/2;break;case 6:e.top=n.readSVarint()+aO+Tu/2;break;case 7:e.advance=n.readVarint();break}}function _O(t){const e=new dO(new rh(new Uint8Array(t))).stacks[0].glyphs,{width:n,height:i}=mO(e);pO(e,n,i);const o=gO(e,n,i);return{glyphData:e,bitmap:o,width:n,height:i}}function mO(t){const e=[],n=new ei(512,512,{autoResize:!0}),i=Object.keys(t);for(let o=0;o<i.length;o++){const r=t[Number(i[o])];r.bitmap&&e.push({glyph:r,width:r.width,height:r.height})}n.pack(e,{inPlace:!0}),n.shrink();for(let o=0;o<e.length;o++){const r=e[o].glyph;r.x=e[o].x,r.y=e[o].y}return{width:Zg(n.w),height:Zg(n.h)}}function pO(t,e,n){const i=Object.keys(t);for(let o=0;o<i.length;o++){const r=t[Number(i[o])];r.bitmap&&(r.texTop=qn(r.y/n),r.texLeft=qn(r.x/e),r.texBottom=qn((r.y+r.height)/n),r.texRight=qn((r.x+r.width)/e))}}function gO(t,e,n){const i=new Uint8Array(e*n),o=Object.keys(t);for(let r=0;r<o.length;r++){const s=t[Number(o[r])];if(s.bitmap)for(let a=0;a<s.height;a++){const l=e*(s.y+a)+s.x,c=s.width*a;for(let d=0;d<s.width;d++)i[l+d]=s.bitmap[c+d]}}return i.buffer}function vO(t,e,n){var r;if(t.id===void 0)throw new Error("The layer id must be set.");if(e.layerIdToInnerId[t.id])throw new Error(`The layer with id «${t.id}» already exists in the map style.`);let i=-1;if(n){const s=Object.values(e.groupsById).find(a=>a&&a.id===n);if(s)i=e.layers.findIndex(a=>a.groupId===s.innerId);else{i=e.layers.findIndex(l=>l.id===n);const a=(r=e.layers[i])==null?void 0:r.groupId;if(a!==void 0&&t.type==="group")throw new Error(`Group layer with id «${t.id}» can't be added before layer with id «${n}» in group with innerId «${a}». Layer groups doesn't support nesting.`)}}else i=e.layers.length;if(i===-1)throw new Error(`The layer with beforeId «${n}» doesn't exist in the map style.`);let o=[];if(t.type!=="group"){o=[t];const s=i!==e.layers.length?e.layers[i]:void 0;if(s&&s.groupId!==void 0){const a=e.groupsById[s.groupId];if(!a){ct(`Для слоя с id «${s.id}» находящегося в группе с groupId «${s.groupId}» отсутствует группа id в стиле c id «${e.id}»`);return}const l=a.layers.findIndex(c=>c.id===s.id);if(l===-1){ct(`Слой с id «${s.id}» и groupId «${s.groupId}» отсутствует группе в стиле c id «${e.id}»`);return}t.groupId=a.innerId,a.layers.splice(l,0,t),a.layers.forEach((c,d)=>c.groupIndex=d)}}else e.groupsById[t.innerId]=t,e.layerIdToInnerId[t.id]=t.innerId,o=t.layers;e.revision++,e.layers.splice(i,0,...o),o.forEach(s=>{if(e.layersById[s.innerId]=s,e.layerIdToInnerId[s.id]=s.innerId,s.type==="point"||s.type==="polygon"||s.type==="metricPoint"||s.type==="embankment"||s.type==="polygon3d"){const a=Math.max(0,...Object.keys(e.rasterSets.byIndex).map(d=>Number(d))),l=new Jc(a+1);sb(s,l).forEach(d=>{e.rasterSets.byKey[d.key]||(e.rasterSets.byIndex[d.index]=d,e.rasterSets.byKey[d.key]=d)})}}),dw(e)}function yO(t,e,n){const i=e.layerIdToInnerId[t];if(i===void 0)return;e.revision++;let o=[];const r=e.groupsById[i];if(r){if(o=r.layers,delete e.groupsById[i],delete e.layerIdToInnerId[r.id],o.length===0)return}else{const a=e.layersById[i];if(!a){ct(`Слой с id «${t}» есть в списке идентификаторов слоев стиля, но при этом отсутствует в стиле c id «${e.id}»`);return}if(a.groupId!==void 0&&a.groupIndex!==void 0){const l=e.groupsById[a.groupId];l&&(l.layers.splice(a.groupIndex,1),l.layers.forEach((c,d)=>c.groupIndex=d))}o=[a]}const s=e.layers.findIndex(a=>a.id===o[0].id);s!==-1&&(o.forEach(a=>{const{styleManager:l,map:{state:c}}=n,d=l.getRemoveLayerHook(a.innerId);d&&(d(c),l.clearRemoveLayerHook(a.innerId)),delete e.layersById[a.innerId],delete e.layerIdToInnerId[a.id]}),e.layers.splice(s,o.length),dw(e))}function dw(t){const e=new Jc;let n;for(const i of t.layers)i.groupId!==void 0&&n&&i.groupId===n.groupId?i.renderIndex=n.renderIndex:i.renderIndex=e.getIndex(),n=i;for(const i in t.groupsById){const o=t.groupsById[i];o&&o.layers[0]&&(o.renderIndex=o.layers[0].renderIndex)}}function bO(t,e,n){const{map:{state:i},collector:o,imageManager:r,renderer:s,tileManager:a}=n;let l;try{l=wO(i,t,256)}catch(b){console.error(b);return}const c=r.addPreparedTexture(l),d=s.getRenderingContext(),{downscale:u}=t.style,{size:f}=i,h=new qt({size:[Math.ceil(f[0]*window.devicePixelRatio/u),Math.ceil(f[1]*window.devicePixelRatio/u)],magFilter:j.LinearFilter,minFilter:j.LinearFilter,wrapS:j.ClampToEdgeWrapping,wrapT:j.ClampToEdgeWrapping}),_=h.getTexture();if(!_){console.error("Can't init HeatMap Layer. Missing FrameBuffer texture");return}const p=r.addPreparedTexture(_),m=s.addFramebuffer({renderTarget:h,clearColor:[0,0,0,0],onResize:()=>{h.setSize([Math.ceil(i.size[0]*window.devicePixelRatio/u),Math.ceil(i.size[1]*window.devicePixelRatio/u)]),h.bind(d),h.unbind(d);const b=h.getTexture();b&&r.updatePreparedTexture(p,b)}});io({collector:o,generator:Br.generateTexture,args:[e,t,p,c]});const g=o.getAccumulatedData(),y=new bi("dynamicObject",g.data,n,i);return a.addObject(y),o.reset(),t.framebufferId={framebuffer:m},b=>{a.removeObject(y),y.clean(b),r.deleteTexture(p),r.deleteTexture(c),s.removeFramebuffer(m)}}function wO(t,e,n){const i=ht(t.styleZoom,t.styleState,[]),o=e.style.color,r=[];if(!xO(o.argument))throw new Error(`Heatmap color must be interpolate expression with 'heatmap-density' argument in layer ${e.id}`);const s=n-1;for(let a=0;a<n;a++){const l=a/s,c=q3(o,l,i);r.push(...c.value)}return new j(new Uint8Array(r),{size:[n,1]})}function xO(t){return typeof t=="object"&&t.type==="heatmap-density"}const uw=1,d2={type:"color",value:[0,0,0,0]};class SO{constructor(e){this.modules=e,this.customLayers=new Map,this.maxCountStyleLayers=1e4,this.styleIndex=uw,this.handyStylesMap=new Map,this.waitingStyleRequests=new Map,this.onRemoveLayerHooks=new Map}createStyle(e,n,i,o){const{state:r}=this.modules.map;if(!Number.isNaN(r.handyStyleId)){const c=this.getStyle(r.handyStyleId);c&&(c.layers.forEach(d=>{const u=this.onRemoveLayerHooks.get(d.innerId);u&&u(r)}),this.onRemoveLayerHooks.clear())}const s=this.styleIndex++,a=yA(e,s,i);M8(a,n),this.handyStylesMap.set(a.id,a),this.setMaxLayersCount(a.layers.length);const l=this.waitingStyleRequests.get(s);return l&&l.resolve(a),this.modules.workers.syncStyle(a),a.layers.forEach(c=>this.initHandyLayer(s,c)),a}hasLayer(e){const n=this.getStyle(this.modules.map.state.handyStyleId);return(n==null?void 0:n.layerIdToInnerId[e])!==void 0}addLayer(e,n){const i=this.getStyle(this.modules.map.state.handyStyleId);if(!i){console.error('Cannot add layer before map style was completely set. Please use "styleload" event.');return}const o=rb(e);o&&(vO(o,i,n),this.setMaxLayersCount(i.layers.length),e.type==="custom"&&o.type==="custom"?this.initCustomLayer(i.id,o,e.render,e.onRemove,e.onAdd):this.initHandyLayer(i.id,o),this.modules.workers.syncStyle(i))}setTerrainStyle(e){const n=this.getStyle(this.modules.map.state.handyStyleId);n&&(n.dem=Z0(e),this.modules.demManager.onTerrainStyleChange(),this.modules.renderer.addRerenderEvent())}addIcon(e,n){const i=this.getStyle(this.modules.map.state.handyStyleId);if(!i)return console.error('Cannot add icons before map style was completely set. Please use "styleload" event.'),!1;const o=i.layers.filter(c=>(c.type==="point"||c.type==="metricPoint")&&c.style.iconImage!==void 0&&yr(c.style.iconImage).some(d=>d===e)),r=i.layers.filter(c=>(c.type==="polygon"||c.type==="embankment"||c.type==="polygon3d")&&!!c.style.textureImage&&yr(c.style.textureImage).some(d=>d===e));if(!!i.icons[e])return console.error(`The icon with the name ${e} already exists.`),!1;const a=Math.max(0,...Object.keys(i.rasterSets.byIndex).map(c=>Number(c))),l=new Jc(a+1);return[...o,...r].forEach(c=>{const{imageType:d,anchor:u}=cp(c),f=ab(e,d,l,u);i.rasterSets.byIndex[f.index]=f,i.rasterSets.byKey[f.key]=f}),i.icons[e]=n,i.revision++,this.modules.workers.syncStyle(i),!0}removeIcon(e){const n=this.getStyle(this.modules.map.state.handyStyleId);if(!n)return console.error('Cannot remove icons before map style was completely set. Please use "styleload" event.'),!1;delete n.icons[e];let i=!1;return n.layers.filter(o=>o.type==="point"&&!!o.style.iconImage||o.type==="polygon"&&!!o.style.textureImage||o.type==="metricPoint"&&!!o.style.iconImage||o.type==="embankment"&&!!o.style.textureImage||o.type==="polygon3d"&&!!o.style.textureImage).forEach(o=>{const{image:r,imageType:s,anchor:a}=cp(o);yr(r).forEach(l=>{if(l===e){const c=s==="icon"?hl(l,a[0],a[1]):_l(l),d=n.rasterSets.byKey[c];d&&(this.modules.assetManager.removeRasterSet(d,n.id),i=!0)}})}),i?(n.revision++,this.modules.workers.syncStyle(n),!0):!1}addModel(e,n){const i=this.getStyle(this.modules.map.state.handyStyleId);return i?i.modelIndex[e]!==void 0?(console.error(`The model with the name ${e} already exists.`),!1):(i.models.push(n),i.modelIndex[e]=i.models.length-1,i.revision++,this.modules.workers.syncStyle(i),!0):(console.error('Cannot add models before map style was completely set. Please use "styleload" event.'),!1)}removeLayer(e){const n=this.getStyle(this.modules.map.state.handyStyleId);if(!n){console.error('Cannot remove layer before map style was completely set. Please use "styleload" event.');return}eb.some(i=>i.id===e)||(yO(e,n,this.modules),this.modules.workers.syncStyle(n))}showLayers(e){const n=this.getStyle(this.modules.map.state.handyStyleId);if(!n){console.error('Cannot hide layer before map style was completely set. Please use "styleload" event.');return}this.setLayerVisibility("visible",e,n)}hideLayers(e){const n=this.getStyle(this.modules.map.state.handyStyleId);if(!n){console.error('Cannot hide layer before map style was completely set. Please use "styleload" event.');return}this.setLayerVisibility("hidden",e,n)}setDynamicStyle(e){this.handyStylesMap.set(Kr,e),this.modules.workers.syncStyle(e)}getStyle(e){return this.handyStylesMap.get(e)}getStyleLayer(e,n){var i;return(i=this.handyStylesMap.get(e))==null?void 0:i.layersById[n]}getStyleRevision(e){var n;return((n=this.getStyle(e))==null?void 0:n.revision)||0}setFramebufferId(e,n,i){var r;const o=(r=this.handyStylesMap.get(e))==null?void 0:r.layersById[n];o&&(o.framebufferId=i)}getFramebufferId(e,n){var i,o;return(o=(i=this.handyStylesMap.get(e))==null?void 0:i.layersById[n])==null?void 0:o.framebufferId}waitForStyle(e){const n=this.handyStylesMap.get(e);if(n)return Promise.resolve(n);const i=this.waitingStyleRequests.get(e);if(i)return i.promise;const o={resolve:void 0,promise:void 0};return o.promise=new Promise(r=>{o.resolve=r}),this.waitingStyleRequests.set(e,o),o.promise}addRemoveLayerHook(e,n){this.onRemoveLayerHooks.set(e,n)}getRemoveLayerHook(e){return this.onRemoveLayerHooks.get(e)}clearRemoveLayerHook(e){this.onRemoveLayerHooks.delete(e)}callCustomLayerRender(e){const n=this.customLayers.get(e);n&&n.renderFunction(this.modules.renderer.getRenderingContext())}getCustomSceneObjects(){const e=[];return this.customLayers.forEach(n=>e.push(n.sceneObject)),e}getMaxLayersCount(){return this.maxCountStyleLayers}getStyleLayerForObject(e){const n=this.getStyle(e.attributes.styleId);return n?n.layersById[e.attributes.layerId]:null}getFeatureFlag(e){if(!this.modules.map.state.graphicsPresetMode)return!1;const n=this.getStyle(this.modules.map.state.handyStyleId);if(!n)return!1;const i=this.modules.map.core.state.styleState.graphicsPreset;return i?n.graphicsPresets[i][e]===!0:!1}getClearColor(){const{map:e,camera:n}=this.modules,{state:i}=e,o=this.handyStylesMap.get(i==null?void 0:i.handyStyleId);if(!o)return i.defaultBackgroundColor;const r=ht(i.styleZoom,i.styleState,[]),s=Le(o.environment.style.skyColor,r),a=i.globeMode?n.globeRatio:0;return kx(d2.value,o.background.color.value,s.value,a),d2}update(){const e=this.getStyle(this.modules.map.state.handyStyleId);e&&(e.light.lightingModesResolved=a8(e.light.lightingModes,ht(this.modules.map.state.styleZoom,this.modules.map.state.styleState,[],!1)))}setLayerVisibility(e,n,i){const{id:o,type:r}=n;if(o&&i.layersById){const s=i.layerIdToInnerId[o];if(s){const a=i.layersById[s];a&&a.style&&(a.style.visibility=e)}}r&&i.layers.forEach(s=>{s.type===r&&(s.style.visibility=e)})}initHandyLayer(e,n){let i;switch(n.type){case"group":n.layers.forEach(o=>this.initHandyLayer(e,o));return;case"heatmap":i=bO(n,e,this.modules);break}i&&this.modules.styleManager.addRemoveLayerHook(n.innerId,i)}setMaxLayersCount(e){this.maxCountStyleLayers<e&&(this.maxCountStyleLayers=e)}initCustomLayer(e,n,i,o,r){const s={sceneObject:{type:ri.Custom,attributes:{styleId:e,layerId:n.innerId,tileData:[]},tile:{zoomLevel:0},layerSettings:{},canRender:!0},layer:n,renderFunction:i};r==null||r(),this.customLayers.set(n.innerId,s),this.modules.styleManager.addRemoveLayerHook(n.innerId,()=>{o==null||o(),this.customLayers.delete(n.innerId)})}}const MO={point:{point:!0,heatmap:!0,gltfModel:!0,metricPoint:!0},polygon:{polygon:!0,polygonExtrusion:!0,mesh:!0,embankment:!0,polygon3d:!0,overpass:!0},line:{line:!0,lineExtrusion:!0,labelLine:!0,dashedLine:!0,oneWayLine:!0,metricPoint:!0,overpass:!0}};function TO(t,e){return!!MO[t][e]}function IO(t){const e=t.vertices.x,n=t.vertices.y;let i=0;for(let o=0;o<e.length-1;o++)i+=Math.hypot(e[o]-e[o+1],n[o]-n[o+1]);return i}function q_(t,e){const n=new Set(e[0].map((i,o)=>e[0][o]===t[0]&&t[1]===e[1][o]?o:-1));return Array.from(n)}function EO(t,e,n,i){e>=0&&n>=0&&Math.abs(e-n)===1&&(t[2][0]=1),n>=0&&i>=0&&Math.abs(n-i)===1&&(t[2][1]=1),e>=0&&i>=0&&Math.abs(e-i)===1&&(t[2][2]=1)}function fw(t,e){const n=q_([t[0][0],t[1][0]],e),i=q_([t[0][1],t[1][1]],e),o=q_([t[0][2],t[1][2]],e);n.forEach(r=>i.forEach(s=>o.forEach(a=>{EO(t,r,s,a)})))}function hw(){return y6(["id","db_label","db_label2","selected","hovered","componentDistanceStart","componentDistanceEnd","objectLength","beginningIsCut","endingIsCut","db_geometry_type","db_plan_id"],["GEOJSON_METATILE_UNKNOWN_SUBLAYER","Commercial_poi_default","Commercial_poi_city","Commercial_poi_premium","Commercial_model","Immersive_model","Immersive_model_multipart","Animated_immersive_model"])}class AO{constructor(){this.events={}}on(e,n){let i=this.events[e];return i||(i=this.events[e]=[]),i.push(n),this}once(e,n){const i=o=>{this.off(e,i),n.call(this,o)};return this.on(e,i),this}off(e,n){const i=this.events[e];if(!i)return this;const o=i.indexOf(n);return o!==-1&&i.splice(o,1),this}emit(e,n){const i=this.events[e];if(!i)return this;const o=i.slice();for(let r=0;r<o.length;r++)o[r].call(this,n);return this}}class CO extends AO{constructor(e,n){super(),this.loadFont=(r,s)=>{let a=this.requestFontRanges.get(r,s);return a||(a=this.createLoadFontRequest(r,s),this.requestFontRanges.set(r,s,a)),a},this.invalidateUsedGltfModels=yl(()=>{var l;const r=new Set,s=this.modules.tileManager.getTileObjects();for(const c of s)for(const d of c.children){if(!kp(d))continue;const{styleId:u,layerId:f,modelIndices:h}=d.attributes,_=this.modules.styleManager.getStyleLayer(u,f);if(!_||_.type!=="gltfModel")continue;const p=this.modules.modelsScene.getCurrentLayerModelId(d.attributes,d.tile);h.forEach(m=>{const g=this.getModel(m,u);if(g){r.add(g);return}if(p===m){const y=this.dataModelIdToUrl[m];y?this.loadModel(y,m,u,!1,_):this.loadModelByIndex(m,u,_)}})}const a=this.modules.tileManager.getCachedMods();for(const c of a)(l=c.objects)==null||l.forEach(d=>{for(const u of d.children){if(!kp(u))continue;const{styleId:f,layerId:h,modelIndices:_}=u.attributes,p=this.modules.styleManager.getStyleLayer(f,h);if(!p||p.type!=="gltfModel")return;_.forEach(m=>{const g=this.getModel(m,u.attributes.styleId);g&&r.add(g)})}});for(const c in this.models){const d=this.models[c];!d.preserve&&!r.has(d)&&d.status===ui.Loaded&&this.removeModel(c)}},Kx),this.state=e,this.modules=n,this.modelsWorker=new this.modules.workers.models.ModelsSource,this.requestedMetatiles=new Set,this.metatiles={},this.loadedRasters={},this.failedRasters={},this.requestedRasters={},this.requestedSvgs={},this.disableIconCache=e.disableIconCache,this.textures=[],this.fontGlyphs={},this.fontTextures=new c2,this.requestFontRanges=new c2,this.pendingFontRanges=0,this.loadedFontRanges=0,this.models={},this.dataModelIdToUrl={},this.visibleBuildingIds=new Set,this.metatileLoader=(r,s,a)=>{const l=M0(s);fetch(r).then(c=>{if(!c.ok)throw new Error(`Failed to load metatile "${l}"`);return c.json()}).then(c=>this.setMetatile(s,a,c)).catch(c=>console.error(c))};const i=(r,s)=>{const a=this.modules.styleManager.getStyle(r);if(!a){console.error(`Not found style ${r} in AssetManager#addNewRasterSets`);return}const{rasterSets:l}=a;s.forEach(c=>{l.byIndex[c.index]=c,l.byKey[c.key]=c})},{fnRegistry:o}=this.modules.workers;o.set("addNewRasterSets",i),o.set("loadFont",this.loadFont),this.setPreparedMetatile(-1,S3),this.setPreparedMetatile(W4,hw())}getMemoryFootprint(){const e={textures:this.textures.map(zc),fontTextures:this.fontTextures.reduce((i,o)=>(i.push(zc(o)),i),[]),fontGlyphs:Object.values(this.fontGlyphs).reduce((i,o)=>Object.values(o).reduce((r,s)=>{var a;return r.push({bitmap:((a=s.bitmap)==null?void 0:a.byteLength)??0}),r},i),[]),models:Object.values(this.models).map(NE).filter(i=>i.buffers.length>0||i.textures.length>0)},n={textures:this.textures.map(Tf),fontTextures:this.fontTextures.reduce((i,o)=>(i.push(Tf(o)),i),[]),models:Object.values(this.models).map(UE).filter(i=>i.buffers.length>0||i.textures.length>0)};return{js:{...e,"--sum":Mn(e)},gpu:{...n,"--sum":Mn(n)}}}fillDataModelUrlMap(e){for(const n in e)this.dataModelIdToUrl[e[n]]=n}getDataModelUrlById(e){return this.dataModelIdToUrl[e]}loadMetatile(e,n,i){this.requestedMetatiles.has(n)||(this.requestedMetatiles.add(n),this.metatileLoader(e,n,i))}setMetatile(e,n,i){qE(i),i.tileProps=i.tileProps.map(WE);const o=x3(i);this.setPreparedMetatile(e,o),this.projectMetatileMetadata===void 0&&(this.projectMetatileMetadata={regionId:n,metatileHash:e})}setPreparedMetatile(e,n){this.metatiles[e]=n,this.modules.workers.parser.setMetatile(e,n)}prepareRasters(e,n,i){var c,d;const o=this.modules.styleManager.getStyle(e);if(!o){console.error(`Not found style ${e} in AssetManager#prepareRasters`);return}const{rasterSets:r}=o,s=this.modules.renderer.getRenderingContext(),a=7,l=n.length/a;for(let u=0;u<l;u++){const f=n[u*a],h=n[u*a+1],_=n[u*a+6],p=n[u*a+2],m=n[u*a+3],g=n[u*a+4],y=n[u*a+5],b=r.byIndex[f];if(b.isSvg){const x={rasterIndex:h,rasterSetIndex:f,x:p,y:m,w:g,h:y,anchorX:b.anchorX,anchorY:b.anchorY,atlasIndex:_,isPacked:!0};b.rasters[h]=x,(d=(c=this.requestedSvgs[o.id])==null?void 0:c[f])==null||d.then(I=>{const E=this.textures[x.atlasIndex],{url:L,revokeURL:N}=qy(I);Yy(L,x.w,x.h).then(k=>{E.subImage(s,k,x.x,x.y),this.modules.renderer.addRerenderEvent(),N&&N()})})}else{const x=b.rasters[h];x.x=p,x.y=m,x.atlasIndex=_,x.isPacked=!0}this.textures[_]===void 0&&(this.textures[_]=new j(void 0,{size:tn,flipY:!1,premultiplyAlpha:!eP,magFilter:j.LinearFilter,minFilter:j.LinearFilter}).prepare(s));const v=this.textures[_],T=i&&i[u];if(T!==void 0){v.subImage(s,T,p,m),this.modules.renderer.addRerenderEvent();continue}}this.modules.workers.labeling.updatePackingInfo(e,n)}loadRasters(e){const i=e.length/3;for(let o=0;o<i;o++){const r=e[o*3],s=e[o*3+1],a=e[o*3+2],l=s<<16|a,c=this.modules.styleManager.getStyle(r);if(!c){console.error(`Not found style ${r} in AssetManager#loadRasters`);continue}if(this.loadedRasters[r]||(this.loadedRasters[r]=new Set,this.failedRasters[r]=new Set,this.requestedRasters[r]=new Set),this.requestedRasters[r].has(l))continue;const{rasterSets:d}=c,u=d.byIndex[s];if(u.rasters[a].isPacked===!1){console.error(`Try to load not packed raster ${u.key}`);continue}this.requestedRasters[r].add(l),u.isSvg?this.loadSvg(l,c,s):this.loadPng(l,c,s,a)}}removeRasterSet(e,n){const{key:i,index:o,rasters:r}=e;delete this.requestedSvgs[n][o],r.forEach(({rasterSetIndex:a,rasterIndex:l})=>{var d,u,f;const c=a<<16|l;(d=this.loadedRasters[n])==null||d.delete(c),(u=this.failedRasters[n])==null||u.delete(c),(f=this.requestedRasters[n])==null||f.delete(c)}),e.rasters.length=0;const s=this.modules.styleManager.getStyle(n);s&&(delete s.rasterSets.byIndex[o],delete s.rasterSets.byKey[i])}getMetatile(e){return this.metatiles[e]}getProjectMetadata(){return this.projectMetatileMetadata}getFontGlyphs(e){return this.fontGlyphs[e]||{}}getFontTextureByName(e,n){return this.fontTextures.get(e,n)}isIdle(){let e=0,n=0;for(const i in this.requestedRasters)e+=this.requestedRasters[i].size,n+=this.loadedRasters[i].size+this.failedRasters[i].size;return e===n&&this.pendingFontRanges===this.loadedFontRanges&&this.allModelsLoaded()}dangerouslySetMetatiles(e){this.metatiles=e}dangerouslySetRasters(e,n){this.loadedRasters=e,this.failedRasters=n}loadModelByIndex(e,n,i){const o=this.getModelUniqueKey(e,n);if(this.models[o]!==void 0)return;const r=this.modules.styleManager.getStyle(n);if(r===void 0){zh({layer:"prepare",message:"Style not found. Can't determine url"});return}const s=r.models[e];if(s===void 0){zh({layer:"prepare",message:`Model with index "${e}" is missing in the style.`});return}const a=b8(s.url,r);this.fetchModel(a,e,o,!1,i)}loadModel(e,n,i,o,r,s){const a=this.getModelUniqueKey(n,i);if(this.models[a]!==void 0){s==null||s();return}this.fetchModel(e,n,a,o,r,s)}getModel(e,n){return this.models[this.getModelUniqueKey(e,n)]}allModelsLoaded(){for(const e in this.models)if(this.models[e].status===ui.Pending)return!1;return!0}isModelLoaded(e,n){const i=this.models[this.getModelUniqueKey(e,n)];return i&&i.status===ui.Loaded}removeModel(e){const n=this.models[e];n&&(n.objects.forEach(i=>{i.elementsBuffer&&i.elementsBuffer.remove()}),n.objects=[],n.buffers.forEach(i=>{i instanceof F&&i.remove()}),n.buffers=[],n.textures.forEach(i=>i.remove()),n.textures=[],delete this.models[e])}fetchModel(e,n,i,o,r,s){const{renderer:a}=this.modules,l=this.models[i]=qk(o);this.modelsWorker.loadModel(e,this.state.dracoDecoderUrl).then(c=>{if(c.type==="ok"){if(l.status=ui.Loaded,!c.result)return;Kk(l,a,c.result,n,r),this.emit("modelloaded",n),this.modules.renderer.addRerenderEvent(),s==null||s()}else zh(c),l.status=ui.Failed})}getModelUniqueKey(e,n){return e>=0?`${n},${e}`:String(e)}async createLoadFontRequest(e,n){this.pendingFontRanges+=1;const i=Number.isNaN(this.state.handyStyleId)?uw:this.state.handyStyleId;try{const o=await this.modules.styleManager.waitForStyle(i),r=await fetch(pv(e,n,o)).then(a=>{if(!a.ok)throw new Error;return a}).catch(()=>(console.error(`Could not load font ${e} for range ${n} fallback to the default font ${Ss}`),fetch(pv(Ss,n,o)).then(a=>{if(!a.ok)throw new Error(`Could not load default font ${Ss} for range ${n}`);return a}))).then(a=>a.arrayBuffer()),s=_O(r);return this.prepareFontAtlas(e,n,s),this.modules.workers.labeling.appendFont(e,s.glyphData),this.loadedFontRanges+=1,this.modules.workers.labeling.markFontAsLoaded(e,n)}catch(o){return console.error(o),this.loadedFontRanges+=1,this.modules.workers.labeling.markFontAsLoaded(e,n)}}prepareFontAtlas(e,n,i){const{bitmap:o,width:r,height:s,glyphData:a}=i;this.fontGlyphs[e]||(this.fontGlyphs[e]={});for(const c in a)this.fontGlyphs[e][c]=a[c];const l=new j(new Uint8Array(o),{size:[r,s],magFilter:j.LinearFilter,minFilter:j.LinearFilter,format:j.AlphaFormat,premultiplyAlpha:!1,flipY:!1});this.fontTextures.set(e,n,l),this.state.needLabeling=!0}loadPng(e,n,i,o){const r=this.modules.renderer.getRenderingContext(),{rasterSets:s}=n,a=s.byIndex[i],l=a.rasters[o],c=this.textures[l.atlasIndex];let d="";if(a.type===Us.Unique){const u=a.id;a.url?d=Q3(a.url,l.w,l.h):d=wr("dynamicPoi",{host:this.state.tileServer,tileSet:this.state.tileSet,protocol:this.state.tileProtocol,subdomain:za(this.state.subdomains,u),id:u,width:l.w.toString(),height:l.h.toString(),regionId:String(a.regionId)})}else if(a.type===Us.Static){const u=n.icons[a.name];if(!u){console.error(`There is no appropriate icon config in the style for raster set: "${a.name}"`),this.failedRasters[n.id].add(e);return}d=vf(u.url,n,za(this.state.subdomains,a.name))}this.modules.workers.parser.prepareAtlas(d).then(u=>{u?(u.isBitmap?(c.subImage(r,u.data[0],l.x,l.y),this.modules.renderer.addRerenderEvent()):vh(u.data[0]).then(f=>{c.subImage(r,f,l.x,l.y),this.modules.renderer.addRerenderEvent()}),this.loadedRasters[n.id].add(e)):this.failedRasters[n.id].add(e)})}loadSvg(e,n,i){const o=this.modules.renderer.getRenderingContext(),r=n.rasterSets.byIndex[i];if(!n.iconBaseUrl){console.error(`Attempt to load svg without existing style for raster set: "${r.name}"`),this.failedRasters[n.id].add(e);return}const s=n.icons[r.name];if(!s){console.error(`There is no appropriate icon config in the style for raster set: "${r.name}"`),this.failedRasters[n.id].add(e);return}const a=vf(s.url,n,za(this.state.subdomains,r.name));this.requestedSvgs[n.id]||(this.requestedSvgs[n.id]={});let l=this.requestedSvgs[n.id][i];(!l||this.disableIconCache)&&(l=this.requestedSvgs[n.id][i]=fetch(a,{cache:this.disableIconCache?"no-cache":"default"}).then(c=>{if(!c.ok)throw new Error("Not 2xx response");return c.text()})),l.then(c=>{const{url:d,revokeURL:u}=qy(c),f=[];for(const h of r.rasters){if(h.w<=0||h.h<=0)continue;const _=this.textures[h.atlasIndex],p=Yy(d,h.w,h.h);p.then(m=>{_.subImage(o,m,h.x,h.y),m.remove(),this.modules.renderer.addRerenderEvent()}),f.push(p)}u&&Promise.all(f).then(u),this.loadedRasters[n.id].add(e)}).catch(c=>{console.error(`Can't load an SVG for the "${r.name}" raster set. Error: `,c),this.failedRasters[n.id].add(e)})}}class PO{constructor(e,n,i,o,r,s,a,l){this.modules=e,this.mapState=n,this.cache=i,this.maxStyleZoom=-1/0,this.minStyleZoom=1/0,this.ready=!1,this.useful=!1,this.status="initial",this.model=o,this.key=r,this.selectedIds=s,this.styleId=a,this.styleRevision=l,this.modelRevision=o.revision,this.objects=[]}update(){switch(this.status){case"initial":{this.useful&&(this.loadModel(),this.status="generating");break}case"generating":{if(this.useful&&this.processResponse&&this.model.texturesLoaded){const{objects:{data:e}}=this.processResponse;this.objects=FO(e,this.modules),this.updateMinAndMaxStyleZoom(this.objects),this.status="generated",this.ready=!0,this.cache.add(this.key,this)}break}}}getIdentifyIds(){var e;return(e=this.processResponse)==null?void 0:e.objects.identifyIds}remove(){this.status==="generated"&&this.cache.remove(this.key),this.status="initial",this.objects.length&&(this.objects.forEach(e=>e.clean(this.mapState)),this.objects=[]),this.ready=!1}canBeRemoved(){return this.status==="initial"}loadModel(){const{model:{regionId:e,metatileHash:n,id:i,sourceModel:{fileName:o,matrix:r,offset:s}}}=this,l={url:wr("model",{host:this.mapState.tileServer,tileSet:this.mapState.tileSet,protocol:this.mapState.tileProtocol,subdomain:za(this.mapState.subdomains,o),regionId:e.toString(),name:o}),id:i,regionId:e,metatileHash:n,selected:this.selectedIds.some(c=>c===i),pixelRatio:window.devicePixelRatio,styleState:this.mapState.styleState,styleId:this.mapState.handyStyleId,offset:s,matrix:r};this.modules.defaultSource.generateModel(l).then(c=>{this.model.prepareTextures(c.textures),this.processResponse=c})}updateMinAndMaxStyleZoom(e){this.minStyleZoom=Math.min(...e.map(n=>Math.min(...n.children.map(i=>{const o=this.modules.styleManager.getStyleLayer(i.attributes.styleId,i.attributes.layerId);return(o==null?void 0:o.type)==="dem"?1/0:(o==null?void 0:o.minzoom)??-1/0})))),this.maxStyleZoom=Math.max(...e.map(n=>Math.max(...n.children.map(i=>{const o=this.modules.styleManager.getStyleLayer(i.attributes.styleId,i.attributes.layerId);return(o==null?void 0:o.type)==="dem"?-1/0:(o==null?void 0:o.maxzoom)??1/0}))))}}function LO(t,e,n,i,o){const r=e.join("|");return`model=${t}_sId=${n}_sRev=${i}_mRev=${o}_sel=${r}`}function FO(t,e){const n=new f2(t,e),i=[],o=u2(n.children[0]??n.identifyChildren[0]??n.depthTestChildren[0]??n.shadowChildren[0]);return o&&["children","identifyChildren","depthTestChildren","shadowChildren"].forEach(r=>{const s=n.modelMatrices.get(0)??Ui();ja(s,o),n.modelMatrices.set(0,s);let a=n[r].length;for(;a--;){const l=n[r][a],c=u2(l);if(!c||Hg(s,c))continue;let d=i.find(u=>{const f=u.modelMatrices.get(0);return f?Hg(f,c):!1});d||(d=new f2([],e),d.modelMatrices.set(0,ja(Ui(),c)),i.push(d)),d[r].push(l),l.tile=d,n[r].splice(a,1)}}),[n,...i]}function u2(t){if(t&&"matrix"in t.attributes)return t.attributes.matrix}class f2 extends H0{constructor(e,n){super("model");const{identifier:i}=n;I5(n,e,this,i.getIdScope(Yo)),this.size=Nt(this.coords[2]),this.zoomLevel=this.coords[2],this.detailLevel=this.coords[3]}setTileCoords(e,n){}syncReplicas(e){}}class kO{constructor(e,n,i,o,r,s){this.modules=e,this.mapState=n,this.cache=i,this.regionId=o,this.metatileHash=r,this.sourceModel=s,this.revision=0,this.texturesLoaded=!1,this.textures=[],this.readiness=0,this.id=s.id,this.attributes=s.attributes??{},this.readinessTickerName=`model-readiness-${this.id}`,this.ids=e.identifier.getIdScope(Yo)}update(){var e,n;(e=this.currentMod)!=null&&e.useful&&this.currentMod.update(),(n=this.newMod)!=null&&n.useful&&this.newMod.update(),xt(this.readinessTickerName,{step:(i,o)=>this.readiness=o},this.mapState)}isAnimating(){return S0(this.readinessTickerName,this.mapState)}commitMod(){this.newMod&&this.newMod.ready&&(this.currentMod=this.newMod,this.newMod=void 0)}setUsefulMod(){const e=this.mapState.handyStyleId,n=this.modules.styleManager.getStyleRevision(e),i=this.ids.getSelected().filter(o=>o===this.id);if(!this.currentMod&&!this.newMod){this.createNewMod(i,e,n,this.revision);return}if(this.currentMod&&Wr(this.currentMod.selectedIds,i)&&this.currentMod.styleId===e&&this.currentMod.styleRevision===n&&this.currentMod.modelRevision===this.revision){this.currentMod.useful=!0,this.newMod=void 0;return}if(this.newMod){Wr(this.newMod.selectedIds,i)&&this.newMod.styleId===e&&this.newMod.styleRevision===n&&this.newMod.modelRevision===this.revision?this.newMod.useful=!0:this.createNewMod(i,e,n,this.revision);return}this.createNewMod(i,e,n,this.revision)}getUsefulMod(){if(this.currentMod&&this.currentMod.useful)return this.currentMod;if(this.newMod&&this.newMod.useful)return this.newMod}getCurrentMod(){return this.currentMod}setAllModsNeedless(){this.currentMod&&(this.currentMod.useful=!1),this.newMod&&(this.newMod.useful=!1)}getOpacity(e){return this.readiness*this.modules.buildingHeightAnimator.getBuildingHeight(e)}getTexture(e){return this.textures[e]}prepareTextures(e){this.texturesLoaded||(e.isBitmap?(this.textures=e.data.map(n=>new j(n,{flipY:!1})),this.texturesLoaded=!0,this.startReadinessTicker()):Promise.all(e.data.map(n=>vh(n))).then(n=>{this.textures=n.map(i=>new j(i,{flipY:!1})),this.texturesLoaded=!0,this.startReadinessTicker()}))}clean(){this.canBeCleaned()&&(this.texturesLoaded&&(this.textures.forEach(e=>e.remove()),this.textures=[],this.texturesLoaded=!1),this.stopReadinessTicker())}canBeCleaned(){return(!this.currentMod||this.currentMod.canBeRemoved())&&(!this.newMod||this.newMod.canBeRemoved())}createNewMod(e,n,i,o){const r=LO(this.id,e,n,i,o),s=this.cache.get(r);s?(this.newMod=s,this.newMod.useful=!0):this.newMod=new PO(this.modules,this.mapState,this.cache,this,r,e,n,i)}startReadinessTicker(){this.readiness=0,At(this.readinessTickerName,{easing:Wa.easing},this.mapState,0,1,Wa.duration,1)}stopReadinessTicker(){this.readiness=0,It(this.readinessTickerName,this.mapState)}}class RO{constructor(e,n){this.mapState=e,this.modules=n,this.buildingsHeight=new Map,this.models=new Map,this.displayedMods=new Map,this.viewportModels=[],this.requestedModelsInfo=new Set,this.loadedModelsInfo=new Set,this.isStyleUpdateInProgress=!1,this.hiddenBuildingIds=new Set,this.cache=new N5(Xx,(i,o)=>o.remove()),this.ids=n.identifier.getIdScope(Yo)}onFeatureStateMapChange(){this.models.forEach(e=>{e.revision++})}update(){this.findViewportModels(),this.mapState.styleZoom>o3&&this.modules.tileManager.getViewportTiles().forEach(e=>{e.type==="zenith"&&e.serverMetadata&&e.serverMetadata.forEach(n=>{const i=this.modules.sourceStorage.getSourceById(e.sourceId);if(i!==void 0&&"getUrl"in i){const o=i.getUrl("modelInfo",{regionId:n.regionId.toString()});this.loadModelsInfo(o,n.regionId,n.metatileHash)}else{const o=wr("modelInfo",{host:this.mapState.tileServer,tileSet:this.mapState.tileSet,protocol:this.mapState.tileProtocol,subdomain:this.mapState.subdomains[0],regionId:n.regionId.toString()});this.loadModelsInfo(o,n.regionId,n.metatileHash)}})}),this.models.forEach(e=>e.setAllModsNeedless()),this.viewportModels.forEach(e=>e.setUsefulMod()),this.models.forEach(e=>e.update()),this.isStyleUpdateInProgress||this.models.forEach(e=>e.commitMod()),this.updateScene(),this.cleanUnnessasaryModels(),this.updateObjectsVisibility()}activateStyleUpdating(){this.isStyleUpdateInProgress=!0}finishStyleUpdating(){this.isStyleUpdateInProgress=!1}redraw(){this.cache.reset(),this.cleanUnnessasaryModels()}isModelsInfoLoaded(e){return this.loadedModelsInfo.has(e)}getTexture(e,n){var i;return(i=this.models.get(e))==null?void 0:i.getTexture(n)}getDisplayedIdentifyData(){const e=[];return this.viewportModels.forEach(n=>{const i=n.getUsefulMod();if(!i)return;const o=i.getIdentifyIds();o&&e.push({metatileHash:n.metatileHash,ids:o})}),e}getOpacity(e,n){var i;return((i=this.models.get(e))==null?void 0:i.getOpacity(n))||0}hasModel(e){return this.models.has(e)}setBuildingHeight(e,n){this.buildingsHeight.set(e,n)}getBuildingHeight(e){return this.buildingsHeight.get(e)||0}isHidden(e){return this.ids.isHidden(e)}getVisibleModelData(e){const n=this.models.get(e);if(!n)return;const i=n.getCurrentMod();if(!i||!i.ready)return;const o=Math.max(n.sourceModel.minZoom,i.minStyleZoom),r=Math.min(n.sourceModel.maxZoom,i.maxStyleZoom),{styleZoom:s}=this.mapState;if(!(s<o||s>=r))return{minStyleZoom:o,maxStyleZoom:r,opacity:this.getOpacity(e,o)}}isIdle(){return this.viewportModelsReady()&&!this.viewportModels.some(e=>e.isAnimating())}viewportModelsReady(){return this.viewportModels.every(e=>{const n=e.getUsefulMod();return n&&n.ready})}setHiddenBuildingIds(e){e.forEach(n=>{this.hiddenBuildingIds.add(n)})}unsetHiddenBuildingIds(e){e.forEach(n=>{this.hiddenBuildingIds.delete(n)})}findViewportModels(){const{styleZoom:e}=this.mapState;this.viewportModels=[],this.models.forEach(n=>{const{bound:i,minZoom:o,maxZoom:r}=n.sourceModel;if(e<o||e>=r)return;const s=this.mapState.styleState._activeFloorIds,a=n.attributes.db_hidden_by_plan_id;if(a&&s.includes(a)||this.modules.floorManager.hasDisplayedFloorBuilding([n.id])||!!!this.modules.assetManager.getMetatile(n.metatileHash)||this.hiddenBuildingIds.has(n.id))return;zs(this.mapState.extendedTilesBounds,i)&&this.viewportModels.push(n)})}updateScene(){let e=!1;const n=new Map;this.viewportModels.forEach(i=>{const o=i.getCurrentMod();o&&o.ready&&n.set(o.key,o)}),this.displayedMods.forEach((i,o)=>{n.has(o)||(i.objects.length&&i.objects.forEach(r=>this.modules.tileManager.removeObject(r)),e=!0)}),n.forEach((i,o)=>{this.displayedMods.has(o)||(i.objects.length&&i.objects.forEach(r=>this.modules.tileManager.addObject(r)),e=!0),this.cache.get(o)}),e&&(this.displayedMods=n,this.modules.renderer.addRerenderEvent(),this.modules.identifier.resetCache())}cleanUnnessasaryModels(){const e=new Set(this.cache.getData().map(n=>n.model));this.models.forEach(n=>{e.has(n)||n.clean()})}loadModelsInfo(e,n,i){this.requestedModelsInfo.has(n)||(this.requestedModelsInfo.add(n),fetch(e).then(o=>{if(!o.ok)throw new Error(`Failed to load models info for region ${n}`);return o.json()}).then(o=>{o.forEach(r=>{const s=new kO(this.modules,this.mapState,this.cache,n,i,r);this.models.set(s.id,s)}),this.loadedModelsInfo.add(n)}).catch(o=>{this.loadedModelsInfo.add(n),console.error(o)}))}updateObjectsVisibility(){const e=this.ids;this.models.forEach(n=>{var r;const i=((r=this.getVisibleModelData(n.id))==null?void 0:r.opacity)||0,o=e.isHidden(n.id,Qn.PolygonExtrusion);i>=.5&&!o?e.hide([n.id],Qn.PolygonExtrusion):i<.5&&o&&e.show([n.id])})}}class zO{constructor(e){this.modules=e,this.isIdle=()=>!this.isGenerating,this.modCache=new Map,this.isGenerating=!1,this.currentPois=[],this.currentIdSet=new Set,this.currentTrafficState=!1,this.currentSelectedIds=[],this.currentModKey=h2(this.currentTrafficState,this.currentSelectedIds),this.ids=e.identifier.getIdScope(Yo)}setPersonalPoi(e){this.currentPois=e;const n=new Set;for(const i of e)n.add(i.id);this.currentIdSet=n,this.modCache.clear(),this.displayedModKey=void 0}redraw(){this.modCache.clear(),this.displayedModKey=void 0}getIdentifyDataChunk(){return this.identifyDataChunk}update(){if(this.regionMetadata===void 0&&(this.regionMetadata=this.modules.assetManager.getProjectMetadata()),this.regionMetadata===void 0)return;this.updateModKey();const e=this.currentModKey,n=this.modCache.get(e);n===void 0&&!this.isGenerating&&this.generate(e,this.currentPois,this.regionMetadata),n!==void 0&&e!==this.displayedModKey&&this.show(e,n,this.regionMetadata)}generate(e,n,i){const{regionId:o,metatileHash:r}=i,s=this.modules.map.state;this.isGenerating=!0,this.modules.workers.parser.generatePersonalPoi(n,o,r,window.devicePixelRatio,this.ids.getSelected(),s.handyStyleId,s.styleState,this.modules.defaultSource.getId()).then(a=>{if(a===void 0){this.isGenerating=!1;return}const{collectorOutput:l,styleId:c}=a,{packedRasters:d,rastersToLoad:u}=l;d!==void 0&&this.modules.assetManager.prepareRasters(c,d),this.modules.assetManager.loadRasters(u),this.modCache.set(e,a),this.isGenerating=!1})}show(e,n,i){const{metatileHash:o}=i,{collectorOutput:{labels:r,identifyIds:s},styleId:a}=n;this.modules.labeler.removeLabels("ppoi"),r.length&&this.modules.labeler.addLabels("ppoi",Yc.PersonalPoi,[{metatileHash:o,labels:r,styleId:a}]),this.identifyDataChunk={metatileHash:o,ids:s},this.modules.identifier.resetCache(),this.displayedModKey=e}updateModKey(){const e=this.ids.getSelected().filter(i=>this.currentIdSet.has(i)),n=this.modules.trafficTileLayer.isEnabled();(!Wr(this.currentSelectedIds,e)||this.currentTrafficState!==n)&&(this.currentTrafficState=n,this.currentSelectedIds=e,this.currentModKey=h2(n,e))}}function h2(t,e){return`ppoi_${t}_${e.join("|")}`}var Ue=(t=>(t[t.Main=0]="Main",t[t.Parser=1]="Parser",t[t.Labeling=2]="Labeling",t[t.Models=3]="Models",t[t.All=4]="All",t))(Ue||{}),ac=(t=>(t[t.FunctionUse=0]="FunctionUse",t[t.FunctionResult=1]="FunctionResult",t))(ac||{});class BO extends pl{constructor(){super(),this.workers=new Map}addWorker(e,n){this.workers.set(e,n),n.addEventListener("message",i=>{const{to:o,msg:r,transferable:s}=i.data,a={from:e,to:o,msg:r,transferable:s};this.routeMessage(a)})}send(e,n,i){const o=this.workers.get(e);if(o){const r={to:e,from:Ue.Main,msg:n,transferable:i};i!==void 0?o.postMessage(r,i):o.postMessage(r)}}broadcast(e){this.workers.forEach((n,i)=>{const o={to:i,from:Ue.Main,msg:e};n.postMessage(o)})}routeMessage(e){const{from:n,to:i,transferable:o,msg:{type:r}}=e;if(i===Ue.Main)this.emit("message",e);else if(i===Ue.All)n!==Ue.Main&&this.emit(r,e),this.workers.forEach((s,a)=>{a!==n&&(o!==void 0?s.postMessage(e,o):s.postMessage(e))});else{const s=this.workers.get(i);s&&(o!==void 0?s.postMessage(e,o):s.postMessage(e))}}}class OO{constructor(e){this.onMessage=n=>{const{from:i,msg:o}=n;switch(o.type){case ac.FunctionUse:this.onFunctionUse(o,i);break;case ac.FunctionResult:this.onFunctionResult(o);break}},this.connector=e,this.functions=new Map,this.functionIdCounter=0,this.pendingFunctions=new Map,e.on("message",this.onMessage)}set(e,n){this.functions.set(e,n)}get(e,n){return(...i)=>{const o=this.functionIdCounter++,r=new Promise(a=>{this.pendingFunctions.set(o,a)}),s={type:ac.FunctionUse,data:{id:o,name:n,args:i}};return this.connector.send(e,s),r}}onFunctionUse(e,n){const{data:{name:i,args:o,id:r}}=e,s=this.functions.get(i);if(s){const a=s(...o);a&&a.then?Promise.resolve(a).then(l=>this.sendFunctionResult(n,r,l)):this.sendFunctionResult(n,r,a)}else console.error(`FnRegistry#onFunctionUse: function ${i} not found`)}sendFunctionResult(e,n,i){const o={type:ac.FunctionResult,data:{id:n,result:i}};i&&i.transferable?this.connector.send(e,o,i.transferable):this.connector.send(e,o)}onFunctionResult(e){const{data:{id:n,result:i}}=e,o=this.pendingFunctions.get(n);o?(o(i),this.pendingFunctions.delete(n)):console.error(`FnRegistry#onFunctionResult: pending function ${n} not found`)}}class DO{constructor(e){this.fnRegistry=e,this.onClassCreate=({id:n,name:i,args:o})=>{const r=this.classes.get(i);if(!r){console.error(`ClassRegistry#onClassCreate: class ${i} not found`);return}const s=r.scope?new r.ClassConstructor(r.scope,...o):new r.ClassConstructor(...o);r.hosts.set(n,s)},this.onMethodUse=({id:n,name:i,method:o,args:r})=>{const s=this.classes.get(i);if(!s){console.error(`ClassRegistry#onMethodUse: class ${i} not found`);return}const a=s.hosts.get(n);if(!a){console.error(`ClassRegistry#onMethodUse: instance ${n} in class ${i} not found when calling the ${o} method`);return}if(!a[o]){console.error(`ClassRegistry#onMethodUse: method ${o} in instance ${n} in class ${i} not found`);return}return o==="destroy"&&s.hosts.delete(n),a[o](...r)},this.classes=new Map,this.idCounter=0,this.fnRegistry.set("createClass",this.onClassCreate),this.fnRegistry.set("classMethodUse",this.onMethodUse)}set(e,n,i){const o=this,r={ClassConstructor:n,hosts:new Map,proxies:new Map,scope:i};return this.classes.set(e,r),{get:s=>{class a{constructor(...d){this.id=o.idCounter++,o.fnRegistry.get(s,"createClass")({id:this.id,args:d,name:e})}}return Object.getOwnPropertyNames(n.prototype).forEach(c=>{c!=="constructor"&&(a.prototype[c]=function(...d){return o.fnRegistry.get(s,"classMethodUse")({id:this.id,name:e,method:c,args:d})})}),a}}}}function zp(t,e,n,i,o=2){const r=o+2;let s=i;const a=n-e>>1;let l=n-e,c;const d=t[e],u=t[e+1],f=t[n],h=t[n+1];for(let _=e+r;_<n;_+=r){const p=NO(t[_],t[_+1],d,u,f,h);if(p>s)c=_,s=p;else if(p===s){const m=Math.abs(_-a);m<l&&(c=_,l=m)}}s>i&&(c-e>r&&zp(t,e,c,i,o),t[c+2]=s,n-c>r&&zp(t,c,n,i,o))}function NO(t,e,n,i,o,r){let s=o-n,a=r-i;if(s!==0||a!==0){const l=((t-n)*s+(e-i)*a)/(s*s+a*a);l>1?(n=o,i=r):l>0&&(n+=s*l,i+=a*l)}return s=t-n,a=e-i,s*s+a*a}function Bc(t,e,n,i,o,r=4){const s={id:t??null,index:o,type:e,geometry:n,tags:i,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};if(e==="Point"||e==="MultiPoint"||e==="LineString")Iu(s,n,r);else if(e==="Polygon")Iu(s,n[0],r);else if(e==="MultiLineString")for(const a of n)Iu(s,a,r);else if(e==="MultiPolygon")for(const a of n)Iu(s,a[0],r);return s}function Iu(t,e,n=4){for(let i=0;i<e.length;i+=n)t.minX=Math.min(t.minX,e[i]),t.minY=Math.min(t.minY,e[i+1]),t.maxX=Math.max(t.maxX,e[i]),t.maxY=Math.max(t.maxY,e[i+1])}function UO(t,e){const n=[];if(t.type==="FeatureCollection")for(let i=0;i<t.features.length;i++)of(n,t.features[i],e,i);else t.type==="Feature"?of(n,t,e,0):of(n,{geometry:t},e,0);return n}function of(t,e,n,i){if(!e.geometry)return;const o=e.geometry.coordinates,r=e.geometry.type,s=Math.pow(n.tolerance/((1<<n.maxZoom)*n.extent),2);let a=[],l=e.id;if(n.promoteId?l=e.properties[n.promoteId]:n.generateId&&(l=i||0),r==="Point")_2(o,a,n.dimensions);else if(r==="MultiPoint")for(const c of o)_2(c,a,n.dimensions);else if(r==="LineString")Bp(o,a,s,!1,n.dimensions);else if(r==="MultiLineString")if(n.lineMetrics){for(const c of o)a=[],Bp(c,a,s,!1,n.dimensions),t.push(Bc(l,"LineString",a,e.properties,i,n.dimensions+2));return}else K_(o,a,s,!1,n.dimensions);else if(r==="Polygon")K_(o,a,s,!0,n.dimensions);else if(r==="MultiPolygon")for(const c of o){const d=[];K_(c,d,s,!0,n.dimensions),a.push(d)}else if(r==="GeometryCollection"){for(const c of e.geometry.geometries)of(t,{id:l,geometry:c,properties:e.properties},n,i);return}else throw new Error("Input data is not a valid GeoJSON object.");t.push(Bc(l,r,a,e.properties,i,n.dimensions+2))}function _2(t,e,n=2){e.push(_w(t[0]),mw(t[1]),0,1);for(let i=2;i<n;i++)e.push(t[i])}function Bp(t,e,n,i,o=2){let r,s,a=0;for(let c=0;c<t.length;c++){const d=_w(t[c][0]),u=mw(t[c][1]);e.push(d,u,0,1);for(let f=2;f<o;f++)e.push(t[c][f]);c>0&&(i?a+=(r*u-d*s)/2:a+=Math.sqrt(Math.pow(d-r,2)+Math.pow(u-s,2))),r=d,s=u}const l=e.length-(o+2);e[2]=1,zp(e,0,l,n,o),e[l+2]=1,e.size=Math.abs(a),e.start=0,e.end=e.size}function K_(t,e,n,i,o=2){for(let r=0;r<t.length;r++){const s=[];Bp(t[r],s,n,i,o),e.push(s)}}function _w(t){return t/360+.5}function mw(t){const e=Math.sin(t*Math.PI/180),n=.5-.25*Math.log((1+e)/(1-e))/Math.PI;return n<0?0:n>1?1:n}function fr(t,e,n,i,o,r,s,a){const l=(a.dimensions===void 0?2:a.dimensions)+2;if(n/=e,i/=e,r>=n&&s<i)return t;if(s<n||r>=i)return null;const c=[];for(const d of t){const u=d.geometry;let f=d.type;const h=o===0?d.minX:d.minY,_=o===0?d.maxX:d.maxY;if(h>=n&&_<i){c.push(d);continue}else if(_<n||h>=i)continue;let p=[];if(f==="Point"||f==="MultiPoint")GO(u,p,n,i,o,l);else if(f==="LineString")pw(u,p,n,i,o,!1,a.lineMetrics,l);else if(f==="MultiLineString")J_(u,p,n,i,o,!1,l);else if(f==="Polygon")J_(u,p,n,i,o,!0,l);else if(f==="MultiPolygon")for(const m of u){const g=[];J_(m,g,n,i,o,!0,l),g.length&&p.push(g)}if(p.length){if(a.lineMetrics&&f==="LineString"){for(const m of p)c.push(Bc(d.id,f,m,d.tags,d.index,l));continue}(f==="LineString"||f==="MultiLineString")&&(p.length===1?(f="LineString",p=p[0]):f="MultiLineString"),(f==="Point"||f==="MultiPoint")&&(f=p.length===l?"Point":"MultiPoint"),c.push(Bc(d.id,f,p,d.tags,d.index,l))}}return c.length?c:null}function GO(t,e,n,i,o,r=4){for(let s=0;s<t.length;s+=r){const a=t[s+o];if(a>=n&&a<=i){Da(e,t[s],t[s+1],t[s+2]);for(let l=3;l<r;l++)e.push(t[s+l])}}}function pw(t,e,n,i,o,r,s,a=4){let l=m2(t);const c=o===0?HO:VO;let d=t.start,u,f;for(let y=0;y<t.length-a;y+=a){const b=t[y],v=t[y+1],T=t[y+2],x=t[y+a],I=t[y+a+1],E=o===0?b:v,L=o===0?x:I;let N=!1;if(s&&(u=Math.sqrt(Math.pow(b-x,2)+Math.pow(v-I,2))),E<n){if(L>n){f=c(l,b,v,x,I,n),l.push(0);for(let k=4;k<a;k++){const w=t[y+k];l.push((t[y+a+k]-w)*f+w)}s&&(l.start=d+u*f)}}else if(E>i){if(L<i){f=c(l,b,v,x,I,i),l.push(0);for(let k=4;k<a;k++){const w=t[y+k];l.push((t[y+a+k]-w)*f+w)}s&&(l.start=d+u*f)}}else{Da(l,b,v,T);for(let k=3;k<a;k++)l.push(t[y+k])}if(L<n&&E>=n){f=c(l,b,v,x,I,n),l.push(0);for(let k=4;k<a;k++){const w=t[y+k];l.push((t[y+a+k]-w)*f+w)}N=!0}if(L>i&&E<=i){f=c(l,b,v,x,I,i),l.push(0);for(let k=4;k<a;k++){const w=t[y+k];l.push((t[y+a+k]-w)*f+w)}N=!0}!r&&N&&(s&&(l.end=d+u*f),e.push(l),l=m2(t)),s&&(d+=u)}let h=t.length-a;const _=t[h],p=t[h+1],m=t[h+2],g=o===0?_:p;if(g>=n&&g<=i){Da(l,_,p,m);for(let y=3;y<a;y++)l.push(t[h+y])}if(h=l.length-a,r&&h>=3&&(l[h]!==l[0]||l[h+1]!==l[1])){Da(l,l[0],l[1],l[2]);for(let y=3;y<a;y++)l.push(l[y])}l.length&&e.push(l)}function m2(t){const e=[];return e.size=t.size,e.start=t.start,e.end=t.end,e}function J_(t,e,n,i,o,r,s){for(const a of t)pw(a,e,n,i,o,r,!1,s)}function Da(t,e,n,i){t.push(e,n,i)}function HO(t,e,n,i,o,r){const s=(r-e)/(i-e);return Da(t,r,n+(o-n)*s,1),s}function VO(t,e,n,i,o,r){const s=(r-n)/(o-n);return Da(t,e+(i-e)*s,r,1),s}function jO(t,e){const n=e.buffer/e.extent,i=e.dimensions+2;let o=t;const r=fr(t,1,-1-n,n,0,-1,2,e),s=fr(t,1,1-n,2+n,0,-1,2,e);return(r||s)&&(o=fr(t,1,-n,1+n,0,-1,2,e)||[],r&&(o=p2(r,1,i).concat(o)),s&&(o=o.concat(p2(s,-1,i)))),o}function p2(t,e,n=4){const i=[];for(let o=0;o<t.length;o++){const r=t[o],s=r.type;let a;if(s==="Point"||s==="MultiPoint"||s==="LineString")a=Q_(r.geometry,e,n);else if(s==="MultiLineString"||s==="Polygon"){a=[];for(const l of r.geometry)a.push(Q_(l,e,n))}else if(s==="MultiPolygon"){a=[];for(const l of r.geometry){const c=[];for(const d of l)c.push(Q_(d,e,n));a.push(c)}}i.push(Bc(r.id,s,a,r.tags,r.index,n))}return i}function Q_(t,e,n=4){const i=[];i.size=t.size,t.start!==void 0&&(i.start=t.start,i.end=t.end);for(let o=0;o<t.length;o+=n){i.push(t[o]+e,t[o+1],t[o+2],t[o+3]);for(let r=4;r<n;r++)i.push(t[o+r])}return i}function g2(t,e,n){if(t.transformed)return t;const i=1<<t.z,o=t.x,r=t.y;for(const s of t.features){const a=s.geometry,l=s.type;s.geometry=[];const c=n.cuts&&l!==1?1:0,d=n.dimensions+c;if(l===1)for(let u=0;u<a.length;u+=d)s.geometry.push(gw(a,u,d,e,i,o,r));else if(l===2)s.geometry=v2(a,e,i,o,r,d);else for(let u=0;u<a.length;u++)s.geometry.push(v2(a[u],e,i,o,r,d))}return t.transformed=!0,t}function v2(t,e,n,i,o,r=3){const s=[];for(let a=0;a<t.length;a++){const l=[];for(let c=0;c<t[a].length;c+=r)l.push(gw(t[a],c,r,e,n,i,o));s.push(l)}return s}function gw(t,e,n,i,o,r,s){const a=[Math.round(i*(t[e]*o-r)),Math.round(i*(t[e+1]*o-s))];for(let l=2;l<n;l++)a.push(t[e+l]);return a}function $O(t,e,n,i,o){const r=e===o.maxZoom?0:o.tolerance/((1<<e)*o.extent),s={features:[],numPoints:0,numSimplified:0,numFeatures:t.length,source:null,x:n,y:i,z:e,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0};for(const a of t)WO(s,a,r,o);return s}function WO(t,e,n,i){const o=e.geometry,r=e.type,s=i.dimensions+2;let a=[];if(t.minX=Math.min(t.minX,e.minX),t.minY=Math.min(t.minY,e.minY),t.maxX=Math.max(t.maxX,e.maxX),t.maxY=Math.max(t.maxY,e.maxY),r==="Point"||r==="MultiPoint")for(let l=0;l<o.length;l+=s){a.push(o[l],o[l+1]);for(let c=4;c<s;c++)a.push(o[l+c]);t.numPoints++,t.numSimplified++}else if(r==="LineString")em(a,o,t,n,!1,!1,i);else if(r==="MultiLineString"||r==="Polygon"){for(let l=0;l<o.length;l++)em(a,o[l],t,n,r==="Polygon",l===0,i);r==="Polygon"&&a.length&&(a=[a])}else if(r==="MultiPolygon")for(let l=0;l<o.length;l++){const c=o[l],d=[];for(let u=0;u<c.length;u++)em(d,c[u],t,n,!0,u===0,i);d.length&&a.push(d)}if(a.length){let l=e.tags||null;if(r==="LineString"&&i.lineMetrics){l={};for(const d in e.tags)l[d]=e.tags[d];l.mapbox_clip_start=o.start/o.size,l.mapbox_clip_end=o.end/o.size}const c={geometry:a,type:r==="Polygon"||r==="MultiPolygon"?3:r==="LineString"||r==="MultiLineString"?2:1,tags:l};e.id!==null&&(c.id=e.id),i.generateIndex&&(c.index=e.index),t.features.push(c)}}function em(t,e,n,i,o,r,s){const a=i*i,l=s&&!!s.cuts,c=s.dimensions+2;if(i>0&&e.size<(o?a:i)){n.numPoints+=e.length/c;return}const d=[];for(let u=0;u<e.length;u+=c){if(i===0||e[u+2]>a){n.numSimplified++,d.push(e[u],e[u+1]);for(let f=4;f<c;f++)d.push(e[u+f]);l&&d.push(e[u+3])}n.numPoints++}o&&ZO(d,r,c-(l?1:2)),t.push(d)}function ZO(t,e,n=3){let i=0;for(let o=0,r=t.length,s=r-n;o<r;s=o,o+=n)i+=(t[o]-t[s])*(t[o+1]+t[s+1]);if(i>0===e)for(let o=0,r=t.length;o<r/2;o+=n)for(let s=0;s<n;s++){const a=t[o+s],l=r-o-(n-s);t[o+s]=t[l],t[l]=a}return t}const tm={Points:1,Lines:2,Polygons:3},XO={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,generateIndex:!1,debug:0,dimensions:2,cuts:!1};class YO{constructor(e,n){n=this.options=qO(Object.create(XO),n);const i=n.debug;if(i&&console.time("preprocess data"),n.maxZoom<0||n.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(n.promoteId&&n.generateId)throw new Error("promoteId and generateId cannot be used together.");let o=UO(e,n);this.tiles={},this.tileCoords=[],i&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",n.indexMaxZoom,n.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),o=jO(o,n),o.length&&this.splitTile(o,0,0,0),i&&(o.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}splitTile(e,n,i,o,r,s,a){const l=[e,n,i,o],c=this.options,d=c.debug;for(;l.length;){o=l.pop(),i=l.pop(),n=l.pop(),e=l.pop();const u=1<<n,f=nm(n,i,o);let h=this.tiles[f];if(!h&&(d>1&&console.time("creation"),h=this.tiles[f]=$O(e,n,i,o,c),this.tileCoords.push({z:n,x:i,y:o}),d)){d>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",n,i,o,h.numFeatures,h.numPoints,h.numSimplified),console.timeEnd("creation"));const E=`z${n}`;this.stats[E]=(this.stats[E]||0)+1,this.total++}if(h.source=e,r==null){if(n===c.indexMaxZoom||h.numPoints<=c.indexMaxPoints)continue}else{if(n===c.maxZoom||n===r)continue;if(r!=null){const E=r-n;if(i!==s>>E||o!==a>>E)continue}}if(h.source=null,e.length===0)continue;d>1&&console.time("clipping");const _=.5*c.buffer/c.extent,p=.5-_,m=.5+_,g=1+_;let y=null,b=null,v=null,T=null,x=fr(e,u,i-_,i+m,0,h.minX,h.maxX,c),I=fr(e,u,i+p,i+g,0,h.minX,h.maxX,c);e=null,x&&(y=fr(x,u,o-_,o+m,1,h.minY,h.maxY,c),b=fr(x,u,o+p,o+g,1,h.minY,h.maxY,c),x=null),I&&(v=fr(I,u,o-_,o+m,1,h.minY,h.maxY,c),T=fr(I,u,o+p,o+g,1,h.minY,h.maxY,c),I=null),d>1&&console.timeEnd("clipping"),l.push(y||[],n+1,i*2,o*2),l.push(b||[],n+1,i*2,o*2+1),l.push(v||[],n+1,i*2+1,o*2),l.push(T||[],n+1,i*2+1,o*2+1)}}getTile(e,n,i){e=+e,n=+n,i=+i;const o=this.options,{extent:r,debug:s}=o;if(e<0||e>24)return null;const a=1<<e;n=n+a&a-1;const l=nm(e,n,i);if(this.tiles[l])return g2(this.tiles[l],r,o);s>1&&console.log("drilling down to z%d-%d-%d",e,n,i);let c=e,d=n,u=i,f;for(;!f&&c>0;)c--,d=d>>1,u=u>>1,f=this.tiles[nm(c,d,u)];return!f||!f.source?null:(s>1&&(console.log("found parent tile z%d-%d-%d",c,d,u),console.time("drilling down")),this.splitTile(f.source,c,d,u,e,n,i),s>1&&console.timeEnd("drilling down"),this.tiles[l]?g2(this.tiles[l],r,o):null)}}function nm(t,e,n){return((1<<t)*n+e)*32+t}function qO(t,e){for(const n in e)t[n]=e[n];return t}function KO(t,e){return new YO(t,e)}var Eu={exports:{}},y2;function JO(){if(y2)return Eu.exports;y2=1,Eu.exports=t,Eu.exports.default=t;function t(M,P,C){C=C||2;var D=P&&P.length,B=D?P[0]*C:M.length,U=e(M,0,B,C,!0),G=[];if(!U||U.next===U.prev)return G;var V,ne,X,Z,Q,le,Ie;if(D&&(U=l(M,P,U,C)),M.length>80*C){V=X=M[0],ne=Z=M[1];for(var ce=C;ce<B;ce+=C)Q=M[ce],le=M[ce+1],Q<V&&(V=Q),le<ne&&(ne=le),Q>X&&(X=Q),le>Z&&(Z=le);Ie=Math.max(X-V,Z-ne),Ie=Ie!==0?32767/Ie:0}return i(U,G,C,V,ne,Ie,0),G}function e(M,P,C,D,B){var U,G;if(B===z(M,P,C,D)>0)for(U=P;U<C;U+=D)G=w(U,M[U],M[U+1],G);else for(U=C-D;U>=P;U-=D)G=w(U,M[U],M[U+1],G);return G&&v(G,G.next)&&(S(G),G=G.next),G}function n(M,P){if(!M)return M;P||(P=M);var C=M,D;do if(D=!1,!C.steiner&&(v(C,C.next)||b(C.prev,C,C.next)===0)){if(S(C),C=P=C.prev,C===C.next)break;D=!0}else C=C.next;while(D||C!==P);return P}function i(M,P,C,D,B,U,G){if(M){!G&&U&&h(M,D,B,U);for(var V=M,ne,X;M.prev!==M.next;){if(ne=M.prev,X=M.next,U?r(M,D,B,U):o(M)){P.push(ne.i/C|0),P.push(M.i/C|0),P.push(X.i/C|0),S(M),M=X.next,V=X.next;continue}if(M=X,M===V){G?G===1?(M=s(n(M),P,C),i(M,P,C,D,B,U,2)):G===2&&a(M,P,C,D,B,U):i(n(M),P,C,D,B,U,1);break}}}}function o(M){var P=M.prev,C=M,D=M.next;if(b(P,C,D)>=0)return!1;for(var B=P.x,U=C.x,G=D.x,V=P.y,ne=C.y,X=D.y,Z=B<U?B<G?B:G:U<G?U:G,Q=V<ne?V<X?V:X:ne<X?ne:X,le=B>U?B>G?B:G:U>G?U:G,Ie=V>ne?V>X?V:X:ne>X?ne:X,ce=D.next;ce!==P;){if(ce.x>=Z&&ce.x<=le&&ce.y>=Q&&ce.y<=Ie&&g(B,V,U,ne,G,X,ce.x,ce.y)&&b(ce.prev,ce,ce.next)>=0)return!1;ce=ce.next}return!0}function r(M,P,C,D){var B=M.prev,U=M,G=M.next;if(b(B,U,G)>=0)return!1;for(var V=B.x,ne=U.x,X=G.x,Z=B.y,Q=U.y,le=G.y,Ie=V<ne?V<X?V:X:ne<X?ne:X,ce=Z<Q?Z<le?Z:le:Q<le?Q:le,Fe=V>ne?V>X?V:X:ne>X?ne:X,Me=Z>Q?Z>le?Z:le:Q>le?Q:le,ye=p(Ie,ce,P,C,D),re=p(Fe,Me,P,C,D),ee=M.prevZ,de=M.nextZ;ee&&ee.z>=ye&&de&&de.z<=re;){if(ee.x>=Ie&&ee.x<=Fe&&ee.y>=ce&&ee.y<=Me&&ee!==B&&ee!==G&&g(V,Z,ne,Q,X,le,ee.x,ee.y)&&b(ee.prev,ee,ee.next)>=0||(ee=ee.prevZ,de.x>=Ie&&de.x<=Fe&&de.y>=ce&&de.y<=Me&&de!==B&&de!==G&&g(V,Z,ne,Q,X,le,de.x,de.y)&&b(de.prev,de,de.next)>=0))return!1;de=de.nextZ}for(;ee&&ee.z>=ye;){if(ee.x>=Ie&&ee.x<=Fe&&ee.y>=ce&&ee.y<=Me&&ee!==B&&ee!==G&&g(V,Z,ne,Q,X,le,ee.x,ee.y)&&b(ee.prev,ee,ee.next)>=0)return!1;ee=ee.prevZ}for(;de&&de.z<=re;){if(de.x>=Ie&&de.x<=Fe&&de.y>=ce&&de.y<=Me&&de!==B&&de!==G&&g(V,Z,ne,Q,X,le,de.x,de.y)&&b(de.prev,de,de.next)>=0)return!1;de=de.nextZ}return!0}function s(M,P,C){var D=M;do{var B=D.prev,U=D.next.next;!v(B,U)&&T(B,D,D.next,U)&&L(B,U)&&L(U,B)&&(P.push(B.i/C|0),P.push(D.i/C|0),P.push(U.i/C|0),S(D),S(D.next),D=M=U),D=D.next}while(D!==M);return n(D)}function a(M,P,C,D,B,U){var G=M;do{for(var V=G.next.next;V!==G.prev;){if(G.i!==V.i&&y(G,V)){var ne=k(G,V);G=n(G,G.next),ne=n(ne,ne.next),i(G,P,C,D,B,U,0),i(ne,P,C,D,B,U,0);return}V=V.next}G=G.next}while(G!==M)}function l(M,P,C,D){var B=[],U,G,V,ne,X;for(U=0,G=P.length;U<G;U++)V=P[U]*D,ne=U<G-1?P[U+1]*D:M.length,X=e(M,V,ne,D,!1),X===X.next&&(X.steiner=!0),B.push(m(X));for(B.sort(c),U=0;U<B.length;U++)C=d(B[U],C);return C}function c(M,P){return M.x-P.x}function d(M,P){var C=u(M,P);if(!C)return P;var D=k(C,M);return n(D,D.next),n(C,C.next)}function u(M,P){var C=P,D=M.x,B=M.y,U=-1/0,G;do{if(B<=C.y&&B>=C.next.y&&C.next.y!==C.y){var V=C.x+(B-C.y)*(C.next.x-C.x)/(C.next.y-C.y);if(V<=D&&V>U&&(U=V,G=C.x<C.next.x?C:C.next,V===D))return G}C=C.next}while(C!==P);if(!G)return null;var ne=G,X=G.x,Z=G.y,Q=1/0,le;C=G;do D>=C.x&&C.x>=X&&D!==C.x&&g(B<Z?D:U,B,X,Z,B<Z?U:D,B,C.x,C.y)&&(le=Math.abs(B-C.y)/(D-C.x),L(C,M)&&(le<Q||le===Q&&(C.x>G.x||C.x===G.x&&f(G,C)))&&(G=C,Q=le)),C=C.next;while(C!==ne);return G}function f(M,P){return b(M.prev,M,P.prev)<0&&b(P.next,M,M.next)<0}function h(M,P,C,D){var B=M;do B.z===0&&(B.z=p(B.x,B.y,P,C,D)),B.prevZ=B.prev,B.nextZ=B.next,B=B.next;while(B!==M);B.prevZ.nextZ=null,B.prevZ=null,_(B)}function _(M){var P,C,D,B,U,G,V,ne,X=1;do{for(C=M,M=null,U=null,G=0;C;){for(G++,D=C,V=0,P=0;P<X&&(V++,D=D.nextZ,!!D);P++);for(ne=X;V>0||ne>0&&D;)V!==0&&(ne===0||!D||C.z<=D.z)?(B=C,C=C.nextZ,V--):(B=D,D=D.nextZ,ne--),U?U.nextZ=B:M=B,B.prevZ=U,U=B;C=D}U.nextZ=null,X*=2}while(G>1);return M}function p(M,P,C,D,B){return M=(M-C)*B|0,P=(P-D)*B|0,M=(M|M<<8)&16711935,M=(M|M<<4)&252645135,M=(M|M<<2)&858993459,M=(M|M<<1)&1431655765,P=(P|P<<8)&16711935,P=(P|P<<4)&252645135,P=(P|P<<2)&858993459,P=(P|P<<1)&1431655765,M|P<<1}function m(M){var P=M,C=M;do(P.x<C.x||P.x===C.x&&P.y<C.y)&&(C=P),P=P.next;while(P!==M);return C}function g(M,P,C,D,B,U,G,V){return(B-G)*(P-V)>=(M-G)*(U-V)&&(M-G)*(D-V)>=(C-G)*(P-V)&&(C-G)*(U-V)>=(B-G)*(D-V)}function y(M,P){return M.next.i!==P.i&&M.prev.i!==P.i&&!E(M,P)&&(L(M,P)&&L(P,M)&&N(M,P)&&(b(M.prev,M,P.prev)||b(M,P.prev,P))||v(M,P)&&b(M.prev,M,M.next)>0&&b(P.prev,P,P.next)>0)}function b(M,P,C){return(P.y-M.y)*(C.x-P.x)-(P.x-M.x)*(C.y-P.y)}function v(M,P){return M.x===P.x&&M.y===P.y}function T(M,P,C,D){var B=I(b(M,P,C)),U=I(b(M,P,D)),G=I(b(C,D,M)),V=I(b(C,D,P));return!!(B!==U&&G!==V||B===0&&x(M,C,P)||U===0&&x(M,D,P)||G===0&&x(C,M,D)||V===0&&x(C,P,D))}function x(M,P,C){return P.x<=Math.max(M.x,C.x)&&P.x>=Math.min(M.x,C.x)&&P.y<=Math.max(M.y,C.y)&&P.y>=Math.min(M.y,C.y)}function I(M){return M>0?1:M<0?-1:0}function E(M,P){var C=M;do{if(C.i!==M.i&&C.next.i!==M.i&&C.i!==P.i&&C.next.i!==P.i&&T(C,C.next,M,P))return!0;C=C.next}while(C!==M);return!1}function L(M,P){return b(M.prev,M,M.next)<0?b(M,P,M.next)>=0&&b(M,M.prev,P)>=0:b(M,P,M.prev)<0||b(M,M.next,P)<0}function N(M,P){var C=M,D=!1,B=(M.x+P.x)/2,U=(M.y+P.y)/2;do C.y>U!=C.next.y>U&&C.next.y!==C.y&&B<(C.next.x-C.x)*(U-C.y)/(C.next.y-C.y)+C.x&&(D=!D),C=C.next;while(C!==M);return D}function k(M,P){var C=new A(M.i,M.x,M.y),D=new A(P.i,P.x,P.y),B=M.next,U=P.prev;return M.next=P,P.prev=M,C.next=B,B.prev=C,D.next=C,C.prev=D,U.next=D,D.prev=U,D}function w(M,P,C,D){var B=new A(M,P,C);return D?(B.next=D.next,B.prev=D,D.next.prev=B,D.next=B):(B.prev=B,B.next=B),B}function S(M){M.next.prev=M.prev,M.prev.next=M.next,M.prevZ&&(M.prevZ.nextZ=M.nextZ),M.nextZ&&(M.nextZ.prevZ=M.prevZ)}function A(M,P,C){this.i=M,this.x=P,this.y=C,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}t.deviation=function(M,P,C,D){var B=P&&P.length,U=B?P[0]*C:M.length,G=Math.abs(z(M,0,U,C));if(B)for(var V=0,ne=P.length;V<ne;V++){var X=P[V]*C,Z=V<ne-1?P[V+1]*C:M.length;G-=Math.abs(z(M,X,Z,C))}var Q=0;for(V=0;V<D.length;V+=3){var le=D[V]*C,Ie=D[V+1]*C,ce=D[V+2]*C;Q+=Math.abs((M[le]-M[ce])*(M[Ie+1]-M[le+1])-(M[le]-M[Ie])*(M[ce+1]-M[le+1]))}return G===0&&Q===0?0:Math.abs((Q-G)/G)};function z(M,P,C,D){for(var B=0,U=P,G=C-D;U<C;U+=D)B+=(M[G]-M[U])*(M[U+1]+M[G+1]),G=U;return B}return t.flatten=function(M){for(var P=M[0][0].length,C={vertices:[],holes:[],dimensions:P},D=0,B=0;B<M.length;B++){for(var U=0;U<M[B].length;U++)for(var G=0;G<P;G++)C.vertices.push(M[B][U][G]);B>0&&(D+=M[B-1].length,C.holes.push(D))}return C},Eu.exports}var QO=JO();const vw=ll(QO);function eD(t){const e=Ct(t),n=q.scaleFactor(Ac(0,0,e)[1]),i=q.scaleFactor(Ac(0,Se,e)[1]);return{min:n,max:i,range:i-n}}function tD(t,e,n,i){const o=[];return t.geometry.forEach(r=>{const s=[],a=[],l=[];r.forEach(f=>{l.push(...sD(f,e)),s.length&&a.push(s.length),s.push(...f)});const c=[];for(let f=0;f<s.length;f++)for(let h=0;h<n;h++)c.push(s[f][h]);const d=vw(c,a,n),u=new Array(n);for(let f=0;f<d.length;f+=3){const h=[];for(let _=0;_<n+1;_++)h.push([]);for(let _=0;_<3;_++)gg(u,s[d[f+2-_]],e,i),h[0][_]=u[0],h[1][_]=u[1],h[2][_]=0,n>2&&(h[3][_]=u[2]),n>3&&(h[4][_]=u[3]);l.forEach(_=>{const p=[[],[],[]];_.forEach((m,g)=>{p[0][g]=m[0],p[1][g]=m[1]}),fw(h,p)}),o.push({tags:t.tags,id:t.id,index:t.index,type:"polygon",vertices:{x:h[0],y:h[1],cut:h[2],signed_z:h[3],abs_z:h[4]}})}}),o}function nD(t,e,n,i){const o=Array(n);return t.geometry.map(r=>{const s=[];for(let a=0;a<n;a++)s.push([]);return r.forEach((a,l)=>{gg(o,a,e,i),s[0][l]=o[0],s[1][l]=o[1],n>2&&(s[2][l]=o[2]),n>3&&(s[3][l]=o[3])}),{tags:t.tags,id:t.id,index:t.index,type:"line",vertices:{x:s[0],y:s[1],z:s[2],signed_z:s[2],abs_z:s[3]}}})}function iD(t,e,n,i){const o=Array(n);return t.geometry.map(r=>{gg(o,r,e,i);const s={x:[o[0]],y:[o[1]],z:n>2?[o[2]??0]:void 0,abs_z:n>3&&o[3]!==void 0?[o[3]]:void 0};return{tags:t.tags,id:t.id,index:t.index,type:"point",vertices:s}})}function gg(t,e,n,i){const o=yw(e,n);t[0]=o[0],t[1]=o[1];const r=i.min+o[1]/Se*i.range;e[2]===void 0?t[2]=0:t[2]=e[2]*He*r,e[3]!==void 0&&(t[3]=e[3]*He*r)}function yw(t,e){return[Ve(t[0]/e*Se,0,Se),Ve((e-t[1])/e*Se,0,Se)]}function oD(t,e){return t[0]<0||t[0]>e||t[1]<0||t[1]>e}function rD(t,e,n){return t[0]>n&&e[0]>n||t[0]<0&&e[0]<0||t[1]>n&&e[1]>n||t[1]<0&&e[1]<0}function sD(t,e){const n=[];let i=[];for(let o=0;o<t.length;o++){const r=t[o];if(i.push(yw(r,e)),!oD(r,e))continue;const s=t[o+1];if(!s)break;rD(r,s,e)&&(i.length>1&&n.push(i),i=[])}return i.length>1&&n.push(i),n}const bw=4096,ww=2,da={maxZoom:db,tolerance:3,extent:bw,buffer:1,debug:0,lineMetrics:!1,promoteId:null,generateId:!1,generateIndex:!0,indexMaxZoom:0,indexMaxPoints:1e5,dimensions:ww};class im{constructor(e){this.options=e}get geoJsonVtInstance(){return this.geoJsonVT||(this.geoJsonVT=KO(this.options.data,{...da,maxZoom:this.options.maxZoom??da.maxZoom,dimensions:this.options.dimensions??da.dimensions,extent:this.options.extent??da.extent,buffer:this.options.buffer??da.buffer,promoteId:this.options.promoteId,tolerance:this.options.tolerance??da.tolerance})),this.geoJsonVT}fetchTile(e){const[n,i,o]=ah(e),r={components:[],byId:new Map},s=this.geoJsonVtInstance.getTile(o,n,i),a=this.options.dimensions??ww,l=this.options.extent??bw,c=eD(e);if(!s)return Promise.resolve(r);for(const d of s.features)switch(d.type){case tm.Points:r.components=r.components.concat(iD(d,l,a,c));break;case tm.Lines:r.components=r.components.concat(nD(d,l,a,c));break;case tm.Polygons:r.components=r.components.concat(tD(d,l,a,c));break;default:console.warn("unsupported type ",s);break}return Promise.resolve(r)}destroy(){this.geoJsonVT=void 0}}function aD(t,e,n){const i={components:[],byId:new Map};return t.features.forEach((o,r)=>{i.components.push(...xw(o.geometry,e).map(s=>({...s,index:r,id:o.id,tags:o.properties||{}})))}),i}function xw(t,e,n){switch(t.type){case"GeometryCollection":{let i=[];return t.geometries.forEach(o=>{i=i.concat(xw(o,e))}),i}case"Point":case"MultiPoint":return lD(t,e);case"LineString":case"MultiLineString":return cD(t,e);case"Polygon":case"MultiPolygon":return dD(t,e)}}function lD(t,e){return t.type==="Point"?[b2(t.coordinates,e)]:t.coordinates.map(n=>b2(n,e))}function cD(t,e){return t.type==="LineString"?[w2(t.coordinates,e)]:t.coordinates.map(n=>w2(n,e))}function dD(t,e,n){return t.type==="Polygon"?x2(t.coordinates,e):t.coordinates.reduce((i,o)=>i.concat(x2(o,e)),[])}function b2(t,e){const n=[0,0,0];return mi(n,q.fromGeo(t),e),{type:"point",vertices:{x:[n[0]],y:[n[1]]}}}function w2(t,e){const n=[[],[]],i=[0,0,0];return t.forEach((o,r)=>{mi(i,q.fromGeo(o),e),n[0][r]=i[0],n[1][r]=i[1]}),{type:"line",vertices:{x:n[0],y:n[1]}}}function x2(t,e,n){const i=[],o=[],r=[],s=[],a=[];t.forEach(d=>{const u=d.map(f=>(mi(a,q.fromGeo(f),e),[Ve(a[0],0,Se),Ve(a[1],0,Se)]));s.push(u),o.length&&r.push(o.length),o.push(...u)});const l=[];for(let d=0;d<o.length;d++)l.push(o[d][0]),l.push(o[d][1]);const c=vw(l,r);for(let d=0;d<c.length;d+=3){const u=[[],[],[],[]];for(let h=0;h<3;h++)u[0][h]=o[c[d+h]][0],u[1][h]=o[c[d+h]][1],u[2][h]=0,u[3][h]=o[c[d+h]][2];s.forEach(h=>{const _=[[],[],[]];h.forEach((p,m)=>{_[0][m]=p[0],_[1][m]=p[1]}),fw(u,_)});const f={type:"polygon",vertices:{x:u[0],y:u[1],cut:u[2]}};i.push(f)}return i}class Au{constructor(e){this.tileLoader=new og("json",e.ignoreMissingTiles),this.options=e,this.url=n=>{const i=this.options.flipY?n:ah(n);return Zc(this.options.url,{x:i[0].toString(),y:i[1].toString(),z:i[2].toString(),subdomain:A3(i)})}}fetchTile(e){return this.tileLoader.fetch(e,this.url).then(n=>n.data?aD(n.data,Ct(e)):{components:[],byId:new Map})}abortTile(e){this.tileLoader.abortRequest(Ge(e))}destroy(){this.tileLoader.destroy()}}const uD=4;class fD{constructor(e,n,i){this.scope=e,this.options=n,this.id=i,this.featureStateMap=new K0,e.sources[i]=this,this.tileData={},this.styleManager=e.styleManager,this.collector=e.collector,this.sourceAttrs=this.options.attributes||{},this.metatile=hw(),this.tileServer="url"in n?new Au(n):new im(n)}fetchTile(e){const n=Ge(e);return this.tileData[n]?Promise.resolve(this.tileData[n]):this.tileServer.fetchTile(e).then(i=>(this.tileData[n]=i,i))}abortTileFetch(e){this.tileServer instanceof Au&&this.tileServer.abortTile(e)}generateTile(e,n,i,o,r,s,a,l){const c=Ge(n),d=this.tileData[c],u=Ct(n),f=[],h=[],_=this.styleManager.getStyle(i),p=new Set(o),{promoteId:m}=this.options,g={},y="generateId"in this.options?this.options.generateId:!1;if(!_)return Promise.resolve({results:f,transferable:h});d&&d.components.forEach((x,I)=>{const{tileProps:E}=this.metatile,L=[],N=[];if(x.tags){const B=Object.keys(x.tags);_c(this.metatile,B);for(const U of B)L[E[U]]=x.tags[U]}const k=Object.keys(this.sourceAttrs);_c(this.metatile,k);const w=Array.from(this.featureStateMap.featureAttrs);_c(this.metatile,w);for(const B of k)L[E[B]]=this.sourceAttrs[B];const S=L[E.db_hidden_by_plan_id];if(S&&e._activeFloorIds.includes(S))return;const A=y?String(x.index+this.id*2**32):m?L[E[m]]:void 0;if(A!==void 0){const B=p.has(A);if(L[E.selected]=B?1:0,d.byId.set(A,I),g[A]=x.index,this.featureStateMap.featureAttrs.size>0){const U=A!==void 0&&this.featureStateMap.get(A);if(U)for(const G of this.featureStateMap.featureAttrs)this.featureStateMap.clearAttrs=!1,N[E[G]]=U[G];else if(this.featureStateMap.clearAttrs===!1){this.featureStateMap.clearAttrs=!0;for(const G in E)N[E[G]]!==void 0&&(N[E[G]]=void 0)}}}const{coords:z}=u,M=z[3],P=s5(r),C=Zo(e,this.sourceAttrs,E,L,N,A,u),D=this.styleManager.getLayers(_.id,E,L).filter(B=>TO(x.type,B.type)&&te(B.filter,C)&&(a?te(a,C):!0));if(D.length===0&&C.id&&this.collector.idIndexer.addOrphanId(C.id),L[E.db_geometry_type]=x.type==="line"?"polyline":x.type,(x.type==="point"||x.type==="line")&&(L[E.db_label]===void 0&&(L[E.db_label]=NaN),L[E.db_label2]===void 0&&(L[E.db_label2]=NaN)),x.type==="line"){const B=IO(x);L[E.componentDistanceStart]=0,L[E.componentDistanceEnd]=B,L[E.objectLength]=B,typeof L[E.beginningIsCut]!="number"&&(L[E.beginningIsCut]=0),typeof L[E.endingIsCut]!="number"&&(L[E.endingIsCut]=0)}T5(this.collector,_,D,C,this.metatile,uD,M,this.id,u,P,x.vertices,void 0,s,l)});const b=this.collector.getAccumulatedData(),v={regionId:0,metatileHash:W4,collectorOutput:b,styleId:_.id};Object.keys(g).length>0&&(v.idToIndex=g),f.push(v),h.push(...b.transferable),this.scope.debouncedResetCollector(),this.scope.syncNewRasterSets();const T={results:f,transferable:h};return Promise.resolve(T)}getObjectAttributes(e,n){const i=this.tileData[n];if(i){const o=i.byId.get(e);if(o===void 0)return;const r=i.components[o];return r===void 0?void 0:r.tags}}deleteTile(e){delete this.tileData[Ge(e)]}setSourceAttrs(e){this.sourceAttrs=e}destroy(){delete this.scope.sources[this.id],this.tileData={},this.sourceAttrs={},this.tileServer.destroy()}setFeatureStateMap(e){this.featureStateMap=Tb(e)}setData(e){if(typeof e=="string"){if(this.tileServer instanceof Au)return this.tileServer.destroy(),this.options={...this.options,url:e},this.tileServer=new Au(this.options),this.tileData={},Promise.resolve(!0)}else if(this.tileServer instanceof im)return this.tileServer.destroy(),this.options={...this.options,data:e},this.tileServer=new im(this.options),this.tileData={},Promise.resolve(!0);return Promise.resolve(!1)}}function hD(t,e){return{path:e,extensions:t.extensions,extensionsRequired:t.extensionsRequired??[],extensionsUsed:t.extensionsUsed??[],extras:t.extras,accessors:mD(t.accessors),buffers:gD(t.buffers),bufferViews:vD(t.bufferViews),cameras:yD(t.cameras),scene:t.scene??0,scenes:xD(t.scenes),nodes:SD(t.nodes),materials:wD(t.materials),meshes:bD(t.meshes),asset:_D(t.asset),animations:pD(t.animations),images:MD(t.images),textures:TD(t.textures),samplers:ID(t.samplers),skins:ED(t.skins)}}function _D(t){return{copyright:t.copyright,generator:t.generator,version:t.version,minVersion:t.minVersion}}function mD(t=[]){return t.map(e=>({bufferView:e.bufferView,byteOffset:e.byteOffset??0,componentType:e.componentType,normalized:e.normalized,count:e.count,type:e.type,max:e.max,min:e.min,sparse:e.sparse,name:e.name,extensions:e.extensions,extras:e.extras}))}function pD(t=[]){return t.map(e=>({channels:e.channels,samplers:e.samplers,name:e.name,extensions:e.extensions,extras:e.extras}))}function gD(t=[]){return t.map(e=>({uri:e.uri,byteLength:e.byteLength,name:e.name,extensions:e.extensions,extras:e.extras,buffer:void 0}))}function vD(t=[]){return t.map(e=>({buffer:e.buffer,byteOffset:e.byteOffset,byteLength:e.byteLength,byteStride:e.byteStride,target:e.target,name:e.name,extensions:e.extensions,extras:e.extras}))}function yD(t=[]){return t.map(e=>({type:e.type,orthographic:e.orthographic,perspective:e.perspective,name:e.name,extensions:e.extensions,extras:e.extras}))}function bD(t=[]){return t.map(e=>({primitives:e.primitives,name:e.name,weights:e.weights,extensions:e.extensions,extras:e.extras}))}function wD(t=[]){return t.map(e=>({alphaCutoff:e.alphaCutoff,alphaMode:e.alphaMode,doubleSided:e.doubleSided,emissiveFactor:e.emissiveFactor,emissiveTexture:e.emissiveTexture,normalTexture:e.normalTexture,occlusionTexture:e.occlusionTexture,pbrMetallicRoughness:e.pbrMetallicRoughness,name:e.name,extras:e.extras,extensions:e.extensions}))}function xD(t=[]){return t.map(e=>({nodes:e.nodes,extensions:e.extensions,extras:e.extras,name:e.name}))}function SD(t=[]){return t.map(e=>{const n=e.rotation??[0,0,0,1],i=e.scale??[1,1,1],o=e.translation??[0,0,0];return{camera:e.camera,children:e.children,matrix:e.matrix?Ux(...e.matrix):void 0,rotation:Cx(...n),scale:yt(...i),translation:yt(...o),name:e.name,mesh:e.mesh,skin:e.skin,extras:e.extras,extensions:e.extensions}})}function MD(t=[]){return t.map(e=>({bufferView:e.bufferView,mimeType:e.mimeType,name:e.name,uri:e.uri,extensions:e.extensions,extras:e.extras,image:void 0}))}function TD(t=[]){return t.map(e=>({extensions:e.extensions,extras:e.extras,name:e.name,sampler:e.sampler,source:e.source}))}function ID(t=[]){return t.map(e=>({extensions:e.extensions,extras:e.extras,name:e.name,magFilter:e.magFilter,minFilter:e.minFilter,wrapS:e.wrapS,wrapT:e.wrapT}))}function ED(t=[]){return t.map(e=>({joints:e.joints,extensions:e.extensions,extras:e.extras,inverseBindMatrices:e.inverseBindMatrices,name:e.name,skeleton:e.skeleton}))}const Oc={JPEG:"image/jpeg",PNG:"image/png",GLTEXTURE:"image/texture"};function Sw(t){return t.substring(0,t.lastIndexOf("/")+1)}function AD(t){if(t.startsWith("data:image"))return t.split(";")[0].split(":")[1];switch(t.substring(t.lastIndexOf("."))){case".png":return Oc.PNG;case".jpg":case".jpeg":default:return Oc.JPEG}}function Mw(t){const e=atob(t.split(",")[1]),n=new ArrayBuffer(e.length),i=new Uint8Array(n);for(let o=0;o<e.length;o++)i[o]=e.charCodeAt(o);return n}const Zt=class Zt{constructor(e){this.data=e}static isGlb(e){const n=new Uint32Array(e,0,Zt.glbHeaderInts),i=n[0],o=n[1];return i===this.glbMagic&&o===this.glbVersion}extractGlbData(){if(this.getCheckedGlbInfo()===void 0)return{json:Dp,buffers:[]};let n;const i=[],o=this.getAllChunkInfos();for(const r of o)r.type===Zt.jsonChunkType&&!n?n=this.getJsonFromChunk(r):r.type===Zt.binaryChunkType&&i.push(this.getBufferFromChunk(r));return{json:n||Dp,buffers:i}}getCheckedGlbInfo(){const e=new Uint32Array(this.data,0,Zt.glbHeaderInts),n=e[0],i=e[1],o=e[2];if(!(!this.checkEquality(n,Zt.glbMagic,"glb magic")||!this.checkEquality(i,Zt.glbVersion,"glb header version")||!this.checkEquality(o,this.data.byteLength,"glb byte length")))return{magic:n,version:i,length:o}}getAllChunkInfos(){const e=[];let n=Zt.glbHeaderInts*4;for(;n<this.data.byteLength;){const i=this.getChunkInfo(n);e.push(i),n+=i.length+Zt.glbChunkHeaderInts*4}return e}getChunkInfo(e){const n=new Uint32Array(this.data,e,Zt.glbChunkHeaderInts),i=e+Zt.glbChunkHeaderInts*4,o=n[0],r=n[1];return{start:i,length:o,type:r}}getJsonFromChunk(e){const n=e.length,i=(Zt.glbHeaderInts+Zt.glbChunkHeaderInts)*4,o=new Uint8Array(this.data,i,n),r=new TextDecoder("utf-8").decode(o);return JSON.parse(r)}getBufferFromChunk(e){return this.data.slice(e.start,e.start+e.length)}checkEquality(e,n,i){return e===n?!0:(console.error(`[GLB MODEL PARSING ERROR] Found invalid/unsupported ${i}, expected: ${n}, but was: ${e}`),!1)}};Zt.glbHeaderInts=3,Zt.glbChunkHeaderInts=2,Zt.glbMagic=1179937895,Zt.glbVersion=2,Zt.jsonChunkType=1313821514,Zt.binaryChunkType=5130562;let Df=Zt;const Tw=5120,CD=5121,PD=5122,LD=5123,FD=5124,Iw=5125,kD=5126,RD=4;let Op;function zD(t){Op=OD(t).then(e=>e).catch(e=>{const n="Draco decoder module failed to initialize"+(e!=null&&e.message?` with the following error: ${e.message}`:".");throw new Error(n)})}async function BD(t){let e=await fetch(t).then(o=>o.text());const i=e.indexOf("if (typeof exports === 'object' && typeof module === 'object')");return i!==0&&(e=e.slice(0,i),e=e+"return DracoDecoderModule;"),e}async function OD(t){const e=await BD(t);return new Function(e)()()}function DD(t){switch(t){case Tw:return"Int8Array";case CD:return"Uint8Array";case PD:return"Int16Array";case LD:return"Uint16Array";case FD:return"Int32Array";case Iw:return"Uint32Array";case kD:return"Float32Array";default:return"Float32Array"}}function ND(t,e,n,i,o,r){const s=o.num_components(),l=n.num_points()*s;let c,d,u;switch(r){case"Float32Array":u=l*4,c=t._malloc(u),e.GetAttributeDataArrayForAllPoints(n,o,t.DT_FLOAT32,u,c),d=new Float32Array(t.HEAPF32.buffer,c,l).slice(),t._free(c);break;case"Int8Array":c=t._malloc(l),e.GetAttributeDataArrayForAllPoints(n,o,t.DT_INT8,l,c),d=new Int8Array(t.HEAP8.buffer,c,l).slice(),t._free(c);break;case"Int16Array":u=l*2,c=t._malloc(u),e.GetAttributeDataArrayForAllPoints(n,o,t.DT_INT16,u,c),d=new Int16Array(t.HEAP16.buffer,c,l).slice(),t._free(c);break;case"Int32Array":u=l*4,c=t._malloc(u),e.GetAttributeDataArrayForAllPoints(n,o,t.DT_INT32,u,c),d=new Int32Array(t.HEAP32.buffer,c,l).slice(),t._free(c);break;case"Uint8Array":c=t._malloc(l),e.GetAttributeDataArrayForAllPoints(n,o,t.DT_UINT8,l,c),d=new Uint8Array(t.HEAPU8.buffer,c,l).slice(),t._free(c);break;case"Uint16Array":u=l*2,c=t._malloc(u),e.GetAttributeDataArrayForAllPoints(n,o,t.DT_UINT16,u,c),d=new Uint16Array(t.HEAPU16.buffer,c,l).slice(),t._free(c);break;case"Uint32Array":u=l*4,c=t._malloc(u),e.GetAttributeDataArrayForAllPoints(n,o,t.DT_UINT32,u,c),d=new Uint32Array(t.HEAPU32.buffer,c,l).slice(),t._free(c);break;default:throw new Error("DRACOLoader: Unexpected attribute type.")}return{name:i,array:d,itemSize:s,componentType:r}}function UD(t,e,n,i,o,r){let s,a;const l=e.GetEncodedGeometryType(n);if(l===t.TRIANGULAR_MESH)s=new t.Mesh,a=e.DecodeBufferToMesh(n,s);else throw new Error("DRACOLoader: Unexpected geometry type.");if(!a.ok()||s.ptr===0)throw new Error("DRACOLoader: Decoding failed: "+a.error_msg());const c={index:null,attributes:{}},d=s.num_points();for(const u in i){let f=Tw,h;for(const[m,g]of Object.entries(r))if(m===u){f=o.accessors[g].componentType,h=o.accessors[g].count;break}if(d!==h)throw new Error(`DRACOLoader: Accessor vertex count ${h} does not match draco decoder vertex count  ${d}`);f=DD(f);const _=e.GetAttributeByUniqueId(s,i[u]),p=ND(t,e,s,u,_,f);c.attributes[p.name]=p}if(l===t.TRIANGULAR_MESH){const f=s.num_faces()*3,h=f*4,_=t._malloc(h);e.GetTrianglesUInt32Array(s,h,_);const p=new Uint32Array(t.HEAPU32.buffer,_,f).slice();t._free(_),c.index={array:p,itemSize:1}}return t.destroy(s),c}function GD(t,e,n,i){const o=t.bufferView,r=e.bufferViews[o],s=e.buffers[r.buffer],l=new Int8Array(s.buffer).slice(r.byteOffset,r.byteOffset+r.byteLength),c=new n.Decoder,d=new n.DecoderBuffer;d.Init(l,r.byteLength);const u=UD(n,c,d,t.attributes,e,i);return n.destroy(d),u}function Io(t,e,n,i,o){const r={buffer:t,byteLength:t.byteLength,extensions:void 0,extras:void 0,name:void 0,uri:void 0};e.buffers.push(r);const s={buffer:e.buffers.length-1,byteLength:t.byteLength,byteOffset:0,byteStride:0,extensions:void 0,extras:void 0,name:o,target:i};e.bufferViews.push(s),e.accessors[n].byteOffset=0,e.accessors[n].bufferView=e.bufferViews.length-1}function sr(t,e){let n;switch(e){case"Int8Array":n=new ArrayBuffer(t.length),new Int8Array(n).set(t);break;case"Uint8Array":n=new ArrayBuffer(t.length),new Uint8Array(n).set(t);break;case"Int16Array":n=new ArrayBuffer(t.length*2),new Int16Array(n).set(t);break;case"Uint16Array":n=new ArrayBuffer(t.length*2),new Uint16Array(n).set(t);break;case"Int32Array":n=new ArrayBuffer(t.length*4),new Int32Array(n).set(t);break;case"Uint32Array":n=new ArrayBuffer(t.length*4),new Uint32Array(n).set(t);break;default:case"Float32Array":n=new ArrayBuffer(t.length*4),new Float32Array(n).set(t);break}return n}function HD(t,e,n,i){const o=e.index.array;if(i!==void 0&&(Io(o,t,i,34963,"index buffer view"),t.accessors[i].componentType=Iw),e.attributes.POSITION!==void 0){const r=sr(e.attributes.POSITION.array,e.attributes.POSITION.componentType);Io(r,t,n.POSITION,34962,"position buffer view")}if(e.attributes.NORMAL!==void 0){const r=sr(e.attributes.NORMAL.array,e.attributes.NORMAL.componentType);Io(r,t,n.NORMAL,34962,"normal buffer view")}for(let r=0;r<RD;++r){const s=`TEXCOORD_${r}`;if(e.attributes[s]!==void 0){const a=sr(e.attributes[s].array,e.attributes[s].componentType);Io(a,t,n[s],34962,`${s} buffer view`)}}if(e.attributes.TANGENT!==void 0){const r=sr(e.attributes.TANGENT.array,e.attributes.TANGENT.componentType);Io(r,t,n.TANGENT,34962,"Tangent buffer view")}if(e.attributes.COLOR_0!==void 0){const r=sr(e.attributes.COLOR_0.array,e.attributes.COLOR_0.componentType);Io(r,t,n.COLOR_0,34962,"color buffer view")}if(e.attributes.JOINTS_0!==void 0){const r=sr(e.attributes.JOINTS_0.array,e.attributes.JOINTS_0.componentType);Io(r,t,n.JOINTS_0,34963,"JOINTS_0 buffer view")}if(e.attributes.WEIGHTS_0!==void 0){const r=sr(e.attributes.WEIGHTS_0.array,e.attributes.WEIGHTS_0.componentType);Io(r,t,n.WEIGHTS_0,34963,"WEIGHTS_0 buffer view")}if(e.attributes.JOINTS_1!==void 0){const r=sr(e.attributes.JOINTS_1.array,e.attributes.JOINTS_1.componentType);Io(r,t,n.JOINTS_1,34963,"JOINTS_1 buffer view")}if(e.attributes.WEIGHTS_1!==void 0){const r=sr(e.attributes.WEIGHTS_1.array,e.attributes.WEIGHTS_1.componentType);Io(r,t,n.WEIGHTS_1,34963,"WEIGHTS_1 buffer view")}}async function VD(t,e){var n;if(!Array.isArray(t.meshes))return Promise.resolve();for(const i of t.meshes)if(Array.isArray(i.primitives))for(const o of i.primitives){if(((n=o.extensions)==null?void 0:n.KHR_draco_mesh_compression)===void 0)continue;Op||zD(e);const r=await Op;if(!r)continue;const s=GD(o.extensions.KHR_draco_mesh_compression,t,r,o.attributes);HD(t,s,o.attributes,o.indices)}}async function vg(t){const e=await self.fetch(t);if(!e.ok)throw new Error(`${e.status} ${e.statusText}: ${e.url}`);return e}const Dp={asset:{version:""}};async function jD(t,e){if(e){t.buffers[0].buffer=e[0]||[];return}await Promise.all(t.buffers.map(async n=>{if(n.buffer){console.error("Buffer is already loaded");return}if(!n.uri){console.error("Buffer can not be loaded. No uri");return}if(n.uri.startsWith("data:"))n.buffer=Mw(n.uri);else{const i=Vr(n.uri)?n.uri:Sw(t.path)+n.uri,o=await vg(i).then(r=>r.arrayBuffer());n.buffer=o}}))}async function $D(t,e,n){if(!e.bufferView)return!1;const i=t.bufferViews[e.bufferView];if(i===void 0)return!1;await n;const o=t.buffers[i.buffer].buffer;if(!o)return!1;const r=new Uint8Array(o,i.byteOffset,i.byteLength);if(typeof createImageBitmap<"u")if(YD(r)){const s=new Blob([r],{type:e.mimeType});e.image=await createImageBitmap(s)}else return console.error(`Unsupported image type ${e.mimeType??""}`),!1;else return!1;return!0}async function WD(t,e){if(e.uri===void 0)return!1;const n=e.mimeType||AD(e.uri);if(e.mimeType=n,typeof createImageBitmap<"u"&&(n===Oc.JPEG||n===Oc.PNG))if(e.uri.startsWith("data:image")){const i=Mw(e.uri);e.image=await createImageBitmap(new Blob([i],{type:n}))}else{const i=Vr(e.uri)?e.uri:`${Sw(t.path)}${e.uri}`,r=await(await vg(i)).arrayBuffer();e.image=await createImageBitmap(new Blob([r],{type:n}))}else return console.error(`Unsupported image type ${n}`),!1;return!0}async function ZD(t,e){await Promise.all(t.images.map(async n=>{if(n.image){n.mimeType!==Oc.GLTEXTURE&&console.error("Image has already been loaded");return}await $D(t,n,e)||await WD(t,n)||console.error(`Was not able to resolve image with uri ${n.uri}`)}))}async function XD(t,e){const n=b6(t,self.origin);try{const i=await vg(n);let o=Dp,r;try{const s=await i.arrayBuffer();if(Df.isGlb(s)){const f=new Df(s).extractGlbData();o=f.json,r=f.buffers}else{const u=new TextDecoder("utf-8"),f=new Uint8Array(s);o=JSON.parse(u.decode(f))}const a=hD(o,n),l=jD(a,r),c=ZD(a,l),d=VD(a,e);return await Promise.all([l,c,d]),{type:"ok",result:a}}catch(s){return{type:"error",layer:"parsing",originalError:s}}}catch(i){return{type:"error",layer:"network",originalError:i}}}function YD(t){const e=t[0]===137&&t[1]===80&&t[2]===78&&t[3]===71&&t[4]===13&&t[5]===10&&t[6]===26&&t[7]===10,n=t[0]===255&&t[1]===216&&t[2]===255;return e||n}class qD{async loadModel(e,n){return await XD(e,n)}}function KD(t){return new Worker("/assets/index-u9DjJkrT.js",{name:t==null?void 0:t.name})}function JD(t){return new Worker("/assets/index-kCfosY-K.js",{name:t==null?void 0:t.name})}function QD(t){return new Worker("/assets/index-Bi9Dq8mW.js",{name:t==null?void 0:t.name})}function eN(t,e){return{setMetatile:t.get(Ue.Parser,"setMetatile"),getMemoryFootprint:t.get(Ue.Parser,"getMemoryFootprint"),prepareAtlas:t.get(Ue.Parser,"prepareAtlas"),packRasters:t.get(Ue.Parser,"packRasters"),fetchTrafficTile:t.get(Ue.Parser,"fetchTrafficTile"),deleteTrafficTile:t.get(Ue.Parser,"deleteTrafficTile"),abortTrafficTileRequest:t.get(Ue.Parser,"abortTrafficTileRequest"),generateTrafficTile:t.get(Ue.Parser,"generateTrafficTile"),generatePersonalPoi:t.get(Ue.Parser,"generatePersonalPoi"),syncStyle:t.get(Ue.Parser,"syncStyle"),GeoJsonSource:e.set("GeoJsonSource",fD).get(Ue.Parser),ZenithSource:e.set("ZenithWorker",EC).get(Ue.Parser)}}function tN(t){return{setCommercialPoiRandomSeed:t.get(Ue.Labeling,"setComPoiRandomSeed"),getMemoryFootprint:t.get(Ue.Labeling,"getMemoryFootprint"),appendFont:t.get(Ue.Labeling,"appendFont"),markFontAsLoaded:t.get(Ue.Labeling,"markFontAsLoaded"),addNewRasterSets:t.get(Ue.Labeling,"addNewRasterSets"),updatePackingInfo:t.get(Ue.Labeling,"updatePackingInfo"),syncStyle:t.get(Ue.Labeling,"syncStyle"),loadRtlPlugin:t.get(Ue.Labeling,"loadRtlPlugin"),markRtlPluginLoaded:t.get(Ue.Labeling,"markRtlPluginLoaded")}}function nN(t){return{ModelsSource:t.set("ModelsWorker",qD).get(Ue.Models)}}class iN{constructor(){this.connector=new BO,this.fnRegistry=new OO(this.connector),this.classRegistry=new DO(this.fnRegistry),this.parserWorker=new KD,this.connector.addWorker(Ue.Parser,this.parserWorker),this.labelingWorker=new JD,this.connector.addWorker(Ue.Labeling,this.labelingWorker),this.modelsWorker=new QD,this.connector.addWorker(Ue.Models,this.modelsWorker),this.parser=eN(this.fnRegistry,this.classRegistry),this.labeling=tN(this.fnRegistry),this.models=nN(this.classRegistry)}syncStyle(e){this.parser.syncStyle(e),this.labeling.syncStyle(e)}destroy(){this.parserWorker.terminate(),this.labelingWorker.terminate(),this.modelsWorker.terminate()}}var Ps;let yg=(Ps=class extends pl{constructor(e,n){super(),this.fogFactorBreakpoint=.4,this.demElevation=0,this.demTilesRevision=NaN,this.options=ts(n,Ps.options),this.uniqId=String(mo()),this.labelKey=`html-${this.uniqId}`;const i=q.fromGeo(this.options.coordinates);this.position={userValue:i,normalizedValue:$r(i)},this.screenPoint=[0,0],this.html=oN(this.options),this.isHidden=!0,this.targetOpacity=0,this.modules=e.modules,this.modules.layers.addLayer(this),this.mapState=e.state,this.rounder=rN(!this.options.disableRounding);let{offset:o}=this.options;const{labeling:r}=this.options;r.type!=="none"&&(r.offset!==void 0&&(o=r.offset),this.modules.labeler.addLabelBox(this.labelKey,{id:this.uniqId,width:r.width,height:r.height,position:this.position.normalizedValue,offset:o,labelingGroup:this.getLabelingGroup(),parentPoiId:r.type==="pinnedToPoi"?r.poiId:void 0}))}destroy(){this.removeHtml(),this.modules.labeler.removeLabels(this.labelKey),this.modules.layers.removeLayer(this)}update(){const e=this.checkZoom(),n=this.checkFog(),i=!this.isInvolvedInLabeling()||this.modules.labeler.isLabelBoxSurvived(this.uniqId);e&&n&&i?this.show():this.hide(),this.updatePosition()}setZIndex(e){this.options.zIndex=e,this.html.style.zIndex=String(e)}setContent(e){this.options.html=e,this.html.innerHTML="";const n=document.createElement("div");typeof e=="string"?n.innerHTML=e:n.append(e),this.html.append(n)}setLabelingSize(e,n){this.options.labeling.type!=="none"&&(this.options.labeling.width=e,this.options.labeling.height=n,this.updateLabelBox())}setPosition(e){const n=q.fromGeo(e);this.position={userValue:n,normalizedValue:$r(n)},this.updateLabelBox()}setOffset(e){this.options.offset=[e[0],e[1]],this.updateLabelBox()}setMinZoom(e){this.options.minZoom=e}setMaxZoom(e){this.options.maxZoom=e}getZIndex(){return this.options.zIndex}getOffset(){return this.options.offset}getPosition(){return q.toGeo(this.position.userValue)}getHtmlElement(){return this.html.firstChild}dangerouslyGetRootElement(){return this.html}isShown(){return!this.isHidden}show(){if(this.isHidden&&(this.isHidden=!1,this.appendHtml(),this.emit("shown",{id:this.uniqId.toString(),point:[this.screenPoint[0],this.screenPoint[1]],object:this}),this.options.animate)){if(this.showAnimationTimer)return;this.hideAnimationTimer&&(clearTimeout(this.hideAnimationTimer),this.hideAnimationTimer=void 0),this.targetOpacity!==1&&(this.showAnimationTimer=window.setTimeout(()=>{this.setHtmlOpacity(1),this.showAnimationTimer=void 0},0))}}hide(){if(!this.isHidden)if(this.isHidden=!0,this.options.animate){if(this.hideAnimationTimer)return;this.showAnimationTimer&&(clearTimeout(this.showAnimationTimer),this.showAnimationTimer=void 0),this.setHtmlOpacity(0),this.hideAnimationTimer=window.setTimeout(()=>{this.removeHtml(),this.hideAnimationTimer=void 0},this.options.duration)}else this.removeHtml()}setHtmlOpacity(e){this.html.style.opacity=String(e),this.targetOpacity=e}removeHtml(){this.html.remove(),this.screenPoint=[0,0]}appendHtml(){this.getMarkerContainer().appendChild(this.html)}getMarkerContainer(){return this.options.preventMapInteractions?this.modules.layout.htmlContainerOutMap:this.modules.layout.htmlContainerInMap}nearCenterScreenPosition(){const e=this.modules.demManager,n=this.mapState;let i=0;if(n.demMode){const a=e.getTilesRevision();this.demTilesRevision!==a&&(this.demElevation=e.getElevation(this.position.normalizedValue)??0,this.demTilesRevision=a),i=(this.demElevation-(n.elevation??0))*n.elevationScale}const o=this.mapState.visibleMapReplicas.map(a=>{const l=[this.position.normalizedValue[0]+et*a,this.position.normalizedValue[1],this.position.normalizedValue[2]+i*He];return q.toGeo(l,l),this.modules.camera.project(l,!0)}),r=o.map(a=>Math.abs(this.mapState.size[0]/2-(isNaN(a[0])?-1/0:a[0]))),s=r.findIndex(a=>a===Math.min(...r));return o[s]}updatePosition(){const e=this.nearCenterScreenPosition();this.html.hidden=Number.isNaN(e[0]),this.rounder(e,e[0]+this.options.offset[0],e[1]+this.options.offset[1],this.mapState.stillness),this.mapState.globeMode&&(this.html.hidden=!this.modules.camera.ecef.canSee(this.getPosition())),yx(this.screenPoint,e)||(this.html.style.transform=`translate3d(${e[0]}px, ${e[1]}px, 0px)`,this.screenPoint=e)}updateLabelBox(){if(this.options.labeling.type==="none")return;const{labeling:{width:e,height:n},offset:i}=this.options;this.modules.labeler.removeLabels(this.labelKey),this.modules.labeler.addLabelBox(this.labelKey,{id:this.uniqId,width:e,height:n,position:this.position.normalizedValue,offset:i,labelingGroup:this.getLabelingGroup(),parentPoiId:this.options.labeling.type==="pinnedToPoi"?this.options.labeling.poiId:void 0})}getLabelingGroup(){return this.isInvolvedInLabeling()?"markerText":"htmlLabel"}checkZoom(){const{zoom:e}=this.mapState,{minZoom:n,maxZoom:i}=this.options;return e>=n&&e<i}checkFog(){if(!this.modules.environmentManager.isFogEnabled()||this.mapState.globeMode)return!0;const{fogLimits:e}=this.modules.environmentManager,{fogDistance:n,position:i}=this.modules.camera,o=(this.position.normalizedValue[0]-i[0])/n,r=(this.position.normalizedValue[1]-i[1])/n,s=Math.sqrt(o**2+r**2),a=e[1]-e[0];return Ve((s-e[0])/a,0,1)<this.fogFactorBreakpoint}isInvolvedInLabeling(){return this.options.labeling.type==="full"||this.options.labeling.type==="pinnedToPoi"}},Ps.options={coordinates:[0,0],html:"",offset:[0,0],animate:!0,duration:500,labeling:{type:"none"},interactive:!0,preventMapInteractions:!1,zIndex:0,minZoom:-1/0,maxZoom:1/0,disableRounding:!1},Ps);function oN(t){const e=document.createElement("div");e.style.position="absolute",e.style.top="0",e.style.left="0",e.style.zIndex=String(t.zIndex),t.interactive||(e.style.pointerEvents="none"),t.animate&&(e.style.opacity="0",e.style.transition=`opacity ${t.duration}ms`,e.style.willChange="opacity");const n=document.createElement("div");return typeof t.html=="string"?n.innerHTML=t.html:n.append(t.html),e.append(n),e}function rN(t){return t?sN:aN}const sN=(t,e,n,i)=>{const o=Math.round(e),r=Math.round(n),s=o-e,a=r-n;t[0]=e+i*s,t[1]=n+i*a},aN=(t,e,n)=>{t[0]=e,t[1]=n},lN="#0085a0",cN="#ffffff",dN=4,uN=1,fN=2,hN=1.5,_N=2.8,S2=6,mN=!0,pN=17.1,om=nc.iterationCount,rm=Ke();class gN extends Kc{constructor(e,n){super(e,{interactive:!1}),this.options=n,this.vectors=this.options.coordinates.map(p=>p.map(m=>q.fromGeo(m))),this.bouncePosition=0,this.growPosition=1;const{tileManager:i,dynamicStyle:o,collector:r,layers:s}=this.modules,a=this.options.animate??mN;let l;if(a){const p=this.options.iterationCount??om;p>1?l={type:"repeat",tipMovementAmplitude:this.options.tipMovementAmplitude||S2,iterationCount:p}:p===1&&(l={type:"appearance",tipMovementAmplitude:this.options.tipMovementAmplitude||S2})}const c=qi({type:"arrow",id:`dynamic-entrance-${this.uniqId}`,minzoom:this.options.minZoom??pN,maxzoom:this.options.maxZoom,style:{color:this.options.color??lN,strokeColor:this.options.borderColor??cN,lineWidth:this.options.width??dN,strokeWidth:this.options.borderWidth??uN,tipWidth:this.options.wingWidthMultiplier??hN,tipHeight:this.options.tipHeightMultiplier??_N,roundingRadius:this.options.roundingRadius??fN,animation:l}});if(!c)return;o.addLayer(c,this.options.zIndex),this.layerId=c.innerId;const d=this.getTileInfo(),u=[],f=Zo(this.mapState.styleState,ul,Ho,u,Wc);vr(c,f);for(let p=0;p<this.vectors.length;p++){const m=this.vectors[p],g=this.getVertices(m,d);f.id=String(p),io({collector:r,generator:Lc.generate,args:[o.getStyle().id,c,f,g]})}const h=r.getAccumulatedData(),_=new bi("dynamicObject",h.data,this.modules,this.mapState,d.coords,this);this.tileObjects.push(_),i.addObject(_),this.identifyIds.push(h.identifyIds),a?(this.bounceTickerId=`entrance-bounce-${this.uniqId}`,this.growTickerId=`entrance-grow-${this.uniqId}`,this.bounceTickerUpdate=xt.bind(null,this.bounceTickerId,{step:(p,m)=>this.bouncePosition=m,complete:()=>{this.bounceTickerUpdate=void 0}},this.mapState),this.growTickerUpdate=xt.bind(null,this.growTickerId,{step:(p,m)=>this.growPosition=m,complete:()=>{this.growTickerUpdate=void 0}},this.mapState),At(this.bounceTickerId,{easing:nc.bounceType},this.mapState,-1,0,nc.bounceTime,this.options.iterationCount??om,{layerId:this.layerId,styleId:o.getStyle().id}),At(this.growTickerId,{easing:nc.growType},this.mapState,0,1,nc.growTime,this.options.iterationCount??om,{layerId:this.layerId,styleId:o.getStyle().id})):(this.bouncePosition=0,this.growPosition=1),s.addLayer(this),r.reset(),this.modules.renderer.addRerenderEvent()}update(){super.update(),this.bounceTickerUpdate&&this.bounceTickerUpdate(),this.growTickerUpdate&&this.growTickerUpdate()}isOutOfMainReplica(){return!1}entranceAnimationInProgress(){return this.bounceTickerUpdate!==void 0||this.growTickerUpdate!==void 0}remove(){this.layerId!==void 0&&this.modules.dynamicStyle.removeLayer(this.layerId),this.destroy()}destroy(){this.bounceTickerUpdate=void 0,this.growTickerUpdate=void 0,this.bounceTickerId&&It(this.bounceTickerId,this.mapState),this.growTickerId&&It(this.growTickerId,this.mapState),super.destroy()}getTileInfo(){const e=es();for(let n=0;n<this.vectors.length;n++){const i=this.vectors[n];for(let o=0;o<i.length;o++)kr(e,i[o])}return Ct(O3(e))}getVertices(e,n){const i=[],o=[];for(let r=0;r<e.length;r++)mi(rm,e[r],n),i[r]=rm[0],o[r]=rm[1];return{x:i,y:o}}}class vN{constructor(e){this.layers=[],this.renderer=e.renderer}addLayer(e){this.layers.push(e),this.renderer.addRerenderEvent()}removeLayer(e){const n=this.layers.indexOf(e);n!==-1&&(this.layers.splice(n,1),this.renderer.addRerenderEvent())}getLayers(){return this.layers}getDynamicObjectLayers(){return this.layers.filter(e=>e instanceof Kc)}getHtmlMarkers(){return this.layers.filter(e=>e instanceof yg)}entranceAnimationFinished(){return this.layers.every(e=>e instanceof gN?!e.entranceAnimationInProgress():!0)}}const M2=()=>"",yN=[.5,.5];class bN{constructor(e){this.loadingCounter=0,this.isIdle=()=>this.loadingCounter===0,this.modules=e,this.cache={}}async getRasterSet(e,n,i,o){const r=this.getKey(e,i,o),s=this.getFromCache(r,n);if(s)return s;const a=await this.loadIcon(e,n,i,o);return a&&this.storeInCache(a,r,n),a}decreaseLoadingCounter(){this.loadingCounter=Math.max(this.loadingCounter-1,0)}async loadIcon(e,n,i,o){const{dynamicStyle:r,workers:s,assetManager:a}=this.modules;let l=e;this.loadingCounter++,n&&(l=await this.loadImageForTransformer(e).then(d=>n(d)).catch(()=>e));const c=await this.loadImage(l);return c?Promise.resolve().then(()=>{i=i!==void 0?i:[c.width,c.height];const d=o!==void 0?[o[0]/i[0],o[1]/i[1]]:yN,u=[i[0]*window.devicePixelRatio,i[1]*window.devicePixelRatio],f=y8([{w:u[0],h:u[1],x:0,y:0,atlasIndex:0,isPacked:!1,anchorX:d[0],anchorY:d[1]}]);r.appendRasterSet(f),s.labeling.addNewRasterSets(r.getStyle().id,[f]);const h=new Uint16Array(3);return h[0]=u[0],h[1]=u[1],h[2]=f.index,s.parser.packRasters(h).then(_=>({packedRasters:_.packedRasters,rasterSet:f,scaledSize:u}))}).then(d=>{const{packedRasters:u,rasterSet:f,scaledSize:h}=d;return u!==void 0&&a.prepareRasters(r.getStyle().id,u,[tw(c,h)]),this.decreaseLoadingCounter(),f}):(this.decreaseLoadingCounter(),Promise.resolve(void 0))}getFromCache(e,n){const i=this.cache[e];if(i)return i.get(n||M2)}storeInCache(e,n,i){this.cache[n]||(this.cache[n]=new Map),this.cache[n].set(i||M2,e)}getKey(e,n,i){const o=n!==void 0?`${n[0]},${n[1]}`:"",r=i!==void 0?`${i[0]},${i[1]}`:"";return`${e}_${o}_${r}`}loadImage(e){return new Promise(n=>{const i=new Image;i.crossOrigin="Anonymous",i.src=e,i.onload=()=>n(i),i.onerror=()=>n(void 0)})}loadImageForTransformer(e){return e.indexOf(".svg")===-1?new Promise(n=>{const i=new Image;i.crossOrigin="Anonymous",i.src=e,i.onload=()=>{n({type:"raster",source:i})},i.onerror=()=>{n({type:"unknown"})}}):new Promise(n=>{const i=new XMLHttpRequest;i.open("GET",e,!0),i.onload=function(){if(i.status!==200||i.response.byteLength===0){n({type:"unknown"});return}n({type:"vector",source:i.response})},i.onerror=function(){n({type:"unknown"})},i.send()})}}const Ew={trafficOn:!1,parkingOn:!1,navigatorOn:!1,immersiveRoadsOn:!1,_floorStackOn:!1,terrainEnabled:!1,graphicsPreset:Hb()?"light":"immersive",_activeFloorIds:[],_activeFloorBuildingIds:[],_activeFloorIsMetro:!1,_floorHeight:3.5,_customUserTimeOffset:0};function wN(){return{...Ew}}function xN(t,e){return t={...t},{...Ew,...t}}function T2(t,e=[],n=[],i=!1){return{...t,_activeFloorIds:e,_activeFloorBuildingIds:n,_activeFloorIsMetro:i}}const sm="floorStackTicker";class SN{constructor(e,n){this.floorLevelOffsets=new Map,this.activeFloorIds=new Set,this.activeDescriptors=[],this.stackAnimationReadiness=0,this.activeGroup="default",this.state=e,this.modules=n,this.complexDescriptors={default:new Map,metro:new Map},this.allowedFloors=new Set,this.floorIdsToObjectIds=new Map,this.requestedFloors=new Set,this.failedRequestedFloors=new Set,this.needUpdate=!1,this.ids=n.identifier.getIdScope(Yo),this.floorIds=n.identifier.getIdScope(tp),this.hiddenObjectIds=new Set,this.stateDiffer=new Kt([{path:"center",type:"vec2"},{path:"zoom",type:"number"},{path:"size",type:"vec2"},{path:"rotation",type:"number"},{path:"pitch",type:"number"},{path:"padding",type:"padding"},{path:"demMode",type:"boolean"},{path:"floorsEnabled",type:"boolean"}])}get maxFloorOffset(){const e=this.state.styleState._floorHeight??0;return Math.floor(Ma.maxStackHeight/e)}get floorHeight(){const e=this.state.styleState._floorHeight??0,n=q.toGeo(this.state.center);return e*He*q.scaleFactor(n[1])}get isStackEnabled(){return this.state.styleState._floorStackOn&&this.activeGroup==="default"&&this.floorHeight>0}update(){if(this.stateDiffer.check(this.state)||this.needUpdate){this.needUpdate=!1;const e=this.findActiveFloor();if(!Lm(e,this.activeFloorIds)){for(const n of this.activeFloorIds.values())this.modules.map.emit("floorcomplexhide",{id:n});this.activeFloorIds.clear(),this.activeDescriptors=[];for(const n of e.values()){const i=this.complexDescriptors[this.activeGroup].get(n);if(i&&this.state.floorsEnabled){const{id:o,defaultFloor:r,floors:s}=i;this.setFloorIdx(r),this.activeDescriptors.push(i),this.modules.map.emit("floorcomplexshow",{id:o,currentFloor:r,floorNames:s.map(({name:a})=>a),firmsToFloorIndexMap:i.firmsToFloorIndexMap})}this.activeFloorIds.add(n)}this.floorLevelOffsets.clear(),this.activeDescriptors.forEach(n=>{n.floors.forEach((i,o)=>{const r=o-n.defaultFloor;i.ids.forEach(s=>{this.floorLevelOffsets.set(s,r)})})})}}this.updateStyleState(),this.updateHiddenIds(),this.updateReadiness()}getActiveFloorHiddenIds(){return Array.from(this.hiddenObjectIds)}prepareFloors(e,n,i,o){o==="zenith"&&i.forEach((r,s)=>{let a=this.floorIdsToObjectIds.get(s);a===void 0&&(a=new Set,this.floorIdsToObjectIds.set(s,a));for(const l of r)a.add(l);this.loadFloor(s,e,n)})}changeFloorNumber(e,n){const i=this.complexDescriptors[this.activeGroup].get(e);i&&(this.setFloorIdx(n),this.modules.map.emit("floorcomplexlevelchange",{id:e,floorIndex:n,floorName:i.floors[n].name}),this.needUpdate=!0)}hasDisplayedFloorBuilding(e){if(this.activeFloorIds.size===0)return!1;if(e.some(n=>this.activeFloorIds.has(n)))return!0;for(const n of this.activeFloorIds.values()){const i=this.complexDescriptors[this.activeGroup].get(n);for(let o=0;o<i.buildings.length;o++){const r=this.floorIdsToObjectIds.get(i.buildings[o]);if(r&&(Array.isArray(e)&&e.some(s=>r.has(s))||typeof e=="string"&&r.has(e)))return!0}}return!1}floorsReady(){return Array.from(this.requestedFloors).every(e=>this.failedRequestedFloors.has(e)||this.complexDescriptors.default.has(e)||this.complexDescriptors.metro.has(e))}configure(e){this.activeGroup=e.activeGroup,this.allowedFloors=new Set(e.allowedFloorIds??[]),this.needUpdate=!0,this.modules.map.emit("floorsactivegroupchange",this.activeGroup)}isVisibleFloorObject(e){return this.activeDescriptors.length===0?!1:this.state.styleState._activeFloorIds.includes(e)}isVisibleFloorStackObject(e){if(!this.isStackEnabled||this.activeDescriptors.length===0||this.activeFloorIdx===void 0)return!1;const n=this.activeFloorIdx-this.activeDescriptors[0].defaultFloor,i=this.floorLevelOffsets.get(e);return i<this.maxFloorOffset&&n>0&&i>=0&&i<n}getFloorObjectElevation(e){if(!this.isStackEnabled||!this.floorLevelOffsets.has(e))return 0;const n=this.floorLevelOffsets.get(e),i=this.floorHeight*n;return n<=0?0:n>this.maxFloorOffset?this.floorHeight*this.maxFloorOffset:Ra((n-1)/n,1,this.stackAnimationReadiness)*i}getFloorStackObjectElevation(e){return this.floorLevelOffsets.has(e)?this.floorLevelOffsets.get(e)*this.floorHeight:0}getFloorStackObjectHeight(e){return!this.isStackEnabled||this.activeDescriptors[0].floors.findIndex(o=>o.ids.includes(e))<this.activeFloorIdx-1?1:this.stackAnimationReadiness}loadFloor(e,n,i){if(this.requestedFloors.has(e))return;const o=wr("floorMeta",{protocol:this.state.tileProtocol,tileSet:this.state.tileSet,host:this.state.tileServer,subdomain:this.state.subdomains[0],regionId:n.toString(10),floorComplexId:e});this.requestedFloors.add(e),fetch(o).then(r=>(r.ok===!1&&this.failedRequestedFloors.add(e),r.json())).then(r=>{let s=r.default_floor_idx,a="default";"is_metro"in r&&r.is_metro&&(s=r.default_metro_floor_idx,a="metro");const l=r.floors.reduce((c,d,u)=>(c[d.id]=u,c),{});this.complexDescriptors[a].set(e,{id:e,regionId:n,metatileHash:i,center:r.center,bound:r.bound,defaultFloor:s,floors:r.floors.map(c=>({ids:c.linked_floors_ids?[c.id,...c.linked_floors_ids]:[c.id],name:c.name})),buildings:r.linked_buildings_ids?r.linked_buildings_ids.concat(e):[e],firmsToFloorIndexMap:Object.entries(r.firm_id_to_floor_id??{}).reduce((c,[d,u])=>(c[d]=l[u],c),{})}),this.needUpdate=!0}).catch(()=>{this.failedRequestedFloors.add(e)})}updateStyleState(){const{styleState:e}=this.state;if(this.activeFloorIds.size===0){(e._activeFloorIds||e._activeFloorBuildingIds)&&(this.state.styleState=T2(e,[],[],!1));return}const n=new Set,i=new Set;for(const o of this.activeFloorIds.values()){const r=this.complexDescriptors[this.activeGroup].get(o);if(!r||this.activeFloorIdx===void 0)continue;const s=r.floors[this.activeFloorIdx];s&&(s.ids.forEach(a=>{n.add(a)}),r.buildings.forEach(a=>i.add(a)))}this.state.styleState=T2(e,Array.from(n),Array.from(i),this.activeGroup==="metro")}updateHiddenIds(){if(this.activeFloorIds.size===0){this.markHiddenObjectsForUpdate();return}const e=new Set;for(const n of this.activeFloorIds.values()){const i=this.complexDescriptors[this.activeGroup].get(n);if(i&&this.activeFloorIdx!==void 0)for(let o=0;o<i.buildings.length;o++){const r=this.floorIdsToObjectIds.get(i.buildings[o]);r&&r.forEach(s=>e.add(s))}}this.markHiddenObjectsForUpdate(e)}markHiddenObjectsForUpdate(e){if(e){const n=this.ids.getHidden(Qn.PolygonExtrusion),i=r1(e,n),o=r1(this.hiddenObjectIds,e);this.ids.hide(Array.from(i),Qn.PolygonExtrusion);const r=this.floorIds.getHidden(),s=r7(i,r);this.ids.hide(Array.from(s),Qn.All),this.ids.show(Array.from(o)),this.hiddenObjectIds=new Set(e)}else this.ids.show(Array.from(this.hiddenObjectIds)),this.hiddenObjectIds.clear()}updateReadiness(){xt(sm,{step:(e,n)=>this.stackAnimationReadiness=n},this.state)}setFloorIdx(e){this.prevActiveFloorIdx=this.activeFloorIdx,this.activeFloorIdx=e,this.isStackEnabled&&this.prevActiveFloorIdx!==void 0&&this.activeFloorIdx>this.prevActiveFloorIdx?(this.stackAnimationReadiness=0,At(sm,{easing:"easeOutQuint"},this.state,0,1,500,1)):(this.stackAnimationReadiness=1,It(sm,this.state))}findActiveFloor(){const e=new Set;if(!this.state.floorsEnabled||this.state.styleZoom<Ma.displayStyleZoom)return e;const{center:n,zoom:i,rotation:o,size:r,pitch:s,viewport:a,padding:l,cameraConfig:c,globeMode:d}=this.state;if(this.activeGroup==="metro")if(this.allowedFloors.size>0)this.allowedFloors.forEach(p=>e.add(p));else{for(const p of this.complexDescriptors.metro.keys())e.add(p);return e}const f=new dl({center:n,zoom:i,rotation:o,size:[Math.floor(r[0]*(1-Ma.viewportPadding)),Math.floor(r[1]*(1-Ma.viewportPadding))],styleState:{},pitch:s,viewport:a,padding:l,cameraConfig:c,globeMode:d}).getViewportVertices();if(this.allowedFloors.size>0){const p=this.complexDescriptors[this.activeGroup];let m;return this.allowedFloors.forEach(g=>{const y=p.get(g);y&&zs(f,y.bound)&&(m=g)}),m&&e.add(m),e}let h=1/0,_;return this.complexDescriptors.default.forEach(p=>{const m=eo(this.state.center,p.center);m<h&&zs(f,p.bound)&&(h=m,_=p)}),_&&e.add(_.id),e}}class MN{constructor(e,n){this.state=e,this.modules=n,this.tileLayers=[],this.objects=[],this.viewportDiffer=new Kt([{path:"center",type:"vec3"},{path:"zoom",type:"number"},{path:"size",type:"vec2"},{path:"rotation",type:"number"},{path:"pitch",type:"number"},{path:"padding",type:"padding"},{path:"demMode",type:"boolean"},{path:"globeMode",type:"boolean"},{path:"elevation",type:"number"},{path:"minElevation",type:"number"},{path:"handyStyleId",type:"string"}])}getMemoryFootprint(e=()=>!0){const n={tileLayers:this.tileLayers.filter(e).map(o=>({[o.getSourceType()]:o.memSizeJs()})),objects:this.objects.filter(o=>o.purpose==="dynamicObject").map(o=>({[o.purpose]:J5(o)}))},i={tileLayers:this.tileLayers.filter(e).map(o=>({[o.getSourceType()]:o.memSizeGpu()})),objects:this.objects.filter(o=>o.purpose==="dynamicObject").map(o=>({[o.purpose]:W0(o)}))};return{js:{...n,"--sum":Mn(n)},gpu:{...i,"--sum":Mn(i)}}}addTileLayer(e){this.tileLayers.indexOf(e)===-1&&(this.tileLayers.push(e),e.redraw(),this.modules.identifier.resetCache(),this.state.needLabeling=!0,this.modules.renderer.addRerenderEvent())}removeTileLayer(e){qg(this.tileLayers,e)&&(e.resetHoverId(),this.modules.identifier.resetCache(),this.state.needLabeling=!0,this.modules.renderer.addRerenderEvent())}redraw(){this.modules.labeler.clearPreviousLabels();for(const e of this.tileLayers)e.resetHoverId(),e.redraw();this.modules.renderer.addRerenderEvent()}activateStyleUpdating(){this.tileLayers.forEach(e=>e.activateStyleUpdating())}finishStyleUpdating(){this.tileLayers.forEach(e=>e.finishStyleUpdating())}getViewportTiles(){const e=[];for(const n of this.tileLayers)e.push(...n.getViewportTiles());return e}viewportTilesReady(){return this.tileLayers.every(e=>e.viewportTilesReady())}displayedTilesAnimationFinished(){return this.tileLayers.every(e=>e.displayedTilesAnimationFinished())}getDisplayedIdentifyData(){const e=[];for(const n of this.tileLayers)e.push(...n.getDisplayedIdentifyData());return e}getLabelingData(){return this.tileLayers.map(e=>e.getLabelingData())}isIdle(){return this.viewportTilesReady()&&this.displayedTilesAnimationFinished()}update(){const e=this.state;this.viewportDiffer.check(e)&&(this.tileLayers.forEach(n=>n.updateViewport()),this.modules.map.emit("viewportchange"));for(const n of this.tileLayers)n.update();if(this.updateTickers(),e.collectStats){this.state.stats.tileCount=0;for(const n of this.tileLayers)this.state.stats.tileCount+=n.getTileCount();this.state.stats.globeTileCount=this.objects.filter(n=>n.purpose==="globe").length,this.state.stats.dynamicTileCount=this.objects.filter(n=>n.purpose==="dynamicObject"||n.purpose==="floor").length}}getTileObjects(){return this.objects}addObject(e,n){if(this.objects.indexOf(e)===-1){if(this.objects.push(e),n)return;this.modules.renderer.addRerenderEvent()}}removeObject(e,n){if(qg(this.objects,e)){if(n)return;this.modules.renderer.addRerenderEvent()}}getCachedMods(){const e=[];for(const n of this.tileLayers){const i=n.gridState.tileModsCache.getData();for(const o of i)e.push(o)}return e}destroy(){for(const e of this.tileLayers)e.destroy();this.objects.forEach(e=>e.clean(this.state))}updateTickers(){this.objects.forEach(e=>e.updateTicker(this.state))}}const TN=(t,e,n,i,o)=>{At("labelingOpacity",{easing:e},t,n,i,o,1)},IN=xt.bind(null,"labelingOpacity",{step:(t,e)=>t.labelingOpacity=e});function EN(t){return t?Object.keys(t).map(Number).sort((e,n)=>e-n):[]}function AN(t,e){const{config:n,ascSortedZoomNumbers:i}=e;if(i.length===0)return{city:Rr.commercialMargins.city};if(t<i[0])return{city:n[i[0]]};if(t>=i[i.length-1])return{city:n[i[i.length-1]]};for(let o=1;o<i.length;o++)if(t<i[o])return{city:n[i[o-1]]};return{city:Rr.commercialMargins.city}}const CN=t=>({appendLabels:t.get(Ue.Labeling,"appendLabels"),appendLabelBox:t.get(Ue.Labeling,"appendLabelBox"),removeLabels:t.get(Ue.Labeling,"removeLabels"),processLabels:t.get(Ue.Labeling,"processLabels"),clearPreviousLabels:t.get(Ue.Labeling,"clearPreviousLabels")});class PN{constructor(e,n){this.state=e,this.modules=n,this.labelTileRevision=0,this.viewportDiffer=new Kt([{path:"center",type:"vec2"},{path:"zoom",type:"number"},{path:"size",type:"vec2"},{path:"rotation",type:"number"},{path:"pitch",type:"number"},{path:"padding",type:"padding"},{path:"demMode",type:"boolean"}]),this.useThrottleUpdate=!0,this.isLabelingInProgress=!1,this.skipHysteresisInNextLabeling=!1,this.alwaysActiveLabelKeys=[],this.survivedLabelBoxes=new Set,this.prevSurvivedCommPoiIds=new Set,this.demKeys={},this.labelTiles=[],this.worker=CN(this.modules.workers.fnRegistry),this.setLabelingInterval(Rr.interval)}disableThrottleUpdateOnce(){this.useThrottleUpdate=!1}update(){IN(this.state),this.state.needReplicasUpdate&&this.labelTiles.forEach(e=>{e.needSync=!0}),(this.viewportDiffer.check(this.state)||this.state.needLabeling)&&!this.isLabelingInProgress&&(this.state.needLabeling=!1,this.isLabelingInProgress=!0,this.useThrottleUpdate?this.throttledUpdateLabeling():(this.useThrottleUpdate=!0,this.generateLabelingTile()))}isIdle(){return this.state.tickers.labelingOpacity===void 0&&!this.isLabelingInProgress&&!this.state.needLabeling}setLabelingInterval(e){this.throttledUpdateLabeling=yl(()=>{this.generateLabelingTile()},e)}addLabels(e,n,i){this.worker.appendLabels(e,n,i,this.state.styleState,this.state.styleZoom),this.enrichWithElevation(i,e),this.alwaysActiveLabelKeys.push(e),this.state.needLabeling=!0}addTileLabels(e,n,i){this.worker.appendLabels(e,n,i,this.state.styleState,this.state.styleZoom),this.enrichWithElevation(i,e),this.state.needLabeling=!0}addLabelBox(e,n){this.worker.appendLabelBox(e,n),this.state.needLabeling=!0}removeLabels(e){this.worker.removeLabels(e);const n=this.alwaysActiveLabelKeys.indexOf(e);n!==-1&&this.alwaysActiveLabelKeys.splice(n,1),this.state.needLabeling=!0}isLabelBoxSurvived(e){return this.survivedLabelBoxes.has(e)}clearPreviousLabels(){this.worker.clearPreviousLabels()}resetHysteresis(){this.skipHysteresisInNextLabeling=!0,this.state.needLabeling=!0}getLabelingRevision(){return this.labelTileRevision}getMemoryFootprint(){const e={labelTiles:this.labelTiles.map(n=>({[n.purpose]:W0(n)}))};return{gpu:{...e,"--sum":Mn(e)}}}generateLabelingTile(){const e=O3(fl(this.state.tilesBounds),Rr.tileMultiplier);let n=[{coords:e,center:this.state.center,tilesBounds:this.state.tilesBounds}];if(!this.state.globeMode)if(e[2]<0)n=[{coords:[0,0,0,0],center:[0,0,0],tilesBounds:[[-2147483648,-2147483648,0],[bt,-2147483648,0],[bt,bt,0],[-2147483648,bt,0]]}];else{const s=Xr(e),a=2**e[2],l=s.min[0]<-2147483648,c=s.max[0]>bt;if(l||c){const d=[...e];d[0]+=l?a:-a;const u=[...this.state.center];u[0]+=l?et:-4294967296;const{min:f,max:h}=Xr(d);n.push({coords:d,center:u,tilesBounds:[[f[0],f[1],0],[h[0],f[1],0],[h[0],h[1],0],[f[0],h[1],0]]})}}const i=this.modules.tileManager.getLabelingData(),o=n.map(({coords:s,center:a,tilesBounds:l})=>({center:a,elevation:this.state.elevation,zoom:this.state.zoom,styleZoom:this.state.styleZoom,rotation:this.state.rotation,size:this.state.size,pitch:this.state.pitch,viewport:this.state.viewport,padding:this.state.padding,globeMode:this.state.globeMode,styleState:this.state.styleState,buildingHeight:this.modules.buildingHeightAnimator.getDefaultBuildingHeight(),tilesBounds:l,debugLabels:this.modules.labelsDebug.isEnabled(),disableSurvivedPoiPrevalence:this.state.disableSurvivedPoiPrevalence,tileInfo:Ct(s),cameraConfig:this.state.cameraConfig})),r=AN(this.state.styleZoom,this.state.cityCommPoiLabeling);this.worker.processLabels(i,this.alwaysActiveLabelKeys,o,window.devicePixelRatio,this.modules.floorManager.getActiveFloorHiddenIds(),{...Rr.commercialMargins,...r},this.skipHysteresisInNextLabeling).then(s=>{this.survivedLabelBoxes.clear(),this.labelTiles.forEach(f=>{this.modules.tileManager.removeObject(f),f.clean(this.state)}),this.labelTiles.length=0;const a=[];s.forEach((f,h)=>{f.survivedLabelBoxIds.forEach(p=>this.survivedLabelBoxes.add(p)),a.push(...f.survivedCommPois),this.modules.assetManager.loadRasters(f.collectorOutput.rastersToLoad);const _=new bi("labeling",f.collectorOutput.data,this.modules,this.state,n[h].coords,void 0,void 0);this.labelTiles.push(_),this.modules.tileManager.addObject(_)}),this.processSurvivedCommPoiIds(a),this.labelTileRevision++;const l=this.state.metrics;l.firstlabeling===void 0&&s.some(({collectorOutput:f})=>f.data.length>0)&&(l.firstlabeling=performance.now()-l.start);const{animationTime:c,animationType:d,interval:u}=Rr;TN(this.state,d,0,1,Math.min(c,u)),this.modules.renderer.addRerenderEvent(),s[0].labels&&e[2]>=0&&this.modules.labelsDebug.drawLabels(s[0].labels),this.isLabelingInProgress=!1}),this.skipHysteresisInNextLabeling=!1}processSurvivedCommPoiIds(e){if(e.length===0){this.prevSurvivedCommPoiIds.clear();return}const n=e.filter(i=>!this.prevSurvivedCommPoiIds.has(i.id));n.length!==0&&this.modules.map.emit("commpoishow",{commPois:n}),this.prevSurvivedCommPoiIds=new Set(e.map(i=>i.id))}enrichWithElevation(e,n){const{demManager:i,map:o}=this.modules;if(o.state.demMode){const r=this.demKeys[n],s=i.getLabelsDemKey(e);if(s===void 0||s===r)return;i.enrichWithElevation(e),this.demKeys[n]=s}}}const We={jointPhase:10,jointWidth:7,jointBorderWidth:3,jointBorder2Width:2,jointSmallWidth:0,jointSmallBorderWidth:4,jointSmallBorder2Width:2,jointColor:"#ffffff",jointBorderColor:"#667799",jointBorder2Color:"#ffffff",linePhase:5,lineWidth:4,lineBorderWidth:2,lineBorder2Width:1,lineColor:"#667799",lineBorderColor:"#ffffff",lineBorder2Color:"#00000026",previewLineColor:"#66779966",labelFontSize:13},Fr={start:{en:"Start",ru:"Старт"},addPoint:{en:"Add point",ru:"Добавить точку"},meter:{en:"m",ru:"м"},kilometer:{en:"km",ru:"км"}};function Aw(t,e,n){return e?Fr.start[n]||Fr.start.en:t<1e3?`${t} ${Fr.meter[n]||Fr.meter.en}`:`${(t/1e3).toFixed(1)} ${Fr.kilometer[n]||Fr.kilometer.en}`}function LN(t){return Fr.addPoint[t]||Fr.addPoint.en}function FN(t,e){return e*.55*t.length}function Cw(t,e){return`
        <div style="font-size: ${e}px;
            color: #667799;
            user-select: none;
            font-family: SuisseIntl, Helvetica, Arial, sans-serif;
            text-shadow: 1px 0px 1px #fff, -1px 0px 1px #fff, 0px 1px 1px #fff, 0px -1px 1px #fff;
            white-space: nowrap;
            cursor: pointer;
        ">
            ${t}
        </div>
    `}function kN(t,e){return`
        <div style="text-shadow: 1px 0px 1px #fff, -1px 0px 1px #fff, 0px 1px 1px #fff, 0px -1px 1px #fff;
            user-select: none;
            color: #667799;
            font-family: SuisseIntl, Helvetica, Arial, sans-serif;
            font-size: 13px;
            margin: -12px 0 0 12px; /** отступы от точки наведения */
            white-space: nowrap;
            cursor: pointer;
        ">
            ${t}
            <br>
            ${LN(e)}
        </div>
    `}function RN(){return`
        <img style="
            user-select: none;
            width: 24px;
            height: 24px;
            margin-top: -4px;
            cursor: pointer;
        " src="data:image/svg+xml;base64,${BN}" alt="close">
    `}function Pw(t,e,n,i){return new LC(i,{coordinates:t,interactive:n,draggable:n,width:e?We.jointWidth:We.jointSmallWidth,borderWidth:e?We.jointBorderWidth:We.jointSmallBorderWidth,border2Width:e?We.jointBorder2Width:We.jointSmallBorder2Width,color:We.jointColor,borderColor:We.jointBorderColor,border2Color:We.jointBorder2Color,zIndex:We.jointPhase})}function I2(t,e,n){return new RU(n,{coordinates:t,zIndex:We.linePhase,zIndex2:We.linePhase-1,zIndex3:We.linePhase-2,width:We.lineWidth,width2:e?0:We.lineWidth+2*We.lineBorderWidth,width3:e?0:We.lineWidth+2*(We.lineBorderWidth+We.lineBorder2Width),color:e?We.previewLineColor:We.lineColor,color2:We.lineBorderColor,color3:We.lineBorder2Color,interactive:!e})}function zN(t,e,n,i){const o=Cw(n,We.labelFontSize),r=FN(n,We.labelFontSize),s=We.labelFontSize,a=e?We.jointWidth:We.jointSmallWidth,l=e?We.jointBorderWidth:We.jointSmallBorderWidth,c=e?We.jointBorder2Width:We.jointSmallBorder2Width,d=a+l*2+c*2;return new yg(i,{coordinates:t,html:o,offset:[d/2+2,-13/2-2],labeling:{type:"full",width:r,height:s},animate:!1,zIndex:We.linePhase+1})}const BN="PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMjIiIGhlaWdodD0iMjIiPjxkZWZzPjxwYXRoIGlkPSJBIiBkPSJNMTIgMTAuNTg2bDMuNzkzLTMuNzkzIDEuNDE0IDEuNDE0TDEzLjQxNCAxMmwzLjc5MyAzLjc5My0xLjQxNCAxLjQxNEwxMiAxMy40MTRsLTMuNzkzIDMuNzkzLTEuNDE0LTEuNDE0TDEwLjU4NiAxMiA2Ljc5MyA4LjIwN2wxLjQxNC0xLjQxNEwxMiAxMC41ODZ6Ii8+PC9kZWZzPjxnIGZpbGwtcnVsZT0iZXZlbm9kZCIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTEgLTEpIj48Y2lyY2xlIGN4PSIxMiIgY3k9IjEyIiByPSIxMC41IiBmaWxsPSIjZmZmIiBzdHJva2U9IiMwMDAiIHN0cm9rZS1vcGFjaXR5PSIuMTUiLz48bWFzayBpZD0iQiIgZmlsbD0iI2ZmZiI+PHVzZSB4bGluazpocmVmPSIjQSIvPjwvbWFzaz48dXNlIGZpbGw9IiMwMDAiIGZpbGwtcnVsZT0ibm9uemVybyIgeGxpbms6aHJlZj0iI0EiLz48ZyBmaWxsPSIjMjYyNjI2IiBtYXNrPSJ1cmwoI0IpIj48cGF0aCBkPSJNMCAwaDI0djI0SDB6Ii8+PC9nPjwvZz48L3N2Zz4=";class ON extends pl{constructor(e,n,i,o){super(),this.markerOrLabelMouseover=()=>{this.markerOrLabelHovered||(this.markerOrLabelHovered=!0,this.hoverTimer===void 0&&this.emit("mouseover"))},this.markerOrLabelMouseout=()=>{this.markerOrLabelHovered&&(this.markerOrLabelHovered=!1,this.hoverTimer=window.setTimeout(()=>{this.markerOrLabelHovered||(this.emit("mouseout"),this.hoverTimer=void 0)},100))},this.onClick=()=>this.emit("click"),this.labelText=Aw(o,i,e.state.lang),this.point=n,this.distance=o,this.label=zN(n,i,this.labelText,e),this.marker=Pw(n,i,!0,e),this.markerOrLabelHovered=!1;const r=this.label.dangerouslyGetRootElement();r.addEventListener("mouseover",this.markerOrLabelMouseover),r.addEventListener("mouseout",this.markerOrLabelMouseout),r.addEventListener("click",this.onClick),this.marker.on("mouseover",()=>this.markerOrLabelMouseover()),this.marker.on("mouseout",()=>this.markerOrLabelMouseout()),this.marker.on("dragstart",s=>{const{lngLat:a,originalEvent:l,point:c,target:d}=s;this.emit("dragstart",{lngLat:a,originalEvent:l,point:c,targetData:this,target:d})}),this.marker.on("dragend",s=>{const{lngLat:a,originalEvent:l,point:c,target:d}=s;this.emit("dragend",{lngLat:a,originalEvent:l,point:c,targetData:this,target:d})})}getDistance(){return this.distance}getPoint(){return this.point}getMarkerUniqId(){return this.marker.uniqId}getLabelUniqId(){return this.label.uniqId}setPoint(e){this.point=e}remove(){this.marker.destroy();const e=this.label.dangerouslyGetRootElement();e.removeEventListener("mouseover",this.markerOrLabelMouseover),e.removeEventListener("mouseout",this.markerOrLabelMouseout),e.removeEventListener("click",this.onClick),this.label.destroy()}activateHover(){this.label.setContent(RN())}deactivateHover(){this.label.setContent(Cw(this.labelText,We.labelFontSize))}}class DN{constructor(e,n){this.onDocumentMouseMove=i=>{this.mousePos=rn(this.modules.layout.rootContainer,i.clientX,i.clientY),this.needsUpdate=!0},this.modules=n,this.state=e,this.joints=[],this.enabled=!1,this.needsUpdate=!1,this.hidePreviewLine=!1,this.hideMouseElem=!1,this.mousePos=[0,0],document.addEventListener("mousemove",this.onDocumentMouseMove),this.langDiffer=new Kt([{path:"lang",type:"string"}])}destroy(){document.removeEventListener("mousemove",this.onDocumentMouseMove)}enable(){this.enabled||(this.enabled=!0,this.state.identifyPickDistance=zi.pickDistance*2,this.popup=new yg(this.modules.map,{coordinates:[0,0],html:"",interactive:!1,animate:!1,zIndex:1}))}disable(){this.enabled=!1,this.reset(),this.mouseElem!==void 0&&(this.mouseElem.destroy(),this.mouseElem=void 0),this.state.identifyPickDistance=zi.pickDistance,this.popup&&(this.popup.destroy(),this.popup=void 0)}update(){this.enabled&&(this.langDiffer.check(this.state)&&this.recalculate(),this.needsUpdate&&(this.needsUpdate=!1,this.drawMousePoint(),this.drawPreviewLine()))}setPoints(e){this.reset(),e.forEach(n=>this.addPointToEnd(n)),this.drawPolyline(),this.sendRulerChangeEvent(!1)}handleClick(e,n){const i=this.getJointByUniqId(n&&n.dynamicObjectId);if(i){const o=this.getJointIndexByReferer(i);o!==void 0&&(i.remove(),this.joints.splice(o,1),this.recalculate(),this.hidePreviewLine=!1,this.hideMouseElem=!1),this.popup&&this.popup.setContent("")}else if(n&&this.polyline&&this.polyline.uniqId===n.dynamicObjectId){const o=this.polyline.snapPoint(e),r=this.getJointIndexByDistance(o.distance),s=this.createJoint(o.point,!1,o.distance);this.joints.splice(r,0,s),this.hidePreviewLine=!0,this.hideMouseElem=!0,this.drawPolyline(),this.sendRulerChangeEvent(!0),this.popup&&this.popup.setContent("")}else{const o=this.modules.camera.unproject(e);this.addPointToEnd(o),this.drawPolyline(),this.sendRulerChangeEvent(!0)}}recalculate(){const e=[];this.joints.forEach((n,i)=>{n.remove();const o=i===0;let r=0;if(!o){const a=e[i-1];r=a.getDistance()+mf(a.getPoint(),n.getPoint())}const s=this.createJoint(n.getPoint(),o,r);e.push(s)}),this.joints=e,this.drawPolyline(),this.sendRulerChangeEvent(!0)}sendRulerChangeEvent(e){this.modules.map.emit("rulerchange",{points:this.getPoints(),isUser:e})}getJointByUniqId(e){if(e!==void 0){for(const n of this.joints)if(e===n.getMarkerUniqId()||e===n.getLabelUniqId())return n}}getJointIndexByDistance(e){let n=0;for(const i of this.joints){if(e<i.getDistance())break;n++}return n}getJointIndexByReferer(e){let n=0;for(const i of this.joints){if(i===e)return n;n++}}getPoints(){return this.joints.map(e=>e.getPoint())}reset(){this.joints.forEach(e=>e.remove()),this.joints=[],this.polyline!==void 0&&(this.polyline.remove(),this.polyline=void 0),this.previewLine!==void 0&&(this.previewLine.remove(),this.previewLine=void 0),this.hidePreviewLine=!1,this.hideMouseElem=!1,this.popup&&this.popup.setContent("")}createJoint(e,n,i){const o=new ON(this.modules.map,e,n,i);return o.on("mouseover",()=>{this.draggableJointIndex===void 0&&(this.requestUpdate(!0,!0),o.activateHover())}),o.on("mouseout",()=>{this.draggableJointIndex===void 0&&(this.requestUpdate(!1,!0),o.deactivateHover())}),o.on("dragstart",()=>{this.requestUpdate(!1,!0),this.draggableJointIndex=this.getJointIndexByReferer(o)}),o.on("dragend",r=>{this.requestUpdate(!1,!0),this.draggableJointIndex=void 0,o.setPoint(r.lngLat),this.recalculate()}),o.on("click",()=>{const r=this.getJointIndexByReferer(o);r!==void 0&&(o.remove(),this.joints.splice(r,1),this.recalculate(),this.hidePreviewLine=!1,this.hideMouseElem=!1),this.popup&&this.popup.setContent("")}),o}addPointToEnd(e){let n=!0,i=0;if(this.joints.length>0){n=!1;const r=this.joints[this.joints.length-1];i=r.getDistance()+mf(r.getPoint(),e)}const o=this.createJoint(e,n,i);this.joints.push(o)}drawPolyline(){this.polyline!==void 0&&(this.polyline.remove(),this.polyline=void 0);const e=this.getPoints();if(e.length<2)return;const n=I2(e,!1,this.modules.map);n.on("mousemove",i=>{if(this.draggableJointIndex===void 0){if(this.popup){const o=n.snapPoint(i.point),r=Aw(o.distance,!1,this.state.lang);this.popup.setPosition(o.point),this.popup.setContent(kN(r,this.state.lang)),this.snapPoint=o.point}this.requestUpdate(!0,!1)}}),n.on("mouseout",()=>{this.draggableJointIndex===void 0&&(this.popup&&this.popup.setContent(""),this.requestUpdate(!1,!0))}),this.polyline=n}requestUpdate(e,n){this.hidePreviewLine=e,this.hideMouseElem=n,this.needsUpdate=!0}getPreviewPoints(){const e=this.getPoints();if(this.hidePreviewLine||e.length<1)return[];const n=this.draggableJointIndex,i=this.modules.camera.unproject(this.mousePos);if(n===void 0||e.length===1)return[];if(n===this.joints.length-1)return[e[e.length-2],i];if(n===0)return[e[1],i];const o=this.joints[n-1],r=this.joints[n+1];return[o.getPoint(),i,r.getPoint()]}drawPreviewLine(){this.previewLine!==void 0&&(this.previewLine.remove(),this.previewLine=void 0);const e=this.getPreviewPoints();e.length<1||(this.previewLine=I2(e,!0,this.modules.map))}drawMousePoint(){this.mouseElem!==void 0&&(this.mouseElem.destroy(),this.mouseElem=void 0),!(this.hideMouseElem||this.snapPoint===void 0)&&(this.mouseElem=Pw(this.snapPoint,!0,!1,this.modules.map))}}class Na{constructor(e,n,i){this.type=e,this.handler=i,this.mouseDownPoint=n,this.handler.mapState.userHasInteracted=!0,this.handler.modules.map.emit("interactionstart",{target:"pitch/rotation"})}processAction(e){switch(e.type){case"mousemove":return this.processMouseMoveAction(e);case"mouseup":return this.processMouseUpAction(e);case"keyup":return this.processKeyUpAction(e);default:return this}}processMouseMoveAction(e){const n=rn(this.handler.container,e.clientX,e.clientY);return new Lw(this.type,this.mouseDownPoint,n,this.handler)}processMouseUpAction(e){switch(this.type){case"keyPrimary":if(e.button===0&&(e.ctrlKey||e.metaKey))return this.returnToInitialState();break;case"secondary":if(e.button===2){const n=rn(this.handler.container,e.clientX,e.clientY);return this.handler.modules.identifier.search("contextmenu",n,!0).then(i=>{No("contextmenu",i,e,n,this.handler.modules)}),this.returnToInitialState()}break;case"auxiliary":if(e.button===1)return this.returnToInitialState();break}return this}processKeyUpAction(e){return this.type==="keyPrimary"&&(e.key==="Control"||e.key==="Meta")?(this.handler.modules.map.emit("interactionend",{target:"pitch/rotation"}),new yh(this.mouseDownPoint,this.handler)):this}returnToInitialState(){return this.handler.mapState.userHasInteracted=!0,this.handler.modules.map.emit("interactionend",{target:"pitch/rotation"}),new vi(this.handler)}}class Lw{constructor(e,n,i,o){this.type=e,this.mouseDownPoint=n,this.mouseMovePoint=i,this.handler=o,this.handler.mapState.userHasInteracted=!0,(!this.handler.mapState.disablePitchByUserInteraction||!this.handler.mapState.disableRotationByUserInteraction)&&this.handler.container.classList.add("mapgl-rotating"),this.update(this.handler.mapState)}processAction(e){switch(e.type){case"mousemove":return this.processMouseMoveAction(e);case"mouseleave":return this.returnToInitialState();case"mouseup":return this.processMouseUpAction(e);case"keyup":return this.processKeyUpAction(e);default:return this}}update(e){this.mouseDownPoint[0]===0&&this.mouseDownPoint[1]===0&&(this.mouseDownPoint=this.mouseMovePoint);const n=pf(e.size,this.mouseDownPoint),i=pf(e.size,this.mouseMovePoint),o=(n[0]-i[0])*Ri.mouseRotateDelta,r=(i[1]-n[1])*Ri.mousePitchDelta;qo(e),e.disableRotationByUserInteraction||ng(e,e.rotation+o,{animate:!1}),e.disablePitchByUserInteraction||Eb(e,Ve(e.pitch+r,e.minPitch,e.maxPitch),{animate:!1}),this.mouseDownPoint=this.mouseMovePoint,this.handler.modules.renderer.addRerenderEvent()}processMouseMoveAction(e){return this.mouseMovePoint=rn(this.handler.container,e.clientX,e.clientY),this.handler.mapState.userHasInteracted=!0,this.update(this.handler.mapState),this}processMouseUpAction(e){switch(this.type){case"keyPrimary":if(e.button===0&&(e.ctrlKey||e.metaKey))return this.returnToInitialState();break;case"secondary":if(e.button===2)return this.returnToInitialState();break;case"auxiliary":if(e.button===1)return this.returnToInitialState();break}return this}processKeyUpAction(e){return this.type==="keyPrimary"&&(e.key==="Control"||e.key==="Meta")?(this.handler.container.classList.remove("mapgl-rotating"),this.handler.modules.map.emit("interactionend",{target:"pitch/rotation"}),new yh(this.mouseMovePoint,this.handler)):this}returnToInitialState(){return this.handler.mapState.userHasInteracted=!0,this.handler.container.classList.remove("mapgl-rotating"),this.handler.modules.map.emit("interactionend",{target:"pitch/rotation"}),new vi(this.handler)}}class yh{constructor(e,n){this.handler=n,this.toInitialOnMouseUp=!1,this.mouseDownPoint=e,this.dragStartPoint=e,this.isTimerStarted=this.handler.dblClickTimer!==void 0,this.handler.mapState.userHasInteracted=!0,this.handler.modules.map.emit("interactionstart",{target:"center"}),this.isTimerStarted&&(window.clearTimeout(this.handler.dblClickTimer),this.handler.dblClickTimer=void 0)}processAction(e){switch(e.type){case"mousedown":return this.toInitialOnMouseUp=!0,this;case"mouseup":return this.processMouseUpAction(e);case"mousemove":return this.processMouseMoveAction(e);case"click":return this.processMouseClickAction(e);case"keydown":return this.processKeyDownAction(e);default:return this}}processMouseUpAction(e){return e.button===0&&(this.toInitialOnMouseUp||!this.handler.modules.layout.isActionWithCanvas(e))?(this.handler.mapState.userHasInteracted=!0,this.handler.modules.map.emit("interactionend",{target:"center"}),new vi(this.handler)):this}processMouseMoveAction(e){const n=rn(this.handler.container,e.clientX,e.clientY);return this.handler.mapState.disableDragging?(this.mouseDownPoint=n,this.dragStartPoint=n,this.toInitialOnMouseUp=!0,this):eo(this.mouseDownPoint,n)<Lr.dragThreshold?(this.dragStartPoint=n,this):new Fw(n,this.dragStartPoint,this.handler)}processMouseClickAction(e){if(!this.handler.modules.layout.isActionWithCanvas(e))return this;if(this.isTimerStarted){if(this.handler.mapState.zoom<this.handler.mapState.maxZoom){const n=this.handler.mapState,i=Math.min(n.zoom+1,n.maxZoom),o=rn(this.handler.container,e.clientX,e.clientY);qo(n),vl(n,i,{duration:Ri.animDuration,zoomPoint:n.keepCenterWhileUserZoomRotate?void 0:o}),this.handler.modules.renderer.addRerenderEvent()}}else{const n=rn(this.handler.container,e.clientX,e.clientY);this.handler.modules.identifier.search("mouseClick",n,!0).then(i=>{const o=this.handler.modules.ruler;if(o.enabled){o.handleClick(n,i);return}this.handler.dblClickTimer||(this.handler.dblClickTimer=window.setTimeout(()=>{No("click",i,e,n,this.handler.modules),this.handler.dblClickTimer=void 0},Lr.doubleClickTime))})}return this.handler.mapState.userHasInteracted=!0,this.handler.modules.map.emit("interactionend",{target:"center"}),new vi(this.handler)}processKeyDownAction(e){return e.key==="Control"||e.key==="Meta"?(this.handler.modules.map.emit("interactionend",{target:"center"}),new Na("keyPrimary",this.mouseDownPoint,this.handler)):this}}class Fw{constructor(e,n,i){this.mouseMovePoint=e,this.dragStartPoint=n,this.handler=i,this.handler.container.classList.add("mapgl-dragging"),this.handler.mapState.userHasInteracted=!0,this.update(this.handler.mapState)}processAction(e){switch(e.type){case"mousemove":return this.processMouseMoveAction(e);case"mouseup":return this.processMouseUpAction(e);case"keydown":return this.processKeyDownAction(e);default:return this}}update(e){const n=this.handler.modules.camera,i=n.flat.unproject(this.dragStartPoint),o=n.flat.unproject(this.mouseMovePoint);if(e.globeMode){const s=u3(n.globeRatio,q.toGeo(e.center));ni(i,i,s),ni(o,o,s)}const r=Fa(e.center);jt(r,r,i),$t(r,r,o),qo(e),Qc(e,r,{animate:!1}),this.dragStartPoint=this.mouseMovePoint,this.handler.modules.renderer.addRerenderEvent()}processMouseMoveAction(e){return this.mouseMovePoint=rn(this.handler.container,e.clientX,e.clientY),this.handler.mapState.userHasInteracted=!0,this.update(this.handler.mapState),this}processMouseUpAction(e){return e.button===0?this.returnToInitialState():this}processKeyDownAction(e){return e.key==="Control"||e.key==="Meta"?(this.handler.container.classList.remove("mapgl-dragging"),this.handler.modules.map.emit("interactionend",{target:"center"}),new Na("keyPrimary",this.mouseMovePoint,this.handler)):this}returnToInitialState(){return this.handler.container.classList.remove("mapgl-dragging"),this.handler.modules.map.emit("interactionend",{target:"center"}),this.handler.mapState.userHasInteracted=!0,new vi(this.handler)}}class kw{constructor(e,n,i){this.handler=i,this.touchStartPoints=n,this.touchMovePoints=e,this.handler.mapState.userHasInteracted=!0,this.handler.mapState.disablePitchByUserInteraction||this.handler.container.classList.add("mapgl-rotating"),this.update(this.handler.mapState)}processAction(e){switch(e.type){case"touchstart":return this.processTouchStartAction(e);case"touchmove":return this.processTouchMoveAction(e);case"touchend":return this.processTouchEndAction(e);default:return this}}processTouchStartAction(e){return this.handler.container.classList.remove("mapgl-rotating"),this.handler.modules.map.emit("interactionend",{target:"pitch/zoom/rotation"}),new il(e,this.handler,!1)}processTouchMoveAction(e){return e.preventDefault(),this.touchMovePoints=bs(e.touches,this.handler.container),this.handler.mapState.userHasInteracted=!0,this.update(this.handler.mapState),this}processTouchEndAction(e){return this.handler.container.classList.remove("mapgl-rotating"),this.handler.modules.map.emit("interactionend",{target:"pitch/zoom/rotation"}),e.touches.length===0?(this.handler.mapState.userHasInteracted=!0,new vi(this.handler)):new il(e,this.handler,!1)}}class rf extends kw{constructor(e,n,i){super(e,n,i),this.startPxAngle=0,this.rotationDetected=!1,n.length>1&&(this.startPxAngle=rd(n[0],n[1]))}update(e){if(this.touchStartPoints.length<2||this.touchMovePoints.length<2)return;const n=Rm(this.touchMovePoints[0],this.touchMovePoints[1]),i=Ur(this.touchMovePoints[0],this.touchMovePoints[1]),o=Ur(this.touchStartPoints[0],this.touchStartPoints[1]),r=i/o,s=e.zoom+Math.log(r)/Math.log(2)*Ri.mobilePinchDelta;let a=0,l=0;if(!this.rotationDetected){const u=rd(this.touchMovePoints[0],this.touchMovePoints[1]);l=Math.abs(this.startPxAngle-u),l>Math.PI&&(l=2*Math.PI-l),l>=this.handler.mapState.touchRotationThreshold&&(this.rotationDetected=!0)}if(this.rotationDetected){const u=this.handler.modules.camera.flat.unproject(this.touchStartPoints[0]),f=this.handler.modules.camera.flat.unproject(this.touchStartPoints[1]),h=this.handler.modules.camera.flat.unproject(this.touchMovePoints[0]),_=this.handler.modules.camera.flat.unproject(this.touchMovePoints[1]);if(u&&f&&h&&_){const p=rd(u,f),m=rd(h,_);a=p-m}}const c=e.rotation+a,d=e.center;e.keepCenterWhileUserZoomRotate||jt(d,e.center,$c(e,n,{zoom:s,rotation:c})),qo(e),Qc(e,d,{animate:!1}),vl(e,s,{animate:!1}),this.handler.mapState.disableRotationByUserInteraction||ng(e,c,{animate:!1}),this.touchStartPoints=this.touchMovePoints,this.handler.modules.renderer.addRerenderEvent()}}class Rw extends kw{constructor(e,n,i){super(e,n,i)}update(e){const n=this.touchStartPoints.map(a=>pf(e.size,a)),i=this.touchMovePoints.map(a=>pf(e.size,a)),o=Rm(n[0],n[1]),s=(Rm(i[0],i[1])[1]-o[1])*Ri.mousePitchDelta;qo(e),Eb(e,Ve(e.pitch+s,e.minPitch,e.maxPitch),{animate:!1}),this.touchStartPoints=this.touchMovePoints,this.handler.modules.renderer.addRerenderEvent()}}class il{constructor(e,n,i){this.handler=n,this.needClickOnTouchEnd=i,this.toZoomRotate=!1,this.touchStartPoints=bs(e.touches,this.handler.container),this.handler.mapState.userHasInteracted=!0,this.isTimerStarted=this.handler.dblClickTimer!==void 0,$h(e)?this.startedInteractionTarget="pitch/zoom/rotation":this.isTimerStarted?(this.startedInteractionTarget="zoom/rotation",window.clearTimeout(this.handler.dblClickTimer),this.handler.dblClickTimer=void 0):this.startedInteractionTarget="center",this.handler.modules.map.emit("interactionstart",{target:this.startedInteractionTarget})}processAction(e){switch(e.type){case"touchstart":return this.processTouchStartAction(e);case"touchmove":return this.processTouchMoveAction(e);case"touchend":return this.processTouchEndAction(e);default:return this}}getStartedInteractionTarget(){return this.startedInteractionTarget}processTouchStartAction(e){return e.preventDefault(),this.touchStartPoints.length===1&&(this.needClickOnTouchEnd=!1,this.handler.modules.map.emit("interactionend",{target:"center"}),this.startedInteractionTarget="pitch/zoom/rotation",this.handler.modules.map.emit("interactionstart",{target:this.startedInteractionTarget}),this.handler.mapState.userHasInteracted=!0),this.touchStartPoints=bs(e.touches,this.handler.container),this}processTouchMoveAction(e){e.preventDefault();const n=bs(e.touches,this.handler.container);if(!$h(e))return eo(this.touchStartPoints[0],n[0])<Lr.dragThreshold?(this.touchStartPoints=n,this):this.isTimerStarted?new zw(n[0],this.touchStartPoints[0],this.handler):this.handler.mapState.disableDragging?(this.touchStartPoints=n,this.needClickOnTouchEnd=!1,this):new Np(n[0],this.touchStartPoints[0],this.handler);if(this.touchStartPoints.length<2)return this.processTouchStartAction(e);const i=Et(),o=Et();ti(i,n[0],this.touchStartPoints[0]),ti(o,n[1],this.touchStartPoints[1]);const r=Ls(i,o);if(r>0){if(this.handler.mapState.enableTwoFingerDragging&&this.touchStartPoints.length===2)return eo(this.touchStartPoints[0],n[0])<Lr.dragThreshold?(this.touchStartPoints=n,this):new Np(n[0],this.touchStartPoints[0],this.handler);const a=eo(this.touchStartPoints[0],n[0]),l=eo(this.touchStartPoints[1],n[1]);return a<Lr.pitchThreshold||l<Lr.pitchThreshold?(this.touchStartPoints=n,this):this.handler.mapState.disablePitchByUserInteraction?this:new Rw(n,this.touchStartPoints,this.handler)}return r<0?new rf(n,this.touchStartPoints,this.handler):Jg(i)||Jg(o)?this.pitchWaitingTimer?this:this.toZoomRotate?(this.toZoomRotate=!1,new rf(n,this.touchStartPoints,this.handler)):(this.pitchWaitingTimer=window.setTimeout(()=>{this.toZoomRotate=!0,this.pitchWaitingTimer=void 0},Lr.pitchWaitingTime),this):new rf(n,this.touchStartPoints,this.handler)}processTouchEndAction(e){return e.cancelable&&e.preventDefault(),e.touches.length===0?e.changedTouches.length===1&&this.needClickOnTouchEnd?this.processTouchClickAction(this.touchStartPoints[0],e):(this.handler.mapState.userHasInteracted=!0,this.handler.modules.map.emit("interactionend",{target:e.changedTouches.length>1?"pitch/zoom/rotation":"center"}),new vi(this.handler)):($h(e)||(this.handler.modules.map.emit("interactionend",{target:"pitch/zoom/rotation"}),this.startedInteractionTarget="center",this.handler.modules.map.emit("interactionstart",{target:this.startedInteractionTarget}),this.handler.mapState.userHasInteracted=!0),this.touchStartPoints=bs(e.touches,this.handler.container),this)}processTouchClickAction(e,n){if(this.isTimerStarted){if(this.handler.mapState.zoom<this.handler.mapState.maxZoom){const i=this.handler.mapState,o=Math.min(i.zoom+1,i.maxZoom),r=i.keepCenterWhileUserZoomRotate?void 0:e;qo(i),vl(i,o,{duration:Ri.animDuration,zoomPoint:r}),this.handler.modules.renderer.addRerenderEvent()}}else if(this.handler.modules.layout.isActionWithCanvas(n))this.handler.modules.identifier.search("mouseClick",e,!0).then(i=>{const o=this.handler.modules.ruler;if(o.enabled){o.handleClick(e,i);return}this.handler.dblClickTimer||(this.handler.dblClickTimer=window.setTimeout(()=>{No("click",i,n,e,this.handler.modules),this.handler.dblClickTimer=void 0},Lr.doubleClickTime))});else{const i=n.changedTouches[0];n.target&&i&&n.target.dispatchEvent(new MouseEvent("click",{bubbles:!0,cancelable:!0,clientX:i.clientX,clientY:i.clientY}))}return this.handler.mapState.userHasInteracted=!0,this.handler.modules.map.emit("interactionend",{target:"center"}),new vi(this.handler)}}class Np{constructor(e,n,i){this.handler=i,this.touchMovePoint=e,this.touchStartPoint=n,this.handler.mapState.userHasInteracted=!0,this.handler.container.classList.add("mapgl-dragging"),this.update(this.handler.mapState)}processAction(e){switch(e.type){case"touchstart":return this.processTouchStartAction(e);case"touchmove":return this.processTouchMoveAction(e);case"touchend":return this.processTouchEndAction();default:return this}}update(e){const n=this.handler.modules.camera,i=n.flat.unproject(this.touchStartPoint),o=n.flat.unproject(this.touchMovePoint);if(e.globeMode){const s=u3(n.globeRatio,q.toGeo(e.center));ni(i,i,s),ni(o,o,s)}const r=Fa(e.center);jt(r,r,i),$t(r,r,o),qo(e),Qc(e,r,{animate:!1}),this.touchStartPoint=this.touchMovePoint,this.handler.modules.renderer.addRerenderEvent()}processTouchStartAction(e){return this.handler.container.classList.remove("mapgl-dragging"),this.handler.modules.map.emit("interactionend",{target:"center"}),new il(e,this.handler,!1)}processTouchMoveAction(e){e.preventDefault();const n=bs(e.touches,this.handler.container);return this.touchMovePoint=n[0],this.handler.mapState.userHasInteracted=!0,this.update(this.handler.mapState),this}processTouchEndAction(){return this.handler.container.classList.remove("mapgl-dragging"),this.handler.modules.map.emit("interactionend",{target:"center"}),this.handler.mapState.userHasInteracted=!0,new vi(this.handler)}}class zw{constructor(e,n,i){this.handler=i,this.mapHeight=i.mapState.size[1],this.startZoom=i.mapState.zoom,this.touchMovePointY=e[1],this.touchStartPoint=n,this.handler.mapState.userHasInteracted=!0,this.update(this.handler.mapState)}processAction(e){switch(e.type){case"touchstart":return this.processTouchStartAction(e);case"touchmove":return this.processTouchMoveAction(e);case"touchend":return this.processTouchEndAction();default:return this}}update(e){const n=this.touchMovePointY-this.touchStartPoint[1];if(n===0)return;const i=n/this.mapHeight,o=Ve(this.startZoom+i*Ri.mobileTapDelta,e.minZoom,e.maxZoom),r=e.center;e.keepCenterWhileUserZoomRotate||jt(r,e.center,$c(e,this.touchStartPoint,{zoom:o})),qo(e),Qc(e,r,{animate:!1}),vl(e,o,{animate:!1}),this.handler.modules.renderer.addRerenderEvent()}processTouchStartAction(e){return this.handler.modules.map.emit("interactionend",{target:"zoom/rotation"}),new il(e,this.handler,!1)}processTouchMoveAction(e){e.preventDefault();const n=bs(e.touches,this.handler.container);return this.touchMovePointY=n[0][1],this.handler.mapState.userHasInteracted=!0,this.update(this.handler.mapState),this}processTouchEndAction(){return this.handler.modules.map.emit("interactionend",{target:"zoom/rotation"}),this.handler.mapState.userHasInteracted=!0,new vi(this.handler)}}class vi{constructor(e){this.handler=e}processAction(e){switch(e.type){case"mousedown":return this.processMouseDownAction(e);case"touchstart":return this.processTouchStartAction(e);default:return this}}processMouseDownAction(e){const n=rn(this.handler.container,e.clientX,e.clientY);switch(e.button){case 0:if(e.ctrlKey||e.metaKey)return new Na("keyPrimary",n,this.handler);if(this.handler.modules.layout.isActionWithCanvas(e)){const i=this.handler.modules.identifier.searchSync(n);No("mousedown",i,e,n,this.handler.modules)}return new yh(n,this.handler);case 1:return new Na("auxiliary",n,this.handler);case 2:return new Na("secondary",n,this.handler);default:return this}}processTouchStartAction(e){if(e.preventDefault(),!e.touches)return this;if(this.handler.modules.layout.isActionWithCanvas(e)){const n=rn(this.handler.container,e.changedTouches[0].clientX,e.changedTouches[0].clientY),i=this.handler.modules.identifier.searchSync(n);No("touchstart",i,e,n,this.handler.modules)}return new il(e,this.handler,e.touches.length===1)}}class Cu{processAction(){return this}}class NN{constructor(e,n){this.preventDefault=i=>{i.preventDefault()},this.onMouseMove=i=>{this.dblClickTimer&&(this.dblClickTimer=void 0),this.switchState(i)},this.onTouchStart=i=>{this.modules.layout.isActionWithMap(i)&&this.switchState(i)},this.switchState=i=>{this.state;const o=this.state.processAction(i);this.state instanceof Cu||(this.state=o)},this.state=new vi(this),this.mapState=e,this.modules=n,this.container=n.layout.mapContainer,document.addEventListener("mouseup",this.switchState),document.addEventListener("keydown",this.switchState),document.addEventListener("keyup",this.switchState),document.addEventListener("mouseleave",this.switchState),document.addEventListener("mousemove",this.onMouseMove),this.container.addEventListener("click",this.switchState),this.container.addEventListener("mousedown",this.switchState),this.container.addEventListener("mouseout",this.switchState),document.addEventListener("touchstart",this.onTouchStart),document.addEventListener("touchend",this.switchState),document.addEventListener("touchmove",this.switchState),this.container.addEventListener("dragstart",this.preventDefault),this.container.addEventListener("drag",this.preventDefault),this.container.addEventListener("dragend",this.preventDefault),this.container.addEventListener("contextmenu",this.preventDefault),this.container.addEventListener("touchmove",this.preventDefault)}destroy(){document.removeEventListener("mouseup",this.switchState),document.removeEventListener("keydown",this.switchState),document.removeEventListener("keyup",this.switchState),document.removeEventListener("mouseleave",this.switchState),document.removeEventListener("mousemove",this.onMouseMove),this.container.removeEventListener("click",this.switchState),this.container.removeEventListener("mousedown",this.switchState),this.container.removeEventListener("mouseout",this.switchState),document.removeEventListener("touchstart",this.onTouchStart),document.removeEventListener("touchend",this.switchState),document.removeEventListener("touchmove",this.switchState),this.container.removeEventListener("dragstart",this.preventDefault),this.container.removeEventListener("drag",this.preventDefault),this.container.removeEventListener("dragend",this.preventDefault),this.container.removeEventListener("contextmenu",this.preventDefault),this.container.removeEventListener("touchmove",this.preventDefault)}block(){if(this.state instanceof Cu)return;const{map:e}=this.modules;switch(this.container.classList.remove("mapgl-dragging"),this.container.classList.remove("mapgl-rotating"),this.state.constructor){case yh:case Fw:case Np:e.emit("interactionend",{target:"center"});break;case Na:case Lw:e.emit("interactionend",{target:"pitch/rotation"});break;case zw:e.emit("interactionend",{target:"zoom/rotation"});break;case rf:case Rw:e.emit("interactionend",{target:"pitch/zoom/rotation"});break;case il:{const n=this.state.getStartedInteractionTarget();e.emit("interactionend",{target:n});break}}this.state=new Cu}unblock(){this.state instanceof vi||this.state instanceof Cu&&(this.state=new vi(this))}}const UN=new Set([lx]);class am extends Error{constructor(e,n){super(e),this.name="TrafficFetchMetaError",this.noRetry=n}}class GN{constructor(e,n){this.mapState=e,this.modules=n,this.fetchMetaRetryAttempt=null,this.enabled=!1,this.justEnabled=!1,this.isMetaLoading=!1,this.lastUpdateTime=-1/0,this.regionIds=new Set,this.id=mo();const i=n.identifier.getIdScope(Yo);this.gridState=j5("traffic",0,this.id,e.trafficMinZoom,e.trafficMaxZoom,e.trafficMinZoom,e.trafficMaxDetailLevel,n,e,i),this.viewportDiffer=new Kt([{path:"center",type:"vec2"},{path:"zoom",type:"number"},{path:"size",type:"vec2"},{path:"rotation",type:"number"},{path:"pitch",type:"number"},{path:"demMode",type:"boolean"}])}show(){this.enabled||(this.enabled=!0,this.justEnabled=!0,this.modules.map.emit("trafficshow"))}hide(){this.enabled&&(wc(this.gridState),this.enabled=!1,this.modules.map.emit("traffichide"))}isEnabled(){return this.enabled}destroy(){wc(this.gridState)}redraw(){this.enabled&&(wc(this.gridState),Mf(this.gridState,this.mapState,this.modules))}activateStyleUpdating(){this.enabled&&Y5(this.gridState,this.mapState.handyStyleId,this.modules.styleManager.getStyleRevision(this.mapState.handyStyleId),this.modules.map.core.getIsFirstStyleUpdate())}finishStyleUpdating(){this.enabled&&q5(this.gridState)}update(){if(!this.enabled)return;let e=!1;if(Lm(this.regionIds,this.mapState.shownRegionIds)||(this.regionIds=new Set(this.mapState.shownRegionIds),e=!0),Date.now()-this.lastUpdateTime>ci.updateInterval&&(e=!0,this.fetchMetaRetryAttempt=null),this.fetchMetaRetryAttempt!==null&&this.fetchMetaRetryAttempt<ci.fetchMetaRetryDelays.length&&Date.now()-this.lastUpdateTime>ci.fetchMetaRetryDelays[this.fetchMetaRetryAttempt]&&(this.fetchMetaRetryAttempt++,e=!0),e&&this.fetchMeta(),this.timestamp===void 0)return;(this.viewportDiffer.check(this.mapState)||this.justEnabled)&&(this.justEnabled=!1,Mf(this.gridState,this.mapState,this.modules),this.modules.renderer.addRerenderEvent());const n={...this.gridState.displayedMods};X5(this.gridState,this.mapState,this.modules),this.fetch(U5(this.gridState),this.timestamp),this.abortFetch(G5(this.gridState)),this.generate(H5(this.gridState)),this.clearTiles(V5(this.gridState)),W5(this.modules,this.mapState,this.gridState,n)}viewportTilesReady(){return $0(this.gridState.tiles,this.gridState.viewportTiles)}getMemoryFootprint(){const e=this.gridState,n={gridState:{displayedMods:Object.keys(e.displayedMods).map(o=>If(e.displayedMods[o])),tileModsCache:e.tileModsCache.keys().filter(o=>!e.displayedMods[o]).map(o=>If(e.tileModsCache.get(o)))}},i={gridState:{displayedMods:Object.keys(e.displayedMods).map(o=>Ef(e.displayedMods[o])),tileModsCache:e.tileModsCache.keys().filter(o=>!e.displayedMods[o]).map(o=>Ef(e.tileModsCache.get(o)))}};return{js:{...n,"--sum":Mn(n)},gpu:{...n,"--sum":Mn(i)}}}fetch(e,n){e.sort((i,o)=>mc(this.mapState.center,i,o)).forEach(i=>HN(i,this.modules,this.mapState,this.regionIds,n))}abortFetch(e){e.forEach(n=>{this.modules.workers.parser.abortTrafficTileRequest(n.key)})}generate(e){e.sort((n,i)=>mc(this.mapState.center,n,i)).forEach(n=>{const i=D5(n);i&&this.modules.workers.parser.generateTrafficTile({styleId:this.mapState.handyStyleId,coords:n.coords,pixelRatio:window.devicePixelRatio,styleState:this.mapState.styleState,sourceId:this.modules.defaultSource.getId()}).then(o=>{if(!o){$3("traffic");return}Array.isArray(o.results)&&z5(i,o.results)})})}clearTiles(e){for(const n of e)this.modules.workers.parser.deleteTrafficTile(n.key),delete this.gridState.tiles[n.key]}fetchMeta(){if(this.isMetaLoading||!this.regionIds.size)return;if(Lm(this.regionIds,UN)){console.warn("Traffic metadata request skip: only Universe"),this.lastUpdateTime=Date.now();return}this.isMetaLoading=!0;const e=this.mapState,n=Ya(ci.timestampUrl,{host:e.trafficServer,protocol:e.trafficProtocol||e.tileProtocol,regions:Array.from(this.regionIds).join(",")});fetch(n).then(i=>{if(i.ok)return i.json();throw new am(`Request traffic timestamp error with status ${i.status}`,!1)}).then(i=>{var r,s;if(!i.length||((r=i[0])==null?void 0:r.time)===void 0||((s=i[0])==null?void 0:s.score)===void 0)throw new am(`Bad traffic timestamp and score response ${i.toString()}`,!0);let o=0;i.forEach(a=>o+=a.score),o=Math.round(o/i.length),this.modules.map.emit("trafficscore",{score:o}),this.timestamp=i[0].time,this.isMetaLoading=!1,this.lastUpdateTime=Date.now(),this.fetchMetaRetryAttempt=null,this.redraw()}).catch(i=>{!(i instanceof am)||!i.noRetry?this.fetchMetaRetryAttempt=this.fetchMetaRetryAttempt??0:this.fetchMetaRetryAttempt=null,this.lastUpdateTime=Date.now(),this.isMetaLoading=!1,console.error(i)})}}function HN(t,e,n,i,o){i.size&&e.workers.parser.fetchTrafficTile({coords:t.coords,tileServer:n.trafficServer,tileProtocol:n.trafficProtocol||n.tileProtocol,regionIds:Array.from(i),timestamp:o}).then(()=>{t.status===j0.Loading&&(t.serverMetadata=[{regionId:0,metatileHash:-2}])})}class VN{constructor(e){this.externalContainer=e,this.rootContainer=document.createElement("div"),this.rootContainer.style.position="relative",this.rootContainer.style.height="100%",this.rootContainer.style.width="100%",this.rootContainer.style.overflow="hidden",this.externalContainer.appendChild(this.rootContainer),this.mapContainer=document.createElement("div"),this.mapContainer.style.position="relative",this.mapContainer.style.height="100%",this.mapContainer.style.width="100%",this.mapContainer.style.touchAction="none",this.mapContainer.style.webkitUserSelect="none",this.mapContainer.style.userSelect="none",this.rootContainer.appendChild(this.mapContainer),this.canvas=document.createElement("canvas"),this.canvas.style.display="block",this.mapContainer.appendChild(this.canvas),this.htmlContainerInMap=document.createElement("div"),this.htmlContainerInMap.style.position="absolute",this.htmlContainerInMap.style.left="0",this.htmlContainerInMap.style.top="0",this.htmlContainerInMap.style.width="100%",this.htmlContainerInMap.style.height="0",this.htmlContainerInMap.style.webkitUserSelect="auto",this.htmlContainerInMap.style.userSelect="auto",this.mapContainer.appendChild(this.htmlContainerInMap),this.htmlContainerOutMap=document.createElement("div"),this.htmlContainerOutMap.style.position="absolute",this.htmlContainerOutMap.style.left="0",this.htmlContainerOutMap.style.top="0",this.htmlContainerOutMap.style.width="100%",this.htmlContainerOutMap.style.height="0",this.mapContainer.after(this.htmlContainerOutMap)}setCanvasSize(e,n){const i=window.devicePixelRatio;return this.canvas.width=e*i,this.canvas.height=n*i,this.canvas.style.width=e+"px",this.canvas.style.height=n+"px",this}destroy(){for(;this.externalContainer.lastChild;)this.externalContainer.removeChild(this.externalContainer.lastChild)}isActionWithCanvas(e){return e.target===this.canvas}isActionWithMap(e){return e instanceof MouseEvent||e instanceof KeyboardEvent?this.isTargetInMap(e.target):Array.from(e.touches).map(i=>i.target).some(i=>this.isTargetInMap(i))}isTargetInMap(e){return!e||!(e instanceof Node)?!1:this.mapContainer.contains(e)}}class jN{constructor(e){this.loadingCounter=0,this.isIdle=()=>this.loadingCounter===0,this.modules=e,this.textureKeys=[],this.texturesMap=new Map}async addTexture(e,n){this.loadingCounter++;const i=await vh(e);return this.storeTexture(i,n)}addPreparedTexture(e){const n=`prepared-${mo()}`;return this.textureKeys.push(n),this.texturesMap.set(n,e),this.textureKeys.length-1}updatePreparedTexture(e,n){this.deleteTexture(e),this.texturesMap.set(this.textureKeys[e],n)}async loadTexture(e,n){this.loadingCounter++;const i=await this.loadImage(e);if(!i){this.decreaseLoadingCounter();return}return this.storeTexture(i,n)}getTexture(e){return this.texturesMap.get(this.textureKeys[e])}destroy(){this.textureKeys=[],this.texturesMap.clear()}deleteTexture(e){var i;const n=this.textureKeys[e];return(i=this.texturesMap.get(n))==null||i.remove(),this.texturesMap.delete(n)}getMemoryFootprint(){const e={texturesMap:Array.from(this.texturesMap.values()).map(zc)},n={texturesMap:Array.from(this.texturesMap.values()).map(Tf)};return{js:{...e,"--sum":Mn(e)},gpu:{...n,"--sum":Mn(n)}}}decreaseLoadingCounter(){this.loadingCounter=Math.max(this.loadingCounter-1,0)}storeTexture(e,n){const i=n==null?void 0:n.size,o=(n==null?void 0:n.pixelRatio)??window.devicePixelRatio,r=(n==null?void 0:n.imagePadding)??1;this.decreaseLoadingCounter();const s=e.getAttribute("src")||e.currentSrc,a=$N(s,i),l=this.textureKeys.indexOf(a);if(l>-1&&this.texturesMap.has(a))return l;const c=this.modules.renderer.getRenderingContext(),d=(i?[i[0],i[1]]:[e.width,e.height]).map(_=>_*o),u=tw(e,d);e.remove();const f=d.map(_=>_+2*r);if(!(n!=null&&n.skipAtlasSizeChecking)&&(f[0]>tn[0]||f[1]>tn[1]))throw new Error(`Image texture dimensions ${f} are larger than the maximum possible ${tn}`);const h=new j(void 0,{size:f,flipY:!1,magFilter:j.LinearFilter,minFilter:j.LinearFilter}).prepare(c);return h.subImage(c,u,r,r),u.remove(),this.texturesMap.set(a,h),this.textureKeys.push(a),this.modules.renderer.addRerenderEvent(),this.textureKeys.length-1}async loadImage(e){return new Promise(n=>{const i=new Image;i.crossOrigin="Anonymous",i.src=e,i.onload=()=>n(i),i.onerror=()=>n(void 0)})}}function $N(t,e){const n=e!==void 0?`_${e[0]},${e[1]}`:"";return`${t}${n}`}const E2=!0,A2=!1,C2=!1,P2=[0];class WN{constructor(e){this.isLoading=!1,this.attempts=0,this.getKeyInfo=async()=>await this.request,this.isIdle=()=>!this.isLoading;const{tileKey:n,keyUrl:i}=e;if(n===qe.tileKey)this.request=Promise.resolve({showCommPoi:!1,urbi:!1,hideCopyright:!0});else{const o=Zc(i,{keyID:n});this.isLoading=!0;const r=async()=>P2.length>=this.attempts?(this.attempts&&(await new Promise(s=>{this.lastTimeout=window.setTimeout(s,P2[this.attempts]*1e3)}),this.clearLastTimeout()),this.attempts++,fetch(o).then(s=>s.ok?s.json():r(),r)):(console.error("Could not load tile key info. A style layers with commercial POI will be added to applied styles."),Promise.resolve(void 0));this.request=r().then(s=>{if(this.isLoading=!1,!s||!s.result||s.meta.code!==200)return{showCommPoi:E2,hideCopyright:C2,urbi:A2,error:!0};const{showCommPoi:a,hideCopyright:l,urbi:c}=s.result.service.properties.public;return{showCommPoi:Th(a)?E2:!!a,hideCopyright:Th(l)?C2:!!l,urbi:Th(c)?A2:!!c}})}}destroy(){this.clearLastTimeout()}clearLastTimeout(){this.lastTimeout!==void 0&&(clearTimeout(this.lastTimeout),this.lastTimeout=void 0)}}class ZN{constructor(){this.sources=[],this.viewportSources=[]}addSource(e){this.sources.push(e),e.type==="geojson"&&e.subtype==="viewport-internal"&&e instanceof hb&&this.viewportSources.push(e)}removeSource(e){this.sources=this.sources.filter(n=>n.getId()!==e),this.viewportSources=this.viewportSources.filter(n=>n.getId()!==e)}getSourceById(e){return this.sources.find(n=>n.getId()===e)}updateViewportSources(){this.viewportSources.forEach(e=>e.update())}}class XN{constructor(e){this.modules=e,this.id=Rs(),this.type="globe"}destroy(){}update(){}fetchTile(e,n){return Promise.resolve([])}generateTile(e,n,i,o,r,s){const a=Ct(n),l=this.modules.collector,c=this.modules.styleManager.getStyle(i);if(!c||!c.environment)return Promise.resolve({results:[]});io({collector:l,generator:tl.sinks.fill.generate,args:[c,c.environment,a]});const d=l.getAccumulatedData();return Promise.resolve({results:[{styleId:i,metatileHash:-1,regionId:-1,collectorOutput:d}]})}abortTileFetch(e){}deleteTile(e){}setAttributes(e){}getAttributes(){return{}}}const L2="gltfModels";class YN{constructor(e,n){this.modules=n,this.type="default",this.id=Rs(),this.state=e,this.options={tileServer:e.tileServer,tileSet:e.tileSet,tileProtocol:e.tileProtocol,tileKey:e.tileKey,subdomains:e.subdomains,appId:e.appId,defaultLang:e.tileServerDefaultLang,sessionId:e.tileSessionId??e.sessionId,isDefaultSource:!0,modelsPath:e.defaultSourceModelsRootUrl,promoteId:"id",idScope:Yo,identifyAsDefaultSource:!0},this.modelsAppearStrategy=e.defaultSourceModelsAppearStrategy??f0,this.zenithSource=new Q5(this.id,this.modules,this.options),this.universeTileLayer=new Ro(0,qe.maxUniverseZoom,0,qe.maxUniverseZoom,this.modules,e,this.zenithSource,{requestOddTiles:e.mobileSdkMode}),this.universeTileLayer.getLabelingData=()=>{const i=Ro.prototype.getLabelingData.call(this.universeTileLayer);return this.regionalTileLayer.isBlank()||(i.labelsKeys=[]),i},this.modules.tileManager.addTileLayer(this.universeTileLayer),this.regionalTileLayer=new Ro(qe.maxUniverseZoom+1,qe.maxRegionalZoom,qe.maxUniverseZoom+1,qe.maxDetailLevel,this.modules,e,this.zenithSource,{requestOddTiles:e.mobileSdkMode}),this.modules.tileManager.addTileLayer(this.regionalTileLayer),this.commercialPoiSource=new up(this.id,this.modules,{url:Lh("commercialPoi",{host:e.tileServer,tileSet:e.commercialTileSet,protocol:qe.protocol,lang:e.lang}),flipY:!0,identifyAsDefaultSource:!0,promoteId:"db_id"}),this.commercialPoiTileLayer=new Ro(hc.minZoom,hc.maxZoom,hc.minZoom,Cf,this.modules,e,this.commercialPoiSource,{viewportPadding:xm}),this.modules.tileManager.addTileLayer(this.commercialPoiTileLayer),this.createModelsSource(),this.modules.sourceStorage.addSource(this)}destroyModelsSource(){this.modelsSource&&(this.modelsSource=null,this.modelsTileLayer&&this.modules.tileManager.removeTileLayer(this.modelsTileLayer))}createModelsSource(){this.modelsSource||(this.modelsSource=new up(this.id,this.modules,{minZoom:pa.minZoom,maxZoom:pa.maxZoom,url:Lh({url:this.state.modelsTilesUrl},{host:this.state.tileServer,tileSet:this.state.modelsTileSet,protocol:qe.protocol,lang:this.state.lang}),ignoreMissingTiles:!0,identifyAsDefaultSource:!0,promoteId:"building_id",modelsPath:this.state.defaultSourceModelsRootUrl??Lh("gltfModel",{host:this.state.tileServer,tileSet:this.state.tileSet,protocol:qe.protocol,lang:this.state.lang}),flipY:!0,attributes:{sourceName:L2}}),this.modelsTileLayer=new Ro(pa.minZoom,pa.maxZoom,pa.minZoom,qe.maxDetailLevel,this.modules,this.state,this.modelsSource,{viewportPadding:xm}),this.modules.tileManager.addTileLayer(this.modelsTileLayer))}getMemoryFootprint(){const e={regionalTileLayer:this.regionalTileLayer.memSizeJs(),universeTileLayer:this.universeTileLayer.memSizeJs(),modelsTileLayer:this.modelsTileLayer?this.modelsTileLayer.memSizeJs():{},...this.commercialPoiTileLayer&&{commercialPoiTileLayer:this.commercialPoiTileLayer.memSizeJs()}},n={regionalTileLayer:this.regionalTileLayer.memSizeGpu(),universeTileLayer:this.universeTileLayer.memSizeGpu(),modelsTileLayer:this.modelsTileLayer?this.modelsTileLayer.memSizeGpu():{},...this.commercialPoiTileLayer&&{commercialPoiTileLayer:this.commercialPoiTileLayer.memSizeGpu()}};return{js:{...e,"--sum":Mn(e)},gpu:{...n,"--sum":Mn(n)}}}destroy(){var e,n;this.modules.tileManager.removeTileLayer(this.universeTileLayer),this.universeTileLayer.destroy(),this.modules.tileManager.removeTileLayer(this.regionalTileLayer),this.regionalTileLayer.destroy(),this.zenithSource.destroy(),this.commercialPoiTileLayer&&(this.modules.tileManager.removeTileLayer(this.commercialPoiTileLayer),this.commercialPoiTileLayer.destroy()),(e=this.commercialPoiSource)==null||e.destroy(),this.modelsTileLayer&&(this.modules.tileManager.removeTileLayer(this.modelsTileLayer),this.modelsTileLayer.destroy()),(n=this.modelsSource)==null||n.destroy(),this.modules.sourceStorage.removeSource(this.id),this.removeGlobeSource()}setAttributes(e){var n,i,o;this.zenithSource.setAttributes({...e,...M3}),this.universeTileLayer.redraw(),this.regionalTileLayer.redraw(),(n=this.commercialPoiSource)==null||n.setAttributes(e),(i=this.commercialPoiTileLayer)==null||i.redraw(),(o=this.modelsSource)==null||o.setAttributes({...e,sourceName:L2}),this.modelsTileLayer&&this.modelsTileLayer.redraw()}getAttributes(){return this.zenithSource.getAttributes()}getId(){return this.id}getZoomDirection(){return this.regionalTileLayer.getZoomDirection()}setHoverId(e){this.regionalTileLayer.setHoverId(e)}setDisabledRegionsId(e){this.regionalTileLayer.disabledRegions=e,this.universeTileLayer.disabledRegions=e}resetHoverId(){this.regionalTileLayer.resetHoverId()}setFeatureStateMap(e){var n,i;this.zenithSource.setFeatureStateMap(e),(n=this.modelsSource)==null||n.setFeatureStateMap(e),this.universeTileLayer.onFeatureStateMapChange(),this.regionalTileLayer.onFeatureStateMapChange(),(i=this.modelsTileLayer)==null||i.onFeatureStateMapChange(),this.modules.modelLayer.onFeatureStateMapChange()}generateHoverTile(e,n,i,o,r,s,a,l){return this.zenithSource.generateTile(e,n,i,o,r,s,a,l)}generateModel(e){return this.zenithSource.generateModel(e)}isIdentifiedAsDefault(){return!0}setDataType(e){this.options.dt!==e&&(!this.options.dt||!e||!h3(this.options.dt,e))&&(this.options.dt=e,this.regionalTileLayer.redraw())}getDataType(){return this.options.dt}setDataFilter(e){var n;this.zenithSource.setDataFilter(e),(n=this.modelsSource)==null||n.setDataFilter(e)}hasLayer(e){return this.modelsTileLayer===e||this.regionalTileLayer===e||this.universeTileLayer===e||this.commercialPoiTileLayer===e}addGlobeSource(){const{modules:e}=this,n=e.map.state;e.styleManager.getStyleLayer(n.handyStyleId,Gs)&&(this.globeSource=new XN(this.modules),this.globeTileLayer=new Ro(n.minZoom,$o.globeMaxZoom,n.minZoom,$o.globeMaxZoom,e,e.map.state,this.globeSource),e.tileManager.addTileLayer(this.globeTileLayer))}removeGlobeSource(){this.globeSource&&(this.globeSource.destroy(),this.globeSource=void 0),this.globeTileLayer&&(this.modules.tileManager.removeTileLayer(this.globeTileLayer),this.globeTileLayer.destroy(),this.globeTileLayer=void 0)}isGlobeTilesReady(){return this.globeTileLayer?this.globeTileLayer.viewportTilesReady()&&!this.globeTileLayer.isEmpty():!1}}const qN={dead:!0,alive:!0,unused:!0,commercialDead:!1,commercialAlive:!1};class KN{constructor(e,n){this.mapState=e,this.modules=n,this.options={},this.viewportDiffer=new Kt([{path:"center",type:"vec2"},{path:"zoom",type:"number"},{path:"size",type:"vec2"},{path:"rotation",type:"number"},{path:"pitch",type:"number"},{path:"padding",type:"padding"},{path:"demMode",type:"boolean"}]),this.sizeDiffer=new Kt([{path:"size",type:"vec2"}])}update(){this.isEnabled()&&(this.sizeDiffer.check(this.mapState)&&this.updateSize(),this.viewportDiffer.check(this.mapState)&&this.clear())}isEnabled(){return!!this.canvas}show(e=qN){this.options=e,Object.values(e).every(i=>i===!1)?this.hide():(this.createCanvas(),this.mapState.needLabeling=!0)}hide(){this.canvas&&(this.modules.layout.mapContainer.removeChild(this.canvas),this.ctx=void 0,this.canvas=void 0)}drawLabels(e){if(!this.canvas||!this.ctx)return;const n=this.ctx,i=this.options,o={[Ln.Dead]:"#ff0000",[Ln.Alive]:"#30763c",[Ln.Unused]:"#aaa",[Ln.CommercialAlive]:"#3a9f22",[Ln.CommercialDead]:"#ff0000"},r=new Int32Array(e),s={[Ln.Dead]:[],[Ln.Alive]:[],[Ln.Unused]:[],[Ln.CommercialAlive]:[],[Ln.CommercialDead]:[]};for(let c=0;c<r.length;c+=5){const d=r[c+4];s[d].push({x:r[c],y:r[c+1],width:r[c+2],height:r[c+3]})}this.clear();const a=window.devicePixelRatio,l=c=>{n.strokeStyle=o[c],s[c].forEach(d=>n.strokeRect(d.x*a+.5,d.y*a+.5,d.width*a,d.height*a))};n.setLineDash([]),i.unused&&l(Ln.Unused),i.dead&&l(Ln.Dead),i.alive&&l(Ln.Alive),n.setLineDash([6]),i.commercialDead&&l(Ln.CommercialDead),i.commercialAlive&&l(Ln.CommercialAlive)}clear(){if(this.canvas&&this.ctx){const{clientWidth:e,clientHeight:n}=this.canvas;this.ctx.clearRect(0,0,e*window.devicePixelRatio,n*window.devicePixelRatio)}}createCanvas(){this.canvas||(this.canvas=document.createElement("canvas"),this.canvas.style.position="absolute",this.canvas.style.left="0",this.canvas.style.top="0",this.canvas.style.pointerEvents="none",this.modules.layout.mapContainer.appendChild(this.canvas),this.ctx=this.canvas.getContext("2d")||void 0,this.updateSize())}updateSize(){if(!this.canvas)return;const{clientWidth:e,clientHeight:n}=this.modules.layout.rootContainer;this.canvas.width=e*window.devicePixelRatio,this.canvas.height=n*window.devicePixelRatio,this.canvas.style.width=e+"px",this.canvas.style.height=n+"px"}}const JN=Ke();class QN{constructor(e){this.globHaloStops=[-2.5,0,1.5,13],this.globeHaloExpFactor=-1,this.fogLimits=new Float32Array([3.7,4.5]),this.fogHorizonBlend=.12,this.fogHorizonLevel=-.07,this.squaredDistMaxFog=0,this.lastStyleId=NaN,this.starsCount=2e4,this.starsGenerationCtx={randomSeed:12345},this.starsUpdateNeeded=!0,this.modules=e;const n=this.modules.renderer.getShaderProgram("sky"),i=new F(new Float32Array([-1,-1,1,-1,1,1,-1,1]));this.vao=dL(i,n)}update(){this.updateFog();const e=this.modules.map.state;isNaN(e.handyStyleId)||this.lastStyleId!==e.handyStyleId&&(this.updateSky(),this.updateStars(),this.lastStyleId=e.handyStyleId)}setParameters(e){const n=this.modules.map.state;e.min!==void 0&&(this.fogLimits[0]=e.min),e.max!==void 0&&(this.fogLimits[1]=e.max),e.horizonBlend!==void 0&&(this.fogHorizonBlend=e.horizonBlend),e.horizonLevel!==void 0&&(this.fogHorizonLevel=e.horizonLevel);const i=this.modules.styleManager.getStyleLayer(n.handyStyleId,Gs);i&&(e.fogColor!==void 0&&(i.style.fogColor=uo(e.fogColor)?fo(e.fogColor):e.fogColor),e.skyColor!==void 0&&(i.style.skyColor=uo(e.skyColor)?fo(e.skyColor):e.skyColor),this.modules.renderer.addRerenderEvent())}renderSky(e){if(!this.isSkyEnabled())return;const n=this.modules.renderer.webGlExtensions,i=this.modules.renderer.lastAppliedGlState;Oi(e,yn,i);const o=this.modules.renderer.getShaderProgram("sky");o.enable(e),e instanceof WebGLRenderingContext&&(Pb(e,o,this.modules.map.state,this.modules),xe(e,o,this.modules.map.state,this.modules),we(e,o,this.modules.map.state,this.modules)),this.vao.bind({gl:e,extensions:n}),e.drawArrays(e.TRIANGLE_FAN,0,4)}renderStars(e){if(!this.starsVao)return;const n=this.modules.renderer.lastAppliedGlState;Oi(e,yn,n);const i=this.modules.renderer.getShaderProgram("stars");i.enable(e),e instanceof WebGLRenderingContext&&Lb(e,i,this.modules.map.state,this.modules),this.starsVao.bind({gl:e,extensions:this.modules.renderer.webGlExtensions}),e.drawArrays(e.POINTS,0,this.starsCount)}renderGlobeHaloBackground(e){const n=this.modules.renderer.webGlExtensions,i=this.modules.renderer.lastAppliedGlState;Oi(e,yn,i);const o=this.modules.renderer.getShaderProgram("globeHaloBackground");o.enable(e),e instanceof WebGLRenderingContext&&Sp(e,o,this.modules.map.state,this.modules),this.vao.bind({gl:e,extensions:n}),e.drawArrays(e.TRIANGLE_FAN,0,4)}renderGlobeHalo(e){const n=this.modules.renderer.webGlExtensions,i=this.modules.renderer.lastAppliedGlState;Oi(e,CL,i);const o=this.modules.renderer.getShaderProgram("globeHalo");o.enable(e),e instanceof WebGLRenderingContext&&Sp(e,o,this.modules.map.state,this.modules),this.vao.bind({gl:e,extensions:n}),e.drawArrays(e.TRIANGLE_FAN,0,4)}isFogEnabled(){var r,s;if(this.modules.map.getFeatureFlag("fogOff")||!((r=this.envStyleLayer)!=null&&r.style.fogColor))return!1;const{styleZoom:e,styleState:n}=this.modules.map.state,i=ht(e,n,[]),o=Le((s=this.envStyleLayer)==null?void 0:s.style.fogColor,i);return o&&o.value[3]!==0}isSkyEnabled(){var r,s;if(this.modules.map.getFeatureFlag("skyOff")||!((r=this.envStyleLayer)!=null&&r.style.skyColor))return!1;const{styleZoom:e,styleState:n}=this.modules.map.state,i=ht(e,n,[]),o=Le((s=this.envStyleLayer)==null?void 0:s.style.skyColor,i);return o&&o.value[3]!==0}isPointInFog(e){const n=this.modules.camera;return Ex(e,n.position)>this.squaredDistMaxFog}isAABBInFog(e){if(!this.modules.environmentManager.isFogEnabled())return!1;const n=this.modules.camera,i=g3(n.position,e.min,e.max,JN);return this.isPointInFog(i)}updateSky(){const e=this.modules.styleManager.getStyleLayer(this.modules.map.state.handyStyleId,Gs);this.envStyleLayer=e}updateStars(){if(!this.starsUpdateNeeded)return;this.starsUpdateNeeded=!1;const e=dM(this.starsGenerationCtx,this.starsCount),n=4,i=new Float32Array(n*e.length);for(let s=0;s<e.length;++s){const a=e[s],l=gf(this.starsGenerationCtx,0,1);i[n*s]=a[0],i[n*s+1]=a[1],i[n*s+2]=a[2],i[n*s+3]=l}const o=new F(i),r=this.modules.renderer.getShaderProgram("stars");this.starsVao=fL(o,r)}updateFog(){const e=this.modules.camera;this.squaredDistMaxFog=(e.fogDistance*this.fogLimits[1])**2}}class eU{constructor(e,n){this.mapState=e,this.mapModules=n,this.state={}}add(e,n=0,i=1,o=Wa.easing,r=Wa.duration){this.state[e]||(this.state[e]={tickerConfig:{start:n,end:i,duration:r,easing:o},tickerKey:"",readiness:n===i?1:0})}has(e){return!!this.state[e]}remove(e){this.state[e]&&delete this.state[e];const n=this.buildTickerKey(e);S0(n,this.mapState)&&It(n,this.mapState)}getReadiness(e){var n;return(n=this.state[e])==null?void 0:n.readiness}isAnimating(e){if(!e){for(const n in this.state)if(Ic(this.state[n].tickerKey,this.mapState)!==void 0)return!0;return!1}return this.state[e]?Ic(this.state[e].tickerKey,this.mapState)!==void 0:!1}update(){const e=[];for(const n in this.state){const i=this.state[n];if(this.mapModules.tileManager.viewportTilesReady()){const o=i.readiness,{start:r,end:s,duration:a,easing:l}=i.tickerConfig;if(i.tickerKey)xt(i.tickerKey,{step:(c,d)=>{i.readiness=d}},this.mapState);else{const c=this.buildTickerKey(n);i.tickerKey=c,At(c,{easing:l},this.mapState,r,s,a,1)}i.readiness===1&&o!==1&&e.push(n)}}return e}buildTickerKey(e){return`gltf-${e}`}}const tU=!1,nU=!0,lm="#ffffffff",iU=0,oU=0,rU=1,Up=15,sU=Nt(Up)/He,Pu=Se/2,aU=["coordinates","rotation","scale","offset"];class Nf extends Kc{constructor(e,n){var x,I,E;super(e,{interactive:n.interactive??!1}),this.map=e,this.needRerender=()=>this.isVisible()&&Ec(Um(this.position.normalizedValue),this.mapState.tilesBounds,this.modules,xm),this.hovered=!1,this.selected=!1,this.status=n.hideOnInit?"hidden":"visible",this.interactiveOcclusion=n.interactiveOcclusion??nU,this.throttledIdentifierUpdate=n.throttledIdentifierUpdate??tU,this.disableAnimation=n.disableAnimation,this.linkedIds=n.linkedIds,this.planId=n.planId,this.tickerNames=new Map;const i=q.fromGeo(n.coordinates);this.position={userValue:i,normalizedValue:$r(i)};const{dynamicStyle:o,collector:r,tileManager:s,layers:a,assetManager:l}=this.modules,{ignoreGlobalLighting:c,colorTextureUvIndex:d,nearCameraFade:u,showRatio:f,playAnimation:h}=n,_=z2(n.rotation??iU),p=n.scale??rU,m=B2(n.offset??oU,n.coordinates[1]);if(this.appliedTransformations={scale:p,rotation:_,offset:m},this.layer=qi({type:"model",id:`dynamic-gltf-model-${this.uniqId}`,style:{modelSrc:["get","model_src"],rotation:Array.isArray(_)?["literal",_]:_,scale:Array.isArray(p)?["literal",p]:p,offset:Array.isArray(m)?["literal",m]:m,linkedIds:["get","linkedIds"],ignoreGlobalLighting:c,colorTextureUvIndex:d,nearCameraFade:u,showRatio:f,playAnimation:h,color:["match",["objectAttr","hovered"],[!0],((x=n.hover)==null?void 0:x.color)||lm,["match",["objectAttr","selected"],[!0],((I=n.select)==null?void 0:I.color)||lm,n.color||lm]]},minzoom:n.minZoom,maxzoom:n.maxZoom,interactive:this.interactive,interactiveOcclusion:this.interactiveOcclusion}),!this.layer)return;(E=n.hover)!=null&&E.color&&(this.on("mouseover",this.switchToHoveredColor),this.on("mouseout",this.switchToNormalColor)),o.addLayer(this.layer,n.zIndex);const g=qa(this.position.normalizedValue,Up),y=mh({model_src:n.modelSrc,linkedIds:n.linkedIds,db_plan_id:n.planId}),b=Zo(this.mapState.styleState,ul,Ho,y,Wc,n.interactive?"0":"");vr(this.layer,b),io({collector:r,generator:Ni.generateInstances,args:[o.getStyle(),this.layer,b,{x:[Pu],y:[Pu],abs_z:[this.position.userValue[2]??0]},Ct(g),NaN]});const v=r.getAccumulatedData(),T=new bi("dynamicObject",v.data,this.modules,this.mapState,g,this);l.fillDataModelUrlMap(v.dataModelsUrls),this.modelId=v.dataModelsUrls[n.modelSrc],this.modelId!==void 0&&(l.loadModel(n.modelSrc,this.modelId,Kr,!0,this.layer,()=>{this.status==="visible"&&(s.addObject(T),this.modules.renderer.addRerenderEvent(),this.linkedIds&&this.map.hideBuildingsById(this.linkedIds),this.updateIdentifier()),setTimeout(()=>this.emit("modelloaded"),0)}),this.tileObjects.push(T),n.interactive&&this.identifyIds.push(v.identifyIds),a.addLayer(this),r.reset(),this.status==="visible"&&this.hideLinkedObjects())}update(){if(super.update(),!this.tickerNames.size)return;const e=[],n={};this.tickerNames.forEach((i,o)=>{xt(i,{step:(r,s)=>{n[o]=s},complete:()=>{e.push(o)}},this.mapState)}),(n.coordinates!==void 0||n.rotation!==void 0||n.scale!==void 0||n.offset!==void 0)&&this.applyTransformations(n.coordinates,n.rotation,n.scale,n.offset),e.forEach(i=>{this.tickerNames.delete(i)}),this.interactive&&this.needRerender()&&(this.throttledIdentifierUpdate?this.mapState.stillness===1&&this.modules.identifier.throttledFillCache():this.tickerNames.size||this.modules.identifier.debouncedFillCache())}setState({hovered:e,selected:n}){e!==void 0&&e!==this.hovered&&(this.hovered=e,this.modules.renderer.addRerenderEvent()),n!==void 0&&n!==this.selected&&(this.selected=n,this.modules.renderer.addRerenderEvent())}isAnimationDisabled(){return this.disableAnimation}getLinkedIds(){return this.linkedIds}isVisible(){return this.status==="visible"}hide(){this.status==="visible"&&(this.status="hidden",this.tileObjects.forEach(e=>{this.modules.tileManager.removeObject(e)}),this.showHiddenBuildings(),this.showLinkedObjects(),this.mapState.shouldIsIdleWaitForUpdates=!0,this.modules.renderer.addRerenderEvent(),this.updateIdentifier())}isOutOfMainReplica(){return!1}show(){this.status==="hidden"&&(this.status="visible",this.tileObjects.forEach(e=>{this.modules.tileManager.addObject(e)}),this.linkedIds&&this.map.hideBuildingsById(this.linkedIds),this.hideLinkedObjects(),this.mapState.shouldIsIdleWaitForUpdates=!0,this.modules.renderer.addRerenderEvent(),this.updateIdentifier())}destroy(e){this.status!=="destroyed"&&(this.stopTransformation(),this.status="destroyed",this.modelId!==void 0&&!this.modules.layers.getDynamicObjectLayers().filter(i=>i instanceof Nf&&i!==this).some(i=>i.modelId===this.modelId)&&!e&&this.modules.assetManager.removeModel(String(this.modelId)),this.updateIdentifier(),this.layer&&this.modules.dynamicStyle.removeLayer(this.layer.innerId),this.showHiddenBuildings(),this.off("mouseover",this.switchToHoveredColor),this.off("mouseout",this.switchToNormalColor),this.showLinkedObjects(),super.destroy())}transform(e){var o;if(this.status==="destroyed"||!this.layer)return;this.stopTransformation();const n={};e.forEach(r=>{const s=cU(r);if(!s)return;const{duration:a=0,easing:l="linear"}=r;n[s]={value:r[s],duration:a,easing:l}});const i={};for(const r in n){if(!lU(r)||n[r]===void 0)continue;let s;if(r==="coordinates"?s=q.fromGeo(n[r].value):r==="offset"?s=B2(n[r].value,((o=n.coordinates)==null?void 0:o.value[1])??q.toGeo(this.position.userValue)[1]):s=n[r].value,!n[r].duration){i[r]=s;continue}const a=`dynamicGltfModel-${r}-${this.uniqId}`;let l,c;if(r==="coordinates")l=this.position.userValue,c=s;else{const d=[0,0,0];Wi(this.appliedTransformations[r],d),l=d;const u=[0,0,0];Wi(s,u),c=u}At(a,{easing:n[r].easing,renderAfterUpdate:this.needRerender},this.mapState,l,c,n[r].duration,1,{layerId:this.layer.innerId,styleId:Kr}),this.tickerNames.set(r,a)}(i.coordinates!==void 0||i.rotation!==void 0||i.scale!==void 0||i.offset!==void 0)&&(this.applyTransformations(i.coordinates,i.rotation,i.scale,i.offset),this.modules.renderer.addRerenderEvent(),this.updateIdentifier())}stopTransformation(){this.tickerNames.forEach(e=>{It(e,this.mapState)}),this.tickerNames.clear()}getCoordinates(){return q.toGeo(this.position.userValue)}getScale(){const e=[0,0,0];return Wi(this.appliedTransformations.scale,e),e}getRotation(){const e=[0,0,0];return Wi(this.appliedTransformations.rotation,e),e}getOffset(){const e=[0,0,0];return Wi(this.appliedTransformations.offset,e),e}applyTransformations(e,n,i,o){var l;const r=this.tileObjects[0];if(!r)return;const s=r.buffers[0];if(!s)return;if(e&&(this.position={userValue:e,normalizedValue:$r(e)},r.setTileCoords(qa(this.position.normalizedValue,Up),this.mapState)),n!==void 0||i!==void 0){const c=z2(n??this.appliedTransformations.rotation),d=i??this.appliedTransformations.scale;this.appliedTransformations.rotation=c,this.appliedTransformations.scale=d}if(o!==void 0){const c=o??this.appliedTransformations.offset;this.appliedTransformations.offset=c}const a=this.modules.renderer.getRenderingContext();Wi(this.appliedTransformations.offset,R2),Wi(this.appliedTransformations.scale,F2),Wi(this.appliedTransformations.rotation,k2),Ni.patchBuffer(a,s,0,Ct(r.coords),[Pu,Pu,this.position.userValue[2]??0],R2,F2,k2,(((l=this.layer)==null?void 0:l.minzoom)??0)<$o.globeMaxZoom)}switchToHoveredColor(){this.hovered=!0,this.modules.renderer.addRerenderEvent()}switchToNormalColor(){this.hovered=!1,this.modules.renderer.addRerenderEvent()}updateIdentifier(){this.interactive&&this.modules.identifier.resetCache()}showLinkedObjects(){const e=this.planId?tp:np;this.linkedIds&&this.modules.identifier.getIdScope(e).show(this.linkedIds)}hideLinkedObjects(){const e=this.planId?tp:np;this.linkedIds&&this.modules.identifier.getIdScope(e).hide(this.linkedIds)}showHiddenBuildings(){if(!this.linkedIds)return;const e=this.modules.layers.getDynamicObjectLayers().filter(n=>n instanceof Nf&&n!==this&&n.isVisible());this.linkedIds.forEach(n=>{e.every(o=>{var r;return!((r=o.getLinkedIds())!=null&&r.includes(n))})&&this.map.showHiddenBuildingsById([n])})}}const F2=[0,0,0],k2=[0,0,0],R2=[0,0,0];function z2(t){return Array.isArray(t)?t.map(e=>e%360):t%360}function B2(t,e){const n=sU/q.scaleFactor(e),i=["x","y"].filter((o,r)=>{const s=Array.isArray(t)?t[r]:t;return s<-n||s>n});return i.length&&console.warn(`
            The offset is too big along ${i.map(o=>`${o}-axis`).join(" and ")} at the current latitude.
            Please, use more accurate coordinates to place the model.
        `),Array.isArray(t)?[t[0]%n,t[1]%n,t[2]]:[t%n,t%n,t]}function lU(t){return aU.includes(t)}function cU(t){if("coordinates"in t)return"coordinates";if("rotation"in t)return"rotation";if("scale"in t)return"scale";if("offset"in t)return"offset"}const dU=[0,0,0],uU=[0,0,0],fU=[0,0,0],hU="modelshow",_U="modelhide",Lu=0,O2=.1;class mU{constructor(e,n){this.sceneObjects=new Map,this.sceneObjectsVisibilityMap=new Map,this.viewportDiffer=new Kt([{path:"center",type:"vec3"},{path:"zoom",type:"number"},{path:"size",type:"vec2"},{path:"rotation",type:"number"},{path:"pitch",type:"number"},{path:"padding",type:"padding"},{path:"demMode",type:"boolean"},{path:"elevation",type:"number"},{path:"minElevation",type:"number"}]),this.mapState=e,this.mapModules=n,this.modelsAnimator=new eU(e,n),this.modelInfo={},this.buildingIds=new Set,this.objectIdToLayerModelKey={},this.linkedIdToObjectId={},this.layerModelKeyBySourceTile=new Map,this.disabled=!1}addLayerModelToSourceTileMap(e){const n=fs(e.attributes),i=cm(e.attributes.styleId,e.attributes.sourceId,e.tile.coords),o=this.layerModelKeyBySourceTile.get(i);o?o.add(n):this.layerModelKeyBySourceTile.set(i,new Set([n]))}clearSourceTileMapByTiles(e,n){n.map(i=>cm(this.mapState.handyStyleId,e,i.coords)).forEach(i=>this.layerModelKeyBySourceTile.delete(i))}clearSourceTileMapBySource(e){Array.from(this.layerModelKeyBySourceTile).map(i=>i[0]).filter(i=>i.split("_")[1]===String(e)).forEach(i=>this.layerModelKeyBySourceTile.delete(i))}getCurrentLayerModelId(e,n){var o;const i=fs(e);return(o=this.modelInfo[i])==null?void 0:o.modelIds[n.id]}getModelOpacity(e){if(e===void 0)return Lu;const n=fs(e.attributes);return n?this.modelsAnimator.getReadiness(n)??Lu:Lu}getModelHeightFactor(e){if(!e)return 1;const n=fs(e.attributes);return this.modelsAnimator.getReadiness(n)??1}isAnimating(e){if(!e)return this.modelsAnimator.isAnimating();const n=this.linkedIdToLayerModelKey(e);return n?this.modelsAnimator.isAnimating(n):!1}objectIdToKey(e){return this.objectIdToLayerModelKey[e]}update(){this.syncStateWithSceneObjects(),this.modelsAnimator.update().length&&this.addNewSceneObjectsToVisibilityMap(),this.viewportDiffer.check(this.mapState)&&this.checkSceneObjectsVisibilityMap(),this.updateObjectsVisibility()}addSceneObject(e){const n=fs(e.attributes);let i=this.modelInfo[n];i?this.objectIdToLayerModelKey[e.id]||this.indexateObject(n,e,i):i=this.addLayerModel(e,n),i&&(i.modelIds[e.tile.id]=e.renderingProperties.modelId,this.sceneObjects.set(e.id,e),this.addLayerModelToSourceTileMap(e))}removeSceneObject(e){this.sceneObjects.delete(e)}allObjectsHaveCurrentModelId(e,n,i){var s;const o=cm(i,e,n),r=this.layerModelKeyBySourceTile.get(o);if(!r)return!0;for(const a of r){const l=(s=this.modelInfo[a])==null?void 0:s.modelIds;if(!l)return!1;for(const c in l)if(l[c]===void 0)return!1}return!0}finishStyleUpdating(){Array.from(this.layerModelKeyBySourceTile).map(n=>n[0]).filter(n=>n.split("_")[0]!==String(this.mapState.handyStyleId)).forEach(n=>this.layerModelKeyBySourceTile.delete(n))}updateModelId(e,n,i,o,r){const{assetManager:s,sourceStorage:a,styleManager:l,camera:c}=this.mapModules,d=this.mapState;e.modelId=void 0;const{styleId:u,layerId:f,sourceId:h,modelIndices:_,modelStepValues:p,modelStepSource:m}=n;if(!_.length)return;let g;switch(m){case Yi.None:g=0;break;case Yi.Zoom:g=Bw(p,d.styleZoom);break;case Yi.Distance:g=pU(o,i,c.position,p,r);break;default:return}if(g===-1)return;const y=_[g];if(y===void 0)return;const b=s.getModel(y,u);if(b)switch(b.status){case ui.Loaded:e.modelId=y;return;case ui.Failed:e.modelId=NaN;return}else{const T=l.getStyleLayer(u,f),x=s.getDataModelUrlById(y);T&&!this.disabled&&(x===void 0?s.loadModelByIndex(y,u,T):x.length&&s.loadModel(x,y,u,!1,T))}if(_.length===1)return;const v=a.getSourceById(h);v&&(m===Yi.Zoom?e.modelId=this.getModelIdByZoom(v,n,o,g):m===Yi.Distance&&(e.modelId=this.getModelIdByDistance(n,o)))}getModelIdByDistance(e,n){return this.getCurrentModelId(e,n)}getModelIdByZoom(e,n,i,o){const{styleId:r,modelIndices:s}=n,a=e.getZoomDirection();if(a===Kn.Stationary)return this.getCurrentModelId(n,i);const l=s.slice(0,o).reverse(),c=s.slice(o+1),d=a===Kn.ZoomingIn?l.concat(c):c.concat(l);for(let u=0;u<d.length;u++){const f=this.mapModules.assetManager.getModel(d[u],r);if(f&&f.status===ui.Loaded)return d[u];if((f==null?void 0:f.status)===ui.Failed)return NaN}}getCurrentModelId(e,n){const i=this.getCurrentLayerModelId(e,n);if(!i)return;const o=this.mapModules.assetManager.getModel(i,e.styleId);if(o&&o.status===ui.Loaded)return i;if((o==null?void 0:o.status)===ui.Failed)return NaN}syncStateWithSceneObjects(){const e=new Set;if(this.disabled=this.mapModules.map.getFeatureFlag("modelsOff"),this.disabled){this.mapModules.defaultSource.destroyModelsSource();for(const i in this.modelInfo){const o=this.modelInfo[i];this.removeLayerModel(i,o)}return}for(const i of this.sceneObjects.values()){const o=fs(i.attributes),r=this.modelInfo[o],s=this.mapState.disableModelsGrowthAnimation||i.tile.dynamicObject instanceof Nf&&i.tile.dynamicObject.isAnimationDisabled();e.add(o),r&&!this.modelsAnimator.has(o)&&!this.disabled&&(this.mapModules.defaultSource.createModelsSource(),this.startAnimation(o,r,s)),this.modelInfo[o]?this.objectIdToLayerModelKey[i.id]||this.indexateObject(o,i,r):this.addLayerModel(i,o)}const n=this.mapState.styleZoom;for(const i in this.modelInfo){const o=this.modelInfo[i];e.has(i)?(n<o.layer.minzoom||n>=o.layer.maxzoom)&&this.removeLayerModel(i,o):this.removeLayerModel(i,o)}}addLayerModel(e,n){var r,s;const i=this.mapModules.styleManager.getStyleLayer(e.attributes.styleId,e.attributes.layerId);if(!i)return;const o={layer:i,ids:e.tile.ids,linkedIds:[],ownerIds:new Set,modelIds:{}};return o.buildingId=((r=e.meta)==null?void 0:r.buildingId)||"",(s=e.meta)!=null&&s.planId&&(o.planId=e.meta.planId),this.indexateObject(n,e,o),this.modelInfo[n]=o,o}startAnimation(e,n,i){if(i){this.modelsAnimator.add(e,1,1);return}const o=n.layer.minzoom??NaN;n.linkedIds.length>0&&this.mapModules.buildingHeightAnimator.getBuildingHeight(o)>.5?this.modelsAnimator.add(e,.5,1):this.modelsAnimator.add(e)}maybeEmitModelEvent(e,n,i){const o=!n.onKeyRemove&&!!i&&zs(i,{min:e.mapPoint,max:e.mapPoint}),r=e.visible;o!==r&&(e.visible=o,this.emitEvent(o&&!r?hU:_U,e))}addNewSceneObjectsToVisibilityMap(){var n,i,o,r;const e=this.mapModules.camera.getViewportVertices(O2);for(const s of this.sceneObjects.values())if((n=s.attributes)!=null&&n.emitShowHideEvents&&((i=s.meta)!=null&&i.buildingId)&&s.attributes.lngLat){const a=fs(s.attributes),l={visible:!1,mapPoint:q.fromGeo(s.attributes.lngLat),buildingId:((o=s.meta)==null?void 0:o.buildingId)||"",sublayer:((r=s.meta)==null?void 0:r.sublayer)||"",key:a};let c=this.sceneObjectsVisibilityMap.get(a);c||(c=new Map,this.sceneObjectsVisibilityMap.set(a,c)),c.get(s.meta.buildingId)||(c.set(s.meta.buildingId,l),this.maybeEmitModelEvent(l,{onKeyShow:!0},e))}}checkSceneObjectsVisibilityMap(){const e=this.mapModules.camera.getViewportVertices(O2);this.sceneObjectsVisibilityMap.forEach(n=>n.forEach(i=>this.maybeEmitModelEvent(i,{},e)))}indexateObject(e,n,i){var r,s;this.objectIdToLayerModelKey[n.id]=e,i.ownerIds.add(n.id),i.buildingId=((r=n.meta)==null?void 0:r.buildingId)||"",i.buildingId&&this.buildingIds.add(i.buildingId);const o=((s=n.meta)==null?void 0:s.linkedIds)??[];if(i.linkedIds.push(...o),n.tile.purpose!=="c3d")for(const a of o)this.linkedIdToObjectId[a]=n.id}removeLayerModel(e,n){var o;(o=n.ids)==null||o.show(n.linkedIds);for(const r of n.ownerIds)delete this.objectIdToLayerModelKey[r];n.buildingId&&this.buildingIds.delete(n.buildingId),this.modelsAnimator.remove(e);const i=this.sceneObjectsVisibilityMap.get(e);i&&(i.forEach(r=>this.maybeEmitModelEvent(r,{onKeyRemove:!0})),this.sceneObjectsVisibilityMap.delete(e)),delete this.modelInfo[e]}linkedIdToLayerModelKey(e){const n=this.linkedIdToObjectId[e];if(!n)return null;const i=this.objectIdToLayerModelKey[n];return i||null}emitEvent(e,n){const{buildingId:i,sublayer:o}=n;if(!o){console.warn(`No sublayer for model ${n.key}`);return}if(!i){console.warn(`No buildingId for model ${n.key}`);return}const r=b5(o);this.mapModules.map.emit(e,{sublayer:o,id:i,isCommercial:r})}updateObjectsVisibility(){const e=this.mapModules.identifier.getIdScope(np),n=this.mapModules.identifier.getIdScope(Yo);e.getHidden().forEach(i=>{n.hide([i],Qn.All)});for(const i in this.modelInfo){const o=this.modelInfo[i],r=o.ids;if(!r)continue;const s=this.modelsAnimator.getReadiness(i)??Lu;for(const a of o.linkedIds){if(r.isHidden(a))continue;const l=o.planId!==void 0?Qn.FloorPolygons:Qn.PolygonExtrusion,c=r.isHidden(a,l);s>.5&&!c?r.hide([a],l):s<.5&&c&&r.show([a])}}}}function fs(t){const{layerId:e,modelIndices:n}=t;return`${e}${n}`}function cm(t,e,n){return`${t}_${e}_${JSON.stringify(n)}`}function pU(t,e,n,i,o){const r=t.modelMatrices.get(0);if(!r)return-1;let s=e.min,a=e.max;o||(s=ii(uU,s,r),a=ii(fU,a,r));const l=g3(n,s,a,dU),c=q.toGeo(l),d=q.scaleFactor(c[1]),u=Qf(n,l)/He/d;return Bw(i,u)}function Bw(t,e){let n=0;for(;n<t.length&&!(e<t[n]);)n++;return n-1}const ua=1/0;class gU{constructor(e,n){this.prevFrameAnimationLayerindex=void 0,this.cacheObjectsCount=0,this.needRerenderCore=!1,this.animationLayersMinIndex=ua,this.state=e,this.modules=n,this.copyProgram=this.modules.renderer.getShaderProgram("copyDepth");const i=new F(new Uint8Array([-1,-1,1,-1,1,1,-1,1]));this.vao=uL(i,this.copyProgram),this.cacheFramebufferId=void 0,this.isReadyCache=!1,this._gl=this.modules.renderer.getRenderingContext(),this.isLowZoom=this.state.zoom<6,this.cacheDisabled=this.state.disableRenderingCache,this.animationLayersUniqueIds=new Set,this.needRerenderCore=!1,this.debugMode=!1}frameEnd(){this.needRerenderCore&&this.modules.renderer.addRerenderEvent()}initInDebugMode(){this.debugMode=!0}frameStart(){this.cacheObjectsCount=0,this.isLowZoom=this.state.zoom<6,this.isReadyCache=!1;let e=!1;this.needRerenderCore=!1,!this.cacheDisabled&&(this.animationLayersUniqueIds.clear(),this.cacheFramebufferId===void 0&&(this.cacheFramebufferId=this.createCacheFramebuffer()),this.animationLayersMinIndex=ua,this.state.rerenderEvents.forEach(n=>{if(n.type==="layerAnimationTicker"){const i=this.getUniqueRenderIndex(n.styleId,n.layerId);this.animationLayersUniqueIds.add(i),this.animationLayersMinIndex=Math.min(this.animationLayersMinIndex,i)}else e=!0}),this.animationLayersMinIndex!==ua&&this.animationLayersMinIndex===this.prevFrameAnimationLayerindex&&(this.isReadyCache=!0),(this.state.needRerender||e)&&(this.prevFrameAnimationLayerindex=void 0,this.isReadyCache=!1))}checkFlatObjectAnimation(e){const n=this.getUniqueRenderIndex(e.attributes.styleId,e.attributes.layerId);this.animationLayersUniqueIds.has(n)&&(this.needRerenderCore=!0)}tryToCacheObjects(e,n,i){return this.cacheDisabled||this.cacheFramebufferId===void 0||this.animationLayersMinIndex===ua||this.isLowZoom||this.getUniqueRenderIndex(n.attributes.styleId,n.attributes.layerId)>=this.animationLayersMinIndex?!1:(e[this.cacheFramebufferId]||(e[this.cacheFramebufferId]={framebuffer:this.modules.renderer.getFramebuffer(this.cacheFramebufferId),objects:[],tileObjects:new Set}),this.cacheObjectsCount++,this.isReadyCache||(e[this.cacheFramebufferId].objects.push(n),e[this.cacheFramebufferId].tileObjects.add(i)),!0)}hasReadyCache(){return this.isReadyCache&&!this.cacheDisabled}render(){var n;if(this.cacheDisabled)return!1;if(this.cacheFramebufferId===void 0||this.cacheObjectsCount===0||this.isLowZoom)return;this.prevFrameAnimationLayerindex=this.animationLayersMinIndex;const e=(n=this.modules.renderer.getFramebuffer(this.cacheFramebufferId))==null?void 0:n.renderTarget;e&&this.copyRenderTargetToCanvasTexture(this._gl,e)}destroy(){this.cacheFramebufferId=void 0,this.vao.remove()}getUniqueRenderIndex(e,n){const i=this.modules.styleManager.getStyleLayer(e,n);if(!i)return ua;const o=this.modules.styleManager.getMaxLayersCount();return-e*o+i.renderIndex}createCacheFramebuffer(){if(!this.isWebgl2Context()&&!this.modules.renderer.webGlExtensions.EXT_frag_depth){console.warn('Render cache disabled - WebGL extension "EXT_frag_depth" not available'),this.cacheDisabled=!0;return}const e=this.modules.renderer.getViewportSize(),n=this.modules.renderer.webglContextState.MAX_TEXTURE_SIZE;if(Math.max(...e)>n){ct(`Disabling post-effects as viewport size ${e[0]}x${e[1]} exceeds hardware limits of ${n}x${n}`),this.cacheDisabled=!0;return}const o=this._gl,{styleManager:r}=this.modules,s=j.NearestFilter,a=this.modules.renderer.getViewportSize(),l=new qt({size:[a[0],a[1]],magFilter:s,minFilter:s,wrapS:j.ClampToEdgeWrapping,wrapT:j.ClampToEdgeWrapping,depthTexture:!0,format:j.RgbaFormat});return this.modules.renderer.addFramebuffer({onResize:()=>{const c=this.modules.renderer.getViewportSize();l.setSize([c[0],c[1]]),l.bind(o),l.unbind(o)},renderTarget:l,onRenderStart:()=>{if(this.isReadyCache||this.cacheFramebufferId===void 0)return;const c=this.modules.renderer.getFramebuffer(this.cacheFramebufferId);if(!c)return;c.renderTarget.bind(o);const d=Pt(r.getClearColor()),u=o.COLOR_BUFFER_BIT|o.DEPTH_BUFFER_BIT;this.storeWebglState(o),o.depthMask(!0),o.enable(o.DEPTH_TEST),o.clearDepth(1),o.clearColor(d[0],d[1],d[2],d[3]),o.clear(u),c.renderTarget.unbind(o),this.restoreWebglState(o)},onRenderEnd:()=>{},isCacheFramebuffer:!0,useDem:!0,renderIndex:ua})}isWebgl2Context(){return!(this.modules.map.getWebGLContext()instanceof WebGLRenderingContext)}copyRenderTargetToCanvasTexture(e,n){const{viewport:i}=this.state,o=window.devicePixelRatio,r=this.modules.renderer.getViewportSize();e.bindFramebuffer(e.FRAMEBUFFER,null),e.viewport(i.left*o,i.bottom*o,r[0],r[1]),this.storeWebglState(e),e.depthMask(!0),e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),this.debugMode&&(e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA_SATURATE,e.ONE_MINUS_SRC_COLOR));const s=this.modules.renderer.webGlExtensions;this.vao.bind({gl:e,extensions:s});const a=n.getTexture();a==null||a.enable(e,0);const l=n.getDepthAttachment();l==null||l.enable(e,1),this.copyProgram.enable(e),this.copyProgram.bind(e,{u_texture:0,u_depth:1}),e.drawArrays(e.TRIANGLE_FAN,0,4),this.restoreWebglState(e)}storeWebglState(e){this.stateWebgl={depthmask:e.getParameter(e.DEPTH_WRITEMASK),depthTest:e.getParameter(e.DEPTH_TEST),depthFunc:e.getParameter(e.DEPTH_FUNC),clearDepth:e.getParameter(e.DEPTH_CLEAR_VALUE)}}restoreWebglState(e){this.stateWebgl&&(e.depthMask(this.stateWebgl.depthmask),this.stateWebgl.depthTest?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),e.depthFunc(this.stateWebgl.depthFunc),e.clearDepth(this.stateWebgl.clearDepth))}}const vU=6e4;class yU{constructor(e,n){this.rerenderEvents=[],this.prevObjects=new Map,this.currentObjects=new Map,this.mapState=e,this.modules=n,this.throttledAutoRefresh=yl(()=>{this.refresh()},vU)}frameEnd(){this.rerenderEvents.forEach(e=>this.modules.renderer.addRerenderEvent(e)),this.clearAnimationTickers()}frameStart(){this.rerenderEvents=[]}clearAllTickers(){this.clearAnimationTickers();for(const e of this.currentObjects.keys())It(e,this.mapState);this.prevObjects=new Map,this.currentObjects=new Map}animateGltfObject(e,n,i){const{localMatrix:o,animationStack:r,transformStack:s}=e.renderingProperties;if(n.style.playAnimation===void 0||!(r!=null&&r.length)||!o||!r||!s)return;const a=this.updateAnimationKeyframes(e,n);nw(o,r,s,i.buffers,a)}clearAnimationTickers(){for(const e of this.prevObjects.keys())this.currentObjects.has(e)||It(e,this.mapState);this.prevObjects=new Map(this.currentObjects),this.currentObjects=new Map}refresh(){this.modules.renderer.addRerenderEvent()}updateAnimationKeyframes(e,n){const{animationStack:i}=e.renderingProperties;if(!i)return;const o=new Map;if(!(e.layerSettings.depthTest||e.layerSettings.shadow)){for(const r of i){const s=`${e.id}_${r.actionId}`,a=Ic(s,this.mapState),l=this.applyAnimationState(s,n,e);if(this.isNeedAnimation(r,l)){if(!a&&l.currentCount>0){const c=l.animationDuration||(r.max?r.max[0]:0),d=l.startOffset||0,u=l.startOffset?(r.frameCount-1)*d/c:0,f=r.frameCount-1,h=c*(1e3/l.playSpeed)-d*(1e3/l.playSpeed);At(s,{easing:"linear",forceFinalValue:!0,renderAfterUpdate:!1},this.mapState,u,f,h,1,{actionId:r.actionId})}xt(s,{keepFinished:!0,step:(c,d,u,f)=>{o.set(u.actionId,d),f||this.rerender(e,n,l)},complete:c=>{l.currentCount>0&&l.currentCount--,l.currentCount>0&&(It(s,this.mapState),this.rerender(e,n,l))}},this.mapState),this.currentObjects.set(s,l)}}return o}}initObjectAnimationState(e,n){const i=this.resolveOptions(e,n),o=i[2]??1/0,r=o,s=i[1]||1,a=i[4]||void 0,l=i[3]||void 0,c=typeof i[0]=="number"?i[0]:void 0,d=typeof i[0]=="string"?i[0]:void 0,u=typeof i[0]=="object"?i[0]:void 0;return{repeatCount:o,playSpeed:s,animationIndex:c,animationName:d,currentCount:r,animations:u,animationDuration:a,startOffset:l,tickerByStep:!!l}}resolveOptions(e,n){if(e.type!=="gltfModel")return{type:"animation-options"};const i=ht(this.mapState.styleZoom,this.mapState.styleState,n.attributes.tileData);return i.callBackFn=()=>this.throttledAutoRefresh(),Z3(e.style.playAnimation,i)}isNeedAnimation(e,n){return n.animationIndex!==void 0&&e.animationIndex===n.animationIndex||n.animationName!==void 0&&e.animationName===n.animationName||n.animations!==void 0&&n.animations.includes(e.animationIndex)||n.animations!==void 0&&n.animations.includes(e.animationName)}applyAnimationState(e,n,i){const o=this.prevObjects.get(e),r=this.initObjectAnimationState(n,i);return o&&r.repeatCount===o.repeatCount&&(r.currentCount=o.currentCount),r}rerender(e,n,i){i.repeatCount!==0&&!i.tickerByStep&&this.rerenderEvents.push({type:"layerAnimationTicker",layerId:n.innerId,styleId:e.attributes.styleId})}}const Ci=.1,bU={id:"simple-mesh",type:"simpleMesh",innerId:hp,filter:!1,minzoom:0,maxzoom:20,precomputes:[],renderIndex:0,style:{}},dm={polygonsQty:1e4,drawCallsQty:150,iterations:7},D2=[15,25,40],wU=1e3;class xU{constructor(e,n){this.state=e,this.modules=n,this.buffer=null,this.sceneObjects=[],this.pixels=new Float32Array(4),this.timeout=1/0,this.scale=yt(1,1,1),this.startTs=0,this.de=Nr(this.state,this.modules),this.framebufferId=this.createFramebuffer(),this.modules.dynamicStyle.addLayer(bU)}async run(e=dm.polygonsQty,n=dm.drawCallsQty,i=dm.iterations,o=wU){this.timeout=o,this.startTs=performance.now();try{return await this._run(e,n,n*i,i)}catch{return{status:"error"}}}destroy(){this.modules.renderer.removeFramebuffer(this.framebufferId),this.buffer=null,this.sceneObjects=[],this.modules.dynamicStyle.removeLayer(hp)}async _run(e,n,i,o){const r=this.modules.renderer.getRenderingContext(),s=this.modules.renderer.getFramebuffer(this.framebufferId);if(!s)throw new Error("Failed to create framebuffer for benchmark.");s.renderTarget.bind(r),r.viewport(0,0,this.modules.renderer.getViewportSize()[0],this.modules.renderer.getViewportSize()[1]);const a=this.prepareData(e,i),l=await this.measureRendering(o,n);if(s.renderTarget.unbind(r),l.length<3)return{status:"timeout"};const c=this.processResults(l);let d=Math.min(c.mean,c.median);try{const h=localStorage.getItem("__MAPGL_BENCH_TIME"),_="0.0.0";if(h){const p=h.split(":"),m=parseFloat(p[1]);_!==p[0]||Number.isNaN(m)||d<m?localStorage.setItem("__MAPGL_BENCH_TIME",`${_}:${d.toPrecision(4)}`):d=m}else localStorage.setItem("__MAPGL_BENCH_TIME",`${_}:${d.toPrecision(4)}`)}catch{}const u=D2.findIndex(h=>d<=h),f=u>-1?D2.length-u-1:0;return{status:l.length<o?"part-done":"done",tier:f,measurements:c,preparation:a}}prepareData(e,n){const i=performance.now();this.buffer=this.generateSphere(e);const o=performance.now(),r=performance.now();this.sceneObjects=this.createSceneObjects(n);const s=performance.now();return{generationTime:o-i,objectsTime:s-r}}async measureRendering(e,n){return new Promise(i=>{const o=[];let r=0,s=0;const a=()=>{const l=performance.now();if(l-this.startTs>this.timeout){i(o);return}const c=this.modules.renderer.getRenderingContext();c.clear(c.COLOR_BUFFER_BIT|c.DEPTH_BUFFER_BIT),this.scale[0]+=.5-Math.random(),cg(this.state,this.modules,this.sceneObjects.slice(s,s+n),this.de),c.readPixels(0,0,1,1,c.RGBA,c.FLOAT,this.pixels),o.push(performance.now()-l),r++,s+=n,r<e?Promise.resolve().then(a):i(o)};setTimeout(()=>{a()},0)})}processResults(e){const n=e.slice();n.sort((o,r)=>o-r);const i=n.slice(0,n.length-.2*n.length);return{median:i[Math.floor(i.length/2)],mean:i.reduce((o,r)=>o+r,0)/i.length,min:i[0],max:i[i.length-1]}}generateSphere(e){const n=Math.floor(Math.sqrt(e/2)),i=n*2,a=n*i*2*3*3,l=new Float32Array(a);let c=0;const d=Math.PI/n,u=2*Math.PI/i,f=new Float32Array(3),h=new Float32Array(3),_=new Float32Array(3),p=new Float32Array(3);for(let m=0;m<n;m++){const g=m*d,y=(m+1)*d,b=Math.sin(g),v=Math.cos(g),T=Math.sin(y),x=Math.cos(y);for(let I=0;I<i;I++){const E=I*u,L=(I+1)*u,N=Math.sin(E),k=Math.cos(E),w=Math.sin(L),S=Math.cos(L);f[0]=Ci*b*k,f[1]=Ci*v,f[2]=Ci*b*N,h[0]=Ci*b*S,h[1]=Ci*v,h[2]=Ci*b*w,_[0]=Ci*T*k,_[1]=Ci*x,_[2]=Ci*T*N,p[0]=Ci*T*S,p[1]=Ci*x,p[2]=Ci*T*w,l.set(f,c),l.set(_,c+3),l.set(h,c+6),l.set(_,c+9),l.set(p,c+12),l.set(h,c+15),c+=18}}return l.buffer}createFramebuffer(){const e=new qt({size:this.modules.renderer.getViewportSize(),magFilter:j.NearestFilter,minFilter:j.NearestFilter,wrapS:j.ClampToEdgeWrapping,wrapT:j.ClampToEdgeWrapping,type:j.Float,flipY:!0});return this.modules.renderer.addFramebuffer({clearColor:[0,0,0,0],renderTarget:e,onResize:()=>{}})}createSceneObjects(e){const n={programName:"simpleMesh",vaoCreator:Y1,webglState:Nb,programBinder:(a,l)=>{const c=Ui();l.bind(a,{u_mat4_mvp:Mc(c,c,this.scale),u_float_scale:1,u_vec3_transform:yt(0,0,0)})},tileBinder:()=>!0,objectBinder:(a,l,c,d,u)=>{l.bind(a,{u_float_scale:u.meta.scale,u_vec3_transform:u.meta.transform})},needsVisibilityBuffer:!1},i=[],o=Y1(new F(this.buffer),this.modules.renderer.getShaderProgram("simpleMesh")),r=new bi("zenith",[],this.modules,this.state),s={layerId:hp,styleId:Kr,tileData:[]};for(let a=0;a<e;a++){const c=(a/20&1)===0?1-(1+a%10)/10:(1+a%10)/10,d=yt(-1+a%20/10,1-Math.floor(a/20)*2/(e/20),0);i.push({id:mo(),type:ri.Tile,start:0,count:this.buffer.byteLength/12,attributesHash:`benchmark-${a}`,vao:o,drawMode:Vc,tile:r,symbol:"simpleMesh",sink:"fill",layerSettings:n,canRender:!0,attributes:s,meta:{scale:c,transform:d},renderingProperties:{}})}return i}}class SU{constructor(e,n,i){this.benchmark=null,this.map=i,this.camera=new dl(e),this.layout=new VN(n),this.collector=new vP("main"),this.workers=new iN,this.identifier=new sO(e,this),this.styleManager=new SO(this),this.assetManager=new CO(e,this),this.imageManager=new jN(this),this.floorManager=new SN(e,this),this.personalPoiManager=new zO(this),this.buildingHeightAnimator=new uP(e,this),this.modelsScene=new mU(e,this),this.renderer=new Jr(e,this),this.layers=new vN(this),this.sourceStorage=new ZN,this.tileManager=new MN(e,this),this.modelLayer=new RO(e,this),this.dynamicStyle=new FA,this.imageCache=new bN(this),this.labeler=new PN(e,this),this.ruler=new DN(e,this),this.trafficTileLayer=new GN(e,this),this.handler=new NN(e,this),this.mouseMoveHandler=new lP(this),this.tileKeyInfo=new WN(e),this.demManager=new WL(this),this.environmentManager=new QN(this),this.defaultSource=new YN(e,this),this.labelsDebug=new KN(e,this),this.postEffectsManager=new TF(e,this),this.renderCacheManager=new gU(e,this),this.animationManager=new yU(e,this),this.shadowManager=new xF(e,this),this.instanceLinker=new aR(this),e.graphicsPresetMode==="auto"&&(this.benchmark=new xU(e,this))}destroy(){this.demManager.disable(),this.imageManager.destroy(),this.trafficTileLayer.destroy(),this.tileManager.destroy(),this.workers.destroy(),this.renderer.destroy(),this.handler.destroy(),this.mouseMoveHandler.destroy(),this.ruler.destroy(),this.labelsDebug.hide(),this.renderCacheManager.destroy(),this.tileKeyInfo.destroy(),this.layout.destroy()}}const La=class La{constructor(e,n={},i){this.requestedFrame=requestAnimationFrame(()=>{}),this.isStyleUpdateInProgress=!1,this.isFirstStyleUpdate=!0,this.lastResizeTime=-1/0,this.replicasDiffer=new Kt([{path:"visibleMapReplicas",type:"replicas"}]),this.graphicsPresetDiffer=new Kt([{path:"graphicsPreset",type:"string"}]),this.renderLoop=u=>{this.requestedFrame=requestAnimationFrame(this.renderLoop),this.updateImmersiveLevel(),this.modules.map.emit("framestart");const f=this.state;if(f.time=Date.now(),this.processMetrics(),this.state.enableTrackResize&&this.autoResize(u),this.modules.mouseMoveHandler.update(),this.handlers.forEach(h=>h.update()),$C(f),UC(f),HC(f),jC(f),this.stillnessUpdater.update(f),DC(f,this.modules.layout.rootContainer),kC(f,this.modules.layout.rootContainer,this.modules.renderer),zC(f,this.modules.renderer),f.demMode=this.checkDemEnabled()&&f.elevationScale>0,this.checkGlobeEnabled(),this.modules.camera.update(),this.updateElevation(),this.updateTilesBounds(),this.replicasDiffer.check(f)&&(f.needReplicasUpdate=!0),this.modules.demManager.update(),this.modules.environmentManager.update(),this.modules.labelsDebug.update(),this.modules.trafficTileLayer.update(),this.modules.layers.getLayers().forEach(h=>{h.update!==void 0&&h.update()}),this.modules.tileManager.update(),this.modules.instanceLinker.update(),this.modules.sourceStorage.updateViewportSources(),this.modules.floorManager.update(),this.modules.modelLayer.update(),this.modules.personalPoiManager.update(),this.modules.ruler.update(),this.modules.dynamicStyle.update(),this.modules.styleManager.update(),this.modules.buildingHeightAnimator.update(),this.modules.modelsScene.update(),this.modules.shadowManager.update(),this.modules.map.emit("update"),this.modules.labeler.update(),this.performanceChecker.update(),this.modules.identifier.update(),this.modules.postEffectsManager.update(),f.loopWorld&&!this.modules.renderer.isNeedRerender()&&Za(f.center),this.modules.renderer.isNeedRerender()&&f.collectStats&&(f.stats.drawCount=0,f.stats.vertexCount=0,f.stats.triangleCount=0,f.stats.drawCountBySymbol={}),this.modules.renderer.isNeedRerender()){let h=this.modules.tileManager.getTileObjects();f.demMode&&(h=h.concat(this.modules.demManager.getGroundTiles())),this.modules.renderer.prerenderUpdate(),f.metrics.firstdraw===void 0&&(f.metrics.firstdraw=performance.now()-f.metrics.start),h.forEach(_=>{_.needSync&&_.syncReplicas(this.state)}),this.modules.renderCacheManager.frameStart(),this.modules.animationManager.frameStart(),this.modules.shadowManager.drawShadowMap(h),this.modules.renderer.renderLabelingTexture(h),this.modules.renderer.renderSpriteLabelingTexture(h),this.modules.renderer.renderTileObjects(h),this.modules.shadowManager.drawDebugFbIfNeeded(),f.needRerender=!1,this.state.rerenderEvents=new Array,this.modules.animationManager.frameEnd(),this.modules.renderCacheManager.frameEnd(),f.collectStats&&(this.modules.map.emit("stats",f.stats),f.metricsSent||(f.metrics.vertexCount=f.stats.vertexCount,f.metrics.triangleCount=f.stats.triangleCount,f.metrics.drawCount=f.stats.drawCount))}this.finishStyleUpdatingCheck(),this.modules.map.update(),this.modules.assetManager.invalidateUsedGltfModels(),f.needReplicasUpdate=!1,f.shouldIsReadyWaitForUpdates=!1,f.shouldIsIdleWaitForUpdates=!1,this.modules.map.emit("frameend"),this.modules.styleManager.getStyle(this.modules.map.state.handyStyleId)&&this.state.graphicsPresetMode&&this.graphicsPresetDiffer.check(this.state.styleState)&&this.modules.map.emit("graphicspresetchange")};const o={...La.options,...n},r={...La.options.padding,...o.padding},s={...La.options.viewport,...o.viewport},a=o.maxBounds?jx(o.maxBounds):o.loopWorld?hS:uS,l=q.fromGeo(o.center);Za(l),$a(l,a,l);const c=o.graphicsPreset&&o.graphicsPreset!=="auto"?{...o.styleState,graphicsPreset:o.graphicsPreset}:o.styleState,d=this.state={time:Date.now(),center:l,zoom:o.styleZoom!==void 0?nh(o.styleZoom,l):o.zoom,rotation:Be(o.rotation),pitch:Be(o.pitch),styleZoom:o.styleZoom!==void 0?o.styleZoom:Ws(o.zoom,l),zoomTypePreserving:o.styleZoom!==void 0?"styleZoom":"zoom",minZoom:o.minZoom,maxZoom:o.maxZoom,maxBounds:a,loopWorld:o.loopWorld??!1,touchRotationThreshold:Be(o.touchRotationThreshold),minPitch:Be(o.minPitch),maxPitch:Be(o.maxPitch),lowZoomMaxPitch:o.lowZoomMaxPitch?Be(o.lowZoomMaxPitch):null,size:[Math.max(1,e.clientWidth-s.left-s.right),Math.max(1,e.clientHeight-s.top-s.bottom)],tickers:{},stillness:1,needRerender:!0,needLabeling:!1,needReplicasUpdate:!1,userHasInteracted:!1,viewport:s,padding:r,labelingOpacity:0,tileServer:o.tileServer,styleServer:o.styleServer||qx.url,fontUrl:o.fontUrl||Gi.defaultUrl,modelUrl:o.modelUrl||G4,iconUrl:o.iconUrl||Yx.defaultUrl,keyUrl:o.keyUrl||j9,tileSet:o.tileSet,tileProtocol:o.tileProtocol,commercialTileSet:o.commercialTileSet,modelsTileSet:o.modelsTileSet??pa.tileSet,modelsTilesUrl:o.modelsTilesUrl??v0.models,defaultSourceModelsRootUrl:o.defaultSourceModelsRootUrl,defaultSourceModelsAppearStrategy:o.defaultSourceModelsAppearStrategy,subdomains:o.subdomains.split(""),floorsEnabled:o.floorsEnabled,collectStats:o.collectStats,stats:{tileCount:0,dynamicTileCount:0,globeTileCount:0,drawCount:0,vertexCount:0,triangleCount:0,drawCountBySymbol:{},foundVisibleTilesCount:0},trafficServer:o.trafficServer,trafficProtocol:o.trafficProtocol,identifyPickDistance:zi.pickDistance,lang:o.lang,tileServerDefaultLang:o.tileServerDefaultLang,tileKey:o.key,appId:o.appId,disableHoverStyles:o.disableHoverStyles,keepCenterWhileUserZoomRotate:!!o.keepCenterWhileUserZoomRotate,disableRotationByUserInteraction:!!o.disableRotationByUserInteraction,disablePitchByUserInteraction:!!o.disablePitchByUserInteraction,disableDragging:!!o.disableDragging,enableTwoFingerDragging:!!o.enableTwoFingerDragging,performanceCaveatEmitted:!1,sessionId:o.sessionId,tileSessionId:o.tileSessionId,shownRegionIds:new Set,preserveDrawingBuffer:!!o.preserveDrawingBuffer,defaultBackgroundColor:Os(o.defaultBackgroundColor),handyStyleId:NaN,styleState:xN(c),disableIconCache:o.disableIconCache,disableRenderingCache:o.disableRenderingCache,rtlPlugin:{scenario:o.useRtlTextPlugin??"depends-on-language",loadFailed:!1,url:o.rtlPluginUrl??$9,hash:o.rtlPluginHash??W9},mobileSdkMode:o.mobileSdkMode,dracoDecoderUrl:(o==null?void 0:o.dracoDecoderUrl)??Z9,demMode:!1,globeMode:!1,globeReady:!1,visibleMapReplicas:[0],tilesBounds:[[0,0],[0,0],[0,0],[0,0]],extendedTilesBounds:[[0,0],[0,0],[0,0],[0,0]],elevation:void 0,elevationScale:0,minElevation:void 0,skipElevationAnimation:o.skipElevationAnimation,metrics:{start:performance.now(),fail:!1,vertexCount:0,triangleCount:0,drawCount:0},metricsSent:!1,shouldIsReadyWaitForUpdates:!1,shouldIsIdleWaitForUpdates:!1,commercialPoiRandomSeed:o.commercialPoiRandomSeed,disableSurvivedPoiPrevalence:!!o.disableSurvivedPoiPrevalence,webglVersion:o.webglVersion,enableTrackResize:!!o.enableTrackResize,autoResizeInterval:Jx.autoResizeInterval,showDefaultTileBounds:!!o.showDefaultTileBounds,immersiveLevel:{tiers:!1},pitchHightLimitation:o.pitchHightLimitation===void 0?Be(90):Be(o.pitchHightLimitation),isLabelingDepthTestDisabled:!1,disableHidingPois:o.disableHidingPois??!1,disableAntiAliasing:o.disableAntiAliasing??!0,rerenderEvents:new Array,cameraConfig:Object.assign({},nn),cityCommPoiLabeling:{config:o.cityCommPoiLabelingConfig,ascSortedZoomNumbers:EN(o.cityCommPoiLabelingConfig)},trafficMinZoom:o.trafficMinZoom??ci.minZoom,trafficMaxZoom:o.trafficMaxZoom??ci.maxZoom,trafficMaxDetailLevel:o.trafficMaxDetailLevel??ci.maxDetailLevel,bssHostAppParams:o.bssHostAppParams,disableStyleFallback:!!o.disableStyleFallback,useFlatDemIrregularMeshNormals:o.useFlatDemIrregularMeshNormals??!1,hiddenImmersiveRoutesEnabled:OL(),modelShowHideEventsSublayers:new Set(o.modelShowHideEventsSublayers??[]),graphicsPresetMode:o.graphicsPreset,shouldEmitGraphicsPresetChangeEvent:!1,isDeprecatedSystem:Hb(),disableModelsGrowthAnimation:o.disableModelsGrowthAnimation??!1};o.cameraConfig&&Object.assign(d.cameraConfig,o.cameraConfig),this.modules=new SU(d,e,i),typeof d.commercialPoiRandomSeed=="number"&&this.modules.workers.labeling.setCommercialPoiRandomSeed(d.commercialPoiRandomSeed),this.modules.styleManager.setDynamicStyle(this.modules.dynamicStyle.getStyle()),this.handlers=[new nP(d,this.modules.layout.mapContainer),new iP(this.modules)],o.disableZoomOnScroll||this.handlers.push(new tP(d,this.modules.layout.mapContainer)),JC&&Qu&&this.handlers.push(new oP(d,e,i)),this.performanceChecker=new rP(d,this.modules),this.stillnessUpdater=new aP,this.measurePerformance(o.graphicsPreset==="auto").then(()=>{this.requestedFrame=requestAnimationFrame(this.renderLoop)})}destroy(){cancelAnimationFrame(this.requestedFrame),this.modules.destroy(),this.handlers.forEach(e=>e.destroy())}isIdle(){return!this.modules.renderer.isNeedRerender()&&!this.state.shouldIsIdleWaitForUpdates&&this.modules.tileManager.isIdle()&&this.modules.assetManager.isIdle()&&this.modules.trafficTileLayer.viewportTilesReady()&&this.modules.layers.entranceAnimationFinished()&&this.modules.modelLayer.isIdle()&&!this.modules.buildingHeightAnimator.isAnimating()&&!this.modules.modelsScene.isAnimating()&&this.modules.labeler.isIdle()}isReady(){return this.isIdle()&&this.modules.floorManager.floorsReady()&&this.modules.identifier.isIdle()&&this.modules.imageManager.isIdle()&&this.modules.imageCache.isIdle()&&this.modules.personalPoiManager.isIdle()&&this.modules.tileKeyInfo.isIdle()&&this.modules.postEffectsManager.isReady()&&!this.state.shouldIsReadyWaitForUpdates}redrawMap(){this.modules.tileManager.redraw(),this.modules.trafficTileLayer.redraw(),this.modules.modelLayer.redraw(),this.modules.personalPoiManager.redraw()}activateStyleUpdating(){this.modules.tileManager.activateStyleUpdating(),this.modules.modelLayer.activateStyleUpdating(),this.modules.trafficTileLayer.activateStyleUpdating(),this.isStyleUpdateInProgress=!0}getIsFirstStyleUpdate(){return this.isFirstStyleUpdate}async measurePerformance(e){if(!e)return;performance.now();const n=await this.modules.benchmark.run();switch(this.modules.benchmark.destroy(),this.modules.benchmark=null,n.status){case"error":this.state.metrics.graphicsPreset="error";break;case"timeout":this.state.metrics.graphicsPreset="timeout",this.modules.map.patchStyleState({graphicsPreset:"light"});break;case"part-done":case"done":const i=n.tier>0?n.tier>1?"immersive":"normal":"light";this.state.metrics.graphicsPreset=n.status==="part-done"?"timeout":i,this.state.metrics.benchRenderTime=Math.round(n.measurements.mean),this.state.metrics.benchGenTime=Math.round(n.preparation.generationTime),this.modules.map.patchStyleState({graphicsPreset:i});break}}processMetrics(){const e=this.state;if(e.metricsSent||e.graphicsPresetMode==="auto"&&!e.metrics.graphicsPreset)return;const n=e.metrics,i=performance.now()-n.start>iS;(n.interactive!==void 0&&n.init!==void 0&&n.firstlabeling!==void 0&&n.ready!==void 0&&n.firstcontent!==void 0&&n.firstdraw!==void 0||i)&&(n.fail=i,this.modules.map.emit("metrics",n),e.metricsSent=!0)}finishStyleUpdatingCheck(){this.isStyleUpdateInProgress&&this.modules.tileManager.viewportTilesReady()&&this.modules.trafficTileLayer.viewportTilesReady()&&this.modules.modelLayer.viewportModelsReady()&&(this.modules.tileManager.finishStyleUpdating(),this.modules.trafficTileLayer.finishStyleUpdating(),this.modules.modelLayer.finishStyleUpdating(),this.modules.modelsScene.finishStyleUpdating(),this.modules.personalPoiManager.redraw(),this.updateBackgroundColor(),this.isStyleUpdateInProgress=!1,this.isFirstStyleUpdate=!1,this.modules.renderer.addRerenderEvent(),this.state.needLabeling=!0)}updateBackgroundColor(){const{renderer:e,postEffectsManager:n,styleManager:i}=this.modules,o=i.getClearColor();o!==void 0&&(e.setClearColor(o),n.setClearColor(o))}checkDemEnabled(){return this.state.styleState.terrainEnabled===!0?this.modules.demManager.isEnabled()||this.modules.demManager.enable():this.modules.demManager.isEnabled()&&this.modules.demManager.disable(),this.modules.demManager.isEnabled()}checkGlobeEnabled(){const{styleState:n,styleZoom:i,globeMode:o,handyStyleId:r}=this.state,{defaultSource:s,map:a}=this.modules,l=o;if(!this.modules.styleManager.getStyleLayer(r,Gs)){this.state.globeMode=!1;return}const{globeMaxZoom:d}=$o,u=!l&&i<d||l&&i<d+.2,f=n.globeEnabled===!0&&u&&!a.getFeatureFlag("globeOff");!l&&f&&(this.modules.defaultSource.addGlobeSource(),this.state.globeReady=!1),l&&!f&&(this.modules.defaultSource.removeGlobeSource(),this.state.globeReady=!1),f&&s.isGlobeTilesReady()&&(this.state.globeReady=!0),this.state.globeMode=f,(f||l&&!f)&&this.updateBackgroundColor()}updateImmersiveLevel(){const e=!!this.state.styleState.immersiveRoadsOn;this.state.immersiveLevel.tiers=e&&this.state.styleZoom>=cS}updateTilesBounds(){const{size:e,zoom:n}=this.state,[i,o,r,s]=this.modules.camera.getViewportVertices(),a=zr(i,o);let l=Zu(r,a);const c=this.state.cameraConfig;let d=w0(e[1],n)*c.viewportLimitRatio;if(d<c.minTrapezeHeight&&(d=c.minTrapezeHeight),l>d){const u=d/l;Nn(r,o,r,u),Nn(s,i,s,u),l=d}if(Sa(this.state.tilesBounds[0],i),Sa(this.state.tilesBounds[1],o),Sa(this.state.tilesBounds[2],r),Sa(this.state.tilesBounds[3],s),this.state.visibleMapReplicas=this.state.loopWorld&&!this.state.globeMode?V6(this.state.tilesBounds):[0],this.state.demMode){const u=I3(this.modules.camera.position,a);if(u<0){const h=(l+Math.abs(u))/l;Nn(i,s,i,h),Nn(o,r,o,h)}if(this.state.elevation!==void 0&&!Number.isNaN(this.state.elevation)){const h=this.modules.camera.position[2],_=this.state.minElevation!==void 0&&!Number.isNaN(this.state.minElevation)?this.state.minElevation:this.state.elevation,p=Math.max(this.state.elevation-_,0)*He/h+1,m=(p-1)*Math.max(1-this.state.pitch/this.state.maxPitch,.1)+1,g=Math.max(this.state.pitch/this.state.maxPitch*30,4);Nn(i,this.modules.camera.position,i,Math.min(m,g)),Nn(o,this.modules.camera.position,o,Math.min(m,g)),Nn(s,this.modules.camera.position,s,Math.min(p,g)),Nn(r,this.modules.camera.position,r,Math.min(p,g))}}this.state.extendedTilesBounds[0]=i,this.state.extendedTilesBounds[1]=o,this.state.extendedTilesBounds[2]=r,this.state.extendedTilesBounds[3]=s}updateElevation(){if(this.state.elevationScale=this.modules.demManager.getVerticalScale(),!this.state.demMode){this.state.elevation!==void 0&&(this.modules.renderer.addRerenderEvent(),this.state.elevation=void 0);return}const e=this.modules.demManager.getElevation(this.state.center);if(e!==void 0)if(this.state.elevation===void 0||this.state.skipElevationAnimation)this.state.elevation=e;else{const i=VL*(e-this.state.elevation);Math.abs(i)<jL?this.state.elevation=e:this.state.elevation+=i;const o=this.modules.demManager.getElevation(this.modules.camera.position);if(o!==void 0){const r=this.state.elevationScale,s=o*r,a=this.modules.camera.position[2]/He,l=Math.min(30,a*.2),c=this.state.elevation*r+a-l;s>c&&(this.state.elevation+=(s-c)/r)}}const n=this.modules.demManager.getMinElevation();n!==void 0&&(this.state.minElevation=n)}autoResize(e){if(e-this.lastResizeTime>=this.state.autoResizeInterval){const n=this.modules.layout.canvas,{clientWidth:i,clientHeight:o}=this.modules.layout.rootContainer,r=window.devicePixelRatio;(n.width!==Math.floor(i*r)||n.height!==Math.floor(o*r))&&(this.lastResizeTime=e,this.modules.map.invalidateSize())}}};La.options={center:[0,0],zoom:0,minZoom:Am.minZoom,maxZoom:Am.maxZoom,rotation:0,touchRotationThreshold:10,pitch:0,minPitch:0,maxPitch:45,lowZoomMaxPitch:45,viewport:{top:0,right:0,bottom:0,left:0},padding:{top:0,right:0,bottom:0,left:0},tileServer:qe.server,tileSet:qe.tileSet,tileProtocol:qe.protocol,commercialTileSet:hc.tileSet,key:qe.tileKey,subdomains:qe.subdomains,floorsEnabled:Ma.enabled,trafficProtocol:ci.protocol,trafficServer:ci.host,collectStats:!1,style:"",styleState:wN(),styleOptions:{rootUrl:"",iconsPath:"",fontsPath:"",stylePath:"",modelsPath:""},lang:Qx,appId:qe.appId,disableHoverStyles:!1,disableZoomOnScroll:!1,disableDragging:!1,enableTwoFingerDragging:!1,disableRotationByUserInteraction:!1,disablePitchByUserInteraction:!1,defaultBackgroundColor:"#f6f2de",disableIconCache:!1,disableRenderingCache:!1,mobileSdkMode:!1,skipElevationAnimation:!1,enableTrackResize:!1,showDefaultTileBounds:!1,immersiveOn:!1,pitchHightLimitation:90,trafficMinZoom:ci.minZoom,trafficMaxZoom:ci.maxZoom,trafficMaxDetailLevel:ci.maxDetailLevel,disableStyleFallback:!1,useFlatDemIrregularMeshNormals:!1,modelShowHideEventsSublayers:[],styleServer:"",fontUrl:"",modelUrl:"",iconUrl:"",keyUrl:""};let N2=La;new Promise(t=>{});const MU=2;function TU(t){const e=[MU,t instanceof WebGLRenderingContext?1:2,t.getParameter(t.ALIASED_LINE_WIDTH_RANGE),t.getParameter(t.ALIASED_POINT_SIZE_RANGE),t.getParameter(t.COMPRESSED_TEXTURE_FORMATS),t.getParameter(t.MAX_COMBINED_TEXTURE_IMAGE_UNITS),t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),t.getParameter(t.MAX_RENDERBUFFER_SIZE),t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),t.getParameter(t.MAX_TEXTURE_SIZE),t.getParameter(t.MAX_VARYING_VECTORS),t.getParameter(t.MAX_VERTEX_ATTRIBS),t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS),t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),t.getParameter(t.MAX_VIEWPORT_DIMS),t.getParameter(t.PACK_ALIGNMENT),t.getParameter(t.SUBPIXEL_BITS),t.getParameter(t.UNPACK_ALIGNMENT),t.getParameter(t.VIEWPORT),t.getParameter(t.SHADING_LANGUAGE_VERSION),t.getParameter(t.VENDOR),t.getParameter(t.RENDERER)];t instanceof WebGLRenderingContext?e.push(...new Array(28).fill(-1)):e.push(t.getParameter(t.MAX_3D_TEXTURE_SIZE),t.getParameter(t.MAX_ARRAY_TEXTURE_LAYERS),t.getParameter(t.MAX_CLIENT_WAIT_TIMEOUT_WEBGL),t.getParameter(t.MAX_COLOR_ATTACHMENTS),t.getParameter(t.MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS),t.getParameter(t.MAX_COMBINED_UNIFORM_BLOCKS),t.getParameter(t.MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS),t.getParameter(t.MAX_DRAW_BUFFERS),t.getParameter(t.MAX_ELEMENT_INDEX),t.getParameter(t.MAX_ELEMENTS_INDICES),t.getParameter(t.MAX_ELEMENTS_VERTICES),t.getParameter(t.MAX_FRAGMENT_INPUT_COMPONENTS),t.getParameter(t.MAX_FRAGMENT_UNIFORM_BLOCKS),t.getParameter(t.MAX_FRAGMENT_UNIFORM_COMPONENTS),t.getParameter(t.MAX_PROGRAM_TEXEL_OFFSET),t.getParameter(t.MAX_SAMPLES),t.getParameter(t.MAX_SERVER_WAIT_TIMEOUT),t.getParameter(t.MAX_TEXTURE_LOD_BIAS),t.getParameter(t.MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS),t.getParameter(t.MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS),t.getParameter(t.MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS),t.getParameter(t.MAX_UNIFORM_BLOCK_SIZE),t.getParameter(t.MAX_UNIFORM_BUFFER_BINDINGS),t.getParameter(t.MAX_VARYING_COMPONENTS),t.getParameter(t.MAX_VERTEX_OUTPUT_COMPONENTS),t.getParameter(t.MAX_VERTEX_UNIFORM_BLOCKS),t.getParameter(t.MAX_VERTEX_UNIFORM_COMPONENTS),t.getParameter(t.MIN_PROGRAM_TEXEL_OFFSET));const n=t.getExtension("WEBGL_debug_renderer_info");n?e.push(t.getParameter(n.UNMASKED_VENDOR_WEBGL),t.getParameter(n.UNMASKED_RENDERER_WEBGL)):e.push("Unsupported","Unsupported");const i=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.LOW_FLOAT),o=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.MEDIUM_FLOAT),r=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.HIGH_FLOAT);return r&&o&&i?(e.push(`[${i.rangeMin},${i.rangeMax}](${i.precision})`),e.push(`[${o.rangeMin},${o.rangeMax}](${o.precision})`),e.push(`[${r.rangeMin},${r.rangeMax}](${r.precision})`)):e.push(new Array(3).fill("Unsupported")),e.push(window.devicePixelRatio),e}function IU(t){const e={1:["stateSetVersion","webGlVersion","ALIASED_LINE_WIDTH_RANGE","ALIASED_POINT_SIZE_RANGE","COMPRESSED_TEXTURE_FORMATS","MAX_COMBINED_TEXTURE_IMAGE_UNITS","MAX_CUBE_MAP_TEXTURE_SIZE","MAX_FRAGMENT_UNIFORM_VECTORS","MAX_RENDERBUFFER_SIZE","MAX_TEXTURE_IMAGE_UNITS","MAX_TEXTURE_SIZE","MAX_VARYING_VECTORS","MAX_VERTEX_ATTRIBS","MAX_VERTEX_TEXTURE_IMAGE_UNITS","MAX_VERTEX_UNIFORM_VECTORS","MAX_VIEWPORT_DIMS","PACK_ALIGNMENT","SUBPIXEL_BITS","UNPACK_ALIGNMENT","VIEWPORT","SHADING_LANGUAGE_VERSION","VENDOR","RENDERER","MAX_3D_TEXTURE_SIZE","MAX_ARRAY_TEXTURE_LAYERS","MAX_CLIENT_WAIT_TIMEOUT_WEBGL","MAX_COLOR_ATTACHMENTS","MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS","MAX_COMBINED_UNIFORM_BLOCKS","MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS","MAX_DRAW_BUFFERS","MAX_ELEMENT_INDEX","MAX_ELEMENTS_INDICES","MAX_ELEMENTS_VERTICES","MAX_FRAGMENT_INPUT_COMPONENTS","MAX_FRAGMENT_UNIFORM_BLOCKS","MAX_FRAGMENT_UNIFORM_COMPONENTS","MAX_PROGRAM_TEXEL_OFFSET","MAX_SAMPLES","MAX_SERVER_WAIT_TIMEOUT","MAX_TEXTURE_LOD_BIAS","MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS","MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS","MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS","MAX_UNIFORM_BLOCK_SIZE","MAX_UNIFORM_BUFFER_BINDINGS","MAX_VARYING_COMPONENTS","MAX_VERTEX_OUTPUT_COMPONENTS","MAX_VERTEX_UNIFORM_BLOCKS","MAX_VERTEX_UNIFORM_COMPONENTS","MIN_PROGRAM_TEXEL_OFFSET"]};e[2]=[...e[1],"UNMASKED_VENDOR_WEBGL","UNMASKED_RENDERER_WEBGL","precisionLow","precisionMedium","precisionHigh","devicePixelRatio"];const n=t[0],i=e[n]??{},o={};for(let r=0;r<t.length;r++)o[i[r]??r]=t[r];return o}const U2=0,EU=-1,AU=-2,G2=3,CU=0,PU=0,LU="#3388ff",FU="#00000000",kU="#00000000";let RU=class extends Kc{constructor(e,n){super(e,n),this.length=1,this.isGeometryOutOfMainReplica=!1,this.removed=!1,this.options=n;const{dynamicStyle:i,layers:o}=this.modules;this.dynamicStyleId=i.getStyle().id,this.geoPoints=this.options.coordinates.filter((s,a,l)=>a===0||!Tx(l[a],l[a-1])),this.points=this.geoPoints.map(s=>q.fromGeo(s)),this.isGeometryOutOfMainReplica=this.points.some(s=>s[0]>bt||s[0]<-2147483648);let r=0;this.distances=[],this.distances.push(r);for(let s=1;s<this.geoPoints.length;s++)r+=mf(this.geoPoints[s-1],this.geoPoints[s]),this.distances.push(r);if(this.stateDiffer=new Kt([{path:"center",type:"vec2"},{path:"zoom",type:"number"},{path:"size",type:"vec2"},{path:"rotation",type:"number"},{path:"pitch",type:"number"},{path:"padding",type:"padding"},{path:"demMode",type:"boolean"}]),this.debouncedGenerate=ki(()=>{this.generate()},200),this.tileAttrs=mh({beginningIsCut:0,endingIsCut:0,db_tiers:n.tiers}),this.options.width!==0){this.rawStyleLayer={type:"line",id:`dynamic-polyline-${this.uniqId}`,minzoom:this.options.minZoom,maxzoom:this.options.maxZoom,style:{color:this.options.color??LU,width:this.options.width??G2},webglState:this.options.renderingMode!=="3d"?this.options.webglState:{depthTest:!0}};const s=qi(this.rawStyleLayer);if(s&&(this.styleLayerId=s.innerId,i.addLayer(s,this.options.zIndex??U2)),this.options.renderingMode==="3d"&&this.options.hiddenPartColor){this.rawHiddenStyleLayer={type:"line",id:`dynamic-polyline-hidden-${this.uniqId}`,minzoom:this.options.minZoom,maxzoom:this.options.maxZoom,style:{color:this.options.hiddenPartColor,width:this.options.width??G2},webglState:{depthTest:!0,depthMask:!1,cullFace:!1,depthFunc:window.WebGLRenderingContext.GREATER}};const a=qi(this.rawHiddenStyleLayer);a&&(this.styleHiddenLayerId=a.innerId,i.addLayer(a,this.options.zIndex??U2))}if(n.showAnimation&&n.showAnimation.animate!==!1&&this.points.length>1){this.animationTickerName=`polyline-${this.uniqId}`;const a=s==null?void 0:s.innerId;a&&this.startShowTicker(this.animationTickerName,a)}}if(this.options.width2){this.rawStyleLayer2={type:"line",id:`dynamic-polyline2-${this.uniqId}`,minzoom:this.options.minZoom,maxzoom:this.options.maxZoom,style:{color:this.options.color2??FU,width:this.options.width2??CU},webglState:this.options.renderingMode!=="3d"?this.options.webglState:{depthTest:!0}};const s=qi(this.rawStyleLayer2);s&&(this.styleLayer2Id=s.innerId,i.addLayer(s,this.options.zIndex2??EU))}if(this.options.width3){this.rawStyleLayer3={type:"line",id:`dynamic-polyline3-${this.uniqId}`,minzoom:this.options.minZoom,maxzoom:this.options.maxZoom,style:{color:this.options.color3??kU,width:this.options.width3??PU},webglState:this.options.renderingMode!=="3d"?this.options.webglState:{depthTest:!0}};const s=qi(this.rawStyleLayer3);s&&(this.styleLayer3Id=s.innerId,i.addLayer(s,this.options.zIndex3??AU))}this.styleLayerId===void 0&&this.styleLayer2Id===void 0&&this.styleLayer3Id===void 0||(o.addLayer(this),this.generate())}update(){this.removed||(super.update(),this.stateDiffer.check(this.mapState)&&this.debouncedGenerate(),this.animationTickerName&&this.updateShowTicker(this.animationTickerName))}isOutOfMainReplica(){return this.isGeometryOutOfMainReplica}snapPoint(e){function n([u,f],h=0){return[h+(u+bt)/et,(f+bt)/et]}function i([u,f]){return[u*et-bt,f*et-bt]}const o=this.mapState.visibleMapReplicas,r=this.points.map(u=>n(u));let s=1/0,a=r[0],l=0;for(const u of o){const f=n(this.modules.camera.flat.unproject(e),u);for(let h=0;h<r.length-1;h++){const _=r[h],p=r[h+1],m=T6(f,_,p),g=m[0]-f[0],y=m[1]-f[1],b=g*g+y*y;b<s&&(s=b,a=i(m),l=h)}}const c=q.toGeo(a),d=this.distances[l]+mf(c,this.geoPoints[l]);return{point:c,distance:d}}setStyle(e){this.setSubLayerStyle(this.styleLayerId,this.rawStyleLayer,e.color),this.setSubLayerStyle(this.styleLayer2Id,this.rawStyleLayer2,e.color2),this.setSubLayerStyle(this.styleLayer3Id,this.rawStyleLayer3,e.color3),this.setSubLayerStyle(this.styleHiddenLayerId,this.rawHiddenStyleLayer,e.hiddenPartColor)}remove(){this.removed||(this.removed=!0,this.animationTickerName&&(It(this.animationTickerName,this.mapState),this.animationTickerName=void 0),this.interactive&&this.modules.identifier.resetCache(),this.styleLayerId!==void 0&&this.modules.dynamicStyle.removeLayer(this.styleLayerId),this.styleHiddenLayerId!==void 0&&this.modules.dynamicStyle.removeLayer(this.styleHiddenLayerId),this.styleLayer2Id!==void 0&&this.modules.dynamicStyle.removeLayer(this.styleLayer2Id),this.styleLayer3Id!==void 0&&this.modules.dynamicStyle.removeLayer(this.styleLayer3Id),super.destroy())}startShowTicker(e,n){var a,l,c;const r=((a=this.options.showAnimation)==null?void 0:a.easing)!==void 0?this.options.showAnimation.easing:"linear",s=((l=this.options.showAnimation)==null?void 0:l.duration)!==void 0?this.options.showAnimation.duration:250;At(e,{easing:r,animationGroup:(c=this.options.showAnimation)==null?void 0:c.animationGroup},this.mapState,0,1,s,1,{layerId:n,styleId:this.dynamicStyleId}),this.length=0}setSubLayerStyle(e,n,i){if(e!==void 0&&i&&n&&i!==n.style.color){const{dynamicStyle:o}=this.modules;n.style.color=i;const r=qi(n);r&&(o.updateLayerStyle(e,r),this.modules.renderer.addRerenderEvent())}}updateShowTicker(e){xt(e,{step:(n,i)=>{var r,s,a,l;const o=x0(((s=(r=this.options.showAnimation)==null?void 0:r.durationRange)==null?void 0:s.start)||0,((l=(a=this.options.showAnimation)==null?void 0:a.durationRange)==null?void 0:l.end)||1,i);o!==this.length&&(this.length=o,this.generate())}},this.mapState)}generate(){if(this.points.length<2||this.removed)return;const e=!!this.animationTickerName,{dynamicStyle:n,collector:i,tileManager:o,identifier:r,map:s}=this.modules,{tileProps:a}=S3,l=Math.min(Math.floor(s.getZoom()),15),c=Nt(l),d=S6(this.points,this.distances,this.length),u=M6(d,c),f=Ke(),h=es();this.tileObjects.forEach(_=>{_.clean(this.mapState),o.removeObject(_,e)}),this.tileObjects=[];for(let _=0;_<u.length;_++){const p=u[_];Em(h);for(let k=0;k<p.length;k++)kr(h,p[k]);th(f,h);const m=qa(f,l),g=Math.pow(2,m[2]),y=[...this.mapState.visibleMapReplicas];if(this.isOutOfMainReplica()){const k=y[0],w=y[y.length-1];y.push(k-1,w+1)}if(!y.map(k=>[m[0]+k*g,m[1],m[2],m[3]]).some(k=>this.mapState.globeMode?lh(this.mapState,this.modules.camera,k):Ec(k,this.mapState.tilesBounds,this.modules)))continue;if(this.options.displayTileBounds){const w=n.getStyle().layers.find(z=>z.id==="debug-tile-bounds");gb(i,w,this.mapState.styleState);const S=i.getAccumulatedData(),A=new bi("dynamicObject",S.data,this.modules,this.mapState,m);this.tileObjects.push(A),o.addObject(A,e)}const T=Ct(m),x=[],I=[];for(let k=0;k<p.length;k++)mi(f,p[k],T),x[k]=f[0],I[k]=f[1];this.tileAttrs[a.beginningIsCut]=0,this.tileAttrs[a.endingIsCut]=0,_!==0&&(this.tileAttrs[a.beginningIsCut]=1),_+1!==u.length&&(this.tileAttrs[a.endingIsCut]=1);const E=Zo(this.mapState.styleState,ul,Ho,this.tileAttrs,Wc,this.interactive?"0":"");if(this.styleLayerId!==void 0){const k=n.getStyle().layersById[this.styleLayerId];wd(k)&&(vr(k,E),io({collector:i,generator:Ot.generate,args:[n.getStyle().id,k,E,T,{x,y:I}]}))}if(this.styleHiddenLayerId!==void 0){const k=n.getStyle().layersById[this.styleHiddenLayerId];wd(k)&&(vr(k,E),io({collector:i,generator:Ot.generate,args:[n.getStyle().id,k,E,T,{x,y:I}]}))}if(this.styleLayer2Id!==void 0){const k=n.getStyle().layersById[this.styleLayer2Id];wd(k)&&(vr(k,E),io({collector:i,generator:Ot.generate,args:[n.getStyle().id,k,E,T,{x,y:I}]}))}if(this.styleLayer3Id!==void 0){const k=n.getStyle().layersById[this.styleLayer3Id];wd(k)&&(vr(k,E),io({collector:i,generator:Ot.generate,args:[n.getStyle().id,k,E,T,{x,y:I}]}))}const L=i.getAccumulatedData(),N=new bi("dynamicObject",L.data,this.modules,this.mapState,T.coords,this);o.addObject(N,e),this.tileObjects.push(N),this.interactive&&this.identifyIds.push(L.identifyIds)}this.interactive&&r.resetCache(),i.reset(),e||this.modules.renderer.addRerenderEvent()}};function zU(t,e){const n={...t};for(const i in e){const o=i;n[o]===void 0&&(n[o]=e[o])}return n}const BU={attributes:{},maxZoom:17,dimensions:2,modelsPath:"",modelsAppearStrategy:"byModel",promoteId:"",idScope:"default",tolerance:3};class Ea{constructor(e,n){this.options=zU(n,BU),this._impl=new Y0(e._impl,this.options,this)}destroy(){this._impl.destroy()}setAttributes(e){return this._impl.setAttributes(e),this}getAttributes(){return this._impl.getAttributes()}async setData(e){await this._impl.setData(e)}}const Jf=class Jf{constructor(e,n){this.options=n;const i=this.prepareOptions(this.options,e);this._impl=new _b(e._impl,i,this)}destroy(){this._impl.destroy()}setAttributes(e){return this._impl.setAttributes(e),this}getAttributes(){return this._impl.getAttributes()}setFeatureStateMap(e){this._impl.setFeatureStateMap(e)}prepareOptions(e,n){const i={tileServer:e.tileServer??"",tileSet:e.tileSet??"",tileProtocol:e.tileProtocol??"",tileKey:e.tileKey??"",subdomains:e.subdomains??(e.layerId?["0,1,2,3"]:[""]),appId:e.appId??n._impl.state.appId,tileTemplateUrl:e.tileTemplateUrl,metatileTemplateUrl:e.metatileTemplateUrl,defaultLang:e.defaultLang,sessionId:e.sessionId,sourceAttributes:e.sourceAttributes,modelsPath:e.modelsPath,disableTilesAnimation:e.disableTilesAnimation,promoteAttributes:e.promoteAttributes,promoteId:e.promoteId,idScope:e.idScope,modelsAppearStrategy:e.modelsAppearStrategy,minZoom:e.minZoom??9,maxZoom:e.maxZoom??15,maxDetailLevel:e.maxGenerateZoom??17,strokeMinZoom:e.strokeMinZoom??8};return e.layerId&&(i.tileTemplateUrl||(i.tileTemplateUrl=`${Og}?ts=userdata&x={x}&y={y}&z={z}&layer=${e.layerId}`),i.metatileTemplateUrl||(i.metatileTemplateUrl=`${Og}/file/{hash}?ts=userdata&layer=${e.layerId}`)),i}};Jf.tileTemplateUrl="{protocol}://{host}/v2/ald?ts={tileSet}&x={x}&y={y}&z={z}&lang={lang}",Jf.metatileTemplateUrl="{protocol}://{host}/v2/ald/file/{hash}.json?ts={tileSet}";let H2=Jf;function OU(t){const e=t.split("?")[1];if(!e)return;const i=e.split("&").map(o=>o.split("=")).find(o=>o[0]==="callback");if(i)return i[1]}setTimeout(()=>{const t=Array.from(document.querySelectorAll("script")).find(n=>n.src.match(J9));if(!t)return;const e=OU(t.src);if(e)if(typeof window[e]=="function")window[e]();else throw new Error(`Not found callback function with name "${e}"`)},0);setTimeout(()=>{if("__mapglPlugins"in window)for(const t in window.__mapglPlugins)window.mapgl[t]=window.__mapglPlugins[t]},0);const DU=async(t,e,n)=>{const i="https://catalog.api.2gis.ru/2.0/region/list?fields=items.default_pos&key=webmaps",o=e.addFolder("Regions"),s=(await fetch(i).then(y=>y.json())).result.items.reduce((y,b)=>{const{name:v,id:T}=b,{lon:x,lat:I,zoom:E}=b.default_pos;return y[v]={center:[x,I],zoom:E,id:T},y},{});o.add({region:"Новосибирск"},"region",Object.keys(s)).onChange(y=>{const{center:b,zoom:v}=s[y];t.setCenter(b,{animate:!1}),t.setZoom(v,{animate:!1})});const a={id:"65536",name:"Universe"},l=document.getElementById("stats"),c=document.getElementById("mods"),d=new Set,u={[a.id]:a.name};Object.entries(s).forEach(([y,{id:b}])=>{u[b]=y});const f={statsVisible:n.showRegionStats};h(n.showRegionStats),o.add(f,"statsVisible").onChange(h);function h(y){y?(l.style.display="block",t.on("idle",_),t.on("movestart",g),c.addEventListener("click",p)):(l.style.display="none",t.off("idle",_),t.off("movestart",g),c.removeEventListener("click",p))}function _(){const y={},b=t._impl.modules.tileManager.getViewportTiles().filter(I=>I.type==="zenith");let v=0;b.forEach(I=>{var E,L;v+=((E=I.serverMetadata)==null?void 0:E.length)||0,(L=I.serverMetadata)==null||L.forEach(N=>{y[N.regionId]===void 0?y[N.regionId]=1:y[N.regionId]++})});let T=0;t.getZoom()>=qe.maxUniverseZoom+1?T=t._impl.modules.defaultSource.regionalTileLayer.getViewportTiles().length:T=t._impl.modules.defaultSource.universeTileLayer.getViewportTiles().length,d.forEach(I=>{y[I]=0});const x=Object.keys(y).sort((I,E)=>Number(I)-Number(E)).map(I=>({id:I,name:u[I]?u[I]:"",qty:y[I],disabled:d.has(Number(I))}));m({regions:x,gridModQty:T,totalModQty:v})}function p(y){const b=y.target,v=b.getAttribute("data-region");v&&(b.checked?d.delete(Number(v)):d.add(Number(v)),t._impl.modules.defaultSource.setDisabledRegionsId(Array.from(d)),t._impl.setStyle($s))}function m({regions:y,totalModQty:b,gridModQty:v}){const T=y.reduce((I,E)=>I.concat(`
            <tr>
                <td>${E.id}</td>
                <td>${E.name}</td>
                <td>${E.qty}</td>
                <td><input type="checkbox" ${E.disabled?"":"checked"}
                    data-region="${E.id}"></td>
            </tr>
            `),""),x=`
        <tr>
            <td></td>
            <td>Всего</td>
            <td>${b}</td>
        </tr>
        <tr>
            <td></td>
            <td>Сетка</td>
            <td>${v}</td>
        </tr>
        `;g(),c.insertAdjacentHTML("beforeend",T.concat(x))}function g(){c.innerHTML=""}};function NU(t,e,n){n===void 0&&(n={});var i={type:"Feature"};return(n.id===0||n.id)&&(i.id=n.id),n.bbox&&(i.bbox=n.bbox),i.properties=e||{},i.geometry=t,i}function UU(t,e,n){if(n===void 0&&(n={}),!t)throw new Error("coordinates is required");if(!Array.isArray(t))throw new Error("coordinates must be an Array");if(t.length<2)throw new Error("coordinates must be at least 2 numbers long");if(!V2(t[0])||!V2(t[1]))throw new Error("coordinates must contain numbers");var i={type:"Point",coordinates:t};return NU(i,e,n)}function V2(t){return!isNaN(t)&&t!==null&&!Array.isArray(t)}function Ow(t,e,n){if(t!==null)for(var i,o,r,s,a,l,c,d=0,u=0,f,h=t.type,_=h==="FeatureCollection",p=h==="Feature",m=_?t.features.length:1,g=0;g<m;g++){c=_?t.features[g].geometry:p?t.geometry:t,f=c?c.type==="GeometryCollection":!1,a=f?c.geometries.length:1;for(var y=0;y<a;y++){var b=0,v=0;if(s=f?c.geometries[y]:c,s!==null){l=s.coordinates;var T=s.type;switch(d=T==="Polygon"||T==="MultiPolygon"?1:0,T){case null:break;case"Point":if(e(l,u,g,b,v)===!1)return!1;u++,b++;break;case"LineString":case"MultiPoint":for(i=0;i<l.length;i++){if(e(l[i],u,g,b,v)===!1)return!1;u++,T==="MultiPoint"&&b++}T==="LineString"&&b++;break;case"Polygon":case"MultiLineString":for(i=0;i<l.length;i++){for(o=0;o<l[i].length-d;o++){if(e(l[i][o],u,g,b,v)===!1)return!1;u++}T==="MultiLineString"&&b++,T==="Polygon"&&v++}T==="Polygon"&&b++;break;case"MultiPolygon":for(i=0;i<l.length;i++){for(v=0,o=0;o<l[i].length;o++){for(r=0;r<l[i][o].length-d;r++){if(e(l[i][o][r],u,g,b,v)===!1)return!1;u++}v++}b++}break;case"GeometryCollection":for(i=0;i<s.geometries.length;i++)if(Ow(s.geometries[i],e)===!1)return!1;break;default:throw new Error("Unknown Geometry Type")}}}}}function GU(t,e){e===void 0&&(e={});var n=0,i=0,o=0;return Ow(t,function(r){n+=r[0],i+=r[1],o++}),UU([n/o,i/o],e.properties)}const HU="tile{subdomain}.maps.2gis.com",Dw="WKT_POLYGON_DEMO",VU={id:Dw,type:"polygon",filter:["match",["get","wkt_geom"],["Polygon","MultiPolygon"],!0,!1],style:{color:"#ff00000f",strokeColor:"#ff0000",strokeWidth:5}},jU=(t,e,n)=>{const i={inspectTiles:!1},o=document.createElement("div");o.style.position="absolute",o.style.display="none",o.style.border="1px solid #000000",o.style.background="rgba(255, 255, 255, 0.7)",o.style.padding="5px",o.style.pointerEvents="none",document.body.appendChild(o);const r={showTooltip:!1};e.add(r,"showTooltip").onChange(A=>{A||(o.style.display="none")}),e.add(i,"inspectTiles"),e.add(n,"showDefaultTileBounds",!!n.showDefaultTileBounds).onChange(()=>document.location.assign(bn(t,n)));let s,a,l,c,d,u;const f={debugViewport:()=>{s==null||s.destroy(),a==null||a.destroy(),l==null||l.destroy(),c==null||c.destroy(),d==null||d.forEach(A=>A.destroy()),d=t._impl.modules.tileManager.getViewportTiles().filter(A=>A.type==="zenith").map(A=>{const z=Xr(A.coords),M=q.toGeo(z.min),P=q.toGeo(z.max);return new mapgl.Polygon(t,{coordinates:[[[M[0],M[1]],[M[0],P[1]],[P[0],P[1]],[P[0],M[1]]]]})}),l=new mapgl.Polygon(t,{coordinates:[t._impl.state.tilesBounds.map(A=>q.toGeo(A))],color:"#00FF0044",strokeColor:"#00ff00"}),c=new mapgl.Polygon(t,{coordinates:[t._impl.state.extendedTilesBounds.map(A=>q.toGeo(A))],color:"#ff000044",strokeColor:"#ff0000"}),s=new mapgl.Marker(t,{coordinates:q.toGeo(t._impl.state.center)}),a=new mapgl.Marker(t,{coordinates:q.toGeo(t._impl.modules.camera.position)})},resetDebugViewport:()=>{s==null||s.destroy(),a==null||a.destroy(),l==null||l.destroy(),c==null||c.destroy(),d==null||d.forEach(A=>A.destroy())},uploadWKT:()=>{u==null||u.destroy(),u=void 0,t.removeLayer(Dw);const A=document.createElement("input");A.type="file",A.accept=".wkt, .txt",A.multiple=!0,A.addEventListener("change",z=>{const M={type:"FeatureCollection",features:[]},P=[];for(let C=0;C<z.target.files.length;C++){const D=z.target.files.item(C),B=new FileReader;P.push(new Promise(U=>{B.onload=function(G){const V=G.target.result;console.log(V),V.split(`
`).forEach(ne=>{const X=l0.parse(ne);X&&M.features.push({type:"Feature",geometry:X,properties:{wkt_geom:X.type}})}),U(!0)}})),B.readAsText(D,"utf8")}Promise.all(P).then(()=>{if(M.features.length){u=new mapgl.GeoJsonSource(t,{data:M}),t.addLayer(VU);const C=GU(M.features[0]);C.geometry!==null&&t.setCenter(C.geometry.coordinates)}})},!1),A.click()}};e.add(f,"debugViewport"),e.add(f,"resetDebugViewport"),e.add(f,"uploadWKT");async function h(A){const z=await b(),M=[];z.forEach(B=>{B==null||B.forEach(U=>{U.geometry.type===A&&M.push(U)})});const P={type:"FeatureCollection",features:M},C=document.createElement("a"),D=new Blob([JSON.stringify(P)],{type:"text/plain"});C.href=URL.createObjectURL(D),C.download=`${A}.geojson`,C.click()}const _={points:()=>h("MultiPoint"),lines:()=>h("LineString"),polygons:()=>h("Polygon"),source:"regional"},p=e.addFolder("dump"),m=["universe","regional"];p.add(_,"source",m),p.add(_,"points"),p.add(_,"lines"),p.add(_,"polygons"),t.on("mousemove",A=>{if(!A.target||!r.showTooltip)return;o.style.display="block",o.style.left=`${A.point[0]+5}px`,o.style.top=`${A.point[1]+5}px`;let z="";for(const M in A.target)z+=`<b>${M}</b>: ${A.target[M]}<br>`;o.innerHTML=z}),t.on("mouseout",()=>{r.showTooltip||(o.style.display="none")});const g=async A=>{i.inspectTiles&&y(A.lngLat)};function y(A){const z=q.fromGeo(A),M=Math.min(Math.floor(t.getZoom()),qe.maxRegionalZoom),P=Nt(M),C=[Math.floor((z[0]+2**31)/P),Math.floor((z[1]+2**31)/P),M,M],D=R3(HU,t._impl.state.tileSet,t._impl.state.tileProtocol,t._impl.state.subdomains,C,t._impl.state.tileKey,t._impl.state.appId,t._impl.state.lang,void 0,"",t._impl.state.sessionId);fetch(D).then(B=>B.arrayBuffer()).then(B=>{let U=[];B.byteLength!==0&&(U=C3(B));const G=U.length,V=[`Clicked on tile: x=${C[0]}, y=${C[1]}, z=${C[2]}`,`Request URL: ${D}`];G===0?V.push("Server returned 0 tiles."):G===1?V.push("Server returned 1 tile:"):V.push(`Server returned ${G} tiles:`),U.forEach(ne=>{const X=(ne.data.byteLength/1024).toFixed(2);V.push(`  * Region ID = ${ne.regionId}, metatileHash = ${M0(ne.metatileHash)}, buffer size = ${X} KiB`)}),console.log(V.join(`
`))})}t.on("click",g);function b(){const A=t._impl.getDefaultSource(),z=(_.source==="universe"?A.universeTileLayer:A.regionalTileLayer).getViewportTiles();return Promise.all(z.map(M=>A.zenithSource.generateTile(t._impl.state,M.coords,t._impl.state.handyStyleId,[],self.devicePixelRatio,void 0,void 0,void 0,!0).then(P=>P.geoJsonData)))}const v={async JS_Buffers(){const A=await Af(t._impl.modules),z={};for(const M in A)A[M].js&&(z[M]=L(A[M].js));N(z),w(z),S(z),k(z),console.log(z)},async GPU_Memory(){const A=await Af(t._impl.modules),z={};for(const M in A)A[M].gpu&&(z[M]=L(A[M].gpu));N(z),w(z),S(z),k(z),console.log(z)}},T=e.addFolder("memory");T.closed=!0,T.add(v,"JS_Buffers"),T.add(v,"GPU_Memory");const x="--sum",I="--count",E="--labelsCount";function L(A,z={[I]:0}){return A===void 0||(z[I]===void 0&&(z[I]=0),Array.isArray(A)||(A=[A]),typeof z[I]=="number"&&(z[I]+=A.length),A.forEach(M=>{Array.isArray(M)?L(M,z):(M[I]===void 0&&(M[I]=1),Object.keys(M).forEach(P=>{if(P===x||P===I)return;const C=M[P];if(!(Array.isArray(C)&&C.length===0))if(z[P]===void 0)if(Array.isArray(C)){z[P]={};for(const D of C)L(D,z[P])}else z[P]=C;else{if(typeof z[P]!=typeof C){console.error(`[STATS] Types mismatch for key '${P}':`,z,M);return}typeof z[P]=="number"?z[P]=Number(z[P])+Number(C):typeof C!="number"&&L(C,z[P])}}))})),z}function N(A){let z=0;for(const M in A){if(M===x||M===I||M===E)continue;const P=A[M];if(Array.isArray(P))for(const C of P)z+=N(C);else z+=typeof P=="number"?P:N(P)}return A[x]=z,z}function k(A,z=M=>M/1e6){for(const M in A){if(M===I||M===E)continue;const P=A[M];if(typeof P=="number")A[M]=z(P,A);else if(Array.isArray(P))for(const C of P)k(C,z);else k(P,z)}}function w(A){const z={[x]:0,[I]:1},M=Object.keys(A);return M.forEach(P=>{const C=A[P];if(Array.isArray(C))for(const D of C)w(D);else z[P]=typeof C=="number"?C:w(C);delete A[P]}),M.forEach(P=>{A[P]=z[P]}),A}function S(A){const z=A[x]===0;for(const M in A){if(M===I&&A[M]===1){delete A[M];continue}M!==x&&(z||A[M]===void 0?delete A[M]:typeof A[M]!="number"&&S(A[M]))}}};function sf(t,e){return t==null||e==null?NaN:t<e?-1:t>e?1:t>=e?0:NaN}function $U(t,e){return t==null||e==null?NaN:e<t?-1:e>t?1:e>=t?0:NaN}function Nw(t){let e,n,i;t.length!==2?(e=sf,n=(a,l)=>sf(t(a),l),i=(a,l)=>t(a)-l):(e=t===sf||t===$U?t:WU,n=t,i=t);function o(a,l,c=0,d=a.length){if(c<d){if(e(l,l)!==0)return d;do{const u=c+d>>>1;n(a[u],l)<0?c=u+1:d=u}while(c<d)}return c}function r(a,l,c=0,d=a.length){if(c<d){if(e(l,l)!==0)return d;do{const u=c+d>>>1;n(a[u],l)<=0?c=u+1:d=u}while(c<d)}return c}function s(a,l,c=0,d=a.length){const u=o(a,l,c,d-1);return u>c&&i(a[u-1],l)>-i(a[u],l)?u-1:u}return{left:o,center:s,right:r}}function WU(){return 0}function ZU(t){return t===null?NaN:+t}const XU=Nw(sf),YU=XU.right;Nw(ZU).center;var Gp=Math.sqrt(50),Hp=Math.sqrt(10),Vp=Math.sqrt(2);function qU(t,e,n){var i,o=-1,r,s,a;if(e=+e,t=+t,n=+n,t===e&&n>0)return[t];if((i=e<t)&&(r=t,t=e,e=r),(a=Uw(t,e,n))===0||!isFinite(a))return[];if(a>0){let l=Math.round(t/a),c=Math.round(e/a);for(l*a<t&&++l,c*a>e&&--c,s=new Array(r=c-l+1);++o<r;)s[o]=(l+o)*a}else{a=-a;let l=Math.round(t*a),c=Math.round(e*a);for(l/a<t&&++l,c/a>e&&--c,s=new Array(r=c-l+1);++o<r;)s[o]=(l+o)/a}return i&&s.reverse(),s}function Uw(t,e,n){var i=(e-t)/Math.max(0,n),o=Math.floor(Math.log(i)/Math.LN10),r=i/Math.pow(10,o);return o>=0?(r>=Gp?10:r>=Hp?5:r>=Vp?2:1)*Math.pow(10,o):-Math.pow(10,-o)/(r>=Gp?10:r>=Hp?5:r>=Vp?2:1)}function KU(t,e,n){var i=Math.abs(e-t)/Math.max(0,n),o=Math.pow(10,Math.floor(Math.log(i)/Math.LN10)),r=i/o;return r>=Gp?o*=10:r>=Hp?o*=5:r>=Vp&&(o*=2),e<t?-o:o}function JU(t){return t}var um=1,fm=2,jp=3,lc=4,j2=1e-6;function QU(t){return"translate("+t+",0)"}function eG(t){return"translate(0,"+t+")"}function tG(t){return e=>+t(e)}function nG(t,e){return e=Math.max(0,t.bandwidth()-e*2)/2,t.round()&&(e=Math.round(e)),n=>+t(n)+e}function iG(){return!this.__axis}function Gw(t,e){var n=[],i=null,o=null,r=6,s=6,a=3,l=typeof window<"u"&&window.devicePixelRatio>1?0:.5,c=t===um||t===lc?-1:1,d=t===lc||t===fm?"x":"y",u=t===um||t===jp?QU:eG;function f(h){var _=i??(e.ticks?e.ticks.apply(e,n):e.domain()),p=o??(e.tickFormat?e.tickFormat.apply(e,n):JU),m=Math.max(r,0)+a,g=e.range(),y=+g[0]+l,b=+g[g.length-1]+l,v=(e.bandwidth?nG:tG)(e.copy(),l),T=h.selection?h.selection():h,x=T.selectAll(".domain").data([null]),I=T.selectAll(".tick").data(_,e).order(),E=I.exit(),L=I.enter().append("g").attr("class","tick"),N=I.select("line"),k=I.select("text");x=x.merge(x.enter().insert("path",".tick").attr("class","domain").attr("stroke","currentColor")),I=I.merge(L),N=N.merge(L.append("line").attr("stroke","currentColor").attr(d+"2",c*r)),k=k.merge(L.append("text").attr("fill","currentColor").attr(d,c*m).attr("dy",t===um?"0em":t===jp?"0.71em":"0.32em")),h!==T&&(x=x.transition(h),I=I.transition(h),N=N.transition(h),k=k.transition(h),E=E.transition(h).attr("opacity",j2).attr("transform",function(w){return isFinite(w=v(w))?u(w+l):this.getAttribute("transform")}),L.attr("opacity",j2).attr("transform",function(w){var S=this.parentNode.__axis;return u((S&&isFinite(S=S(w))?S:v(w))+l)})),E.remove(),x.attr("d",t===lc||t===fm?s?"M"+c*s+","+y+"H"+l+"V"+b+"H"+c*s:"M"+l+","+y+"V"+b:s?"M"+y+","+c*s+"V"+l+"H"+b+"V"+c*s:"M"+y+","+l+"H"+b),I.attr("opacity",1).attr("transform",function(w){return u(v(w)+l)}),N.attr(d+"2",c*r),k.attr(d,c*m).text(p),T.filter(iG).attr("fill","none").attr("font-size",10).attr("font-family","sans-serif").attr("text-anchor",t===fm?"start":t===lc?"end":"middle"),T.each(function(){this.__axis=v})}return f.scale=function(h){return arguments.length?(e=h,f):e},f.ticks=function(){return n=Array.from(arguments),f},f.tickArguments=function(h){return arguments.length?(n=h==null?[]:Array.from(h),f):n.slice()},f.tickValues=function(h){return arguments.length?(i=h==null?null:Array.from(h),f):i&&i.slice()},f.tickFormat=function(h){return arguments.length?(o=h,f):o},f.tickSize=function(h){return arguments.length?(r=s=+h,f):r},f.tickSizeInner=function(h){return arguments.length?(r=+h,f):r},f.tickSizeOuter=function(h){return arguments.length?(s=+h,f):s},f.tickPadding=function(h){return arguments.length?(a=+h,f):a},f.offset=function(h){return arguments.length?(l=+h,f):l},f}function oG(t){return Gw(jp,t)}function rG(t){return Gw(lc,t)}var sG={value:()=>{}};function bg(){for(var t=0,e=arguments.length,n={},i;t<e;++t){if(!(i=arguments[t]+"")||i in n||/[\s.]/.test(i))throw new Error("illegal type: "+i);n[i]=[]}return new af(n)}function af(t){this._=t}function aG(t,e){return t.trim().split(/^|\s+/).map(function(n){var i="",o=n.indexOf(".");if(o>=0&&(i=n.slice(o+1),n=n.slice(0,o)),n&&!e.hasOwnProperty(n))throw new Error("unknown type: "+n);return{type:n,name:i}})}af.prototype=bg.prototype={constructor:af,on:function(t,e){var n=this._,i=aG(t+"",n),o,r=-1,s=i.length;if(arguments.length<2){for(;++r<s;)if((o=(t=i[r]).type)&&(o=lG(n[o],t.name)))return o;return}if(e!=null&&typeof e!="function")throw new Error("invalid callback: "+e);for(;++r<s;)if(o=(t=i[r]).type)n[o]=$2(n[o],t.name,e);else if(e==null)for(o in n)n[o]=$2(n[o],t.name,null);return this},copy:function(){var t={},e=this._;for(var n in e)t[n]=e[n].slice();return new af(t)},call:function(t,e){if((o=arguments.length-2)>0)for(var n=new Array(o),i=0,o,r;i<o;++i)n[i]=arguments[i+2];if(!this._.hasOwnProperty(t))throw new Error("unknown type: "+t);for(r=this._[t],i=0,o=r.length;i<o;++i)r[i].value.apply(e,n)},apply:function(t,e,n){if(!this._.hasOwnProperty(t))throw new Error("unknown type: "+t);for(var i=this._[t],o=0,r=i.length;o<r;++o)i[o].value.apply(e,n)}};function lG(t,e){for(var n=0,i=t.length,o;n<i;++n)if((o=t[n]).name===e)return o.value}function $2(t,e,n){for(var i=0,o=t.length;i<o;++i)if(t[i].name===e){t[i]=sG,t=t.slice(0,i).concat(t.slice(i+1));break}return n!=null&&t.push({name:e,value:n}),t}var $p="http://www.w3.org/1999/xhtml";const W2={svg:"http://www.w3.org/2000/svg",xhtml:$p,xlink:"http://www.w3.org/1999/xlink",xml:"http://www.w3.org/XML/1998/namespace",xmlns:"http://www.w3.org/2000/xmlns/"};function bh(t){var e=t+="",n=e.indexOf(":");return n>=0&&(e=t.slice(0,n))!=="xmlns"&&(t=t.slice(n+1)),W2.hasOwnProperty(e)?{space:W2[e],local:t}:t}function cG(t){return function(){var e=this.ownerDocument,n=this.namespaceURI;return n===$p&&e.documentElement.namespaceURI===$p?e.createElement(t):e.createElementNS(n,t)}}function dG(t){return function(){return this.ownerDocument.createElementNS(t.space,t.local)}}function Hw(t){var e=bh(t);return(e.local?dG:cG)(e)}function uG(){}function wg(t){return t==null?uG:function(){return this.querySelector(t)}}function fG(t){typeof t!="function"&&(t=wg(t));for(var e=this._groups,n=e.length,i=new Array(n),o=0;o<n;++o)for(var r=e[o],s=r.length,a=i[o]=new Array(s),l,c,d=0;d<s;++d)(l=r[d])&&(c=t.call(l,l.__data__,d,r))&&("__data__"in l&&(c.__data__=l.__data__),a[d]=c);return new wi(i,this._parents)}function hG(t){return t==null?[]:Array.isArray(t)?t:Array.from(t)}function _G(){return[]}function Vw(t){return t==null?_G:function(){return this.querySelectorAll(t)}}function mG(t){return function(){return hG(t.apply(this,arguments))}}function pG(t){typeof t=="function"?t=mG(t):t=Vw(t);for(var e=this._groups,n=e.length,i=[],o=[],r=0;r<n;++r)for(var s=e[r],a=s.length,l,c=0;c<a;++c)(l=s[c])&&(i.push(t.call(l,l.__data__,c,s)),o.push(l));return new wi(i,o)}function jw(t){return function(){return this.matches(t)}}function $w(t){return function(e){return e.matches(t)}}var gG=Array.prototype.find;function vG(t){return function(){return gG.call(this.children,t)}}function yG(){return this.firstElementChild}function bG(t){return this.select(t==null?yG:vG(typeof t=="function"?t:$w(t)))}var wG=Array.prototype.filter;function xG(){return Array.from(this.children)}function SG(t){return function(){return wG.call(this.children,t)}}function MG(t){return this.selectAll(t==null?xG:SG(typeof t=="function"?t:$w(t)))}function TG(t){typeof t!="function"&&(t=jw(t));for(var e=this._groups,n=e.length,i=new Array(n),o=0;o<n;++o)for(var r=e[o],s=r.length,a=i[o]=[],l,c=0;c<s;++c)(l=r[c])&&t.call(l,l.__data__,c,r)&&a.push(l);return new wi(i,this._parents)}function Ww(t){return new Array(t.length)}function IG(){return new wi(this._enter||this._groups.map(Ww),this._parents)}function Uf(t,e){this.ownerDocument=t.ownerDocument,this.namespaceURI=t.namespaceURI,this._next=null,this._parent=t,this.__data__=e}Uf.prototype={constructor:Uf,appendChild:function(t){return this._parent.insertBefore(t,this._next)},insertBefore:function(t,e){return this._parent.insertBefore(t,e)},querySelector:function(t){return this._parent.querySelector(t)},querySelectorAll:function(t){return this._parent.querySelectorAll(t)}};function EG(t){return function(){return t}}function AG(t,e,n,i,o,r){for(var s=0,a,l=e.length,c=r.length;s<c;++s)(a=e[s])?(a.__data__=r[s],i[s]=a):n[s]=new Uf(t,r[s]);for(;s<l;++s)(a=e[s])&&(o[s]=a)}function CG(t,e,n,i,o,r,s){var a,l,c=new Map,d=e.length,u=r.length,f=new Array(d),h;for(a=0;a<d;++a)(l=e[a])&&(f[a]=h=s.call(l,l.__data__,a,e)+"",c.has(h)?o[a]=l:c.set(h,l));for(a=0;a<u;++a)h=s.call(t,r[a],a,r)+"",(l=c.get(h))?(i[a]=l,l.__data__=r[a],c.delete(h)):n[a]=new Uf(t,r[a]);for(a=0;a<d;++a)(l=e[a])&&c.get(f[a])===l&&(o[a]=l)}function PG(t){return t.__data__}function LG(t,e){if(!arguments.length)return Array.from(this,PG);var n=e?CG:AG,i=this._parents,o=this._groups;typeof t!="function"&&(t=EG(t));for(var r=o.length,s=new Array(r),a=new Array(r),l=new Array(r),c=0;c<r;++c){var d=i[c],u=o[c],f=u.length,h=FG(t.call(d,d&&d.__data__,c,i)),_=h.length,p=a[c]=new Array(_),m=s[c]=new Array(_),g=l[c]=new Array(f);n(d,u,p,m,g,h,e);for(var y=0,b=0,v,T;y<_;++y)if(v=p[y]){for(y>=b&&(b=y+1);!(T=m[b])&&++b<_;);v._next=T||null}}return s=new wi(s,i),s._enter=a,s._exit=l,s}function FG(t){return typeof t=="object"&&"length"in t?t:Array.from(t)}function kG(){return new wi(this._exit||this._groups.map(Ww),this._parents)}function RG(t,e,n){var i=this.enter(),o=this,r=this.exit();return typeof t=="function"?(i=t(i),i&&(i=i.selection())):i=i.append(t+""),e!=null&&(o=e(o),o&&(o=o.selection())),n==null?r.remove():n(r),i&&o?i.merge(o).order():o}function zG(t){for(var e=t.selection?t.selection():t,n=this._groups,i=e._groups,o=n.length,r=i.length,s=Math.min(o,r),a=new Array(o),l=0;l<s;++l)for(var c=n[l],d=i[l],u=c.length,f=a[l]=new Array(u),h,_=0;_<u;++_)(h=c[_]||d[_])&&(f[_]=h);for(;l<o;++l)a[l]=n[l];return new wi(a,this._parents)}function BG(){for(var t=this._groups,e=-1,n=t.length;++e<n;)for(var i=t[e],o=i.length-1,r=i[o],s;--o>=0;)(s=i[o])&&(r&&s.compareDocumentPosition(r)^4&&r.parentNode.insertBefore(s,r),r=s);return this}function OG(t){t||(t=DG);function e(u,f){return u&&f?t(u.__data__,f.__data__):!u-!f}for(var n=this._groups,i=n.length,o=new Array(i),r=0;r<i;++r){for(var s=n[r],a=s.length,l=o[r]=new Array(a),c,d=0;d<a;++d)(c=s[d])&&(l[d]=c);l.sort(e)}return new wi(o,this._parents).order()}function DG(t,e){return t<e?-1:t>e?1:t>=e?0:NaN}function NG(){var t=arguments[0];return arguments[0]=this,t.apply(null,arguments),this}function UG(){return Array.from(this)}function GG(){for(var t=this._groups,e=0,n=t.length;e<n;++e)for(var i=t[e],o=0,r=i.length;o<r;++o){var s=i[o];if(s)return s}return null}function HG(){let t=0;for(const e of this)++t;return t}function VG(){return!this.node()}function jG(t){for(var e=this._groups,n=0,i=e.length;n<i;++n)for(var o=e[n],r=0,s=o.length,a;r<s;++r)(a=o[r])&&t.call(a,a.__data__,r,o);return this}function $G(t){return function(){this.removeAttribute(t)}}function WG(t){return function(){this.removeAttributeNS(t.space,t.local)}}function ZG(t,e){return function(){this.setAttribute(t,e)}}function XG(t,e){return function(){this.setAttributeNS(t.space,t.local,e)}}function YG(t,e){return function(){var n=e.apply(this,arguments);n==null?this.removeAttribute(t):this.setAttribute(t,n)}}function qG(t,e){return function(){var n=e.apply(this,arguments);n==null?this.removeAttributeNS(t.space,t.local):this.setAttributeNS(t.space,t.local,n)}}function KG(t,e){var n=bh(t);if(arguments.length<2){var i=this.node();return n.local?i.getAttributeNS(n.space,n.local):i.getAttribute(n)}return this.each((e==null?n.local?WG:$G:typeof e=="function"?n.local?qG:YG:n.local?XG:ZG)(n,e))}function Zw(t){return t.ownerDocument&&t.ownerDocument.defaultView||t.document&&t||t.defaultView}function JG(t){return function(){this.style.removeProperty(t)}}function QG(t,e,n){return function(){this.style.setProperty(t,e,n)}}function eH(t,e,n){return function(){var i=e.apply(this,arguments);i==null?this.style.removeProperty(t):this.style.setProperty(t,i,n)}}function tH(t,e,n){return arguments.length>1?this.each((e==null?JG:typeof e=="function"?eH:QG)(t,e,n??"")):ol(this.node(),t)}function ol(t,e){return t.style.getPropertyValue(e)||Zw(t).getComputedStyle(t,null).getPropertyValue(e)}function nH(t){return function(){delete this[t]}}function iH(t,e){return function(){this[t]=e}}function oH(t,e){return function(){var n=e.apply(this,arguments);n==null?delete this[t]:this[t]=n}}function rH(t,e){return arguments.length>1?this.each((e==null?nH:typeof e=="function"?oH:iH)(t,e)):this.node()[t]}function Xw(t){return t.trim().split(/^|\s+/)}function xg(t){return t.classList||new Yw(t)}function Yw(t){this._node=t,this._names=Xw(t.getAttribute("class")||"")}Yw.prototype={add:function(t){var e=this._names.indexOf(t);e<0&&(this._names.push(t),this._node.setAttribute("class",this._names.join(" ")))},remove:function(t){var e=this._names.indexOf(t);e>=0&&(this._names.splice(e,1),this._node.setAttribute("class",this._names.join(" ")))},contains:function(t){return this._names.indexOf(t)>=0}};function qw(t,e){for(var n=xg(t),i=-1,o=e.length;++i<o;)n.add(e[i])}function Kw(t,e){for(var n=xg(t),i=-1,o=e.length;++i<o;)n.remove(e[i])}function sH(t){return function(){qw(this,t)}}function aH(t){return function(){Kw(this,t)}}function lH(t,e){return function(){(e.apply(this,arguments)?qw:Kw)(this,t)}}function cH(t,e){var n=Xw(t+"");if(arguments.length<2){for(var i=xg(this.node()),o=-1,r=n.length;++o<r;)if(!i.contains(n[o]))return!1;return!0}return this.each((typeof e=="function"?lH:e?sH:aH)(n,e))}function dH(){this.textContent=""}function uH(t){return function(){this.textContent=t}}function fH(t){return function(){var e=t.apply(this,arguments);this.textContent=e??""}}function hH(t){return arguments.length?this.each(t==null?dH:(typeof t=="function"?fH:uH)(t)):this.node().textContent}function _H(){this.innerHTML=""}function mH(t){return function(){this.innerHTML=t}}function pH(t){return function(){var e=t.apply(this,arguments);this.innerHTML=e??""}}function gH(t){return arguments.length?this.each(t==null?_H:(typeof t=="function"?pH:mH)(t)):this.node().innerHTML}function vH(){this.nextSibling&&this.parentNode.appendChild(this)}function yH(){return this.each(vH)}function bH(){this.previousSibling&&this.parentNode.insertBefore(this,this.parentNode.firstChild)}function wH(){return this.each(bH)}function xH(t){var e=typeof t=="function"?t:Hw(t);return this.select(function(){return this.appendChild(e.apply(this,arguments))})}function SH(){return null}function MH(t,e){var n=typeof t=="function"?t:Hw(t),i=e==null?SH:typeof e=="function"?e:wg(e);return this.select(function(){return this.insertBefore(n.apply(this,arguments),i.apply(this,arguments)||null)})}function TH(){var t=this.parentNode;t&&t.removeChild(this)}function IH(){return this.each(TH)}function EH(){var t=this.cloneNode(!1),e=this.parentNode;return e?e.insertBefore(t,this.nextSibling):t}function AH(){var t=this.cloneNode(!0),e=this.parentNode;return e?e.insertBefore(t,this.nextSibling):t}function CH(t){return this.select(t?AH:EH)}function PH(t){return arguments.length?this.property("__data__",t):this.node().__data__}function LH(t){return function(e){t.call(this,e,this.__data__)}}function FH(t){return t.trim().split(/^|\s+/).map(function(e){var n="",i=e.indexOf(".");return i>=0&&(n=e.slice(i+1),e=e.slice(0,i)),{type:e,name:n}})}function kH(t){return function(){var e=this.__on;if(e){for(var n=0,i=-1,o=e.length,r;n<o;++n)r=e[n],(!t.type||r.type===t.type)&&r.name===t.name?this.removeEventListener(r.type,r.listener,r.options):e[++i]=r;++i?e.length=i:delete this.__on}}}function RH(t,e,n){return function(){var i=this.__on,o,r=LH(e);if(i){for(var s=0,a=i.length;s<a;++s)if((o=i[s]).type===t.type&&o.name===t.name){this.removeEventListener(o.type,o.listener,o.options),this.addEventListener(o.type,o.listener=r,o.options=n),o.value=e;return}}this.addEventListener(t.type,r,n),o={type:t.type,name:t.name,value:e,listener:r,options:n},i?i.push(o):this.__on=[o]}}function zH(t,e,n){var i=FH(t+""),o,r=i.length,s;if(arguments.length<2){var a=this.node().__on;if(a){for(var l=0,c=a.length,d;l<c;++l)for(o=0,d=a[l];o<r;++o)if((s=i[o]).type===d.type&&s.name===d.name)return d.value}return}for(a=e?RH:kH,o=0;o<r;++o)this.each(a(i[o],e,n));return this}function Jw(t,e,n){var i=Zw(t),o=i.CustomEvent;typeof o=="function"?o=new o(e,n):(o=i.document.createEvent("Event"),n?(o.initEvent(e,n.bubbles,n.cancelable),o.detail=n.detail):o.initEvent(e,!1,!1)),t.dispatchEvent(o)}function BH(t,e){return function(){return Jw(this,t,e)}}function OH(t,e){return function(){return Jw(this,t,e.apply(this,arguments))}}function DH(t,e){return this.each((typeof e=="function"?OH:BH)(t,e))}function*NH(){for(var t=this._groups,e=0,n=t.length;e<n;++e)for(var i=t[e],o=0,r=i.length,s;o<r;++o)(s=i[o])&&(yield s)}var Qw=[null];function wi(t,e){this._groups=t,this._parents=e}function td(){return new wi([[document.documentElement]],Qw)}function UH(){return this}wi.prototype=td.prototype={constructor:wi,select:fG,selectAll:pG,selectChild:bG,selectChildren:MG,filter:TG,data:LG,enter:IG,exit:kG,join:RG,merge:zG,selection:UH,order:BG,sort:OG,call:NG,nodes:UG,node:GG,size:HG,empty:VG,each:jG,attr:KG,style:tH,property:rH,classed:cH,text:hH,html:gH,raise:yH,lower:wH,append:xH,insert:MH,remove:IH,clone:CH,datum:PH,on:zH,dispatch:DH,[Symbol.iterator]:NH};function rl(t){return typeof t=="string"?new wi([[document.querySelector(t)]],[document.documentElement]):new wi([[t]],Qw)}function GH(t){let e;for(;e=t.sourceEvent;)t=e;return t}function Z2(t,e){if(t=GH(t),e===void 0&&(e=t.currentTarget),e){var n=e.ownerSVGElement||e;if(n.createSVGPoint){var i=n.createSVGPoint();return i.x=t.clientX,i.y=t.clientY,i=i.matrixTransform(e.getScreenCTM().inverse()),[i.x,i.y]}if(e.getBoundingClientRect){var o=e.getBoundingClientRect();return[t.clientX-o.left-e.clientLeft,t.clientY-o.top-e.clientTop]}}return[t.pageX,t.pageY]}const HH={passive:!1},Dc={capture:!0,passive:!1};function hm(t){t.stopImmediatePropagation()}function Ua(t){t.preventDefault(),t.stopImmediatePropagation()}function VH(t){var e=t.document.documentElement,n=rl(t).on("dragstart.drag",Ua,Dc);"onselectstart"in e?n.on("selectstart.drag",Ua,Dc):(e.__noselect=e.style.MozUserSelect,e.style.MozUserSelect="none")}function jH(t,e){var n=t.document.documentElement,i=rl(t).on("dragstart.drag",null);e&&(i.on("click.drag",Ua,Dc),setTimeout(function(){i.on("click.drag",null)},0)),"onselectstart"in n?i.on("selectstart.drag",null):(n.style.MozUserSelect=n.__noselect,delete n.__noselect)}const Fu=t=>()=>t;function Wp(t,{sourceEvent:e,subject:n,target:i,identifier:o,active:r,x:s,y:a,dx:l,dy:c,dispatch:d}){Object.defineProperties(this,{type:{value:t,enumerable:!0,configurable:!0},sourceEvent:{value:e,enumerable:!0,configurable:!0},subject:{value:n,enumerable:!0,configurable:!0},target:{value:i,enumerable:!0,configurable:!0},identifier:{value:o,enumerable:!0,configurable:!0},active:{value:r,enumerable:!0,configurable:!0},x:{value:s,enumerable:!0,configurable:!0},y:{value:a,enumerable:!0,configurable:!0},dx:{value:l,enumerable:!0,configurable:!0},dy:{value:c,enumerable:!0,configurable:!0},_:{value:d}})}Wp.prototype.on=function(){var t=this._.on.apply(this._,arguments);return t===this._?this:t};function $H(t){return!t.ctrlKey&&!t.button}function WH(){return this.parentNode}function ZH(t,e){return e??{x:t.x,y:t.y}}function XH(){return navigator.maxTouchPoints||"ontouchstart"in this}function YH(){var t=$H,e=WH,n=ZH,i=XH,o={},r=bg("start","drag","end"),s=0,a,l,c,d,u=0;function f(v){v.on("mousedown.drag",h).filter(i).on("touchstart.drag",m).on("touchmove.drag",g,HH).on("touchend.drag touchcancel.drag",y).style("touch-action","none").style("-webkit-tap-highlight-color","rgba(0,0,0,0)")}function h(v,T){if(!(d||!t.call(this,v,T))){var x=b(this,e.call(this,v,T),v,T,"mouse");x&&(rl(v.view).on("mousemove.drag",_,Dc).on("mouseup.drag",p,Dc),VH(v.view),hm(v),c=!1,a=v.clientX,l=v.clientY,x("start",v))}}function _(v){if(Ua(v),!c){var T=v.clientX-a,x=v.clientY-l;c=T*T+x*x>u}o.mouse("drag",v)}function p(v){rl(v.view).on("mousemove.drag mouseup.drag",null),jH(v.view,c),Ua(v),o.mouse("end",v)}function m(v,T){if(t.call(this,v,T)){var x=v.changedTouches,I=e.call(this,v,T),E=x.length,L,N;for(L=0;L<E;++L)(N=b(this,I,v,T,x[L].identifier,x[L]))&&(hm(v),N("start",v,x[L]))}}function g(v){var T=v.changedTouches,x=T.length,I,E;for(I=0;I<x;++I)(E=o[T[I].identifier])&&(Ua(v),E("drag",v,T[I]))}function y(v){var T=v.changedTouches,x=T.length,I,E;for(d&&clearTimeout(d),d=setTimeout(function(){d=null},500),I=0;I<x;++I)(E=o[T[I].identifier])&&(hm(v),E("end",v,T[I]))}function b(v,T,x,I,E,L){var N=r.copy(),k=Z2(L||x,T),w,S,A;if((A=n.call(v,new Wp("beforestart",{sourceEvent:x,target:f,identifier:E,active:s,x:k[0],y:k[1],dx:0,dy:0,dispatch:N}),I))!=null)return w=A.x-k[0]||0,S=A.y-k[1]||0,function z(M,P,C){var D=k,B;switch(M){case"start":o[E]=z,B=s++;break;case"end":delete o[E],--s;case"drag":k=Z2(C||P,T),B=s;break}N.call(M,v,new Wp(M,{sourceEvent:P,subject:A,target:f,identifier:E,active:B,x:k[0]+w,y:k[1]+S,dx:k[0]-D[0],dy:k[1]-D[1],dispatch:N}),I)}}return f.filter=function(v){return arguments.length?(t=typeof v=="function"?v:Fu(!!v),f):t},f.container=function(v){return arguments.length?(e=typeof v=="function"?v:Fu(v),f):e},f.subject=function(v){return arguments.length?(n=typeof v=="function"?v:Fu(v),f):n},f.touchable=function(v){return arguments.length?(i=typeof v=="function"?v:Fu(!!v),f):i},f.on=function(){var v=r.on.apply(r,arguments);return v===r?f:v},f.clickDistance=function(v){return arguments.length?(u=(v=+v)*v,f):Math.sqrt(u)},f}function Sg(t,e,n){t.prototype=e.prototype=n,n.constructor=t}function e9(t,e){var n=Object.create(t.prototype);for(var i in e)n[i]=e[i];return n}function nd(){}var Nc=.7,Gf=1/Nc,Ga="\\s*([+-]?\\d+)\\s*",Uc="\\s*([+-]?(?:\\d*\\.)?\\d+(?:[eE][+-]?\\d+)?)\\s*",jo="\\s*([+-]?(?:\\d*\\.)?\\d+(?:[eE][+-]?\\d+)?)%\\s*",qH=/^#([0-9a-f]{3,8})$/,KH=new RegExp(`^rgb\\(${Ga},${Ga},${Ga}\\)$`),JH=new RegExp(`^rgb\\(${jo},${jo},${jo}\\)$`),QH=new RegExp(`^rgba\\(${Ga},${Ga},${Ga},${Uc}\\)$`),eV=new RegExp(`^rgba\\(${jo},${jo},${jo},${Uc}\\)$`),tV=new RegExp(`^hsl\\(${Uc},${jo},${jo}\\)$`),nV=new RegExp(`^hsla\\(${Uc},${jo},${jo},${Uc}\\)$`),X2={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074};Sg(nd,Vs,{copy(t){return Object.assign(new this.constructor,this,t)},displayable(){return this.rgb().displayable()},hex:Y2,formatHex:Y2,formatHex8:iV,formatHsl:oV,formatRgb:q2,toString:q2});function Y2(){return this.rgb().formatHex()}function iV(){return this.rgb().formatHex8()}function oV(){return t9(this).formatHsl()}function q2(){return this.rgb().formatRgb()}function Vs(t){var e,n;return t=(t+"").trim().toLowerCase(),(e=qH.exec(t))?(n=e[1].length,e=parseInt(e[1],16),n===6?K2(e):n===3?new Jn(e>>8&15|e>>4&240,e>>4&15|e&240,(e&15)<<4|e&15,1):n===8?ku(e>>24&255,e>>16&255,e>>8&255,(e&255)/255):n===4?ku(e>>12&15|e>>8&240,e>>8&15|e>>4&240,e>>4&15|e&240,((e&15)<<4|e&15)/255):null):(e=KH.exec(t))?new Jn(e[1],e[2],e[3],1):(e=JH.exec(t))?new Jn(e[1]*255/100,e[2]*255/100,e[3]*255/100,1):(e=QH.exec(t))?ku(e[1],e[2],e[3],e[4]):(e=eV.exec(t))?ku(e[1]*255/100,e[2]*255/100,e[3]*255/100,e[4]):(e=tV.exec(t))?e4(e[1],e[2]/100,e[3]/100,1):(e=nV.exec(t))?e4(e[1],e[2]/100,e[3]/100,e[4]):X2.hasOwnProperty(t)?K2(X2[t]):t==="transparent"?new Jn(NaN,NaN,NaN,0):null}function K2(t){return new Jn(t>>16&255,t>>8&255,t&255,1)}function ku(t,e,n,i){return i<=0&&(t=e=n=NaN),new Jn(t,e,n,i)}function rV(t){return t instanceof nd||(t=Vs(t)),t?(t=t.rgb(),new Jn(t.r,t.g,t.b,t.opacity)):new Jn}function Zp(t,e,n,i){return arguments.length===1?rV(t):new Jn(t,e,n,i??1)}function Jn(t,e,n,i){this.r=+t,this.g=+e,this.b=+n,this.opacity=+i}Sg(Jn,Zp,e9(nd,{brighter(t){return t=t==null?Gf:Math.pow(Gf,t),new Jn(this.r*t,this.g*t,this.b*t,this.opacity)},darker(t){return t=t==null?Nc:Math.pow(Nc,t),new Jn(this.r*t,this.g*t,this.b*t,this.opacity)},rgb(){return this},clamp(){return new Jn(Cs(this.r),Cs(this.g),Cs(this.b),Hf(this.opacity))},displayable(){return-.5<=this.r&&this.r<255.5&&-.5<=this.g&&this.g<255.5&&-.5<=this.b&&this.b<255.5&&0<=this.opacity&&this.opacity<=1},hex:J2,formatHex:J2,formatHex8:sV,formatRgb:Q2,toString:Q2}));function J2(){return`#${ws(this.r)}${ws(this.g)}${ws(this.b)}`}function sV(){return`#${ws(this.r)}${ws(this.g)}${ws(this.b)}${ws((isNaN(this.opacity)?1:this.opacity)*255)}`}function Q2(){const t=Hf(this.opacity);return`${t===1?"rgb(":"rgba("}${Cs(this.r)}, ${Cs(this.g)}, ${Cs(this.b)}${t===1?")":`, ${t})`}`}function Hf(t){return isNaN(t)?1:Math.max(0,Math.min(1,t))}function Cs(t){return Math.max(0,Math.min(255,Math.round(t)||0))}function ws(t){return t=Cs(t),(t<16?"0":"")+t.toString(16)}function e4(t,e,n,i){return i<=0?t=e=n=NaN:n<=0||n>=1?t=e=NaN:e<=0&&(t=NaN),new Ji(t,e,n,i)}function t9(t){if(t instanceof Ji)return new Ji(t.h,t.s,t.l,t.opacity);if(t instanceof nd||(t=Vs(t)),!t)return new Ji;if(t instanceof Ji)return t;t=t.rgb();var e=t.r/255,n=t.g/255,i=t.b/255,o=Math.min(e,n,i),r=Math.max(e,n,i),s=NaN,a=r-o,l=(r+o)/2;return a?(e===r?s=(n-i)/a+(n<i)*6:n===r?s=(i-e)/a+2:s=(e-n)/a+4,a/=l<.5?r+o:2-r-o,s*=60):a=l>0&&l<1?0:s,new Ji(s,a,l,t.opacity)}function aV(t,e,n,i){return arguments.length===1?t9(t):new Ji(t,e,n,i??1)}function Ji(t,e,n,i){this.h=+t,this.s=+e,this.l=+n,this.opacity=+i}Sg(Ji,aV,e9(nd,{brighter(t){return t=t==null?Gf:Math.pow(Gf,t),new Ji(this.h,this.s,this.l*t,this.opacity)},darker(t){return t=t==null?Nc:Math.pow(Nc,t),new Ji(this.h,this.s,this.l*t,this.opacity)},rgb(){var t=this.h%360+(this.h<0)*360,e=isNaN(t)||isNaN(this.s)?0:this.s,n=this.l,i=n+(n<.5?n:1-n)*e,o=2*n-i;return new Jn(_m(t>=240?t-240:t+120,o,i),_m(t,o,i),_m(t<120?t+240:t-120,o,i),this.opacity)},clamp(){return new Ji(t4(this.h),Ru(this.s),Ru(this.l),Hf(this.opacity))},displayable(){return(0<=this.s&&this.s<=1||isNaN(this.s))&&0<=this.l&&this.l<=1&&0<=this.opacity&&this.opacity<=1},formatHsl(){const t=Hf(this.opacity);return`${t===1?"hsl(":"hsla("}${t4(this.h)}, ${Ru(this.s)*100}%, ${Ru(this.l)*100}%${t===1?")":`, ${t})`}`}}));function t4(t){return t=(t||0)%360,t<0?t+360:t}function Ru(t){return Math.max(0,Math.min(1,t||0))}function _m(t,e,n){return(t<60?e+(n-e)*t/60:t<180?n:t<240?e+(n-e)*(240-t)/60:e)*255}const Mg=t=>()=>t;function lV(t,e){return function(n){return t+n*e}}function cV(t,e,n){return t=Math.pow(t,n),e=Math.pow(e,n)-t,n=1/n,function(i){return Math.pow(t+i*e,n)}}function dV(t){return(t=+t)==1?n9:function(e,n){return n-e?cV(e,n,t):Mg(isNaN(e)?n:e)}}function n9(t,e){var n=e-t;return n?lV(t,n):Mg(isNaN(t)?e:t)}const Vf=function t(e){var n=dV(e);function i(o,r){var s=n((o=Zp(o)).r,(r=Zp(r)).r),a=n(o.g,r.g),l=n(o.b,r.b),c=n9(o.opacity,r.opacity);return function(d){return o.r=s(d),o.g=a(d),o.b=l(d),o.opacity=c(d),o+""}}return i.gamma=t,i}(1);function uV(t,e){e||(e=[]);var n=t?Math.min(e.length,t.length):0,i=e.slice(),o;return function(r){for(o=0;o<n;++o)i[o]=t[o]*(1-r)+e[o]*r;return i}}function fV(t){return ArrayBuffer.isView(t)&&!(t instanceof DataView)}function hV(t,e){var n=e?e.length:0,i=t?Math.min(n,t.length):0,o=new Array(i),r=new Array(n),s;for(s=0;s<i;++s)o[s]=Tg(t[s],e[s]);for(;s<n;++s)r[s]=e[s];return function(a){for(s=0;s<i;++s)r[s]=o[s](a);return r}}function _V(t,e){var n=new Date;return t=+t,e=+e,function(i){return n.setTime(t*(1-i)+e*i),n}}function Xi(t,e){return t=+t,e=+e,function(n){return t*(1-n)+e*n}}function mV(t,e){var n={},i={},o;(t===null||typeof t!="object")&&(t={}),(e===null||typeof e!="object")&&(e={});for(o in e)o in t?n[o]=Tg(t[o],e[o]):i[o]=e[o];return function(r){for(o in n)i[o]=n[o](r);return i}}var Xp=/[-+]?(?:\d+\.?\d*|\.?\d+)(?:[eE][-+]?\d+)?/g,mm=new RegExp(Xp.source,"g");function pV(t){return function(){return t}}function gV(t){return function(e){return t(e)+""}}function i9(t,e){var n=Xp.lastIndex=mm.lastIndex=0,i,o,r,s=-1,a=[],l=[];for(t=t+"",e=e+"";(i=Xp.exec(t))&&(o=mm.exec(e));)(r=o.index)>n&&(r=e.slice(n,r),a[s]?a[s]+=r:a[++s]=r),(i=i[0])===(o=o[0])?a[s]?a[s]+=o:a[++s]=o:(a[++s]=null,l.push({i:s,x:Xi(i,o)})),n=mm.lastIndex;return n<e.length&&(r=e.slice(n),a[s]?a[s]+=r:a[++s]=r),a.length<2?l[0]?gV(l[0].x):pV(e):(e=l.length,function(c){for(var d=0,u;d<e;++d)a[(u=l[d]).i]=u.x(c);return a.join("")})}function Tg(t,e){var n=typeof e,i;return e==null||n==="boolean"?Mg(e):(n==="number"?Xi:n==="string"?(i=Vs(e))?(e=i,Vf):i9:e instanceof Vs?Vf:e instanceof Date?_V:fV(e)?uV:Array.isArray(e)?hV:typeof e.valueOf!="function"&&typeof e.toString!="function"||isNaN(e)?mV:Xi)(t,e)}function vV(t,e){return t=+t,e=+e,function(n){return Math.round(t*(1-n)+e*n)}}var n4=180/Math.PI,Yp={translateX:0,translateY:0,rotate:0,skewX:0,scaleX:1,scaleY:1};function o9(t,e,n,i,o,r){var s,a,l;return(s=Math.sqrt(t*t+e*e))&&(t/=s,e/=s),(l=t*n+e*i)&&(n-=t*l,i-=e*l),(a=Math.sqrt(n*n+i*i))&&(n/=a,i/=a,l/=a),t*i<e*n&&(t=-t,e=-e,l=-l,s=-s),{translateX:o,translateY:r,rotate:Math.atan2(e,t)*n4,skewX:Math.atan(l)*n4,scaleX:s,scaleY:a}}var zu;function yV(t){const e=new(typeof DOMMatrix=="function"?DOMMatrix:WebKitCSSMatrix)(t+"");return e.isIdentity?Yp:o9(e.a,e.b,e.c,e.d,e.e,e.f)}function bV(t){return t==null||(zu||(zu=document.createElementNS("http://www.w3.org/2000/svg","g")),zu.setAttribute("transform",t),!(t=zu.transform.baseVal.consolidate()))?Yp:(t=t.matrix,o9(t.a,t.b,t.c,t.d,t.e,t.f))}function r9(t,e,n,i){function o(c){return c.length?c.pop()+" ":""}function r(c,d,u,f,h,_){if(c!==u||d!==f){var p=h.push("translate(",null,e,null,n);_.push({i:p-4,x:Xi(c,u)},{i:p-2,x:Xi(d,f)})}else(u||f)&&h.push("translate("+u+e+f+n)}function s(c,d,u,f){c!==d?(c-d>180?d+=360:d-c>180&&(c+=360),f.push({i:u.push(o(u)+"rotate(",null,i)-2,x:Xi(c,d)})):d&&u.push(o(u)+"rotate("+d+i)}function a(c,d,u,f){c!==d?f.push({i:u.push(o(u)+"skewX(",null,i)-2,x:Xi(c,d)}):d&&u.push(o(u)+"skewX("+d+i)}function l(c,d,u,f,h,_){if(c!==u||d!==f){var p=h.push(o(h)+"scale(",null,",",null,")");_.push({i:p-4,x:Xi(c,u)},{i:p-2,x:Xi(d,f)})}else(u!==1||f!==1)&&h.push(o(h)+"scale("+u+","+f+")")}return function(c,d){var u=[],f=[];return c=t(c),d=t(d),r(c.translateX,c.translateY,d.translateX,d.translateY,u,f),s(c.rotate,d.rotate,u,f),a(c.skewX,d.skewX,u,f),l(c.scaleX,c.scaleY,d.scaleX,d.scaleY,u,f),c=d=null,function(h){for(var _=-1,p=f.length,m;++_<p;)u[(m=f[_]).i]=m.x(h);return u.join("")}}}var wV=r9(yV,"px, ","px)","deg)"),xV=r9(bV,", ",")",")"),sl=0,cc=0,Kl=0,s9=1e3,jf,dc,$f=0,js=0,wh=0,Gc=typeof performance=="object"&&performance.now?performance:Date,a9=typeof window=="object"&&window.requestAnimationFrame?window.requestAnimationFrame.bind(window):function(t){setTimeout(t,17)};function Ig(){return js||(a9(SV),js=Gc.now()+wh)}function SV(){js=0}function Wf(){this._call=this._time=this._next=null}Wf.prototype=l9.prototype={constructor:Wf,restart:function(t,e,n){if(typeof t!="function")throw new TypeError("callback is not a function");n=(n==null?Ig():+n)+(e==null?0:+e),!this._next&&dc!==this&&(dc?dc._next=this:jf=this,dc=this),this._call=t,this._time=n,qp()},stop:function(){this._call&&(this._call=null,this._time=1/0,qp())}};function l9(t,e,n){var i=new Wf;return i.restart(t,e,n),i}function MV(){Ig(),++sl;for(var t=jf,e;t;)(e=js-t._time)>=0&&t._call.call(void 0,e),t=t._next;--sl}function i4(){js=($f=Gc.now())+wh,sl=cc=0;try{MV()}finally{sl=0,IV(),js=0}}function TV(){var t=Gc.now(),e=t-$f;e>s9&&(wh-=e,$f=t)}function IV(){for(var t,e=jf,n,i=1/0;e;)e._call?(i>e._time&&(i=e._time),t=e,e=e._next):(n=e._next,e._next=null,e=t?t._next=n:jf=n);dc=t,qp(i)}function qp(t){if(!sl){cc&&(cc=clearTimeout(cc));var e=t-js;e>24?(t<1/0&&(cc=setTimeout(i4,t-Gc.now()-wh)),Kl&&(Kl=clearInterval(Kl))):(Kl||($f=Gc.now(),Kl=setInterval(TV,s9)),sl=1,a9(i4))}}function o4(t,e,n){var i=new Wf;return e=e==null?0:+e,i.restart(o=>{i.stop(),t(o+e)},e,n),i}var EV=bg("start","end","cancel","interrupt"),AV=[],c9=0,r4=1,Kp=2,lf=3,s4=4,Jp=5,cf=6;function xh(t,e,n,i,o,r){var s=t.__transition;if(!s)t.__transition={};else if(n in s)return;CV(t,n,{name:e,index:i,group:o,on:EV,tween:AV,time:r.time,delay:r.delay,duration:r.duration,ease:r.ease,timer:null,state:c9})}function Eg(t,e){var n=go(t,e);if(n.state>c9)throw new Error("too late; already scheduled");return n}function Jo(t,e){var n=go(t,e);if(n.state>lf)throw new Error("too late; already running");return n}function go(t,e){var n=t.__transition;if(!n||!(n=n[e]))throw new Error("transition not found");return n}function CV(t,e,n){var i=t.__transition,o;i[e]=n,n.timer=l9(r,0,n.time);function r(c){n.state=r4,n.timer.restart(s,n.delay,n.time),n.delay<=c&&s(c-n.delay)}function s(c){var d,u,f,h;if(n.state!==r4)return l();for(d in i)if(h=i[d],h.name===n.name){if(h.state===lf)return o4(s);h.state===s4?(h.state=cf,h.timer.stop(),h.on.call("interrupt",t,t.__data__,h.index,h.group),delete i[d]):+d<e&&(h.state=cf,h.timer.stop(),h.on.call("cancel",t,t.__data__,h.index,h.group),delete i[d])}if(o4(function(){n.state===lf&&(n.state=s4,n.timer.restart(a,n.delay,n.time),a(c))}),n.state=Kp,n.on.call("start",t,t.__data__,n.index,n.group),n.state===Kp){for(n.state=lf,o=new Array(f=n.tween.length),d=0,u=-1;d<f;++d)(h=n.tween[d].value.call(t,t.__data__,n.index,n.group))&&(o[++u]=h);o.length=u+1}}function a(c){for(var d=c<n.duration?n.ease.call(null,c/n.duration):(n.timer.restart(l),n.state=Jp,1),u=-1,f=o.length;++u<f;)o[u].call(t,d);n.state===Jp&&(n.on.call("end",t,t.__data__,n.index,n.group),l())}function l(){n.state=cf,n.timer.stop(),delete i[e];for(var c in i)return;delete t.__transition}}function PV(t,e){var n=t.__transition,i,o,r=!0,s;if(n){e=e==null?null:e+"";for(s in n){if((i=n[s]).name!==e){r=!1;continue}o=i.state>Kp&&i.state<Jp,i.state=cf,i.timer.stop(),i.on.call(o?"interrupt":"cancel",t,t.__data__,i.index,i.group),delete n[s]}r&&delete t.__transition}}function LV(t){return this.each(function(){PV(this,t)})}function FV(t,e){var n,i;return function(){var o=Jo(this,t),r=o.tween;if(r!==n){i=n=r;for(var s=0,a=i.length;s<a;++s)if(i[s].name===e){i=i.slice(),i.splice(s,1);break}}o.tween=i}}function kV(t,e,n){var i,o;if(typeof n!="function")throw new Error;return function(){var r=Jo(this,t),s=r.tween;if(s!==i){o=(i=s).slice();for(var a={name:e,value:n},l=0,c=o.length;l<c;++l)if(o[l].name===e){o[l]=a;break}l===c&&o.push(a)}r.tween=o}}function RV(t,e){var n=this._id;if(t+="",arguments.length<2){for(var i=go(this.node(),n).tween,o=0,r=i.length,s;o<r;++o)if((s=i[o]).name===t)return s.value;return null}return this.each((e==null?FV:kV)(n,t,e))}function Ag(t,e,n){var i=t._id;return t.each(function(){var o=Jo(this,i);(o.value||(o.value={}))[e]=n.apply(this,arguments)}),function(o){return go(o,i).value[e]}}function d9(t,e){var n;return(typeof e=="number"?Xi:e instanceof Vs?Vf:(n=Vs(e))?(e=n,Vf):i9)(t,e)}function zV(t){return function(){this.removeAttribute(t)}}function BV(t){return function(){this.removeAttributeNS(t.space,t.local)}}function OV(t,e,n){var i,o=n+"",r;return function(){var s=this.getAttribute(t);return s===o?null:s===i?r:r=e(i=s,n)}}function DV(t,e,n){var i,o=n+"",r;return function(){var s=this.getAttributeNS(t.space,t.local);return s===o?null:s===i?r:r=e(i=s,n)}}function NV(t,e,n){var i,o,r;return function(){var s,a=n(this),l;return a==null?void this.removeAttribute(t):(s=this.getAttribute(t),l=a+"",s===l?null:s===i&&l===o?r:(o=l,r=e(i=s,a)))}}function UV(t,e,n){var i,o,r;return function(){var s,a=n(this),l;return a==null?void this.removeAttributeNS(t.space,t.local):(s=this.getAttributeNS(t.space,t.local),l=a+"",s===l?null:s===i&&l===o?r:(o=l,r=e(i=s,a)))}}function GV(t,e){var n=bh(t),i=n==="transform"?xV:d9;return this.attrTween(t,typeof e=="function"?(n.local?UV:NV)(n,i,Ag(this,"attr."+t,e)):e==null?(n.local?BV:zV)(n):(n.local?DV:OV)(n,i,e))}function HV(t,e){return function(n){this.setAttribute(t,e.call(this,n))}}function VV(t,e){return function(n){this.setAttributeNS(t.space,t.local,e.call(this,n))}}function jV(t,e){var n,i;function o(){var r=e.apply(this,arguments);return r!==i&&(n=(i=r)&&VV(t,r)),n}return o._value=e,o}function $V(t,e){var n,i;function o(){var r=e.apply(this,arguments);return r!==i&&(n=(i=r)&&HV(t,r)),n}return o._value=e,o}function WV(t,e){var n="attr."+t;if(arguments.length<2)return(n=this.tween(n))&&n._value;if(e==null)return this.tween(n,null);if(typeof e!="function")throw new Error;var i=bh(t);return this.tween(n,(i.local?jV:$V)(i,e))}function ZV(t,e){return function(){Eg(this,t).delay=+e.apply(this,arguments)}}function XV(t,e){return e=+e,function(){Eg(this,t).delay=e}}function YV(t){var e=this._id;return arguments.length?this.each((typeof t=="function"?ZV:XV)(e,t)):go(this.node(),e).delay}function qV(t,e){return function(){Jo(this,t).duration=+e.apply(this,arguments)}}function KV(t,e){return e=+e,function(){Jo(this,t).duration=e}}function JV(t){var e=this._id;return arguments.length?this.each((typeof t=="function"?qV:KV)(e,t)):go(this.node(),e).duration}function QV(t,e){if(typeof e!="function")throw new Error;return function(){Jo(this,t).ease=e}}function ej(t){var e=this._id;return arguments.length?this.each(QV(e,t)):go(this.node(),e).ease}function tj(t,e){return function(){var n=e.apply(this,arguments);if(typeof n!="function")throw new Error;Jo(this,t).ease=n}}function nj(t){if(typeof t!="function")throw new Error;return this.each(tj(this._id,t))}function ij(t){typeof t!="function"&&(t=jw(t));for(var e=this._groups,n=e.length,i=new Array(n),o=0;o<n;++o)for(var r=e[o],s=r.length,a=i[o]=[],l,c=0;c<s;++c)(l=r[c])&&t.call(l,l.__data__,c,r)&&a.push(l);return new xr(i,this._parents,this._name,this._id)}function oj(t){if(t._id!==this._id)throw new Error;for(var e=this._groups,n=t._groups,i=e.length,o=n.length,r=Math.min(i,o),s=new Array(i),a=0;a<r;++a)for(var l=e[a],c=n[a],d=l.length,u=s[a]=new Array(d),f,h=0;h<d;++h)(f=l[h]||c[h])&&(u[h]=f);for(;a<i;++a)s[a]=e[a];return new xr(s,this._parents,this._name,this._id)}function rj(t){return(t+"").trim().split(/^|\s+/).every(function(e){var n=e.indexOf(".");return n>=0&&(e=e.slice(0,n)),!e||e==="start"})}function sj(t,e,n){var i,o,r=rj(e)?Eg:Jo;return function(){var s=r(this,t),a=s.on;a!==i&&(o=(i=a).copy()).on(e,n),s.on=o}}function aj(t,e){var n=this._id;return arguments.length<2?go(this.node(),n).on.on(t):this.each(sj(n,t,e))}function lj(t){return function(){var e=this.parentNode;for(var n in this.__transition)if(+n!==t)return;e&&e.removeChild(this)}}function cj(){return this.on("end.remove",lj(this._id))}function dj(t){var e=this._name,n=this._id;typeof t!="function"&&(t=wg(t));for(var i=this._groups,o=i.length,r=new Array(o),s=0;s<o;++s)for(var a=i[s],l=a.length,c=r[s]=new Array(l),d,u,f=0;f<l;++f)(d=a[f])&&(u=t.call(d,d.__data__,f,a))&&("__data__"in d&&(u.__data__=d.__data__),c[f]=u,xh(c[f],e,n,f,c,go(d,n)));return new xr(r,this._parents,e,n)}function uj(t){var e=this._name,n=this._id;typeof t!="function"&&(t=Vw(t));for(var i=this._groups,o=i.length,r=[],s=[],a=0;a<o;++a)for(var l=i[a],c=l.length,d,u=0;u<c;++u)if(d=l[u]){for(var f=t.call(d,d.__data__,u,l),h,_=go(d,n),p=0,m=f.length;p<m;++p)(h=f[p])&&xh(h,e,n,p,f,_);r.push(f),s.push(d)}return new xr(r,s,e,n)}var fj=td.prototype.constructor;function hj(){return new fj(this._groups,this._parents)}function _j(t,e){var n,i,o;return function(){var r=ol(this,t),s=(this.style.removeProperty(t),ol(this,t));return r===s?null:r===n&&s===i?o:o=e(n=r,i=s)}}function u9(t){return function(){this.style.removeProperty(t)}}function mj(t,e,n){var i,o=n+"",r;return function(){var s=ol(this,t);return s===o?null:s===i?r:r=e(i=s,n)}}function pj(t,e,n){var i,o,r;return function(){var s=ol(this,t),a=n(this),l=a+"";return a==null&&(l=a=(this.style.removeProperty(t),ol(this,t))),s===l?null:s===i&&l===o?r:(o=l,r=e(i=s,a))}}function gj(t,e){var n,i,o,r="style."+e,s="end."+r,a;return function(){var l=Jo(this,t),c=l.on,d=l.value[r]==null?a||(a=u9(e)):void 0;(c!==n||o!==d)&&(i=(n=c).copy()).on(s,o=d),l.on=i}}function vj(t,e,n){var i=(t+="")=="transform"?wV:d9;return e==null?this.styleTween(t,_j(t,i)).on("end.style."+t,u9(t)):typeof e=="function"?this.styleTween(t,pj(t,i,Ag(this,"style."+t,e))).each(gj(this._id,t)):this.styleTween(t,mj(t,i,e),n).on("end.style."+t,null)}function yj(t,e,n){return function(i){this.style.setProperty(t,e.call(this,i),n)}}function bj(t,e,n){var i,o;function r(){var s=e.apply(this,arguments);return s!==o&&(i=(o=s)&&yj(t,s,n)),i}return r._value=e,r}function wj(t,e,n){var i="style."+(t+="");if(arguments.length<2)return(i=this.tween(i))&&i._value;if(e==null)return this.tween(i,null);if(typeof e!="function")throw new Error;return this.tween(i,bj(t,e,n??""))}function xj(t){return function(){this.textContent=t}}function Sj(t){return function(){var e=t(this);this.textContent=e??""}}function Mj(t){return this.tween("text",typeof t=="function"?Sj(Ag(this,"text",t)):xj(t==null?"":t+""))}function Tj(t){return function(e){this.textContent=t.call(this,e)}}function Ij(t){var e,n;function i(){var o=t.apply(this,arguments);return o!==n&&(e=(n=o)&&Tj(o)),e}return i._value=t,i}function Ej(t){var e="text";if(arguments.length<1)return(e=this.tween(e))&&e._value;if(t==null)return this.tween(e,null);if(typeof t!="function")throw new Error;return this.tween(e,Ij(t))}function Aj(){for(var t=this._name,e=this._id,n=f9(),i=this._groups,o=i.length,r=0;r<o;++r)for(var s=i[r],a=s.length,l,c=0;c<a;++c)if(l=s[c]){var d=go(l,e);xh(l,t,n,c,s,{time:d.time+d.delay+d.duration,delay:0,duration:d.duration,ease:d.ease})}return new xr(i,this._parents,t,n)}function Cj(){var t,e,n=this,i=n._id,o=n.size();return new Promise(function(r,s){var a={value:s},l={value:function(){--o===0&&r()}};n.each(function(){var c=Jo(this,i),d=c.on;d!==t&&(e=(t=d).copy(),e._.cancel.push(a),e._.interrupt.push(a),e._.end.push(l)),c.on=e}),o===0&&r()})}var Pj=0;function xr(t,e,n,i){this._groups=t,this._parents=e,this._name=n,this._id=i}function f9(){return++Pj}var ar=td.prototype;xr.prototype={constructor:xr,select:dj,selectAll:uj,selectChild:ar.selectChild,selectChildren:ar.selectChildren,filter:ij,merge:oj,selection:hj,transition:Aj,call:ar.call,nodes:ar.nodes,node:ar.node,size:ar.size,empty:ar.empty,each:ar.each,on:aj,attr:GV,attrTween:WV,style:vj,styleTween:wj,text:Mj,textTween:Ej,remove:cj,tween:RV,delay:YV,duration:JV,ease:ej,easeVarying:nj,end:Cj,[Symbol.iterator]:ar[Symbol.iterator]};function Lj(t){return((t*=2)<=1?t*t*t:(t-=2)*t*t+2)/2}var Fj={time:null,delay:0,duration:250,ease:Lj};function kj(t,e){for(var n;!(n=t.__transition)||!(n=n[e]);)if(!(t=t.parentNode))throw new Error(`transition ${e} not found`);return n}function Rj(t){var e,n;t instanceof xr?(e=t._id,t=t._name):(e=f9(),(n=Fj).time=Ig(),t=t==null?null:t+"");for(var i=this._groups,o=i.length,r=0;r<o;++r)for(var s=i[r],a=s.length,l,c=0;c<a;++c)(l=s[c])&&xh(l,t,e,c,s,n||kj(l,e));return new xr(i,this._parents,t,e)}td.prototype.interrupt=LV;td.prototype.transition=Rj;function zj(t){return Math.abs(t=Math.round(t))>=1e21?t.toLocaleString("en").replace(/,/g,""):t.toString(10)}function Zf(t,e){if((n=(t=e?t.toExponential(e-1):t.toExponential()).indexOf("e"))<0)return null;var n,i=t.slice(0,n);return[i.length>1?i[0]+i.slice(2):i,+t.slice(n+1)]}function al(t){return t=Zf(Math.abs(t)),t?t[1]:NaN}function Bj(t,e){return function(n,i){for(var o=n.length,r=[],s=0,a=t[0],l=0;o>0&&a>0&&(l+a+1>i&&(a=Math.max(1,i-l)),r.push(n.substring(o-=a,o+a)),!((l+=a+1)>i));)a=t[s=(s+1)%t.length];return r.reverse().join(e)}}function Oj(t){return function(e){return e.replace(/[0-9]/g,function(n){return t[+n]})}}var Dj=/^(?:(.)?([<>=^]))?([+\-( ])?([$#])?(0)?(\d+)?(,)?(\.\d+)?(~)?([a-z%])?$/i;function Xf(t){if(!(e=Dj.exec(t)))throw new Error("invalid format: "+t);var e;return new Cg({fill:e[1],align:e[2],sign:e[3],symbol:e[4],zero:e[5],width:e[6],comma:e[7],precision:e[8]&&e[8].slice(1),trim:e[9],type:e[10]})}Xf.prototype=Cg.prototype;function Cg(t){this.fill=t.fill===void 0?" ":t.fill+"",this.align=t.align===void 0?">":t.align+"",this.sign=t.sign===void 0?"-":t.sign+"",this.symbol=t.symbol===void 0?"":t.symbol+"",this.zero=!!t.zero,this.width=t.width===void 0?void 0:+t.width,this.comma=!!t.comma,this.precision=t.precision===void 0?void 0:+t.precision,this.trim=!!t.trim,this.type=t.type===void 0?"":t.type+""}Cg.prototype.toString=function(){return this.fill+this.align+this.sign+this.symbol+(this.zero?"0":"")+(this.width===void 0?"":Math.max(1,this.width|0))+(this.comma?",":"")+(this.precision===void 0?"":"."+Math.max(0,this.precision|0))+(this.trim?"~":"")+this.type};function Nj(t){e:for(var e=t.length,n=1,i=-1,o;n<e;++n)switch(t[n]){case".":i=o=n;break;case"0":i===0&&(i=n),o=n;break;default:if(!+t[n])break e;i>0&&(i=0);break}return i>0?t.slice(0,i)+t.slice(o+1):t}var h9;function Uj(t,e){var n=Zf(t,e);if(!n)return t+"";var i=n[0],o=n[1],r=o-(h9=Math.max(-8,Math.min(8,Math.floor(o/3)))*3)+1,s=i.length;return r===s?i:r>s?i+new Array(r-s+1).join("0"):r>0?i.slice(0,r)+"."+i.slice(r):"0."+new Array(1-r).join("0")+Zf(t,Math.max(0,e+r-1))[0]}function a4(t,e){var n=Zf(t,e);if(!n)return t+"";var i=n[0],o=n[1];return o<0?"0."+new Array(-o).join("0")+i:i.length>o+1?i.slice(0,o+1)+"."+i.slice(o+1):i+new Array(o-i.length+2).join("0")}const l4={"%":(t,e)=>(t*100).toFixed(e),b:t=>Math.round(t).toString(2),c:t=>t+"",d:zj,e:(t,e)=>t.toExponential(e),f:(t,e)=>t.toFixed(e),g:(t,e)=>t.toPrecision(e),o:t=>Math.round(t).toString(8),p:(t,e)=>a4(t*100,e),r:a4,s:Uj,X:t=>Math.round(t).toString(16).toUpperCase(),x:t=>Math.round(t).toString(16)};function c4(t){return t}var d4=Array.prototype.map,u4=["y","z","a","f","p","n","µ","m","","k","M","G","T","P","E","Z","Y"];function Gj(t){var e=t.grouping===void 0||t.thousands===void 0?c4:Bj(d4.call(t.grouping,Number),t.thousands+""),n=t.currency===void 0?"":t.currency[0]+"",i=t.currency===void 0?"":t.currency[1]+"",o=t.decimal===void 0?".":t.decimal+"",r=t.numerals===void 0?c4:Oj(d4.call(t.numerals,String)),s=t.percent===void 0?"%":t.percent+"",a=t.minus===void 0?"−":t.minus+"",l=t.nan===void 0?"NaN":t.nan+"";function c(u){u=Xf(u);var f=u.fill,h=u.align,_=u.sign,p=u.symbol,m=u.zero,g=u.width,y=u.comma,b=u.precision,v=u.trim,T=u.type;T==="n"?(y=!0,T="g"):l4[T]||(b===void 0&&(b=12),v=!0,T="g"),(m||f==="0"&&h==="=")&&(m=!0,f="0",h="=");var x=p==="$"?n:p==="#"&&/[boxX]/.test(T)?"0"+T.toLowerCase():"",I=p==="$"?i:/[%p]/.test(T)?s:"",E=l4[T],L=/[defgprs%]/.test(T);b=b===void 0?6:/[gprs]/.test(T)?Math.max(1,Math.min(21,b)):Math.max(0,Math.min(20,b));function N(k){var w=x,S=I,A,z,M;if(T==="c")S=E(k)+S,k="";else{k=+k;var P=k<0||1/k<0;if(k=isNaN(k)?l:E(Math.abs(k),b),v&&(k=Nj(k)),P&&+k==0&&_!=="+"&&(P=!1),w=(P?_==="("?_:a:_==="-"||_==="("?"":_)+w,S=(T==="s"?u4[8+h9/3]:"")+S+(P&&_==="("?")":""),L){for(A=-1,z=k.length;++A<z;)if(M=k.charCodeAt(A),48>M||M>57){S=(M===46?o+k.slice(A+1):k.slice(A))+S,k=k.slice(0,A);break}}}y&&!m&&(k=e(k,1/0));var C=w.length+k.length+S.length,D=C<g?new Array(g-C+1).join(f):"";switch(y&&m&&(k=e(D+k,D.length?g-S.length:1/0),D=""),h){case"<":k=w+k+S+D;break;case"=":k=w+D+k+S;break;case"^":k=D.slice(0,C=D.length>>1)+w+k+S+D.slice(C);break;default:k=D+w+k+S;break}return r(k)}return N.toString=function(){return u+""},N}function d(u,f){var h=c((u=Xf(u),u.type="f",u)),_=Math.max(-8,Math.min(8,Math.floor(al(f)/3)))*3,p=Math.pow(10,-_),m=u4[8+_/3];return function(g){return h(p*g)+m}}return{format:c,formatPrefix:d}}var Bu,_9,m9;Hj({thousands:",",grouping:[3],currency:["$",""]});function Hj(t){return Bu=Gj(t),_9=Bu.format,m9=Bu.formatPrefix,Bu}function Vj(t){return Math.max(0,-al(Math.abs(t)))}function jj(t,e){return Math.max(0,Math.max(-8,Math.min(8,Math.floor(al(e)/3)))*3-al(Math.abs(t)))}function $j(t,e){return t=Math.abs(t),e=Math.abs(e)-t,Math.max(0,al(e)-al(t))+1}function Wj(t,e){switch(arguments.length){case 0:break;case 1:this.range(t);break;default:this.range(e).domain(t);break}return this}function Zj(t){return function(){return t}}function Xj(t){return+t}var f4=[0,1];function Aa(t){return t}function Qp(t,e){return(e-=t=+t)?function(n){return(n-t)/e}:Zj(isNaN(e)?NaN:.5)}function Yj(t,e){var n;return t>e&&(n=t,t=e,e=n),function(i){return Math.max(t,Math.min(e,i))}}function qj(t,e,n){var i=t[0],o=t[1],r=e[0],s=e[1];return o<i?(i=Qp(o,i),r=n(s,r)):(i=Qp(i,o),r=n(r,s)),function(a){return r(i(a))}}function Kj(t,e,n){var i=Math.min(t.length,e.length)-1,o=new Array(i),r=new Array(i),s=-1;for(t[i]<t[0]&&(t=t.slice().reverse(),e=e.slice().reverse());++s<i;)o[s]=Qp(t[s],t[s+1]),r[s]=n(e[s],e[s+1]);return function(a){var l=YU(t,a,1,i)-1;return r[l](o[l](a))}}function Jj(t,e){return e.domain(t.domain()).range(t.range()).interpolate(t.interpolate()).clamp(t.clamp()).unknown(t.unknown())}function Qj(){var t=f4,e=f4,n=Tg,i,o,r,s=Aa,a,l,c;function d(){var f=Math.min(t.length,e.length);return s!==Aa&&(s=Yj(t[0],t[f-1])),a=f>2?Kj:qj,l=c=null,u}function u(f){return f==null||isNaN(f=+f)?r:(l||(l=a(t.map(i),e,n)))(i(s(f)))}return u.invert=function(f){return s(o((c||(c=a(e,t.map(i),Xi)))(f)))},u.domain=function(f){return arguments.length?(t=Array.from(f,Xj),d()):t.slice()},u.range=function(f){return arguments.length?(e=Array.from(f),d()):e.slice()},u.rangeRound=function(f){return e=Array.from(f),n=vV,d()},u.clamp=function(f){return arguments.length?(s=f?!0:Aa,d()):s!==Aa},u.interpolate=function(f){return arguments.length?(n=f,d()):n},u.unknown=function(f){return arguments.length?(r=f,u):r},function(f,h){return i=f,o=h,d()}}function e$(){return Qj()(Aa,Aa)}function t$(t,e,n,i){var o=KU(t,e,n),r;switch(i=Xf(i??",f"),i.type){case"s":{var s=Math.max(Math.abs(t),Math.abs(e));return i.precision==null&&!isNaN(r=jj(o,s))&&(i.precision=r),m9(i,s)}case"":case"e":case"g":case"p":case"r":{i.precision==null&&!isNaN(r=$j(o,Math.max(Math.abs(t),Math.abs(e))))&&(i.precision=r-(i.type==="e"));break}case"f":case"%":{i.precision==null&&!isNaN(r=Vj(o))&&(i.precision=r-(i.type==="%")*2);break}}return _9(i)}function n$(t){var e=t.domain;return t.ticks=function(n){var i=e();return qU(i[0],i[i.length-1],n??10)},t.tickFormat=function(n,i){var o=e();return t$(o[0],o[o.length-1],n??10,i)},t.nice=function(n){n==null&&(n=10);var i=e(),o=0,r=i.length-1,s=i[o],a=i[r],l,c,d=10;for(a<s&&(c=s,s=a,a=c,c=o,o=r,r=c);d-- >0;){if(c=Uw(s,a,n),c===l)return i[o]=s,i[r]=a,e(i);if(c>0)s=Math.floor(s/c)*c,a=Math.ceil(a/c)*c;else if(c<0)s=Math.ceil(s*c)/c,a=Math.floor(a*c)/c;else break;l=c}return t},t}function df(){var t=e$();return t.copy=function(){return Jj(t,df())},Wj.apply(t,arguments),n$(t)}function uc(t,e,n){this.k=t,this.x=e,this.y=n}uc.prototype={constructor:uc,scale:function(t){return t===1?this:new uc(this.k*t,this.x,this.y)},translate:function(t,e){return t===0&e===0?this:new uc(this.k,this.x+this.k*t,this.y+this.k*e)},apply:function(t){return[t[0]*this.k+this.x,t[1]*this.k+this.y]},applyX:function(t){return t*this.k+this.x},applyY:function(t){return t*this.k+this.y},invert:function(t){return[(t[0]-this.x)/this.k,(t[1]-this.y)/this.k]},invertX:function(t){return(t-this.x)/this.k},invertY:function(t){return(t-this.y)/this.k},rescaleX:function(t){return t.copy().domain(t.range().map(this.invertX,this).map(t.invert,t))},rescaleY:function(t){return t.copy().domain(t.range().map(this.invertY,this).map(t.invert,t))},toString:function(){return"translate("+this.x+","+this.y+") scale("+this.k+")"}};uc.prototype;class h4 extends pl{constructor(e,n,i){super(),this.points=e,this.presets=i;const o=n.style||{},r=n.width||700,s=n.height||300,a=n.xDomain||[0,1];this.xDomain=a;const l=n.yDomain||[0,1],c=document.createElement("div"),d=i.length>0?30:0;c.style.background="white",c.style.padding="0",c.style.position="absolute",c.style.top="",c.style.left="0",c.style.bottom="0",c.style.width=`${r}px`,c.style.height=`${s+d}px`,c.style.zIndex="10001";for(const u in o)c.style[u]=o[u];if(c.innerHTML=`<svg class="interpolate-editor" width="${r}" height="${s}">
            <g>
                <path></path>
                <g class="color-scale" transform="translate(0, ${s-5})">
                </g>
                <g class="points-menu" transform="translate(${r-40}, ${s-40})">
                    <g class="remove-point">
                        <rect x="-6" y="-6" width="12" height="12"></rect>
                        <line x1="-6" x2="6"></line>
                    </g>
                    <g class="add-point" transform="translate(20,0)">
                        <rect x="-6" y="-6" width="12" height="12"></rect>
                        <line x1="-6" x2="6"></line><line y1="-6" y2="6"></line>
                    </g>
                </g>
            </g>
        </svg>
        <select id="presets"></select>`,this.editor=c,this.svg=rl(c.querySelector("svg")),this.xScale=df().domain(a).range([30,r-20]),this.yScale=df().domain(l.reverse()).range([10,s-30]),this.svg.append("g").attr("transform",`translate(0, ${s-30})`).call(oG(this.xScale)),this.svg.append("g").attr("transform","translate(30, 0)").call(rG(this.yScale)),this.colorScale=df().domain(l).range(["white","black"]),this.drag=YH().on("drag",u=>{u.subject[0]=this.xScale.invert(u.x),u.subject[1]=this.yScale.invert(u.y),this.update()}),i.length>0){const u=rl(c.querySelector("select"));u.selectAll("option").data(i).enter().append("option").text(h=>h.name).attr("value",h=>String(h.value)),u.on("change",h=>{this.activatePreset(h.target.selectedIndex)})}this.update()}getContainer(){return this.editor}hide(){this.editor.style.display="none"}show(){this.editor.style.display="block"}isHidden(){return this.editor.style.display!=="block"}activatePreset(e){const n=this.presets[e];if(!n){console.log(`Пресет за индексом ${e} не найден`);return}this.points=n.value,this.update()}setPoints(e){this.points=JSON.parse(decodeURIComponent(e)),this.update()}getPoints(){return encodeURIComponent(JSON.stringify(this.points))}update(){this.isHidden()||console.log(`Current value: ${JSON.stringify(this.points)}`),this.updatePoints(),this.updatePointsMenu();const e=i$(this.points),n=o$(e,this.xDomain);this.updateLines(n),this.updateColorScale(n),this.emit("change",[e,this.getPoints()])}updateLines(e){const n=this.svg.selectAll("path").data([this.points]);n.enter().append("path").merge(n).style("stroke","#ccc").attr("d",this.toD(e))}updatePoints(){const e=this.svg.selectAll("circle").data(this.points);e.enter().append("circle").attr("r",4).call(this.drag).merge(e).attr("cx",n=>this.xScale(n[0])).attr("cy",n=>this.yScale(n[1])),e.exit().remove()}updatePointsMenu(){const n=this.points,i=n.length,o=this.svg;o.select(".remove-point").classed("active",i>2).on("click",()=>{i<=2||(n.splice(-1,1),this.update())}),o.select(".add-point").classed("active",i<20).on("click",()=>{i>=20||(n.push([1,.5]),this.update())})}updateColorScale(e){const n=this.svg.select(".color-scale").selectAll("rect").data(e);n.enter().append("rect").attr("x",i=>this.xScale(i[0])).attr("y",0).attr("width",this.xScale(1)/e.length).attr("height",5).merge(n).attr("fill",i=>this.colorScale(i[1])),n.exit().remove()}toD(e){const n=[];n.push(`M${this.xScale(e[0][0])},${this.yScale(e[0][1])}`);for(let i=0;i<e.length;i++)n.push(`L${this.xScale(e[i][0])},${this.yScale(e[i][1])}`);return n.join("")}}function i$(t){const e=t.map(([n,i])=>({key:n,value:i}));return e.sort((n,i)=>n.key-i.key),{type:"interpolate",base:1,steps:e,argument:{type:"shading-intensity"}}}function o$(t,e){const n=[],[o,r]=e,s=(r-o)/128;for(let a=o;a<r;a+=s)n.push([a,L0(t,a,{})]);return n}const _4={"Красная поляна":{center:[40.2363,43.67305],zoom:13},Шерегеш:{center:[87.96426,52.95719],zoom:13},Москва:{center:[37.63541,55.7476],zoom:13},ОАЭ:{center:[56.154,24.7974],zoom:13}};let fa;const Gt={region:"Новосибирск",scale:W.reliefScale??1.2,maxPitch:45,demTileSet:lg,demReliefTileType:"raster",demElevationSourceType:"regular",useFlatDemIrregularMeshNormals:W.useFlatDemIrregularMeshNormals??!1,dem:W.dem};let Ou,Du,Nu,Uu,Gu,Hu,hs;const r$={name:"Демо снимков мапбокс",version:1,background:{color:"#fff"},icons:{},layers:[{id:"sattelite",type:"raster",filter:["match",["sourceAttr","name"],["sattelite"],!0,!1],minzoom:10,maxzoom:20,style:{opacity:1}}],terrain:{}},s$=(t,e)=>{function n(){fa&&(fa.destroy(),fa=void 0)}function i(){W.reliefScale=+Gt.scale.toFixed(2);const I=t._impl.modules.styleManager.getStyle(t._impl.state.handyStyleId),E=I==null?void 0:I.dem.style;E&&(E.verticalScale=W.reliefScale,Vt(t,W),t.triggerRerender())}function o(){W.demTileSet=Gt.demTileSet,t._impl.state.elevation=0,t._impl.modules.demManager.setTileSet(Gt.demTileSet),Vt(t,W)}function r(){Gt.demReliefTileType!=="raster"&&Gt.demReliefTileType!=="vector"||(t._impl.modules.demManager.setReliefTileType(Gt.demReliefTileType),W.demReliefTileType=Gt.demReliefTileType,Vt(t,W))}function s(){Gt.demElevationSourceType!=="regular"&&Gt.demElevationSourceType!=="irregular"||(t._impl.modules.demManager.setElevationSourceType(Gt.demElevationSourceType),W.demElevationSourceType=Gt.demElevationSourceType,Vt(t,W))}e.updateDisplay();const a=Object.keys(_4);e.add(Gt,"region",a).onChange(I=>{const{center:E,zoom:L}=_4[I];t.setCenter(E,{animate:!1}),t.setZoom(L,{animate:!1})});const l=e.add(Gt,"demTileSet",[lg,"relief_hd"]).onChange(o),c=e.add(Gt,"demReliefTileType",["raster","vector"]).onChange(r),d=e.add(Gt,"demElevationSourceType",["regular","irregular"]).onChange(s);e.add(Gt,"useFlatDemIrregularMeshNormals",!!W.useFlatDemIrregularMeshNormals).onChange(()=>{W.useFlatDemIrregularMeshNormals=!!Gt.useFlatDemIrregularMeshNormals,Vt(t,W),window.location.reload()});const u={enable:()=>{W.satellite=!1,W.dem=!0,fa&&n(),W.demTileSet&&(Gt.demTileSet=W.demTileSet,l.updateDisplay(),o()),W.demReliefTileType&&(Gt.demReliefTileType=W.demReliefTileType,c.updateDisplay()),W.demElevationSourceType&&(Gt.demElevationSourceType=W.demElevationSourceType,d.updateDisplay()),r(),s(),i(),Vt(t,W),t._impl.modules.demManager.setMeshMaxZoom(),t.patchStyleState({terrainEnabled:!0})},satellite:()=>{fa||(W.dem=!0,W.satellite=!0,Vt(t,W),fa=new mapgl._J.RasterTileSource(t._impl,{minZoom:2,maxZoom:15,attributes:{name:"sattelite"},url:(I,E,L)=>`https://api.mapbox.com/v4/mapbox.satellite/${L}/${I}/${E}@2x.png?access_token=pk.eyJ1IjoidmxvYm9kYSIsImEiOiJja3M4Z2tva2gwM2JrMnhwNDU4emhubnN3In0.YDkASF0tFoMgVmZW6tZqIg`}),t._impl.setStyle(r$,xs),t.once("styleload",()=>{t._impl.modules.styleManager.setTerrainStyle({verticalScale:["interpolate",["linear"],["zoom"],11,0,12,["global","terrainScale"]]}),i(),t._impl.modules.demManager.setMeshMaxZoom(13)}),t._impl.patchStyleState({terrainEnabled:!0}))},disable:()=>{W.dem=!1,W.satellite=!1,Vt(t,W),n(),t._impl.patchStyleState({terrainEnabled:!1})},debugViewport:()=>{var k,w;Du==null||Du.destroy(),Ou==null||Ou.destroy(),Nu==null||Nu.destroy(),Uu==null||Uu.destroy(),Gu==null||Gu.forEach(S=>S.destroy()),Hu==null||Hu.forEach(S=>S.destroy()),hs==null||hs.destroy();const I=new Float64Array(16),E=[[-1,-1,0,1],[-1,1,0,1],[1,1,0,1],[1,-1,0,1],[-1,-1,0,1]],L=t._impl.modules,N=(w=(k=L.renderer.getFramebuffer(L.demManager.getDemFramebufferId()))==null?void 0:k.getViewProjectionMatrix)==null?void 0:w.call(k);N&&(Go(I,N),hs==null||hs.destroy(),hs=new mapgl._J.Polygon(t._impl,{coordinates:[E.map(S=>eT(ii([],S,I)))],color:"#a8329d20",strokeColor:"#a8329dff",strokeWidth:10})),Ou=new mapgl._J.Polygon(t._impl,{coordinates:[t._impl.state.extendedTilesBounds.map(S=>q.toGeo(S))],color:"#ff000044",strokeColor:"#ff0000"}),Hu=t._impl.modules.demManager.getFlatMapTextures().map(S=>new mapgl._J.Polygon(t._impl,{coordinates:[S.viewport.map(A=>q.toGeo(A))],strokeColor:"#000000",strokeWidth:4})),Du=new mapgl._J.Polygon(t._impl,{coordinates:[t._impl.state.tilesBounds.map(S=>q.toGeo(S))],color:"#00000000",strokeColor:"#00ff00"}),Gu=t._impl.modules.demManager.getMeshTiles().reduce((S,A)=>(A.modelMatrices.forEach(z=>{const M=[[0,0,0,1],[1,0,0,1],[1,1,0,1],[0,1,0,1]].map(P=>q.toGeo(ii([],P,z)));S.push(new mapgl._J.Polygon(t._impl,{coordinates:[M],strokeWidth:2}))}),S),[]),Nu=new mapgl.Marker(t,{coordinates:q.toGeo(t._impl.state.center)}),Uu=new mapgl.Marker(t,{coordinates:q.toGeo(t._impl.modules.camera.position)})}};e.add(u,"enable"),e.add(u,"disable"),e.add(u,"satellite");const f=e.addFolder("Tools");f.add(Gt,"scale",0,5,.1).onChange(i),f.add(u,"debugViewport"),t.once("styleload",()=>{W.satellite&&W.dem?u.satellite():W.dem&&u.enable(),W.rampPreset&&_.setPoints(W.rampPreset)});const h=(I,E=.01)=>{const L=[],N=1/I;for(let k=0;k<I;k++){const w=Math.min(k*N,.99);L.push([k*N,w],[(k+1)*N-E,w])}return L},_=new h4([[0,0],[.5,.3],[.9,1]],{},[{name:"default",value:[[0,0],[.5,.3],[.9,.99]]},{name:"2-step",value:h(2)},{name:"3-step",value:h(3)},{name:"3-step smooth",value:h(3,.1)},{name:"5-step",value:h(5)},{name:"5-step smooth",value:h(5,.1)},{name:"7-step",value:h(7)},{name:"7-step smooth",value:h(7,.1)},{name:"10-step",value:h(10)},{name:"vector-like",value:[[0,0],[.39062,0],[.390625,.2],[.507812,.2],[.5078125,.4],[.6249,.4],[.625,.5],[.6914062,.5],[.69140625,.707],[.7148437,.707],[.71484375,.9],[.8398437,.9],[.83984375,.99],[1,.99]]}]);_.hide(),_.on("change",ki(([I,E])=>{console.log(E),l$(t,I),W.rampPreset=E,Vt(t,W)},150)),document.body.appendChild(_.getContainer());const p=new h4([[0,.1],[12,.1],[14,0]],{xDomain:[0,20]},[]);p.hide(),p.on("change",ki(([I])=>a$(t,I),150)),document.body.appendChild(p.getContainer());const m={enable:()=>{},lightingDirection:280,shadingIntensity:W.shading||.55,tuneRampTexture:()=>{_.isHidden()?(_.show(),p.hide()):_.hide()},tuneHillshade:()=>{p.isHidden()?(p.show(),_.hide()):p.hide()}},g=e.addFolder("Hillshade");function y(){const I=t._impl.modules.styleManager.getStyle(t._impl.state.handyStyleId),E=I==null?void 0:I.dem.style;E&&(E.shadingIntensity=m.shadingIntensity,E.lightingDirection=m.lightingDirection,W.shading=m.shadingIntensity,Vt(t,W),t.triggerRerender(),window.updateLight())}g.add(m,"enable"),g.add(m,"lightingDirection",0,360).onChange(y),g.add(m,"shadingIntensity",0,1,.01).onChange(y),g.add(m,"tuneRampTexture"),g.add(m,"tuneHillshade"),y();let b=[];const v={addMarkers:()=>{v.clearMarkers();const I=t._impl.modules.map.state.size;for(let E=0;E<=I[0];E+=64)for(let L=0;L<I[1];L+=64)T({point:[E,L]})},clearMarkers:()=>{b.forEach(I=>I.destroy()),b=[]},makeOnClick:!1},T=I=>{const E=t.getGroundPoint(I.point);E&&b.push(new mapgl.Marker(t,{coordinates:[E[0],E[1]]}))},x=e.addFolder("Ground");x.add(v,"makeOnClick").onChange(()=>{v.makeOnClick?t.on("click",T):(t.off("click",T),v.clearMarkers())}),x.add(v,"addMarkers"),x.add(v,"clearMarkers")};function a$(t,e){const n=t._impl.modules.styleManager.getStyle(t._impl.state.handyStyleId),i=n==null?void 0:n.layersById[n.layerIdToInnerId[899558]],o=n==null?void 0:n.layersById[n.layerIdToInnerId[957949]],r={...e,argument:{type:"zoom"},steps:e.steps.map(a=>({key:a.key,value:{type:"color",value:[255,255,255,a.value*255]}}))};o&&o.type==="polygon"&&(o.maxzoom=20,o.style.color=r);const s={...e,argument:{type:"zoom"},steps:e.steps.map(a=>({key:a.key,value:{type:"color",value:[0,0,0,a.value*255]}}))};i&&i.type==="polygon"&&(i.maxzoom=20,i.style.color=s),t.triggerRerender()}function l$(t,e){const{imageManager:n,demManager:i}=t._impl.modules,o=t._impl.state;n.updatePreparedTexture(i.getHillshadeRampTextureId(),Vb(o,e,256)),t.triggerRerender(),Vt(t,W)}const c$=[82.89813,54.980219],d$={id:"floor-model-point",type:"model",style:{modelSrc:["get","model_src"],ignoreGlobalLighting:!0,linkedIds:["get","object_id"],scale:.5},filter:["all",["match",["get","db_sublayer"],["Commercial_model"],!0,!1],["match",["get","db_plan_id"],["70030076255414722","70030076256410964"],!0,!1]],minzoom:16},u$={data:{type:"FeatureCollection",features:[{type:"Feature",geometry:{type:"Point",coordinates:[82.897780383575,54.98031450435293]},properties:{db_sublayer:"Commercial_model",db_plan_id:"70030076255414722",object_id:"70000001083860561",id:"floor-model-point-1",model_src:"/assets/models/palm_d.glb"}},{type:"Feature",geometry:{type:"Point",coordinates:[82.89757407904716,54.98031448558413]},properties:{db_sublayer:"Commercial_model",db_plan_id:"70030076255414722",object_id:"70000001026613060",id:"floor-model-point-2",model_src:"/assets/models/pine1.glb"}},{type:"Feature",geometry:{type:"Point",coordinates:[82.8978982421405,54.98014419382116]},properties:{db_sublayer:"Commercial_model",db_plan_id:"70030076256410964",object_id:"70000001059465878",id:"floor-model-point-3",model_src:"/assets/models/tree1.glb"}}]},promoteId:"object_id",attributes:{name:"mocked-gltf-model"}};function f$(t,e){const n=e.addFolder("Immersive Floors"),i={addModels(){t.setCenter(c$),t.setZoom(20),t.setPitch(45),t.addLayer(d$),new Ea(t,u$)}};function o(r){n.add(i,r)}o("addModels")}const m4=["tree1","tree2","treepine","bush1","bush2","palm","pine1","pine2","pine3"],ha=.7,p9=[{name:"Новосибирск",center:[82.924383,55.0302268],zoom:18},{name:"Москва",center:[37.623214,55.7525365],zoom:18}],Pg=p9.map(t=>t.name);Pg.unshift("-");const h$=["mock","tile server"],p4={place:Pg[0],source:h$[0]},_$=(t,e)=>{e.add({"Models scene":()=>{window.location.assign(`${window.location.origin}/model-scene.html${window.location.search}`)}},"Models scene"),e.add(p4,"place",Pg).onChange(()=>s());const n=e.addFolder("Models source");let i=null;const o={animationExpr:'["gltf-animation", 0, 1, 5]'},r={testPerf1(){t.removeLayer("testperf");const S=t._impl.modules.styleManager.getStyle(t._impl.state.handyStyleId),A=(S==null?void 0:S.background.color.value[0])===28?1:0,z={id:"testperf",name:"Immersive Model 3D",type:"model",style:{playAnimation:JSON.parse(o.animationExpr),colorTextureUvIndex:A,modelSrc:["step",["zoom"],["get","model_src"],16,["get","model_lod0_src"],17,["get","model_lod1_src"]],linkedIds:["get","building_id"],visibility:"visible"},filter:["all",["match",["get","db_sublayer"],["Immersive_model_2"],!0,!1],["match",["sourceAttr","sourceName"],["models","gltfModels"],!0,!1]],minzoom:16,metadata:{style:{modelSrc:{inputMode:"json"},linkedIds:{inputMode:"json"}},filterInputMode:"json"},lightingMode:"model"};t.addLayer(z)},testPerf2(){t.removeLayer("testperf");const S=t._impl.modules.styleManager.getStyle(t._impl.state.handyStyleId),A=(S==null?void 0:S.background.color.value[0])===28?1:0,z={id:"testperf",name:"Immersive Model 3D",type:"model",style:{playAnimation:JSON.parse(o.animationExpr),colorTextureUvIndex:A,modelSrc:["step",["zoom"],["get","model_src"],16,["get","model_lod0_src"],17,["get","model_lod1_src"]],linkedIds:["get","building_id"],visibility:"visible"},filter:["all",["match",["get","db_sublayer"],["Immersive_model_3"],!0,!1],["match",["sourceAttr","sourceName"],["models","gltfModels"],!0,!1]],minzoom:16,metadata:{style:{modelSrc:{inputMode:"json"},linkedIds:{inputMode:"json"}},filterInputMode:"json"},lightingMode:"model"};t.addLayer(z)},testPerf3(){t.removeLayer("testperf"),console.log(JSON.parse(o.animationExpr));const S=t._impl.modules.styleManager.getStyle(t._impl.state.handyStyleId),A=(S==null?void 0:S.background.color.value[0])===28?1:0,z={id:"testperf",name:"Immersive Model 3D",type:"model",style:{playAnimation:JSON.parse(o.animationExpr),colorTextureUvIndex:A,modelSrc:["step",["zoom"],["get","model_src"],16,["get","model_lod0_src"],17,["get","model_lod1_src"]],linkedIds:["get","building_id"],visibility:"visible"},filter:["all",["match",["get","db_sublayer"],["Immersive_model_4"],!0,!1],["match",["sourceAttr","sourceName"],["models","gltfModels"],!0,!1]],minzoom:16,metadata:{style:{modelSrc:{inputMode:"json"},linkedIds:{inputMode:"json"}},filterInputMode:"json"},lightingMode:"model"};t.addLayer(z)},testPerf11(){t.removeLayer("testperf");const S=t._impl.modules.styleManager.getStyle(t._impl.state.handyStyleId),A=(S==null?void 0:S.background.color.value[0])===28?1:0,z={id:"testperf",name:"Immersive Model 3D",type:"model",style:{playAnimation:JSON.parse(o.animationExpr),colorTextureUvIndex:A,modelSrc:["step",["zoom"],["get","model_src"],16,["get","model_lod0_src"],17,["get","model_lod1_src"]],linkedIds:["get","building_id"],visibility:"visible"},filter:["all",["match",["get","db_sublayer"],["Immersive_model_2"],!0,!1],["match",["sourceAttr","sourceName"],["models","gltfModels"],!0,!1]],minzoom:16,metadata:{style:{modelSrc:{inputMode:"json"},linkedIds:{inputMode:"json"}},filterInputMode:"json"},lightingMode:"model"};t.addLayer(z,"porch")},testPerf21(){t.removeLayer("testperf");const S=t._impl.modules.styleManager.getStyle(t._impl.state.handyStyleId),A=(S==null?void 0:S.background.color.value[0])===28?1:0,z={id:"testperf",name:"Immersive Model 3D",type:"model",style:{playAnimation:JSON.parse(o.animationExpr),colorTextureUvIndex:A,modelSrc:["step",["zoom"],["get","model_src"],16,["get","model_lod0_src"],17,["get","model_lod1_src"]],linkedIds:["get","building_id"],visibility:"visible"},filter:["all",["match",["get","db_sublayer"],["Immersive_model_3"],!0,!1],["match",["sourceAttr","sourceName"],["models","gltfModels"],!0,!1]],minzoom:16,metadata:{style:{modelSrc:{inputMode:"json"},linkedIds:{inputMode:"json"}},filterInputMode:"json"},lightingMode:"model"};t.addLayer(z,"porch")},testPerf31(){t.removeLayer("testperf");const S=t._impl.modules.styleManager.getStyle(t._impl.state.handyStyleId),A=(S==null?void 0:S.background.color.value[0])===28?1:0,z={id:"testperf",name:"Immersive Model 3D",type:"model",style:{playAnimation:JSON.parse(o.animationExpr),colorTextureUvIndex:A,modelSrc:["step",["zoom"],["get","model_src"],16,["get","model_lod0_src"],17,["get","model_lod1_src"]],linkedIds:["get","building_id"],visibility:"visible"},filter:["all",["match",["get","db_sublayer"],["Immersive_model_4"],!0,!1],["match",["sourceAttr","sourceName"],["models","gltfModels"],!0,!1]],minzoom:16,metadata:{style:{modelSrc:{inputMode:"json"},linkedIds:{inputMode:"json"}},filterInputMode:"json"},lightingMode:"model"};t.addLayer(z,"porch")},apply(S){t.removeLayer("54835"),t.removeLayer("721230"),console.log(o.animationExpr);const A=t._impl.modules.styleManager.getStyle(t._impl.state.handyStyleId),z=(A==null?void 0:A.background.color.value[0])===28?1:0,M={id:"54835",name:"Immersive Model 3D",type:"model",style:{playAnimation:S||JSON.parse(o.animationExpr),colorTextureUvIndex:z,modelSrc:["step",["zoom"],["get","model_src"],16,["get","model_lod0_src"],17,["get","model_lod1_src"]],linkedIds:["get","building_id"],visibility:"visible"},filter:["all",["match",["get","db_sublayer"],["Immersive_model","Immersive_model_multipart"],!0,!1],["match",["sourceAttr","sourceName"],["models","gltfModels"],!0,!1]],minzoom:16,metadata:{style:{modelSrc:{inputMode:"json"},linkedIds:{inputMode:"json"}},filterInputMode:"json"},lightingMode:"model"};t.addLayer(M)},create(){i=new mapgl._J.GeoJsonTileSource(t._impl,{maxZoom:14,url:`${window.location.protocol}//${window.location.host}/assets/tiles/gltf/{z}/{x}/{y}.json`,ignoreMissingTiles:!0,promoteId:"db_id",modelsPath:self.origin,attributes:{sourceName:"models"}})},destroy(){i==null||i.destroy(),i=null},"navigate to"(){t.setCenter([82.771633,55.12001],{animate:!1}),t.setZoom(17)},"testperf to"(){t.setCenter([37.601315,55.753694],{animate:!1}),t.setZoom(17)}};n.add(r,"apply"),n.add(r,"create"),n.add(r,"navigate to"),n.add(r,"testperf to"),n.add(r,"testPerf1"),n.add(r,"testPerf2"),n.add(r,"testPerf3"),n.add(r,"testPerf11"),n.add(r,"testPerf21"),n.add(r,"testPerf31"),n.add(r,"destroy"),n.add(o,"animationExpr",o.animationExpr);function s(){const{center:S,zoom:A}=p9.filter(z=>z.name===p4.place)[0];S&&A&&(t.setCenter(S,{animate:!1}),t.setZoom(A,{animate:!1}))}const a=[];let l=null;const c=e.addFolder("Multi Tiles"),d={count:10};c.add(d,"count",0,100,1).onFinishChange(S=>{const A=t._impl.modules.tileManager.getTileObjects();l={};for(let z=0;z<A.length;++z){const M=A[z],P=m4[Math.floor(Math.random()*m4.length)];l[P]||(l[P]={type:"FeatureCollection",features:[]}),v$(M,S,l[P].features)}u()});function u(){if(a.forEach(S=>S.destroy()),a.length=0,!!l)for(const S in l)a.push(new Ea(t,{attributes:{name:`gltf_${S}`},data:l[S]}))}const f=e.addFolder("instancing");let h=null,_=null;const p={count:100,putOnClick:!1,remove:()=>{_=null,k()},offsetsTest:()=>{g$(t,t.getCenter())}};f.add(p,"offsetsTest"),f.add(p,"count",0,1e3,1).onChange(()=>{_=g4(t.getBounds(),p.count),k()}),f.add(p,"putOnClick").onChange(S=>{S?t.on("click",w):t.off("click",w)}),f.add(p,"remove");const m=e.addFolder("trees"),g={scale:ha,opacity:1,add:()=>{Jl(t,{scale:g.scale},g.opacity)}};m.add(g,"add"),m.add(g,"scale",0,5,.05).onChange(()=>{Jl(t,{scale:g.scale},g.opacity)}),m.add(g,"opacity",0,1,.05).onChange(()=>{Jl(t,{scale:g.scale},g.opacity)});const y=e.addFolder("random trees"),b={navigateToTrees:()=>{window.location.href="/?zoom=20.000&lng=52.3004776&lat=54.8984498&rotation=30&pitch=69&tileServer=tiles-test-trees.web-staging.2gis.ru&maxPitch=89.00000000000001"},scaleMin:ha-.1,scaleMax:ha+.1,rotationZMin:0,rotationZMax:360,offsetXYMin:-1,offsetXYMax:1,randomCase:()=>{Jl(t,{scale:["random",b.scaleMin,b.scaleMax],rotation:["literal",[0,0,["random",b.rotationZMin,b.rotationZMax]]],offset:["literal",[["random",b.offsetXYMin,b.offsetXYMax],["random",b.offsetXYMin,b.offsetXYMax],0]]},1)},noRandomCase:()=>{Jl(t,{scale:ha},1)}};y.add(b,"navigateToTrees"),y.add(b,"scaleMin",0,ha*2,.02).onChange(()=>{b.randomCase()}),y.add(b,"scaleMax",0,ha*2,.02).onChange(()=>{b.randomCase()}),y.add(b,"rotationZMin",0,360,1).onChange(()=>{b.randomCase()}),y.add(b,"rotationZMax",0,360,1).onChange(()=>{b.randomCase()}),y.add(b,"offsetXYMin",-5,5,1).onChange(()=>{b.randomCase()}),y.add(b,"offsetXYMax",-5,5,1).onChange(()=>{b.randomCase()}),y.add(b,"randomCase"),y.add(b,"noRandomCase");let v=null,T=!1;const x=e.addFolder("neom"),I={navigate(){t.setCenter([35.1154407,28.105899700000002]),t.setZoom(19),t.setPitch(45),t.setRotation(-58)},async add(){const S=await fetch("/assets/neom.json").then(A=>A.json());v&&v.destroy(),v=new Ea(t,{data:S,modelsPath:`${self.origin}/assets/models/anim/`,attributes:{sourceName:"neom"}}),!T&&(T=!0,t.addLayer({id:"neom-models",name:"Immersive Model 3D",type:"model",style:{modelSrc:["get","model_src"],linkedIds:["get","building_id"],visibility:"visible"},filter:["all",["match",["get","db_sublayer"],["Immersive_model","Immersive_model_multipart"],!0,!1],["match",["sourceAttr","sourceName"],["neom"],!0,!1]],minzoom:16,metadata:{style:{modelSrc:{inputMode:"json"},linkedIds:{inputMode:"json"}},filterInputMode:"json"},prevLayerId:"977900",nextLayerId:"porch"}))},remove(){v&&(v.destroy(),v=null)}};x.add(I,"navigate"),x.add(I,"add"),x.add(I,"remove");const E=e.addFolder("entrances (Porch)"),L={init(){t.setStyleById("e86e1147-fbaf-4e7e-85d0-4685dbed7764");const S={id:"demo-porch",name:"Подъезды над домами",type:"point",style:{allowElevation:!0,elevation:3,textFont:"Noto_Sans",iconImage:["match",["get","selected"],[!0],"ent_i","ent"],iconWidth:12,textColor:["match",["isBehindObjects"],[!0],"rgba(0,0,0,0)","#353a3d"],textOffset:0,visibility:"visible",iconOpacity:["match",["isBehindObjects"],[!0],.25,1],iconPriority:21,textFontSize:10,textPriority:20,textPlacement:"topCenter"},filter:["match",["get","sublayer"],["Porch"],!0,!1],minzoom:19};t.on("styleload",()=>{y$(t),t.addLayer(S,"779785"),L.initModelToHidePorches()})},initModelToHidePorches(){const S={type:"FeatureCollection",features:[{type:"Feature",geometry:{type:"Point",coordinates:[82.93867070519173,55.03864821947329]},properties:{linkedIds:["141373143519382"]}}]};new Ea(t,{data:S,attributes:{testScenario:"entrances-hiding"}}),t.addModel("palm",{url:`${self.origin}/assets/models/palm.glb`}),t.addLayer({id:"gltf-model-entrances-hiding",type:"model",style:{modelSrc:"palm",linkedIds:["get","linkedIds"]},filter:["match",["get","testScenario"],["entrances-hiding"],!0,!1],minzoom:20})},navigate(){t.setCenter([82.9389032,55.0386569]),t.setZoom(20),t.setPitch(67),t.setRotation(150)},navigate2(){t.setCenter([82.92238938622826,55.02616663141236]),t.setStyleZoom(19.302883759748134),t.setPitch(64),t.setRotation(30)},navigateByiskStaging(){window.location.href="/?zoom=18.765&lng=85.211717&lat=52.540100&tileServer=tileserver.web-staging.2gis.ru&tileSet=vector_dev"},applyPresentationStyle(){t.setStyleById("11cc23d6-1b04-48bc-9e8f-915451708a4a")},selectAllBuildingsAndNav(){t.setSelectedObjects(["141373143519382","141373143519403","141373143519378","141373143519402","70030076252098815","141373143519268"]),t.setCenter([82.938288,55.03987599999999]),t.setZoom(18.573),t.setPitch(67),t.setRotation(150)},selectFirstPorchesAndNav(){t.setSelectedObjects(["53000","66000","51000","61000","50000","64000"]),t.setCenter([82.938288,55.03987599999999]),t.setZoom(18.573),t.setPitch(67),t.setRotation(150)},hideBuilding53(){t.setHiddenObjects(["141373143519382"])},showBuilding53(){t.unsetHiddenObjects(["141373143519382"])},hideBuilding64a(){t.setHiddenObjects(["141373143519268"])},showBuilding64a(){t.unsetHiddenObjects(["141373143519268"])}};E.add(L,"init"),E.add(L,"navigate"),E.add(L,"navigate2"),E.add(L,"navigateByiskStaging"),E.add(L,"applyPresentationStyle"),f$(t,e);let N=!1;function k(){if(!_){h&&(h.destroy(),h=null);return}h?h.setData(_):h=new Ea(t,{attributes:{name:"gltfModels"},data:_}),N||(m$(t),N=!0)}function w(S){_||(_=g4(t.getBounds(),0)),_.features.push({type:"Feature",properties:{},geometry:{type:"Point",coordinates:S.lngLat}}),k()}};function m$(t){t.on("styleload",()=>{t.addLayer({id:"gltf-model",type:"model",style:{modelSrc:"test"},filter:["match",["sourceAttr","name"],["gltfModels"],!0,!1],minzoom:14}),t.addLayer({id:"offsets-test",type:"model",style:{modelSrc:"test",offset:["literal",[["*",30,["+",-1,["get","x"]]],["*",30,["+",-1,["get","y"]]],["*",30,["get","z"]]]]},filter:["match",["sourceAttr","test"],["xyz"],!0,!1],minzoom:14}),t.addModel("test",{url:"/assets/models/tree1.glb"})})}function g4(t,e){const n=t.northEast[0],i=t.northEast[1],o=t.southWest[0],r=t.southWest[1],s=[];for(let a=0;a<e;a++){const l=o+Math.random()*(n-o),c=r+Math.random()*(i-r);s.push({type:"Feature",properties:{db_id:String(a),scale:Math.random()},geometry:{type:"Point",coordinates:[l,c]}})}return{type:"FeatureCollection",features:s}}const p$=["Model_tree_coniferous_point","Model_tree_deciduous_point","Model_tree_mixed_point","Model_tree_palms_point","Model_tree_shrubs_point"];let v4=!1;function Jl(t,e,n){v4||(t.addModel("coniferous",{url:"/assets/models/pine_d.glb"}),t.addModel("deciduous",{url:"/assets/models/tree_d.glb"}),t.addModel("mixed",{url:"/assets/models/mixtree_d.glb"}),t.addModel("palms",{url:"/assets/models/palm_d.glb"}),t.addModel("shrubs",{url:"/assets/models/bush_d.glb"}),v4=!0);for(const i of p$){const o=i.replace("Model_tree_","").replace("_point",""),r="tree-layer-"+o;t.removeLayer(r);const s={modelSrc:o,...e,color:`rgba(255, 255, 255, ${n})`};t.addLayer({id:r,filter:["==",["get","db_sublayer"],i],type:"model",style:s})}}let pm;function g$(t,e){const n={type:"FeatureCollection",features:[]};for(let i=0;i<3;i++)for(let o=0;o<3;o++)n.features.push({type:"Feature",geometry:{type:"Point",coordinates:e},properties:{x:i,y:o,z:0}});for(let i=1;i<3;i++)n.features.push({type:"Feature",geometry:{type:"Point",coordinates:e},properties:{x:0,y:0,z:i}});pm&&pm.destroy(),pm=new Ea(t,{data:n,attributes:{test:"xyz"}})}function v$(t,e,n){const i=Ct(t.coords);for(let o=0;o<e;o++){const r=Ke(),s=yt(Math.random()*Se,Math.random()*Se,0);Sr(r,s,i);const[a,l]=q.toGeo(r);n.push({type:"Feature",properties:{db_id:String(o),scale:Math.random()},geometry:{type:"Point",coordinates:[a,l]}})}}function y$(t){const e=[{coords:[82.93959304690361,55.038789032332886],entranceType:"entrance-2-white-1"},{coords:[82.9392359778285,55.03875771667748],entranceType:"entrance-2-white-1"},{coords:[82.93886952102184,55.03872544039352],entranceType:"entrance-2-white-1"},{coords:[82.93847054243088,55.038690474389895],entranceType:"entrance-2-white-1"},{coords:[82.93809603899717,55.038657621688344],entranceType:"entrance-2-white-1"},{coords:[82.93773628771305,55.038625921687625],entranceType:"entrance-2-white-1"}],n=[{coords:[82.93907878386474,55.03905291807945],entranceType:"entrance-2-white-1"}],i=[{coords:[82.93716573722921,55.03857551928174],entranceType:"entrance-2-white-1"}],o=[{coords:[82.93848361819983,55.039317552370285],entranceType:"entrance-2-white-1"}],r=[{coords:[82.93735340237617,55.03958305853279],entranceType:"entrance-2-white-1"},{coords:[82.9372813180089,55.03985413428267],entranceType:"entrance-2-white-1"}],s=[{coords:[82.93871160596609,55.04090211009445],entranceType:"entrance-2-white-1",angle:-262},{coords:[82.93866533786058,55.040462751253955],entranceType:"entrance-2-white-1",angle:-172},{coords:[82.93842025101185,55.04027102253654],entranceType:"entrance-2-white-1",angle:-262}],a=[{coords:[82.92302714056888,55.02601087140592],entranceType:"entrance-2-white-1",angle:0},{coords:[82.92280558883589,55.02610430856391],entranceType:"entrance-2-white-1",angle:0},{coords:[82.9224905901632,55.02623161315705],entranceType:"entrance-2-white-1",angle:0},{coords:[82.9222880171249,55.02615045815804],entranceType:"entrance-2-white-1",angle:0},{coords:[82.92231066410177,55.02602016978466],entranceType:"entrance-2-white-1",angle:0},{coords:[82.92240006611374,55.02567870397991],entranceType:"entrance-2-white-1",angle:0}],l=[{coords:[82.92360829132832,55.02653020487443],entranceType:"entrance-2-white-1",angle:0},{coords:[82.92327448814703,55.02667098485351],entranceType:"entrance-2-white-1",angle:0},{coords:[82.92389594045399,55.02714021278187],entranceType:"entrance-2-white-1",angle:0},{coords:[82.92343631119942,55.02705399520609],entranceType:"entrance-2-white-1",angle:0}];for(let c=0;c<e.length;c++){const{coords:d,entranceType:u}=e[c]}for(let c=0;c<n.length;c++){const{coords:d,entranceType:u}=n[c]}for(let c=0;c<i.length;c++){const{coords:d,entranceType:u}=i[c]}for(let c=0;c<o.length;c++){const{coords:d,entranceType:u}=o[c]}for(let c=0;c<r.length;c++){const{coords:d,entranceType:u}=r[c]}for(let c=0;c<s.length;c++){const{coords:d,entranceType:u,angle:f}=s[c]}for(let c=0;c<a.length;c++){const{coords:d,entranceType:u,angle:f}=a[c]}for(let c=0;c<l.length;c++){const{coords:d,entranceType:u,angle:f}=l[c]}t.addModel("entrance-2-white-1",{url:`${self.origin}/assets/models/podezd2_w1.glb`}),t.addLayer({id:"gltf-model-entrances",type:"model",style:{modelSrc:"entrance-2-white-1",rotation:["literal",[0,0,["get","db_rotation_z"]]],color:["match",["get","selected"],[!0],"#e07b72eb","#cfcabcd1"]},filter:["match",["sourceAttr","testScenario"],["entrances"],!0,!1],minzoom:16}),t.addLayer({id:"gltf-model-entrances-test-staging",type:"model",style:{modelSrc:"entrance-2-white-1",rotation:["literal",[0,0,["*",-1,["get","db_model_rotation_angle"]]]],color:["match",["get","selected"],[!0],"#E07B72D1","#E8E2D4D1"],colorBlendingMode:"color"},filter:["all",["match",["get","sublayer"],["Porch"],!0,!1]],minzoom:18.5},"621657")}const y4=[64.658777,17.409508];function b$(t,e,n){const i=e.addFolder("Westeros"),o={init(){t.setCenter(y4,{animate:!1}),Vt(t,{tileServer:"tileserver.web-staging.2gis.ru",tileSet:"vector_dev",zoom:18,center:y4}),window.location.reload()},reset(){Vt(t,{tileServer:void 0,tileSet:void 0}),window.location.reload()}};Object.keys(o).forEach(r=>i.add(o,r)),n.westeros&&o.init()}const w$=(t,e)=>{const n=e.addFolder("Textured polygons"),i=1,o="#46C7A1";function r(u){if(u==="default"){t._impl.setStyle($s);return}t._impl.setStyle(JSON.parse(u))}const s={version:1,name:"2gis_textured_polygons",background:{color:"#f6f2de"},icons:{"graph-paper":{url:"assets/images/graph-paper.svg"},wave:{url:"assets/images/wave.svg"},"wave-transparent":{url:"assets/images/wave-transparent.svg"}},layers:[]},a={default:"default","graph-paper":JSON.stringify({...s,layers:[{type:"polygon",style:{color:o,textureImage:"graph-paper",textureSize:[140,80],textureOpacity:i},filter:["match",["get","db_sublayer"],["Forest_quarter"],!0,!1]}]}),waves:JSON.stringify({...s,layers:[{type:"polygon",style:{color:o,textureImage:["step",["zoom"],"wave-transparent",13.5,"",15,"wave"],textureSize:[256,256],textureOpacity:i},filter:["match",["get","sublayer"],["Water_area"],!0,!1]}]})},l={style:"default",textureOpacity:i,color:o},c=n.add(l,"style",Object.keys(a)).onChange(u=>{r(a[u])});n.addColor(l,"color").onChange(d),n.add(l,"textureOpacity",0,1,.01).onChange(d);function d(u){Object.keys(a).forEach(f=>{if(f==="default")return;const h=JSON.parse(a[f]);h.layers[0].style[this.property]=u,a[f]=JSON.stringify(h)}),r(a[c.getValue()])}},x$={type:"FeatureCollection",features:[{type:"Feature",properties:{id:1,name:"ustoi",ustoi:!1,triangles:!1},geometry:{type:"MultiPolygon",coordinates:[[[[64.684549,17.3975546,6.5],[64.684549,17.3975508,0],[64.6840177,17.3961593,0],[64.683701,17.3953405,0],[64.6836635,17.3952208,0],[64.6835321,17.3947985,0],[64.6833561,17.3941228,0],[64.6833327,17.3940665,0],[64.6833115,17.3940313,0],[64.6832928,17.3940032,0],[64.6832365,17.3939656,0],[64.6830933,17.3939445,0],[64.6830417,17.3939445,0],[64.6830159,17.3939468,0],[64.6829831,17.3939609,0],[64.6829737,17.3939844,0],[64.682976,17.3940266,0],[64.6829925,17.3940853,0],[64.6832224,17.3949111,0],[64.683403,17.3953991,0],[64.6837174,17.3961781,0],[64.6839474,17.3966801,0],[64.6841538,17.3971494,0],[64.6843813,17.3976192,0],[64.6843854,17.3976178,6.5],[64.683591,17.39573,6.5],[64.6834622,17.3953861,6.5],[64.6834254,17.3952892,6.5],[64.6834245,17.3952867,6.5],[64.6832847,17.3948771,6.5],[64.6832833,17.3948724,6.5],[64.6830532,17.3940372,6.5],[64.6832409,17.3940561,6.5],[64.6834532,17.3948267,6.5],[64.6835917,17.3952326,6.5],[64.683628,17.3953281,6.5],[64.6837564,17.3956711,6.5],[64.684549,17.3975546,6.5]]]]}},{type:"Feature",properties:{id:2,name:"ustoi",ustoi:!0,triangles:!1},geometry:{type:"MultiPolygon",coordinates:[[[[64.6826532,17.3940121,6.5],[64.6828422,17.3940375,6.5],[64.6829053,17.394045,0],[64.6828966,17.3940044,0],[64.68289,17.3939825,0],[64.6828757,17.3939628,0],[64.6828604,17.3939474,0],[64.6828483,17.3939387,0],[64.6828176,17.3939244,0],[64.682787,17.3939145,0],[64.6827541,17.3939069,0],[64.6826806,17.3938959,0],[64.6826247,17.3938806,0],[64.6825941,17.3938751,0],[64.6825601,17.3938751,0],[64.6825371,17.3938806,0],[64.682525,17.3938926,0],[64.6825173,17.3939167,0],[64.6825129,17.393943,0],[64.6825261,17.3939989,0],[64.6826532,17.3940121,6.5]]]]}},{type:"Feature",properties:{id:3,name:"ustoi",ustoi:!1,triangles:!1},geometry:{type:"MultiPolygon",coordinates:[[[[64.6825261,17.3939989,0],[64.6825483,17.394098,0],[64.6825943,17.3942317,0],[64.6826995,17.3945474,0],[64.6830317,17.3953859,0],[64.6831928,17.3957498,0],[64.6832386,17.3958605,0],[64.6832437,17.3958595,6.5],[64.6830702,17.3954072,6.5],[64.6830692,17.3954046,6.5],[64.6829244,17.3949859,6.5],[64.682923,17.3949813,6.5],[64.6826814,17.3941194,6.5],[64.6826814,17.3941194,6.5],[64.6826532,17.3940121,6.5],[64.6825261,17.3939989,0]]]]}},{type:"Feature",properties:{id:4,name:"ustoi",ustoi:!1,triangles:!1},geometry:{type:"MultiPolygon",coordinates:[[[[64.6828422,17.3940375,0],[64.6828422,17.3940375,6.5],[64.6828526,17.3940778,6.5],[64.6830927,17.3949348,6.5],[64.6832363,17.3953499,6.5],[64.6834087,17.3957994,6.5],[64.6834242,17.3957912,0],[64.6833166,17.3954619,0],[64.6832618,17.3953238,0],[64.6831347,17.394892,0],[64.6831347,17.394892,0],[64.6829053,17.394045,0],[64.6828422,17.3940375,0]]]]}},{type:"Feature",properties:{id:22,name:"ustoi",ustoi:!0,triangles:!1},geometry:{type:"MultiPolygon",coordinates:[[[[64.6845492,17.3975549,6.5],[64.6847958,17.3981496,6.5],[64.6850083,17.3987188,6.5],[64.6848417,17.3987747,6.5],[64.6846301,17.3982082,6.5],[64.6843854,17.3976178,6.5],[64.68438334246194,17.3976185592022,0],[64.68462806943502,17.398208892842216,0],[64.68462900165464,17.3982113693343,0],[64.68479148835354,17.398648409314195,0],[64.68483894840391,17.39877602374081,0],[64.68483931379652,17.398776747911338,0],[64.684840100796,17.398777346916592,0],[64.68484100490849,17.39877783863733,0],[64.68484222756838,17.39877774923355,0],[64.68493241396065,17.39874833539124,0],[64.6850095931956,17.39872039950072,0],[64.6850103380344,17.39871986307794,0],[64.68501054415331,17.398719080794713,0],[64.68501039424864,17.398718240399017,0],[64.68479854616966,17.39814878649156,0],[64.68455267207455,17.397553703050548,0],[64.6845492,17.3975549,6.5]]]]}}]},b4={type:"FeatureCollection",features:[{type:"Feature",bbox:[30.5387205,59.9463272,30.5442021,59.9475111],geometry:{type:"Polygon",coordinates:[[[30.5418927,59.9464711,0],[30.5419668,59.9465984,0],[30.5423119,59.947115,0],[30.5424289,59.9472094,0],[30.5425686,59.9472766,0],[30.5427569,59.9473367,0],[30.5429651,59.9473668,0],[30.5431676,59.9473711,0],[30.5433872,59.9473453,0],[30.543564,59.9473038,0],[30.5437836,59.9472108,0],[30.5439291,59.9471121,0],[30.5439919,59.947012,0],[30.5440147,59.9469075,0],[30.5439832,59.9468073,0],[30.5439376,59.9467358,0],[30.543855,59.9466514,0],[30.5437295,59.9465784,0],[30.5435868,59.946524,0],[30.5434414,59.9464725,0],[30.542979,59.9463748,0],[30.5431263,59.9463903,0],[30.5433272,59.9464146,0],[30.5433284,59.9464147,0],[30.5433493,59.9464168,0],[30.5434115,59.9464252,0],[30.5434725,59.9464354,.010363990878909046],[30.5435323,59.9464473,.048879988364485705],[30.5435906,59.9464609,.08864934312029149],[30.5436472,59.9464762,.12969390459901087],[30.5437019,59.9464931,.16822253908574236],[30.5437546,59.9465117,.20932071530887475],[30.543805,59.9465317,.24904905274885492],[30.543853,59.9465531,.28755792026722027],[30.5438985,59.946576,.32866471246763984],[30.5439413,59.9466,.3671735799862139],[30.5439812,59.9466253,.40690191742677584],[30.5440181,59.9466518,.44800009364913995],[30.5440519,59.9466792,.486528728135871],[30.5440824,59.9467076,.5275732896138821],[30.5441095,59.9467368,.5673426443693577],[30.5441332,59.9467668,.6058586418572631],[30.5441535,59.9467975,.6456842196923456],[30.5441702,59.9468286,.6854702027622905],[30.5441831,59.9468602,.725276208331745],[30.5441924,59.9468921,.7650357621765782],[30.5441982,59.9469247,.8056503525233016],[30.5442021,59.9469519,.8409663695043985],[30.5441981,59.9469886,.8855449053566675],[30.5441924,59.9470209,.9255732943306876],[30.5441831,59.9470528,.9653328481765082],[30.5441702,59.9470844,1.005138853744716],[30.5441535,59.9471156,1.0449248368162916],[30.5441332,59.9471462,1.084750414655185],[30.5441095,59.9471762,1.1232664121384317],[30.5440824,59.9472055,1.163035766893907],[30.5440519,59.9472338,1.2040803283719181],[30.5440181,59.9472613,1.242608962858649],[30.5439812,59.9472877,1.2837071390810129],[30.5439413,59.947313,1.323435476523526],[30.5438985,59.9473371,1.3619443440383505],[30.543853,59.9473599,1.4030511362441018],[30.543805,59.9473814,1.441560003759135],[30.5437546,59.9474014,1.4812883411991153],[30.5437019,59.9474199,1.522386517422248],[30.5436472,59.9474369,1.5609151519089794],[30.5435906,59.9474522,1.601959713387699],[30.5435323,59.9474658,1.641729068140993],[30.5434725,59.9474777,1.6802450656284198],[30.5434115,59.9474878,1.7200706434692297],[30.5433493,59.9474962,1.7598566265332414],[30.5432863,59.9475027,1.7996626321068039],[30.5432227,59.9475074,1.8394221859508058],[30.5431587,59.9475102,1.8791824589939268],[30.5430943,59.9475111,1.9202418995763688],[30.54303,59.9475102,1.9600811088320902],[30.542966,59.9475074,1.9998413818752112],[30.5429024,59.9475027,2.0396009357192133],[30.5428394,59.9474962,2.079406941292776],[30.5427772,59.9474878,2.119192924356787],[30.5427162,59.9474777,2.1590185021975974],[30.5426564,59.9474658,2.197534499685024],[30.5425981,59.9474522,2.237303854436616],[30.5425415,59.9474369,2.27834841591619],[30.5424868,59.9474199,2.316877050402921],[30.5424341,59.9474014,2.357975226626763],[30.5423837,59.9473814,2.397703564066743],[30.5423357,59.9473599,2.4362124315817764],[30.5423294,59.9473568,2.4427960090530334],[30.5423291,59.9473566,2.4428131806958637],[30.5421639,59.94727,2.5],[30.5420802,59.9472137,2.5],[30.542008,59.9471508,2.5],[30.5419562,59.9470901,2.5],[30.5415911,59.9465319,5],[30.5415086,59.9464014,5],[30.5411521,59.9463944,5],[30.5410937,59.9463933,5],[30.5407426,59.9463865,5],[30.5408678,59.9466193,5],[30.5408725,59.9466304,5],[30.540923,59.946759,5],[30.5409477,59.94684,5],[30.5409477,59.9469135,5],[30.5409338,59.9470102,4.950341325807122],[30.5408881,59.9470863,4.788553318606312],[30.5408207,59.9471584,4.62123067748718],[30.5407331,59.9472246,4.454078424436583],[30.5406271,59.9472838,4.286792014088534],[30.5405055,59.9473347,4.119840554258517],[30.54037,59.9473761,3.95247048755019],[30.540224,59.9474071,3.7798753023017015],[30.5400705,59.9474272,3.6179735251403105],[30.539913,59.9474358,3.4507757671919],[30.5397524,59.9474328,3.2806043030038095],[30.5396384,59.9474294,3.1640094374992738],[30.5395318,59.9474171,3.042472098219375],[30.5393811,59.9473913,2.8744713417956365],[30.5392401,59.9473549,2.7072611381755216],[30.5391111,59.9473086,2.5452892384699743],[30.5389972,59.9472533,2.3781193914049963],[30.5389004,59.9471904,2.210971736042984],[30.5388229,59.947121,2.043814816010668],[30.5387664,59.9470467,1.8712825590286297],[30.538732,59.9469691,1.7040161477500204],[30.5387205,59.9468897,1.5367399256457632],[30.5387322,59.9468104,1.3696383949660977],[30.5387667,59.9467328,1.2078260052356733],[30.5388237,59.9466586,1.040469152711335],[30.5389014,59.9465893,.8733442657430376],[30.5389982,59.9465263,.7062412684133722],[30.5391124,59.9464711,.5389905148412796],[30.5392415,59.9464249,.3664084787021627],[30.5393835,59.9463884,.20024077467096],[30.5395409,59.9463561,.022132280945813307],[30.5396672,59.946343,0],[30.5398689,59.9463272,0],[30.5396767,59.9463548,0],[30.5395417,59.9463777,0],[30.5393839,59.9464216,0],[30.5392375,59.9464693,0],[30.5391063,59.9465313,0],[30.5389863,59.9466056,0],[30.5389236,59.9466915,0],[30.5388865,59.9467673,0],[30.5388665,59.9468632,0],[30.5388722,59.9469404,0],[30.5389264,59.9470262,0],[30.5389863,59.9470878,0],[30.5391146,59.9471665,0],[30.5392116,59.9472123,0],[30.5393571,59.9472594,0],[30.5395795,59.9473009,0],[30.5397564,59.9473153,0],[30.5399275,59.9473153,0],[30.5401271,59.9472924,0],[30.5403011,59.9472423,0],[30.5404324,59.9471865,0],[30.5405322,59.9471078,0],[30.5406006,59.9470277,0],[30.5406348,59.9469547,0],[30.5406491,59.9468746,0],[30.5406377,59.9467988,0],[30.5405863,59.9467201,0],[30.5405179,59.9466471,0],[30.5404494,59.9465369,0],[30.5404237,59.9464268,0],[30.5404438,59.9463953,0],[30.5406773,59.9463762,0],[30.541841,59.9463989,0],[30.5418778,59.9464091,0],[30.5418927,59.9464711,0]]]},properties:{IsImmersivePublished:1,ImmersivePublicationPolygon:{id:383184818},Id:381980360,SysCode:0xf8cbfbdd69ec10,Class:{id:6316,sysCode:55101,name:"Embankment_polygon"}}},{type:"Feature",bbox:[30.5378897,59.9438678,30.5433505,59.9459189],geometry:{type:"Polygon",coordinates:[[[30.5415064,59.9459177,0],[30.540035,59.9458891,0],[30.540028,59.9458764,0],[30.5400509,59.9458592,0],[30.5400566,59.9458206,0],[30.5399396,59.9454414,0],[30.5398855,59.9453327,0],[30.5397885,59.9452067,0],[30.5396602,59.9450837,0],[30.5394748,59.9449807,0],[30.5392894,59.9449335,0],[30.5390469,59.944902,0],[30.5387902,59.9449006,0],[30.5385992,59.9449277,0],[30.5384024,59.9449907,0],[30.5382455,59.9450622,0],[30.5381314,59.9451409,0],[30.5380658,59.9452167,0],[30.5380344,59.9452912,0],[30.5380287,59.9453842,0],[30.538063,59.9454972,0],[30.5381171,59.9455845,0],[30.5382113,59.9456618,0],[30.5383026,59.9457118,0],[30.5384098,59.9457794,0],[30.5385717,59.9458561,2.5],[30.5384944,59.9458387,.04885720386374574],[30.5384429,59.9458248,.08667461651732886],[30.5383882,59.9458079,.12511140688963882],[30.5383354,59.9457894,.16612371779782695],[30.5382849,59.9457693,.20588467606028765],[30.5382369,59.9457478,.24437010361849423],[30.5381913,59.945725,.2854042275847819],[30.5381486,59.9457009,.32388965514278223],[30.5381086,59.9456756,.3636506134025906],[30.5380717,59.9456491,.4046629243128205],[30.5380379,59.9456217,.44312792992084477],[30.5380074,59.9455932,.48413800089917064],[30.5379801,59.9455639,.5239270967504586],[30.5379564,59.945534,.5623794862302035],[30.5379362,59.9455033,.6021392933262608],[30.5379195,59.9454721,.6431912394148619],[30.5379066,59.9454405,.681651739936803],[30.5378971,59.9454085,.7213821721633527],[30.5378916,59.9453764,.7611814614781407],[30.5378897,59.9453441,.8008960764173111],[30.5378916,59.9453118,.8418868676026587],[30.5378971,59.9452797,.8816861569174471],[30.5379066,59.9452477,.9214165891439966],[30.5379195,59.9452161,.9598770896659378],[30.5379362,59.9451849,1.0009290357545388],[30.5379564,59.9451542,1.0406888428505963],[30.5379801,59.9451243,1.079141232330341],[30.5380074,59.945095,1.118930328181629],[30.5380379,59.9450665,1.1599403991599548],[30.5380717,59.9450391,1.198405404767979],[30.5381086,59.9450126,1.2394177156765351],[30.5381486,59.9449874,1.2779010545487024],[30.5381913,59.9449632,1.317664101501735],[30.5382369,59.9449404,1.3586982254624909],[30.5382849,59.9449189,1.3971836530206974],[30.5383354,59.9448988,1.4369446112831579],[30.5383882,59.9448803,1.4779569221913462],[30.538443,59.9448634,1.5176899017180003],[30.5384996,59.9448481,1.556164029656164],[30.5385579,59.9448344,1.597221094631894],[30.5386177,59.9448225,1.6356734841102374],[30.5386788,59.9448124,1.6754332912076504],[30.538741,59.944804,1.7164852372997275],[30.538804,59.9447975,1.7549457378172721],[30.5388677,59.9447928,1.794676170042427],[30.5389318,59.94479,1.834475459357089],[30.5389961,59.944789,1.8741900742992585],[30.5390605,59.94479,1.9151808654848266],[30.5391246,59.9447928,1.9549801547994885],[30.5391883,59.9447975,1.9947105870246438],[30.5392513,59.944804,2.0331710875421884],[30.5393135,59.9448124,2.0742230336342646],[30.5393746,59.9448225,2.113982840731678],[30.5394343,59.9448344,2.1524352302100214],[30.5394927,59.9448481,2.1934922951857514],[30.5395493,59.9448634,2.231966423123915],[30.5396041,59.9448803,2.2716994026505692],[30.5396569,59.9448988,2.3127117135587576],[30.5397073,59.9449189,2.3524726718212183],[30.5397554,59.9449404,2.3909580993794246],[30.5398009,59.9449632,2.4319922233401807],[30.5398437,59.9449873,2.47047765090192],[30.5398837,59.9450126,2.5],[30.5399211,59.9450395,2.5],[30.540038,59.945145,2.5],[30.5401179,59.9452289,2.5],[30.5401685,59.9452997,2.5],[30.540475,59.9458886,5],[30.5406199,59.9458351,5],[30.540826,59.9458955,5],[30.5408827,59.9458966,5],[30.5409984,59.9457844,5],[30.5412325,59.9459034,5],[30.5406187,59.9446488,2.5223900355730122],[30.5406157,59.9446385,0],[30.5405851,59.9445378,0],[30.5405717,59.9444729,0],[30.5405726,59.9443807,0],[30.5406103,59.9442757,0],[30.5407033,59.9441816,0],[30.5408242,59.9440843,0],[30.5409667,59.9440039,0],[30.5411286,59.9439412,0],[30.5413066,59.9438972,0],[30.5414977,59.9438726,0],[30.5416982,59.9438678,0],[30.5419045,59.9438832,0],[30.5421131,59.9439184,0],[30.5423181,59.9439727,0],[30.5424775,59.9440434,0],[30.5426084,59.9441397,0],[30.5427118,59.9442338,0],[30.5427884,59.9443233,0],[30.5433091,59.9452334,0],[30.5433505,59.9453548,0],[30.543341,59.945483,0],[30.5432956,59.9455916,0],[30.5432214,59.9456875,0],[30.5431038,59.9457707,0],[30.5429343,59.9458461,0],[30.542736,59.9458999,0],[30.5426401,59.9459189,0],[30.5427064,59.9458718,0],[30.5428293,59.9458091,0],[30.5429963,59.9457318,0],[30.5431075,59.9456482,0],[30.5431674,59.945558,0],[30.543193,59.9454507,0],[30.543193,59.9453413,0],[30.5431502,59.9452211,0],[30.542624,59.9443561,0],[30.5425213,59.9442252,0],[30.5424186,59.9441436,0],[30.5422475,59.9440792,0],[30.5420507,59.9440148,0],[30.541854,59.9439955,0],[30.5416486,59.9439891,0],[30.5414518,59.9440041,0],[30.5412507,59.9440513,0],[30.5410753,59.9441222,0],[30.5409512,59.9442166,0],[30.5408656,59.9443175,0],[30.5408229,59.9444205,0],[30.5408656,59.9445643,0],[30.5409983,59.9448712,0],[30.5413748,59.9456203,0],[30.5414432,59.945704,0],[30.5414945,59.9457641,0],[30.5415159,59.9458027,0],[30.5415218,59.9458996,0],[30.5415064,59.9459177,0]]]},properties:{IsImmersivePublished:1,ImmersivePublicationPolygon:{id:383184818},Id:381982622,SysCode:0xf8cbfbdd6a0688,Class:{id:6316,sysCode:55101,name:"Embankment_polygon"}}},{type:"Feature",bbox:[30.5399212,59.9425398,30.5406141,59.9443011],geometry:{type:"Polygon",coordinates:[[[30.5406141,59.9439176,0],[30.5404643,59.9443011,2.5],[30.540451,59.9442992,2.5],[30.5404413,59.94429,2.5],[30.5404167,59.944239,2.5],[30.5403253,59.9439886,2.5],[30.540215,59.9436722,2.5],[30.5399212,59.9425743,2.5],[30.5399212,59.9425517,2.5],[30.5399343,59.9425398,2.5],[30.540287,59.9430142,0],[30.5402947,59.9430238,0],[30.5403194,59.943103,0],[30.5405855,59.9438976,0],[30.5405969,59.943911,0],[30.5406141,59.9439176,0]]]},properties:{IsImmersivePublished:1,ImmersivePublicationPolygon:{id:383184818},Id:381982828,SysCode:0xf8cbfbdd6a0840,Class:{id:6316,sysCode:55101,name:"Embankment_polygon"}}},{type:"Feature",bbox:[30.5404643,59.943707,30.5425272,59.9443011],geometry:{type:"Polygon",coordinates:[[[30.5420182,59.9437256,0],[30.5420239,59.943707,0],[30.5425272,59.9440176,0],[30.5423623,59.9439444,1.73259360583591],[30.5423553,59.9439419,1.7326019626322369],[30.542144,59.943886,1.813665388348794],[30.5421387,59.9438849,1.813673766364357],[30.5419244,59.9438486,1.8904297407417108],[30.5419182,59.9438479,1.890444621117037],[30.5417052,59.943832,1.9635031226330293],[30.5416983,59.9438318,1.9635050719246914],[30.5414906,59.9438368,2.034065371262253],[30.5414834,59.9438373,2.034065371262253],[30.5412852,59.9438628,2.103493609052418],[30.5412783,59.9438641,2.1034947066865817],[30.5410937,59.9439098,2.173349697458547],[30.5410877,59.9439117,2.1733539279487175],[30.5409203,59.9439766,2.2451105068122508],[30.5409154,59.9439788,2.245117966194709],[30.5407687,59.9440616,2.3200461128790755],[30.5407651,59.9440641,2.320048233808387],[30.5406235,59.9441591,2.3991737490859437],[30.5404928,59.9442801,2.484297749640441],[30.5404794,59.9442945,2.4946447952448176],[30.5404643,59.9443011,2.5],[30.5406141,59.9439176,0],[30.5406304,59.9439188,0],[30.5406475,59.9439179,0],[30.5406663,59.943913,0],[30.5407889,59.9438687,0],[30.5409572,59.9438172,0],[30.5411511,59.9437671,0],[30.5413736,59.9437313,0],[30.5415647,59.9437199,0],[30.5417558,59.9437184,0],[30.5419012,59.9437284,0],[30.5419868,59.9437356,0],[30.5420182,59.9437256,0]]]},properties:{IsImmersivePublished:1,ImmersivePublicationPolygon:{id:383184818},Id:381996551,SysCode:0xf8cbfbdd6ab4a8,Class:{id:6316,sysCode:55101,name:"Embankment_polygon"}}},{type:"Feature",bbox:[30.5420239,59.9436981,30.5435048,59.9460118],geometry:{type:"Polygon",coordinates:[[[30.5426606,59.9441144,1.5812004638434671],[30.5425341,59.9440213,1.6574112491367896],[30.5425282,59.944018,1.6574233810993753],[30.5420239,59.943707,0],[30.5420973,59.9436981,0],[30.5421733,59.9437019,0],[30.5422437,59.94372,0],[30.5423122,59.9437629,0],[30.5425365,59.9439175,0],[30.5426438,59.9440027,0],[30.5428348,59.9442028,0],[30.5429603,59.9443974,0],[30.5434623,59.9453175,0],[30.5435048,59.9454325,0],[30.543482,59.9454457,0],[30.5434685,59.945469,0],[30.5434457,59.9455177,0],[30.5433943,59.9456221,0],[30.5433515,59.9456879,0],[30.5432574,59.9457666,0],[30.5431148,59.9458496,0],[30.5429465,59.9459168,0],[30.5427498,59.9459641,0],[30.5424167,59.9460118,.11271136067840848],[30.5425802,59.9459693,.17258579208300606],[30.5427642,59.9459328,.23971640063611366],[30.5429719,59.9458767,.31833480380656765],[30.5429786,59.9458744,.31833480380656765],[30.5431544,59.9457962,.3980181189788161],[30.5431598,59.9457932,.39802631107578623],[30.5432824,59.9457064,.4699704048919413],[30.5432865,59.9457025,.4699704048919413],[30.5433633,59.9456032,.5420103372693907],[30.543365,59.9456004,.5420106855884403],[30.5434117,59.9454889,.6191078638252661],[30.5434124,59.9454859,.6191096719566376],[30.5434222,59.9453543,.7081850249376445],[30.5434217,59.9453506,.7081893859215886],[30.5433793,59.9452264,.7934266788814126],[30.5428599,59.9443181,1.4313160138388963],[30.5428502,59.9443045,1.4395527874702203],[30.5427814,59.9442241,1.498768355591264],[30.5427704,59.9442127,1.5060914885470893],[30.5426765,59.9441273,1.572131347486299],[30.5426606,59.9441144,1.5812004638434671]]]},properties:{IsImmersivePublished:1,ImmersivePublicationPolygon:{id:383184818},Id:382000136,SysCode:0xf8cbfbdd6ae518,Class:{id:6316,sysCode:55101,name:"Embankment_polygon"}}},{type:"Feature",bbox:[30.5399343,59.9425374,30.5436032,59.9454341],geometry:{type:"Polygon",coordinates:[[[30.5435419,59.9454261,0],[30.5435048,59.9454325,0],[30.5434623,59.9453175,0],[30.5429603,59.9443974,0],[30.5428348,59.9442028,0],[30.5426438,59.9440027,0],[30.5425365,59.9439175,0],[30.5423122,59.9437629,0],[30.5422437,59.94372,0],[30.5421733,59.9437019,0],[30.5420973,59.9436981,0],[30.5420239,59.943707,0],[30.5420096,59.9436855,0],[30.5419754,59.9436655,0],[30.541907,59.9436354,0],[30.540478,59.9430645,0],[30.5404067,59.943023,0],[30.5401445,59.9428226,0],[30.5399343,59.9425398,2.5],[30.5399569,59.9425374,2.248210453991435],[30.5399845,59.9425412,2.2434330715390005],[30.540017,59.9425589,2.2286430278076312],[30.5400246,59.9425642,2.2245188861148915],[30.54012,59.942652,2.161104375849984],[30.5401306,59.9426603,2.156157088849],[30.5402764,59.942764,2.0756523393435433],[30.5402815,59.9427675,2.073297781207561],[30.5404374,59.9428708,1.9911176970159772],[30.540446,59.9428761,1.9880086375838264],[30.5406323,59.9429757,1.9013620732322996],[30.5406389,59.9429791,1.8987256829223145],[30.5407361,59.9430279,1.854969787681397],[30.5407409,59.9430303,1.8534245130325175],[30.5408531,59.9430809,1.8054365479585446],[30.5408594,59.9430835,1.8037112136187972],[30.5421649,59.943587,1.2797989976469517],[30.5423508,59.9436875,1.190919998397008],[30.5425038,59.9437856,1.1099937156117323],[30.5426517,59.9438989,1.0229400212571125],[30.5427923,59.9440347,.9241446405595821],[30.5428833,59.9441702,.8326799111051335],[30.5434628,59.9452653,.11535631165922444],[30.5435376,59.9453626,.049205176330836764],[30.5436032,59.9454341,0],[30.5435747,59.9454264,0],[30.5435419,59.9454261,0]]]},properties:{IsImmersivePublished:1,ImmersivePublicationPolygon:{id:383184818},Id:382000176,SysCode:0xf8cbfbdd6ae560,Class:{id:6316,sysCode:55101,name:"Embankment_polygon"}}},{type:"Feature",bbox:[30.5358904,59.943758,30.5394825,59.9458765],geometry:{type:"Polygon",coordinates:[[[30.538222,59.9448671,0],[30.5378512,59.9450961,0],[30.5376877,59.9452554,0],[30.5376153,59.9453813,0],[30.5375831,59.9453775,0],[30.5375412,59.9453851,0],[30.5374595,59.9454261,0],[30.5373112,59.9455053,0],[30.5371799,59.945572,0],[30.5370411,59.9456369,0],[30.5368814,59.9457008,0],[30.5367255,59.9457437,0],[30.5365468,59.9457886,0],[30.5363414,59.9458315,0],[30.5361703,59.9458515,0],[30.5358904,59.9458765,0],[30.5360495,59.9458466,.074],[30.5361102,59.9458354,.103],[30.5361723,59.9458231,.132],[30.5362319,59.9458105,.161],[30.5362928,59.9457968,.189],[30.5363513,59.9457829,.218],[30.5364109,59.9457678,.247],[30.536468,59.9457525,.276],[30.5365262,59.9457361,.305],[30.5365818,59.9457196,.334],[30.5366385,59.9457018,.362],[30.5366926,59.945684,.391],[30.5367476,59.9456651,.42],[30.5368,59.945646,.449],[30.5368532,59.9456258,.478],[30.5369039,59.9456056,.507],[30.5369551,59.9455842,.535],[30.5370039,59.9455629,.564],[30.5370532,59.9455402,.593],[30.5370956,59.9455199,.619],[30.5371471,59.9454941,.651],[30.5371919,59.9454706,.68],[30.537237,59.9454459,.708],[30.5372795,59.9454214,.737],[30.5373221,59.9453957,.766],[30.5373624,59.9453703,.795],[30.5389229,59.9443842,1.913],[30.5389614,59.944355,1.942],[30.5389957,59.9443274,1.971],[30.5390297,59.9442986,1.999],[30.5390614,59.9442703,2.028],[30.5390928,59.9442408,2.057],[30.5391219,59.9442118,2.086],[30.5391506,59.9441816,2.115],[30.5391771,59.944152,2.143],[30.5392029,59.9441211,2.172],[30.5392267,59.9440909,2.201],[30.5392496,59.9440595,2.23],[30.5392707,59.9440287,2.259],[30.5392909,59.9439968,2.288],[30.539309,59.9439656,2.316],[30.5393263,59.9439333,2.345],[30.5393416,59.9439018,2.374],[30.5393559,59.9438691,2.403],[30.5393684,59.9438372,2.432],[30.5393797,59.9438042,2.461],[30.5393892,59.9437724,2.489],[30.5393989,59.9437664,2.496],[30.5394188,59.94376,2.5],[30.5394374,59.943758,2.5],[30.5394574,59.9437594,2.5],[30.539472,59.9437637,2.5],[30.5394825,59.943769,2.5],[30.5394458,59.944056,0],[30.539403,59.9441718,0],[30.5393559,59.9442491,0],[30.5392062,59.944395,0],[30.5389923,59.944556,0],[30.538804,59.9446312,0],[30.538222,59.9448671,0]]]},properties:{IsImmersivePublished:1,ImmersivePublicationPolygon:{id:383184818},Id:382002003,SysCode:0xf8cbfbdd6b06a0,Class:{id:6316,sysCode:55101,name:"Embankment_polygon"}}},{type:"Feature",bbox:[30.539403,59.943769,30.5399911,59.9449602],geometry:{type:"Polygon",coordinates:[[[30.5394825,59.943769,2.5],[30.5396658,59.9442723,2.5],[30.5397623,59.9445109,2.5],[30.5397745,59.9445377,2.5],[30.5397861,59.9445619,2.5],[30.5399851,59.9449395,2.5],[30.5399911,59.9449602,2.5],[30.5396926,59.9447325,0],[30.539607,59.9446652,0],[30.5395699,59.944618,0],[30.5395329,59.9445436,0],[30.5394929,59.9444621,0],[30.539403,59.9441718,0],[30.5394458,59.944056,0],[30.5394825,59.943769,2.5]]]},properties:{IsImmersivePublished:1,ImmersivePublicationPolygon:{id:383184818},Id:382002138,SysCode:0xf8cbfbdd6b07b8,Class:{id:6316,sysCode:55101,name:"Embankment_polygon"}}},{type:"Feature",bbox:[30.5376153,59.9445962,30.5399911,59.9458935],geometry:{type:"Polygon",coordinates:[[[30.5396926,59.9447325,0],[30.5399911,59.9449602,2.5],[30.5399878,59.9449696,2.5],[30.5399821,59.9449739,2.5],[30.5399668,59.9449801,2.5],[30.5399541,59.944982,2.5],[30.5399422,59.9449825,2.5],[30.5399332,59.944982,2.5],[30.539921,59.9449784,2.4920840440027927],[30.5398973,59.9449627,2.4698411002901257],[30.5398523,59.9449381,2.4313502271613494],[30.5398038,59.9449139,2.3915949404243864],[30.5397526,59.944891,2.351820365361265],[30.5396988,59.9448697,2.3120693981619977],[30.5396426,59.94485,2.2722875594784435],[30.5395843,59.944832,2.2325907638965394],[30.5395258,59.9448162,2.1928544386596545],[30.5394617,59.9448012,2.153041102500248],[30.5394,59.9447889,2.1133326948343236],[30.539333,59.9447778,2.073578225406208],[30.5392688,59.9447691,2.0338106175109387],[30.5392017,59.9447622,1.994085234905558],[30.5391339,59.9447572,1.9543194841194444],[30.5390656,59.9447541,1.9145618327521057],[30.5389951,59.9447531,1.8748216201627315],[30.5389287,59.944754,1.8350944920898098],[30.5388631,59.9447569,1.79692426992092],[30.5387893,59.9447623,1.7547628072330292],[30.5387235,59.9447691,1.715845707330977],[30.5386573,59.9447781,1.6760581362833622],[30.5385942,59.9447885,1.6363365688639782],[30.5385305,59.9448012,1.596615222341668],[30.5384683,59.9448157,1.556801886182261],[30.538408,59.944832,1.5170655609453765],[30.5383497,59.94485,1.4773405501256278],[30.5382935,59.9448697,1.4375869266799177],[30.5382397,59.944891,1.3978359594806506],[30.5381885,59.9449139,1.3580613844175293],[30.5381385,59.9449389,1.3183009425413708],[30.5380943,59.9449638,1.2785263674826788],[30.5380505,59.9449916,1.2387754002794868],[30.5380124,59.9450189,1.199036095684939],[30.5379765,59.9450482,1.1593085378022416],[30.537943,59.9450793,1.1195604407813968],[30.5379139,59.9451105,1.0797471046192386],[30.5378894,59.9451415,1.04003869695374],[30.5378673,59.9451751,1.0002842275274322],[30.5378495,59.9452084,.9604919719896591],[30.5378358,59.945242,.9207764198738991],[30.5378262,59.945275,.8810254862387366],[30.5378202,59.9453093,.8412678348691208],[30.537818,59.9453436,.8015407067973102],[30.5378202,59.9453789,.7618004942116788],[30.5378259,59.9454122,.7220682696072653],[30.5378361,59.9454469,.6822770920563149],[30.5378501,59.9454809,.6425517094474741],[30.5378673,59.9455131,.6027841015533675],[30.5378887,59.9455457,.5630425709835194],[30.5379139,59.9455777,.5233212244615609],[30.537943,59.9456089,.4835078882994029],[30.5379754,59.9456391,.4437715630675638],[30.5380124,59.9456693,.4040322333958604],[30.5380505,59.9456966,.3642929288013128],[30.5380943,59.9457244,.3245419616020457],[30.53814,59.9457501,.2847622314004187],[30.5381885,59.9457743,.2450069446634557],[30.5382381,59.9457965,.20523236960033422],[30.5382973,59.9458198,.16270357642644295],[30.5383556,59.94584,.12155206909924211],[30.5384062,59.9458557,.0860145399217713],[30.5384638,59.9458712,.04963338866205326],[30.5385349,59.9458935,2.5],[30.5384654,59.9458859,0],[30.5382829,59.9458334,0],[30.538106,59.9457743,0],[30.5379786,59.9457218,0],[30.5378722,59.9456588,0],[30.5377486,59.9455463,0],[30.5376896,59.9454605,0],[30.5376648,59.945409,0],[30.537644,59.9453898,0],[30.5376153,59.9453813,0],[30.5376877,59.9452554,0],[30.5378512,59.9450961,0],[30.5382159,59.9448709,0],[30.5382348,59.9448619,0],[30.538804,59.9446312,0],[30.538916,59.9446153,0],[30.5390624,59.9445991,0],[30.5392298,59.9445962,0],[30.5393477,59.9446057,0],[30.5394922,59.9446286,0],[30.539607,59.9446652,0],[30.5396926,59.9447325,0]]]},properties:{IsImmersivePublished:1,ImmersivePublicationPolygon:{id:383184818},Id:382002525,SysCode:0xf8cbfbdd6b0c68,Class:{id:6316,sysCode:55101,name:"Embankment_polygon"}}},{type:"Feature",bbox:[30.5354998,59.9406239,30.5436683,59.945875],geometry:{type:"Polygon",coordinates:[[[30.5385651,59.9410932,0],[30.5385595,59.941026,0],[30.5385737,59.9409874,0],[30.5385994,59.940953,0],[30.5386336,59.9409258,0],[30.5387049,59.9409044,0],[30.5395705,59.9406397,0],[30.539618,59.9406312,0],[30.5396803,59.9406253,0],[30.539746,59.9406239,0],[30.5398087,59.9406296,0],[30.5398628,59.9406453,0],[30.5398999,59.9406625,0],[30.539937,59.9406911,0],[30.5399912,59.940797,0],[30.539997,59.9408543,0],[30.5399769,59.9408872,0],[30.5399285,59.9409602,0],[30.5399028,59.9410532,0],[30.5400228,59.9421287,0],[30.5400741,59.9422446,0],[30.540209,59.9424282,0],[30.5403566,59.9425763,0],[30.5405554,59.9427276,0],[30.5407929,59.9428693,0],[30.5409918,59.9429658,0],[30.5412613,59.9430689,0],[30.5416336,59.9431976,0],[30.5419416,59.9433296,0],[30.5422176,59.9434456,0],[30.5424229,59.9435582,0],[30.5426475,59.9437031,0],[30.5428265,59.9438423,0],[30.5429434,59.9439997,0],[30.5430575,59.94419,0],[30.5434967,59.9450786,0],[30.5435595,59.9452188,0],[30.543608,59.9453146,0],[30.5436683,59.9454191,0],[30.5436041,59.9453492,.048814507472447755],[30.5435304,59.9452533,.11473298057136327],[30.5429523,59.9441605,.8330440452450321],[30.5429516,59.9441593,.8330562087756905],[30.5428593,59.9440219,.9250332761273836],[30.5428572,59.9440193,.9250408784395372],[30.5427144,59.9438815,1.0235148546967225],[30.5427127,59.94388,1.0235256190519408],[30.542563,59.9437652,1.1104800154845105],[30.5425612,59.943764,1.110486166365399],[30.5424063,59.9436647,1.1904351798634227],[30.5424044,59.9436635,1.1904365845195066],[30.5422154,59.9435614,1.278837005802923],[30.5422109,59.9435594,1.278837005802923],[30.5409022,59.9430546,1.8049483359506895],[30.5407878,59.943003,1.8545049267404785],[30.5406876,59.9429526,1.9000111859994133],[30.5404967,59.9428505,1.9888015615488712],[30.5403377,59.9427452,2.0741636799729735],[30.5401845,59.9426362,2.1600381695189586],[30.5400568,59.9425187,2.245761715754833],[30.5399573,59.9424096,2.321835478991991],[30.5398998,59.9423385,2.370421058238723],[30.5398618,59.9422594,2.421087786974209],[30.5398237,59.9421313,2.5],[30.5398206,59.9421223,2.5],[30.539779,59.9419284,2.917061389232159],[30.5397231,59.9415763,3.672680915741336],[30.5396463,59.9409569,5],[30.5394792,59.9409635,5],[30.539312,59.9409702,5],[30.5392412,59.9409693,5],[30.5391162,59.9409733,5],[30.5389867,59.9409775,5],[30.5389825,59.9413205,4.277516800808034],[30.5390245,59.9416424,3.5969823391178686],[30.539025,59.9416454,3.5969823391178686],[30.5391215,59.9421629,2.5],[30.5391854,59.942505,2.5],[30.5391858,59.9425067,2.5],[30.5393585,59.9432682,2.5],[30.539348,59.9435411,2.5],[30.5393008,59.9437654,2.4894165863276747],[30.5392912,59.9437973,2.4603883514121567],[30.5392805,59.9438288,2.431528443497663],[30.5392682,59.9438602,2.4027176840803803],[30.5392546,59.9438914,2.373844763481404],[30.5392394,59.9439224,2.3455323648928355],[30.539223,59.9439533,2.316239970649245],[30.5392051,59.943984,2.287375216545447],[30.5391859,59.9440144,2.2585825709085485],[30.5391652,59.9440446,2.230196400842126],[30.5391431,59.9440747,2.2008903485468823],[30.5391198,59.9441044,2.172091985945743],[30.5390951,59.9441338,2.1437525705670595],[30.5390691,59.9441629,2.1148949015867835],[30.5390417,59.9441918,2.0855952975548884],[30.5390131,59.9442204,2.056789265343468],[30.5389831,59.9442486,2.0279489127468757],[30.5389519,59.9442764,1.9991052161341392],[30.5389194,59.9443039,1.9703182101285626],[30.5388857,59.944331,1.9419140201532132],[30.5388516,59.9443571,1.9119664881597256],[30.5372923,59.9453424,.794815748538476],[30.5372524,59.9453676,.7662426452381502],[30.5372116,59.9453921,.7373850660364986],[30.5371698,59.9454162,.7085900111187922],[30.5371268,59.9454398,.6792843331723799],[30.5370828,59.9454629,.6509234819044206],[30.5370334,59.9454876,.6193668150612401],[30.5369917,59.9455076,.59324849978181],[30.5369447,59.9455291,.5639464225925616],[30.5368967,59.9455501,.535151367675119],[30.5368477,59.9455706,.506293788473061],[30.5367979,59.9455904,.47795042671558496],[30.5367471,59.9456098,.4486280797666013],[30.5366956,59.9456285,.4202825593724518],[30.5366431,59.9456466,.3914724750655801],[30.5365898,59.9456641,.3622003484453388],[30.5365357,59.9456811,.3337961584715701],[30.536481,59.9456973,.3050091524629859],[30.5364255,59.945713,.27616545584855795],[30.5363693,59.9457281,.24732510325391785],[30.5363124,59.9457424,.21851907104370055],[30.5362548,59.9457561,.1892194670119355],[30.5361967,59.9457692,.1603617980296612],[30.5361381,59.9457816,.13202238265025618],[30.5360789,59.9457933,.10322402004858366],[30.536019,59.9458044,.07391796775368643],[30.5359588,59.9458147,.04553179768786841],[30.5358981,59.9458244,.016739152050196247],[30.5358369,59.9458333,0],[30.5357718,59.9458421,0],[30.5354998,59.945875,0],[30.536197,59.945709,0],[30.5364344,59.9456414,0],[30.5366077,59.945577,0],[30.5369029,59.9454483,0],[30.5371789,59.9452841,0],[30.5374483,59.9451167,0],[30.5377178,59.9449299,0],[30.5379681,59.9447496,0],[30.5382312,59.944579,0],[30.5385586,59.9443697,0],[30.5388152,59.9441798,0],[30.5389757,59.944022,0],[30.5390847,59.9438578,0],[30.5391425,59.9437001,0],[30.5391425,59.943523,0],[30.5388558,59.942601,0],[30.5388238,59.9423853,0],[30.5387917,59.9421728,0],[30.5385651,59.9410932,0]]]},properties:{IsImmersivePublished:1,ImmersivePublicationPolygon:{id:383184818},Id:382004754,SysCode:0xf8cbfbdd6b4938,Class:{id:6316,sysCode:55101,name:"Embankment_polygon"}}},{type:"Feature",bbox:[30.5392412,59.9409693,30.5408827,59.9458966],geometry:{type:"Polygon",coordinates:[[[30.539312,59.9409702,5],[30.5393888,59.9415889,3.6751687040873304],[30.539444,59.9419361,2.9298947158508937],[30.5394885,59.9421487,2.5],[30.5395889,59.9425919,2.5],[30.5395896,59.9425947,2.5],[30.5398511,59.943525,2.5],[30.539852,59.9435278,2.5],[30.5401074,59.9442152,2.5],[30.5401075,59.9442157,2.5],[30.5402854,59.9446733,2.5],[30.5408827,59.9458966,5],[30.5408544,59.945896,0],[30.5408464,59.9458959,0],[30.540826,59.9458955,5],[30.5404942,59.9452549,2.5],[30.540323,59.9449191,2.5],[30.5399875,59.9442534,2.5],[30.539795,59.9437149,2.5],[30.5397835,59.9436678,2.5],[30.5397708,59.9436226,2.5],[30.5396918,59.9432483,2.5],[30.5395193,59.9424885,2.5],[30.5394555,59.9421472,2.5],[30.5393592,59.9416312,3.5937327396389414],[30.5392412,59.9409693,5],[30.539312,59.9409702,5]]]},properties:{IsImmersivePublished:1,ImmersivePublicationPolygon:{id:383184818},Id:382005087,SysCode:0xf8cbfbdd6b5198,Class:{id:6316,sysCode:55101,name:"Embankment_polygon"}}},{type:"Feature",bbox:[30.5358648,59.946175,30.5423314,59.9487164],geometry:{type:"Polygon",coordinates:[[[30.5374359,59.9467299,2.5],[30.536715,59.9464485,1.509],[30.5367141,59.9464482,1.509],[30.5364545,59.946353,1.16],[30.5364531,59.9463526,1.16],[30.5363105,59.9463053,.975],[30.5363095,59.946305,.975],[30.5361639,59.9462606,.79],[30.5361607,59.9462597,.79],[30.5360466,59.9462326,.653],[30.5360447,59.9462322,.653],[30.535885,59.9461887,0],[30.5358707,59.9461827,0],[30.5358648,59.946175,0],[30.535988,59.9461893,0],[30.5362142,59.9462284,0],[30.5363949,59.9462675,0],[30.5365147,59.946298,0],[30.5366383,59.9463345,0],[30.5372401,59.9465449,0],[30.5375453,59.9466507,0],[30.5378533,59.9467637,0],[30.5381956,59.9469011,0],[30.5383068,59.9469469,0],[30.5384066,59.9469927,0],[30.5384494,59.9469998,0],[30.5384947,59.9469956,0],[30.5388693,59.9472703,0],[30.5393294,59.9474544,0],[30.5401869,59.9476109,0],[30.5416404,59.9482135,0],[30.5416746,59.9482206,0],[30.5416975,59.948222,0],[30.5417174,59.9482206,0],[30.5423157,59.9486692,.9744706171815977],[30.5423314,59.9486968,.9168816399712715],[30.5423264,59.9487068,.9002421623601118],[30.5423164,59.9487146,.889587851713356],[30.542295,59.9487164,.8946978842407486],[30.542274,59.948711,1.0111554960983389],[30.5421921,59.9486554,1.1631713479575925],[30.5421901,59.9486541,1.1631713479575925],[30.5420297,59.9485586,1.4377555993338433],[30.5420273,59.9485573,1.43777068168383],[30.5418177,59.9484543,1.761469993470254],[30.5418165,59.9484537,1.7614732083341542],[30.5415769,59.9483464,2.115715866586384],[30.5412971,59.9482372,2.5],[30.5374359,59.9467299,2.5]]]},properties:{IsImmersivePublished:1,ImmersivePublicationPolygon:{id:383184818},Id:382005999,SysCode:0xf8cbfbdd6b6890,Class:{id:6316,sysCode:55101,name:"Embankment_polygon"}}},{type:"Feature",bbox:[30.5384947,59.9463103,30.5410467,59.9476109],geometry:{type:"Polygon",coordinates:[[[30.5410138,59.9469941,5],[30.5410467,59.9472444,0],[30.5410251,59.9472443,0],[30.5409098,59.9473325,0],[30.5407292,59.9474297,0],[30.5405391,59.9474911,0],[30.5401814,59.9475609,0],[30.5401587,59.9475758,0],[30.5401587,59.9475889,0],[30.5401869,59.9476109,0],[30.5393294,59.9474544,0],[30.5388693,59.9472703,0],[30.5384947,59.9469956,0],[30.5385254,59.9469833,0],[30.538534,59.9469561,0],[30.5385426,59.946846,0],[30.5385711,59.9467615,0],[30.538611,59.9466814,0],[30.5386623,59.9466085,0],[30.5387565,59.9465383,0],[30.5388534,59.946474,0],[30.5389985,59.9464112,0],[30.5391101,59.9463766,0],[30.539216,59.9463486,0],[30.5393117,59.9463314,0],[30.5395386,59.9463103,0],[30.5395359,59.9463156,.00557194225825361],[30.5395279,59.9463195,.015447235302090431],[30.5395158,59.9463224,.024422148682417166],[30.5393549,59.9463554,.20185781575547967],[30.5393521,59.9463561,.20187401203575014],[30.5392064,59.9463936,.36909057226933556],[30.539202,59.946395,.36909057226933556],[30.5390687,59.9464427,.5362815761381318],[30.5390647,59.9464444,.5362972718674042],[30.5389467,59.9465014,.7034819138327572],[30.5389432,59.9465033,.7035154661895188],[30.5388432,59.9465683,.8705899893019381],[30.5388403,59.9465705,.8706380061787037],[30.5387601,59.9466421,1.037809512441578],[30.5387578,59.9466445,1.0378232921803656],[30.538699,59.9467212,1.2050688247204198],[30.5386975,59.9467237,1.2050688247204198],[30.5386618,59.9468039,1.372311189442399],[30.5386611,59.9468065,1.3723580844958183],[30.538649,59.9468884,1.539431369374125],[30.538649,59.946891,1.539448819422617],[30.5386609,59.946973,1.7066996332139968],[30.5386616,59.9469755,1.7066996332139968],[30.538697,59.9470558,1.873988312938611],[30.5386985,59.9470583,1.8739933410024154],[30.5387569,59.947135,2.041082658806924],[30.5387592,59.9471374,2.0411149595867544],[30.5388393,59.9472091,2.2082958770311842],[30.5388422,59.9472112,2.208298594717617],[30.5389422,59.9472763,2.3754341704982975],[30.5389456,59.9472782,2.3754341704982975],[30.5390632,59.9473353,2.542556234526565],[30.5390673,59.947337,2.542581799436101],[30.5392006,59.9473849,2.7099384219573834],[30.539205,59.9473862,2.7099484737136827],[30.5393506,59.9474239,2.8771904383786775],[30.5393555,59.9474249,2.877225588057711],[30.5395104,59.9474514,3.0443299880206465],[30.539514,59.9474519,3.044372713748119],[30.5396253,59.9474647,3.16094889513478],[30.5396312,59.9474652,3.1609545951586577],[30.5397486,59.9474687,3.2810166727415337],[30.5397494,59.9474687,3.2810393681412564],[30.5399129,59.9474717,3.4480652430709453],[30.5399181,59.9474716,3.448077127494729],[30.5400809,59.9474627,3.615229161609336],[30.5400861,59.9474622,3.615293132694479],[30.5402446,59.9474415,3.782561426273421],[30.5402495,59.9474406,3.782561426273421],[30.5404003,59.9474086,3.9497540681418593],[30.540405,59.9474074,3.9497888761508677],[30.5405449,59.9473646,4.117094148279455],[30.5405492,59.9473631,4.117101890609494],[30.5406749,59.9473105,4.2841303587215345],[30.5406786,59.9473087,4.284139365417626],[30.5407881,59.9472476,4.451363772208661],[30.5407913,59.9472456,4.451371018927576],[30.5408818,59.9471771,4.618511929556251],[30.5408844,59.9471748,4.618541433086218],[30.540954,59.9471004,4.785869280572225],[30.5409558,59.9470979,4.785869280572225],[30.5410031,59.9470193,4.953011223287294],[30.5410042,59.9470167,4.953033410875547],[30.5410062,59.9470101,4.966665633818005],[30.5410138,59.9469941,5]]]},properties:{IsImmersivePublished:1,ImmersivePublicationPolygon:{id:383184818},Id:382006010,SysCode:0xf8cbfbdd6b68a0,Class:{id:6316,sysCode:55101,name:"Embankment_polygon"}}},{type:"Feature",bbox:[30.5410138,59.9469898,30.5423157,59.9486692],geometry:{type:"Polygon",coordinates:[[[30.5423157,59.9486692,.753],[30.5417174,59.9482206,0],[30.5417315,59.9482104,0],[30.5417374,59.9481949,0],[30.5417315,59.9481788,0],[30.5415773,59.9480013,0],[30.5413662,59.9477552,0],[30.5413063,59.9476651,0],[30.5410467,59.9472444,0],[30.5410138,59.9469941,4.568],[30.5410216,59.9469905,4.573],[30.5410352,59.9469898,4.57],[30.5410495,59.9469932,4.558],[30.5410592,59.9470049,4.531],[30.5411347,59.947133,4.246],[30.5415074,59.947668,3.049],[30.5418667,59.9481249,2.002],[30.5422845,59.948619,.858],[30.5423157,59.9486692,.753]]]},properties:{IsImmersivePublished:1,ImmersivePublicationPolygon:{id:383184818},Id:382006018,SysCode:0xf8cbfbdd6b6a88,Class:{id:6316,sysCode:55101,name:"Embankment_polygon"}}},{type:"Feature",bbox:[30.542153,59.9473785,30.5432751,59.9487957],geometry:{type:"Polygon",coordinates:[[[30.5432751,59.9487957,0],[30.5432542,59.9487909,.013811083354771082],[30.543238,59.9487799,.03552245511210781],[30.5430678,59.9485788,.3960641538731381],[30.5427293,59.9481467,1.1551666643992462],[30.5423529,59.9476599,2.008265977558583],[30.542153,59.9473785,2.5],[30.5423291,59.9474977,0],[30.5432434,59.9486348,0],[30.5432751,59.9487957,0]]]},properties:{IsImmersivePublished:1,ImmersivePublicationPolygon:{id:383184818},Id:382013047,SysCode:0xf8cbfbdd6bc9b0,Class:{id:6316,sysCode:55101,name:"Embankment_polygon"}}},{type:"Feature",bbox:[30.5432434,59.9463623,30.5460304,59.9487957],geometry:{type:"Polygon",coordinates:[[[30.5459947,59.9463623,0],[30.5460173,59.9463689,0],[30.5460291,59.9463766,0],[30.5460304,59.9463826,0],[30.546028,59.9463903,0],[30.5460125,59.9463987,1.9994171484221908],[30.5459755,59.9464086,2.142644113024189],[30.5457862,59.9464404,.18611246212821872],[30.5457828,59.946441,.1862082400507233],[30.545539,59.9464947,.6998734069204552],[30.5455376,59.946495,.6999748967782743],[30.5453108,59.9465508,1.1873076726190053],[30.5453065,59.946552,1.1873292152513575],[30.5450841,59.9466272,1.7046480821345444],[30.5450825,59.9466277,1.7047230803451068],[30.5448563,59.9467135,2.2517912842980796],[30.5448519,59.9467155,2.2517912842980796],[30.5447636,59.9467625,2.5],[30.5446401,59.9468282,2.5],[30.5446377,59.9468296,2.5],[30.5444709,59.9469391,2.5],[30.5444682,59.9469411,2.5],[30.5443335,59.9470602,2.5],[30.5443313,59.9470624,2.5],[30.5442031,59.9472232,2.5],[30.5440558,59.9473936,2.5],[30.5440548,59.9473948,2.5],[30.543644,59.9479904,2.5],[30.5434629,59.9482538,1.646406238935488],[30.5434618,59.9482556,1.6464044982509782],[30.5434344,59.9483152,1.4591793245091529],[30.5434342,59.948316,1.4591452442392723],[30.5433959,59.9484195,1.1366100496908411],[30.5433957,59.9484199,1.1365406352304428],[30.5433518,59.9485552,.7167596732376218],[30.5433514,59.9485574,.7167252030222366],[30.5433399,59.9487083,.25418394093974683],[30.5433399,59.9487101,.25418394093974683],[30.5433302,59.9487718,.06662189611647795],[30.5433169,59.948788,.018345252053229455],[30.543296,59.9487947,0],[30.5432751,59.9487957,0],[30.5432434,59.9486348,0],[30.5432562,59.9483794,0],[30.5432818,59.948255,0],[30.5433247,59.9481326,0],[30.543738,59.9475245,0],[30.543902,59.9474429,0],[30.5440377,59.9473533,0],[30.5441796,59.9472178,0],[30.5443317,59.9470184,0],[30.5443907,59.9468439,0],[30.5444101,59.9468453,0],[30.5444329,59.9468407,0],[30.5444572,59.9468317,0],[30.5444871,59.9468124,0],[30.5446526,59.9467222,0],[30.544798,59.9466493,0],[30.5450091,59.9465677,0],[30.5452487,59.9464933,0],[30.5454426,59.946449,0],[30.5455966,59.9464232,0],[30.5459947,59.9463623,0]]]},properties:{IsImmersivePublished:1,ImmersivePublicationPolygon:{id:383184818},Id:382013054,SysCode:0xf8cbfbdd6bc9c8,Class:{id:6316,sysCode:55101,name:"Embankment_polygon"}}},{type:"Feature",bbox:[30.542153,59.9463872,30.5443907,59.9476294],geometry:{type:"Polygon",coordinates:[[[30.5434883,59.9463872,0],[30.5436201,59.9464046,0],[30.5437646,59.9464218,0],[30.5438825,59.9464466,0],[30.5439985,59.94648,0],[30.5440993,59.9465286,0],[30.5441867,59.9465878,0],[30.5442647,59.9466498,0],[30.5443217,59.9467347,0],[30.5443541,59.9468139,0],[30.5443655,59.946832,0],[30.5443907,59.9468439,0],[30.5443317,59.9470184,0],[30.5441796,59.9472178,0],[30.5440377,59.9473533,0],[30.543902,59.9474429,0],[30.543738,59.9475245,0],[30.5437075,59.9475264,0],[30.5435687,59.9475712,0],[30.5433729,59.9476103,0],[30.5431105,59.9476284,0],[30.5428633,59.9476294,0],[30.5426504,59.9476084,0],[30.5425077,59.9475769,0],[30.5423291,59.9474977,0],[30.542153,59.9473785,2.5],[30.5421579,59.9473704,2.5],[30.5421751,59.9473666,2.5],[30.5422036,59.9473666,2.4883284547505515],[30.5422816,59.9473904,2.4362809262478504],[30.5423405,59.9474114,2.3945074458980877],[30.5423904,59.9474299,2.3573418033194993],[30.5423922,59.9474305,2.3572788892790895],[30.5424467,59.9474497,2.317499613710345],[30.5424484,59.9474502,2.3174944420745085],[30.5425049,59.9474677,2.277715509330194],[30.5425067,59.9474682,2.2776899311635206],[30.5425651,59.947484,2.237949036132406],[30.5425669,59.9474845,2.2379437919365155],[30.5426271,59.9474985,2.19816278303184],[30.542629,59.947499,2.1981612538276085],[30.5426907,59.9475113,2.158367280825946],[30.5426927,59.9475116,2.158367280825946],[30.5427558,59.9475221,2.1185709774273365],[30.5427577,59.9475224,2.118539524109463],[30.5428219,59.947531,2.078765645543465],[30.542824,59.9475313,2.078751808383117],[30.542889,59.947538,2.0389745491415723],[30.542891,59.9475382,2.0389745491415723],[30.5429566,59.947543,1.999221592200768],[30.5429587,59.9475431,1.9992008260099774],[30.5430248,59.947546,1.9594296162617],[30.543027,59.9475461,1.9594129416595765],[30.5430934,59.947547,1.9196317839130086],[30.5430953,59.947547,1.9196317839130086],[30.5431617,59.9475461,1.8798506261664407],[30.5431639,59.947546,1.8798339515643172],[30.54323,59.9475431,1.8400627418160398],[30.5432321,59.947543,1.8400419756252493],[30.5432977,59.9475382,1.800289018684445],[30.5432997,59.947538,1.800289018684445],[30.5433647,59.9475313,1.7605117594429],[30.5433668,59.947531,1.7604979222825516],[30.5434309,59.9475224,1.7207240437141331],[30.5434329,59.9475221,1.7206925903986805],[30.543496,59.9475116,1.6808962870000705],[30.543498,59.9475113,1.6808962870000705],[30.5435597,59.947499,1.6411023139984087],[30.5435616,59.9474985,1.6411007847941765],[30.5436217,59.9474845,1.6013197758889315],[30.5436236,59.947484,1.6013145316913389],[30.543682,59.9474682,1.5615736366624295],[30.5436838,59.9474677,1.5615480584935508],[30.5437403,59.9474502,1.521769125752079],[30.543742,59.9474497,1.5217639541155332],[30.5437965,59.9474305,1.4819846785467887],[30.5437983,59.9474299,1.4819217645063787],[30.5438503,59.9474092,1.4421752170259627],[30.5438518,59.9474086,1.4421752170259627],[30.5439014,59.9473864,1.4024084522448264],[30.5439029,59.9473857,1.4024056833092282],[30.5439499,59.9473621,1.3625897969743308],[30.5439513,59.9473614,1.3625870280394246],[30.5439954,59.9473365,1.322820263255723],[30.5439967,59.9473357,1.322820263255723],[30.5440379,59.9473096,1.2830737157772716],[30.5440393,59.9473087,1.2830108017355597],[30.5440774,59.9472814,1.2432315261682065],[30.5440785,59.9472806,1.2432263545302364],[30.5441133,59.9472522,1.2034474217880555],[30.5441144,59.9472513,1.2034218436191764],[30.5441459,59.947222,1.1636809485902675],[30.5441468,59.9472211,1.1636757043926746],[30.5441748,59.9471909,1.1238946954874294],[30.5441756,59.94719,1.123893166284452],[30.5442002,59.947159,1.084099193282461],[30.5442009,59.947158,1.084099193282461],[30.5442217,59.9471264,1.044302889882458],[30.5442224,59.9471254,1.0442714365686268],[30.5442396,59.9470932,1.004497557999668],[30.5442401,59.9470922,1.0044837208396753],[30.5442534,59.9470595,.9647064615997247],[30.5442538,59.9470586,.9647064615997247],[30.5442634,59.9470256,.924953504656999],[30.5442637,59.9470246,.9249327384693744],[30.5442695,59.9469914,.8851615287200896],[30.5442696,59.9469908,.8851510320403044],[30.5442737,59.9469527,.8396091169311606],[30.5442737,59.9469505,.8396091169311606],[30.5442696,59.946922,.8054633058748382],[30.5442695,59.9469216,.8054475277925621],[30.5442637,59.9468885,.7656763180430393],[30.5442634,59.9468874,.7656555518510502],[30.5442538,59.9468545,.7259025949128934],[30.5442534,59.9468535,.7259025949128934],[30.5442401,59.9468209,.6861253356723989],[30.5442396,59.9468198,.6861114985080399],[30.5442224,59.9467877,.6463376199397832],[30.5442217,59.9467867,.6463061666292442],[30.5442009,59.946755,.6065098632253281],[30.5442002,59.9467541,.6065098632253281],[30.5441756,59.9467231,.5667158902233371],[30.5441748,59.9467221,.5667143610203598],[30.5441468,59.946692,.5269333521151145],[30.5441459,59.946691,.5269281079175216],[30.5441144,59.9466617,.48718721288861255],[30.5441133,59.9466608,.4871616347197336],[30.5440785,59.9466325,.4473827019775527],[30.5440774,59.9466316,.44737753033958283],[30.5440393,59.9466043,.4075982547722292],[30.5440379,59.9466034,.4075353407344462],[30.5439967,59.9465773,.3677887932520658],[30.5439954,59.9465765,.3677887932520658],[30.5439513,59.9465517,.32802202847016293],[30.5439499,59.9465509,.32801925953720446],[30.5439029,59.9465273,.2882033731987619],[30.5439014,59.9465266,.28820060426649574],[30.5438518,59.9465045,.24843383948202735],[30.5438503,59.9465039,.24843383948202735],[30.5437983,59.9464832,.20868729200161118],[30.5437965,59.9464825,.2086243779640755],[30.543742,59.9464634,.16884510239245687],[30.5437403,59.9464628,.1688399307559112],[30.5436838,59.9464454,.1290609980144395],[30.543682,59.9464448,.12903541984556055],[30.5436236,59.946429,.08929452481665168],[30.5436217,59.9464286,.08928928061905861],[30.5435616,59.9464145,.049508271713813556],[30.5435597,59.9464141,.04950674251209053],[30.5434954,59.9463948,.006910003727798042],[30.5434897,59.9463912,.0022874133571080257],[30.5434883,59.9463872,0]]]},properties:{IsImmersivePublished:1,ImmersivePublicationPolygon:{id:383184818},Id:382013061,SysCode:0xf8cbfbdd6bcc10,Class:{id:6316,sysCode:55101,name:"Embankment_polygon"}}},{type:"Feature",bbox:[30.5434115,59.946382,30.5466055,59.9491797],geometry:{type:"Polygon",coordinates:[[[30.5466055,59.9463829,0],[30.5461702,59.9464424,0],[30.545942,59.9464753,0],[30.5457367,59.9465211,0],[30.5454857,59.9465941,0],[30.5451862,59.9467014,0],[30.5449837,59.9467944,0],[30.5447669,59.9469174,0],[30.5446015,59.947039,0],[30.5444417,59.9471993,0],[30.5443106,59.9473638,0],[30.5441907,59.9475469,0],[30.544014,59.9478216,0],[30.5437487,59.9482223,0],[30.5436688,59.948361,0],[30.5436004,59.9485528,0],[30.5435719,59.9487474,0],[30.5435491,59.9489648,0],[30.5435605,59.9490378,0],[30.5436026,59.9491797,0],[30.5435399,59.9490958,0],[30.5434771,59.948987,0],[30.543441,59.9488869,0],[30.5434115,59.9487088,.2513631775381904],[30.543423,59.9485599,.7133408204458151],[30.5434664,59.9484259,1.1372237592353736],[30.5435045,59.9483229,1.4603836295077808],[30.5435313,59.9482647,1.6493273759345934],[30.5437117,59.9480021,2.5],[30.5441219,59.9474072,2.5],[30.544269,59.9472372,2.5],[30.5442694,59.9472367,2.5],[30.5443969,59.9470769,2.5],[30.5445292,59.9469599,2.5],[30.5446934,59.9468522,2.5],[30.5448157,59.9467871,2.5],[30.5449019,59.9467413,2.2575874129849125],[30.545125,59.9466567,1.7065353514619228],[30.5453445,59.9465825,1.1920352676497237],[30.5455685,59.9465275,.7013720180381166],[30.54581,59.9464743,.18263106379562838],[30.5459001,59.9464597,0],[30.5460725,59.9464318,1.864702977579008],[30.5463337,59.9463975,.9323378488307905],[30.5464222,59.9463842,.6117591632662933],[30.5464398,59.9463824,.5498811773980664],[30.5464577,59.946382,.4894535946977402],[30.5466055,59.9463829,0]]]},properties:{IsImmersivePublished:1,ImmersivePublicationPolygon:{id:383184818},Id:382013361,SysCode:0xf8cbfbdd6bd070,Class:{id:6316,sysCode:55101,name:"Embankment_polygon"}}},{type:"Feature",bbox:[30.5349177,59.946141,30.5429197,59.9493369],geometry:{type:"Polygon",coordinates:[[[30.5349177,59.946141,0],[30.5350935,59.9461469,0],[30.5353159,59.9461593,0],[30.5355852,59.9461873,.151],[30.5358649,59.9462341,.474],[30.5360168,59.9462652,.652],[30.5361284,59.9462918,.792],[30.5362717,59.9463355,.975],[30.536413,59.9463823,1.161],[30.5366714,59.946477,1.508],[30.5373918,59.9467582,2.5],[30.5412561,59.9482667,2.5],[30.5415291,59.9483733,2.118445345743744],[30.5417682,59.9484803,1.7605486675151663],[30.5419759,59.9485824,1.4358633881532694],[30.5421342,59.9486766,1.1650035638550587],[30.5423387,59.948824,.766542331875166],[30.5423397,59.9488247,.766542331875166],[30.5429197,59.9493369,0],[30.5425802,59.9491,0],[30.5423547,59.9489596,0],[30.5422559,59.9488979,0],[30.5418544,59.9486732,0],[30.5416567,59.9485721,0],[30.5413885,59.9484528,0],[30.5410786,59.9483203,0],[30.5407782,59.9482106,0],[30.5401412,59.9479664,0],[30.539778,59.9478195,0],[30.5390593,59.9475267,0],[30.5387037,59.9473703,0],[30.5382493,59.9471757,0],[30.5376731,59.9469277,0],[30.5373746,59.9468208,0],[30.5368498,59.9466129,0],[30.5365893,59.946507,0],[30.5363573,59.9464222,0],[30.5360759,59.9463401,0],[30.535785,59.9462647,0],[30.5354712,59.9462047,0],[30.5349177,59.946141,0]]]},properties:{IsImmersivePublished:1,ImmersivePublicationPolygon:{id:383184818},Id:382014258,SysCode:0xf8cbfbdd6bdfd0,Class:{id:6316,sysCode:55101,name:"Embankment_polygon"}}},{type:"Feature",bbox:[30.5410937,59.9463933,30.5432829,59.9492647],geometry:{type:"Polygon",coordinates:[[[30.543219,59.9492647,0],[30.5426201,59.9485727,1.034],[30.5426185,59.9485703,1.039],[30.5422641,59.9481602,1.946],[30.541476,59.9470759,4.286],[30.5413959,59.9469546,4.545],[30.5411991,59.9465891,5],[30.5410937,59.9463933,5],[30.5411521,59.9463944,5],[30.5412717,59.9465834,5],[30.5416374,59.9471477,2.5],[30.5420419,59.9477169,2.01],[30.542043,59.9477185,2.01],[30.542421,59.9482072,1.155],[30.5424211,59.9482075,1.155],[30.5427611,59.9486413,.394],[30.5427623,59.9486428,.394],[30.5432052,59.9491671,0],[30.5432074,59.9491695,0],[30.5432829,59.9492493,0],[30.5432621,59.9492543,0],[30.5432414,59.9492593,0],[30.543219,59.9492647,0]]]},properties:{IsImmersivePublished:1,ImmersivePublicationPolygon:{id:383184818},Id:382583692,SysCode:0xf8cbfbdd977da8,Class:{id:6316,sysCode:55101,name:"Embankment_polygon"}}}]},e0=16,dn=16,Pi="#eeeeee",t0="#FBED7A",S$="#ccccff",M$="#cccccc",g9="#A09E9E",T$="#9AC78B",Ht=(t,e)=>["interpolate",["linear"],["zoom"],e,I$(t),e+.1,t],I$=t=>t.slice(0,7)+"00";let gm=!1;const w4={bricks:"Visiwig-Bricks",dots:"dust_texture",squares:"protruding-squares"},E$={0:"non-information",2:"straight-0",4:"right-0",6:"straight-right-0-0",8:"left-0",10:"left-straight-0-0",12:"left-right-0-0",14:"left-straight-right-0-0-0",16:"slightly_right-0",18:"straight-slightly_right-0-0",20:"slightly_right-right-0-0",24:"left-slightly_right-0-0",32:"slightly_left-0",34:"slightly_left-straight-0-0",36:"slightly_left-right-0-0",40:"left-slightly_left-0-0",48:"slightly_left-slightly_right-0-0",64:"sharply_right-0",66:"straight-sharply_right-0-0",68:"right-sharply_right-0-0",80:"slightly_right-sharply_right-0-0",96:"slightly_left-sharply_right-0-0",128:"sharply_left-0",130:"sharply_left-straight-0-0",132:"sharply_left-right-0-0",136:"sharply_left-left-0-0",144:"sharply_left-slightly_right-0-0",160:"sharply_left-slightly_left-0-0",256:"right_with_left_turn-0",258:"straight-right_with_left_turn-0-0",1024:"turnover-0",1026:"straight-turnover-0-0",1028:"right-turnover-0-0",1030:"straight-right-turnover-0-0-0",1032:"left-turnover-0-0",1034:"left-straight-turnover-0-0-0",1040:"slightly_right-turnover-0-0",1042:"straight-slightly_right-turnover-0-0-0",1056:"slightly_left-turnover-0-0",1058:"slightly_left-straight-turnover-0-0-0",1088:"sharply_right-turnover-0-0",1090:"straight-sharply_right-turnover-0-0-0",1152:"sharply_left-turnover-0-0",1154:"sharply_left-straight-turnover-0-0-0"},v9=["match",["get","db_lane_directions"]];for(const[t,e]of Object.entries(E$))v9.push([Number(t)],e);v9.push("");Ht(Pi,dn),Ht(Pi,dn),Ht(Pi,dn),Ht(M$,dn),Ht(Pi,dn),Ht(Pi,dn),Ht(Pi,dn),Ht(S$,dn),Ht(Pi,dn),Ht(Pi,dn),Ht(t0,dn),Ht(Pi,dn),Ht(t0,dn),Ht(Pi,dn);Ht("#505050",dn),Ht(Pi,dn),Ht(t0+"60",dn);Ht(Pi,dn);Ht(T$,e0),Ht(g9,e0);Ht(g9,e0);function x4(t){if(!gm){t.once("styleload",()=>{gm=!1});for(const e in w4)t.addIcon(e,{url:`${self.origin}/assets/images/${w4[e]}.svg`});gm=!0}}const A$={type:"FeatureCollection",features:[]},C$={type:"FeatureCollection",features:[{type:"Feature",properties:{db_road_part:"arch_tunnel",db_sublayer:"Roadbed_outline",db_geometry_type:"polyline"},geometry:{type:"LineString",coordinates:[[30.230585,59.9027651,-5],[30.2306134,59.9026948,-5]]}}]},P$={type:"FeatureCollection",features:[{type:"Feature",properties:{db_sublayer:"Roadbed_outline",db_road_part:"border_overpass",db_geometry_type:"polyline",endingIsCut:1,nextPointX:4312,nextPointY:31652},geometry:{type:"LineString",coordinates:[[82.93730653700112,55.00888253356723,0],[82.93718301297686,55.008829714332535,0]]}},{type:"Feature",properties:{db_sublayer:"Roadbed_outline",db_road_part:"border_overpass",db_geometry_type:"polyline",beginningIsCut:1,previousPointX:4520,previousPointY:31499},geometry:{type:"LineString",coordinates:[[82.93718301297686,55.008829714332535,0],[82.93723681952294,55.008911981959635,0]]}},{type:"Feature",properties:{db_sublayer:"Roadbed_outline",db_road_part:"border_overpass",db_geometry_type:"polyline",beginningIsCut:1,previousPointX:4759.67052257061,previousPointY:31652.92444872856},geometry:{type:"LineString",coordinates:[[82.93733301297686,55.008829714332535,0],[82.93745653700113,55.00888253356723,0]]}},{type:"Feature",properties:{db_sublayer:"Roadbed_outline",db_road_part:"border_overpass",db_geometry_type:"polyline",endingIsCut:1,nextPointX:4967,nextPointY:31499},geometry:{type:"LineString",coordinates:[[82.93738681952294,55.008911981959635,0],[82.93733301297686,55.008829714332535,0]]}}]},L$=(t,e)=>{let n,i,o,r;const s={enable:()=>{s.disable(),W.immersiveRoads=!0,Vt(t,W),a()},disable:()=>{W.immersiveOn=!1,W.immersiveRoads=!1,t.patchStyleState({immersiveRoadsOn:!1}),W.debugWideRoads&&(W.debugWideRoads=!1),Vt(t,W)},useMeters:!1,addDemoWaffle:()=>{u()},rotation:-22.5,angle:90,size:1};e.add(s,"enable"),e.add(s,"disable"),e.add(s,"addDemoWaffle"),e.add(s,"useMeters").onChange(p=>{d=p});const a=async()=>{W.style===void 0&&(t.setStyle("eb10e2c3-3c28-4b81-b74b-859c9c4cf47e",xs),await new Promise(p=>{t.once("styleload",p)})),t.patchStyleState({immersiveRoadsOn:!0}),W.immersiveOn=!0,i==null||i.destroy(),i=new mapgl._J.GeoJsonSource(t._impl,{data:b4,attributes:{demo:"embContourSource"}}),n==null||n.destroy(),n=new mapgl._J.GeoJsonSource(t._impl,{data:A$,dimensions:3}),o==null||o.destroy(),o=new mapgl._J.GeoJsonSource(t._impl,{data:P$,dimensions:3,attributes:{demo:"outline"}}),r==null||r.destroy(),r=new mapgl._J.GeoJsonSource(t._impl,{data:C$,dimensions:3}),new mapgl._J.GeoJsonSource(t._impl,{data:b4,dimensions:3}),new mapgl._J.GeoJsonSource(t._impl,{data:x$,dimensions:3})};(W.debugWideRoads||W.immersiveRoads)&&t.once("styleload",a);const l="embankments",c="#46C7A1";let d=!1;function u(){x4(t),t.removeLayer(l),t._impl.addLayer({id:l,type:"polygon",style:{color:c,textureImage:"waffle",textureSize:d?["meters-to-pixels",[5,5]]:[280,160]},filter:["==",["get","sublayer"],"PolygonMarkings_waffle",!0,!1]})}t.on("styleload",()=>{d=!0,u()});function f(p,m=[32,32]){x4(t),t.removeLayer(l),t._impl.addLayer({id:l,name:"------------ Насыпь",type:"embankment",style:{textureImage:p,textureSize:m},filter:["match",["get","sublayer"],["Embankment_polygon"],!0,!1]})}const h={waffle(){u()},bricks(){f("bricks")},dots(){f("dots",[128,128])},squares(){f("squares")},remove(){t.removeLayer(l)}},_=e.addFolder("demo embankments");_.add(h,"bricks"),_.add(h,"dots"),_.add(h,"squares"),_.add(h,"remove")},F$={type:"FeatureCollection",features:[{type:"Feature",geometry:{type:"LineString",coordinates:[[37.4853751075909,55.8877299979945],[37.48092422315992,55.886609136783335],[37.48042233219722,55.88643911636577],[37.480088658319495,55.886327722054475],[37.47963350999609,55.88614285489623],[37.479491783559176,55.88606220733554],[37.47936360744989,55.88596285174217],[37.47927562499438,55.88586459883277],[37.47924225040735,55.88571369210736],[37.47927681352491,55.88559620554183],[37.479371782898134,55.88548699944317],[37.47948997915451,55.88542206595056],[37.47961669197167,55.88537100066055],[37.47976853927226,55.88533835171493],[37.479941935646956,55.8853214879257],[37.480135718976165,55.885321741359995],[37.480329850686154,55.88534187347011],[37.480519250422766,55.885382141316924],[37.480696360116546,55.885442129252354],[37.48089408912583,55.885532486052924]]},properties:{}},{type:"Feature",geometry:{type:"LineString",coordinates:[[37.480901459837824,55.88553191970577],[37.4810940141348,55.885652520264195],[37.48125264024518,55.88578119665992],[37.481448711416625,55.885931340498125],[37.481509460568255,55.886005380343036],[37.48189790194654,55.88644392583277],[37.482052196210894,55.886629112236776],[37.482835785891744,55.88839345335244],[37.48318249258349,55.88894022649427],[37.48347062665593,55.889334441822086],[37.48393486105725,55.88997823677099],[37.48420855355646,55.890356748756055],[37.48438100924258,55.8906218276011],[37.48460513318869,55.890990073491],[37.484746635777064,55.89128677946478],[37.485059382345376,55.892061172400055],[37.485230108562625,55.89272576239497]]},properties:{db_tiers:[1]}},{type:"Feature",geometry:{type:"LineString",coordinates:[[37.47753101088765,55.8861917953693],[37.47657028580962,55.88596056390365],[37.47543570412232,55.88567775718424]]},properties:{db_tiers:[4]}},{type:"Feature",geometry:{type:"LineString",coordinates:[[37.57856806011144,55.71293328571929],[37.57884394762659,55.712717114396284],[37.578922666972666,55.71265026040434],[37.58036156503359,55.71158804073235],[37.58205319359539,55.7103575956541],[37.58341145411993,55.70935531519281],[37.58377127226828,55.70908675438538],[37.584308680129475,55.70873978360544],[37.58565100004257,55.707972546295146],[37.5864207587528,55.70759138010706],[37.58679528751776,55.70741183728571],[37.587721443205425,55.70706014487208],[37.58859600191957,55.7067241148522],[37.590520066336055,55.70616438340509]]},properties:{db_tiers:[-1]}},{type:"Feature",geometry:{type:"LineString",coordinates:[[37.57856806011144,55.71293328571929],[37.57734966326786,55.713831143221384]]},properties:{db_tiers:[1]}},{type:"Feature",geometry:{type:"LineString",coordinates:[[37.590520066336055,55.70616438340509],[37.59183249661416,55.70577798952112]]},properties:{db_tiers:[0]}},{type:"Feature",geometry:{type:"LineString",coordinates:[[82.90140562300316,55.02586152955721],[82.90008049231923,55.0253629977742]]},properties:{db_tiers:[1],db_label:"abcdifghijklmnop"}}]},k$=(t,e)=>{const n={type:"line",id:"demoRoute",filter:["match",["sourceAttr","demo"],["route"],!0,!1],style:{color:["match",["get","selected"],[!0],"#FF0000","#3388ff"],width:15},webglState:{depthTest:!0}},i={type:"labelLine",id:"demoRouteLabel",filter:["match",["sourceAttr","demo"],["route"],!0,!1],style:{textColor:"#ffffff"},webglState:{depthTest:!0}},o={type:"line",id:"demoRouteInvis",filter:["match",["sourceAttr","demo"],["route"],!0,!1],style:{color:["match",["get","selected"],[!0],"#ff000020","#3388ff20"],width:15},webglState:{depthTest:!0,depthMask:!1,cullFace:!1,depthFunc:window.WebGLRenderingContext.GREATER}};let r;const s={addRemoveFakeRoute:()=>{r?(t.removeLayer("demoRoute"),t.removeLayer("demoRouteLabel"),t.removeLayer("demoRouteInvis"),r==null||r.destroy(),r=void 0):(t.addLayer(n),t.addLayer(i),t.addLayer(o),r=new mapgl._J.GeoJsonSource(t,{data:F$,attributes:{demo:"route"}}))}};e.add(s,"addRemoveFakeRoute")};function S4(t,e){const n=ht(e.styleZoom,e.styleState,[]),[i,o,r]=Le(t,n).value.map(d=>Math.round(d)),s=i.toString(16).padStart(2,"0"),a=o.toString(16).padStart(2,"0"),l=r.toString(16).padStart(2,"0");return`#${s}${a}${l}`}const R$=(t,e)=>{const n=e.addFolder("Environment"),i=t._impl.modules,o=t._impl.state,r={horizonBlend:i.environmentManager.fogHorizonBlend,horizonLevel:i.environmentManager.fogHorizonLevel,limits:Array.from(i.environmentManager.fogLimits),fogColor:"#000000",fogAlpha:0,skyColor:"#000000",skyAlpha:0},s=n.addFolder("Fog");s.add(r,"horizonBlend",0,1).onChange(a).name("Horizon Blend"),s.add(r,"horizonLevel",-.5,.5,.01).onChange(l).name("Horizon Level"),s.add(r.limits,"0",0,5,.01).onChange(c).name("Fog Min"),s.add(r.limits,"1",0,5,.01).onChange(d).name("Fog Max"),t.on("styleload",()=>{const h=i.styleManager.getStyleLayer(o.handyStyleId,Gs);if(!h)return;const _=ht(o.styleZoom,o.styleState,[]),p=Le(h.style.skyColor,_),m=Le(h.style.fogColor,_);r.skyColor=S4(p,o),r.fogColor=S4(m,o),s.addColor(r,"fogColor").onChange(u).name("Fog Color"),s.add(r,"fogAlpha",0,255,1).onChange(u).name("Fog Alpha"),n.addColor(r,"skyColor").onChange(f).name("Sky Color"),n.add(r,"skyAlpha",0,255,1).onChange(f).name("Sky Alpha")});function a(h){t.setEnvironmentParams({horizonBlend:Number(h)})}function l(h){t.setEnvironmentParams({horizonLevel:Number(h)})}function c(h){t.setEnvironmentParams({min:Number(h)})}function d(h){t.setEnvironmentParams({max:Number(h)})}function u(){const h=Os(r.fogColor);h.value[3]=r.fogAlpha,t.setEnvironmentParams({fogColor:h})}function f(){const h=Os(r.skyColor);h.value[3]=r.skyAlpha,t.setEnvironmentParams({skyColor:h})}};function z$(t){if(!(typeof window>"u")){var e=document.createElement("style");return e.setAttribute("type","text/css"),e.innerHTML=t,document.head.appendChild(e),t}}function Ca(t,e){var n=t.__state.conversionName.toString(),i=Math.round(t.r),o=Math.round(t.g),r=Math.round(t.b),s=t.a,a=Math.round(t.h),l=t.s.toFixed(1),c=t.v.toFixed(1);if(e||n==="THREE_CHAR_HEX"||n==="SIX_CHAR_HEX"){for(var d=t.hex.toString(16);d.length<6;)d="0"+d;return"#"+d}else{if(n==="CSS_RGB")return"rgb("+i+","+o+","+r+")";if(n==="CSS_RGBA")return"rgba("+i+","+o+","+r+","+s+")";if(n==="HEX")return"0x"+t.hex.toString(16);if(n==="RGB_ARRAY")return"["+i+","+o+","+r+"]";if(n==="RGBA_ARRAY")return"["+i+","+o+","+r+","+s+"]";if(n==="RGB_OBJ")return"{r:"+i+",g:"+o+",b:"+r+"}";if(n==="RGBA_OBJ")return"{r:"+i+",g:"+o+",b:"+r+",a:"+s+"}";if(n==="HSV_OBJ")return"{h:"+a+",s:"+l+",v:"+c+"}";if(n==="HSVA_OBJ")return"{h:"+a+",s:"+l+",v:"+c+",a:"+s+"}"}return"unknown format"}var M4=Array.prototype.forEach,Ql=Array.prototype.slice,$={BREAK:{},extend:function(e){return this.each(Ql.call(arguments,1),function(n){var i=this.isObject(n)?Object.keys(n):[];i.forEach((function(o){this.isUndefined(n[o])||(e[o]=n[o])}).bind(this))},this),e},defaults:function(e){return this.each(Ql.call(arguments,1),function(n){var i=this.isObject(n)?Object.keys(n):[];i.forEach((function(o){this.isUndefined(e[o])&&(e[o]=n[o])}).bind(this))},this),e},compose:function(){var e=Ql.call(arguments);return function(){for(var n=Ql.call(arguments),i=e.length-1;i>=0;i--)n=[e[i].apply(this,n)];return n[0]}},each:function(e,n,i){if(e){if(M4&&e.forEach&&e.forEach===M4)e.forEach(n,i);else if(e.length===e.length+0){var o=void 0,r=void 0;for(o=0,r=e.length;o<r;o++)if(o in e&&n.call(i,e[o],o)===this.BREAK)return}else for(var s in e)if(n.call(i,e[s],s)===this.BREAK)return}},defer:function(e){setTimeout(e,0)},debounce:function(e,n,i){var o=void 0;return function(){var r=this,s=arguments;function a(){o=null,i||e.apply(r,s)}var l=i||!o;clearTimeout(o),o=setTimeout(a,n),l&&e.apply(r,s)}},toArray:function(e){return e.toArray?e.toArray():Ql.call(e)},isUndefined:function(e){return e===void 0},isNull:function(e){return e===null},isNaN:function(t){function e(n){return t.apply(this,arguments)}return e.toString=function(){return t.toString()},e}(function(t){return isNaN(t)}),isArray:Array.isArray||function(t){return t.constructor===Array},isObject:function(e){return e===Object(e)},isNumber:function(e){return e===e+0},isString:function(e){return e===e+""},isBoolean:function(e){return e===!1||e===!0},isFunction:function(e){return e instanceof Function}},B$=[{litmus:$.isString,conversions:{THREE_CHAR_HEX:{read:function(e){var n=e.match(/^#([A-F0-9])([A-F0-9])([A-F0-9])$/i);return n===null?!1:{space:"HEX",hex:parseInt("0x"+n[1].toString()+n[1].toString()+n[2].toString()+n[2].toString()+n[3].toString()+n[3].toString(),0)}},write:Ca},SIX_CHAR_HEX:{read:function(e){var n=e.match(/^#([A-F0-9]{6})$/i);return n===null?!1:{space:"HEX",hex:parseInt("0x"+n[1].toString(),0)}},write:Ca},CSS_RGB:{read:function(e){var n=e.match(/^rgb\(\s*(\S+)\s*,\s*(\S+)\s*,\s*(\S+)\s*\)/);return n===null?!1:{space:"RGB",r:parseFloat(n[1]),g:parseFloat(n[2]),b:parseFloat(n[3])}},write:Ca},CSS_RGBA:{read:function(e){var n=e.match(/^rgba\(\s*(\S+)\s*,\s*(\S+)\s*,\s*(\S+)\s*,\s*(\S+)\s*\)/);return n===null?!1:{space:"RGB",r:parseFloat(n[1]),g:parseFloat(n[2]),b:parseFloat(n[3]),a:parseFloat(n[4])}},write:Ca}}},{litmus:$.isNumber,conversions:{HEX:{read:function(e){return{space:"HEX",hex:e,conversionName:"HEX"}},write:function(e){return e.hex}}}},{litmus:$.isArray,conversions:{RGB_ARRAY:{read:function(e){return e.length!==3?!1:{space:"RGB",r:e[0],g:e[1],b:e[2]}},write:function(e){return[e.r,e.g,e.b]}},RGBA_ARRAY:{read:function(e){return e.length!==4?!1:{space:"RGB",r:e[0],g:e[1],b:e[2],a:e[3]}},write:function(e){return[e.r,e.g,e.b,e.a]}}}},{litmus:$.isObject,conversions:{RGBA_OBJ:{read:function(e){return $.isNumber(e.r)&&$.isNumber(e.g)&&$.isNumber(e.b)&&$.isNumber(e.a)?{space:"RGB",r:e.r,g:e.g,b:e.b,a:e.a}:!1},write:function(e){return{r:e.r,g:e.g,b:e.b,a:e.a}}},RGB_OBJ:{read:function(e){return $.isNumber(e.r)&&$.isNumber(e.g)&&$.isNumber(e.b)?{space:"RGB",r:e.r,g:e.g,b:e.b}:!1},write:function(e){return{r:e.r,g:e.g,b:e.b}}},HSVA_OBJ:{read:function(e){return $.isNumber(e.h)&&$.isNumber(e.s)&&$.isNumber(e.v)&&$.isNumber(e.a)?{space:"HSV",h:e.h,s:e.s,v:e.v,a:e.a}:!1},write:function(e){return{h:e.h,s:e.s,v:e.v,a:e.a}}},HSV_OBJ:{read:function(e){return $.isNumber(e.h)&&$.isNumber(e.s)&&$.isNumber(e.v)?{space:"HSV",h:e.h,s:e.s,v:e.v}:!1},write:function(e){return{h:e.h,s:e.s,v:e.v}}}}}],ec=void 0,Vu=void 0,n0=function(){Vu=!1;var e=arguments.length>1?$.toArray(arguments):arguments[0];return $.each(B$,function(n){if(n.litmus(e))return $.each(n.conversions,function(i,o){if(ec=i.read(e),Vu===!1&&ec!==!1)return Vu=ec,ec.conversionName=o,ec.conversion=i,$.BREAK}),$.BREAK}),Vu},T4=void 0,Yf={hsv_to_rgb:function(e,n,i){var o=Math.floor(e/60)%6,r=e/60-Math.floor(e/60),s=i*(1-n),a=i*(1-r*n),l=i*(1-(1-r)*n),c=[[i,l,s],[a,i,s],[s,i,l],[s,a,i],[l,s,i],[i,s,a]][o];return{r:c[0]*255,g:c[1]*255,b:c[2]*255}},rgb_to_hsv:function(e,n,i){var o=Math.min(e,n,i),r=Math.max(e,n,i),s=r-o,a=void 0,l=void 0;if(r!==0)l=s/r;else return{h:NaN,s:0,v:0};return e===r?a=(n-i)/s:n===r?a=2+(i-e)/s:a=4+(e-n)/s,a/=6,a<0&&(a+=1),{h:a*360,s:l,v:r/255}},rgb_to_hex:function(e,n,i){var o=this.hex_with_component(0,2,e);return o=this.hex_with_component(o,1,n),o=this.hex_with_component(o,0,i),o},component_from_hex:function(e,n){return e>>n*8&255},hex_with_component:function(e,n,i){return i<<(T4=n*8)|e&~(255<<T4)}},O$=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},vo=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},yo=function(){function t(e,n){for(var i=0;i<n.length;i++){var o=n[i];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),Qr=function t(e,n,i){e===null&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,n);if(o===void 0){var r=Object.getPrototypeOf(e);return r===null?void 0:t(r,n,i)}else{if("value"in o)return o.value;var s=o.get;return s===void 0?void 0:s.call(i)}},ns=function(t,e){if(typeof e!="function"&&e!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)},is=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e&&(typeof e=="object"||typeof e=="function")?e:t},hn=function(){function t(){if(vo(this,t),this.__state=n0.apply(this,arguments),this.__state===!1)throw new Error("Failed to interpret color arguments");this.__state.a=this.__state.a||1}return yo(t,[{key:"toString",value:function(){return Ca(this)}},{key:"toHexString",value:function(){return Ca(this,!0)}},{key:"toOriginal",value:function(){return this.__state.conversion.write(this)}}]),t}();function Lg(t,e,n){Object.defineProperty(t,e,{get:function(){return this.__state.space==="RGB"?this.__state[e]:(hn.recalculateRGB(this,e,n),this.__state[e])},set:function(o){this.__state.space!=="RGB"&&(hn.recalculateRGB(this,e,n),this.__state.space="RGB"),this.__state[e]=o}})}function Fg(t,e){Object.defineProperty(t,e,{get:function(){return this.__state.space==="HSV"?this.__state[e]:(hn.recalculateHSV(this),this.__state[e])},set:function(i){this.__state.space!=="HSV"&&(hn.recalculateHSV(this),this.__state.space="HSV"),this.__state[e]=i}})}hn.recalculateRGB=function(t,e,n){if(t.__state.space==="HEX")t.__state[e]=Yf.component_from_hex(t.__state.hex,n);else if(t.__state.space==="HSV")$.extend(t.__state,Yf.hsv_to_rgb(t.__state.h,t.__state.s,t.__state.v));else throw new Error("Corrupted color state")};hn.recalculateHSV=function(t){var e=Yf.rgb_to_hsv(t.r,t.g,t.b);$.extend(t.__state,{s:e.s,v:e.v}),$.isNaN(e.h)?$.isUndefined(t.__state.h)&&(t.__state.h=0):t.__state.h=e.h};hn.COMPONENTS=["r","g","b","h","s","v","hex","a"];Lg(hn.prototype,"r",2);Lg(hn.prototype,"g",1);Lg(hn.prototype,"b",0);Fg(hn.prototype,"h");Fg(hn.prototype,"s");Fg(hn.prototype,"v");Object.defineProperty(hn.prototype,"a",{get:function(){return this.__state.a},set:function(e){this.__state.a=e}});Object.defineProperty(hn.prototype,"hex",{get:function(){return this.__state.space!=="HEX"&&(this.__state.hex=Yf.rgb_to_hex(this.r,this.g,this.b),this.__state.space="HEX"),this.__state.hex},set:function(e){this.__state.space="HEX",this.__state.hex=e}});var Zs=function(){function t(e,n){vo(this,t),this.initialValue=e[n],this.domElement=document.createElement("div"),this.object=e,this.property=n,this.__onChange=void 0,this.__onFinishChange=void 0}return yo(t,[{key:"onChange",value:function(n){return this.__onChange=n,this}},{key:"onFinishChange",value:function(n){return this.__onFinishChange=n,this}},{key:"setValue",value:function(n){return this.object[this.property]=n,this.__onChange&&this.__onChange.call(this,n),this.updateDisplay(),this}},{key:"getValue",value:function(){return this.object[this.property]}},{key:"updateDisplay",value:function(){return this}},{key:"isModified",value:function(){return this.initialValue!==this.getValue()}}]),t}(),D$={HTMLEvents:["change"],MouseEvents:["click","mousemove","mousedown","mouseup","mouseover"],KeyboardEvents:["keydown"]},y9={};$.each(D$,function(t,e){$.each(t,function(n){y9[n]=e})});var N$=/(\d+(\.\d+)?)px/;function Eo(t){if(t==="0"||$.isUndefined(t))return 0;var e=t.match(N$);return $.isNull(e)?0:parseFloat(e[1])}var H={makeSelectable:function(e,n){e===void 0||e.style===void 0||(e.onselectstart=n?function(){return!1}:function(){},e.style.MozUserSelect=n?"auto":"none",e.style.KhtmlUserSelect=n?"auto":"none",e.unselectable=n?"on":"off")},makeFullscreen:function(e,n,i){var o=i,r=n;$.isUndefined(r)&&(r=!0),$.isUndefined(o)&&(o=!0),e.style.position="absolute",r&&(e.style.left=0,e.style.right=0),o&&(e.style.top=0,e.style.bottom=0)},fakeEvent:function(e,n,i,o){var r=i||{},s=y9[n];if(!s)throw new Error("Event type "+n+" not supported.");var a=document.createEvent(s);switch(s){case"MouseEvents":{var l=r.x||r.clientX||0,c=r.y||r.clientY||0;a.initMouseEvent(n,r.bubbles||!1,r.cancelable||!0,window,r.clickCount||1,0,0,l,c,!1,!1,!1,!1,0,null);break}case"KeyboardEvents":{var d=a.initKeyboardEvent||a.initKeyEvent;$.defaults(r,{cancelable:!0,ctrlKey:!1,altKey:!1,shiftKey:!1,metaKey:!1,keyCode:void 0,charCode:void 0}),d(n,r.bubbles||!1,r.cancelable,window,r.ctrlKey,r.altKey,r.shiftKey,r.metaKey,r.keyCode,r.charCode);break}default:{a.initEvent(n,r.bubbles||!1,r.cancelable||!0);break}}$.defaults(a,o),e.dispatchEvent(a)},bind:function(e,n,i,o){var r=o||!1;return e.addEventListener?e.addEventListener(n,i,r):e.attachEvent&&e.attachEvent("on"+n,i),H},unbind:function(e,n,i,o){var r=o||!1;return e.removeEventListener?e.removeEventListener(n,i,r):e.detachEvent&&e.detachEvent("on"+n,i),H},addClass:function(e,n){if(e.className===void 0)e.className=n;else if(e.className!==n){var i=e.className.split(/ +/);i.indexOf(n)===-1&&(i.push(n),e.className=i.join(" ").replace(/^\s+/,"").replace(/\s+$/,""))}return H},removeClass:function(e,n){if(n)if(e.className===n)e.removeAttribute("class");else{var i=e.className.split(/ +/),o=i.indexOf(n);o!==-1&&(i.splice(o,1),e.className=i.join(" "))}else e.className=void 0;return H},hasClass:function(e,n){return new RegExp("(?:^|\\s+)"+n+"(?:\\s+|$)").test(e.className)||!1},getWidth:function(e){var n=getComputedStyle(e);return Eo(n["border-left-width"])+Eo(n["border-right-width"])+Eo(n["padding-left"])+Eo(n["padding-right"])+Eo(n.width)},getHeight:function(e){var n=getComputedStyle(e);return Eo(n["border-top-width"])+Eo(n["border-bottom-width"])+Eo(n["padding-top"])+Eo(n["padding-bottom"])+Eo(n.height)},getOffset:function(e){var n=e,i={left:0,top:0};if(n.offsetParent)do i.left+=n.offsetLeft,i.top+=n.offsetTop,n=n.offsetParent;while(n);return i},isActive:function(e){return e===document.activeElement&&(e.type||e.href)}},b9=function(t){ns(e,t);function e(n,i){vo(this,e);var o=is(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,n,i)),r=o;o.__prev=o.getValue(),o.__checkbox=document.createElement("input"),o.__checkbox.setAttribute("type","checkbox");function s(){r.setValue(!r.__prev)}return H.bind(o.__checkbox,"change",s,!1),o.domElement.appendChild(o.__checkbox),o.updateDisplay(),o}return yo(e,[{key:"setValue",value:function(i){var o=Qr(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"setValue",this).call(this,i);return this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue()),this.__prev=this.getValue(),o}},{key:"updateDisplay",value:function(){return this.getValue()===!0?(this.__checkbox.setAttribute("checked","checked"),this.__checkbox.checked=!0,this.__prev=!0):(this.__checkbox.checked=!1,this.__prev=!1),Qr(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"updateDisplay",this).call(this)}}]),e}(Zs),U$=function(t){ns(e,t);function e(n,i,o){vo(this,e);var r=is(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,n,i)),s=o,a=r;if(r.__select=document.createElement("select"),$.isArray(s)){var l={};$.each(s,function(c){l[c]=c}),s=l}return $.each(s,function(c,d){var u=document.createElement("option");u.innerHTML=d,u.setAttribute("value",c),a.__select.appendChild(u)}),r.updateDisplay(),H.bind(r.__select,"change",function(){var c=this.options[this.selectedIndex].value;a.setValue(c)}),r.domElement.appendChild(r.__select),r}return yo(e,[{key:"setValue",value:function(i){var o=Qr(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"setValue",this).call(this,i);return this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue()),o}},{key:"updateDisplay",value:function(){return H.isActive(this.__select)?this:(this.__select.value=this.getValue(),Qr(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"updateDisplay",this).call(this))}}]),e}(Zs),G$=function(t){ns(e,t);function e(n,i){vo(this,e);var o=is(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,n,i)),r=o;function s(){r.setValue(r.__input.value)}function a(){r.__onFinishChange&&r.__onFinishChange.call(r,r.getValue())}return o.__input=document.createElement("input"),o.__input.setAttribute("type","text"),H.bind(o.__input,"keyup",s),H.bind(o.__input,"change",s),H.bind(o.__input,"blur",a),H.bind(o.__input,"keydown",function(l){l.keyCode===13&&this.blur()}),o.updateDisplay(),o.domElement.appendChild(o.__input),o}return yo(e,[{key:"updateDisplay",value:function(){return H.isActive(this.__input)||(this.__input.value=this.getValue()),Qr(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"updateDisplay",this).call(this)}}]),e}(Zs);function I4(t){var e=t.toString();return e.indexOf(".")>-1?e.length-e.indexOf(".")-1:0}var w9=function(t){ns(e,t);function e(n,i,o){vo(this,e);var r=is(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,n,i)),s=o||{};return r.__min=s.min,r.__max=s.max,r.__step=s.step,$.isUndefined(r.__step)?r.initialValue===0?r.__impliedStep=1:r.__impliedStep=Math.pow(10,Math.floor(Math.log(Math.abs(r.initialValue))/Math.LN10))/10:r.__impliedStep=r.__step,r.__precision=I4(r.__impliedStep),r}return yo(e,[{key:"setValue",value:function(i){var o=i;return this.__min!==void 0&&o<this.__min?o=this.__min:this.__max!==void 0&&o>this.__max&&(o=this.__max),this.__step!==void 0&&o%this.__step!==0&&(o=Math.round(o/this.__step)*this.__step),Qr(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"setValue",this).call(this,o)}},{key:"min",value:function(i){return this.__min=i,this}},{key:"max",value:function(i){return this.__max=i,this}},{key:"step",value:function(i){return this.__step=i,this.__impliedStep=i,this.__precision=I4(i),this}}]),e}(Zs);function H$(t,e){var n=Math.pow(10,e);return Math.round(t*n)/n}var qf=function(t){ns(e,t);function e(n,i,o){vo(this,e);var r=is(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,n,i,o));r.__truncationSuspended=!1;var s=r,a=void 0;function l(){var _=parseFloat(s.__input.value);$.isNaN(_)||s.setValue(_)}function c(){s.__onFinishChange&&s.__onFinishChange.call(s,s.getValue())}function d(){c()}function u(_){var p=a-_.clientY;s.setValue(s.getValue()+p*s.__impliedStep),a=_.clientY}function f(){H.unbind(window,"mousemove",u),H.unbind(window,"mouseup",f),c()}function h(_){H.bind(window,"mousemove",u),H.bind(window,"mouseup",f),a=_.clientY}return r.__input=document.createElement("input"),r.__input.setAttribute("type","text"),H.bind(r.__input,"change",l),H.bind(r.__input,"blur",d),H.bind(r.__input,"mousedown",h),H.bind(r.__input,"keydown",function(_){_.keyCode===13&&(s.__truncationSuspended=!0,this.blur(),s.__truncationSuspended=!1,c())}),r.updateDisplay(),r.domElement.appendChild(r.__input),r}return yo(e,[{key:"updateDisplay",value:function(){return this.__input.value=this.__truncationSuspended?this.getValue():H$(this.getValue(),this.__precision),Qr(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"updateDisplay",this).call(this)}}]),e}(w9);function E4(t,e,n,i,o){return i+(o-i)*((t-e)/(n-e))}var i0=function(t){ns(e,t);function e(n,i,o,r,s){vo(this,e);var a=is(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,n,i,{min:o,max:r,step:s})),l=a;a.__background=document.createElement("div"),a.__foreground=document.createElement("div"),H.bind(a.__background,"mousedown",c),H.bind(a.__background,"touchstart",f),H.addClass(a.__background,"slider"),H.addClass(a.__foreground,"slider-fg");function c(p){document.activeElement.blur(),H.bind(window,"mousemove",d),H.bind(window,"mouseup",u),d(p)}function d(p){p.preventDefault();var m=l.__background.getBoundingClientRect();return l.setValue(E4(p.clientX,m.left,m.right,l.__min,l.__max)),!1}function u(){H.unbind(window,"mousemove",d),H.unbind(window,"mouseup",u),l.__onFinishChange&&l.__onFinishChange.call(l,l.getValue())}function f(p){p.touches.length===1&&(H.bind(window,"touchmove",h),H.bind(window,"touchend",_),h(p))}function h(p){var m=p.touches[0].clientX,g=l.__background.getBoundingClientRect();l.setValue(E4(m,g.left,g.right,l.__min,l.__max))}function _(){H.unbind(window,"touchmove",h),H.unbind(window,"touchend",_),l.__onFinishChange&&l.__onFinishChange.call(l,l.getValue())}return a.updateDisplay(),a.__background.appendChild(a.__foreground),a.domElement.appendChild(a.__background),a}return yo(e,[{key:"updateDisplay",value:function(){var i=(this.getValue()-this.__min)/(this.__max-this.__min);return this.__foreground.style.width=i*100+"%",Qr(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"updateDisplay",this).call(this)}}]),e}(w9),x9=function(t){ns(e,t);function e(n,i,o){vo(this,e);var r=is(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,n,i)),s=r;return r.__button=document.createElement("div"),r.__button.innerHTML=o===void 0?"Fire":o,H.bind(r.__button,"click",function(a){return a.preventDefault(),s.fire(),!1}),H.addClass(r.__button,"button"),r.domElement.appendChild(r.__button),r}return yo(e,[{key:"fire",value:function(){this.__onChange&&this.__onChange.call(this),this.getValue().call(this.object),this.__onFinishChange&&this.__onFinishChange.call(this,this.getValue())}}]),e}(Zs),o0=function(t){ns(e,t);function e(n,i){vo(this,e);var o=is(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,n,i));o.__color=new hn(o.getValue()),o.__temp=new hn(0);var r=o;o.domElement=document.createElement("div"),H.makeSelectable(o.domElement,!1),o.__selector=document.createElement("div"),o.__selector.className="selector",o.__saturation_field=document.createElement("div"),o.__saturation_field.className="saturation-field",o.__field_knob=document.createElement("div"),o.__field_knob.className="field-knob",o.__field_knob_border="2px solid ",o.__hue_knob=document.createElement("div"),o.__hue_knob.className="hue-knob",o.__hue_field=document.createElement("div"),o.__hue_field.className="hue-field",o.__input=document.createElement("input"),o.__input.type="text",o.__input_textShadow="0 1px 1px ",H.bind(o.__input,"keydown",function(p){p.keyCode===13&&u.call(this)}),H.bind(o.__input,"blur",u),H.bind(o.__selector,"mousedown",function(){H.addClass(this,"drag").bind(window,"mouseup",function(){H.removeClass(r.__selector,"drag")})}),H.bind(o.__selector,"touchstart",function(){H.addClass(this,"drag").bind(window,"touchend",function(){H.removeClass(r.__selector,"drag")})});var s=document.createElement("div");$.extend(o.__selector.style,{width:"122px",height:"102px",padding:"3px",backgroundColor:"#222",boxShadow:"0px 1px 3px rgba(0,0,0,0.3)"}),$.extend(o.__field_knob.style,{position:"absolute",width:"12px",height:"12px",border:o.__field_knob_border+(o.__color.v<.5?"#fff":"#000"),boxShadow:"0px 1px 3px rgba(0,0,0,0.5)",borderRadius:"12px",zIndex:1}),$.extend(o.__hue_knob.style,{position:"absolute",width:"15px",height:"2px",borderRight:"4px solid #fff",zIndex:1}),$.extend(o.__saturation_field.style,{width:"100px",height:"100px",border:"1px solid #555",marginRight:"3px",display:"inline-block",cursor:"pointer"}),$.extend(s.style,{width:"100%",height:"100%",background:"none"}),A4(s,"top","rgba(0,0,0,0)","#000"),$.extend(o.__hue_field.style,{width:"15px",height:"100px",border:"1px solid #555",cursor:"ns-resize",position:"absolute",top:"3px",right:"3px"}),j$(o.__hue_field),$.extend(o.__input.style,{outline:"none",textAlign:"center",color:"#fff",border:0,fontWeight:"bold",textShadow:o.__input_textShadow+"rgba(0,0,0,0.7)"}),H.bind(o.__saturation_field,"mousedown",a),H.bind(o.__saturation_field,"touchstart",a),H.bind(o.__field_knob,"mousedown",a),H.bind(o.__field_knob,"touchstart",a),H.bind(o.__hue_field,"mousedown",l),H.bind(o.__hue_field,"touchstart",l);function a(p){h(p),H.bind(window,"mousemove",h),H.bind(window,"touchmove",h),H.bind(window,"mouseup",c),H.bind(window,"touchend",c)}function l(p){_(p),H.bind(window,"mousemove",_),H.bind(window,"touchmove",_),H.bind(window,"mouseup",d),H.bind(window,"touchend",d)}function c(){H.unbind(window,"mousemove",h),H.unbind(window,"touchmove",h),H.unbind(window,"mouseup",c),H.unbind(window,"touchend",c),f()}function d(){H.unbind(window,"mousemove",_),H.unbind(window,"touchmove",_),H.unbind(window,"mouseup",d),H.unbind(window,"touchend",d),f()}function u(){var p=n0(this.value);p!==!1?(r.__color.__state=p,r.setValue(r.__color.toOriginal())):this.value=r.__color.toString()}function f(){r.__onFinishChange&&r.__onFinishChange.call(r,r.__color.toOriginal())}o.__saturation_field.appendChild(s),o.__selector.appendChild(o.__field_knob),o.__selector.appendChild(o.__saturation_field),o.__selector.appendChild(o.__hue_field),o.__hue_field.appendChild(o.__hue_knob),o.domElement.appendChild(o.__input),o.domElement.appendChild(o.__selector),o.updateDisplay();function h(p){p.type.indexOf("touch")===-1&&p.preventDefault();var m=r.__saturation_field.getBoundingClientRect(),g=p.touches&&p.touches[0]||p,y=g.clientX,b=g.clientY,v=(y-m.left)/(m.right-m.left),T=1-(b-m.top)/(m.bottom-m.top);return T>1?T=1:T<0&&(T=0),v>1?v=1:v<0&&(v=0),r.__color.v=T,r.__color.s=v,r.setValue(r.__color.toOriginal()),!1}function _(p){p.type.indexOf("touch")===-1&&p.preventDefault();var m=r.__hue_field.getBoundingClientRect(),g=p.touches&&p.touches[0]||p,y=g.clientY,b=1-(y-m.top)/(m.bottom-m.top);return b>1?b=1:b<0&&(b=0),r.__color.h=b*360,r.setValue(r.__color.toOriginal()),!1}return o}return yo(e,[{key:"updateDisplay",value:function(){var i=n0(this.getValue());if(i!==!1){var o=!1;$.each(hn.COMPONENTS,function(a){if(!$.isUndefined(i[a])&&!$.isUndefined(this.__color.__state[a])&&i[a]!==this.__color.__state[a])return o=!0,{}},this),o&&$.extend(this.__color.__state,i)}$.extend(this.__temp.__state,this.__color.__state),this.__temp.a=1;var r=this.__color.v<.5||this.__color.s>.5?255:0,s=255-r;$.extend(this.__field_knob.style,{marginLeft:100*this.__color.s-7+"px",marginTop:100*(1-this.__color.v)-7+"px",backgroundColor:this.__temp.toHexString(),border:this.__field_knob_border+"rgb("+r+","+r+","+r+")"}),this.__hue_knob.style.marginTop=(1-this.__color.h/360)*100+"px",this.__temp.s=1,this.__temp.v=1,A4(this.__saturation_field,"left","#fff",this.__temp.toHexString()),this.__input.value=this.__color.toString(),$.extend(this.__input.style,{backgroundColor:this.__color.toHexString(),color:"rgb("+r+","+r+","+r+")",textShadow:this.__input_textShadow+"rgba("+s+","+s+","+s+",.7)"})}}]),e}(Zs),V$=["-moz-","-o-","-webkit-","-ms-",""];function A4(t,e,n,i){t.style.background="",$.each(V$,function(o){t.style.cssText+="background: "+o+"linear-gradient("+e+", "+n+" 0%, "+i+" 100%); "})}function j$(t){t.style.background="",t.style.cssText+="background: -moz-linear-gradient(top,  #ff0000 0%, #ff00ff 17%, #0000ff 34%, #00ffff 50%, #00ff00 67%, #ffff00 84%, #ff0000 100%);",t.style.cssText+="background: -webkit-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",t.style.cssText+="background: -o-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",t.style.cssText+="background: -ms-linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);",t.style.cssText+="background: linear-gradient(top,  #ff0000 0%,#ff00ff 17%,#0000ff 34%,#00ffff 50%,#00ff00 67%,#ffff00 84%,#ff0000 100%);"}var $$={load:function(e,n){var i=n||document,o=i.createElement("link");o.type="text/css",o.rel="stylesheet",o.href=e,i.getElementsByTagName("head")[0].appendChild(o)},inject:function(e,n){var i=n||document,o=document.createElement("style");o.type="text/css",o.innerHTML=e;var r=i.getElementsByTagName("head")[0];try{r.appendChild(o)}catch{}}},W$=`<div id="dg-save" class="dg dialogue">

  Here's the new load parameter for your <code>GUI</code>'s constructor:

  <textarea id="dg-new-constructor"></textarea>

  <div id="dg-save-locally">

    <input id="dg-local-storage" type="checkbox"/> Automatically save
    values to <code>localStorage</code> on exit.

    <div id="dg-local-explain">The values saved to <code>localStorage</code> will
      override those passed to <code>dat.GUI</code>'s constructor. This makes it
      easier to work incrementally, but <code>localStorage</code> is fragile,
      and your friends may not see the same values you do.

    </div>

  </div>

</div>`,Z$=function(e,n){var i=e[n];return $.isArray(arguments[2])||$.isObject(arguments[2])?new U$(e,n,arguments[2]):$.isNumber(i)?$.isNumber(arguments[2])&&$.isNumber(arguments[3])?$.isNumber(arguments[4])?new i0(e,n,arguments[2],arguments[3],arguments[4]):new i0(e,n,arguments[2],arguments[3]):$.isNumber(arguments[4])?new qf(e,n,{min:arguments[2],max:arguments[3],step:arguments[4]}):new qf(e,n,{min:arguments[2],max:arguments[3]}):$.isString(i)?new G$(e,n):$.isFunction(i)?new x9(e,n,""):$.isBoolean(i)?new b9(e,n):null};function X$(t){setTimeout(t,1e3/60)}var Y$=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||X$,q$=function(){function t(){vo(this,t),this.backgroundElement=document.createElement("div"),$.extend(this.backgroundElement.style,{backgroundColor:"rgba(0,0,0,0.8)",top:0,left:0,display:"none",zIndex:"1000",opacity:0,WebkitTransition:"opacity 0.2s linear",transition:"opacity 0.2s linear"}),H.makeFullscreen(this.backgroundElement),this.backgroundElement.style.position="fixed",this.domElement=document.createElement("div"),$.extend(this.domElement.style,{position:"fixed",display:"none",zIndex:"1001",opacity:0,WebkitTransition:"-webkit-transform 0.2s ease-out, opacity 0.2s linear",transition:"transform 0.2s ease-out, opacity 0.2s linear"}),document.body.appendChild(this.backgroundElement),document.body.appendChild(this.domElement);var e=this;H.bind(this.backgroundElement,"click",function(){e.hide()})}return yo(t,[{key:"show",value:function(){var n=this;this.backgroundElement.style.display="block",this.domElement.style.display="block",this.domElement.style.opacity=0,this.domElement.style.webkitTransform="scale(1.1)",this.layout(),$.defer(function(){n.backgroundElement.style.opacity=1,n.domElement.style.opacity=1,n.domElement.style.webkitTransform="scale(1)"})}},{key:"hide",value:function(){var n=this,i=function o(){n.domElement.style.display="none",n.backgroundElement.style.display="none",H.unbind(n.domElement,"webkitTransitionEnd",o),H.unbind(n.domElement,"transitionend",o),H.unbind(n.domElement,"oTransitionEnd",o)};H.bind(this.domElement,"webkitTransitionEnd",i),H.bind(this.domElement,"transitionend",i),H.bind(this.domElement,"oTransitionEnd",i),this.backgroundElement.style.opacity=0,this.domElement.style.opacity=0,this.domElement.style.webkitTransform="scale(1.1)"}},{key:"layout",value:function(){this.domElement.style.left=window.innerWidth/2-H.getWidth(this.domElement)/2+"px",this.domElement.style.top=window.innerHeight/2-H.getHeight(this.domElement)/2+"px"}}]),t}(),K$=z$(`.dg ul{list-style:none;margin:0;padding:0;width:100%;clear:both}.dg.ac{position:fixed;top:0;left:0;right:0;height:0;z-index:0}.dg:not(.ac) .main{overflow:hidden}.dg.main{-webkit-transition:opacity .1s linear;-o-transition:opacity .1s linear;-moz-transition:opacity .1s linear;transition:opacity .1s linear}.dg.main.taller-than-window{overflow-y:auto}.dg.main.taller-than-window .close-button{opacity:1;margin-top:-1px;border-top:1px solid #2c2c2c}.dg.main ul.closed .close-button{opacity:1 !important}.dg.main:hover .close-button,.dg.main .close-button.drag{opacity:1}.dg.main .close-button{-webkit-transition:opacity .1s linear;-o-transition:opacity .1s linear;-moz-transition:opacity .1s linear;transition:opacity .1s linear;border:0;line-height:19px;height:20px;cursor:pointer;text-align:center;background-color:#000}.dg.main .close-button.close-top{position:relative}.dg.main .close-button.close-bottom{position:absolute}.dg.main .close-button:hover{background-color:#111}.dg.a{float:right;margin-right:15px;overflow-y:visible}.dg.a.has-save>ul.close-top{margin-top:0}.dg.a.has-save>ul.close-bottom{margin-top:27px}.dg.a.has-save>ul.closed{margin-top:0}.dg.a .save-row{top:0;z-index:1002}.dg.a .save-row.close-top{position:relative}.dg.a .save-row.close-bottom{position:fixed}.dg li{-webkit-transition:height .1s ease-out;-o-transition:height .1s ease-out;-moz-transition:height .1s ease-out;transition:height .1s ease-out;-webkit-transition:overflow .1s linear;-o-transition:overflow .1s linear;-moz-transition:overflow .1s linear;transition:overflow .1s linear}.dg li:not(.folder){cursor:auto;height:27px;line-height:27px;padding:0 4px 0 5px}.dg li.folder{padding:0;border-left:4px solid rgba(0,0,0,0)}.dg li.title{cursor:pointer;margin-left:-4px}.dg .closed li:not(.title),.dg .closed ul li,.dg .closed ul li>*{height:0;overflow:hidden;border:0}.dg .cr{clear:both;padding-left:3px;height:27px;overflow:hidden}.dg .property-name{cursor:default;float:left;clear:left;width:40%;overflow:hidden;text-overflow:ellipsis}.dg .cr.function .property-name{width:100%}.dg .c{float:left;width:60%;position:relative}.dg .c input[type=text]{border:0;margin-top:4px;padding:3px;width:100%;float:right}.dg .has-slider input[type=text]{width:30%;margin-left:0}.dg .slider{float:left;width:66%;margin-left:-5px;margin-right:0;height:19px;margin-top:4px}.dg .slider-fg{height:100%}.dg .c input[type=checkbox]{margin-top:7px}.dg .c select{margin-top:5px}.dg .cr.function,.dg .cr.function .property-name,.dg .cr.function *,.dg .cr.boolean,.dg .cr.boolean *{cursor:pointer}.dg .cr.color{overflow:visible}.dg .selector{display:none;position:absolute;margin-left:-9px;margin-top:23px;z-index:10}.dg .c:hover .selector,.dg .selector.drag{display:block}.dg li.save-row{padding:0}.dg li.save-row .button{display:inline-block;padding:0px 6px}.dg.dialogue{background-color:#222;width:460px;padding:15px;font-size:13px;line-height:15px}#dg-new-constructor{padding:10px;color:#222;font-family:Monaco, monospace;font-size:10px;border:0;resize:none;box-shadow:inset 1px 1px 1px #888;word-wrap:break-word;margin:12px 0;display:block;width:440px;overflow-y:scroll;height:100px;position:relative}#dg-local-explain{display:none;font-size:11px;line-height:17px;border-radius:3px;background-color:#333;padding:8px;margin-top:10px}#dg-local-explain code{font-size:10px}#dat-gui-save-locally{display:none}.dg{color:#eee;font:11px 'Lucida Grande', sans-serif;text-shadow:0 -1px 0 #111}.dg.main::-webkit-scrollbar{width:5px;background:#1a1a1a}.dg.main::-webkit-scrollbar-corner{height:0;display:none}.dg.main::-webkit-scrollbar-thumb{border-radius:5px;background:#676767}.dg li:not(.folder){background:#1a1a1a;border-bottom:1px solid #2c2c2c}.dg li.save-row{line-height:25px;background:#dad5cb;border:0}.dg li.save-row select{margin-left:5px;width:108px}.dg li.save-row .button{margin-left:5px;margin-top:1px;border-radius:2px;font-size:9px;line-height:7px;padding:4px 4px 5px 4px;background:#c5bdad;color:#fff;text-shadow:0 1px 0 #b0a58f;box-shadow:0 -1px 0 #b0a58f;cursor:pointer}.dg li.save-row .button.gears{background:#c5bdad url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAsAAAANCAYAAAB/9ZQ7AAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAQJJREFUeNpiYKAU/P//PwGIC/ApCABiBSAW+I8AClAcgKxQ4T9hoMAEUrxx2QSGN6+egDX+/vWT4e7N82AMYoPAx/evwWoYoSYbACX2s7KxCxzcsezDh3evFoDEBYTEEqycggWAzA9AuUSQQgeYPa9fPv6/YWm/Acx5IPb7ty/fw+QZblw67vDs8R0YHyQhgObx+yAJkBqmG5dPPDh1aPOGR/eugW0G4vlIoTIfyFcA+QekhhHJhPdQxbiAIguMBTQZrPD7108M6roWYDFQiIAAv6Aow/1bFwXgis+f2LUAynwoIaNcz8XNx3Dl7MEJUDGQpx9gtQ8YCueB+D26OECAAQDadt7e46D42QAAAABJRU5ErkJggg==) 2px 1px no-repeat;height:7px;width:8px}.dg li.save-row .button:hover{background-color:#bab19e;box-shadow:0 -1px 0 #b0a58f}.dg li.folder{border-bottom:0}.dg li.title{padding-left:16px;background:#000 url(data:image/gif;base64,R0lGODlhBQAFAJEAAP////Pz8////////yH5BAEAAAIALAAAAAAFAAUAAAIIlI+hKgFxoCgAOw==) 6px 10px no-repeat;cursor:pointer;border-bottom:1px solid rgba(255,255,255,0.2)}.dg .closed li.title{background-image:url(data:image/gif;base64,R0lGODlhBQAFAJEAAP////Pz8////////yH5BAEAAAIALAAAAAAFAAUAAAIIlGIWqMCbWAEAOw==)}.dg .cr.boolean{border-left:3px solid #806787}.dg .cr.color{border-left:3px solid}.dg .cr.function{border-left:3px solid #e61d5f}.dg .cr.number{border-left:3px solid #2FA1D6}.dg .cr.number input[type=text]{color:#2FA1D6}.dg .cr.string{border-left:3px solid #1ed36f}.dg .cr.string input[type=text]{color:#1ed36f}.dg .cr.function:hover,.dg .cr.boolean:hover{background:#111}.dg .c input[type=text]{background:#303030;outline:none}.dg .c input[type=text]:hover{background:#3c3c3c}.dg .c input[type=text]:focus{background:#494949;color:#fff}.dg .c .slider{background:#303030;cursor:ew-resize}.dg .c .slider-fg{background:#2FA1D6;max-width:100%}.dg .c .slider:hover{background:#3c3c3c}.dg .c .slider:hover .slider-fg{background:#44abda}
`);$$.inject(K$);var C4="dg",P4=72,L4=20,Hc="Default",fc=function(){try{return!!window.localStorage}catch{return!1}}(),xc=void 0,F4=!0,wa=void 0,vm=!1,S9=[],wt=function t(e){var n=this,i=e||{};this.domElement=document.createElement("div"),this.__ul=document.createElement("ul"),this.domElement.appendChild(this.__ul),H.addClass(this.domElement,C4),this.__folders={},this.__controllers=[],this.__rememberedObjects=[],this.__rememberedObjectIndecesToControllers=[],this.__listening=[],i=$.defaults(i,{closeOnTop:!1,autoPlace:!0,width:t.DEFAULT_WIDTH}),i=$.defaults(i,{resizable:i.autoPlace,hideable:i.autoPlace}),$.isUndefined(i.load)?i.load={preset:Hc}:i.preset&&(i.load.preset=i.preset),$.isUndefined(i.parent)&&i.hideable&&S9.push(this),i.resizable=$.isUndefined(i.parent)&&i.resizable,i.autoPlace&&$.isUndefined(i.scrollable)&&(i.scrollable=!0);var o=fc&&localStorage.getItem(xa(this,"isLocal"))==="true",r=void 0,s=void 0;if(Object.defineProperties(this,{parent:{get:function(){return i.parent}},scrollable:{get:function(){return i.scrollable}},autoPlace:{get:function(){return i.autoPlace}},closeOnTop:{get:function(){return i.closeOnTop}},preset:{get:function(){return n.parent?n.getRoot().preset:i.load.preset},set:function(f){n.parent?n.getRoot().preset=f:i.load.preset=f,tW(this),n.revert()}},width:{get:function(){return i.width},set:function(f){i.width=f,a0(n,f)}},name:{get:function(){return i.name},set:function(f){i.name=f,s&&(s.innerHTML=i.name)}},closed:{get:function(){return i.closed},set:function(f){i.closed=f,i.closed?H.addClass(n.__ul,t.CLASS_CLOSED):H.removeClass(n.__ul,t.CLASS_CLOSED),this.onResize(),n.__closeButton&&(n.__closeButton.innerHTML=f?t.TEXT_OPEN:t.TEXT_CLOSED)}},load:{get:function(){return i.load}},useLocalStorage:{get:function(){return o},set:function(f){fc&&(o=f,f?H.bind(window,"unload",r):H.unbind(window,"unload",r),localStorage.setItem(xa(n,"isLocal"),f))}}}),$.isUndefined(i.parent)){if(this.closed=i.closed||!1,H.addClass(this.domElement,t.CLASS_MAIN),H.makeSelectable(this.domElement,!1),fc&&o){n.useLocalStorage=!0;var a=localStorage.getItem(xa(this,"gui"));a&&(i.load=JSON.parse(a))}this.__closeButton=document.createElement("div"),this.__closeButton.innerHTML=t.TEXT_CLOSED,H.addClass(this.__closeButton,t.CLASS_CLOSE_BUTTON),i.closeOnTop?(H.addClass(this.__closeButton,t.CLASS_CLOSE_TOP),this.domElement.insertBefore(this.__closeButton,this.domElement.childNodes[0])):(H.addClass(this.__closeButton,t.CLASS_CLOSE_BOTTOM),this.domElement.appendChild(this.__closeButton)),H.bind(this.__closeButton,"click",function(){n.closed=!n.closed})}else{i.closed===void 0&&(i.closed=!0);var l=document.createTextNode(i.name);H.addClass(l,"controller-name"),s=kg(n,l);var c=function(f){return f.preventDefault(),n.closed=!n.closed,!1};H.addClass(this.__ul,t.CLASS_CLOSED),H.addClass(s,"title"),H.bind(s,"click",c),i.closed||(this.closed=!1)}i.autoPlace&&($.isUndefined(i.parent)&&(F4&&(wa=document.createElement("div"),H.addClass(wa,C4),H.addClass(wa,t.CLASS_AUTO_PLACE_CONTAINER),document.body.appendChild(wa),F4=!1),wa.appendChild(this.domElement),H.addClass(this.domElement,t.CLASS_AUTO_PLACE)),this.parent||a0(n,i.width)),this.__resizeHandler=function(){n.onResizeDebounced()},H.bind(window,"resize",this.__resizeHandler),H.bind(this.__ul,"webkitTransitionEnd",this.__resizeHandler),H.bind(this.__ul,"transitionend",this.__resizeHandler),H.bind(this.__ul,"oTransitionEnd",this.__resizeHandler),this.onResize(),i.resizable&&eW(this),r=function(){fc&&localStorage.getItem(xa(n,"isLocal"))==="true"&&localStorage.setItem(xa(n,"gui"),JSON.stringify(n.getSaveObject()))},this.saveToLocalStorageIfPossible=r;function d(){var u=n.getRoot();u.width+=1,$.defer(function(){u.width-=1})}i.parent||d()};wt.toggleHide=function(){vm=!vm,$.each(S9,function(t){t.domElement.style.display=vm?"none":""})};wt.CLASS_AUTO_PLACE="a";wt.CLASS_AUTO_PLACE_CONTAINER="ac";wt.CLASS_MAIN="main";wt.CLASS_CONTROLLER_ROW="cr";wt.CLASS_TOO_TALL="taller-than-window";wt.CLASS_CLOSED="closed";wt.CLASS_CLOSE_BUTTON="close-button";wt.CLASS_CLOSE_TOP="close-top";wt.CLASS_CLOSE_BOTTOM="close-bottom";wt.CLASS_DRAG="drag";wt.DEFAULT_WIDTH=245;wt.TEXT_CLOSED="Close Controls";wt.TEXT_OPEN="Open Controls";wt._keydownHandler=function(t){document.activeElement.type!=="text"&&(t.which===P4||t.keyCode===P4)&&wt.toggleHide()};H.bind(window,"keydown",wt._keydownHandler,!1);$.extend(wt.prototype,{add:function(e,n){return Sc(this,e,n,{factoryArgs:Array.prototype.slice.call(arguments,2)})},addColor:function(e,n){return Sc(this,e,n,{color:!0})},remove:function(e){this.__ul.removeChild(e.__li),this.__controllers.splice(this.__controllers.indexOf(e),1);var n=this;$.defer(function(){n.onResize()})},destroy:function(){if(this.parent)throw new Error("Only the root GUI should be removed with .destroy(). For subfolders, use gui.removeFolder(folder) instead.");this.autoPlace&&wa.removeChild(this.domElement);var e=this;$.each(this.__folders,function(n){e.removeFolder(n)}),H.unbind(window,"keydown",wt._keydownHandler,!1),k4(this)},addFolder:function(e){if(this.__folders[e]!==void 0)throw new Error('You already have a folder in this GUI by the name "'+e+'"');var n={name:e,parent:this};n.autoPlace=this.autoPlace,this.load&&this.load.folders&&this.load.folders[e]&&(n.closed=this.load.folders[e].closed,n.load=this.load.folders[e]);var i=new wt(n);this.__folders[e]=i;var o=kg(this,i.domElement);return H.addClass(o,"folder"),i},removeFolder:function(e){this.__ul.removeChild(e.domElement.parentElement),delete this.__folders[e.name],this.load&&this.load.folders&&this.load.folders[e.name]&&delete this.load.folders[e.name],k4(e);var n=this;$.each(e.__folders,function(i){e.removeFolder(i)}),$.defer(function(){n.onResize()})},open:function(){this.closed=!1},close:function(){this.closed=!0},hide:function(){this.domElement.style.display="none"},show:function(){this.domElement.style.display=""},onResize:function(){var e=this.getRoot();if(e.scrollable){var n=H.getOffset(e.__ul).top,i=0;$.each(e.__ul.childNodes,function(o){e.autoPlace&&o===e.__save_row||(i+=H.getHeight(o))}),window.innerHeight-n-L4<i?(H.addClass(e.domElement,wt.CLASS_TOO_TALL),e.__ul.style.height=window.innerHeight-n-L4+"px"):(H.removeClass(e.domElement,wt.CLASS_TOO_TALL),e.__ul.style.height="auto")}e.__resize_handle&&$.defer(function(){e.__resize_handle.style.height=e.__ul.offsetHeight+"px"}),e.__closeButton&&(e.__closeButton.style.width=e.width+"px")},onResizeDebounced:$.debounce(function(){this.onResize()},50),remember:function(){if($.isUndefined(xc)&&(xc=new q$,xc.domElement.innerHTML=W$),this.parent)throw new Error("You can only call remember on a top level GUI.");var e=this;$.each(Array.prototype.slice.call(arguments),function(n){e.__rememberedObjects.length===0&&Q$(e),e.__rememberedObjects.indexOf(n)===-1&&e.__rememberedObjects.push(n)}),this.autoPlace&&a0(this,this.width)},getRoot:function(){for(var e=this;e.parent;)e=e.parent;return e},getSaveObject:function(){var e=this.load;return e.closed=this.closed,this.__rememberedObjects.length>0&&(e.preset=this.preset,e.remembered||(e.remembered={}),e.remembered[this.preset]=ju(this)),e.folders={},$.each(this.__folders,function(n,i){e.folders[i]=n.getSaveObject()}),e},save:function(){this.load.remembered||(this.load.remembered={}),this.load.remembered[this.preset]=ju(this),r0(this,!1),this.saveToLocalStorageIfPossible()},saveAs:function(e){this.load.remembered||(this.load.remembered={},this.load.remembered[Hc]=ju(this,!0)),this.load.remembered[e]=ju(this),this.preset=e,s0(this,e,!0),this.saveToLocalStorageIfPossible()},revert:function(e){$.each(this.__controllers,function(n){this.getRoot().load.remembered?M9(e||this.getRoot(),n):n.setValue(n.initialValue),n.__onFinishChange&&n.__onFinishChange.call(n,n.getValue())},this),$.each(this.__folders,function(n){n.revert(n)}),e||r0(this.getRoot(),!1)},listen:function(e){var n=this.__listening.length===0;this.__listening.push(e),n&&T9(this.__listening)},updateDisplay:function(){$.each(this.__controllers,function(e){e.updateDisplay()}),$.each(this.__folders,function(e){e.updateDisplay()})}});function kg(t,e,n){var i=document.createElement("li");return e&&i.appendChild(e),n?t.__ul.insertBefore(i,n):t.__ul.appendChild(i),t.onResize(),i}function k4(t){H.unbind(window,"resize",t.__resizeHandler),t.saveToLocalStorageIfPossible&&H.unbind(window,"unload",t.saveToLocalStorageIfPossible)}function r0(t,e){var n=t.__preset_select[t.__preset_select.selectedIndex];e?n.innerHTML=n.value+"*":n.innerHTML=n.value}function J$(t,e,n){if(n.__li=e,n.__gui=t,$.extend(n,{options:function(s){if(arguments.length>1){var a=n.__li.nextElementSibling;return n.remove(),Sc(t,n.object,n.property,{before:a,factoryArgs:[$.toArray(arguments)]})}if($.isArray(s)||$.isObject(s)){var l=n.__li.nextElementSibling;return n.remove(),Sc(t,n.object,n.property,{before:l,factoryArgs:[s]})}},name:function(s){return n.__li.firstElementChild.firstElementChild.innerHTML=s,n},listen:function(){return n.__gui.listen(n),n},remove:function(){return n.__gui.remove(n),n}}),n instanceof i0){var i=new qf(n.object,n.property,{min:n.__min,max:n.__max,step:n.__step});$.each(["updateDisplay","onChange","onFinishChange","step","min","max"],function(r){var s=n[r],a=i[r];n[r]=i[r]=function(){var l=Array.prototype.slice.call(arguments);return a.apply(i,l),s.apply(n,l)}}),H.addClass(e,"has-slider"),n.domElement.insertBefore(i.domElement,n.domElement.firstElementChild)}else if(n instanceof qf){var o=function(s){if($.isNumber(n.__min)&&$.isNumber(n.__max)){var a=n.__li.firstElementChild.firstElementChild.innerHTML,l=n.__gui.__listening.indexOf(n)>-1;n.remove();var c=Sc(t,n.object,n.property,{before:n.__li.nextElementSibling,factoryArgs:[n.__min,n.__max,n.__step]});return c.name(a),l&&c.listen(),c}return s};n.min=$.compose(o,n.min),n.max=$.compose(o,n.max)}else n instanceof b9?(H.bind(e,"click",function(){H.fakeEvent(n.__checkbox,"click")}),H.bind(n.__checkbox,"click",function(r){r.stopPropagation()})):n instanceof x9?(H.bind(e,"click",function(){H.fakeEvent(n.__button,"click")}),H.bind(e,"mouseover",function(){H.addClass(n.__button,"hover")}),H.bind(e,"mouseout",function(){H.removeClass(n.__button,"hover")})):n instanceof o0&&(H.addClass(e,"color"),n.updateDisplay=$.compose(function(r){return e.style.borderLeftColor=n.__color.toString(),r},n.updateDisplay),n.updateDisplay());n.setValue=$.compose(function(r){return t.getRoot().__preset_select&&n.isModified()&&r0(t.getRoot(),!0),r},n.setValue)}function M9(t,e){var n=t.getRoot(),i=n.__rememberedObjects.indexOf(e.object);if(i!==-1){var o=n.__rememberedObjectIndecesToControllers[i];if(o===void 0&&(o={},n.__rememberedObjectIndecesToControllers[i]=o),o[e.property]=e,n.load&&n.load.remembered){var r=n.load.remembered,s=void 0;if(r[t.preset])s=r[t.preset];else if(r[Hc])s=r[Hc];else return;if(s[i]&&s[i][e.property]!==void 0){var a=s[i][e.property];e.initialValue=a,e.setValue(a)}}}}function Sc(t,e,n,i){if(e[n]===void 0)throw new Error('Object "'+e+'" has no property "'+n+'"');var o=void 0;if(i.color)o=new o0(e,n);else{var r=[e,n].concat(i.factoryArgs);o=Z$.apply(t,r)}i.before instanceof Zs&&(i.before=i.before.__li),M9(t,o),H.addClass(o.domElement,"c");var s=document.createElement("span");H.addClass(s,"property-name"),s.innerHTML=o.property;var a=document.createElement("div");a.appendChild(s),a.appendChild(o.domElement);var l=kg(t,a,i.before);return H.addClass(l,wt.CLASS_CONTROLLER_ROW),o instanceof o0?H.addClass(l,"color"):H.addClass(l,O$(o.getValue())),J$(t,l,o),t.__controllers.push(o),o}function xa(t,e){return document.location.href+"."+e}function s0(t,e,n){var i=document.createElement("option");i.innerHTML=e,i.value=e,t.__preset_select.appendChild(i),n&&(t.__preset_select.selectedIndex=t.__preset_select.length-1)}function R4(t,e){e.style.display=t.useLocalStorage?"block":"none"}function Q$(t){var e=t.__save_row=document.createElement("li");H.addClass(t.domElement,"has-save"),t.__ul.insertBefore(e,t.__ul.firstChild),H.addClass(e,"save-row");var n=document.createElement("span");n.innerHTML="&nbsp;",H.addClass(n,"button gears");var i=document.createElement("span");i.innerHTML="Save",H.addClass(i,"button"),H.addClass(i,"save");var o=document.createElement("span");o.innerHTML="New",H.addClass(o,"button"),H.addClass(o,"save-as");var r=document.createElement("span");r.innerHTML="Revert",H.addClass(r,"button"),H.addClass(r,"revert");var s=t.__preset_select=document.createElement("select");if(t.load&&t.load.remembered?$.each(t.load.remembered,function(u,f){s0(t,f,f===t.preset)}):s0(t,Hc,!1),H.bind(s,"change",function(){for(var u=0;u<t.__preset_select.length;u++)t.__preset_select[u].innerHTML=t.__preset_select[u].value;t.preset=this.value}),e.appendChild(s),e.appendChild(n),e.appendChild(i),e.appendChild(o),e.appendChild(r),fc){var a=document.getElementById("dg-local-explain"),l=document.getElementById("dg-local-storage"),c=document.getElementById("dg-save-locally");c.style.display="block",localStorage.getItem(xa(t,"isLocal"))==="true"&&l.setAttribute("checked","checked"),R4(t,a),H.bind(l,"change",function(){t.useLocalStorage=!t.useLocalStorage,R4(t,a)})}var d=document.getElementById("dg-new-constructor");H.bind(d,"keydown",function(u){u.metaKey&&(u.which===67||u.keyCode===67)&&xc.hide()}),H.bind(n,"click",function(){d.innerHTML=JSON.stringify(t.getSaveObject(),void 0,2),xc.show(),d.focus(),d.select()}),H.bind(i,"click",function(){t.save()}),H.bind(o,"click",function(){var u=prompt("Enter a new preset name.");u&&t.saveAs(u)}),H.bind(r,"click",function(){t.revert()})}function eW(t){var e=void 0;t.__resize_handle=document.createElement("div"),$.extend(t.__resize_handle.style,{width:"6px",marginLeft:"-3px",height:"200px",cursor:"ew-resize",position:"absolute"});function n(r){return r.preventDefault(),t.width+=e-r.clientX,t.onResize(),e=r.clientX,!1}function i(){H.removeClass(t.__closeButton,wt.CLASS_DRAG),H.unbind(window,"mousemove",n),H.unbind(window,"mouseup",i)}function o(r){return r.preventDefault(),e=r.clientX,H.addClass(t.__closeButton,wt.CLASS_DRAG),H.bind(window,"mousemove",n),H.bind(window,"mouseup",i),!1}H.bind(t.__resize_handle,"mousedown",o),H.bind(t.__closeButton,"mousedown",o),t.domElement.insertBefore(t.__resize_handle,t.domElement.firstElementChild)}function a0(t,e){t.domElement.style.width=e+"px",t.__save_row&&t.autoPlace&&(t.__save_row.style.width=e+"px"),t.__closeButton&&(t.__closeButton.style.width=e+"px")}function ju(t,e){var n={};return $.each(t.__rememberedObjects,function(i,o){var r={},s=t.__rememberedObjectIndecesToControllers[o];$.each(s,function(a,l){r[l]=e?a.initialValue:a.getValue()}),n[o]=r}),n}function tW(t){for(var e=0;e<t.__preset_select.length;e++)t.__preset_select[e].value===t.preset&&(t.__preset_select.selectedIndex=e)}function T9(t){t.length!==0&&Y$.call(window,function(){T9(t)}),$.each(t,function(e){e.updateDisplay()})}var nW=wt;const at=new nW({width:280,closed:!0});at.useLocalStorage=!0;at.domElement.parentElement&&(at.domElement.parentElement.style.zIndex="10",at.domElement.style.float="left",at.domElement.style.marginLeft="15px");function iW(t,e){const n=e.addFolder("Labeling"),i={dead:!1,alive:!1,unused:!1,commercialDead:!1,commercialAlive:!1};Object.keys(i).forEach(u=>n.add(i,u).onChange(()=>t.showLabelsDebug(i)));const o={commercialPoiRandomSeed:W.commercialPoiRandomSeed!==void 0?W.commercialPoiRandomSeed:0};let r;const s="RANDOM_POINT",a={addMarkers:()=>{a.clearMarkers();const u={type:"FeatureCollection",features:[]},f=t.getSize().slice(),h=16,_=f.map(p=>Math.trunc(.25*p));for(let p=_[0];p<=f[0]-_[0];p+=h)for(let m=_[1];m<f[1]-_[1];m+=h){const g=Math.trunc(Math.random()*h),y=t.unproject([p-g,m-g]);u.features.push({type:"Feature",geometry:{type:"Point",coordinates:y},properties:{}})}r=new mapgl.GeoJsonSource(t,{data:u,attributes:{demo:"randomMarkers"}}),t.addLayer({id:s,filter:["match",["sourceAttr","demo"],["randomMarkers"],!0,!1],type:"point",style:{iconImage:"avtobus",iconWidth:16}})},clearMarkers:()=>{r==null||r.destroy(),r=void 0,t.removeLayer(s)}};n.add(o,"commercialPoiRandomSeed",0,1e5,.1).onChange(()=>{W.commercialPoiRandomSeed=o.commercialPoiRandomSeed,document.location.assign(bn(t,W))}),n.add(a,"addMarkers"),n.add(a,"clearMarkers");const l=n.addFolder("Commercial Margins"),c=l.addFolder("Default"),d=l.addFolder("City");c.add(mapgl._J.config.labeling.commercialMargins.default,"leftRight",0,1e3,1).onChange(()=>t._impl.refresh()),c.add(mapgl._J.config.labeling.commercialMargins.default,"topBottom",0,1e3,1).onChange(()=>t._impl.refresh()),d.add(mapgl._J.config.labeling.commercialMargins.city,"leftRight",0,1e3,1).onChange(()=>t._impl.refresh()),d.add(mapgl._J.config.labeling.commercialMargins.city,"topBottom",0,1e3,1).onChange(()=>t._impl.refresh())}var uf={exports:{}},oW=uf.exports,z4;function rW(){return z4||(z4=1,function(t,e){(function(n,i){t.exports=i()})(oW,function(){var n=function(){function i(h){return s.appendChild(h.dom),h}function o(h){for(var _=0;_<s.children.length;_++)s.children[_].style.display=_===h?"block":"none";r=h}var r=0,s=document.createElement("div");s.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",s.addEventListener("click",function(h){h.preventDefault(),o(++r%s.children.length)},!1);var a=(performance||Date).now(),l=a,c=0,d=i(new n.Panel("FPS","#0ff","#002")),u=i(new n.Panel("MS","#0f0","#020"));if(self.performance&&self.performance.memory)var f=i(new n.Panel("MB","#f08","#201"));return o(0),{REVISION:16,dom:s,addPanel:i,showPanel:o,begin:function(){a=(performance||Date).now()},end:function(){c++;var h=(performance||Date).now();if(u.update(h-a,200),h>l+1e3&&(d.update(1e3*c/(h-l),100),l=h,c=0,f)){var _=performance.memory;f.update(_.usedJSHeapSize/1048576,_.jsHeapSizeLimit/1048576)}return h},update:function(){a=this.end()},domElement:s,setMode:o}};return n.Panel=function(i,o,r){var s=1/0,a=0,l=Math.round,c=l(window.devicePixelRatio||1),d=80*c,u=48*c,f=3*c,h=2*c,_=3*c,p=15*c,m=74*c,g=30*c,y=document.createElement("canvas");y.width=d,y.height=u,y.style.cssText="width:80px;height:48px";var b=y.getContext("2d");return b.font="bold "+9*c+"px Helvetica,Arial,sans-serif",b.textBaseline="top",b.fillStyle=r,b.fillRect(0,0,d,u),b.fillStyle=o,b.fillText(i,f,h),b.fillRect(_,p,m,g),b.fillStyle=r,b.globalAlpha=.9,b.fillRect(_,p,m,g),{dom:y,update:function(v,T){s=Math.min(s,v),a=Math.max(a,v),b.fillStyle=r,b.globalAlpha=1,b.fillRect(0,0,d,p),b.fillStyle=o,b.fillText(l(v)+" "+i+" ("+l(s)+"-"+l(a)+")",f,h),b.drawImage(y,_+c,p,m-c,g,_,p,m-c,g),b.fillRect(_+m-c,p,c,g),b.fillStyle=r,b.globalAlpha=.9,b.fillRect(_+m-c,p,c,l((1-v/T)*g))}}},n})}(uf)),uf.exports}var sW=rW();const Pr=ll(sW);function aW(t){const e=new Pr;e.domElement.style.position="absolute",e.domElement.style.top="",e.domElement.style.left="0",e.domElement.style.bottom="0",document.body.appendChild(e.domElement),t._impl.on("framestart",()=>e.begin()),t._impl.on("frameend",()=>e.end());const n=e.addPanel(Pr.Panel("tiles","#7fc97f","#000")),i=e.addPanel(Pr.Panel("dynTiles","#c9b756","#000")),o=e.addPanel(Pr.Panel("globeTiles","#c9b756","#000")),r=e.addPanel(Pr.Panel("vtReq","#4c70a6","#000")),s=e.addPanel(Pr.Panel("draws","#beaed4","#000")),a=e.addPanel(Pr.Panel("vtcs","#fdc086","#000")),l=e.addPanel(Pr.Panel("trgls","#fd0999","#000"));let c=40,d=50,u=50,f=1e3,h=1e6,_=1e6,p=50;t._impl.state.collectStats=!0,t._impl.on("stats",m=>{const{tileCount:g,dynamicTileCount:y,globeTileCount:b,drawCount:v,vertexCount:T,triangleCount:x,foundVisibleTilesCount:I}=m;c=g>c?c*1.5:c,d=y>d?d*1.5:d,u=b>u?u*1.5:u,f=v>f?f*1.5:f,h=T>h?h*1.5:h,_=x>_?_*1.5:_,p=I>p?p*1.5:p,n.update(g,c),r.update(I,p),i.update(y,d),t._impl.state.globeMode?(o.update(b,u),o.dom.style.disable="block"):o.dom.style.disable="none",s.update(v,f),a.update(T,h),l.update(x,_)})}function lW(t){const e=new mapgl.Control(t,"",{position:"topRight"});t.on("move",n),n();function n(){e.getContainer().innerHTML=` <div class="stylezoom">
            ${t.getStyleZoom().toFixed(2)}
        </div>`}}function cW(t,e){const n=Object.keys(b3),i=e.addFolder("Animation"),o=i.addFolder("Tiles");o.add(mapgl._J.config.tileAnimation,"time",1,2e3),o.add(mapgl._J.config.tileAnimation,"type",n);const r=i.addFolder("Building");r.add(mapgl._J.config.buildingAnimation,"duration",1,2e3),r.add(mapgl._J.config.buildingAnimation,"easing",n);const s=i.addFolder("Entrance");s.add(mapgl._J.config.entranceAnimation,"bounceTime",1,6e3),s.add(mapgl._J.config.entranceAnimation,"bounceType",n),s.add(mapgl._J.config.entranceAnimation,"growTime",1,2e3),s.add(mapgl._J.config.entranceAnimation,"growType",n),s.add(mapgl._J.config.entranceAnimation,"stagger",0,2e3);const a=i.addFolder("Labeling");a.add(mapgl._J.config.labeling,"animationTime",100,700),a.add(mapgl._J.config.labeling,"animationType",n),a.add(Rr,"interval",100,700).onChange(()=>t._impl.modules.labeler.setLabelingInterval(mapgl._J.config.labeling.interval));const l=i.addFolder("Layer animation"),c={"Model animation 15s":()=>{const d=t._impl.modules.styleManager.getStyle(t._impl.state.handyStyleId);if(d){const u=d.layerIdToInnerId[977900];At("modelanim",{},t._impl.state,0,1,15e3,1,{layerId:u,styleId:t._impl.state.handyStyleId}),t._impl.on("framestart",()=>xt("modelanim",{},t._impl.state))}},"Poi animation 15s":()=>{const d=t._impl.modules.styleManager.getStyle(t._impl.state.handyStyleId);if(d){const u=d.layerIdToInnerId[572603];At("poianim",{},t._impl.state,0,1,15e3,1,{layerId:u,styleId:t._impl.state.handyStyleId}),t._impl.on("framestart",()=>xt("poianim",{},t._impl.state))}},"Road animation 15s":()=>{const d=t._impl.modules.styleManager.getStyle(t._impl.state.handyStyleId);if(d){const u=d.layerIdToInnerId["intercity roads background white"];At("roadanim",{},t._impl.state,0,1,15e3,1,{layerId:u,styleId:t._impl.state.handyStyleId}),t._impl.on("framestart",()=>xt("roadanim",{},t._impl.state))}},"Traffic animation 15s":()=>{const d=t._impl.modules.styleManager.getStyle(t._impl.state.handyStyleId);if(d){const u=d.layerIdToInnerId["porch under house"];At("traficanim",{},t._impl.state,0,1,15e3,1,{layerId:u,styleId:t._impl.state.handyStyleId}),t._impl.on("framestart",()=>xt("traficanim",{},t._impl.state))}}};l.add(c,"Model animation 15s"),l.add(c,"Poi animation 15s"),l.add(c,"Road animation 15s"),l.add(c,"Traffic animation 15s")}function dW(t,e){const n=t._impl.modules,i=e.addFolder("Light"),o={"Surface Illumination":0,azimuth:230,altitude:50,intensity:.2,color:"#ffffff",backlightAzimuth:0,backlightAltitude:60,backlightIntensity:0,backlightColor:"#ffffff",ambientColor:"#ffffff",ambientIntensity:.85,enableGltfLighting:!1,makeItOld:!1,ignoreGlobalLighting:!1};let r=null;const s=yl(function(){o["Surface Illumination"]=o.intensity*Math.sin(Math.PI*o.altitude/180)+o.backlightIntensity*Math.sin(Math.PI*o.backlightAltitude/180)+o.ambientIntensity,r.value=o["Surface Illumination"].toString(10)},100),a={enabled:!1,resolutionWidth:t._impl.modules.shadowManager.shadowMapParams[0],resolutionHeight:t._impl.modules.shadowManager.shadowMapParams[1],radius:t._impl.modules.shadowManager.shadowMapParams[2],bias:n.shadowManager.baseBias,discreteVolume:n.shadowManager.discreteVolume,volumeMultiplier:n.shadowManager.volumeMultiplier,volumeSizeStep:n.shadowManager.volumeSizeStep,volumeMinSize:n.shadowManager.volumeMinSize,adaptiveVerticalSize:n.shadowManager.adaptiveVerticalSize,debugDraw:n.shadowManager.debugDraw},l=function(){const x=n.styleManager.getStyle(t._impl.state.handyStyleId);if(!x)return;const I={sources:{sun:{type:"directional",altitude:o.altitude,azimuth:o.azimuth,color:o.color,intensity:o.intensity},backlight:{type:"directional",altitude:o.backlightAltitude,azimuth:o.backlightAzimuth,color:o.backlightColor,intensity:o.backlightIntensity},atmosphere:{type:"ambient",color:o.ambientColor,intensity:o.ambientIntensity}},defaultLightingMode:o.ignoreGlobalLighting?"none":"global",lightingModes:{global:["sun","backlight","atmosphere"]}};I.shadows=a.enabled?{source:"sun",radius:a.radius}:void 0,x.light=cb(I,x.dem),t.triggerRerender(),s()};window.updateLight=l;const c=()=>{const x=n.styleManager.getStyle(t._impl.state.handyStyleId);x==null||x.layers.forEach(I=>{I.type==="gltfModel"&&(I.style.ignoreGlobalLighting=!o.enableGltfLighting)}),l()},d=()=>{o.azimuth=0,o.makeItOld?o.altitude=0:o.altitude=60,l()};let u=null;function f(x){n.shadowManager.baseBias=x,t._impl.state.needRerender=!0}function h(x){n.shadowManager.discreteVolume=x,t._impl.state.needRerender=!0,x&&!u&&(u=v.add(a,"volumeSizeStep",1e3,1e5,1e3).onChange(p).name("Size Step")),!x&&u&&(v.remove(u),u=null)}function _(x){n.shadowManager.volumeMultiplier=x,t._impl.state.needRerender=!0}function p(x){n.shadowManager.volumeSizeStep=x,t._impl.state.needRerender=!0}function m(x){n.shadowManager.volumeMinSize=x,t._impl.state.needRerender=!0}function g(x){n.shadowManager.adaptiveVerticalSize=x,t._impl.state.needRerender=!0}function y(x){n.shadowManager.debugDraw=x,t._impl.state.needRerender=!0}r=i.add(o,"Surface Illumination").domElement.querySelector("input"),i.add(o,"ignoreGlobalLighting").onChange(l),i.add(o,"azimuth",0,360,1).onChange(l),i.add(o,"altitude",0,90,1).onChange(l),i.add(o,"intensity",0,1,1e-4).onChange(l),i.addColor(o,"color").onChange(l),i.addColor(o,"ambientColor").onChange(l),i.add(o,"ambientIntensity",0,1,1e-4).onChange(l),i.add(o,"enableGltfLighting").onChange(c),i.add(o,"makeItOld").onChange(d);const b=i.addFolder("backlight light");b.add(o,"backlightAzimuth",0,360,1).onChange(l),b.add(o,"backlightAltitude",0,90,1).onChange(l),b.add(o,"backlightIntensity",0,1,1e-4).onChange(l),b.addColor(o,"backlightColor").onChange(l);const v=i.addFolder("Shadow");v.add(a,"enabled").onChange(l),v.add(a,"debugDraw").onChange(y).name("Debug Draw"),v.add(a,"adaptiveVerticalSize").onChange(g).name("Adaptive Vertical Size"),v.add(a,"resolutionWidth",{256:256,1024:1024,2048:2048,4096:4096,8192:8192,16384:16384}).onChange(x=>{n.shadowManager.setShadowResolution(x,a.resolutionHeight),t._impl.state.needRerender=!0}).name("Resolution Width"),v.add(a,"resolutionHeight",{256:256,1024:1024,2048:2048,4096:4096,8192:8192,16384:16384}).onChange(x=>{n.shadowManager.setShadowResolution(a.resolutionWidth,x),t._impl.state.needRerender=!0}).name("Resolution Height"),v.add(a,"bias",0,1e3,1).onChange(f).name("Bias"),v.add(a,"radius",0,3,.1).onChange(l).name("Radius"),v.add(a,"volumeMultiplier",.1,10,.1).onChange(_).name("Volume Multiplier"),v.add(a,"volumeMinSize",1e3,1e5,100).onChange(m).name("Min Volume Size");const T=v.add(a,"discreteVolume").onChange(h).name("Discrete Volume");h.call(T,a.discreteVolume),s()}const uW="https://catalog.api.2gis.ru";function fW(t,e=!1){let n=[],i;function o(){t._impl.setSelectedIds(),n.forEach(s=>s.destroy()),n=[]}function r(s){const a=[`id=${s}`,"key=webmaps","fields=items.links"];return fetch(`${uW}/3.0/items/byid?${a.join("&")}`).then(l=>l.json())}if(t.on("click",async s=>{console.log("Map click:",s);const a=s.target&&s.target.id;if(a!==i&&(o(),i=a,t._impl.setSelectedIds(a!==void 0?[a]:void 0),a!==void 0)){const l=await r(a);if(l.meta.code===200&&l.result.total>0&&l.result.items[0].links!==void 0&&l.result.items[0].links.entrances!==void 0){const c=l.result.items[0].links.entrances.map(d=>d.geometry.vectors).filter(d=>d!==void 0).reduce((d,u)=>d.concat(u),[]).map(d=>l0.parse(d).coordinates);if(c.length===0)return;if(mapgl._J.config.entranceAnimation.stagger===0)n.push(new mapgl._J.Entrance(t._impl,{coordinates:c,animate:!0,minZoom:16}));else{const d=c.reduce((u,f)=>(u[0]+=f[f.length-1][0],u[1]+=f[f.length-1][1],u),[0,0]);d[0]/=c.length,d[1]/=c.length,c.sort((u,f)=>Math.atan2(d[1]-f[0][1],d[0]-f[0][0])-Math.atan2(d[1]-u[0][1],d[0]-u[0][0]));for(let u=0;u<c.length;u++){const f=c[u];n.push(new mapgl._J.Entrance(t._impl,{coordinates:[f],minZoom:16,animate:u%2===1})),await ix(mapgl._J.config.entranceAnimation.stagger/c.length)}}for(const d of n)d.on("click",u=>{console.log(u,d)})}}}),t._impl.on("metrics",async s=>{console.log("metrics",{...s,webglStats:IU(TU(t.getWebGLContext())),fps:t._impl.performanceChecker.getFpsStats(),memory:await t._impl.performanceChecker.getMemoryStats(),webGpuSupported:await DL()})}),!e){const s=()=>{history.replaceState({},document.title,bn(t,W))};[["moveend"],["trafficshow",!0],["traffichide",!0]].forEach(([l,c])=>t.on(l,c?()=>setTimeout(s):s))}t.on("copyrightclick",s=>{console.log("Copyright click:",s.type,s.href),s.originalEvent.preventDefault()}),t.on("floorlevelchange",s=>{console.log("Floor level change: ",s.floorPlanId,s.floorLevelIndex,s.floorLevelName)})}const hW={type:"FeatureCollection",features:[{type:"Feature",properties:{},geometry:{type:"LineString",coordinates:[[40.0488087858624,43.610852223415925],[40.047062672674656,43.608789065472635]]}},{type:"Feature",properties:{},geometry:{type:"LineString",coordinates:[[40.017703883349895,43.59046939304687],[40.01663543932634,43.589768478909455]]}},{type:"Feature",properties:{db_tiers:[-1]},geometry:{type:"LineString",coordinates:[[40.047062672674656,43.608789065472635],[40.045166015625,43.60662577379785],[40.045166015625,43.60662577379785],[40.04433151334524,43.60567361919462],[40.04379004240036,43.60505769677922],[40.043004155159,43.604261868096174],[40.043004155159,43.604261868096174],[40.04297498613596,43.60423224888767],[40.041704289615154,43.603248494431234],[40.038748160004616,43.601228736875676],[40.03536220639944,43.59952260923714],[40.034497529268265,43.599138984862066],[40.0341796875,43.599019769447345],[40.0341796875,43.599019769447345],[40.03022141754627,43.59753623403938],[40.02933159470558,43.597170079246986],[40.028475634753704,43.59667766066833],[40.02783324569464,43.59630591596549],[40.02783324569464,43.59630591596549],[40.023193359375,43.59361937912089],[40.023193359375,43.59361937912089],[40.02183951437473,43.59283554045577],[40.017703883349895,43.59046939304687]]}}]},_W=(t,e)=>{const n="tunnel1",i="fakeRoute1",o="fakeRoute2";let r;const s={add(){s.remove(),t.patchStyleState({immersiveLevel:1}),t.addLayer({type:"tunnel",id:n,filter:["match",["get","sublayer"],["Federal_road_tunnel"],!0,!1],style:{color:"#FCFBF2",sideColor:"#32a852",topColor:"#ff0000"}})},remove(){t.removeLayer(n),t.patchStyleState({immersiveLevel:0})},fakeRoute(){r?(r.destroy(),r=void 0,t.removeLayer(i),t.removeLayer(o)):(t.addLayer({type:"line",id:i,filter:["match",["sourceAttr","demo"],["fake_route"],!0,!1],style:{color:"#3388ff",width:15},webglState:{depthTest:!0}}),t.addLayer({type:"line",id:o,filter:["match",["sourceAttr","demo"],["fake_route"],!0,!1],style:{color:"#3388ff20",width:15},webglState:{depthTest:!0,depthMask:!1,cullFace:!1,depthFunc:window.WebGLRenderingContext.GREATER}}),r=new mapgl._J.GeoJsonSource(t,{data:hW,attributes:{demo:"fake_route"}}))}};e.add(s,"add"),e.add(s,"remove"),e.add(s,"fakeRoute")},li=5e3,mW=(t,e)=>{const n=e.addFolder("Camera Fade"),i={override:!1},o={gltfModel:li,buildingModel:li,polygonExtrusion:li,lineExtrusion:li,overpass:li,embankment:li};if(W.nearCameraFade){const s=W.nearCameraFade;o.gltfModel=s[1]??li,o.buildingModel=s[3]??li,o.polygonExtrusion=s[5]??li,o.polygonExtrusion=s[5]??li,o.lineExtrusion=s[9]??li,o.overpass=s[10]??li,o.embankment=s[11]??li}t.on("styleload",()=>{i.override&&(B4(o,t),t.triggerRerender())});function r(){i.override&&(B4(o,t),t.triggerRerender(),W.nearCameraFade=[0,o.gltfModel,0,o.buildingModel,0,o.polygonExtrusion,0,0,0,o.lineExtrusion,o.overpass,o.embankment],history.replaceState({},document.title,bn(t,W)))}n.add(i,"override").onChange(s=>{if(!s){i.override=!0;return}r()}),n.add(o,"gltfModel",0,1e5).onChange(ki(r,100)),n.add(o,"buildingModel",0,1e5).onChange(ki(r,100)),n.add(o,"polygonExtrusion",0,1e5).onChange(ki(r,100)),n.add(o,"lineExtrusion",0,1e5).onChange(ki(r,100)),n.add(o,"overpass",0,1e5).onChange(ki(r,100)),n.add(o,"embankment",0,1e5).onChange(ki(r,100))};function B4(t,e){const n=e._impl.modules.styleManager.getStyle(e._impl.state.handyStyleId);if(n)for(const i in n.layersById){const o=n.layersById[i];o&&typeof t[o.type]=="number"&&"nearCameraFade"in o.style&&(o.style.nearCameraFade=t[o.type])}}function pW(t,e,n){const i=e.addFolder("Camera"),o=t._impl.state.cameraConfig,r={fov:o.fov,useDynamicNearFar:o.useDynamicNearFar};r.fov*=180/Math.PI,i.add(r,"fov",1,200).onChange(u=>{t._impl.state.cameraConfig.fov=u/180*Math.PI,t._impl.refresh()}),i.add(r,"useDynamicNearFar").onChange(u=>{t._impl.state.cameraConfig.useDynamicNearFar=u,u===!1&&(t._impl.state.cameraConfig.near=nn.near,t._impl.state.cameraConfig.far=nn.far),t._impl.refresh()}),i.add(t._impl.state.cameraConfig,"near",1,2**32).onChange(u=>{t._impl.state.cameraConfig.near=u,t._impl.refresh()}).listen(),i.add(t._impl.state.cameraConfig,"far",1,nn.far).onChange(u=>{t._impl.state.cameraConfig.far=u,t._impl.refresh()}).listen(),i.add(n,"maxPitch",0,89,1).onChange(u=>{t.setMaxPitch(u,{animate:!1})}),i.add(n,"lowZoomMaxPitch",0,89,1).onChange(u=>{t.setLowZoomMaxPitch(u,{animate:!1})});let s;const a={showHorizonOffset:!1};i.add(a,"showHorizonOffset").onChange(u=>{u?l():c()});function l(){const u=t._impl.modules.camera;u.globeRatio>Number.EPSILON||(s==null||s.remove(),s=document.createElement("div"),s.style.position="absolute",s.style.zIndex="9",s.style.width="100%",s.style.height="5px",s.style.backgroundColor="#f00",s.style.top=`${u.getHorizonPixelOffset()}px`,s.style.left="0",document.body.append(s),t.on("move",d))}function c(){s==null||s.remove(),s=void 0,t.off("move",d)}function d(){const u=t._impl.modules.camera;s&&u.globeRatio<Number.EPSILON&&(s.style.top=`${u.getHorizonPixelOffset()}px`)}}function gW(t,e){const n=e.addFolder("Debug near far"),i=t._impl.modules;let o=0,r=0,s=[],a=[];const l={debugViewport(){c(),console.log("Минимальная глубина:",s[2]),console.log("Максимальная глубина:",a[2]),console.log(`Буфер глубины используется на ${50*(a[2]-s[2])} %`),console.log("Высота камеры:",i.camera.position[2],`(2**${Math.log2(i.camera.position[2])})`),console.log("Рекомендованный near:",o,`(2^${Math.log2(o).toFixed(5)})`),console.log("Рекомендованный far:",r,`(2^${Math.log2(r).toFixed(5)})`)}};n.add(l,"debugViewport");function c(){const[d,u,f,h]=i.camera.getViewportVertices();s=Va([],[d[0],d[1],d[2],1],i.camera.viewProjectionMatrix),a=Va([],[f[0],f[1],f[2],1],i.camera.viewProjectionMatrix);const _=_n([],$t([],i.camera.position,t._impl.state.center));o=Fs($t([],i.camera.position,d),_),r=Fs($t([],i.camera.position,h),_),jr(s,s,1/s[3]),jr(a,a,1/a[3])}}function vW(t,e,n){const i=e.addFolder("Camera");pW(t,i,n),mW(t,i),gW(t,i)}const O4="sample-patterns-layer",yW=["match",["get","sublayer"],["Oneway_federal_road","Federal_road","Federal_road_pay","Federal_road_bridge","Federal_road_pay_bridge"],!0,!1],bW=["none","triangles","chess","doubledash","stripe"],wW=(t,e)=>{const n={type:"none",color:"#fff",useMeters:!1,width:16,param1:16,param2:4,param3:16,param4:2,geojsonCase:s},i=e.addFolder("Patterns");i.add(n,"type",bW).onChange(o),i.addColor(n,"color").onChange(o),i.add(n,"useMeters").onChange(o),i.add(n,"width",1,32).onFinishChange(o),i.add(n,"param1",1,64).onFinishChange(o),i.add(n,"param2",1,32).onFinishChange(o),i.add(n,"param3",1,32).onFinishChange(o),i.add(n,"param4",-8,32).onFinishChange(o),i.add(n,"geojsonCase");function o(){t.removeLayer(O4);const{type:a,color:l,width:c,param1:d,param2:u,param3:f,param4:h,useMeters:_}=n;if(d===0)return;const p=m=>_?["meters-to-pixels",m]:m;t.addLayer({id:O4,filter:yW,type:"line",style:{width:p(c),color:l,pattern:["pattern",a,p(d),p(u),p(f),p(h)],startCap:"butt",endCap:"butt"}})}let r;function s(){const l=[45,45],c=xW(l,.003),d="geojson-patterns-layer",u="geojson-patterns-layer-bg",f=16,h={doubledash:[[16,4,8,16],[16,2,8,16],[16,4,16,16],[16,4,16,0],[16,4,16,0]]};function _(p,m){return{id:d,type:"line",filter:["==",["get","foo"],"bar"],style:{width:f,color:"#080",pattern:["pattern",p,...m],startCap:"butt",endCap:"round"}}}t.removeLayer(d),t.removeLayer(u),t.addLayer(_("doubledash",h.doubledash[5])),t.setCenter(l),t.setZoom(14),t.setPitch(15),!r&&(r=new mapgl.GeoJsonSource(t,{data:{type:"FeatureCollection",features:[{type:"Feature",properties:{foo:"bar"},geometry:{type:"LineString",coordinates:c}}]}}))}};function xW(t,e){return[[t[0]+e,t[1]],[t[0],t[1]-e],[t[0]-e,t[1]],[t[0],t[1]+e],[t[0]+e,t[1]]]}const SW=22,MW=[...Array(SW+1)].map((t,e)=>e).reduce((t,e)=>(t[e]=e,t),{});function TW(t,e){const n=e.addFolder("Traffic Options");["trafficMinZoom","trafficMaxZoom","trafficMaxDetailLevel"].forEach(o=>n.add(W,o,{...MW}).onChange(()=>document.location.assign(bn(t,W))))}const ym="pedestrian-pattern-layer",bm="pedestrian-debug-line",D4=["match",["sourceAttr","sourceName"],["pedestrian-pattern-case"],!0,!1],IW=(t,e)=>{const n={color:"#e7e7e7",useMeters:!0,navigate(){t.setCenter([82.90622312195248,55.04357220882439]),t.setZoom(20),t.setRotation(0),t.setPitch(0)},init:s,destroy(){r&&(r.destroy(),r=void 0),t.removeLayer(ym),t.removeLayer(bm)},addDebugLines(){t.addLayer({id:bm,filter:D4,type:"line",style:{width:1}})},removeDebugLines(){t.removeLayer(bm)}},i=e.addFolder("Pedestrian Patterns");i.add(n,"navigate"),i.add(n,"init"),i.add(n,"destroy"),i.addColor(n,"color").onChange(o),i.add(n,"useMeters").onChange(o),i.add(n,"addDebugLines"),i.add(n,"removeDebugLines");function o(){t.removeLayer(ym);const{color:a,useMeters:l}=n,c=d=>l?["meters-to-pixels",d]:d;t.addLayer({id:ym,filter:D4,type:"line",style:{width:c(["get","db_test_width"]),color:a,pattern:["pattern","stripe",c(["get","db_test_line_height"]),c(["get","db_test_line_space"])],startCap:"butt",endCap:"butt"}})}let r;function s(){o(),t.removeLayer("602230"),r&&r.destroy(),r=new mapgl.GeoJsonSource(t,{data:{type:"FeatureCollection",features:[{type:"Feature",properties:{db_test_width:9,db_test_line_height:.4,db_test_line_space:.6},geometry:{type:"LineString",coordinates:[[82.90617953919306,55.043427812452634],[82.90650927227709,55.0435418354634]]}},{type:"Feature",properties:{db_test_width:9,db_test_line_height:.4,db_test_line_space:.6},geometry:{type:"LineString",coordinates:[[82.9062616182777,55.043747464646344],[82.90595210071513,55.04364451246393]]}},{type:"Feature",properties:{db_test_width:4,db_test_line_height:.4,db_test_line_space:.6},geometry:{type:"LineString",coordinates:[[82.90594930953847,55.04346929754859],[82.90588478368342,55.04352913992117]]}},{type:"Feature",properties:{db_test_width:4,db_test_line_height:.4,db_test_line_space:.6},geometry:{type:"LineString",coordinates:[[82.90645236169522,55.04372670428449],[82.90651634380683,55.04366642457664]]}}]},attributes:{sourceName:"pedestrian-pattern-case"}})}},EW=(t,e)=>{const n={currentId:"0"};function i(){const a=t._impl.modules.styleManager.getStyle(t._impl.modules.map.state.handyStyleId);return a==null?void 0:a.layers.map(l=>l.id)}const o=e.addFolder("Controls Layout Hidden");function r(){const a={...Q8};Object.keys(a).forEach(l=>{o.add(a,l).onChange(c=>{c?t._impl.showLayers({type:l}):t._impl.hideLayers({type:l})})})}function s(){const a=i(),l={value:"none"};o.add(l,"value",a).name("Select Layer").onChange(c=>{n.currentId&&n.currentId!==c&&t._impl.showLayers({id:n.currentId}),n.currentId=c,t._impl.hideLayers({id:c})})}t.on("styleload",()=>{r(),s()})},AW=[82.94150261766764,55.01333602964375],wm=["Preschool_house_roof","Private_house_roof","Momrah_building_roof","Floor_plan_house_roof","Kiosk_roof","Canopy_roof","Underground_house_roof","Dwelling_house_roof","Technical_house_roof","School_house_roof","New_house_roof","Administrative_house_roof"];function CW(t,e){const n=e.addFolder("Roofs"),i=n.addFolder("Tune roof colors"),o={colorRgba:"rgba(252, 251, 237, 1)",colorSelectedRgba:"rgba(255, 147, 135, 1)",hoverColorRgba:"rgba(255, 255, 255, 0.45)"};function r(){return{id:"roofs",minzoom:16,type:"polygon3d",filter:["match",["get","db_sublayer"],wm,!0,!1],style:{color:["match",["get","selected"],[!0],o.colorSelectedRgba,o.colorRgba],elevation:["mappoints-to-meters",["get","db_elevation"]]}}}function s(){return{id:"roofLayerHover",minzoom:16,type:"polygon3d",filter:["all",["match",["get","hovered"],[!0],!0,!1],["match",["get","db_sublayer"],wm,!0,!1],["match",["get","selected"],[!0],!1,!0]],style:{color:o.hoverColorRgba,elevation:["mappoints-to-meters",["get","db_elevation"]]}}}function a(){t.removeLayer("roofs"),t.removeLayer("roofLayerHover");const c=r(),d=s();t.addLayer(c,"843132"),t.addLayer(d,"194588")}const l={initStagingDataAndStyle(){Vt(t,{tileServer:"tileserver.web-staging.2gis.ru",tileSet:"vector_dev",style:"e7b545ae-812e-4ec8-a551-720c300cbf22"}),window.location.reload()},navigateAndAddLayers(){t.setCenter(AW,{animate:!1}),t.setStyleZoom(19),l.addRoofsLayers()},addBl(){const c={version:0,name:"empty",background:{color:"#f5f2e0"},icons:{},layers:[]};t.setStyle(c,{fontsPath:"",iconsPath:"",modelsPath:""})},addRoofsLayers(){this.removeRoofsLayers();const c=r(),d=s();t.addLayer(c,"843132"),t.addLayer(d,"194588")},removeRoofsLayers(){wm.forEach(c=>{t.removeLayer(c)})},removeRoofsHovers(){t.removeLayer("roofLayerHover")},reset(){Vt(t,{tileServer:void 0,tileSet:void 0}),window.location.reload()},color:"#FCFBED",colorAlpha:1,strokeColor:"#C9C3B4",strokeColorAlpha:1,strokeWidth:.5};n.add(l,"initStagingDataAndStyle"),n.add(l,"navigateAndAddLayers"),n.add(l,"addBl"),n.add(l,"addRoofsLayers"),n.add(l,"removeRoofsLayers"),n.add(l,"removeRoofsHovers"),n.add(l,"reset"),i.add(o,"colorRgba",o.colorRgba).onFinishChange(a),i.add(o,"colorSelectedRgba",o.colorSelectedRgba).onFinishChange(a),i.add(o,"hoverColorRgba",o.hoverColorRgba).onFinishChange(a)}const PW=(t,e)=>{let n,i,o="0",r="0",s=0;const a=_=>{o="0",r="0",console.log(_,"click")},l=()=>{const _=t._impl.getMapRenderStat(),p=["#00FF00","#A8FF00","#FFFF00","#FFA500","#FF4500","#000000"];if(i&&_.drawCount!==0){const m=p[_.level];i.innerHTML=`<div title="Level:${_.level} DrawCount:${_.drawCount}(${_.drawsLevel}) VertexCount:${_.vertexCount}(${_.vertexLevel}) TrianglesCount:${_.triangleCount}(${_.triangleLevel})" style="background-color:${m}; color:${m==="#000000"?"#FF4500":"#000000"}">Draws: ${_.drawCount}</div>`}o!==r&&o!=="0"?(s=_.drawCount,r=o,t._impl.showLayers({id:o})):r!=="0"&&i&&_.drawCount!==0&&(i.innerHTML=`Draws: ${_.drawCount} Up: ${(100/s*_.drawCount-100).toFixed(2)}%`)},c={add:()=>{if(!n){const _=`
                    <button class="drawCallsButton">
                        .........
                    </button>
                `;n=new mapgl.Control(t,_,{position:"bottomCenter"}),i=n.getContainer().querySelector(".drawCallsButton"),i.innerHTML=`Draws: ${t._impl.state.stats.drawCount}`,i.addEventListener("click",a),t._impl.on("frameend",l),t.triggerRerender()}},destroy:()=>{n&&(n.destroy(),n=void 0,i==null||i.removeEventListener("click",a),t._impl.off("frameend",l),i=void 0)}},d=e.addFolder("DrawsIndicator control");d.add(c,"add"),d.add(c,"destroy");const u={currentId:"0"};function f(){const _=t._impl.modules.styleManager.getStyle(t._impl.modules.map.state.handyStyleId);return _==null?void 0:_.layers.map(p=>p.id)}function h(){const _=f(),p={value:"none"};d.add(p,"value",_).name("Select Layer").onChange(m=>{u.currentId&&u.currentId!==m&&t._impl.showLayers({id:u.currentId}),u.currentId=m,o=m,t._impl.hideLayers({id:m})})}t.on("styleload",()=>{h()})},LW=(t,e)=>{const n={enabled:!!W.globe,debugUnproject:!1};e.add(n,"enabled").onChange(o=>{t.patchStyleState({globeEnabled:o}),W.globe=o,Vt(t,W)}),e.add(n,"debugUnproject").onChange(o=>{o?t.on("click",i):t.off("click",i)});function i(o){const r=t._impl.modules.camera,s=o.lngLat,a=q.toGeo(r.flat.unproject(o.point)),l=Rn.toGeo(r.ecef.unproject(o.point));new mapgl.HtmlMarker(t,{coordinates:a,html:'<div style="pointer-events: none; position: relative;"><div style="position: absolute; left: -4px; top: -4px; border-radius: 8px; background: #0c08; width:8px; height:8px;"></div></div>'}),new mapgl.HtmlMarker(t,{coordinates:l,html:'<div style="pointer-events: none; position: relative;"><div style="position: absolute; left: -4px; top: -4px; border-radius: 8px; background: #00c8; width:8px; height:8px;"></div></div>'}),new mapgl.HtmlMarker(t,{coordinates:s,html:'<div style="pointer-events: none; position: relative;"><div style="position: absolute; left: -3px; top: -3px; border-radius: 6px; background: #c008; width:6px; height:6px;"></div></div>'})}};var tc={},N4;function FW(){if(N4)return tc;N4=1,Object.defineProperty(tc,"__esModule",{value:!0}),tc.load=void 0;var t;function e(i){if(i===void 0&&(i="https://mapgl.2gis.com/api/js"),typeof window>"u")throw new Error("mapgl is supported only in browser environment");return t?Promise.resolve(t):n(i).then(function(){return t=window.mapgl,t})}tc.load=e;function n(i){return new Promise(function(o,r){var s=document.createElement("script");s.type="text/javascript",s.async=!0,s.crossOrigin="anonymous",s.src=i,document.body.appendChild(s),s.addEventListener("load",function(){o()}),s.addEventListener("error",function(a){r(a)})})}return tc}var kW=FW();const RW="/index.umd.js";kW.load(RW).then(t=>{const e=new t.Map("map",W);window.mapgl=t,window.map=e,window.__MAPGL_DEVTOOLS__&&window.__MAPGL_DEVTOOLS__.init(e),aW(e),lW(e),ex(e,at),fW(e);const n=at.addFolder("Debug");at.addFolder("FlyOnMap").add({FlyDemo:()=>{window.location.assign(`${window.location.origin}/fly-run.html${window.location.search}`)}},"FlyDemo"),jU(e,n,W),vW(e,at,W),dW(e,at);const o=at.addFolder("Terrain");s$(e,o);const r=at.addFolder("Globe");LW(e,r);const s=at.addFolder("ImmersiveRoads");L$(e,s),k$(e._impl,s),_W(e._impl,s.addFolder("Tunnel")),TW(e,at),cW(e,at),iW(e,at);const a=at.addFolder("Controls");F9(e,a),PW(e,a),hx(e,a),EW(e,a),ux(e,at,W),F7(e,at);const l=at.addFolder("glTF models");_$(e,l),b$(e,at,W),w$(e,at),R$(e,at);const c=at.addFolder("Dynamic Objects");U9(e,c),N9(e,c),k9(e,c),R9(e,c),B9(e,c),O9(e,c),D9(e,c),fx(e,at),DU(e,at,{showRegionStats:"regionStats"in V4}),wW(e,at),IW(e,at),Q7(e._impl,at),CW(e,at),e.on("floorlevelchange",d=>console.log("floorlevelchange",d)),e.on("floorplanhide",d=>console.log("floorplanhide",d)),e.on("floorplanshow",d=>console.log("floorplanshow",d)),W.traffic&&(e.showTraffic(),e.patchStyleState({trafficOn:!0}))});
