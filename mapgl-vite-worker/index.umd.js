(function(Je,Na){typeof exports=="object"&&typeof module<"u"?Na(exports):typeof define=="function"&&define.amd?define(["exports"],Na):(Je=typeof globalThis<"u"?globalThis:Je||self,Na(Je.mapgl={}))})(this,function(Je){"use strict";var Cr;const Na="tile{subdomain}.maps.2gis.com",Kx="jam.api.2gis.com",Jx="https://styles.api.2gis.com",Qx="https://disk.2gis.com/styles/assets/icons",xp="https://disk.2gis.com/styles/assets/models",e2="https://mapgl.2gis.com/api/fonts",t2="https://keys.api.2gis.com/public/v1/keys/{keyID}/services/mapgl-js-api",i2="https://mapgl.2gis.com/api/js/plugins/rtl-v1.1.1.js",n2="sha512-IyuCqmcNBfZyrExDMisGi0Xhp4PXupx6AMp4cjpKcAzJo+kSmOtRTLbL1xZsfxnsIqci9Q0piqY+kcwl1hCPyw==",s2="https://mapgl.2gis.com/api/js/plugins/draco_decoder_gltf.js",Sp=107.17318798131565,No=2**20,xe=2**15,rt=2**16-1,Nn=xe/rt,$=16383,Mp=2.54,Rr=96,Wh=4294967296/(256/Rr*Mp),At=.7071067811865475,o2=1175494351e-47,r2=3402823466e29,sc=["Arial","Helvetica","HelveticaNeueCyr","Open_Sans","Open_Sans_Semibold","Open_Sans_Italic","Segoe_UI","PT_Sans_Caption","PT_Sans","Verdana","Verdana_bold","Noto_Sans","Noto_Sans_Semibold","Noto_Sans_Italic","SuisseIntl_Bold"],ho="Noto_Sans",Ip=1/2,Tp=-4,oc=2147483647,rc="c080bb6a-8134-4993-93a1-5b4d8c36a59b",a2=5,Ua=4,Xh=40,Yh=65e3,qh="byModel",l2=65536,c2=512,Ep="empty",zr={minZoom:2,maxZoom:20},Xe={protocol:"https",server:Na,subdomains:"0123",tileSet:"vector_a",tileKey:Ep,appId:"empty",cacheRatio:2,maxUniverseZoom:8,maxRegionalZoom:15,maxDetailLevel:17},Fr={minZoom:10,maxZoom:14,tileSet:"com_poi_web",rasterSizes:[96,84,72,60,48,36,24]},Uo={minZoom:15,maxZoom:15,tileSet:"vector_immersive"},Ap=100,Kh=13.5,Gt=[2048,2048],ac={tiles:"{protocol}://{host}/vt?r={request}&ts={tileSet}&key={tileKey}&appId={appId}&lang={lang}&default_lang={defaultLang}&s={sessionId}&dt={dt}",metatile:"{protocol}://{host}/metafiles/{hash}/metatile.json?ts={tileSet}",modelInfo:"{protocol}://{host}/metafiles/{regionId}/models.json?ts={tileSet}",model:"{protocol}://{host}/metafiles/{regionId}/{name}?ts={tileSet}",gltfModel:"{protocol}://{host}/metafiles/{modelSrc}?ts={tileSet}",convertData:"{protocol}://{host}/metafiles/{hash}/convert.json?ts={tileSet}",dynamicPoi:"{protocol}://{host}/metafiles/{regionId}/poi/{id}_{width}_{height}.png?ts={tileSet}",models:"{protocol}://{host}/v2/ald?ts={tileSet}&x={x}&y={y}&z={z}",commercialPoi:"{protocol}://{host}/v2/ald?ts={tileSet}&x={x}&y={y}&z={z}&lang={lang}",floorMeta:"{protocol}://{host}/metafiles/{regionId}/{floorComplexId}.json?ts={tileSet}"},ki={protocol:"https",host:Kx,url:"{protocol}://{host}/tiles?tls={tiles}&reg={regions}&tm={time}&fmt=json&z={z}",timestampUrl:"{protocol}://{host}/meta?reg={regions}&time&score",updateInterval:2*60*1e3,minZoom:10,maxZoom:16,maxDetailLevel:17,fetchMetaRetryDelays:[2,5,25].map(t=>t*1e3)},jt={defaultUrl:e2,gamma:.08,baseSize:24,baseLineHeight:1.2,bomCharCode:65279},Jh={defaultUrl:Qx},Ga={url:Jx,path:"styles/{id}"},ks={doubleClickTime:185,dragThreshold:2,pitchWaitingTime:200,pitchThreshold:7},Pp=1e3,ja={inAnimationTime:180,inAnimationType:"linear",outAnimationTime:800,outAnimationType:"linear"},Qh={time:300,type:"linear"},Go={minStyleZoom:16,duration:500,easing:"easeOutQuint"},Dr={bounceType:"easeOutElastic",bounceTime:1200,growType:"easeInOutQuad",growTime:1200,stagger:0,iterationCount:1/0},rn={pixelDensity:.5,sceneOpacity:0,cacheDebounceTime:400,cacheThrottleTime:300,pickDistance:3},uo={interval:220,animationTime:200,animationType:"linear",tileMultiplier:1.5,axisAngleToleranceDeg:45,axisCheckDistancePx:13,commercialMargins:{default:{topBottom:60,leftRight:60},city:{topBottom:500,leftRight:500}},lineLabelsHidePitchDeg:40,maxLabelLength:30},Lp={0:uo.commercialMargins.city,11:{topBottom:250,leftRight:250},12:{topBottom:170,leftRight:170}},lc={alwaysRerender:!1,autoResizeInterval:50},eu="en",an={macWheelDeltaToZoomDelta:.0018,notMacTrackpadDeltaToZoomDelta:.0018*3,wheelZoomDelta:.65,animDuration:400,throttleDelay:100,mouseRotateDelta:2.5,mousePitchDelta:2.5,mobilePinchDelta:1,mobileTapDelta:10},us={duration:1300,maxSpeed:8,minSpeed:.02,nonLinearity:5},ln={fov:60*Math.PI/180,useDynamicNearFar:!1,near:1e3,far:2**34,viewportLimitRatio:2,minTrapezeHeight:2*131072,perspectiveDistanceLimitRatio:10,minFogDistance:2e4,pitchInterStartZoom:16.5,pitchInterEndZoom:19},In={globeMaxZoom:8,globeInterStartZoom:7,globeInterEndZoom:16},Cp=1e3,Rp=16,jo={enabled:!0,displayStyleZoom:18,detailLevel:17,wallMinBrightness:.8265,wallMaxBrightness:.95,viewportPadding:.2,maxStackHeight:40},zp={fpsCaveat:10},Fp=3e4,tu=["Commercial_poi_city"],iu=["Commercial_poi_premium"],Dp=["Commercial_poi_default","Commercial_poi_custom","Commercial_poi_navi",...tu,...iu],Op=["Commercial_model"],Bp=["s_personal_poi"],kp=["Landmark_poi","Landmark_point"],Np=[105,84,63,42,21],Up="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzBweCIgaGVpZ2h0PSI0OHB4IiB2aWV3Qm94PSIwIDAgMzAgNDgiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+PCEtLSBHZW5lcmF0b3I6IFNrZXRjaCA1MS4yICg1NzUxOSkgLSBodHRwOi8vd3d3LmJvaGVtaWFuY29kaW5nLmNvbS9za2V0Y2ggLS0+PHRpdGxlPlBhZ2UgMSBDb3B5PC90aXRsZT48ZGVzYz5DcmVhdGVkIHdpdGggU2tldGNoLjwvZGVzYz48ZGVmcz48bGluZWFyR3JhZGllbnQgeDE9IjUwJSIgeTE9IjUwJSIgeDI9IjUwJSIgeTI9IjAlIiBpZD0ibGluZWFyR3JhZGllbnQtMSI+PHN0b3Agc3RvcC1jb2xvcj0iIzFCODlFRSIgb2Zmc2V0PSIwJSI+PC9zdG9wPjxzdG9wIHN0b3AtY29sb3I9IiMzMTk4RUMiIG9mZnNldD0iMTAwJSI+PC9zdG9wPjwvbGluZWFyR3JhZGllbnQ+PC9kZWZzPjxnIGlkPSJQYWdlLTEiIHN0cm9rZT0ibm9uZSIgc3Ryb2tlLXdpZHRoPSIxIiBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxnIGlkPSJSZWNvdmVyeS0wMSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTgzOS4wMDAwMDAsIC00MjUuMDAwMDAwKSI+PGcgaWQ9IlBhZ2UtMS1Db3B5IiB0cmFuc2Zvcm09InRyYW5zbGF0ZSg4MzkuMDAwMDAwLCA0MjUuMDAwMDAwKSI+PGVsbGlwc2UgaWQ9Ik92YWwtMyIgZmlsbD0iIzAwMDAwMCIgb3BhY2l0eT0iMC4wMzYzODA1OTciIGN4PSIxNSIgY3k9IjQ1LjUiIHJ4PSIzIiByeT0iMS41Ij48L2VsbGlwc2U+PGVsbGlwc2UgaWQ9Ik92YWwtMy1Db3B5IiBmaWxsPSIjMDAwMDAwIiBvcGFjaXR5PSIwLjAzNjM4MDU5NyIgY3g9IjE1IiBjeT0iNDUuNSIgcng9IjQuNSIgcnk9IjIuNSI+PC9lbGxpcHNlPjxwYXRoIGQ9Ik0xNSw0NS44ODM2MzUzIEwxNS44ODIzNTI5LDQ1Ljg4MzYzNTMgQzE1Ljg4MjM1MjksMjkuMjE3NzUyOSAyMC43NzY3NjQ3LDIzLjc5NzQ1ODggMjcuOTg3MzUyOSwyMy43OTc0NTg4IEwyOC4zMjk3MDU5LDIzLjc5NzQ1ODggQzI5LjA3Nzk0MTIsMjEuNTkwNjk0MSAzMCwxNy45OTE1NzY1IDMwLDE1LjAwMDQgQzMwLDcuMTQzOTI5NDEgMjMuNzY3OTQxMiwwLjAwMDQgMTUsMC4wMDA0IEM2LjIzMjA1ODgyLDAuMDAwNCAwLDcuMTQzOTI5NDEgMCwxNS4wMDA0IEMwLDE3Ljk5MTU3NjUgMC45MjIwNTg4MjQsMjEuNTkwNjk0MSAxLjY3MDI5NDEyLDIzLjc5NzQ1ODggTDIuMDEyNjQ3MDYsMjMuNzk3NDU4OCBDOS4yMjQxMTc2NSwyMy43OTc0NTg4IDE0LjExNzY0NzEsMjkuMjE3NzUyOSAxNC4xMTc2NDcxLDQ1Ljg4MzYzNTMgTDE1LDQ1Ljg4MzYzNTMgWiIgaWQ9IkZpbGwtMSIgZmlsbD0idXJsKCNsaW5lYXJHcmFkaWVudC0xKSI+PC9wYXRoPjwvZz48L2c+PC9nPjwvc3ZnPg==",Gp=[15,46],jp=16,Va={bias:100,textureSize:[2048,2048],shadowRadius:3},d2=Object.freeze(Object.defineProperty({__proto__:null,DEFAULT_MIN_TIERS_STYLE_ZOOM:jp,MAP_DEFAULTS:zr,atlasSize:Gt,buildingAnimation:Go,cityCommPoiLabelingConfig:Lp,commercialCitySublayers:tu,commercialModelSublayers:Op,commercialPoi:Fr,commercialPremiumSublayers:iu,commercialSublayers:Dp,defaultCameraConfig:ln,defaultLang:eu,defaultMarkerAnchor:Gp,defaultMarkerIcon:Up,defaultShadowsSettings:Va,entranceAnimation:Dr,events:ks,floors:jo,fonts:jt,globeConfig:In,houseHover:ja,icons:Jh,identify:rn,inertia:us,labeling:uo,landmarkPoiSublayers:kp,landmarkRasterSizes:Np,loadModelsInfoStyleZoom:Kh,maxZoomForDynamicNear:Rp,metricsTimeout:Fp,minCalculationScreenHeight:Cp,modelCacheSize:Ap,models:Uo,performanceCheck:zp,personalSublayers:Bp,render:lc,styles:Ga,tileAnimation:Qh,tiles:Xe,traffic:ki,urls:ac,workerResetInterval:Pp,zoom:an},Symbol.toStringTag,{value:"Module"})),cn=1e-6;let dn=typeof Float64Array<"u"?Float64Array:Array;function Oe(){let t=new dn(3);return t[0]=0,t[1]=0,t[2]=0,t}function Or(t){var e=new dn(3);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}function fo(t){let e=t[0],i=t[1],n=t[2];return Math.sqrt(e*e+i*i+n*n)}function at(t,e,i){let n=new dn(3);return n[0]=t,n[1]=e,n[2]=i,n}function Br(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function gt(t,e,i,n){return t[0]=e,t[1]=i,t[2]=n,t}function Ot(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2],t}function h2(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2],t}function Ni(t,e,i){return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t}function Vp(t,e){let i=e[0]-t[0],n=e[1]-t[1],s=e[2]-t[2];return Math.sqrt(i*i+n*n+s*s)}function u2(t,e){let i=e[0]-t[0],n=e[1]-t[1],s=e[2]-t[2];return i*i+n*n+s*s}function f2(t){let e=t[0],i=t[1],n=t[2];return e*e+i*i+n*n}function Hp(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t}function Ui(t,e){let i=e[0],n=e[1],s=e[2],o=i*i+n*n+s*s;return o>0&&(o=1/Math.sqrt(o),t[0]=e[0]*o,t[1]=e[1]*o,t[2]=e[2]*o),t}function nu(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function kr(t,e,i){let n=e[0],s=e[1],o=e[2],r=i[0],a=i[1],l=i[2];return t[0]=s*l-o*a,t[1]=o*r-n*l,t[2]=n*a-s*r,t}function Ti(t,e,i,n){let s=e[0],o=e[1],r=e[2];return t[0]=s+n*(i[0]-s),t[1]=o+n*(i[1]-o),t[2]=r+n*(i[2]-r),t}function Tn(t,e,i){let n=e[0],s=e[1],o=e[2],r=i[3]*n+i[7]*s+i[11]*o+i[15];return r=r||1,t[0]=(i[0]*n+i[4]*s+i[8]*o+i[12])/r,t[1]=(i[1]*n+i[5]*s+i[9]*o+i[13])/r,t[2]=(i[2]*n+i[6]*s+i[10]*o+i[14])/r,t}function _2(t,e,i){let n=e[0],s=e[1],o=e[2],r=i[0],a=i[1],l=i[2],c=i[3],d=c*n+a*o-l*s,h=c*s+l*n-r*o,u=c*o+r*s-a*n,f=-r*n-a*s-l*o;return t[0]=d*c+f*-r+h*-l-u*-a,t[1]=h*c+f*-a+u*-r-d*-l,t[2]=u*c+f*-l+d*-a-h*-r,t}function m2(t,e,i,n){let s=[],o=[];return s[0]=e[0]-i[0],s[1]=e[1]-i[1],s[2]=e[2]-i[2],o[0]=s[0],o[1]=s[1]*Math.cos(n)-s[2]*Math.sin(n),o[2]=s[1]*Math.sin(n)+s[2]*Math.cos(n),t[0]=o[0]+i[0],t[1]=o[1]+i[1],t[2]=o[2]+i[2],t}function p2(t,e,i,n){let s=[],o=[];return s[0]=e[0]-i[0],s[1]=e[1]-i[1],s[2]=e[2]-i[2],o[0]=s[2]*Math.sin(n)+s[0]*Math.cos(n),o[1]=s[1],o[2]=s[2]*Math.cos(n)-s[0]*Math.sin(n),t[0]=o[0]+i[0],t[1]=o[1]+i[1],t[2]=o[2]+i[2],t}function g2(t,e,i,n){let s=[],o=[];return s[0]=e[0]-i[0],s[1]=e[1]-i[1],s[2]=e[2]-i[2],o[0]=s[0]*Math.cos(n)-s[1]*Math.sin(n),o[1]=s[0]*Math.sin(n)+s[1]*Math.cos(n),o[2]=s[2],t[0]=o[0]+i[0],t[1]=o[1]+i[1],t[2]=o[2]+i[2],t}function v2(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]}function y2(t,e){let i=t[0],n=t[1],s=t[2],o=e[0],r=e[1],a=e[2];return Math.abs(i-o)<=cn*Math.max(1,Math.abs(i),Math.abs(o))&&Math.abs(n-r)<=cn*Math.max(1,Math.abs(n),Math.abs(r))&&Math.abs(s-a)<=cn*Math.max(1,Math.abs(s),Math.abs(a))}const vi=h2,su=Vp,w2=u2,_o=fo;(function(){let t=Oe();return function(e,i,n,s,o,r){let a,l;for(i||(i=3),n||(n=0),s?l=Math.min(s*i+n,e.length):l=e.length,a=n;a<l;a+=i)t[0]=e[a],t[1]=e[a+1],t[2]=e[a+2],o(t,t,r),e[a]=t[0],e[a+1]=t[1],e[a+2]=t[2];return e}})();function Gi(){let t=new dn(16);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function Nr(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function b2(t,e,i,n,s,o,r,a,l,c,d,h,u,f,m,p){let _=new dn(16);return _[0]=t,_[1]=e,_[2]=i,_[3]=n,_[4]=s,_[5]=o,_[6]=r,_[7]=a,_[8]=l,_[9]=c,_[10]=d,_[11]=h,_[12]=u,_[13]=f,_[14]=m,_[15]=p,_}function x2(t,e,i,n,s,o,r,a,l,c,d,h,u,f,m,p,_){return t[0]=e,t[1]=i,t[2]=n,t[3]=s,t[4]=o,t[5]=r,t[6]=a,t[7]=l,t[8]=c,t[9]=d,t[10]=h,t[11]=u,t[12]=f,t[13]=m,t[14]=p,t[15]=_,t}function ou(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function S2(t,e){if(t===e){let i=e[1],n=e[2],s=e[3],o=e[6],r=e[7],a=e[11];t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=i,t[6]=e[9],t[7]=e[13],t[8]=n,t[9]=o,t[11]=e[14],t[12]=s,t[13]=r,t[14]=a}else t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15];return t}function Ns(t,e){let i=e[0],n=e[1],s=e[2],o=e[3],r=e[4],a=e[5],l=e[6],c=e[7],d=e[8],h=e[9],u=e[10],f=e[11],m=e[12],p=e[13],_=e[14],g=e[15],y=i*a-n*r,b=i*l-s*r,v=i*c-o*r,I=n*l-s*a,S=n*c-o*a,P=s*c-o*l,T=d*p-h*m,L=d*_-u*m,B=d*g-f*m,O=h*_-u*p,w=h*g-f*p,x=u*g-f*_,C=y*x-b*w+v*O+I*B-S*L+P*T;return C?(C=1/C,t[0]=(a*x-l*w+c*O)*C,t[1]=(s*w-n*x-o*O)*C,t[2]=(p*P-_*S+g*I)*C,t[3]=(u*S-h*P-f*I)*C,t[4]=(l*B-r*x-c*L)*C,t[5]=(i*x-s*B+o*L)*C,t[6]=(_*v-m*P-g*b)*C,t[7]=(d*P-u*v+f*b)*C,t[8]=(r*w-a*B+c*T)*C,t[9]=(n*B-i*w-o*T)*C,t[10]=(m*S-p*v+g*y)*C,t[11]=(h*v-d*S-f*y)*C,t[12]=(a*L-r*O-l*T)*C,t[13]=(i*O-n*L+s*T)*C,t[14]=(p*b-m*I-_*y)*C,t[15]=(d*I-h*b+u*y)*C,t):null}function ri(t,e,i){let n=e[0],s=e[1],o=e[2],r=e[3],a=e[4],l=e[5],c=e[6],d=e[7],h=e[8],u=e[9],f=e[10],m=e[11],p=e[12],_=e[13],g=e[14],y=e[15],b=i[0],v=i[1],I=i[2],S=i[3];return t[0]=b*n+v*a+I*h+S*p,t[1]=b*s+v*l+I*u+S*_,t[2]=b*o+v*c+I*f+S*g,t[3]=b*r+v*d+I*m+S*y,b=i[4],v=i[5],I=i[6],S=i[7],t[4]=b*n+v*a+I*h+S*p,t[5]=b*s+v*l+I*u+S*_,t[6]=b*o+v*c+I*f+S*g,t[7]=b*r+v*d+I*m+S*y,b=i[8],v=i[9],I=i[10],S=i[11],t[8]=b*n+v*a+I*h+S*p,t[9]=b*s+v*l+I*u+S*_,t[10]=b*o+v*c+I*f+S*g,t[11]=b*r+v*d+I*m+S*y,b=i[12],v=i[13],I=i[14],S=i[15],t[12]=b*n+v*a+I*h+S*p,t[13]=b*s+v*l+I*u+S*_,t[14]=b*o+v*c+I*f+S*g,t[15]=b*r+v*d+I*m+S*y,t}function Zp(t,e,i){let n=i[0],s=i[1],o=i[2],r,a,l,c,d,h,u,f,m,p,_,g;return e===t?(t[12]=e[0]*n+e[4]*s+e[8]*o+e[12],t[13]=e[1]*n+e[5]*s+e[9]*o+e[13],t[14]=e[2]*n+e[6]*s+e[10]*o+e[14],t[15]=e[3]*n+e[7]*s+e[11]*o+e[15]):(r=e[0],a=e[1],l=e[2],c=e[3],d=e[4],h=e[5],u=e[6],f=e[7],m=e[8],p=e[9],_=e[10],g=e[11],t[0]=r,t[1]=a,t[2]=l,t[3]=c,t[4]=d,t[5]=h,t[6]=u,t[7]=f,t[8]=m,t[9]=p,t[10]=_,t[11]=g,t[12]=r*n+d*s+m*o+e[12],t[13]=a*n+h*s+p*o+e[13],t[14]=l*n+u*s+_*o+e[14],t[15]=c*n+f*s+g*o+e[15]),t}function Ha(t,e,i){let n=i[0],s=i[1],o=i[2];return t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n,t[3]=e[3]*n,t[4]=e[4]*s,t[5]=e[5]*s,t[6]=e[6]*s,t[7]=e[7]*s,t[8]=e[8]*o,t[9]=e[9]*o,t[10]=e[10]*o,t[11]=e[11]*o,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function ru(t,e,i){let n=Math.sin(i),s=Math.cos(i),o=e[4],r=e[5],a=e[6],l=e[7],c=e[8],d=e[9],h=e[10],u=e[11];return e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=o*s+c*n,t[5]=r*s+d*n,t[6]=a*s+h*n,t[7]=l*s+u*n,t[8]=c*s-o*n,t[9]=d*s-r*n,t[10]=h*s-a*n,t[11]=u*s-l*n,t}function $p(t,e,i){let n=Math.sin(i),s=Math.cos(i),o=e[0],r=e[1],a=e[2],l=e[3],c=e[8],d=e[9],h=e[10],u=e[11];return e!==t&&(t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=o*s-c*n,t[1]=r*s-d*n,t[2]=a*s-h*n,t[3]=l*s-u*n,t[8]=o*n+c*s,t[9]=r*n+d*s,t[10]=a*n+h*s,t[11]=l*n+u*s,t}function Wp(t,e,i){let n=Math.sin(i),s=Math.cos(i),o=e[0],r=e[1],a=e[2],l=e[3],c=e[4],d=e[5],h=e[6],u=e[7];return e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=o*s+c*n,t[1]=r*s+d*n,t[2]=a*s+h*n,t[3]=l*s+u*n,t[4]=c*s-o*n,t[5]=d*s-r*n,t[6]=h*s-a*n,t[7]=u*s-l*n,t}function cc(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=e[1],t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=e[2],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function Xp(t,e,i){let n=i[0],s=i[1],o=i[2],r=Math.sqrt(n*n+s*s+o*o),a,l,c;return Math.abs(r)<cn?null:(r=1/r,n*=r,s*=r,o*=r,a=Math.sin(e),l=Math.cos(e),c=1-l,t[0]=n*n*c+l,t[1]=s*n*c+o*a,t[2]=o*n*c-s*a,t[3]=0,t[4]=n*s*c-o*a,t[5]=s*s*c+l,t[6]=o*s*c+n*a,t[7]=0,t[8]=n*o*c+s*a,t[9]=s*o*c-n*a,t[10]=o*o*c+l,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t)}function M2(t,e,i,n){let s=e[0],o=e[1],r=e[2],a=e[3],l=s+s,c=o+o,d=r+r,h=s*l,u=s*c,f=s*d,m=o*c,p=o*d,_=r*d,g=a*l,y=a*c,b=a*d,v=n[0],I=n[1],S=n[2];return t[0]=(1-(m+_))*v,t[1]=(u+b)*v,t[2]=(f-y)*v,t[3]=0,t[4]=(u-b)*I,t[5]=(1-(h+_))*I,t[6]=(p+g)*I,t[7]=0,t[8]=(f+y)*S,t[9]=(p-g)*S,t[10]=(1-(h+m))*S,t[11]=0,t[12]=i[0],t[13]=i[1],t[14]=i[2],t[15]=1,t}function Yp(t,e,i,n,s,o,r){let a=1/(e-i),l=1/(n-s),c=1/(o-r);return t[0]=-2*a,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*l,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*c,t[11]=0,t[12]=(e+i)*a,t[13]=(s+n)*l,t[14]=(r+o)*c,t[15]=1,t}function Za(t,e,i,n){let s,o,r,a,l,c,d,h,u,f,m=e[0],p=e[1],_=e[2],g=n[0],y=n[1],b=n[2],v=i[0],I=i[1],S=i[2];return Math.abs(m-v)<cn&&Math.abs(p-I)<cn&&Math.abs(_-S)<cn?mat4.identity(t):(d=m-v,h=p-I,u=_-S,f=1/Math.sqrt(d*d+h*h+u*u),d*=f,h*=f,u*=f,s=y*u-b*h,o=b*d-g*u,r=g*h-y*d,f=Math.sqrt(s*s+o*o+r*r),f?(f=1/f,s*=f,o*=f,r*=f):(s=0,o=0,r=0),a=h*r-u*o,l=u*s-d*r,c=d*o-h*s,f=Math.sqrt(a*a+l*l+c*c),f?(f=1/f,a*=f,l*=f,c*=f):(a=0,l=0,c=0),t[0]=s,t[1]=a,t[2]=d,t[3]=0,t[4]=o,t[5]=l,t[6]=h,t[7]=0,t[8]=r,t[9]=c,t[10]=u,t[11]=0,t[12]=-(s*m+o*p+r*_),t[13]=-(a*m+l*p+c*_),t[14]=-(d*m+h*p+u*_),t[15]=1,t)}function qp(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]&&t[9]===e[9]&&t[10]===e[10]&&t[11]===e[11]&&t[12]===e[12]&&t[13]===e[13]&&t[14]===e[14]&&t[15]===e[15]}const Us=ri;function En(t,e,i){return t[0]=i[0],t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=i[1],t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=i[2],t[11]=0,t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=1,t}function xt(){let t=new dn(2);return t[0]=0,t[1]=0,t}function Kp(t){let e=new dn(2);return e[0]=t[0],e[1]=t[1],e}function au(t,e){let i=new dn(2);return i[0]=t,i[1]=e,i}function $a(t,e){return t[0]=e[0],t[1]=e[1],t}function Vt(t,e,i){return t[0]=e,t[1]=i,t}function An(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t}function I2(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t}function T2(t,e,i){return t[0]=Math.min(e[0],i[0]),t[1]=Math.min(e[1],i[1]),t}function E2(t,e,i){return t[0]=Math.max(e[0],i[0]),t[1]=Math.max(e[1],i[1]),t}function Ei(t,e,i){return t[0]=e[0]*i,t[1]=e[1]*i,t}function Un(t,e){var i=e[0]-t[0],n=e[1]-t[1];return Math.sqrt(i*i+n*n)}function lu(t){var e=t[0],i=t[1];return Math.sqrt(e*e+i*i)}function A2(t){var e=t[0],i=t[1];return e*e+i*i}function fs(t,e){var i=e[0],n=e[1],s=i*i+n*n;return s>0&&(s=1/Math.sqrt(s),t[0]=e[0]*s,t[1]=e[1]*s),t}function Vo(t,e){return t[0]*e[0]+t[1]*e[1]}function Jp(t,e,i,n){var s=e[0],o=e[1];return t[0]=s+n*(i[0]-s),t[1]=o+n*(i[1]-o),t}function mo(t,e){return t[0]===e[0]&&t[1]===e[1]}function P2(t,e){let i=t[0],n=t[1],s=e[0],o=e[1];return Math.abs(i-s)<=cn*Math.max(1,Math.abs(i),Math.abs(s))&&Math.abs(n-o)<=cn*Math.max(1,Math.abs(n),Math.abs(o))}const Qp=lu,Ai=I2,po=Un;(function(){let t=xt();return function(e,i,n,s,o,r){let a,l;for(i||(i=2),n||(n=0),s?l=Math.min(s*i+n,e.length):l=e.length,a=n;a<l;a+=i)t[0]=e[a],t[1]=e[a+1],o(t,t,r),e[a]=t[0],e[a+1]=t[1];return e}})();function Wa(){let t=new dn(4);return t[0]=0,t[1]=0,t[2]=0,t[3]=0,t}function L2(t,e,i,n){let s=new dn(4);return s[0]=t,s[1]=e,s[2]=i,s[3]=n,s}function dc(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}function C2(t,e,i,n,s){return t[0]=e,t[1]=i,t[2]=n,t[3]=s,t}function R2(t,e,i){return t[0]=e[0]*i[0],t[1]=e[1]*i[1],t[2]=e[2]*i[2],t[3]=e[3]*i[3],t}function Ur(t,e,i){return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t[3]=e[3]*i,t}function z2(t,e){let i=e[0],n=e[1],s=e[2],o=e[3],r=i*i+n*n+s*s+o*o;return r>0&&(r=1/Math.sqrt(r),t[0]=i*r,t[1]=n*r,t[2]=s*r,t[3]=o*r),t}function F2(t,e,i,n){let s=e[0],o=e[1],r=e[2],a=e[3];return t[0]=s+n*(i[0]-s),t[1]=o+n*(i[1]-o),t[2]=r+n*(i[2]-r),t[3]=a+n*(i[3]-a),t}function hc(t,e,i){let n=e[0],s=e[1],o=e[2],r=e[3];return t[0]=i[0]*n+i[4]*s+i[8]*o+i[12]*r,t[1]=i[1]*n+i[5]*s+i[9]*o+i[13]*r,t[2]=i[2]*n+i[6]*s+i[10]*o+i[14]*r,t[3]=i[3]*n+i[7]*s+i[11]*o+i[15]*r,t}function cu(t,e){let i=t[0],n=t[1],s=t[2],o=t[3],r=e[0],a=e[1],l=e[2],c=e[3];return Math.abs(i-r)<=cn*Math.max(1,Math.abs(i),Math.abs(r))&&Math.abs(n-a)<=cn*Math.max(1,Math.abs(n),Math.abs(a))&&Math.abs(s-l)<=cn*Math.max(1,Math.abs(s),Math.abs(l))&&Math.abs(o-c)<=cn*Math.max(1,Math.abs(o),Math.abs(c))}const D2=R2;(function(){let t=Wa();return function(e,i,n,s,o,r){let a,l;for(i||(i=4),n||(n=0),s?l=Math.min(s*i+n,e.length):l=e.length,a=n;a<l;a+=i)t[0]=e[a],t[1]=e[a+1],t[2]=e[a+2],t[3]=e[a+3],o(t,t,r),e[a]=t[0],e[a+1]=t[1],e[a+2]=t[2],e[a+3]=t[3];return e}})();const Ho=Wa();class Z{constructor(e,i){this.state=e,this.camera=i,this.position=[0,0,0]}static fromGeo(e,i=[0,0]){const s=Math.sin(ve(e[1])),o=e[0]*4294967296/360,r=Math.log((1+s)/(1-s))*4294967296/(4*Math.PI);let a=0;if(e.length>2){const l=Z.scaleFactor(e[1]);a=(e[2]??0)*Ge*l}return i[0]=o,i[1]=Be(r,-2147483648,2147483648),i[2]=a,i}static toGeo(e,i=[0,0]){i[0]=e[0]*360/4294967296;const n=-2*Math.PI/4294967296;if(i[1]=90-2*Ln(Math.atan(Math.exp(e[1]*n))),e[2]){const s=Z.scaleFactor(i[1]);i[2]=e[2]/Ge/s}return i}static scaleFactor(e){return 1/Math.cos(ve(e))}update(){const{center:e,rotation:i,zoom:n,pitch:s,size:o}=this.state,r=Wo(n,o),a=Math.max(r*Math.sin(s),1);this.position[0]=e[0]+Math.sin(i)*a,this.position[1]=e[1]-Math.cos(i)*a,this.position[2]=r*Math.cos(s)}project(e,i=!1,n=[NaN,NaN]){const{size:s,viewport:o}=this.state;Ho[0]=e[0],Ho[1]=e[1],Ho[2]=e[2],Ho[3]=1,hc(Ho,Ho,this.camera.viewProjectionMatrix);const[r,a,l,c]=Ho,d=c*2;if(i&&(l>d||l<-d||r>d||r<-d||a>d||a<-d))return n;const u=s[0]/2,f=s[1]/2;return n[0]=u+o.left+r*u/c,n[1]=f+o.top-a*f/c,n}unproject(e,i=[0,0,0]){const{size:n,viewport:s}=this.state;i[0]=(e[0]-s.left)/n[0]*2-1,i[1]=-((Math.max(this.camera.horizonPixelOffset,e[1])-s.top)/n[1])*2+1,i[2]=0,Tn(i,i,this.camera.viewProjectionMatrixInverse),i[0]-=this.position[0],i[1]-=this.position[1],i[2]-=this.position[2],Ui(i,i);const o=-this.position[2]/i[2];return i[0]=this.position[0]+i[0]*o,i[1]=this.position[1]+i[1]*o,i[2]=this.position[2]+i[2]*o,i}setState(e){this.state=e}}const Zo=Wa();function eg(t){return[t[2],t[0],t[1]]}class Yt{constructor(e,i){this.state=e,this.camera=i,this.position=[0,0,0],this.ivpMatrix=[],this.cachedVisibleArc=new ug(()=>{const n=Wo(this.state.zoom,this.state.size)/Ge;return Math.acos($o/($o+n))},()=>[this.state.zoom]),this.cachedPixelRadius=new ug(()=>{const n=Z.toGeo(this.state.center),s=j2(n,0,this.visibleArc),o=this.project(Yt.fromGeo(s));return o[0]-=this.state.viewport.left+this.state.size[0]/2+(this.state.padding.left-this.state.padding.right)/2,o[1]-=this.state.viewport.top+this.state.size[1]/2+(this.state.padding.top-this.state.padding.bottom)/2,Qp(o)},()=>[this.state.zoom,this.state.cameraConfig.fov,this.state.size[0],this.state.size[1],this.state.padding.bottom,this.state.padding.top,this.state.padding.left,this.state.padding.right,this.camera.globeMatrix[0]]),this.update()}get visibleArc(){return this.cachedVisibleArc.value}get pixelRadius(){return this.cachedPixelRadius.value}static fromGeo(e,i=[NaN,NaN,NaN]){const n=ve(e[0]),s=ve(e[1]),o=Math.cos(n),r=Math.sin(n),a=Math.cos(s),l=Math.sin(s),c=$o*Ge;return i[0]=r*a*c,i[1]=l*c,i[2]=o*a*c,i}static toGeo(e,i=[NaN,NaN]){const n=e[0],s=e[1],o=e[2],r=Math.sqrt(n*n+s*s+o*o),a=Math.asin(o/r),l=Math.atan2(s,n);return i[0]=Ln(l),i[1]=Ln(a),i}update(){const{state:e}=this,i=Z.toGeo(e.center),n=Wo(e.zoom,e.size)+$o*Ge,s=ve(i[0]),o=ve(i[1]),r=Math.cos(s),a=Math.sin(s),l=Math.cos(o),c=Math.sin(o);this.position=[a*l*n,c*n,r*l*n];const d=[0,0,1];Za(this.ivpMatrix,eg(this.position),[0,0,0],d),Us(this.ivpMatrix,this.camera.projectionMatrix,this.ivpMatrix),Ns(this.ivpMatrix,this.ivpMatrix)}project(e,i=!1,n=[NaN,NaN]){const{size:s,viewport:o}=this.state,r=Wa();Zo[0]=e[0],Zo[1]=e[1],Zo[2]=e[2],Zo[3]=1,hc(Zo,Zo,this.camera.globeMatrix),hc(r,Zo,this.camera.viewProjectionMatrix);const[a,l,c,d]=r,h=d*2;if(i&&(c>h||c<-h||a>h||a<-h||l>h||l<-h))return n[0]=NaN,n[1]=NaN,n;const f=s[0]/2,m=s[1]/2;return n[0]=f+o.left+a*f/d,n[1]=m+o.top-l*m/d,n}unproject(e,i,n=[NaN,NaN,NaN]){const{size:s,viewport:o}=this.state,r=[(e[0]-o.left)/s[0]*2-1,-((Math.max(0,e[1])-o.top)/s[1])*2+1,0],a=eg(this.position),l=[0,0,0,1];Tn(l,r,this.ivpMatrix);const c=Ui([],vi([],l,a)),d=Hp([],a),h=nu(d,c),u=f2(d)-h**2,f=($o*Ge)**2;if(u>f){if(i)return Yt.fromGeo(Z.toGeo(this.state.center));const{left:y,bottom:b,top:v,right:I}=this.state.padding,S=e[0]-o.left-s[0]/2-(y-I)/2,P=e[1]-o.top-s[1]/2-(v-b)/2,T=Ei([],fs([],[S,P]),this.pixelRadius-1);return T[0]=T[0]+o.left+s[0]/2+(y-I)/2,T[1]=T[1]+o.top+s[1]/2+(v-b)/2,this.unproject(T,!0,n)}const m=Math.sqrt(f-u),p=h-m,_=h+m,g=Math.min(p,_);return n[0]=a[0]+c[0]*g,n[1]=a[1]+c[1]*g,n[2]=a[2]+c[2]*g,n}setState(e){this.state=e}canSee(e){const i=Z.toGeo(this.state.center);return pc(i,e)<this.visibleArc}}function ji(t,e){return{min:t||au(1/0,1/0),max:e||au(-1/0,-1/0)}}function du(t){return ji(Z.fromGeo(t.southWest),Z.fromGeo(t.northEast))}function Vi(t,e){T2(t.min,t.min,e),E2(t.max,t.max,e)}function tg(t,e){t.min[0]=e.min[0],t.max[0]=e.max[0],t.min[1]=e.min[1],t.max[1]=e.max[1]}function uc(t){t.min[0]=1/0,t.max[0]=-1/0,t.min[1]=1/0,t.max[1]=-1/0}function Gr(t,e){return t[0]=e.min[0]+(e.max[0]-e.min[0])/2,t[1]=e.min[1]+(e.max[1]-e.min[1])/2,t}function jr(t,e,i){t[0]=Be(i[0],e.min[0],e.max[0]),t[1]=Be(i[1],e.min[1],e.max[1])}function O2(t,e){return e[0]<=t.max[0]&&e[0]>=t.min[0]&&e[1]<=t.max[1]&&e[1]>=t.min[1]}function B2(t,e){return e[1]<=t.max[1]&&e[1]>=t.min[1]}function hu(t,e,i=0){const n=t.min[0]+i<=e.max[0]-i&&e.min[0]+i<=t.max[0]-i,s=t.min[1]+i<=e.max[1]-i&&e.min[1]+i<=t.max[1]-i;return n&&s}function k2(t,e){return{min:[Math.max(t.min[0],e.min[0]),Math.max(t.min[1],e.min[1])],max:[Math.min(t.max[0],e.max[0]),Math.min(t.max[1],e.max[1])]}}function ig(t,e){const i=Gr([],t),n=(t.max[0]-t.min[0])/2*e,s=(t.max[1]-t.min[1])/2*e;t.min[0]=i[0]-n,t.min[1]=i[1]-s,t.max[0]=i[0]+n,t.max[1]=i[1]+s}const ng=6378137,uu=2*Math.PI*ng,Ge=4294967296/uu,Xa=En([],[-1,-1,0],[2,2,1]),fc=En([],[.5,.5,0],[.5,.5,1]),$o=ng*(Math.PI/2),Pi=2**15/4294967296;function fu(t,e,i,n,s,o,r=0){s[0]=(i[0]+n[0])/2,s[1]=(i[1]+n[1])/2;const a=t.project(i),l=t.project(n),c=t.project(s),d=po(c,e),h=po(a,e),u=po(l,e);if(d<o)return s;if(h<o)return i;if(u<o)return n;if(r>=10)return s;const f=h+d,m=u+d;return f>m?fu(t,e,n,s,s,o,r+1):fu(t,e,i,s,s,o,r+1)}function _u(t){return Math.max(t,Cp)}function Wo(t,e){const i=ln,n=_u(e[1])/2,s=4294967296/2**t,o=n/256*s,r=Math.tan(i.fov/2);return o/r}function N2(t,e){const i=ln;return Math.log(_u(e[1])*4294967296/(2*256*Math.tan(i.fov/2)*t))/Math.LN2}function sg(t){return Wh*Math.pow(2,-t)}function og(t){const i=Z.toGeo(t)[1],n=1/(2*Math.cos(ve(i)));return Math.log(n)/Math.log(2)}function rg(t,e){return 2**(Math.round(t)-e.coords[2])}function ag(t,e){const i=Z.scaleFactor(e[1]);return 1+t*(i-1)}function Xo(t,e){const i=og(e)*yc(9,10,t);return t+Be(i,-1,0)}function Ya(t,e){const i=og(e),n=i*yc(9,10+i,t);return t-Be(n,-1,0)}function Yo(t,e){return Mp*(t/Rr)/e}function Vr(t,e){return e*Ge*Z.scaleFactor(t[1])}function qo(t,e){const n=Math.PI/180,s=t[1]*n,o=e[1]*n,r=Math.sin((e[1]-t[1])*n/2),a=Math.sin((e[0]-t[0])*n/2),l=r*r+Math.cos(s)*Math.cos(o)*a*a,c=2*Math.atan2(Math.sqrt(l),Math.sqrt(1-l));return Math.round(6371e3*c)}function U2(t){let e=0;if(t.length>1)for(let i=0;i<t.length-1;i++)e+=qo(t[i],t[i+1]);return e}const _c=ji([-2147483648,-2147483648],[4294967296/2,4294967296/2]),mc=ji([-214748364800,-2147483648],[4294967296*100/2,4294967296/2]);function Hr(t){let n=t[0];if(n>=-2147483648&&n<=2147483648)return;const s=4294967296;n=((n- -2147483648)%s+s)%s+-2147483648,t[0]=n}function mu(t,e){return t*Math.pow(2,-e)*4294967296/256}function lg(t,e){return t*Math.pow(2,e)*256/4294967296}function pu(t,e){return t===0?-1/0:-Math.log(e*256/(t*4294967296))/Math.LN2}xt(),xt();function G2(t){const e=t[0],i=t[1];return Zr(e,-2147483648,2147483648)&&Zr(i,-2147483648,2147483648)}function gu(t,e,i,n,s,o,r={top:0,right:0,bottom:0,left:0},a={top:0,right:0,bottom:0,left:0},l,c){const d=ln,h=new hn({center:Z.fromGeo(t),zoom:e,rotation:ve(i),size:n,pitch:ve(s),viewport:r,padding:a,cameraConfig:d,globeMode:!1,styleState:{}}),u=Z.toGeo(h.flat.unproject(o)),f=Z.toGeo(h.flat.unproject([o[0]+l,o[1]+c]));return Math.max(1,qo(u,f))}function Li(t){const e=[...t];return G2(e)||(e[0]=(4294967296+(e[0]+2147483648)%4294967296)%4294967296-2147483648),e}function pc(t,e){const i=Math.cos(ve(e[0]-t[0])),n=Math.sin(ve(e[1])),s=Math.sin(ve(t[1])),o=Math.cos(ve(e[1])),r=Math.cos(ve(t[1]));return Math.acos(n*s+o*r*i)}function j2(t,e,i){const n=ve(t[0]),s=ve(t[1]),o=[0,0];return o[1]=Math.asin(Math.sin(s)*Math.cos(i)+Math.cos(s)*Math.sin(i)*Math.cos(e)),o[0]=n+Math.atan2(Math.sin(e)*Math.sin(i)*Math.cos(s),Math.cos(i)-Math.sin(s)*Math.sin(o[1])),[Ln(o[0]),Ln(o[1])]}const V2=[0,0,1],H2=Oe(),Pn=[0,0,0];class hn{constructor(e){this.state=e,this.position=[0,0,0],this.projectionMatrix=[],this.viewMatrix=[],this.viewMatrixTranspose=[],this.projectionMatrixInverse=[],this.viewProjectionMatrix=[],this.viewProjectionMatrixInverse=[],this.globeMatrix=[],this.ecefMvpMatrix=new Float32Array(16),this.flat2ecef=0,this.fogDistance=0,this.correctedPitch=0,this.correctedRotation=0,this.horizonPixelOffset=0,this.prevZoom=0,this.horizonPixelOffset=0,this.flat=new Z(e,this),this.ecef=new Yt(e,this),this.update()}get globeRatio(){return this.flat2ecef}setState(e){this.state=e,this.flat.setState(e),this.ecef.setState(e),this.update()}update(){const{globeMaxZoom:e}=In;this.flat2ecef=this.state.globeMode?Be(e-this.state.zoom,0,1):0,this.limitPitchRotation(),this.updatePosition(),this.updateViewMatrix(),this.updateProjectionMatrices(),this.state.pitch=this.correctedPitch,this.state.rotation=this.correctedRotation,this.flat.update(),this.ecef.update(),ri(this.viewProjectionMatrix,this.projectionMatrix,this.viewMatrix),Ns(this.viewProjectionMatrixInverse,this.viewProjectionMatrix),Ns(this.projectionMatrixInverse,this.projectionMatrix),S2(this.viewMatrixTranspose,this.viewMatrix),this.state.globeMode&&this.updateGlobeMatrix(),Us(this.ecefMvpMatrix,this.viewProjectionMatrix,this.globeMatrix),this.updateHorizonPixelOffset(),this.updateFogDistance()}project(e,i=!1,n=[NaN,NaN]){if(this.flat2ecef<Number.EPSILON)return this.flat.project(Z.fromGeo(e),i,n);if(this.flat2ecef>1-Number.EPSILON)return this.ecef.project(Yt.fromGeo(e),i,n);{const s=this.flat.project(Z.fromGeo(e),i),o=this.ecef.project(Yt.fromGeo(e),i);return Array.from(Ti(n,s,o,this.flat2ecef))}}unproject(e,i=[0,0],n=!1){if(this.flat2ecef<Number.EPSILON){const s=[0,0,0];return this.flat.unproject(e,s),Z.toGeo(s,i),i}else if(this.flat2ecef>1-Number.EPSILON){const s=[0,0,0];return this.ecef.unproject(e,!1,s),Yt.toGeo(s,i),i}else{const s=[0,0,0],o=[0,0,0];return this.flat.unproject(e,s),Z.toGeo(s,s),this.ecef.unproject(e,!1,o),Yt.toGeo(o,o),n?(fu(this,e,o,s,i,2),i[2]=0,i):(Ti(i,s,o,this.flat2ecef),i[2]=0,i)}}getViewportVertices(e){const{size:i,viewport:n}=this.state;let s={top:0,right:0,bottom:0,left:0};if(e!==void 0){const r=i[0]*e,a=i[1]*e;s={top:r,right:a,bottom:r,left:a}}return[this.flat.unproject([n.left+s.left,i[1]+n.top-s.bottom,0]),this.flat.unproject([i[0]+n.left-s.right,i[1]+n.top-s.bottom,0]),this.flat.unproject([i[0]+n.left-s.right,n.top+s.top,0]),this.flat.unproject([n.left+s.left,n.top+s.top,0])]}getHorizonPixelOffset(){return this.horizonPixelOffset}updatePosition(){const{center:e,zoom:i,size:n}=this.state,s=Wo(i,n);this.prevZoom=i;const o=Math.max(s*Math.sin(this.correctedPitch),1);this.position[0]=e[0]+Math.sin(this.correctedRotation)*o,this.position[1]=e[1]-Math.cos(this.correctedRotation)*o,this.position[2]=s*Math.cos(this.correctedPitch)}limitPitchRotation(){const e=this.state,{zoom:i,pitch:n,rotation:s,cameraConfig:o,styleState:r,lowZoomMaxPitch:a,maxPitch:l}=e,{pitchInterStartZoom:c,pitchInterEndZoom:d}=o,{globeInterEndZoom:h,globeMaxZoom:u}=In;if(this.correctedPitch=n,this.correctedRotation=s,i<d){const f=Math.max(0,i-c)/(d-c);this.correctedPitch=Math.min(n,$r(a??90,l??90,f))}if(r.globeEnabled&&i<h){const f=Math.max(0,i-u)/(h-u);if(this.correctedPitch=Math.min(this.correctedPitch,$r(0,l??90,f)),i<=u)this.correctedRotation=0;else if(i!==this.prevZoom){const m=0-s,p=(this.prevZoom-i)/(i-u);p>0&&(this.correctedRotation+=m*p%360)}}}updateProjectionMatrices(){const e=this.state.cameraConfig,i=e.fov;e.useDynamicNearFar||this.state.globeMode?this.updateNearFarState():this.restoreFixedNearFar();const{near:n,far:s}=e,{size:o,view:r}=this.correctViewAndSize(),a=o[0]/o[1];let l=n*Math.tan(i/2),c=2*l,d=a*c,h=-d/2;h+=r.x*d/o[0],l-=r.y*c/o[1],d*=r.width/o[0],c*=r.height/o[1];const u=h+d,f=l-c,m=this.projectionMatrix;m[0]=2*n/(u-h),m[5]=2*n/(l-f),m[8]=(u+h)/(u-h),m[9]=(l+f)/(l-f),m[10]=-(s+n)/(s-n),m[11]=-1,m[14]=-2*s*n/(s-n),m[1]=m[2]=m[3]=m[4]=m[6]=m[7]=m[12]=m[13]=m[15]=0,Ns(this.projectionMatrixInverse,this.projectionMatrix)}updateNearFarState(){const{zoom:e,cameraConfig:i}=this.state,n=this.position;if(e>Rp)i.near=ln.near;else{const r=.25*n[2],a=Math.min(16-e,1);i.near=r*a+ln.near*(1-a)}const s=(1-Math.min(e,20.5)/21)**2;i.far=ln.far*s}restoreFixedNearFar(){const{cameraConfig:e}=this.state;e.near=ln.near,e.far=ln.far}correctViewAndSize(){const{size:e,padding:i}=this.state,n=Math.max(0,i.top-i.bottom)*Math.tan(this.correctedPitch),s=_u(e[1])+n,o={x:(i.right-i.left)/2,y:(i.bottom-i.top)/2,width:e[0],height:e[1]};o.y+=(s-e[1])/2;const r=[e[0],s];return{view:o,size:r}}updateFogDistance(){const{center:e}=this.state,i=this.state.cameraConfig,n=su(this.position,e);this.fogDistance=Math.max(i.minFogDistance,n)}updateViewMatrix(){Za(this.viewMatrix,this.position,this.state.center,V2)}updateGlobeMatrix(){const e=this.globeMatrix,i=[0,0,0];ou(e);const n=Z.toGeo(this.state.center);gt(i,this.state.center[0],this.state.center[1],-this.state.center[2]-$o*Ge),Zp(this.globeMatrix,e,i),ru(e,e,ve(n[1])),$p(e,e,-ve(n[0]))}updateHorizonPixelOffset(){const{viewport:e,size:i,zoom:n}=this.state,s=this.flat.unproject([e.left,i[1]+e.top,0]),o=this.flat.unproject([e.left+i[0]/2,i[1]+e.top,0]),r=this.flat.unproject([i[0]+e.left,i[1]+e.top,0]);vi(Pn,r,s),g2(Pn,Pn,H2,ve(90)),Ui(Pn,Pn);const a=mu(i[1]*this.state.cameraConfig.perspectiveDistanceLimitRatio,n);Ni(Pn,Pn,a),Ot(Pn,o,Pn),this.flat.project(Pn,!1,Pn),this.horizonPixelOffset=Math.max(0,Math.ceil(Pn[1]))}}function Be(t,e,i){return t=Math.max(t,e),t=Math.min(t,i),t}function gc(t){return t===0||Number.isNaN(t)?t:t>0?1:-1}function vc(t,e){return[e[0]/t[0]*2-1,-(e[1]/t[1])*2+1]}function ve(t){return t*Math.PI/180}function Ln(t){return t/Math.PI*180}function qa(t,e,i){i.zoom!==void 0&&(i.zoom=Be(i.zoom,t.minZoom,t.maxZoom));const n={...t};Hr(n.center);const s=new hn(n),o=s.unproject(e),r=Z.fromGeo(o);i.center&&Hr(i.center),s.setState({...t,...i});const a=Z.fromGeo(s.unproject(e));Math.abs(r[0]-a[0])>2**31&&(a[0]+=(r[0]>0?1:-1)*2**32);const l=Oe();if(vi(l,r,a),t.globeMode&&Math.abs(o[1])>70&&t.zoom>In.globeInterStartZoom&&t.zoom<In.globeMaxZoom){const c=Math.abs(t.zoom-i.zoom);if(c>1e-4){const d=Math.abs(r[0]-a[0]),h=Math.log10(d/c),u=Math.min(1,10**(6-h));Number.isNaN(u)||Ni(l,l,u)}}return l}function cg(t){return t=t>>>0,t=t-1,t=t|t>>1,t=t|t>>2,t=t|t>>4,t=t|t>>8,t=t|t>>16,t+1}function Cn(t,e){const i={...e};for(const n in t)t[n]!==void 0&&(i[n]=t[n]);return i}function vu(t){const e={};for(const i in t){const n=t[i];e[n]=i}return e}function dg(t,e){const i=[];for(const n in t)e[n]||i.push(t[n]);return i}function yc(t,e,i){return Be((i-t)/(e-t),0,1)}function Z2(t){return t%1}function Zr(t,e,i){return t>=e&&t<=i}function yu(t,e){if(t.size!==e.size)return!1;for(const i of Array.from(t))if(!e.has(i))return!1;return!0}function hg(t,e){return t===e?!0:t.length!==e.length?!1:!t.some((i,n)=>i!==e[n])}function go(t,e){if(t===e)return!0;if(t&&e&&typeof t=="object"&&typeof e=="object"){const i=Array.isArray(t),n=Array.isArray(e);let s,o,r;if(i&&n){if(o=t.length,o!==e.length)return!1;for(s=o;s--!==0;)if(!go(t[s],e[s]))return!1;return!0}if(i!==n)return!1;const a=t instanceof Date,l=e instanceof Date;if(a!==l)return!1;if(a&&l)return t.getTime()===e.getTime();const c=t instanceof RegExp,d=e instanceof RegExp;if(c!==d)return!1;if(c&&d)return t.toString()===e.toString();const h=Object.keys(t);if(o=h.length,o!==Object.keys(e).length)return!1;for(s=o;s--!==0;)if(!Object.prototype.hasOwnProperty.call(e,h[s]))return!1;for(s=o;s--!==0;)if(r=h[s],!go(t[r],e[r]))return!1;return!0}return t!==t&&e!==e}function vo(t,e){const i=t.indexOf(e);return i!==-1?(t.splice(i,1),!0):!1}function $r(t,e,i){return t+(e-t)*i}function wu(t){return t==null}function Gn(t,e){const i=e;typeof t=="number"?i.fill(t):Array.isArray(t)&&typeof t[0]=="number"&&typeof t[1]=="number"&&typeof t[2]=="number"&&(i[0]=t[0],i[1]=t[1],i[2]=t[2])}class ug{constructor(e,i){this.getNewValidFor=i,this.getNewValue=e,this.currentValue=NaN,this.currentValidFor=new Array(i().length).fill(NaN)}get value(){const e=this.getNewValidFor();return this.currentValidFor.some((n,s)=>n!==e[s])&&(this.currentValidFor=e,this.currentValue=this.getNewValue()),this.currentValue}}function fg(t){return typeof t=="object"&&t!==null&&!Array.isArray(t)}function _g(){let t=new dn(9);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t}function $2(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10],t}function bu(){let t=new dn(4);return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t}function W2(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t}function X2(t,e,i){i=i*.5;let n=Math.sin(i);return t[0]=n*e[0],t[1]=n*e[1],t[2]=n*e[2],t[3]=Math.cos(i),t}function Y2(t,e,i){i*=.5;let n=e[0],s=e[1],o=e[2],r=e[3],a=Math.sin(i),l=Math.cos(i);return t[0]=n*l-o*a,t[1]=s*l+r*a,t[2]=o*l+n*a,t[3]=r*l-s*a,t}function q2(t,e,i){i*=.5;let n=e[0],s=e[1],o=e[2],r=e[3],a=Math.sin(i),l=Math.cos(i);return t[0]=n*l+s*a,t[1]=s*l-n*a,t[2]=o*l+r*a,t[3]=r*l-o*a,t}function xu(t,e,i,n){let s=e[0],o=e[1],r=e[2],a=e[3],l=i[0],c=i[1],d=i[2],h=i[3],u,f,m,p,_;return f=s*l+o*c+r*d+a*h,f<0&&(f=-f,l=-l,c=-c,d=-d,h=-h),1-f>1e-6?(u=Math.acos(f),m=Math.sin(u),p=Math.sin((1-n)*u)/m,_=Math.sin(n*u)/m):(p=1-n,_=n),t[0]=p*s+_*l,t[1]=p*o+_*c,t[2]=p*r+_*d,t[3]=p*a+_*h,t}function K2(t,e){let i=e[0]+e[4]+e[8],n;if(i>0)n=Math.sqrt(i+1),t[3]=.5*n,n=.5/n,t[0]=(e[5]-e[7])*n,t[1]=(e[6]-e[2])*n,t[2]=(e[1]-e[3])*n;else{let s=0;e[4]>e[0]&&(s=1),e[8]>e[s*3+s]&&(s=2);let o=(s+1)%3,r=(s+2)%3;n=Math.sqrt(e[s*3+s]-e[o*3+o]-e[r*3+r]+1),t[s]=.5*n,n=.5/n,t[3]=(e[o*3+r]-e[r*3+o])*n,t[o]=(e[o*3+s]+e[s*3+o])*n,t[r]=(e[r*3+s]+e[s*3+r])*n}return t}const mg=z2;(function(){let t=Oe(),e=at(1,0,0),i=at(0,1,0);return function(n,s,o){let r=nu(s,o);return r<-.999999?(kr(t,e,s),_o(t)<1e-6&&kr(t,i,s),Ui(t,t),X2(n,t,Math.PI),n):r>.999999?(n[0]=0,n[1]=0,n[2]=0,n[3]=1,n):(kr(t,s,o),n[0]=t[0],n[1]=t[1],n[2]=t[2],n[3]=1+r,mg(n,n))}})(),function(){let t=bu(),e=bu();return function(i,n,s,o,r,a){return xu(t,n,r,a),xu(e,s,o,a),xu(i,t,e,2*a*(1-a)),i}}(),function(){let t=_g();return function(e,i,n,s){return t[0]=n[0],t[3]=n[1],t[6]=n[2],t[1]=s[0],t[4]=s[1],t[7]=s[2],t[2]=-i[0],t[5]=-i[1],t[8]=-i[2],mg(e,K2(e,t))}}();const _s=[0,0,0],ms=[0,0,0],Su=Oe();_g();function jn(t,e,i,n,s){if(e!==n||i!==s){const o=s-i,r=e-n,a=1/Math.sqrt(o*o+r*r);t[0]=o*a,t[1]=r*a}else t[0]=0,t[1]=0}function pg(t,e,i,n){return vi(_s,i,e),vi(ms,i,n),kr(t,ms,_s),Ui(t,t),t}function ps(t,e,i,n,s){if(e!==n||i!==s){const o=n-e,r=s-i,a=1/Math.sqrt(o*o+r*r);t[0]=o*a,t[1]=r*a}else t[0]=0,t[1]=0}function gg(t,e,i,n,s){const o=e+n,r=i+s,a=e*o+i*r,l=5;if(a!==0){const c=1/a;t[0]=o*c,t[1]=r*c,lu(t)>l&&fs(t,t)}else t[0]=0,t[1]=0}function qt(t){return Be(t*127,-127,127)}function Mu(t,e=t){return t[0]=qt(e[0]),t[1]=qt(e[1]),t}function J2(t,e,i,n,s){t[0]=e*n+i*s,t[1]=i*n-e*s}function yo(t,e){const i=e[0];t[0]=-e[1],t[1]=i}function Iu(t,e){const i=e[0];t[0]=e[1],t[1]=-i}function vg(t){return t[0]===0&&t[1]===0}function wc(t,e){return Math.atan2(e[1]-t[1],e[0]-t[0])}function Tu(t,e){return[(t[0]+e[0])/2,(t[1]+e[1])/2]}function yg(t,e){const i=Math.sin(e),n=Math.cos(e),s=n*t[0]-i*t[1],o=i*t[0]+n*t[1];Vt(t,s,o)}function Q2(t,e,i,n,s=!0){if(mo(e,i)||mo(i,n)){Vt(t,0,0);return}Ai(_s,i,e),Ai(ms,n,i),s?(yo(_s,_s),yo(ms,ms)):(Iu(_s,_s),Iu(ms,ms)),fs(_s,_s),fs(ms,ms),An(t,_s,ms),fs(t,t)}function eS(t,e,i){e[0]=fo(gt(Su,t[0],t[1],t[2])),e[1]=fo(gt(Su,t[3],t[4],t[5])),e[2]=fo(gt(Su,t[6],t[7],t[8]))}function tS(t,e,i,n){e[0]=fo(at(t[0],t[1],t[2])),e[1]=fo(at(t[4],t[5],t[6])),e[2]=fo(at(t[8],t[9],t[10])),i[0]=t[12],i[1]=t[13],i[2]=t[14]}function wg(t,e,i,n){const[s,o]=t,[r,a]=e,[l,c]=i;return n[0]=Math.min(Math.max(s,r),l),n[1]=Math.min(Math.max(o,a),c),n[2]=0,n}function bg(t,e,i){if(t.length===0)return;const n=ve(e),s=ji();for(const r of t){const a=Z.fromGeo(r);yg(a,-n),Vi(s,a)}const o=Oe();return Gr(o,s),yg(o,n),{center:o,zoom:iS(s,i)}}function iS(t,e){return Math.min(pu(e[0],Math.abs(t.max[0]-t.min[0])),pu(e[1],Math.abs(t.max[1]-t.min[1])))}function nS(t,e,i){const n=bg(t,e,i);if(n)return{zoom:n.zoom,center:Z.toGeo(n.center)}}function Ht(t,e,i){const n=t.getBoundingClientRect();return[e-n.left-t.clientLeft,i-n.top-t.clientTop]}function Ko(t,e){const i=[];for(let n=0;n<t.length;n++)i[n]=Ht(e,t[n].clientX,t[n].clientY);return i}function Eu(t){return t.touches.length>1}const sS=Z.fromGeo,oS=Z.toGeo;function rS(t,e,i,n,s,o,r={top:0,right:0,bottom:0,left:0},a={top:0,right:0,bottom:0,left:0},l=!1){return new hn({center:Z.fromGeo(t),zoom:e,rotation:ve(i),size:n,pitch:ve(s),viewport:r,padding:a,cameraConfig:ln,globeMode:l,styleState:{}}).project(o)}function aS(t,e,i,n,s,o,r={top:0,right:0,bottom:0,left:0},a={top:0,right:0,bottom:0,left:0},l=!1){return new hn({center:Z.fromGeo(t),zoom:e,rotation:ve(i),size:n,pitch:ve(s),viewport:r,padding:a,cameraConfig:ln,globeMode:l,styleState:{}}).unproject(o)}function lS(t,e,i,n,s,o,r={top:0,right:0,bottom:0,left:0},a={top:0,right:0,bottom:0,left:0},l){return gu(t,e,i,n,s,o,r,a,l,l)}function cS(t,e){return new hn(t).project(Z.toGeo(e))}const dS=Object.freeze(Object.defineProperty({__proto__:null,geoLineDistance:U2,geoToMapDistance:Vr,getCenterZoomByPoints:nS,getMetersFromPixels:lS,getMousePositionInContainer:Ht,projectGeoToMap:sS,projectGeoToScreen:rS,projectMapToGeo:oS,projectMapToScreen:cS,projectScreenToGeo:aS},Symbol.toStringTag,{value:"Module"})),Au=/\{(\w+)\}/g;function Jo(t,e){return t.replace(Au,(i,n)=>e[n])}function xg(t){const[e,i]=t.split("?");if(!i)return e;const s=i.split("&").map(o=>o.split("=")).filter(([,o])=>o!=="undefined").map(o=>o.join("=")).join("&");return s.length?`${e}?${s}`:e}function Pu(t,e){return(typeof t=="object"?t.url:ac[t]).replace(Au,(i,n)=>e[n]??i).replace(Au,(i,n)=>e[n]??i)}function gs(t,e){const i=Jo(e.host,{subdomain:e.subdomain}),n=Jo(typeof t=="object"?t.url:ac[t],{...e,host:i});return xg(n)}function Ka(t,e){const i=Jo(t,e);return xg(i)}function Wr(t,e){let i=0;for(let n=0;n<e.length;n++)i+=e.charCodeAt(n);return t[i%t.length]}function hS(t,e){const i=new URL(e);return t.startsWith("//")?`${i.protocol}${t}`:t.startsWith("/")?`${i.origin}${t}`:t}function Ja(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var bc={},Sg;function uS(){return Sg||(Sg=1,function(){for(var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",e=new Uint8Array(256),i=0;i<t.length;i++)e[t.charCodeAt(i)]=i;bc.encode=function(n){var s=new Uint8Array(n),o,r=s.length,a="";for(o=0;o<r;o+=3)a+=t[s[o]>>2],a+=t[(s[o]&3)<<4|s[o+1]>>4],a+=t[(s[o+1]&15)<<2|s[o+2]>>6],a+=t[s[o+2]&63];return r%3===2?a=a.substring(0,a.length-1)+"=":r%3===1&&(a=a.substring(0,a.length-2)+"=="),a},bc.decode=function(n){var s=n.length*.75,o=n.length,r,a=0,l,c,d,h;n[n.length-1]==="="&&(s--,n[n.length-2]==="="&&s--);var u=new ArrayBuffer(s),f=new Uint8Array(u);for(r=0;r<o;r+=4)l=e[n.charCodeAt(r)],c=e[n.charCodeAt(r+1)],d=e[n.charCodeAt(r+2)],h=e[n.charCodeAt(r+3)],f[a++]=l<<2|c>>4,f[a++]=(c&15)<<4|d>>2,f[a++]=(d&3)<<6|h&63;return u}}()),bc}var Mg=uS();function fS(t){let e=0;for(let i=0;i<t.length;i++)e+=t[i]*256**(t.length-1-i);return e}function Lu(t){const e=new Uint8Array(6);for(let i=0;i<6;i++)e[i]=Math.floor(t/256**(5-i))&255;return encodeURIComponent(Mg.encode(e))}function _S(t,e){const i={};t.forEach((s,o)=>{i[s]=o});let n=t.length;i.selected=i.selected??n++,i.hovered=i.hovered??n++,i.dpi=i.dpi??n++,i.isRealtime=i.isRealtime??n++,i.pixelDensityPreset=i.pixelDensityPreset??n++,i.tier=i.tier??n++;for(const s in e)i[s]===void 0&&(i[s]=n++);return i}function Ig(t){const e=_S(t.tileProps,t.defaultProps),i={};for(const n in t.defaultProps)i[n]={index:e[n],value:t.defaultProps[n]};return{version:t.version,dictionaries:t.enumerationValues,reverseDictionaries:Object.keys(t.enumerationValues).reduce((n,s)=>(n[s]=vu(t.enumerationValues[s]),n),{}),tileProps:e,tilePropsByIndex:vu(e),defaultProps:i,vertexPropsLegacy:Cu(t.vertexProps)?mS(t):{},vertexProps:Cu(t.vertexProps)?[]:t.vertexProps}}function mS(t){const e=t.vertexProps,i={point:["x","y","z"],polygon:["x","y","cut","signed_z"],polyline:["x","y"]};if(!e)return i;if(!Cu(e))return console.warn(`Попытка сгенерировать vertexPropsLegacy для метатайла версии ${t.version}`),{};const n={0:"point",1:"polyline",2:"polygon"};return Object.keys(e).forEach(s=>{const o=n[s];if(typeof o>"u"){console.warn(`Неизвестный тип геометрии "${s}", нужно его поддержать`);return}i[o]=e[parseInt(s,10)]}),i}function pS(t,e){const i={};if(e)for(let n=0;n<e.length;n++)i[e[n]]=n;return Ig({enumerationValues:{db_sublayer:i},version:"7.0.0",defaultProps:{},tileProps:t,vertexProps:[]})}function Qa(t,e){const{tileProps:i}=t;let n=Object.keys(i).length;for(const s of e)i[s]===void 0&&(i[s]=n,n+=1)}let Ne=0;const yi={beginningIsCut:Ne++,class:Ne++,componentDistanceEnd:Ne++,componentDistanceStart:Ne++,db_icon_priority:Ne++,db_label_priority:Ne++,db_label2_priority:Ne++,dpi:Ne++,endingIsCut:Ne++,height:Ne++,db_hidden_by_plan_building_id:Ne++,db_hidden_by_plan_id:Ne++,id:Ne++,isRealtime:Ne++,db_label:Ne++,db_label2:Ne++,nextPointX:Ne++,nextPointY:Ne++,db_object_class:Ne++,objectLength:Ne++,pixelDensityPreset:Ne++,previousPointX:Ne++,previousPointY:Ne++,db_region:Ne++,selected:Ne++,hovered:Ne++,db_sublayer:Ne++,traffic_color:Ne++,traffic_road_class:Ne++,traffic_road_z_level:Ne++,db_tiers:Ne++,model_src:Ne++,linkedIds:Ne++,db_model_rotation_angle:Ne++,db_plan_id:Ne++,traffic_color2:Ne++},Gs={version:"5.0.0",tileProps:yi,tilePropsByIndex:vu(yi),defaultProps:{},dictionaries:{},reverseDictionaries:{},vertexPropsLegacy:{},vertexProps:[]},Hi=[],un={},Tg={sourceName:"zenith"};function Cu(t){return!Array.isArray(t)}const gS=Object.freeze(Object.defineProperty({__proto__:null,getMetersFromPixelsXY:gu,getUrl:gs,hashToString:Lu},Symbol.toStringTag,{value:"Module"}));let Qo=class{constructor(){this.events={}}on(e,i){let n=this.events[e];return n||(n=this.events[e]=[]),n.push(i),this}once(e,i){const n=s=>{this.off(e,n),i.call(this,s)};return this.on(e,n),this}off(e,i){const n=this.events[e];if(!n)return this;const s=n.indexOf(i);return s!==-1&&n.splice(s,1),this}emit(e,i){const n=this.events[e];if(!n)return this;const s=n.slice();for(let o=0;o<s.length;o++)s[o].call(this,i);return this}},vS=1;function Vn(){return vS++}let yS=1;const Hn=()=>++yS,Eg=Hn(),Ag=Hn();class Zi extends Qo{constructor(e,i,n){super(),this.interactive=i.interactive??!0,this.uniqId=String(Vn()),this.parentObject=n,this.modules=e.modules,this.mapState=e.state,this.tileObjects=[],this.identifyIds=[]}update(){this.mapState.needReplicasUpdate&&this.tileObjects.forEach(e=>{e.needSync=!0})}destroy(){const e=this.modules;this.tileObjects.forEach(i=>{i.clean(this.mapState),e.tileManager.removeObject(i)}),this.tileObjects=[],e.layers.removeLayer(this),e.renderer.addRerenderEvent()}getIdentifyData(){return this.identifyIds.map(e=>({dynamicObjectId:this.uniqId,metatileHash:-1,ids:e}))}isInteractive(){return this.interactive}}var xc={},Pg;function wS(){return Pg||(Pg=1,xc.read=function(t,e,i,n,s){var o,r,a=s*8-n-1,l=(1<<a)-1,c=l>>1,d=-7,h=i?s-1:0,u=i?-1:1,f=t[e+h];for(h+=u,o=f&(1<<-d)-1,f>>=-d,d+=a;d>0;o=o*256+t[e+h],h+=u,d-=8);for(r=o&(1<<-d)-1,o>>=-d,d+=n;d>0;r=r*256+t[e+h],h+=u,d-=8);if(o===0)o=1-c;else{if(o===l)return r?NaN:(f?-1:1)*(1/0);r=r+Math.pow(2,n),o=o-c}return(f?-1:1)*r*Math.pow(2,o-n)},xc.write=function(t,e,i,n,s,o){var r,a,l,c=o*8-s-1,d=(1<<c)-1,h=d>>1,u=s===23?Math.pow(2,-24)-Math.pow(2,-77):0,f=n?0:o-1,m=n?1:-1,p=e<0||e===0&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(a=isNaN(e)?1:0,r=d):(r=Math.floor(Math.log(e)/Math.LN2),e*(l=Math.pow(2,-r))<1&&(r--,l*=2),r+h>=1?e+=u/l:e+=u*Math.pow(2,1-h),e*l>=2&&(r++,l/=2),r+h>=d?(a=0,r=d):r+h>=1?(a=(e*l-1)*Math.pow(2,s),r=r+h):(a=e*Math.pow(2,h-1)*Math.pow(2,s),r=0));s>=8;t[i+f]=a&255,f+=m,a/=256,s-=8);for(r=r<<s|a,c+=s;c>0;t[i+f]=r&255,f+=m,r/=256,c-=8);t[i+f-m]|=p*128}),xc}var Ru,Lg;function bS(){if(Lg)return Ru;Lg=1,Ru=e;var t=wS();function e(w){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(w)?w:new Uint8Array(w||0),this.pos=0,this.type=0,this.length=this.buf.length}e.Varint=0,e.Fixed64=1,e.Bytes=2,e.Fixed32=5;var i=65536*65536,n=1/i,s=12,o=typeof TextDecoder>"u"?null:new TextDecoder("utf8");e.prototype={destroy:function(){this.buf=null},readFields:function(w,x,C){for(C=C||this.length;this.pos<C;){var V=this.readVarint(),M=V>>3,A=this.pos;this.type=V&7,w(M,x,this),this.pos===A&&this.skip(V)}return x},readMessage:function(w,x){return this.readFields(w,x,this.readVarint()+this.pos)},readFixed32:function(){var w=S(this.buf,this.pos);return this.pos+=4,w},readSFixed32:function(){var w=T(this.buf,this.pos);return this.pos+=4,w},readFixed64:function(){var w=S(this.buf,this.pos)+S(this.buf,this.pos+4)*i;return this.pos+=8,w},readSFixed64:function(){var w=S(this.buf,this.pos)+T(this.buf,this.pos+4)*i;return this.pos+=8,w},readFloat:function(){var w=t.read(this.buf,this.pos,!0,23,4);return this.pos+=4,w},readDouble:function(){var w=t.read(this.buf,this.pos,!0,52,8);return this.pos+=8,w},readVarint:function(w){var x=this.buf,C,V;return V=x[this.pos++],C=V&127,V<128||(V=x[this.pos++],C|=(V&127)<<7,V<128)||(V=x[this.pos++],C|=(V&127)<<14,V<128)||(V=x[this.pos++],C|=(V&127)<<21,V<128)?C:(V=x[this.pos],C|=(V&15)<<28,r(C,w,this))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var w=this.readVarint();return w%2===1?(w+1)/-2:w/2},readBoolean:function(){return!!this.readVarint()},readString:function(){var w=this.readVarint()+this.pos,x=this.pos;return this.pos=w,w-x>=s&&o?B(this.buf,x,w):L(this.buf,x,w)},readBytes:function(){var w=this.readVarint()+this.pos,x=this.buf.subarray(this.pos,w);return this.pos=w,x},readPackedVarint:function(w,x){if(this.type!==e.Bytes)return w.push(this.readVarint(x));var C=a(this);for(w=w||[];this.pos<C;)w.push(this.readVarint(x));return w},readPackedSVarint:function(w){if(this.type!==e.Bytes)return w.push(this.readSVarint());var x=a(this);for(w=w||[];this.pos<x;)w.push(this.readSVarint());return w},readPackedBoolean:function(w){if(this.type!==e.Bytes)return w.push(this.readBoolean());var x=a(this);for(w=w||[];this.pos<x;)w.push(this.readBoolean());return w},readPackedFloat:function(w){if(this.type!==e.Bytes)return w.push(this.readFloat());var x=a(this);for(w=w||[];this.pos<x;)w.push(this.readFloat());return w},readPackedDouble:function(w){if(this.type!==e.Bytes)return w.push(this.readDouble());var x=a(this);for(w=w||[];this.pos<x;)w.push(this.readDouble());return w},readPackedFixed32:function(w){if(this.type!==e.Bytes)return w.push(this.readFixed32());var x=a(this);for(w=w||[];this.pos<x;)w.push(this.readFixed32());return w},readPackedSFixed32:function(w){if(this.type!==e.Bytes)return w.push(this.readSFixed32());var x=a(this);for(w=w||[];this.pos<x;)w.push(this.readSFixed32());return w},readPackedFixed64:function(w){if(this.type!==e.Bytes)return w.push(this.readFixed64());var x=a(this);for(w=w||[];this.pos<x;)w.push(this.readFixed64());return w},readPackedSFixed64:function(w){if(this.type!==e.Bytes)return w.push(this.readSFixed64());var x=a(this);for(w=w||[];this.pos<x;)w.push(this.readSFixed64());return w},skip:function(w){var x=w&7;if(x===e.Varint)for(;this.buf[this.pos++]>127;);else if(x===e.Bytes)this.pos=this.readVarint()+this.pos;else if(x===e.Fixed32)this.pos+=4;else if(x===e.Fixed64)this.pos+=8;else throw new Error("Unimplemented type: "+x)},writeTag:function(w,x){this.writeVarint(w<<3|x)},realloc:function(w){for(var x=this.length||16;x<this.pos+w;)x*=2;if(x!==this.length){var C=new Uint8Array(x);C.set(this.buf),this.buf=C,this.length=x}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(w){this.realloc(4),P(this.buf,w,this.pos),this.pos+=4},writeSFixed32:function(w){this.realloc(4),P(this.buf,w,this.pos),this.pos+=4},writeFixed64:function(w){this.realloc(8),P(this.buf,w&-1,this.pos),P(this.buf,Math.floor(w*n),this.pos+4),this.pos+=8},writeSFixed64:function(w){this.realloc(8),P(this.buf,w&-1,this.pos),P(this.buf,Math.floor(w*n),this.pos+4),this.pos+=8},writeVarint:function(w){if(w=+w||0,w>268435455||w<0){c(w,this);return}this.realloc(4),this.buf[this.pos++]=w&127|(w>127?128:0),!(w<=127)&&(this.buf[this.pos++]=(w>>>=7)&127|(w>127?128:0),!(w<=127)&&(this.buf[this.pos++]=(w>>>=7)&127|(w>127?128:0),!(w<=127)&&(this.buf[this.pos++]=w>>>7&127)))},writeSVarint:function(w){this.writeVarint(w<0?-w*2-1:w*2)},writeBoolean:function(w){this.writeVarint(!!w)},writeString:function(w){w=String(w),this.realloc(w.length*4),this.pos++;var x=this.pos;this.pos=O(this.buf,w,this.pos);var C=this.pos-x;C>=128&&u(x,C,this),this.pos=x-1,this.writeVarint(C),this.pos+=C},writeFloat:function(w){this.realloc(4),t.write(this.buf,w,this.pos,!0,23,4),this.pos+=4},writeDouble:function(w){this.realloc(8),t.write(this.buf,w,this.pos,!0,52,8),this.pos+=8},writeBytes:function(w){var x=w.length;this.writeVarint(x),this.realloc(x);for(var C=0;C<x;C++)this.buf[this.pos++]=w[C]},writeRawMessage:function(w,x){this.pos++;var C=this.pos;w(x,this);var V=this.pos-C;V>=128&&u(C,V,this),this.pos=C-1,this.writeVarint(V),this.pos+=V},writeMessage:function(w,x,C){this.writeTag(w,e.Bytes),this.writeRawMessage(x,C)},writePackedVarint:function(w,x){x.length&&this.writeMessage(w,f,x)},writePackedSVarint:function(w,x){x.length&&this.writeMessage(w,m,x)},writePackedBoolean:function(w,x){x.length&&this.writeMessage(w,g,x)},writePackedFloat:function(w,x){x.length&&this.writeMessage(w,p,x)},writePackedDouble:function(w,x){x.length&&this.writeMessage(w,_,x)},writePackedFixed32:function(w,x){x.length&&this.writeMessage(w,y,x)},writePackedSFixed32:function(w,x){x.length&&this.writeMessage(w,b,x)},writePackedFixed64:function(w,x){x.length&&this.writeMessage(w,v,x)},writePackedSFixed64:function(w,x){x.length&&this.writeMessage(w,I,x)},writeBytesField:function(w,x){this.writeTag(w,e.Bytes),this.writeBytes(x)},writeFixed32Field:function(w,x){this.writeTag(w,e.Fixed32),this.writeFixed32(x)},writeSFixed32Field:function(w,x){this.writeTag(w,e.Fixed32),this.writeSFixed32(x)},writeFixed64Field:function(w,x){this.writeTag(w,e.Fixed64),this.writeFixed64(x)},writeSFixed64Field:function(w,x){this.writeTag(w,e.Fixed64),this.writeSFixed64(x)},writeVarintField:function(w,x){this.writeTag(w,e.Varint),this.writeVarint(x)},writeSVarintField:function(w,x){this.writeTag(w,e.Varint),this.writeSVarint(x)},writeStringField:function(w,x){this.writeTag(w,e.Bytes),this.writeString(x)},writeFloatField:function(w,x){this.writeTag(w,e.Fixed32),this.writeFloat(x)},writeDoubleField:function(w,x){this.writeTag(w,e.Fixed64),this.writeDouble(x)},writeBooleanField:function(w,x){this.writeVarintField(w,!!x)}};function r(w,x,C){var V=C.buf,M,A;if(A=V[C.pos++],M=(A&112)>>4,A<128||(A=V[C.pos++],M|=(A&127)<<3,A<128)||(A=V[C.pos++],M|=(A&127)<<10,A<128)||(A=V[C.pos++],M|=(A&127)<<17,A<128)||(A=V[C.pos++],M|=(A&127)<<24,A<128)||(A=V[C.pos++],M|=(A&1)<<31,A<128))return l(w,M,x);throw new Error("Expected varint not more than 10 bytes")}function a(w){return w.type===e.Bytes?w.readVarint()+w.pos:w.pos+1}function l(w,x,C){return C?x*4294967296+(w>>>0):(x>>>0)*4294967296+(w>>>0)}function c(w,x){var C,V;if(w>=0?(C=w%4294967296|0,V=w/4294967296|0):(C=~(-w%4294967296),V=~(-w/4294967296),C^4294967295?C=C+1|0:(C=0,V=V+1|0)),w>=18446744073709552e3||w<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");x.realloc(10),d(C,V,x),h(V,x)}function d(w,x,C){C.buf[C.pos++]=w&127|128,w>>>=7,C.buf[C.pos++]=w&127|128,w>>>=7,C.buf[C.pos++]=w&127|128,w>>>=7,C.buf[C.pos++]=w&127|128,w>>>=7,C.buf[C.pos]=w&127}function h(w,x){var C=(w&7)<<4;x.buf[x.pos++]|=C|((w>>>=3)?128:0),w&&(x.buf[x.pos++]=w&127|((w>>>=7)?128:0),w&&(x.buf[x.pos++]=w&127|((w>>>=7)?128:0),w&&(x.buf[x.pos++]=w&127|((w>>>=7)?128:0),w&&(x.buf[x.pos++]=w&127|((w>>>=7)?128:0),w&&(x.buf[x.pos++]=w&127)))))}function u(w,x,C){var V=x<=16383?1:x<=2097151?2:x<=268435455?3:Math.floor(Math.log(x)/(Math.LN2*7));C.realloc(V);for(var M=C.pos-1;M>=w;M--)C.buf[M+V]=C.buf[M]}function f(w,x){for(var C=0;C<w.length;C++)x.writeVarint(w[C])}function m(w,x){for(var C=0;C<w.length;C++)x.writeSVarint(w[C])}function p(w,x){for(var C=0;C<w.length;C++)x.writeFloat(w[C])}function _(w,x){for(var C=0;C<w.length;C++)x.writeDouble(w[C])}function g(w,x){for(var C=0;C<w.length;C++)x.writeBoolean(w[C])}function y(w,x){for(var C=0;C<w.length;C++)x.writeFixed32(w[C])}function b(w,x){for(var C=0;C<w.length;C++)x.writeSFixed32(w[C])}function v(w,x){for(var C=0;C<w.length;C++)x.writeFixed64(w[C])}function I(w,x){for(var C=0;C<w.length;C++)x.writeSFixed64(w[C])}function S(w,x){return(w[x]|w[x+1]<<8|w[x+2]<<16)+w[x+3]*16777216}function P(w,x,C){w[C]=x,w[C+1]=x>>>8,w[C+2]=x>>>16,w[C+3]=x>>>24}function T(w,x){return(w[x]|w[x+1]<<8|w[x+2]<<16)+(w[x+3]<<24)}function L(w,x,C){for(var V="",M=x;M<C;){var A=w[M],E=null,k=A>239?4:A>223?3:A>191?2:1;if(M+k>C)break;var D,U,N;k===1?A<128&&(E=A):k===2?(D=w[M+1],(D&192)===128&&(E=(A&31)<<6|D&63,E<=127&&(E=null))):k===3?(D=w[M+1],U=w[M+2],(D&192)===128&&(U&192)===128&&(E=(A&15)<<12|(D&63)<<6|U&63,(E<=2047||E>=55296&&E<=57343)&&(E=null))):k===4&&(D=w[M+1],U=w[M+2],N=w[M+3],(D&192)===128&&(U&192)===128&&(N&192)===128&&(E=(A&15)<<18|(D&63)<<12|(U&63)<<6|N&63,(E<=65535||E>=1114112)&&(E=null))),E===null?(E=65533,k=1):E>65535&&(E-=65536,V+=String.fromCharCode(E>>>10&1023|55296),E=56320|E&1023),V+=String.fromCharCode(E),M+=k}return V}function B(w,x,C){return o.decode(w.subarray(x,C))}function O(w,x,C){for(var V=0,M,A;V<x.length;V++){if(M=x.charCodeAt(V),M>55295&&M<57344)if(A)if(M<56320){w[C++]=239,w[C++]=191,w[C++]=189,A=M;continue}else M=A-55296<<10|M-56320|65536,A=null;else{M>56319||V+1===x.length?(w[C++]=239,w[C++]=191,w[C++]=189):A=M;continue}else A&&(w[C++]=239,w[C++]=191,w[C++]=189,A=null);M<128?w[C++]=M:(M<2048?w[C++]=M>>6|192:(M<65536?w[C++]=M>>12|224:(w[C++]=M>>18|240,w[C++]=M>>12&63|128),w[C++]=M>>6&63|128),w[C++]=M&63|128)}return C}return Ru}var xS=bS();const Sc=Ja(xS);Array(16);function wo(t,e){return{a:t[1]-e[1],b:e[0]-t[0],c:t[0]*e[1]-e[0]*t[1]}}function Mc(t,e){return Math.abs(Cg(t,e))}function Cg(t,e){return(e.a*t[0]+e.b*t[1]+e.c)/Math.sqrt(e.a*e.a+e.b*e.b)}function SS(t,e,i){const{a:n,b:s,c:o}=wo(t,e);return at(i,-(n*i+o)/s,0)}function MS(t,e,i){const{a:n,b:s,c:o}=wo(t,e);return at(-(s*i+o)/n,i,0)}const er=ji(),$i=ji();function Rg(t,e,i){const n=e[e.length-1]*i;let s=t[0],o=0;const r=[s];let a=1,l;for(;a<t.length&&!l;){const c=t[a],d=e[a];let h=c;if(d>n){if(!l){const u=(n-o)/(d-o);l=[],Jp(l,s,c,u)}h=l}r.push(h),s=h,o=e[a],a++}return r}function zg(t,e){let i=t[0];uc(er),Vi(er,i);let n=[i];const s=[n];let o=1;for(;o<t.length;){const r=t[o];let a=!1,l=r;if(tg($i,er),Vi($i,l),$i.max[0]-$i.min[0]>e){const c=$i.max[0]===l[0]?$i.min[0]+e:$i.max[0]-e;l=SS(i,l,c),a=!0}if(a&&(tg($i,er),Vi($i,l)),$i.max[1]-$i.min[1]>e){const c=$i.max[1]===l[1]?$i.min[1]+e:$i.max[1]-e;l=MS(i,l,c),a=!0}a?(n.push(l),uc(er),Vi(er,l),n=[l],s.push(n),i=l):(n.push(r),Vi(er,r),i=r,o++)}return s}function IS(t,e,i){const n=t[0]-e[0],s=t[1]-e[1],o=i[0]-e[0],r=i[1]-e[1],a=n*o+s*r,l=o*o+r*r,c=l!==0?a/l:0;return c<0?e:c>1?i:[e[0]+c*o,e[1]+c*r]}function bo(t){const e=t[0][0],i=t[0][1],n=t[1][0],s=t[1][1],o=t[2][0],r=t[2][1],a=t[3][0],l=t[3][1];return{min:[Math.min(e,n,o,a),Math.min(i,s,r,l)],max:[Math.max(e,n,o,a),Math.max(i,s,r,l)]}}function TS(t){return[[t[0][0],t[0][1],t[0][2]],[t[1][0],t[1][1],t[1][2]],[t[2][0],t[2][1],t[2][2]],[t[3][0],t[3][1],t[3][2]]]}function tr(t,e){const i=bo(t);if(!hu(e,i))return!1;const n=[wo(t[3],t[2]),wo(t[1],t[0]),wo(t[0],t[3]),wo(t[2],t[1])],s=[e.min,e.max,[e.min[0],e.max[1]],[e.max[0],e.min[1]]];for(const o of n){let r=!0;for(let a=0;a<s.length;a++){const l=s[a];if(o.a*l[0]+o.b*l[1]+o.c<0){r=!1;break}}if(r)return!1}return!0}function ES(t,e,i){t.forEach(n=>{const s=1+e/Vp(i,n);Ti(n,i,n,s)})}const Ic={};var Zn=Ic.TileRequestUrl={};Zn.read=function(t,e){return t.readFields(Zn._readField,{tiles:[]},e)},Zn._readField=function(t,e,i){t===1&&e.tiles.push(Zn.Tile.read(i,i.readVarint()+i.pos))},Zn.write=function(t,e){if(t.tiles)for(var i=0;i<t.tiles.length;i++)e.writeMessage(1,Zn.Tile.write,t.tiles[i])},Zn.Tile={},Zn.Tile.read=function(t,e){return t.readFields(Zn.Tile._readField,{x:0,y:0,zoom:0},e)},Zn.Tile._readField=function(t,e,i){t===1?e.x=i.readVarint():t===2?e.y=i.readVarint():t===3&&(e.zoom=i.readVarint())},Zn.Tile.write=function(t,e){t.x&&e.writeVarintField(1,t.x),t.y&&e.writeVarintField(2,t.y),t.zoom&&e.writeVarintField(3,t.zoom)};var ei=Ic.TileResponseData={};ei.read=function(t,e){return t.readFields(ei._readField,{tileGroups:[]},e)},ei._readField=function(t,e,i){t===1&&e.tileGroups.push(ei.TileGroup.read(i,i.readVarint()+i.pos))},ei.write=function(t,e){if(t.tileGroups)for(var i=0;i<t.tileGroups.length;i++)e.writeMessage(1,ei.TileGroup.write,t.tileGroups[i])},ei.TileGroup={},ei.TileGroup.read=function(t,e){return t.readFields(ei.TileGroup._readField,{x:0,y:0,zoom:0,tiles:[]},e)},ei.TileGroup._readField=function(t,e,i){t===1?e.x=i.readVarint():t===2?e.y=i.readVarint():t===3?e.zoom=i.readVarint():t===4&&e.tiles.push(ei.TileGroup.Tile.read(i,i.readVarint()+i.pos))},ei.TileGroup.write=function(t,e){if(t.x&&e.writeVarintField(1,t.x),t.y&&e.writeVarintField(2,t.y),t.zoom&&e.writeVarintField(3,t.zoom),t.tiles)for(var i=0;i<t.tiles.length;i++)e.writeMessage(4,ei.TileGroup.Tile.write,t.tiles[i])},ei.TileGroup.Tile={},ei.TileGroup.Tile.read=function(t,e){return t.readFields(ei.TileGroup.Tile._readField,{regionId:0,hash:null,data:null},e)},ei.TileGroup.Tile._readField=function(t,e,i){t===1?e.regionId=i.readVarint():t===2?e.hash=i.readBytes():t===3&&(e.data=i.readBytes())},ei.TileGroup.Tile.write=function(t,e){t.regionId&&e.writeVarintField(1,t.regionId),t.hash&&e.writeBytesField(2,t.hash),t.data&&e.writeBytesField(3,t.data)};const Fg=[0,0,0];function Ye(t){return{coords:t,size:Mt(t[2]),offset:Wi(t)}}function Ce(t){return`${t[0]}_${t[1]}_${t[2]}_${t[3]}`}function AS(t,e){return`${Ce(t)}_${e.stringify()}`}function zu(t){const e=t.split("_");return[parseInt(e[0],10),parseInt(e[1],10),parseInt(e[2],10),parseInt(e[3],10)]}function Dg(t){return Xe.subdomains[Math.abs(t[0]+t[1])%Xe.subdomains.length]}function PS(t){const e=new Sc(t),i=Ic.TileResponseData.read(e),{x:n,y:s,zoom:o,tiles:r}=i.tileGroups[0];return r.map(({regionId:a,hash:l,data:c})=>(c||(console.warn(`Tile ${o}_${n}_${s} from region ${a} is corrupt (has no data)`),c=new Uint8Array(0)),{data:c,regionId:a,metatileHash:fS(l)}))}function LS(t){return t.map(e=>({regionId:e.regionId,metatileHash:e.metatileHash}))}function CS(t){const e=Math.ceil(t.byteLength/4)*4,i=new ArrayBuffer(e);return new Uint8Array(i).set(t),i}function xo(t){const[e,i,n]=t;return{min:Wi([e,i,n,n]),max:Wi([e+1,i+1,n,n])}}function RS(t,e){return hu(xo(t),xo(e),.001)}function Xr(t,e,i,n=0){const s=xo(t);return s.min[0]-=n,s.min[1]-=n,s.max[0]+=n,s.max[1]+=n,i.environmentManager.isAABBInFog(s)?!1:tr(e,s)}function zS(t){return Math.trunc(t/2)*2+1}function Fu(t,e=1,i=3,n=!1){let s=1/Math.cos(ve(t));return n&&(s=Math.log2(s)),Be(Math.ceil(s),e,i)-1}const FS=(t,e)=>(isNaN(t[0])||t[0]===e[0])&&(isNaN(t[1])||t[1]===e[1])&&(isNaN(t[2])||t[2]===e[2])&&(isNaN(t[3])||t[3]===e[3]);function Og(t,e,i){const n=DS(e,t.size),s=Math.trunc(e),o=Array.from(t.center);Hr(o);const r=Z.toGeo(o),a={min:[r[0]-Be(n*2,0,90),Be(r[1]-n,-85,85)],max:[r[0]+Be(n*2,0,90),Be(r[1]+n,-85,85)]},l=Math.max(Fu(a.min[1],2,4),Fu(a.max[1],2,4)),c=Math.max(i,s-l),d=Kr(o,c);d[0]=Math.trunc(d[0]),d[1]=Math.trunc(d[1]);const h=new hn(t),u=Bg(t,h,r),f=$S(d,r,u,h,t),m=[];return f.forEach(p=>{FS([NaN,2,2,NaN],p)?m.push(...Ng(p,1)):m.push(p)}),m.filter(p=>Ac(t,h,p))}function DS(t,e){const i=$o*Ge,n=Wo(t,e)+i,s=ln.fov/2,o=Math.sin(s),r=Math.cos(s),a=i/n;let l=Ln(Math.acos(o**2/a+r*Math.sqrt(1-o**2/a**2)));return Number.isNaN(l)&&(l=90),l}function Bg(t,e,i){const n=Yt.toGeo(e.ecef.unproject([t.viewport.left,t.viewport.top]));return Math.min(3*Math.max(pc(n,i)),e.ecef.visibleArc)}function OS(t,e,i,n,s,o){const[r,a,l]=t,c=kS(t),d=n>=5?2:1,h=Fu((c.max[1]+c.min[1])/2,d,3,!0),u=Math.max(Math.abs(c.min[1]),Math.abs(c.max[1])),f=Math.max(i,n-h);return l>=f||u>70&&o>0||u>82||pc(e,[(c.max[0]+c.min[0])/2,(c.max[1]+c.min[1])/2])>.75*s}function BS(t,e){const n=Math.trunc(t.zoom),s=Array.from(t.center);Hr(s),Z.toGeo(s,s);const o=[],r=new hn(t),a=Bg(t,r,s);function l(c,d=0){if(Vg(s,a,c)&&Ac(t,r,c))if(OS(c,s,2,n,r.ecef.visibleArc,d))o.push(c);else for(const h of Ng(c,1))l(h,d+1)}return Og(t,Math.trunc(t.zoom),2).map(([c,d,h])=>{l([c,d,h,e])}),o}function kS(t){return{min:kg(t),max:kg([t[0]+1,t[1]+1,t[2],t[3]])}}function kg(t){const e=Wi(t);return Z.toGeo(e)}function Du(t,e,i,n,s,o=0,r=1/0,a=!1){if(t.globeMode)return BS(t,s);a&&(i=zS(i),i>r&&(i-=2));const l=bo(t.tilesBounds),c=Mt(i),d=2**i,h=Math.floor((l.min[0]+2147483648-o)/c),u=Math.floor((l.max[0]+2147483648+o)/c),f=Math.max(Math.floor((l.min[1]+2147483648-o)/c),0),m=Math.min(Math.floor((l.max[1]+2147483648+o)/c),d-1),p=[],_=new Set;for(let g=h;g<=u;g++)for(let y=f;y<=m;y++){const b=[g,y,i,s];if(Xr(b,t.tilesBounds,e,o)){b[0]=(d+b[0]%d)%d;const v=Ce(b);_.has(v)||(_.add(v),p.push(b))}}return t.demMode&&NS(p,t,e,i,n,s),p}function NS(t,e,i,n,s,o){const r=new Set(t.map(Ce)),a=new Set,l=TS(e.tilesBounds);let c=t.slice();for(let d=n;d>=s;d--){let h=0;const u=[];c.forEach(v=>{const I=US(v),S=Ce(I);a.has(S)||(u.push(I),a.add(S),GS(I,P=>{const T=Ce(P);!r.has(T)&&!a.has(T)&&Xr(P,e.extendedTilesBounds,i)&&(t.push(P),r.add(T),h++)}))});const f=Mt(d-1);ES(l,f,e.center);const m=bo(l),p=2**(d-1),_=Math.floor((m.min[0]+2147483648)/f),g=Math.floor((m.max[0]+2147483648)/f),y=Math.max(Math.floor((m.min[1]+2147483648)/f),0),b=Math.min(Math.floor((m.max[1]+2147483648)/f),p-1);for(let v=_;v<=g;v++)for(let I=y;I<=b;I++){const S=[v,I,d-1,o];S[0]=(p+S[0]%p)%p;const P=Ce(S);!a.has(P)&&Xr(S,l,i)&&(u.push(S),h++)}if(!h)break;c=u}}function US(t,e=1){const[i,n,s,o]=t,r=Math.pow(2,e);return[Math.trunc(i/r),Math.trunc(n/r),s-e,o]}function Ng(t,e){const[i,n,s,o]=t,r=Math.pow(2,e),a=[];for(let l=0;l<r;l++)for(let c=0;c<r;c++)a.push([i*r+l,n*r+c,s+e,o]);return a}function GS(t,e){let[i,n,s]=t;const o=t[3];i*=2,n*=2,s++,e([i,n,s,o]),e([i+1,n,s,o]),e([i,n+1,s,o]),e([i+1,n+1,s,o])}function jS(t,e,i,n,s,o,r,a,l,c,d,h){const u=new Sc,f={tiles:[{x:s[0],y:s[1],zoom:s[2]}]};Ic.TileRequestUrl.write(f,u);const m={x:s[0].toString(),y:s[1].toString(),z:s[2].toString(),protocol:i,host:t,subdomain:n[Math.abs(s[0]+s[1])%n.length],tileSet:e,lang:a,appId:r,tileKey:o,sessionId:d,defaultLang:c,dt:h==null?void 0:h.join(","),request:encodeURIComponent(Mg.encode(u.finish()))};return gs(l?{url:l}:"tiles",m)}function VS(t,e){const i=t.coords,n=e.coords,s=i[2],o=n[2];return s===o?i[0]===n[0]&&i[1]===n[1]:s<o?Ou(t,e):Ou(e,t)}function Ou(t,e){if(e.zoomLevel<t.zoomLevel)return!1;if(e.zoomLevel===t.zoomLevel)return e.coords[0]===t.coords[0]&&e.coords[1]===t.coords[1]&&e.detailLevel>t.detailLevel;const i=Math.pow(2,e.coords[2]-t.coords[2]),n=t.coords[0]*i,s=n+i,o=t.coords[1]*i,r=o+i,a=e.coords[0],l=e.coords[1];return a>=n&&a<s&&l>=o&&l<r}function HS(t,e,i){const{coords:n}=t,s=Math.min(e,i),o=Math.pow(2,t.zoomLevel-s),r=[Math.floor(n[0]/o),Math.floor(n[1]/o),s,e];return Ce(r)}function Bu(t,e,i,n){const s=HS(e,i,n);return t[s]}function Ug(t,e,i){const n=[];for(const s in t){const o=t[s];i(o)&&Ou(e,o)&&n.push(o)}return n}function Yr(t,e,i){return Un(t,jg(e.coords))-Un(t,jg(i.coords))}function $n(t,e,i){t[0]=e[0]*i.size/xe+i.offset[0],t[1]=e[1]*i.size/xe+i.offset[1],t[2]=e[2]}const Tc=Oe();function ku(t,e,i,n){Tc[0]=e[0][i],Tc[1]=e[1][i],Tc[2]=(e[2]??[])[i],$n(t,Tc,n)}function Pt(t,e,i){t[0]=(e[0]-i.offset[0])*xe/i.size,t[1]=(e[1]-i.offset[1])*xe/i.size,t[2]=e[2]}function Mt(t){return 2**(32-t)}function Nu(t){return t[0]>=0&&t[0]<=xe&&t[1]>=0&&t[1]<=xe}function qr(t,e){return t*4294967296/(xe*Math.pow(2,e))}function Ci(t){return Be(t/No*xe,0,rt)}function Gg(t){return t/xe*No}function Wi(t){const e=Mt(t[2]),i=2147483648;return at(t[0]*e-i,t[1]*e-i,0)}function Wn(t){return[t[0]+2147483648,t[1]+2147483648,32,32]}function jg(t){const e=Mt(t[2]),i=2147483648;return at((t[0]+.5)*e-i,(t[1]+.5)*e-i,0)}function Kr(t,e){const n=Mt(e),s=t[0]-n/2,o=t[1]-n/2;return[(s+2147483648)/n,(o+2147483648)/n,e,e]}function ir(t,e=1){const i=Math.max(t.max[0]-t.min[0],t.max[1]-t.min[1],1)*e,n=32-Math.log(i)/Math.LN2,s=xt();return Gr(s,t),Kr(s,n)}const Jr=t=>{const[e,i,n,s]=t;return[e,2**n-1-i,n,s]},Xn=(t,e)=>{$n(Fg,e,t);const i=Z.toGeo(Fg);return Z.scaleFactor(i[1])};function el(t,e,i){const n=[0,0,0];return $n(n,[t,e],i),Z.toGeo(n)}function ZS(t){const e=Math.min(t[0][0],t[1][0],t[2][0],t[3][0])+2147483648,i=Math.max(t[0][0],t[1][0],t[2][0],t[3][0])+2147483648,n=Math.floor(e/4294967296),s=Math.floor(i/4294967296);return Array.from({length:s-n+1},(o,r)=>r+n)}function Uu(t,e){return Yt.fromGeo(el(e[0],e[1],t))}function So(t,e,i,n){const s=[];return $n(s,n,i),pc(Z.toGeo(s),t)<e}function Vg(t,e,i){const n=Ye(i),s=xe;return So(t,e,n,[0,s/2,0])||So(t,e,n,[s,s/2,0])||So(t,e,n,[s/2,s,0])||So(t,e,n,[s/2,0,0])||So(t,e,n,[0,0,0])||So(t,e,n,[0,s,0])||So(t,e,n,[s,s,0])||So(t,e,n,[s,0,0])}function Ec(t,e,i){const n=[];return $n(n,i,e),t.ecef.project(Yt.fromGeo(Z.toGeo(n)))}function Ac(t,e,i){const[n,s,o]=i;if(s===0||s===2**o-1)return!0;const r=Ye(i),a=xe,l=[Ec(e,r,[0,0,0]),Ec(e,r,[0,a,0]),Ec(e,r,[a,a,0]),Ec(e,r,[a,0,0])],c=l.map(f=>f[0]),d=l.map(f=>f[1]),h={min:[Math.min(...c),Math.min(...d)],max:[Math.max(...c),Math.max(...d)]},u={min:[t.viewport.left,t.viewport.top],max:[t.viewport.left+t.size[0],t.viewport.top+t.size[1]]};return hu(h,u)}function $S(t,e,i,n,s){const a=new Map,l=[t],c=[];for(c.push(t);l.length;){if(c.length>300){console.warn("collectVisibleGlobeTiles: too many tiles",c.length);break}if(l.length>500){console.warn("collectVisibleGlobeTiles: queue overflow");break}const d=l.shift();if(d){const[h,u,f]=d;a.set(h+"."+u+"."+f,!0),WS(d,a,e,i).filter(p=>Ac(s,n,p)).forEach(p=>{const[_,g,y]=p;a.set(_+"."+g+"."+y,!0),c.push(p),l.push(p)})}}return c}function WS(t,e,i,n){const[s,o,r,a]=t,l=2**r-1,c=_=>_>l?0:_<0?l:_,d=([_,g,y,b])=>((g>l||g<0)&&(g=g>l?l:0,_=y===0?_:(_+2**(y-1))%2**y),[_,g,y,b]),h=[c(s-1),o,r,a],u=[c(s+1),o,r,a],f=d([s,o-1,r,a]),m=d([s,o+1,r,a]);return[u,m,f,h].filter(_=>{const[g,y,b]=_;return!e.has(g+"."+y+"."+b)}).filter(_=>Vg(i,n,_))}function XS(t,e,i,n=0){return""}var Xi=(t=>(t[t.Tile=0]="Tile",t[t.Custom=1]="Custom",t))(Xi||{});class YS{constructor(e){this._enable=!1,this.name=e.name,this.index=e.index,this.location=e.location!==void 0?e.location:-1,this.locationsCount=e.locationsCount??1,Hg(this.locationsCount)}bindLocation(e,i){return this.location!==-1&&this.index!==!0&&e.bindAttribLocation(i,this.location,this.name),this}getLocation(e,i){return this.location===-1&&this.index!==!0&&(this.location=e.getAttribLocation(i,this.name)),this}bind(e,i){if(!this._enable&&this.index!==!0){for(let n=0;n<this.locationsCount;n++)e.enableVertexAttribArray(this.location+n);this._enable=!0}return i.bind(e,this.location,void 0),this}disable(e){if(this._enable&&this.index!==!0){for(let i=0;i<this.locationsCount;i++)e.disableVertexAttribArray(this.location+i);this._enable=!1}return this}}function Hg(t){if(t<0||t>4)throw new Error("[2gl] Invalid attribute location count. Must be 1, 2, 3 or 4")}const Te=class Te{constructor(e,i,n=!1,s=!1){this.elementsType=null,this.isDirty=!0,this._glBuffer=null,this._glContext=null,this._initData=e,this.byteLength=e.byteLength,this.type=n?Te.ElementArrayBuffer:Te.ArrayBuffer,this.options=Object.assign({},Te.defaultOptions,i),this.drawType=(i==null?void 0:i.drawType)??Te.StaticDraw;const o=[Te.UnsignedByte,Te.UnsignedShort,Te.UnsignedInt];n&&!o.includes(this.options.dataType)&&(console.warn("Please provide dataType of one of the following values:Buffer.UnsignedByte, Buffer.UnsignedShort, Buffer.UnsignedInt. Defaulting to UnsignedInt"),this.options.dataType=Te.UnsignedInt),this._preserveData=s}static _dataTypeSize(e){switch(e){case Te.Byte:case Te.UnsignedByte:return 1;case Te.UnsignedShort:case Te.Short:return 2;case Te.Float:case Te.Int:case Te.UnsignedInt:return 4}throw new Error(`[2gl] Unsupported Buffer data type: ${String(e)}`)}memSizeJs(){var e;return((e=this._initData)==null?void 0:e.byteLength)??0}memSizeGPU(){return this.byteLength}bind(e,i,n,s,o){if(this._glBuffer||this.prepare(e),this.type===Te.ArrayBuffer){e.bindBuffer(e.ARRAY_BUFFER,this._glBuffer),i=i||0,n=n||this.options,o=o??1,Hg(o);const r=this._toGlParam(e,n.dataType)||e.FLOAT;if(o===1)e.vertexAttribPointer(i,n.itemSize,r,n.normalized,n.stride,n.offset),this.bindVertexAttribDivisor(e,i,n,s);else{const a=Te._dataTypeSize(n.dataType);for(let l=0;l<o;l++)e.vertexAttribPointer(i+l,o,r,n.normalized,n.stride,n.offset+l*o*a),this.bindVertexAttribDivisor(e,i+l,n,s)}}else this.type===Te.ElementArrayBuffer&&e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this._glBuffer);return this}remove(){return this._unprepare(),this}subData(e,i,n){this._glBuffer||this.prepare(e);const s=this._toGlParam(e,this.type)||e.ARRAY_BUFFER;return e.bindBuffer(s,this._glBuffer),e.bufferSubData(s,i,n),this}replaceData(e){e&&(this._initData=e),this.isDirty=!0}commitData(e){const i=this._toGlParam(e,this.type)||e.ARRAY_BUFFER,n=this._toGlParam(e,this.drawType)||e.STATIC_DRAW;e.bindBuffer(i,this._glBuffer),e.bufferData(i,this._initData,n),this.isDirty=!1}prepare(e){return this._glContext=e,this._glBuffer=e.createBuffer(),this.commitData(e),this._preserveData||(this._initData=null),this}getGLType(e){return this._toGlParam(e,this.options.dataType)}getData(){return this._initData}_unprepare(){this._glBuffer&&this._glContext&&this._glContext.deleteBuffer(this._glBuffer),this._glBuffer=null,this._glContext=null,this._initData=null,this.isDirty=!1}_toGlParam(e,i){return i===Te.ArrayBuffer?e.ARRAY_BUFFER:i===Te.ElementArrayBuffer?e.ELEMENT_ARRAY_BUFFER:i===Te.StaticDraw?e.STATIC_DRAW:i===Te.DynamicDraw?e.DYNAMIC_DRAW:i===Te.Byte?e.BYTE:i===Te.Short?e.SHORT:i===Te.Int?e.INT:i===Te.Float?e.FLOAT:i===Te.UnsignedByte?e.UNSIGNED_BYTE:i===Te.UnsignedShort?e.UNSIGNED_SHORT:i===Te.UnsignedInt?e.UNSIGNED_INT:null}_hasRealWebGLContext(){return typeof window<"u"&&("WebGLRenderingContext"in window||"WebGL2RenderingContext"in window)}bindVertexAttribDivisor(e,i,n,s){n.instanceDivisor&&this._hasRealWebGLContext()&&(e instanceof WebGLRenderingContext?s?s.vertexAttribDivisorANGLE(i,n.instanceDivisor):console.error("Can't set up instanced attribute divisor. Missing ANGLE_instanced_arrays extension"):e.vertexAttribDivisor(i,n.instanceDivisor))}};Te.ArrayBuffer=1,Te.ElementArrayBuffer=2,Te.StaticDraw=10,Te.DynamicDraw=11,Te.Float=20,Te.UnsignedByte=21,Te.UnsignedShort=22,Te.UnsignedInt=23,Te.Byte=24,Te.Short=25,Te.Int=26,Te.defaultOptions={itemSize:3,dataType:Te.Float,stride:0,offset:0,normalized:!1,instanceDivisor:0,drawType:Te.StaticDraw};let R=Te;function Zg(t){if(t===void 0)return;const e=window.WebGLRenderingContext,n={[e.UNSIGNED_BYTE]:R.UnsignedByte,[e.UNSIGNED_SHORT]:R.UnsignedShort,[e.UNSIGNED_INT]:R.UnsignedInt,[e.BYTE]:R.Byte,[e.SHORT]:R.Short,[e.INT]:R.Int,[e.FLOAT]:R.Float}[t];return n===void 0?(console.error(`Cannot translate ${t} gltf componentType`),NaN):n}function R8(t){return t}var nr=(t=>(t[t.Striped=1]="Striped",t[t.Entrance=2]="Entrance",t[t.Patterned=3]="Patterned",t))(nr||{}),tl=(t=>(t[t.Line=0]="Line",t[t.Arrow=1]="Arrow",t[t.StartBorder=2]="StartBorder",t[t.LineEnding=3]="LineEnding",t))(tl||{}),ht=(t=>(t[t.TileCut=0]="TileCut",t[t.Butt=1]="Butt",t[t.Round=2]="Round",t))(ht||{});const ti=xt(),Pc=xt(),Qr=xt(),Mo=xt(),il=xt(),js=xt(),Gu=xt(),Rn=xt();let ea=0,Io=0;function $g(t,e,i,n,s,o,r,a,l,c){if(!(s<2)){if(ps(ti,e[0],i[0],e[1],i[1]),ea=0,o===ht.Round){const d=l!==void 0?l[0]:0,h=c!==void 0?c[0]:0;ju(t,e[0],i[0],(n==null?void 0:n[0])??0,-ti[0],-ti[1],d,h,a)}for(let d=1;d<s;d++)qS(t,e,i,n,d,s,a,l,c);if(r===ht.Round){const d=l!==void 0?l[s-1]:0,h=c!==void 0?c[s-1]:0;ju(t,e[s-1],i[s-1],(n==null?void 0:n[s-1])??0,ti[0],ti[1],d,h,a)}}}function qS(t,e,i,n,s,o,r,a,l){const c=s===o-1;if(Vt(il,e[s-1],i[s-1]),Vt(js,e[s],i[s]),a!==void 0&&l!==void 0?(Vt(Qr,a[s-1],l[s-1]),Vt(Mo,a[s],l[s])):(Vt(Qr,0,0),Vt(Mo,0,0)),yo(Rn,ti),c)Io=0;else{Vt(Gu,e[s+1],i[s+1]),ps(Pc,js[0],js[1],Gu[0],Gu[1]);const u=Be(Vo(ti,Pc),-1,1);if(u<=0)Io=0,ju(t,js[0],js[1],(n==null?void 0:n[s])??0,ti[0],ti[1],Mo[0],Mo[1],r);else{const m=Math.sqrt((1-u)/(1+u)),p=gc(Vo(Rn,Pc));Io=m*p}}KS(t,0,1,3,3,1,2);const d=Rn[0]*At,h=Rn[1]*At;sr(t,il[0],il[1],(n==null?void 0:n[s-1])??0,(Rn[0]+ti[0]*ea)*At,(Rn[1]+ti[1]*ea)*At,d,h,Qr[0],Qr[1],r),sr(t,il[0],il[1],(n==null?void 0:n[s-1])??0,(-Rn[0]-ti[0]*ea)*At,(-Rn[1]-ti[1]*ea)*At,-d,-h,Qr[0],Qr[1],r),sr(t,js[0],js[1],(n==null?void 0:n[s])??0,(-Rn[0]+ti[0]*Io)*At,(-Rn[1]+ti[1]*Io)*At,-d,-h,Mo[0],Mo[1],r),sr(t,js[0],js[1],(n==null?void 0:n[s])??0,(Rn[0]-ti[0]*Io)*At,(Rn[1]-ti[1]*Io)*At,d,h,Mo[0],Mo[1],r),c||($a(ti,Pc),ea=Io)}function ju(t,e,i,n,s,o,r,a,l){JS(t,0,1,2);const c=-s*.01,d=-o*.01;sr(t,e,i,n,s+c,o+d,s,o,r,a,l),sr(t,e,i,n,-o+c,s+d,-o,s,r,a,l),sr(t,e,i,n,o+c,-s+d,o,-s,r,a,l)}function sr(t,e,i,n,s,o,r,a,l,c,d){const h=t.elements.offset*t.elements.stride,u=h>>1,f=h>>2;t.views.position[u]=$+e,t.views.position[u+1]=$+i,t.views.extender[h]=s*127,t.views.extender[h+1]=o*127,t.views.normal[h]=r*127,t.views.normal[h+1]=a*127,"height"in t.views&&(t.views.height[f]=n),"shift"in t.views&&(t.views.shift[f]=l,t.views.shift[f+1]=c),"localID"in t.views&&(t.views.localID[f]=d),t.elements.offset++}function KS(t,e,i,n,s,o,r){const a=t.indices.buffer,l=t.indices.offset,c=t.elements.offset;a[l]=c+e,a[l+1]=c+i,a[l+2]=c+n,a[l+3]=c+s,a[l+4]=c+o,a[l+5]=c+r,t.indices.offset=l+6}function JS(t,e,i,n){const s=t.indices.buffer,o=t.indices.offset,r=t.elements.offset;s[o]=r+e,s[o+1]=r+i,s[o+2]=r+n,t.indices.offset=o+3}function It(t,e,i){return e.precomputes.forEach((n,s)=>{t.push(i.tileData[s])}),t}function nl(t,e){for(let i=0,n=e.length;i<n;i++)t.push(e[i]);return t}const QS={x:0,y:1};function eM(t){const e={};for(const i in t)t[i]&&(e[i]=Array.from(t[i]));return e}function sl(t,e){for(const i in t){const n=QS[i];n!==void 0?t[i].push(e[n]):t[i].push(NaN)}}function tM(t,e,i,n){if(isNaN(t.step)||isNaN(t.width))return i;const{tileProps:s,tileAttrs:o}=n,r=Xn(e,[0,0]),a=xe/Mt(e.coords[2])*Ge*r;let l=t.step*a;if(isNaN(l)&&(l=0),l===0)return i;const c=t.width*a,d={},h=i.x,u=i.y,f=h.length;for(const T in i)d[T]=[];let m=0;const p=[m];for(let T=1;T<f;T++)m+=po([h[T-1],u[T-1]],[h[T],u[T]]),p.push(m);const _=xt(),g=xt(),y=[0,0],b=Math.abs(m/Math.trunc(m/l)),v=[h[0],u[0]];let I=(t.stopLines?1:-1)*Math.sign(t.width),S=0,P=0;for(sl(d,v),t.stopLines&&!o[s.beginningIsCut]&&(ps(_,h[P],u[P],h[P+1],u[P+1]),yo(g,_),Ei(y,g,I*c),An(v,v,y),sl(d,v),S+=b/2,I=-I);S<=m;){for(;S>p[P+1];)P++;if(ps(_,h[P],u[P],h[P+1],u[P+1]),yo(g,_),I>0)Ei(y,g,I*c),An(v,v,y),Ei(y,_,b/2),An(v,v,y),sl(d,v);else{const T=Math.min(1,(S-p[P])/(p[P+1]-p[P]));Jp(v,[h[P],u[P]],[h[P+1],u[P+1]],T),sl(d,v)}I=-I,S+=b/2}return t.stopLines&&!o[s.endingIsCut]&&(Ei(y,g,I*c),An(v,v,y),sl(d,v)),d}function Vu(t,e,i,n){if(!iM(t)||t.length===0)return i;let s=eM(i);for(const o of t){if(typeof o!="object"||!o)return console.warn(`Wrong value ${o} in modifiers list.`),null;if(!("type"in o))return console.warn(`Wrong value ${o} in modifiers list.`),null;switch(o.type){case"zigzag-modifier":s=tM(o,e,s,n);break;default:return console.warn(`Expression with type ${o.type} cannot be used as geometry modifier.`),null}if(s===null)return null}return s}function iM(t){return!!t&&Array.isArray(t)}const nM=new Set(["bottomCenter","bottomRight","bottomLeft","topCenter","topRight","topLeft","rightBottom","rightCenter","rightTop","leftBottom","leftCenter","leftTop","centerCenter"]);function sM(t){return nM.has(t)}function oM(t){return typeof t=="number"||typeof t=="boolean"||typeof t=="string"||t===null}function Hu(t){if(Array.isArray(t)){const e=t;if(!e.length)return!1;if({zoom:!0,height:!0,coalesce:!0,"heatmap-density":!0,"shading-intensity":!0,objectAttr:!0,step:!0,interpolate:!0,all:!0,get:!0,sourceAttr:!0,featureState:!0,global:!0,match:!0,in:!0,any:!0,"!":!0,"==":!0,"!=":!0,">=":!0,">":!0,"<=":!0,"<":!0,"to-boolean":!0,"to-color":!0,"+":!0,"*":!0,"^":!0,log10:!0,random:!0,literal:!0,isBehindObjects:!0,"mappoints-to-meters":!0,"meters-to-pixels":!0,uint64:!0,"geometry-modifier":!0,pattern:!0,precompute:!0,"gltf-animation":!0,distance:!0,time:!0,"local-time":!0,"utc-time":!0}[e[0]])return!0}return!1}function Wg(t){return Hu(t)&&t[0]==="literal"}function or(t){return!Array.isArray(t)&&typeof t=="object"&&t!==null&&t.type!==void 0&&t.type!=="color"}function rM(t){return!Array.isArray(t)&&typeof t=="object"&&t!==null&&t.type==="color"}function Xg(t,e){return Array.isArray(t)?t.length>0&&t.every(i=>typeof i===e):!1}function aM(t){return Xg(t,"string")}function Yn(t){return Xg(t,"number")}function Yg(t){return!Array.isArray(t)&&typeof t=="object"&&t!==null&&t.type==="object"}function lM(t){const e=typeof t;return t===null||e==="string"||e==="number"||e==="boolean"||aM(t)||Yn(t)}function cM(t){return lM(t)||rM(t)||Yg(t)}function qn(t){return{type:"color",value:t}}function Vs(t,e,i){return`${t}_${e}_${i}`}function ta(t){return`texture-${t}`}function Zu(t,e){return t+"-"+e}function ii(t){return Wg(t)&&Array.isArray(t[1])?t[1][0]:Array.isArray(t)?Hu(t)?t:t[0]:t}function Hs(t){if(Wg(t)&&Array.isArray(t[1]))return t[1][1];if(Array.isArray(t)&&!Hu(t)&&t[1]!==void 0)return t[1]}function ai(t){if(typeof t=="number"||Yn(t))return t;if(t.type==="literalArray"&&Yn(t.array))return t.array;throw new Error("Unsupported simple literal expression. Can't resolve.")}function ol(t,e=0){const i=Number(t);return isNaN(i)?e:i}const qg=qn([0,0,0,0]);function Kg(t){return typeof t!="string"?!1:/(#(?:[0-9a-f]{2}){2,4}|#[0-9a-f]{3}|(?:rgba?|hsla?)\((?:\d+%?(?:,|\s)+){2,3}[\s\/]*[\d\.]+%?\))/i.test(t)}function rl(t){return!!t&&typeof t=="object"&&t.type==="color"}function $u(t){return!!t&&typeof t=="object"&&t.type==="gradient-color"}function ia(t){const e=t.toLowerCase();let i=qg;switch(e[0]){case"#":i=hM(e);break;case"h":i=uM(e);break;case"r":i=fM(e);break}return i}function dM(t){return t.length<7?t[0]+t[1]+t[1]+t[2]+t[2]+t[3]+t[3]+(t.length===5?t[4]+t[4]:"ff"):t.length===7?t+"ff":t}function hM(t){if(!new RegExp(`^#[a-f0-9]{${t.length-1}}$`).test(t)||![4,5,7,9].includes(t.length))return qg;const i=dM(t),n=parseInt(i[1]+i[2],16),s=parseInt(i[3]+i[4],16),o=parseInt(i[5]+i[6],16),r=parseInt(i[7]+i[8],16);return qn([n,s,o,r])}function uM(t){const e=Jg(t);e[0]/=360,e[1]/=100,e[2]/=100;const[i,n,s]=_M(e[0],e[1],e[2]),o=e[3]!==void 0?e[3]*255:255;return qn([Math.round(i),Math.round(n),Math.round(s),Math.round(o)])}function fM(t){const[e,i,n,s]=Jg(t),o=s!==void 0?s*255:255;return qn([Math.round(e),Math.round(i),Math.round(n),Math.round(o)])}function Jg(t){return t.split("(")[1].split(")")[0].split(",").map(i=>parseFloat(i))}function Wu(t,e,i){return i<0&&(i+=1),i>1&&(i-=1),i<1/6?t+(e-t)*6*i:i<1/2?e:i<2/3?t+(e-t)*(2/3-i)*6:t}function _M(t,e,i){if(e===0)return[i*255,i*255,i*255];const n=i<.5?i*(1+e):i+e-i*e,s=2*i-n;return[Wu(s,n,t+1/3)*255,Wu(s,n,t)*255,Wu(s,n,t-1/3)*255]}function Xu(t){let e="",i=0;for(;i<t.length;){let n=t[i++];if(n>127){if(n>191&&n<224){if(i>=t.length)return console.error("Incomplete 2-byte sequence"),e;n=(n&31)<<6|t[i]&63}else if(n>223&&n<240){if(i+1>=t.length)return console.error("Incomplete 3-byte sequence"),e;n=(n&15)<<12|(t[i]&63)<<6|t[++i]&63}else if(n>239&&n<248){if(i+2>=t.length)return console.error("Incomplete 4-byte sequence"),e;n=(n&7)<<18|(t[i]&63)<<12|(t[++i]&63)<<6|t[++i]&63}else return console.error(`Unknown multibyte start 0x${n.toString(16)} at index ${i-1}`),e;++i}if(n<=65535)e+=String.fromCharCode(n);else if(n<=1114111)n-=65536,e+=String.fromCharCode(n>>10|55296),e+=String.fromCharCode(n&1023|56320);else return console.error(`Code point 0x${n.toString(16)} exceeds UTF-16 reach`),e}return e}function Yu(t,e){if(t.length<=e||t.indexOf(`
`)!==-1)return t;const i=[];return t.split(" ").forEach(n=>{const s=i.length-1;i.length===0||i[s].length+n.length>=e?i.push(n):i[s]+=" "+n}),i.join(`
`)}function qu(t){return Math.floor(t/256)}function mM(t){const e=new Set;return t.forEach(i=>{if(i!==void 0)for(let n=0;n<i.length;n++){const s=i.charCodeAt(n);s!==jt.bomCharCode&&e.add(qu(s))}}),Array.from(e)}function Qg(t,e,i=1,n="…"){if(t.length<=e)return t;const s=e-n.length;switch(i){case 2:return t.substring(0,s)+n;case 1:{const o=Math.ceil(s/2);return t.substring(0,o)+n+t.substring(t.length-(s-o),t.length)}}}function pM(t,e){Ze(`No glyph for character ${t} (code = ${e}, range = ${qu(e)})`)}const ev=new Set;function Ku(t){console.group("Gltf model error"),console.warn("Stage:",t.layer),t.message&&console.warn("Message:",t.message),t.originalError&&(console.groupCollapsed("Original error"),console.warn(t.originalError),console.groupEnd()),console.groupEnd()}function tv(t){Ze(`Got an empty response from the "${t}" tile generation.`)}function Ze(t){ev.has(t)||(console.log(t),ev.add(t))}const gM=2166136261,vM=16777619;function yM(t,e){let i=gM;for(const n of e)i=i^n,i=i*vM;t.randomSeed=Math.abs(i)}function Lc(t,e,i){let n=.5;return t.randomSeed?(t.randomSeed=t.randomSeed*16807%2147483647,n=(t.randomSeed-1)/2147483646):Ze("Resolve 'random': random seed is absent, the mean value between start and end will be used."),n*(i-e)+e}function wM(t=128){const e=[],i=[];for(let n=0;n<t;n++)e.push(iv(n,2)),i.push(iv(n,3));return{base2:e,base3:i}}function iv(t,e){let i=0,n=1/e;for(;t>0;)i=i+n*(t%e),t=Math.floor(t/e),n=n/e;return i}function bM(t,e){const i=[];for(let n=0;n<e;n++){const s=Lc(t,0,2*Math.PI),o=Math.acos(Lc(t,0,2)-1),r=Math.sin(o)*Math.cos(s),a=Math.sin(o)*Math.sin(s),l=Math.cos(o);i.push(at(r,a,l))}return i}var wi=(t=>(t[t.Uniform=1]="Uniform",t[t.Labeling=2]="Labeling",t[t.Generator=3]="Generator",t))(wi||{});const li=-1;var rr=(t=>(t.global="global",t.none="none",t))(rr||{}),vs=(t=>(t[t.Pixels=0]="Pixels",t[t.Meters=1]="Meters",t))(vs||{});const nv="bottomCenter";function ci(t,e){for(const i in e)e[i]!==void 0&&(t[i]=e[i])}function xM(t){const i={color:"#000000",textureImage:"",textureSize:16,textureOpacity:1,strokeColor:"#00000000",strokeWidth:1,visibility:"visible"};if(ci(i,t),t.strokeColor===void 0&&!i.textureImage&&(i.strokeColor=i.color),!Array.isArray(i.textureSize)||i.textureSize[0]==="step"||i.textureSize[0]==="literal")return i;if(!i.textureSize.length)i.textureSize=16;else if(Yn(i.textureSize))i.textureSize.length===1&&(i.textureSize=i.textureSize[0]);else return i;return i}function SM(t){const i={color:"#000000",textureImage:"",textureSize:16,textureOpacity:1,strokeColor:"#00000000",strokeWidth:1,nearCameraFade:2500,visibility:"visible",elevation:0};if(ci(i,t),t.strokeColor===void 0&&!i.textureImage&&(i.strokeColor=i.color),!Array.isArray(i.textureSize)||i.textureSize[0]==="step"||i.textureSize[0]==="literal")return i;if(!i.textureSize.length)i.textureSize=16;else if(Yn(i.textureSize))i.textureSize.length===1&&(i.textureSize=i.textureSize[0]);else return i;return i}function MM(t){const e={iconImage:"",color:"#FFFFFF",rotation:0,width:1,visibility:"visible"};return ci(e,t),t.height===void 0&&(e.height=e.width),e}function IM(t){const e={topColor:"#000000",strokeColor:"#000000",strokeWidth:1,sideColor:"#000000",sideStrokeColor:"#000000",height:["mappoints-to-meters",["get","db_height"]],nearCameraFade:2500,visibility:"visible"};return ci(e,t),t.strokeColor===void 0&&(e.strokeColor=e.topColor),t.sideColor===void 0&&(e.sideColor=e.topColor),t.sideStrokeColor===void 0&&(e.sideStrokeColor=e.sideColor),e}function TM(t){const e={color:"#000000",width:1,shift:0,geometryModifier:["geometry-modifier"],pattern:["pattern","none"],startCap:"round",endCap:"round",withHeight:!1,visibility:"visible"};return ci(e,t),e}function EM(t){const e={color:"#000000",strokeColor:"#000000",strokeWidth:1,nearCameraFade:2500,visibility:"visible"};return ci(e,t),t.strokeColor===void 0&&(e.strokeColor=e.color),e}function AM(t){const e={sideColor:"#000000",strokeColor:"#000000",strokeWidth:1,sideStrokeColor:"#000000",height:0,visibility:"visible",nearCameraFade:2500};return ci(e,t),t.strokeColor===void 0&&(e.strokeColor=e.sideColor),t.sideStrokeColor===void 0&&(e.sideStrokeColor=e.sideColor),e}function PM(t){const e={textField:["get","db_label"],textFont:"Noto_Sans",textColor:"#000000",textFontSize:16,textLetterSpacing:0,textHaloColor:"rgba(0, 0, 0, 0)",textHaloWidth:0,textPriority:0,textLabelingSideMargin:0,textDuplicationSpacing:0,lineEndingOffsets:0,visibility:"visible",labelingGroup:To};return ci(e,t),e}function LM(t){const e={color:"#000000",lineWidth:2,lineLength:10,tipWidth:1.5,tipHeight:2,roundingRadius:0,priority:0,duplicationSpacing:0,endingOffsets:0,visibility:"visible",labelingGroup:To};return ci(e,t),e}function CM(t){const e={color:"#000000",gapColor:"#00000000",width:1,shift:0,gapLength:1,dashLength:1,geometryModifier:["geometry-modifier"],withHeight:!1,visibility:"visible"};return ci(e,t),e}function RM(t){const e={color:"#000000",width:1,shift:0,visibility:"visible"};return ci(e,t),e}function zM(t){const e={color:"#ffffff",strokeColor:"#3388ff",strokeColor2:"#00000000",width:20,strokeWidth:3,strokeWidth2:0,visibility:"visible"};return ci(e,t),e}function FM(t){const e={allowOverlap:!1,allowElevation:!1,elevation:NaN,iconOpacity:1,iconImage:"",iconAnchor:[.5,.5],iconOffset:[0,0],iconWidth:16,iconTextField:["get","db_label2"],iconTextFont:"",iconTextAnchor:[.5,.5],iconTextOffset:[0,0],iconTextColor:"#000000",iconTextFontSize:16,iconTextLineHeight:1.2,iconTextLetterSpacing:0,iconTextPadding:[0,0,0,0],iconTextHaloWidth:0,iconTextHaloColor:"rgba(0, 0, 0, 0)",iconPriority:0,iconRotation:0,iconLabelingGroup:To,iconLabelingMargin:{topBottom:0,leftRight:0},textField:[["get","db_label"],["get","db_label2"]],textFont:"",textColor:"#000000",textFontSize:16,textLineHeight:1.2,textLetterSpacing:0,textPlacement:nv,textOffset:0,textHaloColor:"rgba(0, 0, 0, 0)",textHaloWidth:0,textLabelingMargin:{topBottom:0,leftRight:0},textPriority:0,textMaxLengthPerLine:30,visibility:"visible",textLabelingGroup:To,duplicationSpacing:100,endingOffsets:0};return ci(e,t),e}function DM(t){const e={color:"#000000",strokeColor:"#000000",lineWidth:1,strokeWidth:0,tipWidth:1,tipHeight:1,roundingRadius:3,animation:{type:"appearance",tipMovementAmplitude:0},visibility:"visible"};return t.strokeColor===void 0&&(e.strokeColor=e.color),ci(e,t),e}function OM(t){const e={opacity:1,visibility:"visible"};return ci(e,t),e}function BM(t){return Cn(t,{color:["interpolate",["linear"],["heatmap-density"],0,"rgba(53, 136, 253, 0)",.2,"rgba(53, 136, 253, 0.2)",.4,"rgb(255, 201, 77)",.6,"rgb(255, 202, 20)",.75,"rgb(245, 0, 7)",1,"rgb(255, 0, 0)"],radius:30,opacity:1,intensity:1,weight:1,downscale:1,visibility:"visible"})}function kM(t){return Cn(t,{shadingIntensity:["interpolate",["linear"],["zoom"],12,0,14.5,.7],verticalScale:1,shadingPalette:["interpolate",["linear"],["shading-intensity"],0,0,1,1],lightingDirection:322})}function NM(t){return Cn(t,{modelSrc:"",offset:0,scale:1,rotation:0,color:"#fff",linkedIds:"",visibility:"visible",colorTextureUvIndex:0,nearCameraFade:2500,ignoreGlobalLighting:!1,showRatio:1,metallic:NaN,roughness:NaN,preventObjectsHiding:!1,lightingModel:"phong",playAnimation:-1})}function UM(t){const e={visibility:"visible",sideColor:"#000000",borderTopColor:"#000000",bottomColor:"#000000",strokeColor:"#000000",strokeWidth:1,debug:!1,thickness:1,borderHeight:0,borderWidth:.3,color:"#000000",nearCameraFade:0,tunnelHeight:5};return ci(e,t),t.borderTopColor===void 0&&(e.borderTopColor=e.color),t.strokeColor===void 0&&(e.strokeColor=e.color),t.sideColor===void 0&&(e.sideColor=e.color),t.bottomColor===void 0&&(e.bottomColor=e.color),e}function GM(t){const e={visibility:"visible",sideColor:"#000000",topColor:"#000000",bottomColor:"#000000",strokeColor:"#000000",strokeWidth:1,color:"#ffffff",nearCameraFade:0};return ci(e,t),e}function jM(t){return Cn(t,{skyColor:"#6EC0FF00",fogColor:"#FAFDFF00",starsIntensity:1})}function VM(t){const e={sources:{sun:{type:"directional",altitude:50,azimuth:230,color:"#FFFFFF",intensity:.2},atmosphere:{type:"ambient",color:"#FFFFFF",intensity:.85}},lightingModes:{[rr.global]:["sun","atmosphere"]},defaultLightingMode:"global"},i=Cn(t??{},e);return i.lightingModes[rr.none]=[],i}function HM(t){return Cn(t??{},{light:{},normal:{},immersive:{}})}const ar="__overlapped",Ju="__commercial",To="default",Qu={groups:[To,ar,Ju],overlay:[[To,ar]],intersect:[[]]},ZM="#F5F2E0",lr=null,sv=[0,0,0];function q(t,e){if(!or(t))return t;if(e.allowedExpressions&&!e.allowedExpressions.has(t.type))return Ze(`Expression of type ${t.type} is not allowed here`),lr;switch(t.type){case"time":return XM(t,e);case"objectAttr":return KM(t,e);case"coalesce":return YM(t,e);case"all":return $M(t,e);case"any":return WM(t,e);case"featureState":return JM(t,e);case"get":return av(t,e);case"global":return QM(t,e);case"sourceAttr":return qM(t,e);case"in":return dI(t,e);case"interpolate":return eI(t,e);case"match":return tI(t,e);case"step":return iI(t,e);case"to-boolean":return rI(t,e);case"to-color":return nI(t,e);case"mappoints-to-meters":return sI(t,e);case"meters-to-pixels":return oI(t,e);case"!":return aI(t,e);case"==":case"!=":return lI(t,e);case">":case"<":case">=":case"<=":return cI(t,e);case"zoom":return e.type==="binder"||e.type==="labeling"?e.styleZoom:e.type==="generator"&&e.tileInfo?e.tileInfo.coords[3]:(Ze(`Zoom expression cannot be used in ${e.type} context`),lr);case"distance":if(e.type==="binder"){const n=Z.toGeo(e.objectCenter),s=Z.scaleFactor(n[1])*Ge;return su(e.objectCenter,e.cameraCenter)/s}else return Ze(`Distance expression can't be resolved in the ${e.type} context`),lr;case"height":return 1;case"+":return hI(t,e);case"*":return uI(t,e);case"^":return fI(t,e);case"log10":return _I(t,e);case"random":return mI(t,e);case"literalArray":return pI(t,e);case"literalObject":return{type:"object",value:t.object};case"isBehindObjects":return e.type==="binder"?e.isBehind:(Ze(`isBehindObjects expression cannot be used in ${e.type} context`),lr);case"geometry-modifier":return t.modifiers;case"line-pattern":return[t.patternType,...t.parameters.map(n=>q(n,e))];case"precompute":return e.tileData[t.precomputeIndex]??null;case"gltf-animation":return rv(t,e);case"local-time":return ov(t,e);case"utc-time":return ov(t,e);default:return Ze(`Not supported expression type <<${t.type}>> in ${JSON.stringify(t)}`),lr}}function $M(t,e){return t.array.every(i=>q(i,e)===!0)}function WM(t,e){return t.array.some(i=>q(i,e)===!0)}function ov(t,e){const i=Date.now()+ +(e.styleState._customUserTimeOffset||0);if(t.type==="local-time"){const n=t.offset?+(q(t.offset,e)||0)*6e4:0;return i+n}if(t.type==="utc-time"){const n=t.offset?+(q(t.offset,e)||0)*6e4:0;return i+new Date().getTimezoneOffset()*6e4+n}return i}function XM(t,e){const i=n=>{const s=q(t.timeSource,e),o=new Date(+(s||0));return n==="day-minutes-720"?(o.getHours()%12||0)*60+o.getMinutes():o.getTime()};return e.type==="binder"?(e.callBackFn&&e.callBackFn(),Array.isArray(t.format)?t.format.map(n=>i(n)):i(t.format)):i("timestamp")}function YM(t,e){for(const i of t.array){const n=q(i,e);if(n!==null)return n}return null}function qM(t,e){return e.type==="generator"?e.sourceAttrs[t.property]??null:null}function KM(t,e){return e.type==="binder"&&e.dynamicObject&&e.dynamicObject[t.property]||null}function rv(t,e){const i={type:"animation-options"};return t.options?t.options.forEach((n,s)=>i[s]=q(n,e)):or(t)||(i[0]=t),i}function JM(t,e){if(e.type==="generator"){const i=e.featureAttrs[e.tileProps[t.property]]??null;return Number.isNaN(i)?null:i}else throw new Error("Feature state expression can be resolved only in generator context")}function av(t,e){if(e.type==="generator"){let i=e.tileAttrs[e.tileProps[t.property]]??null;return typeof i=="object"&&i!==null&&!Array.isArray(i)&&(i={type:"object",value:i}),Number.isNaN(i)?null:i}else throw new Error("Get expression can be resolved only in generator context")}function QM(t,e){const i=e.styleState[t.property];return i==null?null:typeof i=="object"&&!Array.isArray(i)?{type:"object",value:i}:i}function eI(t,e){if(t.steps.length===0)return Ze("Interpolate expression contains 0 steps, cannot interpolate"),lr;const i=q(t.steps[0].value,e),n=q(t.argument,e);if(typeof n!="number")return Ze(`Interpolate value resolved to non-number value: ${n} ${t.argument}`),0;if(rl(i)){if(or(t.argument)&&t.argument.type==="height"){const s={type:"gradient-color",values:[],steps:[]};return t.steps.forEach(o=>{const r=W(o.key,e),a=q(o.value,e);rl(a)&&!Number.isNaN(r)&&(s.values.push({type:"color",value:a.value}),s.steps.push(r))}),s.steps.length!==2?(Ze("Gradient expression must resolve 2 steps"),lr):s}return dv(t,n,e)}return lv(t,n,e)}function tI(t,e){const i=q(t.input,e),n=t.cases.find(s=>s.values.has(i));return q((n==null?void 0:n.output)??t.defaultOutput,e)}function iI(t,e){const i=Number(q(t.value,e)),n=ef(t,i,e)-1;return q(t.steps[n].value,e)}function nI(t,e){const i=q(t.value,e);return Kg(i)?ia(i):rl(i)?i:(console.warn(`Can't resolve expression. Must be color, but got ${i}`),qn([0,0,0,0]))}function sI(t,e){if(e.type!=="generator"||!e.tileInfo)throw new Error("Выражение `mappoints-to-meters` можно резолвить только в контексте генератора");return q(t.value,e)/(Ge*Xn(e.tileInfo,[0,0]))}function oI(t,e){const i=W(t.value,e);let n,s=i*256/uu;if(e.type==="generator"){if(!e.tileInfo)return null;n=e.tileInfo.coords[3],s*=Xn(e.tileInfo,[0,0])}else n=e.styleZoom;return s*2**(n+1)}function rI(t,e){return!!q(t.value,e)}function aI(t,e){return!q(t.value,e)}function lI(t,e){const i=q(t.leftValue,e),n=q(t.rightValue,e);switch(t.type){case"==":return i===n;case"!=":return i!==n}}function cI(t,e){const i=q(t.leftValue,e);if(i===null)return null;const n=q(t.rightValue,e);if(n===null)return null;switch(t.type){case"<":return i<n;case">":return i>n;case"<=":return i<=n;case">=":return i>=n}}function dI(t,e){const i=q(t.item,e),n=q(t.collection,e);return n===null?!1:typeof n!="object"?(Ze(`InExpression second argument resolved to non-object/non-array value: ${n}`),null):Array.isArray(n)?n.some(s=>s===i):Yg(n)?n.value.hasOwnProperty(i):(Ze(`InExpression second argument resolved incorrectly: ${n}`),null)}function hI(t,e){const i=t.array.map(n=>q(n,e));return Yn(i)?i.reduce((n,s)=>n+s,0):(Ze(`Resolve AdditionExpression: arguments are not resolved as an array of numbers: ${i}`),null)}function uI(t,e){const i=t.array.map(n=>q(n,e));return Yn(i)?i.reduce((n,s)=>n*s,1):(Ze(`Resolve MultiplicationExpression: arguments are not resolved as an array of numbers: ${i}`),null)}function fI(t,e){const i=q(t.base,e);if(typeof i!="number")return Ze(`Resolve PowExpression: base resolved as non-number value: ${i}`),null;const n=q(t.exponent,e);return typeof n!="number"?(Ze(`Resolve PowExpression: exponent resolved as non-number value: ${n}`),null):Math.pow(i,n)}function _I(t,e){const i=q(t.value,e);return typeof i!="number"?(Ze(`Resolve Log10Expression: value resolved as non-number value: ${i}`),null):Math.log10(i)}function mI(t,e){const i=q(t.start,e);if(typeof i!="number")return Ze(`Resolve RandomizationExpression: start resolved as non-number value: ${i}`),null;const n=q(t.end,e);return typeof n!="number"?(Ze(`Resolve RandomizationExpression: end resolved as non-number value: ${n}`),null):n<i?(Ze("Resolve RandomizationExpression: end cannot be less than start."),null):Lc(e,i,n)}function pI(t,e){return t.array.map(i=>q(i,e))}function lv(t,e,i){const n=ef(t,e,i);if(n===0)return Number(q(t.steps[0].value,i));if(n===t.steps.length)return gI(t,i,e);const s=Number(q(t.steps[n-1].value,i));if(i.type==="labeling"&&i.interpolateExpressionAsStep)return s;const o=hv(t,e,n,i),r=Number(q(t.steps[n].value,i));return(1-o)*s+o*r}function ze(t,e){const i=q(t,e);return rl(i)?i:$u(i)?i.values[1]:(console.warn(`Can't resolve expression. Must be color, but got ${i}`),qn([0,0,0,0]))}function cv(t,e){const i=q(t,e);return $u(i)?i:null}function W(t,e,i=NaN){const n=q(t,e);return typeof n=="number"?n:i}function Ri(t,e,i=""){const n=q(t,e);return typeof n=="string"?n:i}function Cc(t,e,i=nv){const n=q(t,e);return sM(n)?n:i}function dv(t,e,i){const n=ef(t,e,i);if(n===0)return ze(t.steps[0].value,i);if(n===t.steps.length)return ze(t.steps[t.steps.length-1].value,i);const s=hv(t,e,n,i),o=ze(t.steps[n-1].value,i).value,r=ze(t.steps[n].value,i).value;return qn([o[0]*(1-s)+r[0]*s,o[1]*(1-s)+r[1]*s,o[2]*(1-s)+r[2]*s,o[3]*(1-s)+r[3]*s])}function gI(t,e,i){const n=t.steps[t.steps.length-1],s=t.base;return s===1?W(n.value,e):W(n.value,e)*Math.pow(s,i-W(n.key,e))}function ut(t,e,i,n=!1,s,o,r){return{type:"binder",styleZoom:t,styleState:e,tileData:i,randomSeed:0,isBehind:n,dynamicObject:s,cameraCenter:o??sv,objectCenter:r??sv}}function ys(t,e,i,n){return{type:"labeling",styleZoom:t,styleState:e,interpolateExpressionAsStep:i,randomSeed:0,tileData:n}}function di(t,e,i,n,s,o,r){return{type:"generator",styleState:t,tileProps:i,tileAttrs:n,id:o,tileData:[],featureAttrs:s,sourceAttrs:e,randomSeed:0,tileInfo:r}}function ef(t,e,i){let n=0;for(;n<t.steps.length&&!(e<W(t.steps[n].key,i));)n++;return n}function hv(t,e,i,n){const s=t.base,o=W(t.steps[i].key,n)-W(t.steps[i-1].key,n),r=e-W(t.steps[i-1].key,n);return s===1?r/o:(Math.pow(s,r)-1)/(Math.pow(s,o)-1)}function Tt(t){const[e,i,n,s]=t.value;return[((e*s+127)/255>>>0)/255,((i*s+127)/255>>>0)/255,((n*s+127)/255>>>0)/255,s/255]}function Zs(t,e,i,n=!1){const s=[];return cr(s,t,e,i),n?s:Array.from(new Set(s))}function vI(t,e){const i={};return Object.keys(t).forEach(n=>{i[n]=yI(t[n],e)}),i}const na=bu();function uv(t,e){const i=new Float32Array(3);return gt(i,1,0,0),W2(na),q2(na,na,-ve(e-90)),Y2(na,na,-ve(t)),_2(i,i,na),Ui(i,i),Hp(i,i),i}function yI(t,e){const i={ambientColorIntensity:new Float32Array(ze(t.ambientColor,e).value.map(n=>n/255)),dir1ColorIntensity:new Float32Array(ze(t.dir1Color,e).value.map(n=>n/255)),dir1Direction:uv(q(t.dir1Altitude,e),q(t.dir1Azimuth,e)),dir2ColorIntensity:new Float32Array(ze(t.dir2Color,e).value.map(n=>n/255)),dir2Direction:uv(q(t.dir2Altitude,e),q(t.dir2Azimuth,e)),shadowLightIndex:t.shadowLightIndex??-1,shadowRadius:t.shadowRadius??1};return i.ambientColorIntensity[3]=q(t.ambientIntensity,e),i.dir1ColorIntensity[3]=q(t.dir1Intensity,e),i.dir2ColorIntensity[3]=q(t.dir2Intensity,e),i}function cr(t,e,i,n){if(!or(e)){t.push(e);return}switch(e.type){case"all":return wI(t,e,i,n);case"match":return bI(t,e,i,n);case"step":return xI(t,e,i,n);case"interpolate":return SI(t,e,i,n);case"precompute":if(n){const s=n.precomputes[e.precomputeIndex].expr;cr(t,s,i,n);return}break;case"get":{if(!i){console.error("There is no context to resolve the expression. The value from data will not be added to the result.");return}const s=av(e,i);t.push(s);return}}}function wI(t,e,i,n){e.array.forEach(s=>cr(t,s,i,n))}function bI(t,e,i,n){cr(t,e.defaultOutput),e.cases.forEach(s=>cr(t,s.output,i,n))}function xI(t,e,i,n){e.steps.forEach(s=>cr(t,s.value,i,n))}function SI(t,e,i,n){e.steps.forEach(s=>cr(t,s.value,i,n))}const Kn=1,Jn=-1,Qn=[.5,.5],zn=[.5,.5],lt=[.5,.5],sa=[.5,.5],tf=[0,0];let fn,Qe,st,ct=0,_n=0,ni=0,bi=0;const MI={x:0,y:0,z:0,xn2:0,yn2:0,xn1:0,yn1:0,patternedLine:!1,noTurn:!0,leftTurn:!1,sharpTurn:!1,reverseTurn:!1,extender:[.5,.5],faExtender:[.5,.5],saExtender:[.5,.5]},II=1-1e-4,TI=0,fv=-.9;function EI(t,e,i,n,s,o,r,a){const l=MI;l.x=t,l.y=e,l.z=i,l.xn2=n,l.yn2=s,l.xn1=o,l.yn1=r,l.patternedLine=a;const c=n*o+s*r;return l.noTurn=c>II,l.leftTurn=n*-r+s*o<0,l.sharpTurn=c<TI&&c>fv,l.reverseTurn=c<fv,l}function nf(t,e,i,n,s,o,r,a,l,c,d,h,u=!1){let f,m,p,_,g,y,b,v,I,S,P,T,L;if(n!==0)if(st=d,Qe=h,fn=Qe.indices,_n=Qe.elements.offset,ct=0,ni=0,bi=0,t[0],e[0],n===1)f=t[0],m=e[0],p=(i==null?void 0:i[0])??0,L=0,$s(fn,_n,0,2,1,1,2,3),ft(Qe,st,0,f,m,p,1,-1,1,-1,L,!1,Jn),ft(Qe,st,0,f,m,p,-1,-1,-1,-1,L,!1,Kn),ft(Qe,st,0,f,m,p,1,1,1,1,L,!1,Jn),ft(Qe,st,0,f,m,p,-1,1,-1,1,L,!1,Kn),ct=ct+4;else{switch(_=t[0],g=e[0],y=(i==null?void 0:i[0])??0,b=t[1],v=e[1],I=(i==null?void 0:i[1])??0,L=u?st.cDist:0,s){case ht.TileCut:jn(Qn,_,g,r,a),jn(lt,b,v,_,g),T=sf(b,v,I,Qn[0],Qn[1],lt[0],lt[1],u),T.noTurn?_v(_,g,y,lt[0],lt[1],L):Rc(0,_,g,y,Qn[0],Qn[1],lt[0],lt[1],L,u);break;case ht.Butt:case ht.Round:jn(lt,b,v,_,g),_v(_,g,y,lt[0],lt[1],L),s===ht.Round&&Rc(0,_,g,y,lt[0],lt[1],lt[0],lt[1],L,u);break;default:throw new Error("LoftedLine: unknown Ending Type")}const B=n-1;for(let x=1;x<B;x++){_=t[x-1],g=e[x-1],y=(i==null?void 0:i[x-1])??0,b=t[x],v=e[x],I=(i==null?void 0:i[x])??0,S=t[x+1],P=e[x+1];const C=b-_,V=v-g;L+=Math.sqrt(C*C+V*V)/xe,jn(Qn,b,v,_,g),jn(lt,S,P,b,v),Rc(x,b,v,I,Qn[0],Qn[1],lt[0],lt[1],L,u)}_=t[n-2],g=e[n-2],y=(i==null?void 0:i[n-2])??0,b=t[B],v=e[B],I=(i==null?void 0:i[B])??0;const O=b-_,w=v-g;switch(L+=Math.sqrt(O*O+w*w)/xe,o){case ht.TileCut:jn(Qn,b,v,_,g),jn(lt,l,c,b,v),T=sf(b,v,I,Qn[0],Qn[1],lt[0],lt[1],u),T.noTurn?mv(B,b,v,I,lt[0],lt[1],L):pv(B,L,T);break;case ht.Butt:case ht.Round:jn(lt,b,v,_,g),mv(B,b,v,I,lt[0],lt[1],L),o===ht.Round&&Rc(B,b,v,I,lt[0],lt[1],-lt[0],-lt[1],L,u);break;default:throw new Error("LoftedLine: unknown Ending Type")}}}function sf(t,e,i,n,s,o,r,a){const l=EI(t,e,i,n,s,o,r,a);if(!l.noTurn&&!l.reverseTurn){gg(zn,n,s,o,r);const c=zn[0],d=zn[1];l.extender[0]=c,l.extender[1]=d,l.faExtender[0]=c-n*2,l.faExtender[1]=d-s*2,l.saExtender[0]=c-o*2,l.saExtender[1]=d-r*2}else l.extender[0]=0,l.extender[1]=0,l.faExtender[0]=0,l.faExtender[1]=0,l.saExtender[0]=0,l.saExtender[1]=0;return l}function of(t,e,i,n,s,o,r,a,l,c){gg(zn,s,o,r,a),s*-a+o*r<0?ft(Qe,st,t,e,i,n,-zn[0],-zn[1],-zn[0],-zn[1],l,!1,c):ft(Qe,st,t,e,i,n,zn[0],zn[1],zn[0],zn[1],l,!1,c),ct++}function Rc(t,e,i,n,s,o,r,a,l,c){const d=sf(e,i,n,s,o,r,a,c);pv(t,l,d),AI(t,l,d),PI(t,l,d)}function _v(t,e,i,n,s,o){ft(Qe,st,0,t,e,i,-n,-s,-n,-s,o,!1,Kn),ft(Qe,st,0,t,e,i,n,s,n,s,o,!1,Jn),ct=ct+2,ni=1,bi=0}function mv(t,e,i,n,s,o,r){const a=ct+1,l=ct;ft(Qe,st,t,e,i,n,-s,-o,-s,-o,r,!1,Kn),ft(Qe,st,t,e,i,n,s,o,s,o,r,!1,Jn),ct=ct+2,$s(fn,_n,bi,l,ni,ni,l,a),ni=a,bi=l}function AI(t,e,i){if(i.noTurn)return;const n=i.sharpTurn?2:1;let s,o;i.reverseTurn||i.patternedLine&&i.sharpTurn?(s=bi,o=ni):i.leftTurn?(s=ni,o=ct+n):(s=ct+n,o=bi);const r=ct;if(rf(fn,_n,ni,bi,r),i.sharpTurn){const l=ct+1;i.leftTurn?$s(fn,_n,r,l,s,s,l,o):$s(fn,_n,r,o,l,l,o,s)}else i.leftTurn,rf(fn,_n,r,o,s);const a=i.leftTurn?Kn:Jn;i.sharpTurn?(i.leftTurn?jn(sa,i.xn2,i.yn2,i.xn1,i.yn1):jn(sa,i.xn1,i.yn1,i.xn2,i.yn2),of(t,i.x,i.y,i.z,i.xn2,i.yn2,sa[0],sa[1],e,a),of(t,i.x,i.y,i.z,sa[0],sa[1],i.xn1,i.yn1,e,a)):of(t,i.x,i.y,i.z,i.xn2,i.yn2,i.xn1,i.yn1,e,a),i.reverseTurn||(i.leftTurn?ft(Qe,st,t,i.x,i.y,i.z,-i.xn1,-i.yn1,-i.xn1,-i.yn1,e,!1,a):ft(Qe,st,t,i.x,i.y,i.z,i.xn1,i.yn1,i.xn1,i.yn1,e,!1,a),ct++),bi=o,ni=s}function pv(t,e,i){if(i.noTurn)return;const n=ct+1,s=ct;if(i.reverseTurn||i.patternedLine&&i.sharpTurn?(ft(Qe,st,t,i.x,i.y,i.z,-i.xn2,-i.yn2,-i.xn2,-i.yn2,e,!1,Kn),ft(Qe,st,t,i.x,i.y,i.z,i.xn2,i.yn2,i.xn2,i.yn2,e,!1,Jn)):i.leftTurn?(ft(Qe,st,t,i.x,i.y,i.z,-i.xn2,-i.yn2,i.faExtender[0],i.faExtender[1],e,!0,Kn),ft(Qe,st,t,i.x,i.y,i.z,i.xn2,i.yn2,i.extender[0],i.extender[1],e,!0,Jn)):(ft(Qe,st,t,i.x,i.y,i.z,-i.xn2,-i.yn2,-i.extender[0],-i.extender[1],e,!0,Kn),ft(Qe,st,t,i.x,i.y,i.z,i.xn2,i.yn2,-i.faExtender[0],-i.faExtender[1],e,!0,Jn)),ct=ct+2,$s(fn,_n,bi,s,ni,ni,s,n),bi=s,ni=n,!i.patternedLine&&!i.reverseTurn){const o=ct+1,r=ct;i.leftTurn?(ft(Qe,st,t,i.x,i.y,i.z,-i.xn2,-i.yn2,-i.xn2,-i.yn2,e,!1,0),ft(Qe,st,t,i.x,i.y,i.z,0,0,0,0,e,!1,0),$s(fn,_n,n,s,o,o,s,r)):(ft(Qe,st,t,i.x,i.y,i.z,0,0,0,0,e,!1,0),ft(Qe,st,t,i.x,i.y,i.z,i.xn2,i.yn2,i.xn2,i.yn2,e,!1,0),$s(fn,_n,s,r,n,n,r,o)),ct=ct+2,bi=r,ni=o}}function PI(t,e,i){if(i.noTurn||i.reverseTurn)return;const n=ct+1,s=ct;if(i.patternedLine&&i.sharpTurn){ft(Qe,st,t,i.x,i.y,i.z,i.xn2,i.yn2,i.xn2,i.yn2,e,!1,Kn),ft(Qe,st,t,i.x,i.y,i.z,-i.xn2,-i.yn2,-i.xn2,-i.yn2,e,!1,Jn),ct=ct+2,bi=s,ni=n;return}else i.leftTurn?(ft(Qe,st,t,i.x,i.y,i.z,-i.xn1,-i.yn1,i.saExtender[0],i.saExtender[1],e,!1,Kn),ft(Qe,st,t,i.x,i.y,i.z,i.xn1,i.yn1,i.extender[0],i.extender[1],e,!1,Jn)):(ft(Qe,st,t,i.x,i.y,i.z,-i.xn1,-i.yn1,-i.extender[0],-i.extender[1],e,!1,Kn),ft(Qe,st,t,i.x,i.y,i.z,i.xn1,i.yn1,-i.saExtender[0],-i.saExtender[1],e,!1,Jn));ct=ct+2,i.leftTurn?$s(fn,_n,bi,s,ni,ni,s,n):$s(fn,_n,ni,bi,n,n,bi,s),bi=s,ni=n}function ft(t,e,i,n,s,o,r,a,l,c,d,h,u){const f=t.elements.offset*e.offsetMultiplier,m=f>>1,p=f<<1;if(t.views.position[f]=$+n,t.views.position[f+1]=$+s,t.views.extender[f]=Math.floor(l*At*127+.5),t.views.extender[f+1]=Math.floor(c*At*127+.5),e.type===nr.Patterned){const _=t,g=1e-5;_.views.texture[m]=(g+d)*Math.sign(u)}else if(e.type===nr.Striped){const _=t;_.views.texExtender[p]=qt(r*At),_.views.texExtender[p+1]=qt(a*At),_.views.vertexDistance[m]=d,_.views.objectLength[m]=e.oLen,"componentDistance"in t.views&&(t.views.componentDistance[m]=e.cDist)}else if(e.type===nr.Entrance){const _=t,{px:g,py:y,count:b}=e,v=i===0,I=i===b-1,S=v?i:i-1,P=v?i+1:i;ps(tf,g[S],y[S],g[P],y[P]),_.views.direction[f]=Math.round(tf[0]*127),_.views.direction[f+1]=Math.round(tf[1]*127),_.views.type[m]=I?tl.LineEnding:tl.Line,_.views.texExtender[p]=qt(r*(h||I?-1:1)*At),_.views.texExtender[p+1]=qt(a*(h||I?-1:1)*At),_.views.vertexDistance[m]=d,_.views.objectLength[m]=e.oLen}t.views.localID[m]=e.localID,"height"in t.views&&(t.views.height[m]=o),t.elements.offset++}function rf(t,e,i,n,s){const o=t.buffer,r=t.offset;o[r]=e+i,o[r+1]=e+n,o[r+2]=e+s,t.offset=r+3}function $s(t,e,i,n,s,o,r,a){const l=t.buffer,c=t.offset;l[c]=e+i,l[c+1]=e+n,l[c+2]=e+s,l[c+3]=e+o,l[c+4]=e+r,l[c+5]=e+a,t.offset=c+6}function dr(t){return Rr*t}function af(t){return t/Rr}function LI(t){return!!t.match(/^[0-9a-f]{8}-[0-9a-f]{4}-[0-5][0-9a-f]{3}-[089ab][0-9a-f]{3}-[0-9a-f]{12}$/i)}const CI={arrow:!0,buildingModel:!0,custom:!0,dashedLine:!0,embankment:!0,group:!0,heatmap:!0,labelLine:!0,line:!0,lineExtrusion:!0,metricPoint:!0,model:!0,oneWayLine:!0,overpass:!0,point:!0,polygon:!0,polygon3d:!0,polygonExtrusion:!0,raster:!0,shiftedLine:!0,tunnel:!0};function gv(t){return CI[t]}function vv(t){return t!=="group"&&t!=="custom"}function yv(t){return t==="model"?"gltfModel":t!=="group"?t:void 0}const wv=32,bv=512;function RI(t,e,i,n,s){const o=[t[0][0],t[1][0]],r=ve(90+n),a=[];$n(a,o,s);const l=Z.toGeo(a),c=Vr(l,e),d=Vr(l,i),h=Math.sqrt(c**2+d**2)/2,u=Math.atan(c/-d)+Math.PI+r,f=h*Math.cos(u),m=h*Math.sin(u),p=Math.atan(-c/-d)+Math.PI+r,_=h*Math.cos(p),g=h*Math.sin(p),y=Math.atan(-c/d)+2*Math.PI+r,b=h*Math.cos(y),v=h*Math.sin(y),I=Math.atan(c/d)+r,S=h*Math.cos(I),P=h*Math.sin(I),T=[],L=[],B=[],O=[];return Pt(T,[a[0]+f,a[1]+m],s),Pt(L,[a[0]+_,a[1]+g],s),Pt(B,[a[0]+b,a[1]+v],s),Pt(O,[a[0]+S,a[1]+P],s),[[T[0],L[0],B[0],O[0]],[T[1],L[1],B[1],O[1]]]}function oa(t,e){const i=Math.max(t,e);return i*wv>bv?bv/i:wv}function zI(){let t=new dn(4);return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t}function FI(t,e,i,n,s){return t[0]=e,t[1]=i,t[2]=n,t[3]=s,t}function DI(t){return t[0]*t[3]-t[2]*t[1]}var zc={exports:{}},Fc={exports:{}},OI=Fc.exports,xv;function BI(){return xv||(xv=1,function(t,e){(function(i,n){t.exports=n()})(OI,function(){function i(r,a,l,c,d){n(r,a,l||0,c||r.length-1,d||o)}function n(r,a,l,c,d){for(;c>l;){if(c-l>600){var h=c-l+1,u=a-l+1,f=Math.log(h),m=.5*Math.exp(2*f/3),p=.5*Math.sqrt(f*m*(h-m)/h)*(u-h/2<0?-1:1),_=Math.max(l,Math.floor(a-u*m/h+p)),g=Math.min(c,Math.floor(a+(h-u)*m/h+p));n(r,a,_,g,d)}var y=r[a],b=l,v=c;for(s(r,l,a),d(r[c],y)>0&&s(r,l,c);b<v;){for(s(r,b,v),b++,v--;d(r[b],y)<0;)b++;for(;d(r[v],y)>0;)v--}d(r[l],y)===0?s(r,l,v):(v++,s(r,v,c)),v<=a&&(l=v+1),a<=v&&(c=v-1)}}function s(r,a,l){var c=r[a];r[a]=r[l],r[l]=c}function o(r,a){return r<a?-1:r>a?1:0}return i})}(Fc)),Fc.exports}var Sv;function kI(){if(Sv)return zc.exports;Sv=1,zc.exports=e,zc.exports.default=e;var t=BI();function e(_,g){if(!(this instanceof e))return new e(_,g);this._maxEntries=Math.max(4,_||9),this._minEntries=Math.max(2,Math.ceil(this._maxEntries*.4)),g&&this._initFormat(g),this.clear()}e.prototype={all:function(){return this._all(this.data,[])},search:function(_){var g=this.data,y=[],b=this.toBBox;if(!f(_,g))return y;for(var v=[],I,S,P,T;g;){for(I=0,S=g.children.length;I<S;I++)P=g.children[I],T=g.leaf?b(P):P,f(_,T)&&(g.leaf?y.push(P):u(_,T)?this._all(P,y):v.push(P));g=v.pop()}return y},collides:function(_){var g=this.data,y=this.toBBox;if(!f(_,g))return!1;for(var b=[],v,I,S,P;g;){for(v=0,I=g.children.length;v<I;v++)if(S=g.children[v],P=g.leaf?y(S):S,f(_,P)){if(g.leaf||u(_,P))return!0;b.push(S)}g=b.pop()}return!1},load:function(_){if(!(_&&_.length))return this;if(_.length<this._minEntries){for(var g=0,y=_.length;g<y;g++)this.insert(_[g]);return this}var b=this._build(_.slice(),0,_.length-1,0);if(!this.data.children.length)this.data=b;else if(this.data.height===b.height)this._splitRoot(this.data,b);else{if(this.data.height<b.height){var v=this.data;this.data=b,b=v}this._insert(b,this.data.height-b.height-1,!0)}return this},insert:function(_){return _&&this._insert(_,this.data.height-1),this},clear:function(){return this.data=m([]),this},remove:function(_,g){if(!_)return this;for(var y=this.data,b=this.toBBox(_),v=[],I=[],S,P,T,L;y||v.length;){if(y||(y=v.pop(),P=v[v.length-1],S=I.pop(),L=!0),y.leaf&&(T=i(_,y.children,g),T!==-1))return y.children.splice(T,1),v.push(y),this._condense(v),this;!L&&!y.leaf&&u(y,b)?(v.push(y),I.push(S),S=0,P=y,y=y.children[0]):P?(S++,y=P.children[S],L=!1):y=null}return this},toBBox:function(_){return _},compareMinX:r,compareMinY:a,toJSON:function(){return this.data},fromJSON:function(_){return this.data=_,this},_all:function(_,g){for(var y=[];_;)_.leaf?g.push.apply(g,_.children):y.push.apply(y,_.children),_=y.pop();return g},_build:function(_,g,y,b){var v=y-g+1,I=this._maxEntries,S;if(v<=I)return S=m(_.slice(g,y+1)),n(S,this.toBBox),S;b||(b=Math.ceil(Math.log(v)/Math.log(I)),I=Math.ceil(v/Math.pow(I,b-1))),S=m([]),S.leaf=!1,S.height=b;var P=Math.ceil(v/I),T=P*Math.ceil(Math.sqrt(I)),L,B,O,w;for(p(_,g,y,T,this.compareMinX),L=g;L<=y;L+=T)for(O=Math.min(L+T-1,y),p(_,L,O,P,this.compareMinY),B=L;B<=O;B+=P)w=Math.min(B+P-1,O),S.children.push(this._build(_,B,w,b-1));return n(S,this.toBBox),S},_chooseSubtree:function(_,g,y,b){for(var v,I,S,P,T,L,B,O;b.push(g),!(g.leaf||b.length-1===y);){for(B=O=1/0,v=0,I=g.children.length;v<I;v++)S=g.children[v],T=l(S),L=d(_,S)-T,L<O?(O=L,B=T<B?T:B,P=S):L===O&&T<B&&(B=T,P=S);g=P||g.children[0]}return g},_insert:function(_,g,y){var b=this.toBBox,v=y?_:b(_),I=[],S=this._chooseSubtree(v,this.data,g,I);for(S.children.push(_),o(S,v);g>=0&&I[g].children.length>this._maxEntries;)this._split(I,g),g--;this._adjustParentBBoxes(v,I,g)},_split:function(_,g){var y=_[g],b=y.children.length,v=this._minEntries;this._chooseSplitAxis(y,v,b);var I=this._chooseSplitIndex(y,v,b),S=m(y.children.splice(I,y.children.length-I));S.height=y.height,S.leaf=y.leaf,n(y,this.toBBox),n(S,this.toBBox),g?_[g-1].children.push(S):this._splitRoot(y,S)},_splitRoot:function(_,g){this.data=m([_,g]),this.data.height=_.height+1,this.data.leaf=!1,n(this.data,this.toBBox)},_chooseSplitIndex:function(_,g,y){var b,v,I,S,P,T,L,B;for(T=L=1/0,b=g;b<=y-g;b++)v=s(_,0,b,this.toBBox),I=s(_,b,y,this.toBBox),S=h(v,I),P=l(v)+l(I),S<T?(T=S,B=b,L=P<L?P:L):S===T&&P<L&&(L=P,B=b);return B},_chooseSplitAxis:function(_,g,y){var b=_.leaf?this.compareMinX:r,v=_.leaf?this.compareMinY:a,I=this._allDistMargin(_,g,y,b),S=this._allDistMargin(_,g,y,v);I<S&&_.children.sort(b)},_allDistMargin:function(_,g,y,b){_.children.sort(b);var v=this.toBBox,I=s(_,0,g,v),S=s(_,y-g,y,v),P=c(I)+c(S),T,L;for(T=g;T<y-g;T++)L=_.children[T],o(I,_.leaf?v(L):L),P+=c(I);for(T=y-g-1;T>=g;T--)L=_.children[T],o(S,_.leaf?v(L):L),P+=c(S);return P},_adjustParentBBoxes:function(_,g,y){for(var b=y;b>=0;b--)o(g[b],_)},_condense:function(_){for(var g=_.length-1,y;g>=0;g--)_[g].children.length===0?g>0?(y=_[g-1].children,y.splice(y.indexOf(_[g]),1)):this.clear():n(_[g],this.toBBox)},_initFormat:function(_){var g=["return a"," - b",";"];this.compareMinX=new Function("a","b",g.join(_[0])),this.compareMinY=new Function("a","b",g.join(_[1])),this.toBBox=new Function("a","return {minX: a"+_[0]+", minY: a"+_[1]+", maxX: a"+_[2]+", maxY: a"+_[3]+"};")}};function i(_,g,y){if(!y)return g.indexOf(_);for(var b=0;b<g.length;b++)if(y(_,g[b]))return b;return-1}function n(_,g){s(_,0,_.children.length,g,_)}function s(_,g,y,b,v){v||(v=m(null)),v.minX=1/0,v.minY=1/0,v.maxX=-1/0,v.maxY=-1/0;for(var I=g,S;I<y;I++)S=_.children[I],o(v,_.leaf?b(S):S);return v}function o(_,g){return _.minX=Math.min(_.minX,g.minX),_.minY=Math.min(_.minY,g.minY),_.maxX=Math.max(_.maxX,g.maxX),_.maxY=Math.max(_.maxY,g.maxY),_}function r(_,g){return _.minX-g.minX}function a(_,g){return _.minY-g.minY}function l(_){return(_.maxX-_.minX)*(_.maxY-_.minY)}function c(_){return _.maxX-_.minX+(_.maxY-_.minY)}function d(_,g){return(Math.max(g.maxX,_.maxX)-Math.min(g.minX,_.minX))*(Math.max(g.maxY,_.maxY)-Math.min(g.minY,_.minY))}function h(_,g){var y=Math.max(_.minX,g.minX),b=Math.max(_.minY,g.minY),v=Math.min(_.maxX,g.maxX),I=Math.min(_.maxY,g.maxY);return Math.max(0,v-y)*Math.max(0,I-b)}function u(_,g){return _.minX<=g.minX&&_.minY<=g.minY&&g.maxX<=_.maxX&&g.maxY<=_.maxY}function f(_,g){return g.minX<=_.maxX&&g.minY<=_.maxY&&g.maxX>=_.minX&&g.maxY>=_.minY}function m(_){return{children:_,height:1,leaf:!0,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}function p(_,g,y,b,v){for(var I=[g,y],S;I.length;)y=I.pop(),g=I.pop(),!(y-g<=b)&&(S=g+Math.ceil((y-g)/b/2)*b,t(_,S,g,y,v),I.push(g,S,S,y))}return zc.exports}var NI=kI();const lf=Ja(NI),al=Oe(),Mv=Oe(),UI=xt(),GI=xt(),Iv=zI(),ra=64;function Tv(t,e){const i=lf();for(let n=0;n<e.length;n+=3){const s=e[n],o=e[n+1],r=e[n+2],a=cf(t,s),l=cf(t,o),c=cf(t,r),d=[a,l,c];i.insert({minX:Math.min(a[0],l[0],c[0]),minY:Math.min(a[1],l[1],c[1]),maxX:Math.max(a[0],l[0],c[0]),maxY:Math.max(a[1],l[1],c[1]),data:d})}return i}function cf(t,e){const i=t[e*3],n=t[e*3+1],s=t[e*3+2];return[i,n,s]}function Ev(t,e){const i=gt(al,e[0],e[1],0),n=zu(t.key),s=Ye(n),o=new Uint16Array(3);Pt(o,i,s);const r=t.tree.search({minX:o[0],maxX:o[0],minY:o[1],maxY:o[1]});for(const a of r){const[l,c,d]=a.data,h=jI(l,c,d,o,al);if(!h)continue;return l[2]*h[0]+c[2]*h[1]+d[2]*h[2]}}function jI(t,e,i,n,s){const o=df(t,e,i);if(o===0){if(t[0]===e[0]&&e[0]===i[0]&&t[1]===e[1]&&e[1]===i[1])return t[0]===n[0]&&t[1]===n[1]?(s[0]=1,s[1]=0,s[2]=0,s):null;let c=null;if(hf(t,e,n)){const d=Dc(t,e,n);c=Ti(al,t,e,d),s[0]=1-d,s[1]=d,s[2]=0}if(hf(e,i,n)){const d=Dc(e,i,n),h=Ti(Mv,e,i,d);(!c||h[2]>c[2])&&(s[0]=0,s[1]=1-d,s[2]=d,c||(c=al),Br(c,h))}if(hf(i,t,n)){const d=Dc(i,t,n),h=Ti(Mv,i,t,d);(!c||h[2]>c[2])&&(s[0]=d,s[1]=0,s[2]=1-d,c||(c=al),Br(c,h))}if(c)return s}const r=df(n,e,i)/o,a=df(n,i,t)/o,l=1-r-a;return r<0||a<0||l<0||r>1||a>1||l>1?null:(s[0]=r,s[1]=a,s[2]=l,s)}function df(t,e,i){return FI(Iv,e[0]-t[0],i[0]-t[0],e[1]-t[1],i[1]-t[1]),DI(Iv)}function hf(t,e,i){const n=(e[0]-t[0])*(i[1]-t[1])-(e[1]-t[1])*(i[0]-t[0]);return Math.abs(n)>1e-8?!1:(i[0]-t[0])*(i[0]-e[0])+(i[1]-t[1])*(i[1]-e[1])<=0}function Dc(t,e,i){const n=Ai(UI,e,t),s=Ai(GI,i,t);return Vo(s,n)/A2(n)}function Av(t,e,i,n,s){const o=af(s);Zs(n.textureImage).forEach(r=>{if(!r.length)return;const a=i.byKey[ta(r)];if(!a){console.error(`Not found raster set with texture ${r}`);return}if(!a.isSvg)return;const l=n.textureSize;let c;if(n.lengthUnits===vs.Meters){const[h,u=h]=l;c=[h*oa(h,h),u*oa(u,u)]}else c=VI(l);c.forEach(h=>{const[u,f]=Array.isArray(h)?h:[h,h];t.atlasPacker.packSvg(a,[{w:u,h:f}],o),a.rasters.forEach(m=>t.atlasPacker.addRastersToLoad(e,m))})})}function VI(t){return or(t)?t.type==="step"?t.steps.map(e=>Array.isArray(e.value)||typeof e.value=="number"?e.value:e.value.type==="literalArray"?e.value.array:(console.warn("textureSize only supports shallow step expression"),[0])):t.type==="literalArray"?[ai(t)]:(Ze(`Unsupported texture size expression of type "${t.type}". Can't resovle.`),[0]):[t]}function uf(t,e){const{tileAttrs:i,tileProps:n}=t,s=Number.isNaN(i[n.db_begin_nominal_height])?0:i[n.db_begin_nominal_height]??0,o=Number.isNaN(i[n.db_end_nominal_height])?0:i[n.db_end_nominal_height]??0,r=i[n.objectLength]??1,a=i[n.componentDistanceStart]??0,l=i[n.componentDistanceEnd]??0,c=$r(s,o,a/r),d=$r(s,o,l/r),h=t.tileInfo?Xn(t.tileInfo,[0,0]):1,u=Array.from({length:e.x.length});if(c===d)return u.fill(c*Ge*h),u;const f=e.x.length;for(let m=0;m<f;m++)u[m]=Ge*h*$r(c,d,Dc([e.x[0],e.y[0]],[e.x[f-1],e.y[f-1]],[e.x[m],e.y[m]]));return u}const St={symbol:"line",sinks:{solid:{stride:12,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.extender=new Int8Array(e,4),t.views.normal=new Int8Array(e,6),t.views.localID=new Uint32Array(e,8)},packObjectAttributes(t,e,i,n){return It([t,e.innerId,i],e,n)},unpackObjectAttributes(t){return{styleId:t[0],layerId:t[1],tiers:t[2],tileData:t.slice(3)}}},solid3d:{stride:16,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.extender=new Int8Array(e,4),t.views.normal=new Int8Array(e,6),t.views.height=new Float32Array(e,8),t.views.localID=new Uint32Array(e,12)},packObjectAttributes(t,e,i,n){return It([t,e.innerId,i],e,n)},unpackObjectAttributes(t){return{styleId:t[0],layerId:t[1],tiers:t[2],tileData:t.slice(3)}}},patterned:{stride:16,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.extender=new Int16Array(e,4),t.views.texture=new Float32Array(e,8),t.views.localID=new Uint32Array(e,12)},packObjectAttributes(t,e,i,n){return It([t,e.innerId,i],e,n)},unpackObjectAttributes(t){return{styleId:t[0],layerId:t[1],tiers:t[2],tileData:t.slice(3)}}},patterned3d:{stride:20,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.extender=new Int16Array(e,4),t.views.texture=new Float32Array(e,8),t.views.height=new Float32Array(e,12),t.views.localID=new Uint32Array(e,16)},packObjectAttributes(t,e,i,n){return It([t,e.innerId,i],e,n)},unpackObjectAttributes(t){return{styleId:t[0],layerId:t[1],tiers:t[2],tileData:t.slice(3)}}}},generate(t,e,i,n,s,o){const r=Vu(q(i.style.geometryModifier,n),s,o,n);if(r===null)return;const{tileAttrs:a,tileProps:l}=n,c=i.style.withHeight?uf(n,r):void 0,d=t.idIndexer.getIndex(n,e,i),h=q(i.ignoreTier,n)?null:n.tileAttrs[l.db_tiers],u=i.style.withHeight?t.getBucket(i.type,"solid3d",St.sinks.solid3d.packObjectAttributes(e,i,h,n),St.sinks.solid3d.binder):t.getBucket(i.type,"solid",St.sinks.solid.packObjectAttributes(e,i,h,n),St.sinks.solid.binder),f=Number.isNaN(a[l.beginningIsCut])?!1:a[l.beginningIsCut]!==0,m=Number.isNaN(a[l.endingIsCut])?!1:a[l.endingIsCut]!==0,p=Ri(i.style.startCap,n),_=Ri(i.style.endCap,n);$g(u,r.x,r.y,c,r.x.length,f?ht.TileCut:Oc(p),m?ht.TileCut:Oc(_),d)},generatePatterned(t,e,i,n,s,o){const r=Vu(q(i.style.geometryModifier,n),s,o,n);if(r===null)return;const{tileAttrs:a,tileProps:l}=n,c=q(i.ignoreTier,n)?null:n.tileAttrs[l.db_tiers],d=i.style.withHeight?t.getBucket("line","patterned3d",St.sinks.patterned3d.packObjectAttributes(e,i,c,n),St.sinks.patterned3d.binder):t.getBucket("line","patterned",St.sinks.patterned.packObjectAttributes(e,i,c,n),St.sinks.patterned.binder),h=t.idIndexer.getIndex(n,e,i),u=HI(a[l.componentDistanceStart]/xe,a[l.componentDistanceEnd]/xe,a[l.objectLength]/xe,h,i.style.withHeight?St.sinks.patterned3d.stride/2:St.sinks.patterned.stride/2),f=Number.isNaN(a[l.beginningIsCut])?!1:a[l.beginningIsCut]!==0,m=Number.isNaN(a[l.endingIsCut])?!1:a[l.endingIsCut]!==0,p=Ri(i.style.startCap,n),_=Ri(i.style.endCap,n),g=i.style.withHeight?uf(n,r):void 0;nf(r.x,r.y,g,r.x.length,f?ht.TileCut:Oc(p),m?ht.TileCut:Oc(_),a[l.previousPointX],a[l.previousPointY],a[l.nextPointX],a[l.nextPointY],u,d,!0)}},aa={type:nr.Patterned,cDist:0,sLen:0,oLen:0,localID:0,offsetMultiplier:8,px:[],py:[],count:0};function HI(t,e,i,n,s){return aa.cDist=t,aa.sLen=e-t,aa.oLen=i,aa.localID=n,aa.offsetMultiplier=s,aa}function Oc(t){switch(t){case"round":return ht.Round;case"tilecut":return ht.TileCut;case"butt":default:return ht.Butt}}const Bc={symbol:"shiftedLine",sinks:{solid:{stride:16,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.extender=new Int8Array(e,4),t.views.normal=new Int8Array(e,6),t.views.shift=new Float32Array(e,8)},packObjectAttributes(t,e,i,n){return It([t,e.innerId,i],e,n)},unpackObjectAttributes(t){return{styleId:t[0],layerId:t[1],tiers:t[2],tileData:t.slice(3)}}}},generate(t,e,i,n,s){const{tileAttrs:o,tileProps:r}=n,a=Number.isNaN(o[r.beginningIsCut])?!1:o[r.beginningIsCut]!==0,l=Number.isNaN(o[r.endingIsCut])?!1:o[r.endingIsCut]!==0,c=q(i.ignoreTier,n)?null:n.tileAttrs[r.db_tiers],d=t.getBucket(i.type,"solid",Bc.sinks.solid.packObjectAttributes(e,i,c,n),Bc.sinks.solid.binder);$g(d,s.x,s.y,void 0,s.x.length,a?ht.TileCut:ht.Round,l?ht.TileCut:ht.Round,0,s.normal_x,s.normal_y)}};function zi(t,e){return t===0?0:Math.min(t*2-1,(e-t)*2)}function Pv(t,e,i,n,s,o,r,a,l){let c=t.elements.offset;for(let d=0;d<e;d++){const h=zi(d,e),u=d===e-1;if(s&&s[h]===1||!s&&!u){const f=i[h],m=n[h],p=(d+1)%e,_=zi(p,e),g=i[_],y=n[_];$I(t,c),ZI(t,c,f,m,g,y,o),l?Lv(t,c,l[0],l[1],l[0],l[1]):Lv(t,c,f,m,g,y),r!==void 0&&"localID"in t.views&&t.views.localID!==void 0&&Cv(t.views.localID,c,r,t.elements.stride),a!==void 0&&"labelingTextureID"in t.views&&t.views.labelingTextureID!==void 0&&Cv(t.views.labelingTextureID,c,a,t.elements.stride),c=c+4}}t.elements.offset=c}function ZI(t,e,i,n,s,o,r){const a=t.views.position,l=t.elements.stride/a.BYTES_PER_ELEMENT;e=e*l,a[e]=$+i,a[e+1]=$+n,a[e+2]=0,e+=l,a[e]=$+i,a[e+1]=$+n,a[e+2]=Ci(r),e+=l,a[e]=$+s,a[e+1]=$+o,a[e+2]=0,e+=l,a[e]=$+s,a[e+1]=$+o,a[e+2]=Ci(r)}function Lv(t,e,i,n,s,o){const r=t.views.demPosition,a=t.elements.stride/r.BYTES_PER_ELEMENT;e=e*a,i=(i+$)/8,n=(n+$)/8,s=(s+$)/8,o=(o+$)/8,r[e]=i,r[e+1]=n,e+=a,r[e]=i,r[e+1]=n,e+=a,r[e]=s,r[e+1]=o,e+=a,r[e]=s,r[e+1]=o}function Cv(t,e,i,n){const s=n/t.BYTES_PER_ELEMENT;e=e*s,t[e]=i,t[e+=s]=i,t[e+=s]=i,t[e+=s]=i}function $I(t,e){const i=t.indices.buffer;let n=t.indices.offset;i[n++]=e,i[n++]=e+3,i[n++]=e+1,i[n++]=e,i[n++]=e+2,i[n++]=e+3,t.indices.offset=n}const Ws=[.5,.5],Xs=[.5,.5];function ff(t,e,i,n,s,o){let r=t.elements.offset;const a=zi(e-1,e);let l=i[a],c=n[a],d=s?s[a]:0;const h=r;for(let u=0;u<e;u++){const f=zi(u,e),m=u===e-1,p=i[f],_=n[f],g=s?s[f]:m?0:1;d!==0&&(ps(Xs,l,c,p,_),zv(t,r,g,m?h:r+4),XI(t,r,l,c,p,_),o?Rv(t,r,o[0],o[1],o[0],o[1]):Rv(t,r,l,c,p,_),Mu(Xs),YI(t,r,Xs),qI(t,r,Xs),r=r+4),l=p,c=_,d=g}t.elements.offset=r}function _f(t,e,i,n,s,o,r){let a=t.elements.offset;const l=zi(e-2,e),c=zi(e-1,e);let d=i[c],h=n[c],u=s?s[l]:1,f=s?s[c]:0;jn(Ws,i[l],n[l],d,h);let m=Ws[0],p=Ws[1];for(let _=0;_<e;_++){const g=zi(_,e),y=_===e-1,b=i[g],v=n[g],I=s?s[g]:y?0:1;ps(Xs,d,h,b,v);const S=Xs[1],P=-Xs[0];u!==0&&(f===0?(Ws[0]=m,Ws[1]=p):WI(Ws,m,p,S,P),J2(Xs,m,p,Ws[0],Ws[1]),zv(t,a,0,0),KI(t,a,d,h,o,r??[d,h]),JI(t,a,Mu(Ws),Mu(Xs)),QI(t,a),a=a+4),d=b,h=v,u=f,f=I,m=S,p=P}t.elements.offset=a}function WI(t,e,i,n,s){let o,r,a;e*n+i*s>0?(o=e+n,r=i+s,a=1/Math.sqrt(o*o+r*r),t[0]=o*a,t[1]=r*a):(o=s-i,r=e-n,o!==0&&r!==0?(a=1/Math.sqrt(o*o+r*r),t[0]=o*a,t[1]=r*a):(t[0]=0,t[1]=0))}function Rv(t,e,i,n,s,o){const r=t.views.demPosition,a=t.elements.stride/r.BYTES_PER_ELEMENT;e=e*a,i=(i+$)/8,n=(n+$)/8,s=(s+$)/8,o=(o+$)/8,r[e]=i,r[e+1]=n,e+=a,r[e]=i,r[e+1]=n,e+=a,r[e]=s,r[e+1]=o,e+=a,r[e]=s,r[e+1]=o}function XI(t,e,i,n,s,o){const{position:r,distance:a}=t.views,l=t.elements.stride/r.BYTES_PER_ELEMENT;e=e*l,r[e]=$+i,r[e+1]=$+n,r[e+2]=0,a[e]=0,e+=l,r[e]=$+i,r[e+1]=$+n,r[e+2]=0,a[e]=-32767,e+=l,r[e]=$+s,r[e+1]=$+o,r[e+2]=0,a[e]=-32767,e+=l,r[e]=$+s,r[e+1]=$+o,r[e+2]=0,a[e]=0}function YI(t,e,i){const n=t.elements.stride/t.views.normals.BYTES_PER_ELEMENT;e=e*n;for(let s=0;s<4;s++)t.views.normals[e]=i[0],t.views.normals[e+1]=i[1],t.views.normals[e+2]=0,t.views.normals[e+3]=0,e+=n}function qI(t,e,i){const n=t.elements.stride/t.views.direction.BYTES_PER_ELEMENT;e=e*n;for(let s=0;s<4;s++)t.views.direction[e]=i[0],t.views.direction[e+1]=i[1],t.views.direction[e+2]=0,t.views.direction[e+3]=0,e+=n}function KI(t,e,i,n,s,o){const r=t.elements.stride/t.views.position.BYTES_PER_ELEMENT;e=e*r,t.views.position[e]=$+i,t.views.position[e+1]=$+n,t.views.position[e+2]=0,t.views.distance[e]=32767,t.views.demPosition[e]=($+o[0])/8,t.views.demPosition[e+1]=($+o[1])/8,e+=r,t.views.position[e]=$+i,t.views.position[e+1]=$+n,t.views.position[e+2]=0,t.views.distance[e]=-32767,t.views.demPosition[e]=($+o[0])/8,t.views.demPosition[e+1]=($+o[1])/8,e+=r,t.views.position[e]=$+i,t.views.position[e+1]=$+n,t.views.position[e+2]=Ci(s),t.views.distance[e]=-32767,t.views.demPosition[e]=($+o[0])/8,t.views.demPosition[e+1]=($+o[1])/8,e+=r,t.views.position[e]=$+i,t.views.position[e+1]=$+n,t.views.position[e+2]=Ci(s),t.views.distance[e]=32767,t.views.demPosition[e]=($+o[0])/8,t.views.demPosition[e+1]=($+o[1])/8}function JI(t,e,i,n){const s=t.elements.stride/t.views.normals.BYTES_PER_ELEMENT;e=e*s;for(let o=0;o<4;o++)t.views.normals[e]=i[0],t.views.normals[e+1]=i[1],t.views.normals[e+2]=n[0],t.views.normals[e+3]=n[1],e+=s}function QI(t,e){const i=t.elements.stride/t.views.direction.BYTES_PER_ELEMENT;e=e*i;for(let n=0;n<4;n++)t.views.direction[e]=0,t.views.direction[e+2]=127,e+=i}function zv(t,e,i,n){const s=t.indices.buffer;let o=t.indices.offset;s[o++]=e,s[o++]=e+1,s[o++]=e+3,s[o++]=e+3,s[o++]=e+1,s[o++]=e+2,i!==0&&(s[o++]=e+2,s[o++]=n+1,s[o++]=n+0),t.indices.offset=o}const ll=Oe(),cl=Oe(),Ys=Oe();function dl(t,e,i,n,s,o,r,a,l,c,d,h,u){gt(ll,e,i,n),gt(cl,s,o,r),vi(Ys,cl,ll),y2(cl,ll)||(Ui(Ys,Ys),Ni(Ys,Ys,127)),eT(t,0,1,3,3,1,2),kc(t,ll,Ys,1,a,l,c,h),kc(t,ll,Ys,-1,a,l,c,h),kc(t,cl,Ys,-1,a,l,d,u),kc(t,cl,Ys,1,a,l,d,u)}function kc(t,e,i,n,s,o,r,a){const l=t.elements.offset*t.elements.stride,c=l/t.views.position.BYTES_PER_ELEMENT;if(t.views.position[c]=o?e[0]:$+e[0],t.views.position[c+1]=o?e[1]:$+e[1],"z"in t.views){const d=l/t.views.z.BYTES_PER_ELEMENT;t.views.z[d]=e[2]}else t.views.position[c+2]=o?e[2]:Ci(e[2]);if(t.views.directionDistance[l]=i[0],t.views.directionDistance[l+1]=i[1],t.views.directionDistance[l+2]=i[2],t.views.directionDistance[l+3]=n,"demPosition"in t.views){const d=l/t.views.demPosition.BYTES_PER_ELEMENT;s=s??e,t.views.demPosition[d]=(o?s[0]:$+s[0])/8,t.views.demPosition[d+1]=(o?s[1]:$+s[1])/8}"absZ"in t.views&&r!==void 0&&(t.views.absZ[l/t.views.absZ.BYTES_PER_ELEMENT]=r),"isPivot"in t.views&&(t.views.isPivot[l/t.views.isPivot.BYTES_PER_ELEMENT]=a??0),t.elements.offset++}function eT(t,e,i,n,s,o,r){const a=t.indices.buffer,l=t.indices.offset,c=t.elements.offset;a[l]=c+e,a[l+1]=c+i,a[l+2]=c+n,a[l+3]=c+s,a[l+4]=c+o,a[l+5]=c+r,t.indices.offset=l+6}const Nc=xe/2,hl=(t,e,i,n,s,o)=>It([t,e.innerId,i,n,s],e,o),Uc=t=>({styleId:t[0],layerId:t[1],hiddenById:t[2],floorId:t[3],isFloorStack:t[4],tileData:t.slice(5)}),ws={symbol:"polygonExtrusion",sinks:{sideFill:{stride:20,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.localID=new Uint32Array(e,8),t.views.demPosition=new Int16Array(e,12),t.views.labelingTextureID=new Uint32Array(e,16)},packObjectAttributes:hl,unpackObjectAttributes:Uc},topFill:{stride:20,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.localID=new Uint32Array(e,8),t.views.demPosition=new Int16Array(e,12),t.views.labelingTextureID=new Uint32Array(e,16)},packObjectAttributes:hl,unpackObjectAttributes:Uc},sideStroke:{stride:20,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.distance=new Int16Array(e,6),t.views.normals=new Int8Array(e,8),t.views.direction=new Int8Array(e,12),t.views.demPosition=new Int16Array(e,16)},packObjectAttributes:hl,unpackObjectAttributes:Uc},topStroke:{stride:16,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.directionDistance=new Int8Array(e,8),t.views.demPosition=new Int16Array(e,12)},packObjectAttributes:hl,unpackObjectAttributes:Uc}},generate(t,e,i,n,s){const o=s.x,r=s.y,a=s.cut??[],l=n.tileProps.db_plan_id?n.tileAttrs[n.tileProps.db_plan_id]:"",c=n.tileAttrs[n.tileProps.db_hidden_by_plan_building_id]??"",d=n.tileAttrs[n.tileProps.db_sublayer]==="Floor_ground",h=o.length,u=n.id??"";let f;n.tileProps.db_centroid_x&&n.tileProps.db_centroid_y&&!Number.isNaN(n.tileAttrs[n.tileProps.db_centroid_x])&&!Number.isNaN(n.tileAttrs[n.tileProps.db_centroid_y])?f=[n.tileAttrs[n.tileProps.db_centroid_x],n.tileAttrs[n.tileProps.db_centroid_y]]:f=oT(o,r,a);const m=q(i.style.height,n),p=n.tileInfo?Xn(n.tileInfo,[0,0]):1,_=m*Ge*p,g=t.idIndexer.getIndex(n,e,i,{floorId:Number.isNaN(l)?void 0:l}),y=t.pointIndexer.getIndex(u),b=hl(e,i,c,l,d,n);if(_>0){const P=t.getBucket("polygonExtrusion","sideFill",b,ws.sinks.sideFill.binder);let T=P.indices.offset;Pv(P,h,o,r,a,_,g,y,f),P.objectsData[T]={objectId:u,size:P.indices.offset-T};const L=t.getBucket("polygonExtrusion","sideStroke",b,ws.sinks.sideStroke.binder);l||(T=L.indices.offset,ff(L,h,o,r,a,f),_f(L,h,o,r,a,_,f),L.objectsData[T]={objectId:u,size:L.indices.offset-T})}const v=t.getBucket("polygonExtrusion","topFill",b,ws.sinks.topFill.binder);let I=v.indices.offset;tT(v,h,o,r,_,g,y,f),v.objectsData[I]={objectId:u,size:v.indices.offset-I};const S=t.getBucket("polygonExtrusion","topStroke",b,ws.sinks.topStroke.binder);I=S.indices.offset,iT(S,h,o,r,a,_,f),S.objectsData[I]={objectId:u,size:S.indices.offset-I}}};function tT(t,e,i,n,s,o,r,a){let l=t.elements.offset;const c=l;mf(t,l++,i[0],n[0],s,o,r,a),mf(t,l++,i[1],n[1],s,o,r,a);for(let d=2;d<e;d++)nT(t,c,d),mf(t,l++,i[d],n[d],s,o,r,a);t.elements.offset=l}function iT(t,e,i,n,s,o,r){for(let a=0;a<e;a++){const l=zi(a,e);if(s&&s[l]===1){const c=zi((a+1)%e,e);dl(t,i[l],n[l],o,i[c],n[c],o,r)}}}function mf(t,e,i,n,s,o,r,a){const l=t.elements.stride,c=e*(l/t.views.position.BYTES_PER_ELEMENT);t.views.position[c]=$+i,t.views.position[c+1]=$+n,t.views.position[c+2]=Ci(s),t.views.position[c+3]=1,t.views.demPosition[c]=($+a[0])/8,t.views.demPosition[c+1]=($+a[1])/8;const d=e*(l/t.views.localID.BYTES_PER_ELEMENT);t.views.localID[d]=o,t.views.labelingTextureID[d]=r}function nT(t,e,i){const n=t.indices.buffer;let s=t.indices.offset;i%2===0?(n[s++]=e+i-2,n[s++]=e+i-1,n[s++]=e+i):(n[s++]=e+i-1,n[s++]=e+i-2,n[s++]=e+i),t.indices.offset=s}function Fv(t){return(Nc-Math.abs(t[0]-Nc))**2+(Nc-Math.abs(t[1]-Nc))**2}function sT(t){return t[0]===0||t[0]===xe||t[1]===0||t[1]===xe}function oT(t,e,i){let n,s=xe**2;const o=t.length,r=ji();for(let a=0;a<o;a++){n||Vi(r,[t[a],e[a]]);const l=zi(a,o);if(i[l]===0){const c=[t[l],e[l]],d=zi((a+1)%o,o),h=[t[d],e[d]];if(sT(c)){const u=Fv(c);u<s&&(n=c,s=u);const f=Fv(h);f<s&&(n=h,s=f)}else n=[(t[l]+t[d])/2,(e[l]+e[d])/2]}}return n||(n=[],Gr(n,r)),n}const ul={type:nr.Striped,cDist:0,oLen:0,sLen:0,localID:0,offsetMultiplier:14,px:[],py:[],count:0};function rT(t,e,i,n){return ul.cDist=t,ul.oLen=e,ul.localID=i,ul.offsetMultiplier=n,ul}const es={symbol:"dashedLine",sinks:{stroke:{stride:28,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.extender=new Int16Array(e,4),t.views.texExtender=new Int8Array(e,8),t.views.vertexDistance=new Float32Array(e,12),t.views.componentDistance=new Float32Array(e,16),t.views.objectLength=new Float32Array(e,20),t.views.localID=new Uint32Array(e,24)},packObjectAttributes(t,e,i,n){return It([t,e.innerId,i],e,n)},unpackObjectAttributes(t){return{styleId:t[0],layerId:t[1],tiers:t[2],tileData:t.slice(3)}}},stroke3d:{stride:32,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.extender=new Int16Array(e,4),t.views.texExtender=new Int8Array(e,8),t.views.vertexDistance=new Float32Array(e,12),t.views.componentDistance=new Float32Array(e,16),t.views.objectLength=new Float32Array(e,20),t.views.height=new Float32Array(e,24),t.views.localID=new Uint32Array(e,28)},packObjectAttributes(t,e,i,n){return It([t,e.innerId,i],e,n)},unpackObjectAttributes(t){return{styleId:t[0],layerId:t[1],tiers:t[2],tileData:t.slice(3)}}}},generate(t,e,i,n,s,o){const r=Vu(q(i.style.geometryModifier,n),s,o,n);if(r===null)return;const{tileAttrs:a,tileProps:l}=n,c=q(i.ignoreTier,n)?null:n.tileAttrs[l.db_tiers],d=i.style.withHeight?t.getBucket(i.type,"stroke3d",es.sinks.stroke3d.packObjectAttributes(e,i,c,n),es.sinks.stroke3d.binder):t.getBucket(i.type,"stroke",es.sinks.stroke.packObjectAttributes(e,i,c,n),es.sinks.stroke.binder),h=t.idIndexer.getIndex(n,e,i),u=rT(a[l.componentDistanceStart]/xe,a[l.objectLength]/xe,h,i.style.withHeight?es.sinks.stroke3d.stride/2:es.sinks.stroke.stride/2),f=Number.isNaN(a[l.beginningIsCut])?!1:a[l.beginningIsCut]!==0,m=Number.isNaN(a[l.endingIsCut])?!1:a[l.endingIsCut]!==0,p=i.style.withHeight?uf(n,r):void 0;nf(r.x,r.y,p,r.x.length,f?ht.TileCut:ht.Butt,m?ht.TileCut:ht.Butt,a[l.previousPointX],a[l.previousPointY],a[l.nextPointX],a[l.nextPointY],u,d)}},Gc=[rt/2,rt/2],Fn={symbol:"buildingModel",sinks:{fill:{stride:24,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.texCoords=new Uint16Array(e,8),t.views.localID=new Uint32Array(e,12),t.views.demPosition=new Int16Array(e,16),t.views.labelingTextureID=new Uint32Array(e,20)},packObjectAttributes:(t,e,i,n,s,o)=>It([t,e.innerId,i,s,n],e,o),unpackObjectAttributes:t=>({styleId:t[0],layerId:t[1],texture:t[2],id:t[3],matrix:t[4],tileData:t.slice(5)})},stroke:{stride:16,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.directionDistance=new Int8Array(e,8),t.views.demPosition=new Int16Array(e,12)},packObjectAttributes:(t,e,i,n,s)=>It([t,e.innerId,n,i],e,s),unpackObjectAttributes:t=>({styleId:t[0],layerId:t[1],id:t[2],matrix:t[3],tileData:t.slice(4)})}},processSubmesh(t,e,i,n,s,o,r,a,l){const c=i.id??"",d=n.idIndexer.getIndex(i,t,e),h=n.pointIndexer.getIndex(c),u=n.getBucket(e.type,"fill",Fn.sinks.fill.packObjectAttributes(t,e,a,l,c,i),Fn.sinks.fill.binder,r);lT(u,o);for(let f=0;f<s.length;f++)aT(u,s,f,d,h)},processOuterEdge(t,e,i,n,s,o,r){const a=i.id??"",l=n.getBucket(e.type,"stroke",Fn.sinks.stroke.packObjectAttributes(t,e,r,a,i),Fn.sinks.stroke.binder);for(let c=0;c<o.length;c+=2){const d=o[c]*5,h=o[c+1]*5;dl(l,s[d],s[d+1],s[d+2],s[h],s[h+1],s[h+2],Gc,!0)}}};function aT(t,e,i,n,s){const o=t.elements.offset,r=Fn.sinks.fill.stride,a=i*5,l=o*(r/t.views.position.BYTES_PER_ELEMENT),c=o*(r/t.views.localID.BYTES_PER_ELEMENT);t.views.position[l]=e[a],t.views.position[l+1]=e[a+1],t.views.position[l+2]=e[a+2],t.views.texCoords[l]=e[a+3],t.views.texCoords[l+1]=e[a+4],t.views.localID[c]=n,t.views.demPosition[l]=Gc[0]/8,t.views.demPosition[l+1]=Gc[1]/8,t.views.labelingTextureID[c]=s,t.elements.offset++}function lT(t,e){const i=t.elements.offset;let n=t.indices.offset;for(let s=0;s<e.length;s++)t.indices.buffer[n++]=i+e[s];t.indices.offset=n}const la=xt(),fl=xt(),ca={type:nr.Entrance,offsetMultiplier:18,cDist:0,oLen:0,sLen:0,px:[],py:[],count:0,localID:0};function cT(t,e,i,n){return ca.px=t.x,ca.py=t.y,ca.oLen=i/xe,ca.count=e,ca.localID=n,ca}const _l={symbol:"arrow",sinks:{stroke:{stride:36,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.segmentEnd=new Uint16Array(e,4),t.views.texExtender=new Int8Array(e,8),t.views.arrowExtender=new Int8Array(e,10),t.views.extender=new Int16Array(e,12),t.views.direction=new Int16Array(e,16),t.views.vertexDistance=new Float32Array(e,20),t.views.objectLength=new Float32Array(e,24),t.views.type=new Float32Array(e,28),t.views.localID=new Uint32Array(e,32)},packObjectAttributes(t,e,i,n){return It([t,e.innerId,i>2?1:0],e,n)},unpackObjectAttributes(t){return{styleId:t[0],layerId:t[1],isLongArrow:t[2],tileData:t.slice(3)}}}},generate:(t,e,i,n,s)=>{const o=s.x,r=s.y,a=s.x.length,l=dT(o,r,a),c=t.getBucket(i.type,"stroke",_l.sinks.stroke.packObjectAttributes(e,i,a,n),_l.sinks.stroke.binder),d=t.idIndexer.getIndex(n,e,i),h=cT(s,a,l,d);nf(s.x,s.y,void 0,a,ht.Butt,ht.Butt,0,0,0,0,h,c);let u=0;Dv(c,tl.StartBorder,o[0],r[0],o[1],r[1],0,0,u,l,d);for(let f=0;f<a-1;f++){if(f!==0){const m=o[f]-o[f-1],p=r[f]-r[f-1];u+=Math.sqrt(m*m+p*p)}Dv(c,tl.Arrow,o[f],r[f],o[f+1],r[f+1],-1,0,u,l,d)}}};function dT(t,e,i){let n=0;for(let s=1;s<i;s++){const o=t[s]-t[s-1],r=e[s]-e[s-1];n+=Math.sqrt(o*o+r*r)}return n}function Dv(t,e,i,n,s,o,r,a,l,c,d){hT(t,1,2,0,0,2,3),jc(t,e,i,n,s,o,r,a,-1,-1,l,c,!0,d),jc(t,e,i,n,s,o,r,a,1,-1,l,c,!1,d),jc(t,e,i,n,s,o,r,a,1,1,l,c,!1,d),jc(t,e,i,n,s,o,r,a,-1,1,l,c,!0,d)}function jc(t,e,i,n,s,o,r,a,l,c,d,h,u,f){const m=t.elements,p=m.stride*m.offset,_=p>>1,g=_>>1;ps(la,i,n,s,o),yo(fl,la),t.views.position[_]=$+i,t.views.position[_+1]=$+n,t.views.segmentEnd[_]=$+s,t.views.segmentEnd[_+1]=$+o,t.views.texExtender[p]=qt(fl[0]*c*(u?-1:1)*At),t.views.texExtender[p+1]=qt(fl[1]*c*(u?-1:1)*At),t.views.arrowExtender[p]=qt(l*At),t.views.arrowExtender[p+1]=qt(c*At);const y=l+r,b=c+a,v=la[0]*y+fl[0]*b,I=la[1]*y+fl[1]*b;t.views.extender[_]=Math.round(v*At*127),t.views.extender[_+1]=Math.round(I*At*127),t.views.direction[_]=Math.round(la[0]*127),t.views.direction[_+1]=Math.round(la[1]*127),t.views.vertexDistance[g]=d/rt,t.views.objectLength[g]=h/rt,t.views.type[g]=e,t.views.localID[g]=f,t.elements.offset++}function hT(t,e,i,n,s,o,r){const{elements:a,indices:l}=t,{buffer:c,offset:d}=l,h=a.offset;c[d]=h+e,c[d+1]=h+i,c[d+2]=h+n,c[d+3]=h+s,c[d+4]=h+o,c[d+5]=h+r,l.offset=d+6}const da={symbol:"circle",sinks:{fill:{stride:20,binder:(t,e)=>{t.views.flatPosition=new Uint16Array(e),t.views.ecefPosition=new Int16Array(e,6),t.views.extender=new Int16Array(e,12),t.views.localID=new Uint32Array(e,16)},packObjectAttributes:(t,e,i)=>It([t,e.innerId],e,i),unpackObjectAttributes:t=>({styleId:t[0],layerId:t[1],tileData:t.slice(2)})}},generate(t,e,i,n,s){const o=t.getBucket(i.type,"fill",da.sinks.fill.packObjectAttributes(e,i,n),da.sinks.fill.binder),r=t.idIndexer.getIndex(n,e,i),a=[s.x[0],s.y[0],s.z?s.z[0]:0],l=n.tileInfo?Uu(n.tileInfo,a):[0,0,0];uT(o,0,2,1,0,3,2),Vc(o,a,l,-1,-1,r),Vc(o,a,l,-1,1,r),Vc(o,a,l,1,1,r),Vc(o,a,l,1,-1,r)}};function Vc(t,[e,i,n],s,o,r,a){const c=t.elements.offset*t.elements.stride>>1,d=c>>1;t.views.flatPosition[c]=$+e,t.views.flatPosition[c+1]=$+i,t.views.flatPosition[c+2]=Ci(n),t.views.ecefPosition[c]=s[0]*Pi,t.views.ecefPosition[c+1]=s[1]*Pi,t.views.ecefPosition[c+2]=s[2]*Pi,t.views.extender[c]=o,t.views.extender[c+1]=r,t.views.localID[d]=a,t.elements.offset++}function uT(t,e,i,n,s,o,r){const{elements:a,indices:l}=t,{buffer:c,offset:d}=l,h=a.offset;c[d]=h+e,c[d+1]=h+i,c[d+2]=h+n,c[d+3]=h+s,c[d+4]=h+o,c[d+5]=h+r,l.offset=d+6}const ha=xt(),ua=xt(),Ov=xt(),Bv=xt(),pf=(t,e,i)=>It([t,e.innerId],e,i),gf=t=>({styleId:t[0],layerId:t[1],tileData:t.slice(2)}),ml=Gg(1),bs={symbol:"lineExtrusion",sinks:{fill:{stride:12,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.demPosition=new Int16Array(e,8)},packObjectAttributes:pf,unpackObjectAttributes:gf},topStroke:{stride:16,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.directionDistance=new Int8Array(e,8),t.views.demPosition=new Int16Array(e,12)},packObjectAttributes:pf,unpackObjectAttributes:gf},sideStroke:{stride:20,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.distance=new Int16Array(e,6),t.views.normals=new Int8Array(e,8),t.views.direction=new Int8Array(e,12),t.views.demPosition=new Int16Array(e,16)},packObjectAttributes:pf,unpackObjectAttributes:gf}},generate(t,e,i,n,s){const o=s.x,r=s.y,a=o.length,l=t.getBucket(i.type,"fill",bs.sinks.fill.packObjectAttributes(e,i,n),bs.sinks.fill.binder),c=t.getBucket(i.type,"topStroke",bs.sinks.topStroke.packObjectAttributes(e,i,n),bs.sinks.topStroke.binder),d=t.getBucket(i.type,"sideStroke",bs.sinks.sideStroke.packObjectAttributes(e,i,n),bs.sinks.sideStroke.binder);for(let h=0;h<a-1;h++){const u=o[h],f=r[h],m=o[h+1],p=r[h+1];Vt(ha,u,m),Vt(ua,f,p),Vt(Ov,m,u),Vt(Bv,p,f),Pv(l,2,ha,ua,void 0,ml),dl(c,u,f,ml,m,p,ml),ff(d,2,ha,ua,void 0),ff(d,2,Ov,Bv,void 0),_f(d,2,ha,ua,void 0,ml)}Vt(ha,o[a-1],o[0]),Vt(ua,r[a-1],r[0]),_f(d,2,ha,ua,void 0,ml)}};function fT(t){const e=Math.log(t)*256;return e+(e<0?-.5:.5)<<16>>16}function Yi(t){return t*32768+.5<<16>>>16}function _T(t){return Math.log(t)*256+.5<<16>>16}const fa={symbol:"raster",sinks:{fill:{stride:8,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.txtrCoords=new Uint16Array(e,4)},packObjectAttributes(t,e,i,n,s){return It([t,e.innerId,n,s],e,i)},unpackObjectAttributes(t){return{styleId:t[0],layerId:t[1],textureIndex:t[2],tiers:t[3],tileData:t.slice(4)}}}},generate(t,e,i,n,s,o,r){const a=e.x,l=e.y,c=t.getBucket(s.type,"fill",fa.sinks.fill.packObjectAttributes(i,s,n,o,r),fa.sinks.fill.binder);let d=c.elements.offset;mT(c.indices,d,0,1,2,2,1,3),Hc(c,d++,a[0],l[0],0,1),Hc(c,d++,a[1],l[1],1,1),Hc(c,d++,a[2],l[2],0,0),Hc(c,d++,a[3],l[3],1,0),c.elements.offset=d}};function Hc(t,e,i,n,s,o){e=e*4,t.views.position[e]=$+i,t.views.position[e+1]=$+n,t.views.txtrCoords[e]=Yi(s),t.views.txtrCoords[e+1]=Yi(o)}function mT(t,e,i,n,s,o,r,a){const l=t.buffer,c=t.offset;l[c]=e+i,l[c+1]=e+n,l[c+2]=e+s,l[c+3]=e+o,l[c+4]=e+r,l[c+5]=e+a,t.offset=c+6}function pT(t){return!!t&&t.type==="polygon"}function Zc(t){return!!t&&t.type==="line"}function kv(t){return t.reduce((e,i,n)=>(e[i]=n,e),{})}function gT(t){return t===void 0||typeof t=="boolean"?!!t:!!JSON.stringify(t).match(/\["get","(db_)?sublayer"]/)}function Nv(t,e,i,n,s){return It([t,e.innerId,i,n],e,s)}const vT=(t,e,i,n,s)=>It([t,e.innerId,i,n],e,s),Uv=t=>({styleId:t[0],layerId:t[1],tiers:t[2],floorId:t[3],tileData:t.slice(4)}),qi={symbol:"polygon",sinks:{fill:{stride:8,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.localID=new Uint32Array(e,4)},packObjectAttributes:Nv,unpackObjectAttributes:Uv},stroke:{stride:8,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.directionDistance=new Int8Array(e,4)},packObjectAttributes:Nv,unpackObjectAttributes:Uv},shadow:{stride:4,binder:(t,e)=>{t.views.position=new Uint16Array(e)},packObjectAttributes:vT,unpackObjectAttributes:t=>({styleId:t[0],layerId:t[1],tiers:t[2],floorId:t[3],tileData:t.slice(4)})}},generate(t,e,i,n,s,o,r){if(n.tileAttrs[n.tileProps.db_geometry_type]==="polyline")return;const l=s.x,c=s.y,d=s.cut,h=n.tileAttrs[n.tileProps.db_plan_id]||"";pT(i)&&r&&Av(t,e,r,i.style,o);const u=t.idIndexer.getIndex(n,e,i,{floorId:h||void 0}),f=n.id??"",m=i.type==="polygon"&&!q(i.ignoreTier,n)?n.tileAttrs[n.tileProps.db_tiers]:null,p=t.getBucket("polygon","fill",qi.sinks.fill.packObjectAttributes(e,i,m,h,n),qi.sinks.fill.binder),_=p.indices.offset;Gv(p,l.length,l,c,u),p.objectsData[_]={objectId:f,size:p.indices.offset-_};const g=t.getBucket("polygon","stroke",qi.sinks.stroke.packObjectAttributes(e,i,m,h,n),qi.sinks.stroke.binder);if(d){const y=g.indices.offset;yT(g,l.length,l,c,d),g.objectsData[y]={objectId:f,size:g.indices.offset-y}}}};function Gv(t,e,i,n,s){const o=t.indices.buffer;let r=t.indices.offset,a=t.elements.offset;const l=a;vf(t,a++,i[0],n[0],s),vf(t,a++,i[1],n[1],s);for(let c=2;c<e;c++)wT(o,r,l,c),vf(t,a++,i[c],n[c],s),r=r+3;t.elements.offset=a,t.indices.offset=r}function yT(t,e,i,n,s){for(let o=0;o<e;o++){const r=zi(o,e);if(s[r]===1){const a=zi((o+1)%e,e);dl(t,i[r],n[r],0,i[a],n[a],0)}}}function vf(t,e,i,n,s){e=e*t.elements.stride/t.views.position.BYTES_PER_ELEMENT,t.views.position[e]=$+i,t.views.position[e+1]=$+n,e=e>>1,"localID"in t.views&&(t.views.localID[e]=s)}function wT(t,e,i,n){n%2===0?(t[e]=i+n-2,t[e+1]=i+n-1,t[e+2]=i+n):(t[e]=i+n-1,t[e+1]=i+n-2,t[e+2]=i+n)}function bT(t,e,i=[],n=[]){return{x:jv(i,t),y:jv(n,e)}}function jv(t,e){const i=t.reduce((s,o)=>s.concat(o),[0]).concat(e),n=i.length-1;return{coords:i.slice(i[0]===i[1]?1:0,i[n-1]===i[n]?n:n+1),isOddStretchable:xT(t)}}function xT(t){var e;return!((e=t==null?void 0:t[0])!=null&&e[0])}function ST(t,e,i,n,s){return[Vv(t.x,e,n[0],s),Vv(t.y,i,n[1],s)]}function Vv(t,e,i,n){if(t.coords.length<2)throw new Error("The source coords array must have at least two coordinates");return t.coords.map((s,o)=>(e+s+n*(o===0?-1:o===t.coords.length-1?1:0))/i)}function MT(t,e,i,n,s=0,o=0){return[Zv(Hv(t.x,e),n,s),Zv(Hv(t.y,i),n,o)]}function Hv(t,e){const{stretchSize:i,fixSize:n}=IT(t),{coords:s,isOddStretchable:o}=t,r=e<n?n:e,a=[s[0]];for(let l=1;l<s.length;l++){const c=s[l-1],d=s[l],h=l%2===(o?1:0),u=a[a.length-1];if(!h){a.push(u+d-c);continue}a.push(Math.round((r-n)*(d-c)/i)+u)}return a}function IT({coords:t,isOddStretchable:e}){if(t.length<2)throw new Error("An axis must have at least two coordinates");if(t.length===2)return{stretchSize:t[t.length-1],fixSize:0};let i=0;for(let n=e?0:1;n<t.length-1;n=n+2)i+=t[n+1]-t[n];return{stretchSize:i,fixSize:t[t.length-1]-i}}function Zv(t,e,i=0){const n=t[t.length-1]-t[0],s=t.map(o=>Math.round(o-n/2+i));return s.length===2?s[s.length-1]+=2*e:(s[0]-=e,s[s.length-1]+=e),s}function TT(t,e,i,n,s,o,r,a,l){const c=bT(i.w,i.h,a,l),d=ST(c,i.x,i.y,e,Ip),h=MT(c,n,s,Ip,o,r);t.set(h,d)}function ET(t,e,i,n,s,o,r,a,l,c,d,h){const{textureX:u,textureY:f,stretchedX:m,stretchedY:p,countX:_,countY:g}=s,y=r!==-1/0?r:o2,b=a!==1/0?a:r2,[v,I]=h;for(let S=0;S<_-1;S++){const P=u[S],T=u[S+1],L=m[S],B=m[S+1];for(let O=0;O<g-1;O++){const w=f[O],x=f[O+1],C=p[O],V=p[O+1];$v(o,0,2,1,1,2,3),$c(o,t,e,i,n,L,C,P,w,v,I,y,b,l,c,d),$c(o,t,e,i,n,B,C,T,w,v,I,y,b,l,c,d),$c(o,t,e,i,n,L,V,P,x,v,I,y,b,l,c,d),$c(o,t,e,i,n,B,V,T,x,v,I,y,b,l,c,d)}}}const hr=[0,0];function AT(t,e,i,n,s,o,r){const{stretchedX:a,stretchedY:l}=n,c=Math.ceil((a[a.length-1]-a[0])/2),d=Math.ceil((l[l.length-1]-l[0])/2),h=o*Xh/2;hr[0]=a[0]+c,hr[1]=l[0]+d;const u=hr[0]-h,f=hr[0]+h,m=hr[1]-h,p=hr[1]+h;return $v(s,0,2,1,1,2,3),Wc(s,t,e,i,u,m,r),Wc(s,t,e,i,f,m,r),Wc(s,t,e,i,u,p,r),Wc(s,t,e,i,f,p,r),hr}function $c(t,e,i,n,s,o,r,a,l,c,d,h,u,f,m,p){let _=t.elements.offset*20;t.views.flatPosition[_]=$+e,t.views.flatPosition[_+1]=$+i,t.views.flatPosition[_+2]=Ci(n),t.views.ecefPosition[_]=s[0]*Pi,t.views.ecefPosition[_+1]=s[1]*Pi,t.views.ecefPosition[_+2]=s[2]*Pi,t.views.cornerOffset[_]=o,t.views.cornerOffset[_+1]=-r,t.views.checkPointOffset[_]=c,t.views.checkPointOffset[_+1]=d,t.views.texCoords[_]=Yi(a),t.views.texCoords[_+1]=Yi(l),t.views.scales[_]=_T(h),t.views.scales[_+1]=fT(u),_=_>>1,t.views.localID[_]=f,t.views.labelingTextureID[_]=m,t.views.spritePointTextureID[_]=p,t.elements.offset++}function Wc(t,e,i,n,s,o,r){const a=t.elements,l=a.stride*a.offset>>1;t.views.position[l]=$+e,t.views.position[l+1]=$+i,t.views.position[l+2]=Ci(n),t.views.cornerOffset[l]=s,t.views.cornerOffset[l+1]=-o,t.views.labelingTextureID[l>>1]=r,a.offset++}function $v(t,e,i,n,s,o,r){const{elements:a,indices:l}=t,{buffer:c,offset:d}=l,h=a.offset;c[d]=h+e,c[d+1]=h+i,c[d+2]=h+n,c[d+3]=h+s,c[d+4]=h+o,c[d+5]=h+r,l.offset=d+6}class PT{constructor(){this.countX=0,this.countY=0,this.textureX=[],this.textureY=[],this.stretchedX=[],this.stretchedY=[]}reset(){this.countX=0,this.countY=0}set(e,i){this.countX=i[0].length,this.countY=i[1].length,this.textureX=i[0],this.textureY=i[1],this.stretchedX=e[0],this.stretchedY=e[1]}isEmpty(){return this.countX===0||this.countY===0}}var Ki=(t=>(t[t.Common=0]="Common",t[t.Commercial=1]="Commercial",t[t.CommercialCity=2]="CommercialCity",t[t.CommercialPremium=3]="CommercialPremium",t[t.Landmark=4]="Landmark",t))(Ki||{}),_a=(t=>(t[t.Point=0]="Point",t[t.Line=1]="Line",t))(_a||{}),Eo=(t=>(t[t.Tile=0]="Tile",t[t.Floor=1]="Floor",t[t.DynamicObject=2]="DynamicObject",t[t.PersonalPoi=3]="PersonalPoi",t))(Eo||{}),xi=(t=>(t[t.Dead=0]="Dead",t[t.Alive=1]="Alive",t[t.Unused=2]="Unused",t[t.CommercialAlive=3]="CommercialAlive",t[t.CommercialDead=4]="CommercialDead",t))(xi||{}),xs=(t=>(t[t.Text=0]="Text",t[t.Icon=1]="Icon",t[t.PoiText=2]="PoiText",t[t.PoiText2=3]="PoiText2",t[t.OneWayLine=4]="OneWayLine",t[t.LineText=5]="LineText",t[t.Box=6]="Box",t))(xs||{});let LT=Math.random;var Ss=(t=>(t[t.Point=0]="Point",t[t.Line=1]="Line",t[t.OneWayLine=2]="OneWayLine",t))(Ss||{});function Fi(t,e){return Number.isNaN(t)?e:t}function Xc(t,e){if(!t)return"";const i=q(t,e);return!Number.isNaN(i)&&(i||i===0)?String(i):""}const Di=4294967295,qs=4294967040,CT=qs-1,yf={},RT=1e6,Wv=["main","parser","labeling","models"];let wf=0;Wv.forEach(t=>{const e=wf+Math.floor(CT/Wv.length);yf[t]={min:wf,max:e-RT},wf=e});class zT{constructor(e){this.ids=[],this.orphanIds=[],this.phases=[],this.sublayers=[],this.styleIds=[],this.layerIds=[],this.instanceIds=[],this.objectClasses=[],this.floorIds=[],this.center=[],this.strings={},this.minIdentifyIndex=yf[e].min,this.maxIdentifyIndex=yf[e].max,this.index=this.minIdentifyIndex}getIndex(e,i,n,s={}){const{id:o,tileProps:r,tileAttrs:a}=e,l=n.interactive,c=s.ignoreHover?!1:a[r.hovered],d=c&&n.type!=="polygon3d"||n.type==="embankment";return!!o&&l&&!c&&!d?this.getIndexInternal({id:o,styleId:i,layer:n,sublayer:a[r.db_sublayer],...s}):Di}getIndexInternal(e){var o,r,a,l;const i=this.index+this.ids.length;this.ids.push(e.id),this.floorIds.push(e.floorId??""),this.phases.push(e.layer.renderIndex),this.sublayers.push(((r=(o=e.metatile)==null?void 0:o.dictionaries.db_sublayer)==null?void 0:r[e.sublayer])??NaN),this.styleIds.push(e.styleId),this.layerIds.push(e.layer.innerId),this.instanceIds.push(e.instanceId??0);const{center:n,objectClass:s}=e;if(n?this.center.push(Math.round(n[0]),Math.round(n[1])):this.center.push(oc,oc),typeof s=="string"){const c=(l=(a=e.metatile)==null?void 0:a.dictionaries.db_object_class)==null?void 0:l[s];c?this.objectClasses.push(c):(this.objectClasses.push(0),this.strings[i]={objectClass:s})}else this.objectClasses.push(Di);return i}addOrphanId(e){this.orphanIds.push(e)}getIndexerStats(){return{ids:this.ids.length,orphanIds:this.orphanIds.length,floorIds:this.floorIds.length,phases:this.phases.length,sublayers:this.sublayers.length,styleIds:this.styleIds.length,layerIds:this.layerIds.length,instanceIds:this.instanceIds.length,objectClasses:this.objectClasses.length,strings:Object.keys(this.strings).length,center:this.center.length}}getPacked(){const e=this.ids,i=this.orphanIds,n=this.floorIds,s=new Float32Array(this.phases).buffer,o=new Uint32Array(this.sublayers).buffer,r=new Uint16Array(this.styleIds).buffer,a=new Uint32Array(this.layerIds).buffer,l=new Uint8Array(this.instanceIds).buffer,c=new Uint32Array(this.objectClasses).buffer,d=new Int32Array(this.center).buffer,h=this.index,u=this.index+this.ids.length-1;this.index=this.index+this.ids.length,this.index>this.maxIdentifyIndex&&(this.index=this.minIdentifyIndex);const f=this.strings;return this.ids=[],this.orphanIds=[],this.floorIds=[],this.phases=[],this.sublayers=[],this.styleIds=[],this.layerIds=[],this.instanceIds=[],this.objectClasses=[],this.strings={},this.center=[],{idBuffer:e,orphanIds:i,floorIdBuffer:n,startIndex:h,endIndex:u,phaseBuffer:s,sublayerBuffer:o,styleIdBuffer:r,layerIdBuffer:a,instanceIdBuffer:l,objectClassBuffer:c,centerBuffer:d,strings:f}}}function FT(t){return t.type==="labelLine"||t.type==="point"||t.type==="oneWayLine"}function bf(t,e,i,n,s){const o=[];for(const r of t)for(const a of r.labels){const l=i.getStyle(a.styleId);if(!l){console.error(`Not found style ${a.styleId} in unpackPreLabelingResult`);continue}const c=l.layersById[a.layerId];if(!c||!FT(c)){console.error(`Not found layer: ${a.layerId} in style ${a.styleId} in unpackPreLabelingResult`);continue}const d=new DT(a,c,e,r.metatileHash);switch(a.type){case Ss.Point:d.setSpecificPointAttributes(a,n,s);break;case Ss.Line:d.setSpecificLineAttributes(a,n,s);break;case Ss.OneWayLine:d.setSpecificOneWayAttributes(a);break}o.push(d)}return o}let DT=class{constructor(e,i,n,s){this.rtlProcessed=!1,this.labelingElements=[],this.id="",this.floorId="",this.detailLevel=0,this.labelPriority=0,this.label="",this.ranges=[],this.pointType=Ki.Common,this.iconPriority=0,this.styleIconPriority=0,this.styleTextPriority=0,this.identifyIndex=Di,this.identifyPoiLabelIndex=Di,this.labelingTextureIndex=Di,this.spritePointTextureIndex=Di,this.hovered=0,this.label2Priority=0,this.mapPointVertices=[0,0,0],this.geoPoint=[NaN,NaN],this.demElevation=0,this.elevation=0,this.componentDistanceStartWorld=0,this.componentDistanceEnd=0,this.componentDistanceStart=0,this.objectLengthWorld=0,this.checkPointOffset=[0,0],this.layer=i,this.styleId=e.styleId,this.source=n,this.sourceId=e.sourceId,this.metatileHash=s,this.geometryType=e.type===Ss.Point?e.geometryType:_a.Line,this.tileData=e.tileData,this.labelPriority=e.labelPriority,this.detailLevel=e.tileCoords[2],this.styleIconPriority=e.styleIconPriority,this.styleTextPriority=e.styleTextPriority,this.id=e.id,this.floorId=e.floorId}setSpecificPointAttributes(e,i,n){if(this.layer.type!=="point")throw new Error("Label: layer type is not a point");const s=this.layer.style;this.pointType=e.pointType,this.label2Priority=e.label2Priority,this.iconPriority=e.iconPriority,this.identifyIndex=e.identifyIndex,this.identifyPoiLabelIndex=e.identifyPoiLabelIndex,this.labelingTextureIndex=e.labelingTextureIndex,this.spritePointTextureIndex=e.spritePointTextureIndex,this.hovered=e.hovered,this.demElevation=e.demElevation;const o=ys(n,i,!0,e.tileData);this.label=Yu(Xc(s.textField,o),s.textMaxLengthPerLine),s.textField2&&(this.label2=Yu(Xc(s.textField2,o),s.textMaxLengthPerLine)),this.layer.type==="point"&&s.iconTextField&&(this.iconLabel=Yu(Xc(s.iconTextField,o),s.textMaxLengthPerLine));const r=Ye(e.tileCoords);this.mapPointVertices=[];const a=[0,0,0],l=[0,0,0];if(e.geometryType===_a.Point)ku(this.mapPointVertices,e.vertices,0,r),this.geoPoint=Z.toGeo(this.mapPointVertices),this.layer.style.allowElevation||(this.mapPointVertices[2]=0);else{for(let c=0;c<e.vertices[0].length;c++)a[0]=e.vertices[0][c],a[1]=e.vertices[1][c],$n(l,a,r),this.mapPointVertices.push(l[0],l[1],l[2]);this.componentDistanceStart=e.componentDistanceStart,this.componentDistanceEnd=e.componentDistanceEnd,this.componentDistanceStartWorld=qr(this.componentDistanceStart,e.tileCoords[2]),this.objectLengthWorld=qr(e.objectLength,e.tileCoords[2])}}setSpecificLineAttributes(e,i,n){if(this.layer.type!=="labelLine")throw new Error("Label: layer type is not a labelLine");const s=ys(n,i,!0,e.tileData);this.label=Xc(this.layer.style.textField,s);const o=Ye(e.tileCoords);this.mapPointVertices=[];const r=[0,0,0],a=[0,0,0];for(let l=0;l<e.vertices[0].length;l++)r[0]=e.vertices[0][l],r[1]=e.vertices[1][l],$n(a,r,o),this.mapPointVertices.push(a[0],a[1],a[2]);this.componentDistanceStart=e.componentDistanceStart,this.componentDistanceEnd=e.componentDistanceEnd,this.componentDistanceStartWorld=qr(this.componentDistanceStart,e.tileCoords[2]),this.objectLengthWorld=qr(e.objectLength,e.tileCoords[2]),this.tiers=q(this.layer.ignoreTier,s)?void 0:e.tiers}setSpecificOneWayAttributes(e){const i=Ye(e.tileCoords);this.mapPointVertices=[];const n=[0,0,0],s=[0,0,0];for(let o=0;o<e.vertices[0].length;o++)n[0]=e.vertices[0][o],n[1]=e.vertices[1][o],$n(s,n,i),this.mapPointVertices.push(s[0],s[1],s[2]);this.componentDistanceStart=e.componentDistanceStart,this.componentDistanceEnd=e.componentDistanceEnd,this.componentDistanceStartWorld=qr(this.componentDistanceStart,e.tileCoords[2]),this.objectLengthWorld=qr(e.objectLength,e.tileCoords[2]),this.tiers=e.tiers}updateRanges(){this.ranges=mM([this.label,this.label2,this.iconLabel])}};function xf(t){return t.pointType===Ki.Commercial||t.pointType===Ki.CommercialCity||t.pointType===Ki.CommercialPremium}const Sf=new Map;class Mf{constructor(e,i,n,s,o,r,a){if(this.anchorWorld=[0,0,0,0],this.anchorGeo=[0,0],this.groupPriority=0,this.labelingGroup=To,this.marginTopBottom=0,this.marginLeftRight=0,this.elevation=0,this.type=i,this.label=e,this.layer=e.layer,this.elevation=e.elevation,this.id=e.id+"_"+i+"_"+Math.floor(n[0]/1e3)+"_"+Math.floor(n[1]/1e3)+this.getIconLabelPriorityToId(e),dc(this.anchorWorld,n),this.anchorGeo=e.geoPoint,s!==0&&(this.anchorWorld[2]*=s),a){const l=Yt.fromGeo(this.anchorGeo);this.anchorScreen=o.ecef.project(l,!1)}else this.anchorScreen=o.flat.project([this.anchorWorld[0],this.anchorWorld[1],this.anchorWorld[2]+this.elevation,0]);switch(this.anchorPosition=0,this.anchorSegmentIndex=0,this.halfLabelWidth=0,this.commPriorityRandomFactor=NaN,this.itemPriority=i===xs.Icon?e.iconPriority:e.labelPriority,this.layer.type){case"labelLine":this.labelingGroup=this.layer.style.labelingGroup,this.groupPriority=e.styleTextPriority;break;case"oneWayLine":this.labelingGroup=this.layer.style.labelingGroup,this.groupPriority=this.layer.style.priority;break;case"point":{if(xf(e))if(Sf.has(this.label.id))this.commPriorityRandomFactor=Sf.get(this.label.id);else{const l=LT();this.commPriorityRandomFactor=l,Sf.set(this.label.id,l)}i===xs.PoiText?(this.labelingGroup=this.layer.style.allowOverlap?ar:this.layer.style.textLabelingGroup,this.groupPriority=this.layer.style.iconImage?Math.min(e.styleTextPriority,e.styleIconPriority):e.styleTextPriority,this.marginTopBottom=this.layer.style.textLabelingMargin.topBottom,this.marginLeftRight=this.layer.style.textLabelingMargin.leftRight):i===xs.PoiText2?(this.labelingGroup=this.layer.style.allowOverlap?ar:this.layer.style.textLabelingGroup2,this.groupPriority=Math.min(e.styleTextPriority,e.styleIconPriority),this.marginTopBottom=this.layer.style.textLabelingMargin.topBottom,this.marginLeftRight=this.layer.style.textLabelingMargin.leftRight):(this.labelingGroup=this.layer.style.allowOverlap?ar:this.layer.style.iconLabelingGroup,this.groupPriority=e.styleIconPriority,this.marginTopBottom=this.layer.style.iconLabelingMargin.topBottom,this.marginLeftRight=this.layer.style.iconLabelingMargin.leftRight);break}}this.labelingGroupTable=r.labelingGroups.table,this.overflowStyleZoom=-1/0,this.boxes=[],this.placementIndex=0}getIconLabelPriorityToId(e){if(xf(e))return"";const{layer:i}=e;if(i.type==="point"){const n=e.styleIconPriority.toFixed(0),s=e.styleTextPriority.toFixed(0);return"_"+n+"_"+s}return""}}function Xv(t,e,i,n,s,o){if(!t||s&&!o)return[0,0];if(!o)return[t.w/e,t.h/e];const r=If(i,n,o),a=ai(i.style.iconTextPadding);return[a[3]+a[1]+r[0],a[0]+a[2]+r[1]]}function Yc(t,e,i){return Tf(W(t.style.textFontSize,e),t.style.textLineHeight,i)}function Yv(t,e,i){return Tf(W(t.style.textFontSize2,e),t.style.textLineHeight,i)}function If(t,e,i){return Tf(W(t.style.iconTextFontSize,e),t.style.iconTextLineHeight,i)}function Tf(t,e,i){const s=t/jt.baseSize*i.maxWidth,o=t*e*i.lines.length;return[s,o]}function qv(t,e,i){const n=i[0]??0,s=i[1]??0;return[(.5-t.anchorX)*e[0]+n,(.5-t.anchorY)*e[1]+s]}function OT(t,e,i){const n=e[0]??.5,s=e[1]??.5,o=i[0]??0,r=i[1]??0;return[(.5-n)*t[0]+o,(.5-s)*t[1]+r]}function Kv(t,e,i,n,s){const o=i[0]??.5,r=i[1]??.5,a=s[0]??0,l=s[1]??0;return[t[0]/2-o*e[0]-n[3]+a,t[1]/2-r*e[1]-n[0]+l]}function qc(t,e,i,n,s){const o=e[0],r=e[1],a=i[0],l=i[1];let c=0,d=0;const h=l/2+r/2,u=l/2-r/2,f=-h,m=-u,p=a/2+o/2,_=a/2-o/2,g=-p,y=-_;switch(t){case"bottomCenter":d=h+s;break;case"rightCenter":c=p+s;break;case"topCenter":d=f-s;break;case"leftCenter":c=g-s;break;case"bottomRight":c=_,d=h+s;break;case"topRight":c=_,d=f-s;break;case"bottomLeft":c=y,d=h+s;break;case"rightBottom":c=p+s,d=m;break;case"rightTop":c=p+s,d=u;break;case"topLeft":c=y,d=f-s;break;case"leftTop":c=g-s,d=u;break;case"leftBottom":c=g-s,d=m;break}return[c+n[0],d+n[1]]}var ur=(t=>(t[t.Static=0]="Static",t[t.Unique=1]="Unique",t[t.Loaded=2]="Loaded",t))(ur||{});let Jv=1e4+1;const BT={w:0,h:0,x:0,y:0,atlasIndex:0,isPacked:!1},Ef={};function kT(t,e,i,n,s,o){const r=Zu(t,s);if(!Ef[r]){const a=Jv++;Ef[r]={type:ur.Unique,isSvg:!1,index:a,key:r,name:"",fileName:"",id:t,regionId:i,url:o,rasters:e.map((l,c)=>({...BT,rasterSetIndex:a,rasterIndex:c,w:l,h:l,anchorX:n[0],anchorY:n[1]}))}}return Ef[r]}function NT(t){const e=Jv++;return{type:ur.Loaded,isSvg:!1,index:e,key:`loaded-${e}`,name:"",fileName:"",rasters:t.map((i,n)=>({...i,rasterIndex:n,rasterSetIndex:e}))}}function ma(t,e,i){let n,s=1/0;for(let o=0;o<t.length;o++){const r=t[o];if(i&&!r.isPacked)continue;const a=Math.abs(r.w-e);a<s&&(n=o,s=a)}return n}function Af(t){return!!t&&"stretchX"in t&&Array.isArray(t.stretchX)&&"stretchY"in t&&Array.isArray(t.stretchY)&&"width"in t&&typeof t.width=="number"&&"height"in t&&typeof t.height=="number"}function Pf(t,e){const i=e.precomputes;return t.map((n,s)=>{const o=i[s];return o&&o.usage===wi.Uniform?n:null})}var ts=(t=>(t[t.Icon=0]="Icon",t[t.First=1]="First",t[t.Second=2]="Second",t))(ts||{});const Lf=new PT,pa=[0,0,0];let pl=[0,0,0];const Ks={symbol:"point",sinks:{raster:{stride:40,binder:(t,e)=>{t.views.flatPosition=new Uint16Array(e),t.views.ecefPosition=new Int16Array(e,6),t.views.cornerOffset=new Int16Array(e,12),t.views.checkPointOffset=new Int16Array(e,16),t.views.texCoords=new Uint16Array(e,20),t.views.scales=new Int16Array(e,24),t.views.localID=new Uint32Array(e,28),t.views.labelingTextureID=new Uint32Array(e,32),t.views.spritePointTextureID=new Uint32Array(e,36)},packObjectAttributes:(t,e,i,n,s,o)=>nl([t.styleId,t.layer.innerId,e,i,n,s],o),unpackObjectAttributes:t=>({styleId:t[0],layerId:t[1],animDirection:t[2],atlasIndex:t[3],labelTest:t[4],floorId:t[5],tileData:t.slice(6)})},text:{stride:36,binder:(t,e)=>{t.views.flatPosition=new Uint16Array(e),t.views.ecefPosition=new Int16Array(e,6),t.views.cornerOffset=new Int16Array(e,12),t.views.checkPointOffset=new Int16Array(e,16),t.views.texCoords=new Uint16Array(e,20),t.views.localID=new Uint32Array(e,24),t.views.labelingTextureID=new Uint32Array(e,28),t.views.spritePointTextureID=new Uint32Array(e,32)},packObjectAttributes:(t,e,i,n,s,o,r,a)=>nl([t.styleId,t.layer.innerId,e,i,n[0],-n[1],s,o,r],a),unpackObjectAttributes:t=>({styleId:t[0],layerId:t[1],animDirection:t[2],range:t[3],offsetX:t[4],offsetY:t[5],labelIndex:t[6],fontIndex:t[7],floorId:t[8],tileData:t.slice(9)})},labelingTexture:{stride:16,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.cornerOffset=new Int16Array(e,8),t.views.labelingTextureID=new Uint32Array(e,12)},packObjectAttributes:(t,e=[0,0])=>nl([t.styleId,t.layer.innerId,e[0],-e[1],t.floorId],[]),unpackObjectAttributes:t=>({styleId:t[0],layerId:t[1],offsetX:t[2],offsetY:t[3],floorId:t[4],tileData:t.slice(5)})}},processElement(t,e,i,n,s,o,r){const{layer:a,label:l}=i;if(a.type!=="point")return;const c=ys(o.styleZoom,o.styleState,!0,l.tileData),d=ey(c,t,s,l),h=t.icons[Ri(a.style.iconImage,c)],u=Af(h),f=Xv(d,s,a,c,u,l.iconTextMetrics),m=ai(a.style.iconTextOffset),p=ai(a.style.iconTextPadding);let _,g=[0,0];if(d)if(l.iconTextMetrics){const v=ai(a.style.iconTextAnchor);_=If(a,c,l.iconTextMetrics),g=Kv(f,_,v,p,m)}else{const v=ai(a.style.iconOffset);g=qv(d,f,v)}Pt(pa,i.anchorWorld,r);const{globeInterStartZoom:y}=In;if(!(!(o.globeMode&&o.zoom<y)&&!Nu(pa)))switch(pl=Yt.fromGeo(i.anchorGeo),i.type){case xs.Icon:if(!d||u&&!l.iconTextMetrics)return;const v=u?h.stretchX:void 0,I=u?h.stretchY:void 0;if(Cf(e,l,pa,pl,n,d,f[0]*s,f[1]*s,g[0]*s,g[1]*s,s,v==null?void 0:v.map(([P,T])=>[P*s,T*s]),I==null?void 0:I.map(([P,T])=>[P*s,T*s])),!_)return;const S=ai(a.style.iconTextAnchor);UT(t,e,i.label,pa,pl,o,n,OT(_,S,m),a,s);return;case xs.PoiText:GT(t,e,i,pa,pl,f,o,n,g,a,s);return;case xs.PoiText2:jT(t,e,i,pa,pl,f,o,n,g,a,s);return}},getLabelingInfo(t,e,i,n,s,o){const{layer:r}=t;if(r.type!=="point")return;t.labelingElements.length=0;const a=ys(n.styleZoom,n.styleState,!0,t.tileData),l=ey(a,i,o,t),c=i.icons[Ri(r.style.iconImage,a)],d=Af(c),h=Xv(l,o,r,a,d,t.iconTextMetrics);let u,f=[0,0];if(l&&(!d||t.iconTextMetrics)){if(t.iconTextMetrics){const g=ai(r.style.iconTextAnchor),y=ai(r.style.iconTextOffset),b=ai(r.style.iconTextPadding);u=If(r,a,t.iconTextMetrics),f=Kv(h,u,g,b,y)}else{const g=ai(r.style.iconOffset);f=qv(l,h,g)}const _=new Mf(t,xs.Icon,e,n.buildingHeight,s,i,n.globeMode);_.boxes.push([-h[0]/2+f[0],-h[1]/2+f[1],h[0]/2+f[0],h[1]/2+f[1]]),t.labelingElements.push(_)}const m=Ri(r.style.textFont,a);t.label.length>0&&m.length&&(VT(t,e,i,h,n,s,f,r),t.label2&&HT(t,e,i,h,n,s,f,r))}};function UT(t,e,i,n,s,o,r,a,l,c){const{iconTextMetrics:d}=i;if(!d||!l.style.iconTextFont)return;const h=ys(o.styleZoom,o.styleState,!1,i.tileData),u=Ri(l.style.iconTextFont,h),f=t.fontNameToIndex[u]??t.fontNameToIndex[ho];Kc(e,i,0,d,n,s,r,a,l,f,c)}function GT(t,e,i,n,s,o,r,a,l,c,d){const{label:h}=i,{textMetrics:u}=h,f=ys(r.styleZoom,r.styleState,!1,h.tileData),m=Ri(c.style.textFont,f);if(!m.length)return;const p=Yc(c,f,u),_=t.fontNameToIndex[m]??t.fontNameToIndex[ho],g=i.parent?Cc(c.style.textPlacement,f):"centerCenter",y=W(c.style.textOffset,f),b=qc(g,o,p,l,y);Kc(e,h,1,h.textMetrics,n,s,a,b,c,_,d)}function jT(t,e,i,n,s,o,r,a,l,c,d){const{label:h}=i,{textMetrics:u,textMetrics2:f}=h;if(!f||!c.style.textFont2)return;const m=ys(r.styleZoom,r.styleState,!1,h.tileData),p=Yc(c,m,u),_=Yv(c,m,f),g=W(c.style.textOffset,m),y=W(c.style.textOffset2??0,m,0),b=Ri(c.style.textFont2,m),v=t.fontNameToIndex[b]??t.fontNameToIndex[ho],I=qc(Cc(c.style.textPlacement,m),o,[_[0],p[1]],l,g);I[1]+=(p[1]+_[1])/2+y,Kc(e,h,2,f,n,s,a,I,c,v,d)}function Kc(t,e,i,n,s,o,r,a,l,c,d){if(i===1&&e.labelingElements.length===1){const u=t.getBucket("point","labelingTexture",Ks.sinks.labelingTexture.packObjectAttributes(e),Ks.sinks.labelingTexture.binder);e.checkPointOffset=$T(u,s,n,l,d,e.labelingTextureIndex)}const h={};for(const u of e.ranges)h[u]=t.getBucket("point","text",Ks.sinks.text.packObjectAttributes(e,r,u,a,i,c,e.floorId,Pf(e.tileData,l)),Ks.sinks.text.binder);ZT(h,e,s,o,n,l,i,e.checkPointOffset)}function Qv(t,e,i,n,s,o,r){return Cf(t,e,i,n,s,o,o.w,o.h,o.w*(.5-o.anchorX),o.h*(.5-o.anchorY),r,void 0,void 0)}function Cf(t,e,i,n,s,o,r,a,l,c,d,h,u){if(r<=0||a<=0)return;const f=e.layer;if(f.type!=="point")return;TT(Lf,Gt,o,r,a,l,c,h,u),t.atlasPacker.addRastersToLoad(e.styleId,o);const m=t.getBucket("point","labelingTexture",Ks.sinks.labelingTexture.packObjectAttributes(e),Ks.sinks.labelingTexture.binder);e.checkPointOffset=AT(i[0],i[1],i[2],Lf,m,d,e.labelingTextureIndex);const p=t.getBucket("point","raster",Ks.sinks.raster.packObjectAttributes(e,s,o.atlasIndex,h!==void 0||u!==void 0,e.floorId,Pf(e.tileData,f)),Ks.sinks.raster.binder);ET(i[0],i[1],i[2],n,Lf,p,-1/0,1/0,e.identifyIndex,e.labelingTextureIndex,e.spritePointTextureIndex,e.checkPointOffset)}function VT(t,e,i,n,s,o,r,a){const{textMetrics:l}=t;if(!l)return;const c=ys(s.styleZoom,s.styleState,!1,t.tileData),d=W(a.style.textOffset,c),h=Yc(a,c,l),u=new Mf(t,xs.PoiText,e,s.buildingHeight,o,i,s.globeMode);t.labelingElements.length>0&&(u.parent=t.labelingElements[0]);const f=u.parent?Cc(a.style.textPlacement,c):"centerCenter",m=qc(f,n,h,r,d);u.boxes.push([m[0]-h[0]/2,m[1]-h[1]/2,m[0]+h[0]/2,m[1]+h[1]/2]),t.labelingElements.push(u)}function HT(t,e,i,n,s,o,r,a){const{textMetrics:l,textMetrics2:c}=t;if(!c)return;const d=ys(s.styleZoom,s.styleState,!1,t.tileData),h=Yc(a,d,l),u=Yv(a,d,c),f=W(a.style.textOffset,d),m=W(a.style.textOffset2??0,d,0),p=new Mf(t,xs.PoiText2,e,s.buildingHeight,o,i,s.globeMode);t.labelingElements.length>1?(p.parent=t.labelingElements[0],p.firstLabel=t.labelingElements[1]):t.labelingElements.length>0&&(p.parent=t.labelingElements[0],p.firstLabel=t.labelingElements[0]);const _=qc(Cc(a.style.textPlacement,d),n,[u[0],h[1]],r,f);_[1]+=(h[1]+u[1])/2+m,p.boxes.push([_[0]-u[0]/2,_[1]-u[1]/2,_[0]+u[0]/2,_[1]+u[1]/2]),t.labelingElements.push(p)}function ey(t,e,i,n){const{rasterSets:s}=e,{layer:o}=n;if(o.type!=="point")return;let r;const a=xf(n);if(a||n.pointType===Ki.Landmark)r=s.byKey[Zu(n.id,a?"commercial":"landmark")];else{const l=Ri(o.style.iconImage,t);if(l.length){const c=ai(o.style.iconAnchor);r=s.byKey[Vs(l,c[0],c[1])]}}if(r){const l=W(o.style.iconWidth,t),c=ma(r.rasters,l*i,!0);if(c!==void 0)return r.rasters[c]}}const Jc=[0,0];function ZT(t,e,i,n,s,o,r,a){let{textLineHeight:d,textLetterSpacing:h}=o.style;r===ts.Icon&&(d=o.style.iconTextLineHeight,h=o.style.iconTextLetterSpacing);const{identifyPoiLabelIndex:u,labelingTextureIndex:f,spritePointTextureIndex:m}=e,{lines:p,maxWidth:_}=s,g=d*jt.baseSize;let y=ty(1,g,p.length);for(let b=0;b<p.length;b++){const v=p[b].width;let I=0;I=-v/2,Jc[0]=I,Jc[1]=y;const S=p[b].glyphs;for(let P=0;P<S.length;P++){const T=S[P];T.bitmap!==void 0&&YT(t[T.range],i,n,Jc,T,u,f,m,a),Jc[0]+=T.advance+jt.baseSize*h}y-=g}}const Ms=[0,0];function $T(t,e,i,n,s,o){const{lines:r,maxWidth:a}=i;if(!r.length)return Ms[0]=0,Ms[1]=0,Ms;const{textLineHeight:l}=n.style,c=l*jt.baseSize,d=-a/2,h=ty(1,c,r.length),u=a/2,f=h-(r.length-1)*c;Ms[0]=s*(d+u)/2,Ms[1]=s*(h+f)/2;const m=s*Xh/2,p=Ms[0]-m,_=Ms[0]+m,g=Ms[1]+m,y=Ms[1]-m,b=t.elements.offset;return nd(t.indices,b,1,0,3,2,3,0),ed(t,e,p,g,o),ed(t,e,_,g,o),ed(t,e,p,y,o),ed(t,e,_,y,o),Ms}function WT(t,e,i,n,s,o,r){const a=i[1]+n.top,l=i[0]+n.left,c=a-n.height,d=l+n.width,h=Math.sin(s),u=Math.cos(s),f=l*u-a*h,m=l*h+a*u,p=d*u-a*h,_=d*h+a*u,g=l*u-c*h,y=l*h+c*u,b=d*u-c*h,v=d*h+c*u,I=t.elements.offset;td(t,e,f,m,n.texLeft,n.texTop,o,r),td(t,e,p,_,n.texRight,n.texTop,o,r),td(t,e,g,y,n.texLeft,n.texBottom,o,r),td(t,e,b,v,n.texRight,n.texBottom,o,r),nd(t.indices,I,1,0,3,2,3,0)}function XT(t,e,i){const n=t.elements.offset,s=qt(Math.cos(i)),o=qt(Math.sin(i));id(t,e,s,o,-1,-1),id(t,e,s,o,1,-1),id(t,e,s,o,1,1),id(t,e,s,o,-1,1),nd(t.indices,n,0,1,2,2,3,0)}function ty(t,e,i){let n;switch(t){case 0:n=e/2+e*(i-1);break;case 2:n=-e/2;break;default:n=i&1?e*(i>>1):e/2+e*(i-1>>1)}return n}function YT(t,e,i,n,s,o,r,a,l){const c=n[1]+s.top,d=n[0]+s.left,h=c-s.height,u=d+s.width,[f,m]=l,p=t.elements.offset;Qc(t,e,i,d,c,s.texLeft,s.texTop,f,m,o,r,a),Qc(t,e,i,u,c,s.texRight,s.texTop,f,m,o,r,a),Qc(t,e,i,d,h,s.texLeft,s.texBottom,f,m,o,r,a),Qc(t,e,i,u,h,s.texRight,s.texBottom,f,m,o,r,a),nd(t.indices,p,1,0,3,2,3,0)}function Qc(t,e,i,n,s,o,r,a,l,c,d,h){const u=t.elements,f=u.stride*u.offset>>1,m=f>>1;t.views.flatPosition[f]=$+e[0],t.views.flatPosition[f+1]=$+e[1],t.views.flatPosition[f+2]=Ci(e[2]),t.views.ecefPosition[f]=i[0]*Pi,t.views.ecefPosition[f+1]=i[1]*Pi,t.views.ecefPosition[f+2]=i[2]*Pi,t.views.cornerOffset[f]=n,t.views.cornerOffset[f+1]=s,t.views.checkPointOffset[f]=a,t.views.checkPointOffset[f+1]=l,t.views.texCoords[f]=o,t.views.texCoords[f+1]=r,t.views.localID[m]=c,t.views.labelingTextureID[m]=d,t.views.spritePointTextureID[m]=h,u.offset++}function ed(t,e,i,n,s){const o=t.elements,r=o.stride*o.offset>>1;t.views.position[r]=$+e[0],t.views.position[r+1]=$+e[1],t.views.position[r+2]=Ci(e[2]),t.views.cornerOffset[r]=i,t.views.cornerOffset[r+1]=n,t.views.labelingTextureID[r>>1]=s,o.offset++}function td(t,e,i,n,s,o,r,a){const l=t.elements;let c=l.stride*l.offset>>1;t.views.position[c]=$+e[0],t.views.position[c+1]=$+e[1],t.views.position[c+2]=Ci(e[2]),t.views.texCoords[c]=s,t.views.texCoords[c+1]=o,c=c>>1,t.views.cornerOffset[c]=i,t.views.cornerOffset[c+1]=n,t.views.styleZoomLimits[c]=r,t.views.styleZoomLimits[c+1]=a,l.offset++}function id(t,e,i,n,s,o){const r=t.elements.stride*t.elements.offset,a=r/t.views.position.BYTES_PER_ELEMENT,l=r/t.views.direction.BYTES_PER_ELEMENT;t.views.position[a]=$+e[0],t.views.position[a+1]=$+e[1],t.views.direction[l]=i,t.views.direction[l+1]=n,t.views.widenDirection[l]=s,t.views.widenDirection[l+1]=o,t.elements.offset++}function nd(t,e,i,n,s,o,r,a){const l=t.buffer,c=t.offset;l[c]=e+i,l[c+1]=e+n,l[c+2]=e+s,l[c+3]=e+o,l[c+4]=e+r,l[c+5]=e+a,t.offset=c+6}const Rf=[0,0,0],gl=[0,0],zf={symbol:"labelLine",sinks:{raster:{stride:28,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.texCoords=new Uint16Array(e,8),t.views.cornerOffset=new Float32Array(e,12),t.views.styleZoomLimits=new Float32Array(e,20)},packObjectAttributes:(t,e,i,n,s,o)=>nl([t.styleId,t.layer.innerId,e,i,n,s],o),unpackObjectAttributes(t){return{styleId:t[0],layerId:t[1],animDirection:t[2],range:t[3],fontIndex:t[4],tiers:t[5],tileData:t.slice(6)}}}},processElement(t,e,i,n,s,o,r){const{label:a,anchorPosition:l,anchorSegmentIndex:c,halfLabelWidth:d,layer:h}=i;if(h.type!=="labelLine")return;const{axis:u}=a,{center:f,styleZoom:m}=o,p=ys(m,o.styleState,!1,a.tileData),_=Ri(h.style.textFont,p),g=t.fontNameToIndex[_]??t.fontNameToIndex[ho],y={},b=q(h.ignoreTier,p)?null:a.tiers;for(const T of a.ranges)y[T]=e.getBucket("labelLine","raster",zf.sinks.raster.packObjectAttributes(a,n,T,g,b??null,Pf(a.tileData,h)),zf.sinks.raster.binder);const v=a.textMetrics.lines[0],I=W(h.style.textFontSize,p)/jt.baseSize,S=v.glyphs,P=qT(u,l,d,o.rotation);gl[0]=-v.width/2,gl[1]=0;for(let T=0;T<S.length;T++){const L=S[T],B=(gl[0]+L.left+L.width/2)*I*(P?-1:1),O=gc(B)||1;let w=-1/0,x=1/0;for(let C=c;C>=1&&C<u.vertexCount&&!(x<i.overflowStyleZoom);C+=O,x=w){const V=O===1?C:C-1;w=Xo(pu(B,u.lengths[V]-l),f);const M=u.interpolate(l,C);Pt(Rf,M,r),Nu(Rf)&&L.bitmap!==void 0&&WT(y[L.range],Rf,gl,L,M[3]+(P?Math.PI:0),Math.max(w,i.overflowStyleZoom),x)}gl[0]+=L.advance+jt.baseSize*h.style.textLetterSpacing}},getLabelingInfo(){}};function qT(t,e,i,n){const s=t.interpolate(e-i,t.getSegmentIndex(e-i)),o=t.interpolate(e+i,t.getSegmentIndex(e+i)),r=Math.atan2(o[1]-s[1],o[0]-s[0])-n;return Math.cos(r)<0}const Ff=[0,0,0],Df={symbol:"oneWayLine",sinks:{raster:{stride:12,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.direction=new Int8Array(e,8),t.views.widenDirection=new Int8Array(e,10)},packObjectAttributes:(t,e,i)=>nl([t.styleId,t.layer.innerId,e,i],t.tileData),unpackObjectAttributes:t=>({styleId:t[0],layerId:t[1],animDirection:t[2],tiers:t[3],tileData:t.slice(4)})}},processElement(t,e,i,n,s,o,r){const{label:a,anchorWorld:l}=i;if(Pt(Ff,l,r),!Nu(Ff))return;const c=e.getBucket("oneWayLine","raster",Df.sinks.raster.packObjectAttributes(a,n,a.tiers??null),Df.sinks.raster.binder);XT(c,Ff,l[3])},getLabelingInfo(){}},Js={symbol:"heatmap",sinks:{fill:{stride:8,binder:(t,e)=>{t.views.position=new Float32Array(e)},packObjectAttributes:(t,e,i,n)=>[t,e.innerId,i,n],unpackObjectAttributes:t=>({styleId:t[0],layerId:t[1],textureIndex:t[2],rampTextureIndex:t[3],tileData:t.slice(4)})},framebuffer:{stride:12,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.weight=new Float32Array(e,4),t.views.widen=new Int8Array(e,8)},packObjectAttributes:(t,e)=>[t,e],unpackObjectAttributes:t=>({styleId:t[0],layerId:t[1],tileData:t.slice(2)})}},generate(t,e,i,n,s){const o=n.x,r=n.y,a=Number(q(i.style.weight,s));if(Number.isNaN(a)){console.error("Can't resolve style.weight to number");return}const l=t.getBucket(i.type,"framebuffer",Js.sinks.framebuffer.packObjectAttributes(e,i.innerId),Js.sinks.framebuffer.binder);for(let c=0;c<o.length;c++)JT(l,0,1,2,2,1,3),od(l,o[c],r[c],-1,-1,a),od(l,o[c],r[c],1,-1,a),od(l,o[c],r[c],-1,1,a),od(l,o[c],r[c],1,1,a)},generateTexture(t,e,i,n,s){const o=[-1,1,1,-1],r=[-1,-1,1,1],a=t.getBucket(i.type,"fill",Js.sinks.fill.packObjectAttributes(e,i,n,s),Js.sinks.fill.binder);let l=a.elements.offset;KT(a.indices,l,0,1,2,0,2,3),sd(a,l++,o[0],r[0]),sd(a,l++,o[1],r[1]),sd(a,l++,o[2],r[2]),sd(a,l++,o[3],r[3]),a.elements.offset=l}};function sd(t,e,i,n){const s=e*2;t.views.position[s]=i,t.views.position[s+1]=n}function KT(t,e,i,n,s,o,r,a){const l=t.buffer,c=t.offset;l[c]=e+i,l[c+1]=e+n,l[c+2]=e+s,l[c+3]=e+o,l[c+4]=e+r,l[c+5]=e+a,t.offset=c+6}function od(t,e,i,n,s,o){const r=t.elements.offset*t.elements.stride,a=r>>1,l=a>>1;t.views.position[a]=$+e,t.views.position[a+1]=$+i,t.views.weight[l]=o,t.views.widen[r]=n,t.views.widen[r+1]=s,t.elements.offset++}function JT(t,e,i,n,s,o,r){const{elements:a,indices:l}=t,{buffer:c,offset:d}=l,h=a.offset;c[d]=h+e,c[d+1]=h+i,c[d+2]=h+n,c[d+3]=h+s,c[d+4]=h+o,c[d+5]=h+r,l.offset=d+6}let QT=0;function vl(){return QT++}const is=vl(),ga=vl(),iy={stride:4,binder:(t,e)=>{},packObjectAttributes(t,e){return[t,e]},unpackObjectAttributes(t){return{styleId:t[0],layerId:t[1],tileData:t.slice(3)}}},Of={stride:20,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.normal=new Float32Array(e,4),t.views.height=new Float32Array(e,16)},packObjectAttributes(t,e){return[t,e]},unpackObjectAttributes(t){return{styleId:t[0],layerId:t[1],tileData:t.slice(2)}}},hi={symbol:"dem",sinks:{mesh:iy,ground:iy,mesh2:Of,ground2:Of,elevation:Of,hillshade:{stride:8,binder:(t,e)=>{},packObjectAttributes(t,e){return[t,e]},unpackObjectAttributes(t){return{styleId:t[0],layerId:t[1],tileData:t.slice(2)}}},flatBottom:{stride:12,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.demPosition=new Int16Array(e,4),t.views.extender=new Int8Array(e,8)},packObjectAttributes(t,e,i){return i?[t,e,i]:[t,e]},unpackObjectAttributes(t){return{styleId:t[0],layerId:t[1],matrix:t[2]?t[2]:void 0,tileData:t.slice(3)}}}},generateMeshElevation(t,e,i,n){const s=t.getBucket("dem","elevation",hi.sinks.elevation.packObjectAttributes(i,n),hi.sinks.elevation.binder),o=t.getBucket("dem","mesh2",hi.sinks.mesh2.packObjectAttributes(i,n),hi.sinks.mesh2.binder),r=t.getBucket("dem","ground2",hi.sinks.ground2.packObjectAttributes(i,n),hi.sinks.ground2.binder);kf(s,e),kf(o,e),kf(r,e)},generateHillshade(t,e,i,n){const s=new Uint16Array(e.reduce((r,a)=>{const[l,c,d,h]=a;return r.push(l*xe,c*xe,Yi(d),Yi(h)),r},[]));return{symbol:hi.symbol,sink:"hillshade",buffer:s.buffer,generatedObjects:[{drawMode:Ua,attributes:hi.sinks.hillshade.packObjectAttributes(i,n),rangeStart:0,rangeEnd:s.buffer.byteLength,extents:new Uint16Array(6)}]}},generateFloorsBottomFill(t,e,i,n,s,o){const r=i[0],a=i[1],l=i[0].length,c=hi.sinks.flatBottom.packObjectAttributes(e,is,o),d=t.getBucket("dem","flatBottom",c,hi.sinks.flatBottom.binder);eE(d,l,r,a,n,s,!!o)}};function eE(t,e,i,n,s,o,r){let a=t.elements.offset;const l=a;if(!(e<3)){Bf(t,a++,i[0],n[0],o,s[0],r),Bf(t,a++,i[1],n[1],o,s[1],r);for(let c=2;c<e;c++)tE(t,l,c),Bf(t,a++,i[c],n[c],o,s[c],r);t.elements.offset=a}}function Bf(t,e,i,n,s,o,r){const a=e*(t.elements.stride/t.views.position.BYTES_PER_ELEMENT),l=e*(t.elements.stride/t.views.extender.BYTES_PER_ELEMENT);t.views.position[a]=r?i:$+i,t.views.position[a+1]=r?n:$+n,t.views.demPosition[a]=(r?s[0]:$+s[0])/8,t.views.demPosition[a+1]=(r?s[1]:$+s[1])/8,t.views.extender[l]=o[0]*127,t.views.extender[l+1]=o[1]*127}function tE(t,e,i){const n=t.indices.buffer;let s=t.indices.offset;i%2===0?(n[s++]=e+i-2,n[s++]=e+i-1,n[s++]=e+i):(n[s++]=e+i-1,n[s++]=e+i-2,n[s++]=e+i),t.indices.offset=s}function kf(t,e){for(let i=0;i<e.indices.length;i++){const n=e.indices[i],s=t.elements.offset*(t.elements.stride/t.views.position.BYTES_PER_ELEMENT);t.views.position[s]=$+e.vertices[n*3],t.views.position[s+1]=$+e.vertices[n*3+1];const o=t.elements.offset*(t.elements.stride/t.views.normal.BYTES_PER_ELEMENT);t.views.normal[o]=e.normals[n*3],t.views.normal[o+1]=e.normals[n*3+1],t.views.normal[o+2]=e.normals[n*3+2];const r=t.elements.offset*(t.elements.stride/t.views.height.BYTES_PER_ELEMENT);t.views.height[r]=e.vertices[n*3+2],t.elements.offset++,t.indices.buffer[t.indices.offset]=i,t.indices.offset++}}const iE=new Set(Dp),nE=new Set(tu),sE=new Set(iu),oE=new Set(Bp),rE=new Set(kp),aE=new Set(Op);function rd(t){return iE.has(t)}function ny(t){return nE.has(t)}function sy(t){return sE.has(t)}function lE(t){return oE.has(t)}function oy(t){return rE.has(t)}function ry(t){return aE.has(t)}const ad=(t,e,i,n,s,o,r,a,l,c,d)=>{const{tileProps:h,tileAttrs:u}=n;if(cE(t,e,i,n,c,d),d)return;let f=Ki.Common;const m=u[h.db_sublayer];ny(m)?f=Ki.CommercialCity:sy(m)?f=Ki.CommercialPremium:rd(m)?f=Ki.Commercial:oy(m)&&(f=Ki.Landmark);const p=l.x.length===1?_a.Point:_a.Line;let _=[],g;if(p===_a.Point){if(n&&i.style.allowElevation){const O=W(i.style.elevation,n);if(Number.isNaN(O))typeof l.z<"u"&&(l.z=[o<4?Gg(l.z[0]):l.z[0]]);else{const w=O*Ge*Xn(Ye(r),[l.x[0],l.y[0]]);l.z=[w]}}_=[[l.x[0]],[l.y[0]],typeof l.z<"u"?[l.z[0]]:[0]],g=[0,0,0],$n(g,[_[0][0],_[1][0],_[2][0]],Ye(r))}else _=[l.x,l.y];const y=n.id??"",b=f===Ki.Commercial||f===Ki.CommercialCity||f===Ki.CommercialPremium,v=h.db_plan_id&&!b?u[h.db_plan_id]:"";let I=Di,S=Di;Number.isNaN(y)||(I=t.idIndexer.getIndex(n,e.id,i,{objectClass:u[h.db_object_class],instanceId:0,metatile:s,center:g,floorId:v,ignoreHover:!0}),S=t.idIndexer.getIndex(n,e.id,i,{objectClass:u[h.db_object_class],instanceId:1,metatile:s,center:g,floorId:v,ignoreHover:!0}));const P=u[h.db_point_building_id],T=t.pointIndexer.getIndex(P),L=t.pointIndexer.getIndex(y),B={type:Ss.Point,pointType:f,geometryType:p,styleId:e.id,layerId:i.innerId,sourceId:a,tileCoords:r,id:n.id??"",floorId:v,identifyIndex:I,identifyPoiLabelIndex:S,labelingTextureIndex:T,spritePointTextureIndex:L,labelPriority:Fi(u[h.db_label_priority],0),label2Priority:Fi(u[h.db_label2_priority],0),styleIconPriority:W(i.style.iconPriority,n),styleTextPriority:W(i.style.textPriority,n),iconPriority:Fi(u[h.db_icon_priority],0),hovered:Fi(u[h.hovered],0),componentDistanceStart:Fi(u[h.componentDistanceStart],0),componentDistanceEnd:Fi(u[h.componentDistanceEnd],0),objectLength:Fi(u[h.objectLength],0),vertices:_,demElevation:NaN,tileData:[...n.tileData]};t.addLabel(B)};function cE(t,e,i,n,s,o){const{tileProps:r,tileAttrs:a}=n,{rasterSets:l,icons:c}=e,d=af(s),h=Zs(i.style.iconWidth),u=rd(a[r.db_sublayer]),f=oy(a[r.db_sublayer]),m=ai(i.style.iconAnchor);if(u||f){if(o)return;const p=u?Fr.rasterSizes:Np,_=kT(n.id??"",p,a[r.db_region],m,u?"commercial":"landmark",r.url_src?a[r.url_src]:void 0);t.atlasPacker.addNewRasterSet(e.id,_),t.atlasPacker.pack(_,h,d)}else Zs(i.style.iconImage).forEach(p=>{if(!p.length)return;const _=l.byKey[Vs(p,m[0],m[1])];if(!_){console.error(`Not found raster set with image ${p}, anchorX: ${m[0]}, anchorY: ${m[1]}`);return}if(!_.isSvg)return;const g=c[p],y=g&&Af(g)?[{w:g.width,h:g.height}]:h.map(b=>({w:b,h:b}));t.atlasPacker.packSvg(_,y,d),o&&_.rasters.forEach(b=>t.atlasPacker.addRastersToLoad(e.id,b))})}const dE=(t,e,i,n,s,o,r)=>{const a={type:Ss.Line,styleId:e,layerId:i.innerId,sourceId:s,tileCoords:n,id:o.id??"",floorId:o.tileAttrs[o.tileProps.db_plan_id]??"",componentDistanceStart:Fi(o.tileAttrs[o.tileProps.componentDistanceStart],0),componentDistanceEnd:Fi(o.tileAttrs[o.tileProps.componentDistanceEnd],0),objectLength:Fi(o.tileAttrs[o.tileProps.objectLength],0),labelPriority:Fi(o.tileAttrs[o.tileProps.db_label_priority],0),styleIconPriority:W(i.style.textPriority,o),styleTextPriority:W(i.style.textPriority,o),vertices:[r.x,r.y],tileData:[...o.tileData],tiers:q(i.ignoreTier,o)?void 0:o.tileAttrs[o.tileProps.db_tiers]};t.addLabel(a)},hE=(t,e,i,n,s,o,r)=>{const{tileProps:a,tileAttrs:l}=o,c=q(i.ignoreTier,o)?null:l[a.db_tiers],d={type:Ss.OneWayLine,styleId:e,layerId:i.innerId,sourceId:s,tileCoords:n,id:o.id??"",floorId:o.tileAttrs[o.tileProps.db_plan_id]??"",componentDistanceStart:Fi(o.tileAttrs[o.tileProps.componentDistanceStart],0),componentDistanceEnd:Fi(o.tileAttrs[o.tileProps.componentDistanceEnd],0),objectLength:Fi(o.tileAttrs[o.tileProps.objectLength],0),labelPriority:Fi(o.tileAttrs[o.tileProps.db_label_priority],0),styleIconPriority:W(i.style.priority,o),styleTextPriority:0,vertices:[r.x,r.y],tileData:[...o.tileData],tiers:c};t.addLabel(d)};function ay(t,e,i){return Ka(i.fontUrlTemplate,{name:t,range:String(e)})}function ld(t,e,i){const n=Qs(t)?t:Ao(e.iconBaseUrl,t);return Ka(n,{subdomain:i,appHost:window.location.host})}function uE(t,e){return Qs(t)?t:Ao(e.modelsBaseUrl,t)}function fE(t,e,i){return Qs(t)||!e?t:vE(e)?Jo(e,{modelSrc:t,subdomain:Dg(i)}):Ao(e,t)}function ly(t,e,i){return t.replace("image",`image_${e}x${i}`)}const cy=/_i$/;function _E(t){return cy.test(t)}function mE(t){return t.replace(cy,"")}function pE(t,e){const i=Qs(e.fontsPath)?e.fontsPath:Ao(e.rootUrl,e.fontsPath),n="{name}_{range}.pbf";t.fontUrlTemplate=Ao(i,n),t.iconBaseUrl=Qs(e.iconsPath)?e.iconsPath:Ao(e.rootUrl,e.iconsPath),t.modelsBaseUrl=Qs(e.modelsPath)?e.modelsPath:Ao(e.rootUrl,e.modelsPath)}function Nf(t){return Qs(t.stylePath)?t.stylePath:Ao(t.rootUrl,t.stylePath)}const gE=new RegExp("^(?:(?:[a-z]+:)?(?:[a-z]+:)?//|data:)","i");function Qs(t){return gE.test(t)}function vE(t){return/{\w+}/g.test(t)}function Ao(...t){const e=t.filter(n=>n.length>0);let i=e[0];for(let n=1;n<e.length;n++){i[i.length-1]!=="/"&&(i+="/");const s=e[n];s[0]==="/"?i+=s.slice(1):i+=s}return i}function dy(t,e,i){const n=ai(i.style.iconAnchor),s=Vs(t,n[0],n[1]);return e.rasterSets.byKey[s]}function yE(t,e,i,n){const s=e.icons[i.name];if(!s)return;const o=ma(i.rasters,n*window.devicePixelRatio,!0);if(o===void 0)return;const r=ld(s.url,e,Wr(t.map.state.subdomains,i.name)),{w:a,h:l}=i.rasters[o];return{fullUrl:r,width:a,height:l}}function wE(t,e,i,n){const s=mE(n),o=dy(s,e,i);if(!o)return;const r=e.icons[o.name];if(r)return ld(r.url,e,Wr(t.map.state.subdomains,o.name))}function bE(t,e,i){const n=t.styleManager.getStyle(t.map.state.handyStyleId);if(!n)return;const s=n.layersById[e.layerId];if(!s)return;const o=ut(t.map.state.styleZoom,t.map.state.styleState,[]);let r;const a=s.style.iconWidth,l=W(a,o);if(i.isCommercial){r=n.rasterSets.byKey[Zu(e.id,"commercial")];const u=r.url;if(!u)return;const f=ma(r.rasters,l*window.devicePixelRatio,!0);if(f===void 0)return;const{w:m,h:p}=r.rasters[f],_=ly(u,m,p);return{baseUrl:u,fullUrl:_,width:m,height:p}}const c=s.style.iconImage;if(!c)return;const d=Ri(c,o);if(r=dy(d,n,s),!r)return;const h=yE(t,n,r,l);if(h){if(_E(d)){const u=wE(t,n,s,d);u!==void 0&&(h.fullUrlUnhovered=u)}return h}}function xE(t){return Array.isArray(t)?t:[t]}function hy(t){return t&&t.buffer instanceof ArrayBuffer}var ns=(t=>(t[t.None=0]="None",t[t.Zoom=1]="Zoom",t[t.Distance=2]="Distance",t))(ns||{}),yl=(t=>(t[t.default=0]="default",t[t.flat=1]="flat",t[t.axis=2]="axis",t[t.centroid=3]="centroid",t))(yl||{});const Is=[0,0,0],wl=new Int16Array([0,0,0]),Oi=new Array(16),Uf=new Float32Array(9),fr=[0,0,0],Gf=[0,0,0],jf=[0,0,0],cd=[0,0,0],SE=Oe(),ME=_o([1,1,1]),ss={symbol:"gltfModel",sinks:{instances:{stride:64,binder:(t,e)=>{t.views.flatPosition=new Uint16Array(e),t.views.ecefPosition=new Int16Array(e,8),t.views.matrix=new Float32Array(e,16),t.views.localID=new Uint32Array(e,52),t.views.labelingTextureID=new Uint32Array(e,56),t.views.absZ=new Float32Array(e,60)},packObjectAttributes(t,e,i,n,s,o,r,a,l=[],c,d,h,u){return It([t,e.innerId,i,l,a,o,n,s,c,d,h,u],e,r)},unpackObjectAttributes(t){return{styleId:t[0],layerId:t[1],modelIndices:t[2],lngLat:t[3],emitShowHideEvents:t[4],sourceId:t[5],modelStepValues:t[6],modelStepSource:t[7],parentId:t[8],absZ:t[9],floorId:t[10],subkey:t[11],tileData:t.slice(12)}}}},generateInstances(t,e,i,n,s,o,r,a,l,c,d=0){const h=q(i.style.linkedIds,n),u=h===""?[]:xE(h),f=i.style.modelSrc,m=[];let p=ns.None;const _=Zs(f,n,i,!0);if(_.length===1)m.push(0);else if(_.length>1){if(!or(f)||f.type!=="step"||!or(f.value)){console.error(`Only step-expression is allowed as 'modelSrc' style property. Models won't be displayed for layer ${i.id}`);return}switch(f.value.type){case"zoom":p=ns.Zoom;break;case"distance":p=ns.Distance;break;default:console.error(`'${f.value.type}' type in 'modelSrc' step expression is not supported. Only 'zoom' and 'distance' are supported. Models won't be displayed for layer ${i.id}`);return}f.steps.forEach(({key:x})=>{m.push(x)})}p===ns.Distance&&_.reverse(),_.forEach((x,C)=>{x===null&&C!==0&&(_[C]=_[C-1])}),p===ns.Distance&&_.reverse();const g=_.map(x=>x===null?"":x).map(x=>{let C=e.modelIndex[x];return C===void 0&&(x=fE(x,a??"",o.coords),C=t.addUsedModelByUrl(x)),t.addUsedModel(C),C}),{tileProps:y,tileAttrs:b}=n;let v=qs;i.interactive?n.id&&(v=b[y.hovered]?Di:t.idIndexer.getIndex(n,e.id,i,{metatile:c,objectClass:b[y.db_object_class]})):v=i.interactiveOcclusion?qs:Di;const I=n.id??"-1",S=b[y.db_point_building_id];let P=qs;n.id&&(P=t.pointIndexer.getIndex(S??n.id));const T=l!=null&&l.has(b[y.db_sublayer])&&I!=="-1"?1:0,L=t.getBucket("gltfModel","instances",ss.sinks.instances.packObjectAttributes(e.id,i,g,m,p,r,n,T,T?el(s.x[0],s.y[0],o):void 0,S,!!s.abs_z,y.db_plan_id?b[y.db_plan_id]:"",XS(o,s.x[0],s.y[0],d)),ss.sinks.instances.binder);let B=L.meta;if(B)B.linkedIds.push(...u);else{const x=y.db_plan_id?b[y.db_plan_id]:void 0;B=L.meta={linkedIds:u.slice(),modelsPath:a??"",buildingId:I,planId:x}}T&&(B.sublayer=b[y.db_sublayer]),S&&(B.childrenIds||(B.childrenIds=[]),B.childrenIds.push(I));let O;const w=EE(b,n);if(w){const x=s.x[0],C=s.y[0],V=[0,0,0];$n(V,[x,C],o),O=[V,Z.fromGeo(w)]}for(let x=0;x<s.x.length;x++){const C=s.abs_z&&s.abs_z[x];gt(Gf,0,0,0),Gn(q(i.style.rotation,n),Gf),gt(fr,1,1,1),Gn(q(i.style.scale,n),fr),gt(jf,0,0,0),Gn(q(i.style.offset,n),jf),uy(s.x[x],s.y[x],0,jf,fr,Gf,O,o,i.minzoom<In.globeMaxZoom),AE(L,Is,wl,Uf,v,P,C)}},patchBuffer(t,e,i,n,s,o,r,a,l){const c=ss.sinks.instances.stride*i;uy(s[0],s[1],s[2],o,r,a,void 0,n,l),Is[0]+=$,Is[1]+=$,Is[2]=Ci(Is[2]),e.subData(t,c+0,new Uint16Array(Is)),l&&e.subData(t,c+8,wl),e.subData(t,c+16,Uf)}};function IE(t,e,i,n){const s=i*xe/Mt(n.coords[2]);Ei(e,e,s),e[2]*=i,Ot(t,t,e)}function uy(t,e,i,n,s,o,r,a,l){gt(Is,t,e,i);const c=Xn(a,Is)*Ge;if(ou(Oi),Wp(Oi,Oi,ve(o[2])),$p(Oi,Oi,ve(o[1])),ru(Oi,Oi,ve(o[0])),Ha(Oi,Oi,s),r?TE(Oi,r[0],r[1]):(gt(fr,c,c,c),Ha(Oi,Oi,fr)),ru(Oi,Oi,Math.PI/2),$2(Uf,Oi),IE(Is,n,c,a),l){const d=Uu(a,Is);wl[0]=d[0]*Pi,wl[1]=d[1]*Pi,wl[2]=d[2]*Pi}}function TE(t,e,i){Ai(cd,i,e),Wp(t,t,Math.atan2(cd[1],cd[0]));const n=lu(cd);gt(fr,n,n,n),Ha(t,t,fr)}function EE(t,e){const i=t[e.tileProps.direction];return i===void 0?null:Array.isArray(i)?i:i.type==="Point"?i.coordinates:null}function AE(t,e,i,n,s,o,r){const a=t.elements.offset*ss.sinks.instances.stride,l=t.views,c=a/l.flatPosition.BYTES_PER_ELEMENT,d=$+e[0],h=$+e[1],u=Ci(e[2]);if(l.flatPosition[c]=d,l.flatPosition[c+1]=h,l.flatPosition[c+2]=u,l.ecefPosition[c]=i[0],l.ecefPosition[c+1]=i[1],l.ecefPosition[c+2]=i[2],t.elements.offset>t.elements.maximum-1)return;l.matrix.set(n,a/l.matrix.BYTES_PER_ELEMENT),l.localID[a/l.localID.BYTES_PER_ELEMENT]=s,l.labelingTextureID[a/l.labelingTextureID.BYTES_PER_ELEMENT]=o,r!==void 0&&(l.absZ[a/l.absZ.BYTES_PER_ELEMENT]=r),PE(t,d,h,u,n);const f=t.indices;f.buffer[f.offset]=t.elements.offset,f.offset++,t.elements.offset++}function PE(t,e,i,n,s){const o=t.extents;e<o[0]&&(o[0]=e),i<o[1]&&(o[1]=i),n<o[2]&&(o[2]=n),e>o[3]&&(o[3]=e),i>o[4]&&(o[4]=i),n>o[5]&&(o[5]=n);const r=SE;eS(s,r);const a=_o(r)/ME;a>t.maxDiag&&(t.maxDiag=a)}var ne=(t=>(t[t.side=0]="side",t[t.top=1]="top",t[t.bottom=2]="bottom",t))(ne||{});const bl=[0,0,0],xl=[0,0,0],Sl=[0,0,0],dd=[0,0,0],fy=(t,e,i,n,s)=>It([t,e.innerId,i,n],e,s),_y=(t,e,i,n)=>It([t,e.innerId,i],e,n),my=t=>({styleId:t[0],layerId:t[1],side:t[2],absZ:t[3],tileData:t.slice(4)}),py=t=>({styleId:t[0],layerId:t[1],absZ:t[2],tileData:t.slice(3)}),ee={symbol:"mesh",sinks:{fill:{stride:28,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.z=new Float32Array(e,4),t.views.normal=new Int8Array(e,8),t.views.gradient=new Int8Array(e,11),t.views.localID=new Uint32Array(e,12),t.views.demPosition=new Int16Array(e,16),t.views.absZ=new Float32Array(e,16),t.views.isPivot=new Uint8Array(e,20),t.views.labelingTextureID=new Uint32Array(e,24)},packObjectAttributes:fy,unpackObjectAttributes:my},inverse:{stride:16,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.z=new Float32Array(e,4),t.views.demPosition=new Int16Array(e,8),t.views.absZ=new Float32Array(e,8),t.views.isPivot=new Uint8Array(e,12)},packObjectAttributes:_y,unpackObjectAttributes:py},depthClear:{stride:16,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.z=new Float32Array(e,4),t.views.demPosition=new Int16Array(e,8),t.views.absZ=new Float32Array(e,8),t.views.isPivot=new Uint8Array(e,12)},packObjectAttributes:_y,unpackObjectAttributes:py},stroke:{stride:20,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.z=new Float32Array(e,4),t.views.directionDistance=new Int8Array(e,8),t.views.demPosition=new Int16Array(e,12),t.views.absZ=new Float32Array(e,12),t.views.isPivot=new Uint8Array(e,16)},packObjectAttributes:fy,unpackObjectAttributes:my}},generate(t,e,i,n,s,o,r,a,l,c,d="fill",h=!1){const u=o.x,f=o.y,m=o.signed_z;let p=0;if(i.type==="polygon3d"||i.type==="embankment"){const L=q(i.style.elevation,s),B=s.tileInfo?Xn(s.tileInfo,[0,0]):1;p=L*Ge*B}const _=o.gradient,g=o.abs_z,y=o.is_pivot,b=u.length,v=s.tileAttrs[s.tileProps.hovered],I=s.id??"",S=t.pointIndexer.getIndex(I);let P=qs;switch(i.type){case"polygon3d":{i.interactive?(P=v?Di:t.idIndexer.getIndex(s,e,i),!v&&P===Di&&(P=qs)):P=i.interactiveOcclusion?qs:Di;break}case"overpass":case"tunnel":{P=t.idIndexer.getIndex(s,e,i),P===Di&&(P=qs);break}case"embankment":{P=qs;break}default:{const{type:L}=i}}(i.type==="embankment"||i.type==="polygon3d")&&l&&Av(t,e,l,i.style,a);let T;if(d==="inverse")T=t.getBucket("mesh","inverse",ee.sinks.inverse.packObjectAttributes(e,i,!!g,s),ee.sinks.inverse.binder);else if(d==="fill")T=t.getBucket("mesh","fill",ee.sinks.fill.packObjectAttributes(e,i,n,!!g,s),ee.sinks.fill.binder);else if(d==="depthClear")T=t.getBucket("mesh","depthClear",ee.sinks.depthClear.packObjectAttributes(e,i,!!g,s),ee.sinks.depthClear.binder);else return;for(let L=0;L<b-2;L++){const B=!(L%2);LE(T);const O=h?2:1,w=h?1:2,x=B?L+O:L+w,C=B?L+w:L+O,V=xe/r.size;gt(bl,u[L],f[L],((m==null?void 0:m[L])??0)*V),gt(xl,u[x],f[x],((m==null?void 0:m[x])??0)*V),gt(Sl,u[C],f[C],((m==null?void 0:m[C])??0)*V),pg(dd,bl,xl,Sl),bl[2]/=V,xl[2]/=V,Sl[2]/=V,bl[2]+=p,xl[2]+=p,Sl[2]+=p;const M=T.elements.offset;Vf(T,bl,dd,_==null?void 0:_[L],P,S,c,g==null?void 0:g[L],y==null?void 0:y[L]),Vf(T,xl,dd,_==null?void 0:_[x],P,S,c,g==null?void 0:g[x],y==null?void 0:y[x]),Vf(T,Sl,dd,_==null?void 0:_[C],P,S,c,g==null?void 0:g[C],y==null?void 0:y[C]),T.objectsData[M]={objectId:I,size:T.elements.offset-M}}}};function Vf(t,e,i,n,s,o,r,a,l){const c=t.elements.stride*t.elements.offset,d=c/t.views.position.BYTES_PER_ELEMENT;t.views.position[d]=$+e[0],t.views.position[d+1]=$+e[1],t.views.z[c/t.views.z.BYTES_PER_ELEMENT]=e[2];const h=c/t.views.demPosition.BYTES_PER_ELEMENT;if(t.views.demPosition[h]=(((r==null?void 0:r[0])??e[0])+$)/8,t.views.demPosition[h+1]=(((r==null?void 0:r[1])??e[1])+$)/8,a!==void 0&&(t.views.absZ[c/t.views.absZ.BYTES_PER_ELEMENT]=a),t.views.isPivot[c/t.views.isPivot.BYTES_PER_ELEMENT]=l??0,"normal"in t.views){const u=c/t.views.normal.BYTES_PER_ELEMENT,f=c/t.views.localID.BYTES_PER_ELEMENT,m=c/t.views.gradient.BYTES_PER_ELEMENT;t.views.normal[u]=qt(i[0]),t.views.normal[u+1]=qt(i[1]),t.views.normal[u+2]=qt(i[2]),t.views.gradient[m]=qt(n??0),t.views.localID[f]=s,t.views.labelingTextureID[f]=o}t.elements.offset++}function LE(t){const e=t.indices.buffer,i=t.indices.offset,n=t.elements.offset;e[i]=n,e[i+1]=n+1,e[i+2]=n+2,t.indices.offset+=3}const gy=[0,0,0],vy=[0,0,0],yy=[0,0,0],hd=[0,0,0],va={symbol:"mapMesh",sinks:{fill:{stride:24,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.z=new Float32Array(e,4),t.views.extender=new Int16Array(e,8),t.views.normal=new Int8Array(e,12),t.views.gradient=new Int8Array(e,15),t.views.demPosition=new Int16Array(e,16),t.views.absZ=new Float32Array(e,16),t.views.isPivot=new Uint8Array(e,20)},packObjectAttributes:(t,e,i,n,s)=>It([t,e.innerId,i,n],e,s),unpackObjectAttributes:t=>({styleId:t[0],layerId:t[1],meshTier:t[2],absZ:t[3],tileData:t.slice(4)})}},generate(t,e,i,n,s,o,r,a){const l=s.x,c=s.y,d=s.signed_z??[],h=s.gradient,u=s.is_pivot,f=s.abs_z,m=l.length,p=a==null?void 0:a[0],_=a==null?void 0:a[1];if(m<3)return;const g=xe/r.size,y=t.getBucket("mapMesh","fill",va.sinks.fill.packObjectAttributes(e,i,o,!!f,n),va.sinks.fill.binder),b=y.indices.buffer;let v=y.indices.offset;const I=y.elements.offset;for(let S=2;S<m;S++){const P=!(S%2),T=P?S-2:S-1,L=P?S-1:S-2;CE(b,v,I,(S-2)*3+2),gt(yy,l[T],c[T],d[T]*g),gt(vy,l[L],c[L],d[L]*g),gt(gy,l[S],c[S],d[S]*g),pg(hd,yy,vy,gy),Hf(y,l[T],c[T],d[T],h==null?void 0:h[T],u==null?void 0:u[T],f==null?void 0:f[T],hd,p,_),Hf(y,l[L],c[L],d[L],h==null?void 0:h[L],u==null?void 0:u[L],f==null?void 0:f[L],hd,p,_),Hf(y,l[S],c[S],d[S],h==null?void 0:h[S],u==null?void 0:u[S],f==null?void 0:f[S],hd,p,_),v+=3}y.indices.offset=v}};function CE(t,e,i,n){t[e]=i+n-2,t[e+1]=i+n-1,t[e+2]=i+n}function Hf(t,e,i,n,s,o,r,a,l=e,c=i){const d=t.elements.offset*t.elements.stride,h=d/t.views.position.BYTES_PER_ELEMENT,u=d/t.views.normal.BYTES_PER_ELEMENT,f=d/t.views.demPosition.BYTES_PER_ELEMENT;t.views.position[h]=$+e,t.views.position[h+1]=$+i,t.views.z[d/t.views.z.BYTES_PER_ELEMENT]=n,t.views.normal[u]=qt(a[0]),t.views.normal[u+1]=qt(a[1]),t.views.normal[u+2]=qt(a[2]),t.views.gradient[d/t.views.gradient.BYTES_PER_ELEMENT]=s??0,t.views.isPivot[d/t.views.isPivot.BYTES_PER_ELEMENT]=o??0,t.views.demPosition[f]=($+l)/8,t.views.demPosition[f+1]=($+c)/8,r!==void 0&&(t.views.absZ[d/t.views.absZ.BYTES_PER_ELEMENT]=r),t.elements.offset++}const RE=1,Zf=-1,zE=1.3,wy=-200,by=-300,FE=Math.tan(ve(175/2)),Dn=[0,0,0],Po=[0,0,0],DE=[0,0,0],Ml=[0,0,0],$f=[0,0,0],Lt=[0,0,0];let ud=0,Il=0;const xy={symbol:"overpass",sinks:{},generate(t,e,i,n,s,o,r,a){var k;let l=s.signed_z;if(!l)return;const c=s.abs_z!==void 0&&Array.from(s.abs_z).some(D=>D)?s.abs_z:void 0,d=n.styleState.terrainEnabled===!0,h=n.tileAttrs[n.tileProps.db_road_part],u=n.tileAttrs[n.tileProps.db_geometry_type],f=(k=n.tileAttrs[n.tileProps.db_tiers])==null?void 0:k[0],m=!!n.tileAttrs[n.tileProps.db_is_mountain]&&!!c&&d,p=h==="tunnel_arch"&&m,_=h==="border_tunnel"&&m;if(h==="roadbed_flat"||h==="border_tunnel_descent"&&m)return;const y=n.tileProps,b=n.tileAttrs.slice();n.id=void 0,b[y.db_tiers]=void 0;const v=e.id,I=s.x.length,S=s.x,P=s.y,T=s.cut??[],L=new Uint8Array(I);p||l.forEach((D,U)=>{L[U]=D?0:1}),!!n.tileAttrs[n.tileProps.db_ignore_z]&&!!c&&d&&(l=new Int32Array(l.length));const O=d?zE:1;d&&!m&&(h==="roadbed_tunnel"||h==="roadbed_tunnel_descent"||h==="border_tunnel"||h==="border_tunnel_descent")&&(l=new Int32Array(l).map(D=>D*O)),Vt(Ml,0,0);const x=Xn(o,Ml)*Ge,C=xe/o.size*x,V=Math.max(W(i.style.borderWidth,n,0),0)*C,M=Math.max(W(i.style.thickness,n,0),0)*x,A=V>0?Math.max(-M,W(i.style.borderHeight,n,0)*x):0,E=Math.max(W(i.style.tunnelHeight,n,0),0)*x;if(u==="polygon"){if(f===void 0)return;const D=[S,P,T,l,new Int8Array(I),L];c&&D.push(c);const U=h==="roadbed_tunnel_descent",N=h==="roadbed_tunnel"||U;va.generate(t,v,i,n,he(D),f,o,void 0);const G=D.map(H=>Array.from(H));for(let H=0;H<G[3].length;H++)G[3][H]-=M,G[4][H]=0;ee.generate(t,v,i,ne.bottom,n,he(G),o,r,a,void 0,N?"inverse":"fill",!0);const Q=[];for(let H=0;H<f;H++)Q.push(H);const X=t.getBucket("polygon","shadow",qi.sinks.shadow.packObjectAttributes(v,i,Q,"",n),qi.sinks.shadow.binder);if(Gv(X,D[0].length,D[0],D[1],Di),N&&!U){const H=D.slice();H[3]=m?new Array(D[0].length).fill(E):Array.from(D[3]).map(K=>K+Math.abs(K/O)-1),ee.generate(t,v,i,ne.top,n,he(H),o,r,a,void 0,m?"fill":"inverse"),m&&ee.generate(t,v,i,ne.bottom,n,he(H),o,r,a,void 0,"fill",!0)}if(U&&d&&!m){const H=D.slice();H[3]=new Array(D[0].length).fill(Math.max(0,A)),ee.generate(t,v,i,ne.top,n,he(H),o,r,a,void 0,"depthClear")}}else if(u==="polyline"){const D=ee.sinks.stroke.packObjectAttributes(v,i,ne.top,!!c,n),U=ee.sinks.stroke.packObjectAttributes(v,i,ne.side,!!c,n),N=ee.sinks.stroke.packObjectAttributes(v,i,ne.bottom,!!c,n),G=OE({x:S,y:P,cut:T,signed_z:l,is_pivot:L,abs_z:c});if(h==="tunnel_arch"&&!m){const Q=Math.max(A,0),X=Tl(G),H=Sy(G,V),K=G.map(ie=>{const J=ie.slice();return J[2]=d?by:wy,J[4]=0,J});Fe(t,N,K);const oe=Ji(H,X,V).map(ie=>(ie[2]=Q,ie[4]=1,ie)),Me=H.map(ie=>{const J=ie.slice();return J[2]=Q,J[4]=1,J}),re=Ie(oe,Me);do ee.generate(t,v,i,ne.top,n,he(re),o,r,a,void 0,Q?"fill":"inverse");while(t.isOverloaded());const Le=G.map(ie=>{const J=ie.slice();return J[2]=Q,J[4]=1,J});Fe(t,D,Le);const be=Ie(Le,K);do ee.generate(t,v,i,ne.side,n,he(be),o,r,a);while(t.isOverloaded());const ge=Ie(oe.map(ie=>{const J=ie.slice();return J[2]=d?by:wy,J[4]=0,J}),oe.map(ie=>{const J=ie.slice();return J[2]=0,J}));do ee.generate(t,v,i,ne.side,n,he(ge),o,r,a,void 0,"inverse");while(t.isOverloaded());if(Q){const ie=Ji(H,X,V).map(Ut=>(Ut[2]=0,Ut[4]=0,Ut));Fe(t,N,ie),Fe(t,D,oe);const J=Ie(ie,oe);do ee.generate(t,v,i,ne.side,n,he(J),o,r,a,void 0,"fill");while(t.isOverloaded());const ae=H.map(Ut=>{const Qt=Ut.slice();return Qt[2]=0,Qt[4]=0,Qt}),Ee=Ie([Me[0],ae[0]],[oe[0],ie[0]]);do ee.generate(t,v,i,ne.side,n,he(Ee),o,r,a,void 0,"fill");while(t.isOverloaded());Fe(t,D,[Me[0],oe[0]]),Fe(t,U,[oe[0],ie[0]]),Fe(t,N,[ie[0],ae[0]]);const Re=Me.length-1,pi=Ie([ae[Re],Me[Re]],[ie[Re],oe[Re]]);do ee.generate(t,v,i,ne.side,n,he(pi),o,r,a,void 0,"fill");while(t.isOverloaded());if(Fe(t,D,[Me[Re],oe[Re]]),Fe(t,U,[oe[Re],ie[Re]]),Fe(t,N,[ie[Re],ae[Re]]),d){do ee.generate(t,v,i,ne.top,n,he(re),o,r,a,void 0,"depthClear");while(t.isOverloaded());do ee.generate(t,v,i,ne.side,n,he(J),o,r,a,void 0,"depthClear");while(t.isOverloaded());do ee.generate(t,v,i,ne.side,n,he(Ee),o,r,a,void 0,"depthClear");while(t.isOverloaded());do ee.generate(t,v,i,ne.side,n,he(pi),o,r,a,void 0,"depthClear");while(t.isOverloaded())}}}else if(p){if(!E)return;const Q=Tl(G),X=Sy(G,V),H=Ji(G,Q,V),K=Ji(X,Q,V),oe=G.map(re=>{const Le=re.slice();return Le[2]=E,Le}),Me=Ie(oe,G);do ee.generate(t,v,i,ne.side,n,he(Me),o,r,a,void 0,"depthClear");while(t.isOverloaded());if(V){const re=[G[0],X[0]],Le=re.map(Bi=>{const nt=Bi.slice();return nt[2]=E,nt[4]=E/(E+A),nt}),be=Ie(re,Le);do ee.generate(t,v,i,ne.side,n,he(be),o,r,a);while(t.isOverloaded());const ge=[H[0],K[0]],ie=ge.map(Bi=>{const nt=Bi.slice();return nt[2]=E,nt[4]=E/(E+A),nt}),J=Ie(ie,ge);do ee.generate(t,v,i,ne.side,n,he(J),o,r,a);while(t.isOverloaded());const ae=[H[0],G[0]],Ee=ae.map(Bi=>{const nt=Bi.slice();return nt[2]=E,nt[4]=E/(E+A),nt}),Re=Ie(ae,Ee);do ee.generate(t,v,i,ne.side,n,he(Re),o,r,a);while(t.isOverloaded());const pi=[X[0],K[0]],Ut=pi.map(Bi=>{const nt=Bi.slice();return nt[2]=E,nt[4]=E/(E+A),nt}),Qt=Ie(pi,Ut);do ee.generate(t,v,i,ne.side,n,he(Qt),o,r,a);while(t.isOverloaded());const hs=G.length-1,$h=[X[hs],G[hs]],wp=$h.map(Bi=>{const nt=Bi.slice();return nt[2]=E,nt[4]=E/(E+A),nt}),gi=Ie($h,wp);do ee.generate(t,v,i,ne.side,n,he(gi),o,r,a);while(t.isOverloaded());const He=[K[hs],H[hs]],b8=He.map(Bi=>{const nt=Bi.slice();return nt[2]=E,nt[4]=E/(E+A),nt}),x8=Ie(b8,He);do ee.generate(t,v,i,ne.side,n,he(x8),o,r,a);while(t.isOverloaded());const Xx=[K[hs],X[hs]],S8=Xx.map(Bi=>{const nt=Bi.slice();return nt[2]=E,nt[4]=E/(E+A),nt}),M8=Ie(Xx,S8);do ee.generate(t,v,i,ne.side,n,he(M8),o,r,a);while(t.isOverloaded());const Yx=[G[hs],H[hs]],I8=Yx.map(Bi=>{const nt=Bi.slice();return nt[2]=E,nt[4]=E/(E+A),nt}),T8=Ie(Yx,I8);do ee.generate(t,v,i,ne.side,n,he(T8),o,r,a);while(t.isOverloaded())}if(A){const re=G.length-1,Le=[X[re],G[re],G[0],X[0]].map(gi=>{const He=gi.slice();return He[2]=E,He[4]=E/(E+A),He}),be=Le.map(gi=>{const He=gi.slice();return He[2]=E+A,He[4]=1,He}),ge=Ie(Le,be);do ee.generate(t,v,i,ne.side,n,he(ge),o,r,a);while(t.isOverloaded());const ie=[K[re],H[re],H[0],K[0]].map(gi=>{const He=gi.slice();return He[2]=E,He[4]=E/(E+A),He}),J=ie.map(gi=>{const He=gi.slice();return He[2]=E+A,He[4]=1,He}),ae=Ie(J,ie);do ee.generate(t,v,i,ne.side,n,he(ae),o,r,a);while(t.isOverloaded());const Ee=Ie(be,J);do ee.generate(t,v,i,ne.top,n,he(Ee),o,r,a);while(t.isOverloaded());const Re=Ie(ie,Le);do ee.generate(t,v,i,ne.bottom,n,he(Re),o,r,a);while(t.isOverloaded());const pi=[X[0],K[0]].map(gi=>{const He=gi.slice();return He[2]=E,He[4]=E/(E+A),He}),Ut=pi.map(gi=>{const He=gi.slice();return He[2]=E+A,He[4]=1,He}),Qt=Ie(pi,Ut);do ee.generate(t,v,i,ne.side,n,he(Qt),o,r,a);while(t.isOverloaded());const hs=[K[re],X[re]].map(gi=>{const He=gi.slice();return He[2]=E,He[4]=E/(E+A),He}),$h=hs.map(gi=>{const He=gi.slice();return He[2]=E+A,He[4]=1,He}),wp=Ie(hs,$h);do ee.generate(t,v,i,ne.side,n,he(wp),o,r,a);while(t.isOverloaded())}}else if(h==="border_overpass"||h==="border_flat"){const Q=[b[y.previousPointX],b[y.previousPointY],l[0]??0,0],X=!!b[y.beginningIsCut]&&My(G[1],G[0],Q);X&&G.splice(0,0,Q);const H=G.length-1,K=[b[y.nextPointX],b[y.nextPointY],l[l.length-1]??0,0],oe=!!b[y.endingIsCut]&&My(G[H-1],G[H],K);oe&&G.push(K);const Me=Tl(G);X&&(Me.shift(),G.shift()),oe&&(Me.pop(),G.pop());const re=G.map(Ee=>{const Re=Ee.slice();return Re[2]=Math.max(Re[2]-M,0),Re[4]=0,Re});Fe(t,U,G);const Le=Ji(G,Me,V).map(Ee=>{const Re=Ee.slice();return Re[2]=Math.max(Ee[2]-M,0),Re[4]=0,Re}),be=Ji(G,Me,V).map(Ee=>{const Re=Ee.slice();return Re[2]=Math.max(Ee[2]+A,0),Re[4]=1,Re}),ge=G.map(Ee=>{const Re=Ee.slice();return A>0&&(Re[2]=Math.max(Re[2]+A,0)),Re[4]=1,Re});if(A>0){Fe(t,D,ge);const Ee=Ie(ge,G.map(Re=>{const pi=Re.slice();return pi[4]=0,pi}));do ee.generate(t,v,i,ne.side,n,he(Ee),o,r,a);while(t.isOverloaded())}Fe(t,N,Le),Fe(t,D,be);const ie=Ie(be,ge);do ee.generate(t,v,i,ne.top,n,he(ie),o,r,a);while(t.isOverloaded());const J=Ie(re,Le);do ee.generate(t,v,i,ne.bottom,n,he(J),o,r,a,void 0,"fill");while(t.isOverloaded());const ae=Ie(Le,be);do ee.generate(t,v,i,ne.side,n,he(ae),o,r,a,void 0,"fill");while(t.isOverloaded());if(l[0]===0){const Ee=Ie([ge[0],re[0]],[be[0],Le[0]]);do ee.generate(t,v,i,ne.side,n,he(Ee),o,r,a,void 0,"fill");while(t.isOverloaded());Fe(t,D,[be[0],ge[0]]),Fe(t,U,[ge[0],re[0]]),Fe(t,U,[Le[0],be[0]]),Fe(t,N,[re[0],Le[0]])}if(l[l.length-1]===0){const Ee=re.length-1,Re=Ie([re[Ee],ge[Ee]],[Le[Ee],be[Ee]]);do ee.generate(t,v,i,ne.side,n,he(Re),o,r,a,void 0,"fill");while(t.isOverloaded());Fe(t,D,[ge[Ee],be[Ee]]),Fe(t,U,[re[Ee],ge[Ee]]),Fe(t,U,[be[Ee],Le[Ee]]),Fe(t,N,[Le[Ee],re[Ee]])}}else if(_){const Q=G.map(H=>{const K=H.slice();return K[2]=E,K[4]=E/(E+A),K}),X=Ie(Q,G);do ee.generate(t,v,i,ne.side,n,he(X),o,r,a);while(t.isOverloaded());do ee.generate(t,v,i,ne.side,n,he(X),o,r,a,void 0,"fill",!0);while(t.isOverloaded())}else{const Q=Tl(G),X=h==="border_tunnel_descent",H=h==="border_tunnel"||X,K=H?Math.max(A,0):A,oe=G.map(be=>{const ge=be.slice();return ge[2]-=M,X?ge[2]=0:H&&(ge[2]=Math.max(ge[2],Zf)),ge[4]=0,ge}),Me=Ji(G,Q,V).map(be=>(be[2]-=M,X&&(be[2]=0),be[4]=0,be)),re=Ji(G,Q,V).map(be=>(be[2]+=K,X?be[2]=K:H&&(be[2]=Math.max(be[2],Zf)),be[4]=1,be)),Le=G.map(be=>{const ge=be.slice();if(ge[4]=1,X)ge[2]=K;else if(H){const ie=Math.abs(ge[2]/O),J=K-ge[2],ae=ge[2]+ie-1;ge[4]=(ae+Math.abs(ge[2]))/J,ge[2]=ae}else ge[2]+=K;return ge});if(H){X&&Fe(t,D,Le);const be=Ie(Le,G.map(J=>{const ae=J.slice();return ae[4]=0,ae}));do ee.generate(t,v,i,ne.side,n,he(be),o,r,a);while(t.isOverloaded());const ge=Le.map(J=>{const ae=J.slice();return ae[2]=Math.min(J[2],Zf),ae}),ie=Ie(ge,G);do ee.generate(t,v,i,ne.side,n,he(ie),o,r,a,void 0,"inverse",!0);while(t.isOverloaded())}if(A>0&&(!H||X)){Fe(t,N,Me),Fe(t,D,re);const be=Ie(re,Le);do ee.generate(t,v,i,ne.top,n,he(be),o,r,a);while(t.isOverloaded());if(X&&d)do ee.generate(t,v,i,ne.top,n,he(be),o,r,a,void 0,"depthClear");while(t.isOverloaded())}if(!H||X){const be=Ie(oe,Me);do ee.generate(t,v,i,ne.bottom,n,he(be),o,r,a,void 0,"fill");while(t.isOverloaded());const ge=Ie(Me,re);do ee.generate(t,v,i,ne.side,n,he(ge),o,r,a,void 0,"fill");while(t.isOverloaded());if(X&&d)do ee.generate(t,v,i,ne.side,n,he(ge),o,r,a,void 0,"depthClear");while(t.isOverloaded());if(l[0]===0){const ie=Ie([Le[0],oe[0]],[re[0],Me[0]]);do ee.generate(t,v,i,ne.side,n,he(ie),o,r,a,void 0,"fill");while(t.isOverloaded());if(X&&d)do ee.generate(t,v,i,ne.side,n,he(ie),o,r,a,void 0,"depthClear");while(t.isOverloaded());Fe(t,D,[re[0],Le[0]]),Fe(t,U,[Le[0],oe[0]]),Fe(t,U,[Me[0],re[0]]),Fe(t,N,[oe[0],Me[0]])}if(l[l.length-1]===0){const ie=oe.length-1,J=Ie([oe[ie],Le[ie]],[Me[ie],re[ie]]);do ee.generate(t,v,i,ne.side,n,he(J),o,r,a,void 0,"fill");while(t.isOverloaded());if(X&&d)do ee.generate(t,v,i,ne.side,n,he(J),o,r,a,void 0,"depthClear");while(t.isOverloaded());Fe(t,D,[Le[ie],re[ie]]),Fe(t,U,[oe[ie],Le[ie]]),Fe(t,U,[re[ie],Me[ie]]),Fe(t,N,[Me[ie],oe[ie]])}}}}}};function OE(t){var n,s,o;const e=[],i=t.x.length;for(let r=0;r<i;r++){const a=[t.x[r],t.y[r],((n=t.signed_z)==null?void 0:n[r])??0,((s=t.cut)==null?void 0:s[r])??0,0,((o=t.is_pivot)==null?void 0:o[r])??0];t.abs_z&&a.push(t.abs_z[r]),e.push(a)}return e}function Tl(t){const e=[];ps(Dn,t[0][0],t[0][1],t[1][0],t[1][1]),ud=0;for(let i=1;i<t.length;i++)BE(e,t,i);return e}function BE(t,e,i){const n=i===e.length-1;if(Vt(DE,e[i-1][0],e[i-1][1]),Vt(Ml,e[i][0],e[i][1]),Iu(Lt,Dn),n)Il=0;else{Vt($f,e[i+1][0],e[i+1][1]),ps(Po,Ml[0],Ml[1],$f[0],$f[1]);const r=Be(Vo(Dn,Po),-1,1),a=Math.min(Math.sqrt((1-r)/(1+r)),FE),l=gc(Vo(Lt,Po));Il=a*l}let s=Lt[0]+Dn[0]*ud,o=Lt[1]+Dn[1]*ud;t.push([s,o]),n&&(s=Lt[0]+Dn[0]*Il,o=Lt[1]+Dn[1]*Il,t.push([s,o])),n||($a(Dn,Po),ud=Il)}function Ji(t,e,i){const n=[];for(let s=0;s<t.length;s++){const o=t[s].slice();$a(Lt,e[s]),Ei(Lt,Lt,i),An(o,o,Lt),n.push(o)}return n}function Fe(t,e,i){do{const n=t.getBucket("mesh","stroke",e,ee.sinks.stroke.binder),s=i.length;for(let o=0;o<s-1;o++){const r=o+1;dl(n,i[o][0],i[o][1],i[o][2],i[r][0],i[r][1],i[r][2],void 0,!1,i[o][6],i[r][6],i[o][5],i[r][5])}}while(t.isOverloaded())}function Ie(t,e){return kE([t[0]].concat(t,e.slice().reverse()))}function kE(t){const e=t.length,i=[[],[],[],[],[],[]];t[0][6]!==void 0&&i.push([]);for(let n=0;n<e;n++){const s=zi(n,e),o=t[n];i[0][s]=o[0],i[1][s]=o[1],i[2][s]=o[3],i[3][s]=o[2],i[4][s]=o[4]??0,i[5][s]=o[5]??0,i[6]&&(i[6][s]=o[6]??0)}return i}function he(t){return{x:t[0],y:t[1],cut:t[2],signed_z:t[3],gradient:t[4],is_pivot:t[5],abs_z:t[6]}}function Sy(t,e){return t=t.map(i=>i.slice()),vi(Lt,t[0],t[1]),Ui(Lt,Lt),Ni(Lt,Lt,e),Ot(t[0],t[0],Lt),vi(Lt,t[t.length-1],t[t.length-2]),Ui(Lt,Lt),Ni(Lt,Lt,e),Ot(t[t.length-1],t[t.length-1],Lt),t}const My=function(){const t=Math.cos(ve(RE));return(e,i,n)=>(Ai(Dn,i,e),fs(Dn,Dn),Ai(Po,i,n),fs(Po,Po),Vo(Dn,Po)<=t)}();function NE(t,e,i,n){return It([t,e.innerId,i],e,n)}const fd={symbol:"metricPoint",sinks:{fill:{stride:8,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.texCoords=new Uint16Array(e,4)},packObjectAttributes:NE,unpackObjectAttributes:t=>({styleId:t[0],layerId:t[1],tiers:t[2],tileData:t.slice(3)})}},generate(t,e,i,n,s,o,r){GE(t,n,s,i,o);const a=W(s.style.width,o),l=W(s.style.height,o),c=W(s.style.rotation,o),[d,h]=RI([e.x,e.y],a,l,c,r),u=q(s.ignoreTier,o)?null:o.tileAttrs[o.tileProps.db_tiers],f=t.getBucket("metricPoint","fill",fd.sinks.fill.packObjectAttributes(n.id,s,u,o),fd.sinks.fill.binder);let m=f.elements.offset;UE(f.indices,m,0,1,2,0,2,3),_d(f,m++,d[0],h[0],0,0),_d(f,m++,d[1],h[1],1,0),_d(f,m++,d[2],h[2],1,1),_d(f,m++,d[3],h[3],0,1),f.elements.offset=m}};function _d(t,e,i,n,s,o){e=e*4,t.views.position[e]=$+i,t.views.position[e+1]=$+n,t.views.texCoords[e]=Yi(s),t.views.texCoords[e+1]=Yi(o)}function UE(t,e,i,n,s,o,r,a){const l=t.buffer,c=t.offset;l[c]=e+i,l[c+1]=e+n,l[c+2]=e+s,l[c+3]=e+o,l[c+4]=e+r,l[c+5]=e+a,t.offset=c+6}function GE(t,e,i,n,s){const{rasterSets:o}=e,r=af(n);Zs(i.style.iconImage).forEach(a=>{if(!a.length)return;const l=o.byKey[ta(a)];if(!l){console.error(`Not found raster set with texture ${a}`);return}if(!l.isSvg)return;const c=W(i.style.width,s),d=W(i.style.height,s),h=oa(c,d),u=c*h,f=d*h;t.atlasPacker.packSvg(l,[{w:u,h:f}],r),l.rasters.forEach(m=>t.atlasPacker.addRastersToLoad(e.id,m))})}const _r=1e5,Wf=4;function jE(t){return Ty(t.lo,t.hi)}function Iy(t){return[t%_r,Math.floor(t/_r)%_r,0,0]}function VE(t){let i=0;for(let n=0;n<Wf;n++){const s=t[n]*4294967296+i;i=Math.floor(s/_r),t[n]=s%_r}}function HE(t,e){let i=0;for(let n=0;n<Wf;n++){const s=t[n]+e[n]+i;i=Math.floor(s/_r),t[n]=s%_r}}function ZE(t){const e="00000";let i=!0,n=Wf,s="";for(;--n>=0;){const o=String(t[n]);i?t[n]!==0&&(s+=o,i=!1):s+=e.slice(o.length)+o}return s.length||(s="0"),s}function Ty(t,e){const i=Iy(t),n=Iy(e);return VE(n),HE(n,i),ZE(n)}const si=[0,0,0],md=[0,0,0],pd=new Float64Array(16),Ey={symbol:"tunnel",sinks:{},generate(t,e,i,n,s,o,r,a){var X;const{tileProps:l,tileAttrs:c}=n,d=(X=c[l.db_tiers])==null?void 0:X[0];if(jE(c[l.id])!=="70030076221371399"||!d)return;const u=e.id;Vt(si,0,0);const m=Xn(o,si)*Ge,p=xe/o.size*m,_=1/(xe/o.size),g=c[l.objectLength],y=c[l.componentDistanceStart]??0,b=c[l.componentDistanceEnd]??0,v=y===0?0:-5,I=175,S=243,P=b===g?0:-5;if(Number.isNaN(g)||Number.isNaN(y)||g===0)return;const T=S-I,L=I+T*y/g,B=I+T*b/g,O=3.5*p,w=5*p,x=[];let C=0;for(let H=0;H<s.x.length;H++){const K=[s.x[H],s.y[H],0];H>0&&(C+=po(K,x[H-1]),K[2]=C),x.push(K)}const V=$E(x),M=Tl(x);x.forEach(H=>{const K=H[2]/V;H[2]=(v+K*(P-v))*m,H[5]=(L+K*(B-L))*m});const A=ee.sinks.stroke.packObjectAttributes(u,i,ne.side,!0,n),E=Ji(x,M,O),k=Ji(x,M,-O),D=Ie(E,k),U=Ji(x,M,w),N=U.map(H=>{const K=H.slice();return K[2]=Math.max(0,K[2]),K});ee.generate(t,u,i,ne.side,n,he(Ie(U,N)),o,r,a,void 0,"inverse");const G=Ji(x,M,-w),Q=G.map(H=>{const K=H.slice();return K[2]=Math.max(0,K[2]),K});ee.generate(t,u,i,ne.side,n,he(Ie(Q,G)),o,r,a,void 0,"inverse"),x[0][2]!==0&&x[x.length-1][2]!==0&&ee.generate(t,u,i,ne.side,n,he(Ie(N,Q)),o,r,a,void 0,"inverse");do va.generate(t,u,i,n,he(D),d,o,void 0);while(t.isOverloaded());for(let H=1;H<x.length;H++){const K=[],oe=[],Me=x[H-1],re=x[H],Le=M[H-1],be=M[H];for(let ie=0;ie<=181;ie+=15){const J=ve(ie),ae=Me.slice();gt(si,Le[0],Le[1],0),Ni(si,si,O),yo(md,si),Xp(pd,-J,md),Tn(si,si,pd),si[2]*=_,Ot(ae,ae,si),K.push(ae);const Ee=re.slice();gt(si,be[0],be[1],0),Ni(si,si,O),yo(md,si),Xp(pd,-J,md),Tn(si,si,pd),si[2]*=_,Ot(Ee,Ee,si),oe.push(Ee)}const ge=Ie(K,oe);if(ee.generate(t,u,i,ne.side,n,he(ge),o,r,a,void 0,"fill"),H===1&&x[0][2]===0){Fe(t,A,K);const ie=x[0].slice(),J=x[0].slice(),ae=M[0].slice(),Ee=M[0].slice();Ei(ae,ae,w),Ei(Ee,Ee,-w),An(ie,ie,ae),An(J,J,Ee);const Re=ie.slice(),pi=J.slice();Re[2]+=w*_,pi[2]+=w*_;const Ut=[ie];for(let Qt=0;Qt<5;Qt++)Ut.push(Re);for(let Qt=0;Qt<5;Qt++)Ut.push(pi);Ut.push(J),Fe(t,A,Ut),ee.generate(t,u,i,ne.side,n,he(Ie(Ut,K)),o,r,a,void 0,"fill")}else if(H===x.length-1&&x[x.length-1][2]===0){Fe(t,A,oe);const ie=x[x.length-1].slice(),J=x[x.length-1].slice(),ae=M[x.length-1].slice(),Ee=M[x.length-1].slice();Ei(ae,ae,w),Ei(Ee,Ee,-w),An(ie,ie,ae),An(J,J,Ee);const Re=ie.slice(),pi=J.slice();Re[2]+=w*_,pi[2]+=w*_;const Ut=[ie];for(let Qt=0;Qt<5;Qt++)Ut.push(Re);for(let Qt=0;Qt<5;Qt++)Ut.push(pi);Ut.push(J),Fe(t,A,Ut),ee.generate(t,u,i,ne.side,n,he(Ie(oe,Ut)),o,r,a,void 0,"fill")}}if(x[0][2]===0||x[x.length-1][2]===0){const H=Ji(x,M,w),K=Ji(x,M,-w),oe=H.map(ge=>{const ie=ge.slice();return ie[2]=Math.max(0,ie[2]+w*_),ie}),Me=K.map(ge=>{const ie=ge.slice();return ie[2]=Math.max(0,ie[2]+w*_),ie});H.forEach(ge=>{ge[2]=Math.max(0,ge[2])}),K.forEach(ge=>{ge[2]=Math.max(0,ge[2])});const re=Ie(H,oe),Le=Ie(Me,K);Fe(t,A,H),Fe(t,A,K),Fe(t,A,oe),Fe(t,A,Me),ee.generate(t,u,i,ne.side,n,he(re),o,r,a,void 0,"fill"),ee.generate(t,u,i,ne.side,n,he(Le),o,r,a,void 0,"fill");const be=Ie(oe,Me);ee.generate(t,u,i,ne.top,n,he(be),o,r,a,void 0,"fill")}}};function $E(t){let e=0;for(let i=0;i<t.length-1;i++)e+=Un(t[i],t[i+1]);return e}var Ts=(t=>(t[t.Chess=1]="Chess",t[t.DoubleDash=2]="DoubleDash",t[t.Stripe=3]="Stripe",t[t.Triangles=4]="Triangles",t[t.Circle=5]="Circle",t[t.Chevron=6]="Chevron",t[t.None=-1]="None",t))(Ts||{});function Ay(t){switch(t){case"chess":return 1;case"doubledash":return 2;case"triangles":return 4;case"circle":return 5;case"heart":return 6;case"stripe":return 3;default:return-1}}const WE={symbol:"simpleMesh",sinks:{fill:{stride:24,binder:()=>{},packObjectAttributes(t,e,i){return It([t,e.innerId],e,i)},unpackObjectAttributes(t){return{styleId:t[0],layerId:t[1],tileData:t.slice(2)}}}}},XE=32,ya={symbol:"globe",sinks:{fill:{stride:16,binder:(t,e)=>{t.views.ecefPosition=new Int16Array(e),t.views.flatPosition=new Uint16Array(e,6),t.views.texture=new Uint16Array(e,12)},packObjectAttributes(t,e,i){return[t,e.innerId,i]},unpackObjectAttributes(t){return{styleId:t[0],layerId:t[1],tileData:t.slice(2)}},generate(t,e,i,n){const s=n.coords.join("/"),o=t.getBucket("globe","fill",ya.sinks.fill.packObjectAttributes(e.id,i,s),ya.sinks.fill.binder);KE(o,XE,n.coords)}}}},YE=Yt.fromGeo([0,90]),qE=Yt.fromGeo([0,-90]);function KE(t,e,i){const n=Ye(i),s=t.views.ecefPosition,o=t.indices.buffer,r=i[1]===2**i[2]-1,a=i[1]===0,l=t.elements.offset*ya.sinks.fill.stride/Uint16Array.BYTES_PER_ELEMENT;let c=0,d=t.indices.offset;for(let h=0;h<e;h++)for(let u=0;u<e;u++){let f;const m=[h*32768/(e-1),u*32768/(e-1)];r&&u===e-1?f=YE:a&&u===0?f=qE:f=Uu(n,m),s[l+c++]=f[0]*Pi,s[l+c++]=f[1]*Pi,s[l+c++]=f[2]*Pi,s[l+c++]=$+m[0],s[l+c++]=$+m[1],s[l+c++]=0,s[l+c++]=h/(e-1)*(2**16-1),s[l+c++]=u/(e-1)*(2**16-1)}for(let h=0;h<e-1;h++)for(let u=0;u<e-1;u++){const f=h*e+u,m=f+1,p=f+e,_=p+1;o[d++]=f,o[d++]=p,o[d++]=m,o[d++]=m,o[d++]=p,o[d++]=_}t.indices.offset=d,t.elements.offset=l+c/8}var eo=(t=>(t[t.none=0]="none",t[t.fadeIn=1]="fadeIn",t[t.fadeOut=-1]="fadeOut",t))(eo||{});function vt({collector:t,generator:e,args:i}){do e(t,...i);while(t.isOverloaded())}const Py={arrow:_l,line:St,polygon:qi,embankment:ee,polygon3d:ee,metricPoint:fd,labelLine:zf,lineExtrusion:bs,polygonExtrusion:ws,oneWayLine:Df,dashedLine:es,shiftedLine:Bc,circle:da,buildingModel:Fn,gltfModel:ss,point:Ks,raster:fa,heatmap:Js,dem:hi,mesh:ee,mapMesh:va,overpass:xy,tunnel:Ey,simpleMesh:WE,globe:ya};function El(t,e){const i=Py[t];return i?i.sinks[e].stride:0}function Zt(t,e){t.precomputes.forEach((i,n)=>{e.tileData[n]=q(i.expr,e)})}function Ly(t,e,i,n,s,o,r,a,l,c,d,h,u,f){i.forEach(m=>{if(yM(n,[d.x[0],d.y[0]]),!(r!==void 0&&(m.maxzoom<=r||m.minzoom>=r+1&&r!==Xe.maxDetailLevel))&&!(n.tileProps.hovered&&!Number.isNaN(n.tileAttrs[n.tileProps.hovered])&&n.tileAttrs[n.tileProps.hovered]===1&&m.type!=="polygon"&&m.type!=="polygonExtrusion"&&m.type!=="point"&&m.type!=="polygon3d")){Zt(m,n);do switch(m.type){case"line":const p=q(m.style.pattern,n);p&&p[0]!==Ts.None?St.generatePatterned(t,e.id,m,n,l,d):St.generate(t,e.id,m,n,l,d);break;case"dashedLine":es.generate(t,e.id,m,n,l,d);break;case"shiftedLine":Bc.generate(t,e.id,m,n,d);break;case"polygon":qi.generate(t,e.id,m,n,d,c,e.rasterSets);break;case"polygon3d":case"embankment":ee.generate(t,e.id,m,ne.top,n,d,l,c,e.rasterSets,void 0,"fill");break;case"metricPoint":{fd.generate(t,d,c,e,m,n,l);break}case"polygonExtrusion":ws.generate(t,e.id,m,n,d);break;case"labelLine":dE(t,e.id,m,l.coords,a,n,d);break;case"oneWayLine":hE(t,e.id,m,l.coords,a,n,d);break;case"point":{ad(t,e,m,n,s,o,l.coords,a,d,c,h);break}case"lineExtrusion":bs.generate(t,e.id,m,n,d);break;case"arrow":_l.generate(t,e.id,m,n,d);break;case"heatmap":{Js.generate(t,e.id,m,d,n);break}case"gltfModel":{ss.generateInstances(t,e,m,n,d,l,a,u,f,s,2);break}case"overpass":xy.generate(t,e,m,n,d,l,c,e.rasterSets);break;case"tunnel":Ey.generate(t,e,m,n,d,l,c,e.rasterSets);break}while(t.isOverloaded())}})}class z{constructor(e,i={}){this._buffer=e,this.options=Object.assign({},R.defaultOptions,i)}get isDirty(){return this._buffer.isDirty}set isDirty(e){this._buffer.isDirty=e}bind(e,i,n,s,o){this._buffer.bind(e,i,n||this.options,s,o)}replaceData(e){this._buffer.replaceData(e)}commitData(e){this._buffer.commitData(e)}getData(){return this._buffer.getData()}}function Cy(t,e){const i=new Set;return t.forEach(n=>{e.has(n)||i.add(n)}),i}function JE(t,e){if(!t||!e)return t===e;if(t.size!==e.size)return!1;for(const i of t)if(!e.has(i))return!1;return!0}function QE(t,e){const i=new Set;for(const n of e)t.has(n)&&i.add(n);return i}function e4(t,e){if(!t||!e)return t===e;if(t.size!==e.size)return!1;for(const[i,n]of t)if(!e.has(i)||!JE(n,e.get(i)))return!1;return!0}const mn="default",Xf="floor",Yf="dynamicModel";var Qi=(t=>(t[t.PolygonExtrusion=1]="PolygonExtrusion",t[t.FloorPolygons=2]="FloorPolygons",t[t.All=3]="All",t))(Qi||{});class t4{constructor(e){this.identifier=e,this.tileLayers=[],this.selected=[],this.hidden=new Map,this.parentChildrenMap=new Map,this.childParentMap=new Map,this.parentChildrenMapByTile=new Map,this.selectedIdsByApi=[]}registerTileLayer(e){this.tileLayers.push(e)}unregisterTileLayer(e){this.tileLayers=this.tileLayers.filter(i=>i!==e)}select(e){this.selectedIdsByApi=e.slice(),this.selected=this.getIdsToSelect(e),this.selected.sort();for(const i of this.tileLayers)i.setSelectedIds(this.selected);this.identifier.debouncedFillCache()}getSelected(){return this.selected}show(e){for(const i of e)this.hidden.delete(i);this.triggerIdUpdate(e)}hide(e,i=3){for(const n of e)this.hidden.set(n,i);this.triggerIdUpdate(e)}isHidden(e,i=3){return(this.hidden.get(e)??0)>=i}getHidden(e=3){const i=new Set;return this.hidden.forEach((n,s)=>{n>=e&&i.add(s)}),i}triggerIdUpdate(e){for(const i of this.tileLayers)i.pushIdsToUpdate(e)}removeParentChildrenData(e){let i=!1;e.forEach(n=>{const s=this.parentChildrenMapByTile.delete(n);!i&&s&&(i=!0)}),i&&this.rebuildMaps()}updateParentChildrenData(e,i){this.updateTileParentChildrenData(e,i)&&(this.addParentChildrenData(i),this.select(this.selectedIdsByApi))}addParentChildrenData(e){e&&e.size&&e.forEach((i,n)=>{const s=this.parentChildrenMap.get(n);s?i.forEach(o=>{s.add(o),this.childParentMap.set(o,n)}):(this.parentChildrenMap.set(n,new Set(i)),i.forEach(o=>{this.childParentMap.set(o,n)}))})}rebuildMaps(){this.parentChildrenMap.clear(),this.childParentMap.clear(),this.parentChildrenMapByTile.forEach(e=>this.addParentChildrenData(e))}updateTileParentChildrenData(e,i){const n=this.parentChildrenMapByTile.get(e);return e4(n,i)?!1:(n&&n.forEach((s,o)=>{const r=this.parentChildrenMap.get(o);s.forEach(a=>{r==null||r.delete(a),this.childParentMap.delete(a)})}),this.parentChildrenMapByTile.delete(e),i&&this.parentChildrenMapByTile.set(e,i),!0)}getIdsToSelect(e){const i=new Set(e);return e.forEach(n=>{if(this.parentChildrenMap.has(n)){const o=this.parentChildrenMap.get(n);o!=null&&o.size&&o.forEach(i.add,i)}}),Array.from(i)}}function Ry(t,e,i,n){for(const s of e)s4(t,i,s,n)}function i4(t,e,i){const n=e.buffer,s=[];for(const o of e.generatedObjects){const r=new DataView(n,o.rangeStart,o.rangeEnd-o.rangeStart),a=new R(r);a.purpose="instanced",a.drawType=R.StaticDraw,a.prepare(t.getRenderingContext()),o.buffer=a,o.rangeEnd-o.rangeStart===i&&(o.tMatrix3x3=new Float32Array(r.buffer,o.rangeStart+16,9)),s.push(a)}return s}function n4(t,e,i,n,s){const o=new R(i);o.purpose="attributes",o.drawType=R.StaticDraw,o.prepare(t.getRenderingContext());const r=[];let a,l,c;return s&&(c=new R(s,{itemSize:1,dataType:R.UnsignedShort},!0),c.elementsType=R.UnsignedShort),e.forEach(d=>{const h=t.getShaderProgram(d.programName),u=d.vaoCreator(o,h,c);if(d.needsVisibilityBuffer){if(!a||!l){const f=new Uint8Array(new Array(n).fill(1));a=new R(f,void 0,!1,!0),a.purpose="visibility",l=new z(a,{itemSize:1,dataType:R.UnsignedByte})}u.setAttribute("a_float_visibility",l)}r.push(u)}),{buffer:o,visibilityBuffer:a,vaos:r}}function s4(t,e,i,n){const{renderer:s,instanceLinker:o}=t,{symbol:r,sink:a,generatedObjects:l,buffer:c,elementsBuffer:d,elementSize:h}=i;if(s.symbolSettingsList[r]===void 0)return;const f=qf(s,r,a);if(f.length===0)return;const m=El(r,a);if(f[0].instanceBinder){const b=i4(s,i,m);e.buffers.push(...b),o.enqueue(i,e);return}let p=0;d&&h?p=d.byteLength/h:p=c.byteLength/m;const{buffer:_,vaos:g,visibilityBuffer:y}=n4(s,f,c,p,d);e.pushBuffer(_),y&&e.pushBuffer(y);for(let b=0;b<l.length;b++){const{rangeStart:v,rangeEnd:I,attributes:S,drawMode:P,meta:T,objectsData:L}=l[b],B=Py[r].sinks[a].unpackObjectAttributes(S),O=[];for(let w=0;w<f.length;w++){const x=f[w],C=g[w],V=x.uniformSet||"fill",M={id:Vn(),type:Xi.Tile,layerSettings:x,start:v/m,count:(I-v)/m,attributes:B,renderingProperties:{},attributesHash:JSON.stringify(S)+"_"+V+"_"+e.detailLevel,vao:C,drawMode:P,tile:e,symbol:r,sink:a,meta:T,canRender:!0};e.push(M),x.needsVisibilityBuffer&&O.push(C)}n&&O.length>0&&L&&e instanceof Ct&&o4(L,e,O,n,!!B.floorId)}}function o4(t,e,i,n,s){const o=s?e.floorObjectsMap:e.objectsMap,r=[];for(const a in t){const l=t[a];let c=o[a];c||(c=new Map,o[a]=c);let d=c.get(i);d||(d=[],c.set(i,d));for(const h of l)d.push(h);n.isHidden(a,Qi.PolygonExtrusion)&&r.push(a)}n.triggerIdUpdate(r)}function qf(t,e,i){const n=t.symbolSettingsList[e];if(n===void 0)return[];const s=n[i];return s==null||s.length===0?[]:s}var Kf,zy;function r4(){if(zy)return Kf;zy=1;var t=4,e=.001,i=1e-7,n=10,s=11,o=1/(s-1),r=typeof Float32Array=="function";function a(p,_){return 1-3*_+3*p}function l(p,_){return 3*_-6*p}function c(p){return 3*p}function d(p,_,g){return((a(_,g)*p+l(_,g))*p+c(_))*p}function h(p,_,g){return 3*a(_,g)*p*p+2*l(_,g)*p+c(_)}function u(p,_,g,y,b){var v,I,S=0;do I=_+(g-_)/2,v=d(I,y,b)-p,v>0?g=I:_=I;while(Math.abs(v)>i&&++S<n);return I}function f(p,_,g,y){for(var b=0;b<t;++b){var v=h(_,g,y);if(v===0)return _;var I=d(_,g,y)-p;_-=I/v}return _}function m(p){return p}return Kf=function(_,g,y,b){if(!(0<=_&&_<=1&&0<=y&&y<=1))throw new Error("bezier x values must be in [0, 1] range");if(_===g&&y===b)return m;for(var v=r?new Float32Array(s):new Array(s),I=0;I<s;++I)v[I]=d(I*o,_,y);function S(P){for(var T=0,L=1,B=s-1;L!==B&&v[L]<=P;++L)T+=o;--L;var O=(P-v[L])/(v[L+1]-v[L]),w=T+O*o,x=h(w,_,y);return x>=e?f(P,w,_,y):x===0?w:u(P,T,T+o,_,y)}return function(T){return T===0?0:T===1?1:d(S(T),g,b)}},Kf}var a4=r4();const l4=Ja(a4);function c4(t,e,i,n){return e+i/n*t}const d4=l4(.25,.1,.25,1);function h4(t,e,i,n){return e+i*d4(t/n)}function u4(t,e,i,n){return i*(t/=n)*t+e}function f4(t,e,i,n){return-i*(t/=n)*(t-2)+e}function _4(t,e,i,n){return(t/=n/2)<1?i/2*t*t+e:-i/2*(--t*(t-2)-1)+e}function m4(t,e,i,n){return i*(t/=n)*t*t+e}function p4(t,e,i,n){return i*((t=t/n-1)*t*t+1)+e}function g4(t,e,i,n){return(t/=n/2)<1?i/2*t*t*t+e:i/2*((t-=2)*t*t+2)+e}function v4(t,e,i,n){return i*(t/=n)*t*t*t+e}function y4(t,e,i,n){return-i*((t=t/n-1)*t*t*t-1)+e}function w4(t,e,i,n){return(t/=n/2)<1?i/2*t*t*t*t+e:-i/2*((t-=2)*t*t*t-2)+e}function b4(t,e,i,n){return i*(t/=n)*t*t*t*t+e}function x4(t,e,i,n){return i*((t=t/n-1)*t*t*t*t+1)+e}function S4(t,e,i,n){return(t/=n/2)<1?i/2*t*t*t*t*t+e:i/2*((t-=2)*t*t*t*t+2)+e}function M4(t,e,i,n){return-i*Math.cos(t/n*(Math.PI/2))+i+e}function I4(t,e,i,n){return i*Math.sin(t/n*(Math.PI/2))+e}function T4(t,e,i,n){return-i/2*(Math.cos(Math.PI*t/n)-1)+e}function E4(t,e,i,n){return t==0?e:i*Math.pow(2,10*(t/n-1))+e}function A4(t,e,i,n){return t==n?e+i:i*(-Math.pow(2,-10*t/n)+1)+e}function P4(t,e,i,n){return t==0?e:t==n?e+i:(t/=n/2)<1?i/2*Math.pow(2,10*(t-1))+e:i/2*(-Math.pow(2,-10*--t)+2)+e}function L4(t,e,i,n){return-i*(Math.sqrt(1-(t/=n)*t)-1)+e}function C4(t,e,i,n){return i*Math.sqrt(1-(t=t/n-1)*t)+e}function R4(t,e,i,n){return(t/=n/2)<1?-i/2*(Math.sqrt(1-t*t)-1)+e:i/2*(Math.sqrt(1-(t-=2)*t)+1)+e}function z4(t,e,i,n){var r=1.70158,s=0,o=i;if(t==0)return e;if((t/=n)==1)return e+i;if(s||(s=n*.3),o<Math.abs(i)){o=i;var r=s/4}else var r=s/(2*Math.PI)*Math.asin(i/o);return-(o*Math.pow(2,10*(t-=1))*Math.sin((t*n-r)*(2*Math.PI)/s))+e}function F4(t,e,i,n){var r=1.70158,s=0,o=i;if(t==0)return e;if((t/=n)==1)return e+i;if(s||(s=n*.3),o<Math.abs(i)){o=i;var r=s/4}else var r=s/(2*Math.PI)*Math.asin(i/o);return o*Math.pow(2,-10*t)*Math.sin((t*n-r)*(2*Math.PI)/s)+i+e}function D4(t,e,i,n){var r=1.70158,s=0,o=i;if(t==0)return e;if((t/=n/2)==2)return e+i;if(s||(s=n*(.3*1.5)),o<Math.abs(i)){o=i;var r=s/4}else var r=s/(2*Math.PI)*Math.asin(i/o);return t<1?-.5*(o*Math.pow(2,10*(t-=1))*Math.sin((t*n-r)*(2*Math.PI)/s))+e:o*Math.pow(2,-10*(t-=1))*Math.sin((t*n-r)*(2*Math.PI)/s)*.5+i+e}function O4(t,e,i,n,s){return s==null&&(s=1.70158),i*(t/=n)*t*((s+1)*t-s)+e}function B4(t,e,i,n,s){return s==null&&(s=1.70158),i*((t=t/n-1)*t*((s+1)*t+s)+1)+e}function k4(t,e,i,n,s){return s==null&&(s=1.70158),(t/=n/2)<1?i/2*(t*t*(((s*=1.525)+1)*t-s))+e:i/2*((t-=2)*t*(((s*=1.525)+1)*t+s)+2)+e}function N4(t,e,i,n){return(t/=n)<1/2.75?i*(7.5625*t*t)+e:t<2/2.75?i*(7.5625*(t-=1.5/2.75)*t+.75)+e:t<2.5/2.75?i*(7.5625*(t-=2.25/2.75)*t+.9375)+e:i*(7.5625*(t-=2.625/2.75)*t+.984375)+e}function U4(t,e,i,n){return i*(1-Math.pow(1-t/n,us.nonLinearity+1))+e}const G4=Object.freeze(Object.defineProperty({__proto__:null,ease:h4,easeInBack:O4,easeInCirc:L4,easeInCubic:m4,easeInElastic:z4,easeInExpo:E4,easeInOutBack:k4,easeInOutCirc:R4,easeInOutCubic:g4,easeInOutElastic:D4,easeInOutExpo:P4,easeInOutQuad:_4,easeInOutQuart:w4,easeInOutQuint:S4,easeInOutSine:T4,easeInQuad:u4,easeInQuart:v4,easeInQuint:b4,easeInSine:M4,easeOutBack:B4,easeOutBounce:N4,easeOutCirc:C4,easeOutCubic:p4,easeOutElastic:F4,easeOutExpo:A4,easeOutQuad:f4,easeOutQuart:y4,easeOutQuint:x4,easeOutSine:I4,inertia:U4,linear:c4},Symbol.toStringTag,{value:"Module"})),j4={easing:"easeInOutQuad",forceFinalValue:!0,renderAfterUpdate:!0};function Al(t,e){return e.tickers[t]}function Bt(t,e,i,n,s,o,r,a){let l;e.animationGroup&&(l=Object.keys(i.tickers).filter(c=>i.tickers[c].animationGroup===e.animationGroup)),i.tickers[t]={...j4,...e,from:n,to:s,duration:o,attributes:a,startTime:i.time,alreadyStartedGroupTickers:l,iterationCount:r}}function yt(t,e){delete e.tickers[t]}function Jf(t,e){return!!e.tickers[t]}function kt(t,e,i){var l;const n=i.tickers[t];if(!n)return;if(n.alreadyStartedGroupTickers&&n.alreadyStartedGroupTickers.some(c=>!!i.tickers[c])){n.startTime=i.time;return}let s=i.time-n.startTime;if(n.iterationCount>1){const c=s;s=c%n.duration,n.iterationCount!==1/0&&c>=n.duration*n.iterationCount&&(s=n.duration)}let o;if(n.from.length){o=[];for(let c=0;c<n.from.length;c++){const d=Fy(n.easing,n.from[c],n.to[c],n.duration,s);o.push(d)}}else o=Fy(n.easing,n.from,n.to,n.duration,s);let r=!1;s>=n.duration&&(n.forceFinalValue&&(o=n.to),r=!0),e.step&&e.step(i,o,n.attributes,r),r&&(e.keepFinished||yt(t,i),e.complete&&e.complete(i)),(typeof n.renderAfterUpdate=="function"?n.renderAfterUpdate():n.renderAfterUpdate)&&((l=n.attributes)!=null&&l.layerId?i.rerenderEvents.push({type:"layerAnimationTicker",layerId:n.attributes.layerId,styleId:n.attributes.styleId}):i.rerenderEvents.push({type:"coreAnimationTicker"}))}function Fy(t,e,i,n,s){return G4[t](s,e,i-e,n)}let V4=0;class Qf{constructor(e,i){this.isDestroyed=!1,this.id=V4++,this.ids=i,this.tickerName=`tile-fade-${e}-${this.id}`,this.readiness=1,this.needSync=!1,this.modelMatrices=new Map,this.coords=[0,0,0,0],this.bounds=new Map,this.mvpMatrices=new Map,this.demMatrices=new Map,this.flatMapTexMatrices=new Map,this.purpose=e,this.buffers=[],this.children=[],this.identifyChildren=[],this.depthTestChildren=[],this.shadowChildren=[],this.labelTestChildren=[]}get destroyed(){return this.isDestroyed}get empty(){return this.children.length===0}updateMvpMatrix(e,i,n){this.modelMatrices.forEach((s,o)=>{const r=this.mvpMatrices.get(o)??new Float32Array(16);if(Us(r,e,s),this.mvpMatrices.set(o,r),i){const a=this.demMatrices.get(o)??new Float32Array(16);Us(a,i,s),this.demMatrices.set(o,a)}if(n){const a=this.flatMapTexMatrices.get(o)??new Float32Array(16);Us(a,n,s),this.flatMapTexMatrices.set(o,a)}})}setMvpMatrix(e){this.modelMatrices.forEach((i,n)=>{this.mvpMatrices.set(n,new Float32Array(e))})}clean(e){for(const i of this.buffers)i.remove();this.buffers=[],this.children=[],this.labelTestChildren=[],this.identifyChildren=[],this.depthTestChildren=[],this.shadowChildren=[],yt(this.tickerName,e),this.isDestroyed=!0}updateTicker(e){kt(this.tickerName,{step:(i,n)=>{this.readiness=n}},e)}startTicker(e,i,n,s,o){Bt(this.tickerName,{easing:i},e,s,o,n,1)}tickerFinished(e){return!Jf(this.tickerName,e)}push(e){const i=e.layerSettings;i.identify?this.identifyChildren.push(e):i.depthTest?this.depthTestChildren.push(e):i.labelTest?e.sink==="raster"&&e.symbol==="point"&&this.labelTestChildren.push(e):i.shadow?this.shadowChildren.push(e):this.children.push(e)}pushBuffer(e){this.buffers.push(e)}}class Ct extends Qf{constructor(e,i,n,s,o=[0,0,0,0],r,a,l){super(e,a),this.objectsMap={},this.floorObjectsMap={},this.dynamicObject=r,this.sourceId=l,Ry(n,i,this,a),this.setTileCoords(o,s)}setTileCoords(e,i){const n=e[2],s=e[3],o=Mt(n);this.coords=e,this.size=o,this.zoomLevel=n,this.detailLevel=s,this.mvpMatrices.clear(),this.demMatrices.clear(),this.flatMapTexMatrices.clear(),this.syncReplicas(i)}syncReplicas(e){let i=[...e.visibleMapReplicas];if(this.purpose==="globe"){const{center:o}=e,r=Mt(this.coords[2]),a=Math.trunc((2**31+o[0])/r);i=[Math.round((a-this.coords[0])/2**this.coords[2])]}if(this.dynamicObject&&this.dynamicObject.isOutOfMainReplica()){const o=i[0],r=i[i.length-1];i.push(o-1,r+1)}const n=$/xe*this.size,s=Math.pow(2,this.coords[2]);this.bounds.clear(),this.modelMatrices.clear(),i.forEach(o=>{const r=[this.coords[0]+o*s,this.coords[1],this.coords[2],this.coords[3]],a=Wi(r);this.bounds.set(o,{min:[a[0],a[1]],max:[a[0]+this.size,a[1]+this.size]});const l=Gi();En(l,[a[0]-n,a[1]-n,0],at(this.size/Nn,this.size/Nn,No/Nn)),this.modelMatrices.set(o,l)}),this.needSync=!1}updateObjVisibility(e,i,n){const s=n?this.floorObjectsMap[e]:this.objectsMap[e];if(!s)return!1;let o=!1;return s.forEach((r,a)=>{const c=a[0].getBuffer("a_float_visibility").getData();if(!(c instanceof Uint8Array))return;let d=!1;for(const{offset:h,size:u}of r)if(c[h]!==i){for(let f=h;f<h+u;++f)c[f]=i;d=!0}if(d){a[0].rewriteData("a_float_visibility");for(const h of a)h.isDirty=!0;o=!0}}),o}clean(e){for(const i in this.objectsMap)this.objectsMap[i].forEach((n,s)=>{s.forEach(o=>{o.unbind(),o.remove()})});for(const i in this.floorObjectsMap)this.floorObjectsMap[i].forEach((n,s)=>{s.forEach(o=>{o.unbind(),o.remove()})});super.clean(e)}}var pn=(t=>(t[t.Stationary=0]="Stationary",t[t.ZoomingIn=1]="ZoomingIn",t[t.ZoomingOut=2]="ZoomingOut",t))(pn||{}),gn=(t=>(t[t.ByOne=0]="ByOne",t[t.WaitingLayer=1]="WaitingLayer",t[t.GlobalWaiting=2]="GlobalWaiting",t))(gn||{});function H4(t,e,i){return{key:e,labelsKey:`${t.labelsKey}_${e}`,useful:!0,ready:!1,needGenerate:!1,tile:t,status:0,params:i.clone()}}function Dy(t,e,i){t.generatedData=e,i&&t.params.setTileIds(i)}function Oy(t){const e=t.generatedData,i=[];if(!e)return i;for(let n=0;n<e.length;n++){const s=e[n];s.collectorOutput.labels&&i.push({metatileHash:s.metatileHash,labels:s.collectorOutput.labels,styleId:s.styleId})}return i}function e_(t,e){t.status=0,t.generatedData=void 0,t.objects!==void 0&&t.objects.forEach(i=>i.clean(e)),t.objects=void 0,t.ready=!1,t.tile.currentMod===t&&(t.tile.currentMod=void 0)}function By(t){return t.status===0}function ky(t,e,i,n,s){switch(t.status){case 0:t.useful&&(t.status=1);break;case 1:t.useful?t.tile.serverMetadata&&(t.status=2):t.status=0;break;case 2:Z4(t,i,n)&&(t.status=3,t.needGenerate=!0);break;case 3:t.generatedData&&(t.status=4,t.ready=!0,t.objects=t.generatedData.map(o=>{const{collectorOutput:{data:r}}=o;return new Ct(t.tile.type,r,n,i,t.tile.coords,void 0,s,t.tile.sourceId)}),e.add(t.key,t));break}}function Z4(t,e,i){switch(t.tile.type){case"zenith":return!!(t.useful&&t.tile.serverMetadata&&$4(t.tile.serverMetadata,e,i));case"traffic":return!!(t.useful&&t.tile.serverMetadata);case"raster":case"geojson":case"globe":case"dem":return!!t.useful;default:return!1}}function $4(t,e,i){const{assetManager:n,modelLayer:s}=i;for(let o=0;o<t.length;o++){const{regionId:r,metatileHash:a}=t[o];if(!n.getMetatile(a)||e.styleZoom>Kh&&!s.isModelsInfoLoaded(r))return!1}return!0}class Pl{constructor(e,i,n,s,o){this.selectedIds=e.slice(),this.styleState={...i},this.tileRevision=n,this.styleRevision=o,this.styleId=s}static equal(e,i){return e.tileRevision===i.tileRevision&&e.styleId===i.styleId&&e.styleRevision===i.styleRevision&&go(e.getSelectedIds(),i.getSelectedIds())&&go(e.styleState,i.styleState)}clone(){return new Pl(this.selectedIds,this.styleState,this.tileRevision,this.styleId,this.styleRevision)}stringify(){const e=this.selectedIds.join("|");return`sId=${this.styleId}_sRev=${this.styleRevision}_tRev=${this.tileRevision}_sel=${e}_sSt=${JSON.stringify(this.styleState)}`}getSelectedIds(){return this.tileIds?this.selectedIds.filter(e=>{var i;return(i=this.tileIds)==null?void 0:i.has(e)}):this.selectedIds.slice()}setTileIds(e){this.tileIds=e}}var mr=(t=>(t[t.Initial=0]="Initial",t[t.Loading=1]="Loading",t[t.Loaded=2]="Loaded",t))(mr||{});function W4(t,e,i,n){return{type:t,sourceId:i,key:Ce(e),labelsKey:`${t}_${i}_${n}`,coords:e,zoomLevel:e[2],detailLevel:e[3],needFetch:!1,revision:0,needAbortFetch:!1,needGenerate:!1,status:0,oldHoverTileObjects:[]}}function Ny(t,e,i,n,s,o){const r=[];if(i.oldHoverTileObjects.forEach(a=>{a.tickerFinished(e)?(t.tileManager.removeObject(a),a.clean(e)):r.push(a)}),i.oldHoverTileObjects=r,s===void 0){t_(t,i,e);return}e.performanceCaveatEmitted||(o||!i.hover||i.hover.id===s)&&Y4(t,e,i,s,n)}function X4(t,e){const i=Math.min(Math.floor(t.styleZoom),Xe.maxDetailLevel),n=e.coords[3];return i===n}function Y4(t,e,i,n,s){if(!i.idSet||!i.idSet.has(n)||!X4(e,i)){t_(t,i,e);return}const o=t.identifier.getIdScope(mn);o.isHidden(n,Qi.PolygonExtrusion)||q4(t,i,n,s).then(r=>{t_(t,i,e);const a={id:n,tileObjects:[],generatedData:[]},l=[];r.results.forEach(c=>{const d=new Ct("hover",c.collectorOutput.data,t,e,i.coords,void 0,o),{packedRasters:h,rastersToLoad:u}=c.collectorOutput;h!==void 0&&t.assetManager.prepareRasters(c.styleId,h),t.assetManager.loadRasters(u),a.tileObjects.push(d),t.tileManager.addObject(d),d.startTicker(e,ja.inAnimationType,ja.inAnimationTime,0,1),c.collectorOutput.labels.length&&l.push({metatileHash:c.metatileHash,labels:c.collectorOutput.labels,styleId:c.styleId})}),a.generatedData=r.results,t.labeler.addLabels("label_hover",Eo.Tile,l),t.identifier.debouncedFillCache(),i.hover=a})}function t_(t,e,i){e.hover&&(e.hover.tileObjects.forEach(n=>{e.oldHoverTileObjects.push(n),n.startTicker(i,ja.outAnimationType,ja.outAnimationTime,1,0)}),e.hover=void 0,t.labeler.removeLabels("label_hover"),t.identifier.debouncedFillCache())}function q4(t,e,i,n){const s=e.newMod||e.currentMod,o=(s==null?void 0:s.params.getSelectedIds())||[],r=t.map.state;return t.defaultSource.generateHoverTile(r,e.coords,r.handyStyleId,o,self.devicePixelRatio,{},i,n)}function Uy(t){if(t.newMod&&t.newMod.needGenerate)return t.newMod.needGenerate=!1,t.newMod}function K4(t){return(!t.currentMod||By(t.currentMod))&&(!t.newMod||By(t.newMod))}function J4(t,e){t.currentMod&&e_(t.currentMod,e),t.newMod&&e_(t.newMod,e)}function Q4(t){t.currentMod=void 0}function gd(t){if(t.currentMod&&t.currentMod.useful)return t.currentMod;if(t.newMod&&t.newMod.useful)return t.newMod}function e3(t){t.currentMod&&(t.currentMod.useful=!1),t.newMod&&(t.newMod.useful=!1)}function t3(t,e,i){if(t.idSet&&e.setTileIds(t.idSet),!t.currentMod&&!t.newMod){i_(t,e,i);return}if(t.currentMod&&Pl.equal(t.currentMod.params,e)){t.currentMod.useful=!0,t.newMod=void 0;return}if(t.newMod){Pl.equal(t.newMod.params,e)?t.newMod.useful=!0:i_(t,e,i);return}i_(t,e,i)}function i_(t,e,i){const n=AS(t.coords,e),s=i.get(n);s?(t.newMod=s,t.newMod.useful=!0):(t.newMod=H4(t,n,e),t.idSet&&t.newMod.params.setTileIds(t.idSet))}function i3(t,e,i,n,s){switch(t.status){case 0:t.newMod&&t.newMod.useful&&(t.status=1,t.needFetch=!0);break;case 1:t.newMod&&t.newMod.useful?t.serverMetadata&&(t.status=2):(t.status=0,t.needAbortFetch=!0);break}t.currentMod&&ky(t.currentMod,e,i,n,s),t.newMod&&(ky(t.newMod,e,i,n,s),t.newMod.needGenerate&&(t.needGenerate=!0))}function n3(t){t.newMod&&t.newMod.ready&&(t.currentMod=t.newMod,t.newMod=void 0)}function s3(t){const e=new Set;return t.forEach(i=>{const{idBuffer:n,orphanIds:s}=i.collectorOutput.identifyIds;for(const o of n)e.add(o);for(const o of s)e.add(o)}),e}function o3(t){t.status===1&&(t.needAbortFetch=!0),t.status=0,t.serverMetadata=void 0,t.revision++}function r3(t){t.revision++}const a3=()=>{};class Gy{constructor(e,i=a3){this.queue=[],this.data={},this.size=e,this.onRemove=i}add(e,i){this.data[e]||(this.queue.push(e),this.data[e]=i,this.shrink(this.size))}remove(e){this.data[e]&&(this.queue.splice(this.queue.indexOf(e),1),delete this.data[e])}get(e){const i=this.data[e];return i&&(this.queue.splice(this.queue.indexOf(e),1),this.queue.push(e)),i}reset(){this.shrink(0)}setSize(e){this.size=e,this.shrink(e)}getSize(){return this.size}keys(){return this.queue}getData(){return Object.keys(this.data).map(e=>this.data[e])}shrink(e){for(;this.queue.length>e;){const i=this.queue.shift(),n=this.data[i];delete this.data[i],this.onRemove(i,n)}}}function wa(t){const e=t.viewportTiles;for(const i in t.tiles)e3(t.tiles[i]);for(let i=0;i<e.length;i++){const n=e[i];let s=t.tiles[n];s||(s=t.tiles[n]=W4(t.type,zu(n),t.sourceId,t.tileLayerId));const o=new Pl(t.selectedIds,t.styleState,s.revision,t.styleId,t.styleRevision);t3(s,o,t.tileModsCache)}}function n_(t,e){for(let i=0;i<e.length;i++){const n=t[e[i]],s=gd(n);if(!s||!s.ready)return!1}return!0}function jy(t){const e=[];for(const i in t.tiles){const n=t.tiles[i];n.needFetch&&(n.needFetch=!1,e.push(n))}return e}function Vy(t){const e=[];for(const i in t.tiles){const n=t.tiles[i];n.needAbortFetch&&(n.needAbortFetch=!1,e.push(n))}return e}function Hy(t){const e=[];for(const i in t.tiles){const n=t.tiles[i];n.needGenerate&&(n.needGenerate=!1,e.push(n))}return e}function Zy(t){const e=new Set(t.viewportTiles),i=new Set(t.tileModsCache.getData().map(s=>s.tile)),n=[];for(const s in t.tiles){const o=t.tiles[s];K4(o)&&!e.has(s)&&t.zoomDirection===pn.Stationary&&!i.has(o)&&n.push(o)}return n}function $y(t,e,i,n,s,o,r,a,l,c,d=0,h=!1){return{type:t,sourceId:e,tileLayerId:i,styleId:l.handyStyleId,styleRevision:a.styleManager.getStyleRevision(l.handyStyleId),styleState:l.styleState,minZoomLevel:n,maxZoomLevel:s,minDetailLevel:o,maxDetailLevel:r,tiles:{},viewportTiles:[],zoomLevel:Wy(t,l.zoom,l.styleZoom),zoomDirection:pn.Stationary,zoomStartZoom:0,tileModsCache:new Gy(0,(u,f)=>{var m;a.labeler.removeLabels(f.labelsKey),(m=f.objects)==null||m.forEach(p=>a.tileManager.removeObject(p)),e_(f,l)}),tileModsCacheMaxCount:0,selectedIds:[],displayedMods:{},tilesAppearance:gn.ByOne,mapState:l,stopLabelAnimation:!1,viewportPadding:d,displayStats:{matched:0,shifted:0,parent:0,children:0},requestOddTiles:h,ids:c}}function Wy(t,e,i){return t==="raster"?Math.round(e):Math.floor(i)}function Ll(t){for(const e in t.tiles)J4(t.tiles[e],t.mapState);t.tiles={},t.viewportTiles=[],t.zoomDirection=pn.Stationary,t.tileModsCache.reset(),t.displayedMods={},t.tilesAppearance=gn.ByOne}function Xy(t,e,i,n,s=!1){const{tileManager:o,renderer:r}=t,a=i.displayedMods,l=dg(a,n);l.forEach(h=>{if(h.objects!==void 0){let u=!s;for(const f in n)if(VS(h.tile,n[f].tile)){u=!1;break}h.objects.forEach(f=>{o.addObject(f),u&&f.startTicker(e,Qh.type,Qh.time,0,1)})}});const c=dg(n,a);c.forEach(h=>{var u;h.objects!==void 0&&(h.objects.forEach(f=>{o.removeObject(f)}),(u=h.tile.hover)==null||u.tileObjects.forEach(f=>o.removeObject(f)))});const d=l.length>0||c.length>0;return d&&(e.needLabeling=!0,r.addRerenderEvent()),d}function s_(t){t.viewportTiles.forEach(e=>n3(t.tiles[e]))}function l3(t){switch(t){case"geojson":return 3;case"raster":return 1/0}return 2}function Cl(t,e,i){c3(t,e.styleZoom,e.zoom),d3(t,e,i),h3(t),wa(t)}function c3(t,e,i){const n=Wy(t.type,i,e),s=n-t.zoomLevel;t.zoomDirection===pn.Stationary&&(s>0?(t.zoomDirection=pn.ZoomingIn,t.zoomStartZoom=t.zoomLevel):s<0&&(t.zoomDirection=pn.ZoomingOut,t.zoomStartZoom=t.zoomLevel)),t.zoomLevel=n}function d3(t,e,i){if(t.zoomLevel<t.minZoomLevel){t.viewportTiles=[];return}const n=Be(t.zoomLevel,t.minZoomLevel,t.maxZoomLevel),s=Be(t.zoomLevel,t.minDetailLevel,t.maxDetailLevel);switch(t.type){case"globe":t.viewportTiles=Og(e,n,t.minZoomLevel).map(Ce);break;default:t.viewportTiles=Du(e,i,n,t.minZoomLevel,s,t.viewportPadding,t.maxZoomLevel,t.requestOddTiles).map(Ce),e.stats.foundVisibleTilesCount=t.viewportTiles.length}}function h3(t){const e=Math.round((Object.keys(t.displayedMods).length+t.viewportTiles.length)*Xe.cacheRatio);t.tileModsCacheMaxCount<e&&(t.tileModsCacheMaxCount=e),e>t.tileModsCacheMaxCount/2&&t.tileModsCache.setSize(e)}function u3(t,e,i,n,s,o,r){const a=g3(t),l={},c=new Set,d=h=>qy(h,i);for(const h of e){const u=a[h];if(u){vd(l,u),o.matched++;continue}const f=t[h],m=Yy(f,a,1)||Yy(f,a,-1);if(m){o.shifted++,vd(l,m);continue}const p=f3(f,a,n,s,r);if(p){o.parent++,vd(l,p),c.add(p);continue}const _=Ug(a,f,d);for(const g of _)o.children++,vd(l,g)}return p3(l,c,t),l}function Yy(t,e,i){const{coords:n}=t,s=i>0?Math.min(n[3]+i,32):32,o=i<0?Math.max(n[3]+i,0):0;for(let r=n[3]+i;r>=o&&r<=s;r+=i){const a=Ce([n[0],n[1],n[2],r]),l=e[a];if(l)return l}}function f3(t,e,i,n,s){for(let r=t.detailLevel-1;r>=i;r--){const a=Bu(e,t,r,n);if(a)return a}const o=i;for(let r=t.zoomLevel;r>=o;r--){const a=Bu(e,t,t.detailLevel,r);if(a)return a}if(s)for(let r=t.zoomLevel;r>=o;r--)for(let a=t.detailLevel;a>=i;a--){const l=Bu(e,t,a,r);if(l)return l}return null}function _3(t){const e=t.currentMod;return e===void 0?!1:e.ready}function qy(t,e){const i=t.currentMod;return i===void 0?!1:e[i.key]!==void 0}function vd(t,e){const i=e.currentMod;t[i.key]=i}function m3(t,e){const i=e.currentMod;i!==void 0&&delete t[i.key]}function p3(t,e,i){const n=s=>qy(s,t);for(const s of e){const o=Ug(i,s,n);for(const r of o)m3(t,r)}}function g3(t){const e={};for(const i in t){const n=t[i];_3(n)&&(e[i]=n)}return e}function Ky(t,e,i){v3(t,e,i),y3(t),w3(t,e.globeMode);for(const n in t.displayedMods)t.tileModsCache.get(n);b3(t),x3(t)}function v3(t,e,i){for(const n in t.tiles)i3(t.tiles[n],t.tileModsCache,e,i,t.ids)}function y3(t){switch(t.tilesAppearance){case gn.ByOne:s_(t);break;case gn.WaitingLayer:n_(t.tiles,t.viewportTiles)&&(t.tilesAppearance=gn.ByOne,s_(t));break;case gn.GlobalWaiting:break}}function w3(t,e){const{tiles:i,viewportTiles:n,displayedMods:s,minZoomLevel:o,maxZoomLevel:r,displayStats:a}=t;t.displayedMods=u3(i,n,s,o,r,a,e)}function b3({tiles:t,displayedMods:e,viewportTiles:i}){for(const n in t){if(i.includes(n))continue;const s=t[n],o=s.currentMod;o&&!e[o.key]&&Q4(s)}}function x3(t){switch(t.zoomDirection){case pn.ZoomingIn:(t.zoomLevel<=t.zoomStartZoom||Jy(t))&&(t.zoomDirection=pn.Stationary,t.zoomStartZoom=t.zoomLevel);break;case pn.ZoomingOut:(t.zoomLevel>=t.zoomStartZoom||Jy(t))&&(t.zoomDirection=pn.Stationary,t.zoomStartZoom=t.zoomLevel);break}}function Jy(t){const{tiles:e,viewportTiles:i,displayedMods:n}=t;for(let s=0;s<i.length;s++){const o=e[i[s]],r=gd(o);if(!r||n[r.key]===void 0)return!1}return!0}function S3(t,e,i,n){var s;i.selectedIds=n,i.tilesAppearance=gn.WaitingLayer,wa(i);for(const o in i.tiles){const r=i.tiles[o];Ny(t,e,r,i.sourceId,(s=r.hover)==null?void 0:s.id,!0)}}function Qy(t,e,i,n){if(!e.disableHoverStyles){for(const s in i.tiles){const o=i.tiles[s];Ny(t,e,o,i.sourceId,n)}t.labeler.disableThrottleUpdateOnce()}}function M3(t,e){t.styleState=e,wa(t)}function e0(t,e,i,n){n?t.tilesAppearance=gn.ByOne:t.tilesAppearance=gn.GlobalWaiting,t.styleId=e,t.styleRevision=i,wa(t)}function t0(t){t.tilesAppearance=gn.ByOne,s_(t)}function I3(t){t.tilesAppearance=gn.WaitingLayer,t.stopLabelAnimation=!0,Object.keys(t.tiles).forEach(e=>{o3(t.tiles[e])}),wa(t)}function T3(t){t.tilesAppearance=gn.WaitingLayer,Object.keys(t.tiles).forEach(e=>{r3(t.tiles[e])}),wa(t)}function E3(t,e,i){for(const n of t.viewportTiles){const s=t.tiles[n],o=gd(s);if(!o)continue;const r=Oy(o);if(r.length===0)continue;const a=e.getLabelsDemKey(r);o.demKey!==a&&(o.demKey=a,i.addTileLabels(o.labelsKey,Eo.Tile,r))}}function Rl(t){return{_src:t.memSizeJs()}}function yd(t){return{_texture:t.memSizeGPU()}}function i0(t){return{[String(t.purpose)]:{_initData:t.memSizeJs()}}}function A3(t){return{[String(t.purpose)]:{_glBuffer:t.memSizeGPU()}}}function wd(t){var i;const e={};return t.generatedData&&(e.generatedData={collectorOutput:(i=t.generatedData)==null?void 0:i.map(n=>C3(n.collectorOutput))}),t.objects&&(e.objects=t.objects.map(n=>n0(n))),e}function bd(t){return{objects:t.objects?t.objects.map(e=>o_(e)):0}}function n0(t){return{buffers:t.buffers.map(i0)}}function o_(t){return{children:t.children.map(e=>({[`${e.symbol}_${e.sink}`]:(e.instanceCount??e.count)*El(e.symbol,e.sink)})),buffers:t.buffers.filter(e=>e.purpose!=="attributes"&&e.purpose!=="instanced").map(e=>({[String(e.purpose)]:e.byteLength}))}}function P3(t){return{buffers:t.buffers.filter(e=>e instanceof R).map(i0).filter(e=>e._initData),textures:t.textures.map(Rl)}}function L3(t){return{buffers:t.buffers.filter(e=>e instanceof R).map(A3),textures:t.textures.map(Rl)}}function ui(t){if(typeof t=="number")return t;let e=0;if(Array.isArray(t))for(const i of t)e+=ui(i);else for(const i in t){const n=t[i];typeof n=="number"?e+=n:e+=ui(n)}return e}function C3(t){return{data:t.data.reduce((i,n)=>(i[`${n.symbol}_${n.sink}`]=n.buffer.byteLength,i),{}),identifyIds:{centerBuffer:t.identifyIds.centerBuffer.byteLength,instanceIdBuffer:t.identifyIds.instanceIdBuffer.byteLength,layerIdBuffer:t.identifyIds.layerIdBuffer.byteLength,objectClassBuffer:t.identifyIds.objectClassBuffer.byteLength,phaseBuffer:t.identifyIds.phaseBuffer.byteLength,styleIdBuffer:t.identifyIds.styleIdBuffer.byteLength,sublayerBuffer:t.identifyIds.sublayerBuffer.byteLength}}}async function s0(t){return{defaultSource:t.defaultSource.getMemoryFootprint(),tileManager:t.tileManager.getMemoryFootprint(e=>!t.defaultSource.hasLayer(e)),identifier:t.identifier.getMemoryFootprint(),assetManager:t.assetManager.getMemoryFootprint(),trafficTileLayer:t.trafficTileLayer.getMemoryFootprint(),imageManager:t.imageManager.getMemoryFootprint(),parserThread:await t.workers.parser.getMemoryFootprint(),labelingThread:await t.workers.labeling.getMemoryFootprint(),renderer:t.renderer.getMemoryFootprint(),labeler:t.labeler.getMemoryFootprint(),postEffectsManager:t.postEffectsManager.getMemoryFootprint(),shadowManager:t.shadowManager.getMemoryFootprint()}}class os{constructor(e,i,n,s,o,r,a,l={}){this.disabledRegions=null,this.generatingCount=0,this.tilesGenerationQueue=[],this.disableTilesAnimation=!1,this.idsToUpdate=new Set,this.destroyed=!1,l=Object.assign({viewportPadding:0,disableTilesAnimation:!1,requestOddTiles:!1},l),this.ids=o.identifier.getIdScope(l.idScope??mn),this.ids.registerTileLayer(this),this.modules=o,this.mapState=r,this.prevStyleState=r.styleState,this.sourceCore=a,this.id=Vn(),this.disableTilesAnimation=!!l.disableTilesAnimation,this.gridState=$y(a.type,a.id,this.id,e,i,n,s,o,this.mapState,this.ids,l.viewportPadding,l.requestOddTiles),this.maxGeneratingCount=l3(a.type)}memSizeJs(){const e=this.gridState;return{gridState:{displayedMods:Object.keys(e.displayedMods).map(i=>wd(e.displayedMods[i])),tileModsCache:e.tileModsCache.keys().filter(i=>!e.displayedMods[i]).map(i=>wd(e.tileModsCache.get(i)))}}}memSizeGpu(){const e=this.gridState;return{gridState:{displayedMods:Object.keys(e.displayedMods).map(i=>bd(e.displayedMods[i])),tileModsCache:e.tileModsCache.keys().filter(i=>!e.displayedMods[i]).map(i=>bd(e.tileModsCache.get(i)))}}}destroy(){this.destroyed=!0,Ll(this.gridState),this.modules.modelsScene.clearSourceTileMapBySource(this.sourceCore.id),this.ids.unregisterTileLayer(this)}redraw(){Ll(this.gridState),this.modules.modelsScene.clearSourceTileMapBySource(this.sourceCore.id),Cl(this.gridState,this.mapState,this.modules)}getZoomDirection(){return this.gridState.zoomDirection}getDisplayedTileObjects(){const e=[];for(const i in this.gridState.displayedMods){const n=this.gridState.displayedMods[i];n.objects&&e.push(...n.objects)}return e}getDisplayedIdentifyData(){var i,n;const e=[];for(const s in this.gridState.displayedMods){const o=this.gridState.displayedMods[s];(n=o.generatedData)==null||n.concat(((i=o.tile.hover)==null?void 0:i.generatedData)||[]).forEach(r=>e.push({ids:r.collectorOutput.identifyIds,metatileHash:r.metatileHash,sourceId:o.tile.sourceId,tileKey:o.tile.key}))}return e}getLabelingData(){const e={sourceId:this.gridState.sourceId,animate:!this.gridState.stopLabelAnimation,labelsKeys:[]};for(const i in this.gridState.displayedMods){const n=this.gridState.displayedMods[i];e.labelsKeys.push(n.labelsKey)}return this.gridState.stopLabelAnimation&&this.viewportTilesReady()&&(this.gridState.stopLabelAnimation=!1),e}getViewportTiles(){const e=[],i=this.gridState.viewportTiles;for(let n=0;n<i.length;n++){const s=this.gridState.tiles[i[n]];s&&e.push(s)}return e}viewportTilesReady(){return n_(this.gridState.tiles,this.gridState.viewportTiles)}isEmpty(){return this.gridState.viewportTiles.length===0}displayedTilesAnimationFinished(){for(const e in this.gridState.displayedMods){const i=this.gridState.displayedMods[e];if(i.objects){for(const n of i.objects)if(!n.tickerFinished(this.mapState))return!1}}return!0}activateStyleUpdating(){e0(this.gridState,this.mapState.handyStyleId,this.modules.styleManager.getStyleRevision(this.mapState.handyStyleId),this.modules.map.core.getIsFirstStyleUpdate())}finishStyleUpdating(){t0(this.gridState)}setSelectedIds(e){S3(this.modules,this.mapState,this.gridState,e)}setHoverId(e){Qy(this.modules,this.mapState,this.gridState,e)}resetHoverId(){Qy(this.modules,this.mapState,this.gridState)}onSourceDataChange(){I3(this.gridState)}onFeatureStateMapChange(){T3(this.gridState)}getTileCount(){let e=0;for(const i in this.gridState.displayedMods){const n=this.gridState.displayedMods[i].objects;n!==void 0&&(e+=n.length)}return e}isBlank(){for(const e of this.gridState.viewportTiles){const i=this.gridState.tiles[e],{serverMetadata:n}=i;if(n===void 0||n.length===0)continue;const s=gd(i);if(s&&s.ready)return!1}return!0}updateViewport(){Cl(this.gridState,this.mapState,this.modules)}update(){this.mapState.needReplicasUpdate&&this.setModObjectsSyncNecessity();const e={...this.gridState.displayedMods};this.mapState.styleState!==this.prevStyleState&&M3(this.gridState,this.mapState.styleState),Ky(this.gridState,this.mapState,this.modules);const{demManager:i,labeler:n}=this.modules;E3(this.gridState,i,n),this.fetch(jy(this.gridState)),this.abortFetch(Vy(this.gridState)),this.generate(Hy(this.gridState)),this.clearTiles(Zy(this.gridState)),Xy(this.modules,this.mapState,this.gridState,e,this.disableTilesAnimation),this.updateVisibility()}pushIdsToUpdate(e){e.forEach(i=>this.idsToUpdate.add(i))}getSourceType(){return this.sourceCore.type}fetch(e){e.sort((i,n)=>Yr(this.mapState.center,i,n)).forEach(i=>{this.sourceCore.fetchTile(i.coords,this.mapState).then(n=>{i.status===mr.Loading&&(i.serverMetadata=n)})})}abortFetch(e){e.forEach(i=>this.sourceCore.abortTileFetch(i.coords))}updateGenerationQueue(){if(this.destroyed||this.generatingCount>this.maxGeneratingCount)return;const e=this.getTileToGenerate();if(!e)return;++this.generatingCount;const{tile:i,mod:n}=e,s={tileCoords:i.coords,selectedIds:n.params.getSelectedIds(),styleId:n.params.styleId},o=this.disabledRegions,r={areTileBoundsVisible:this.mapState.showDefaultTileBounds};this.sourceCore.generateTile(this.mapState,s.tileCoords,s.styleId,s.selectedIds,devicePixelRatio,r).then(a=>{if(!a){tv(this.sourceCore.type);return}if(!Array.isArray(a.results))return;let{results:l}=a;o&&(l=l.filter(d=>!o.includes(d.regionId)));const c=new Map;if(l.forEach(d=>{d.collectorOutput.data.forEach(h=>{h.symbol!=="gltfModel"||h.sink!=="instances"||h.generatedObjects.forEach(u=>{var g;const f=ss.sinks.instances.unpackObjectAttributes(u.attributes),m=(g=u.meta)==null?void 0:g.childrenIds,p=f.parentId;if(!m||!p)return;let _=c.get(p);_||(_=new Set,c.set(p,_));for(const y of m)_.add(y)})})}),c.size){const d=Ce(s.tileCoords);this.ids.updateParentChildrenData(d,c)}l.forEach(d=>{const{styleId:h,metatileHash:u,regionId:f,collectorOutput:m}=d,{packedRasters:p,rastersToLoad:_,floorHidingMap:g,dataModelsUrls:y}=m;p!==void 0&&this.modules.assetManager.prepareRasters(h,p),this.modules.assetManager.fillDataModelUrlMap(y),this.modules.assetManager.loadRasters(_),this.modules.floorManager.prepareFloors(f,u,g,this.sourceCore.type)}),i.idSet=s3(l),Dy(n,l,i.idSet),this.modules.labeler.addTileLabels(n.labelsKey,Eo.Tile,Oy(n))}).finally(()=>{this.generatingCount=this.generatingCount-1,this.updateGenerationQueue()})}getTileToGenerate(){this.tilesGenerationQueue.sort((i,n)=>Yr(this.mapState.center,i,n));let e=this.tilesGenerationQueue.shift();for(;e;){const i=Uy(e);if(i){if(i.useful)return{mod:i,tile:e};e.newMod=void 0}e=this.tilesGenerationQueue.shift()}return null}addTileToGenerationQueue(e){this.tilesGenerationQueue.push(e),this.updateGenerationQueue()}generate(e){e.sort((i,n)=>Yr(this.mapState.center,i,n)).forEach(i=>{var n;(n=i.newMod)!=null&&n.needGenerate&&!this.tilesGenerationQueue.includes(i)&&this.addTileToGenerationQueue(i)})}clearTiles(e){if(!e.length)return;const i=[];this.modules.modelsScene.clearSourceTileMapByTiles(this.sourceCore.id,e);for(const n of e)this.sourceCore.deleteTile(n.coords),i.push(n.key),delete this.gridState.tiles[n.key];this.ids.removeParentChildrenData(i)}updateVisibility(){if(this.idsToUpdate.size===0)return;const e=[];this.gridState.tileModsCache.getData().forEach(n=>{n.objects&&n.objects.forEach(s=>{e.push(s)})}),e.length!==0&&this.updateObjectsVisibility(e)}updateObjectsVisibility(e){let i=!1;for(const n of this.idsToUpdate){const s=+!this.ids.isHidden(n,Qi.PolygonExtrusion),o=+!this.ids.isHidden(n,Qi.FloorPolygons);for(const r of e)r.updateObjVisibility(n,s,!1)&&(i=!0),r.updateObjVisibility(n,o,!0)&&(i=!0)}this.idsToUpdate.clear(),i&&(this.modules.renderer.addRerenderEvent(),this.modules.identifier.debouncedFillCache())}setModObjectsSyncNecessity(){this.gridState.tileModsCache.getData().forEach(i=>{var n;(n=i.objects)==null||n.forEach(s=>{s.needSync=!0})})}}class zl{constructor(e=0){this.index=e,this.keysMap={}}getIndex(){const e=this.index;return this.index+=1,e}getUniqueIndex(e){return this.keysMap[e]===void 0&&(this.keysMap[e]=this.index,this.index+=1),this.keysMap[e]}getIndexedKeys(){return this.keysMap}}function R3(t){const e=z3(t),{groups:i,table:n}=F3(e),s={};for(let r=0;r<n.length;r++){const a=n[r],l=i[r];s[l]={};for(let c=0;c<a.length;c++){const d=i[c];s[l][d]=n[r][c]}}const o=i.reduce((r,a,l)=>(r[a]=l,r),{});return{indexToGroup:i,groupToIndex:o,table:s}}function z3(t){const e=(t.groups||[]).concat(Qu.groups).reduce((n,s)=>(n.includes(s)||n.push(s),n),[]),i=(t.overlay||[]).concat(Qu.overlay).concat(e.reduce((n,s)=>(s===To||s===ar||s===Ju||n.push([s,ar]),n),[])).reduce((n,s)=>{const o=[];for(const r of s)e.includes(r)&&o.push(r);return o.length>1&&n.push(o),s.length===1&&o.length===1&&n.push(o),n},[]);return{groups:e,overlay:i,intersect:Qu.intersect}}function F3(t){const{groups:e,overlay:i,intersect:n}=t,s=e.reduce((r,a,l)=>(r[a]=l,r),{}),o=[];for(let r=0;r<e.length;r++){const a=[];for(let l=0;l<e.length;l++)a.push(!0);o.push(a)}for(let r=0;r<i.length;r++){const a=i[r];for(let l=0;l<a.length;l++)for(let c=l+1;c<a.length;c++){const d=s[a[l]],h=s[a[c]];o[d][h]=!1,o[h][d]=!1}}for(let r=0;r<n.length;r++){const a=n[r];for(let l=0;l<a.length;l++)for(let c=l+1;c<a.length;c++){const d=s[a[l]],h=s[a[c]];o[d][h]=!0,o[h][d]=!0}}return{groups:e,table:o}}const D3={db_id:"id",tech_db_beginning_is_cut:"beginningIsCut",tech_db_ending_is_cut:"endingIsCut",tech_db_previous_point_x:"previousPointX",tech_db_previous_point_y:"previousPointY",tech_db_next_point_x:"nextPointX",tech_db_next_point_y:"nextPointY",tech_db_object_length:"objectLength",tech_db_component_distance_start:"componentDistanceStart",tech_db_component_distance_end:"componentDistanceEnd",tech_db_geometry_type:"db_geometry_type"},O3=t=>D3[t]??t,B3={objectClass:"db_object_class",sublayer:"db_sublayer",db_id:"id"};function k3(t){return B3[t]??t}const N3={Class:"db_class",DisputePosition:"db_dispute_position",ObjectClass:"db_object_class",ParkingType:"db_parking_type",Sublayer:"db_sublayer",Subsublayer:"db_subsublayer",Icon:"db_icon",GeometryType:"db_geometry_type",ModelType:"db_model_type",RoadSupportTypes:"tech_db_road_support_type",RoadMarkingColorType:"db_road_marking_color_type",PoiCategory:"L1_Poi_category",RoadPart:"db_road_part",TriangulationMethod:"db_triangulation_method"},U3=t=>{t.enumerationValues=Object.keys(t.enumerationValues??{}).reduce((e,i)=>{const n=N3[i];return n&&(e[n]=t.enumerationValues[i]),e},{})};class o0{constructor(e,i,n){this.id=e,this.modules=i,this.options=n,this.type="zenith",this.worker=new i.workers.parser.ZenithSource,this.sourceAttrs=Cn(n.sourceAttributes??{},Tg),this.objectAttributes={},this.dataFilter=n.dataFilter}fetchTile(e,i){const{assetManager:n,map:s}=this.modules,o=this.constructTileUrl(e,i);return this.worker.fetchTile({tileUrl:o,coords:e}).catch(()=>Promise.resolve()).then(r=>{if(!r)return;const{metadata:a,err:l}=r;return a.forEach(c=>{const d=this.constructMetaTileUrl(c);n.loadMetatile(d,c.metatileHash,c.regionId),s.emit("tileload",{tileCoords:e,regionId:c.regionId}),i.shownRegionIds.add(c.regionId)}),(l==null?void 0:l.status)===403&&s.emit("invalidtilekey"),a})}async generateTile(e,i,n,s,o,r={},a,l=this.id,c){const d=await this.worker.generateTile({styleId:n,tileInfo:Ye(i),pixelRatio:o,selectedIds:s,styleState:e.styleState,floorsEnabled:e.floorsEnabled,sourceAttrs:this.sourceAttrs,hoverId:a,sourceId:l,isDefaultSource:this.options.isDefaultSource,modelsPath:this.options.modelsPath,promoteAttributes:this.options.promoteAttributes,promoteId:this.options.promoteId,isCustomZenithSource:!this.options.isDefaultSource,dataFilter:this.dataFilter,...r,modelShowHideEventsSublayers:e.modelShowHideEventsSublayers},c);return d.promotedAttrs&&(this.objectAttributes[Ce(i)]=d.promotedAttrs),d}getObjectAttributes(e,i){var n;return(n=this.objectAttributes[e])==null?void 0:n[i]}generateModel(e){return this.worker.generateModel(e)}abortTileFetch(e){this.worker.abortTileRequest(Ce(e))}deleteTile(e){this.objectAttributes[Ce(e)]=void 0,this.worker.deleteTile(Ce(e))}setAttributes(e){this.sourceAttrs=e}getAttributes(){return this.sourceAttrs}destroy(){this.worker.destroy(),this.sourceAttrs={},this.objectAttributes={}}setFeatureStateMap(e){this.worker.setFeatureStateMap(e)}setDataFilter(e){e?this.dataFilter=F(e,{precomputes:[]},wi.Generator):this.dataFilter=void 0}constructTileUrl(e,i){return jS(this.options.tileServer,this.options.tileSet,this.options.tileProtocol,this.options.subdomains,e,this.options.tileKey,this.options.appId,i.lang,this.options.tileTemplateUrl,this.options.defaultLang,this.options.sessionId,this.options.dt)}constructMetaTileUrl(e){const i=this.options.metatileTemplateUrl,n={host:this.options.tileServer,tileSet:this.options.tileSet,protocol:this.options.tileProtocol,subdomain:this.options.subdomains[0],hash:Lu(e.metatileHash)};return gs(i?{url:i}:"metatile",n)}}const r0=[{id:"__2gis_comm_poi",type:"point",style:{textFont:["Noto_Sans_Semibold",["step",["zoom"],"Noto_Sans",16,"Noto_Sans"]],iconImage:"peak",iconWidth:["interpolate",["linear"],["zoom"],15,22,16.8,30],textColor:"#3A3A3A",visibility:"visible",textFontSize:[["interpolate",["linear"],["zoom"],15.5,11,18,13],["interpolate",["linear"],["zoom"],15.5,10,18,12]],textHaloColor:"rgba(255,255,255,0.5)",textHaloWidth:.9,iconLabelingGroup:Ju,iconLabelingMargin:{leftRight:6,topBottom:6}},filter:["all",["match",["get","db_sublayer"],["Commercial_poi_default","Commercial_poi_city","Commercial_poi_premium"],!0,!1],["any",["==",["in",["get","db_building_id"],["global","_activeFloorBuildingIds"]],!1],["in",["get","db_plan_id"],["global","_activeFloorIds"]]]]}];function G3(t){const e={};let i=0;for(const n in t)e[n]=i,i+=1;return e}let j3=Number.MIN_SAFE_INTEGER;function a0(){return j3++}const V3=a0(),H3=a0(),l0="__JAKARTA__DEM__LIGHTING__";class r_ extends Error{constructor(e){super(`Unknown expression type '${e[0]}' in '${JSON.stringify(e)}'`),this.name="UnknownExpressionTypeError",Object.setPrototypeOf(this,new.target.prototype)}}function F(t,e,i=wi.Uniform){if(oM(t))return Kg(t)?ia(t):t;switch(t[0]){case"coalesce":return tA(t,e,i);case"all":return eA(t,e,i);case"any":return iA(t,e,i);case"match":return Z3(t,e,i);case"in":return K3(t,e,i);case"interpolate":return c0(t,e,i);case"step":return Q3(t,e,i);case"featureState":case"get":case"sourceAttr":return d0(t,e,i);case"objectAttr":return{type:"objectAttr",property:t[1]};case"global":return{type:"global",property:t[1]};case"zoom":return{type:"zoom"};case"distance":return{type:"distance"};case"local-time":return{type:"local-time",offset:F(t[1]||0,e,i)};case"utc-time":return{type:"utc-time",offset:F(t[1]||0,e,i)};case"time":return nA(t,e,i);case"height":return{type:"height"};case"heatmap-density":return{type:"heatmap-density"};case"shading-intensity":return{type:"shading-intensity"};case"to-boolean":case"to-color":case"!":case"log10":case"mappoints-to-meters":case"meters-to-pixels":return $3(t,e,i);case"uint64":return F(t[1],e,i);case"==":case"!=":case"<":case"<=":case">":case">=":return W3(t,e,i);case"+":return X3(t,e,i);case"*":return Y3(t,e,i);case"^":return q3(t,e,i);case"random":return sA(t,e,i);case"literal":return Array.isArray(t[1])?oA(t,e,i):typeof t[1]=="object"&&t[1]!==null?rA(t):t[1];case"isBehindObjects":return{type:"isBehindObjects"};case"geometry-modifier":const n=[];return t.slice(1).forEach(s=>{const o=aA(s);o&&n.push(o)}),{type:"geometry-modifier",modifiers:n};case"pattern":return{type:"line-pattern",patternType:Ay(t[1]),parameters:t.slice(2).map(s=>F(s,e,i))};case"precompute":{if(!e)throw new r_(t);const s=e.precomputes.length;return e.precomputes.push({expr:F(t[1],void 0,i),usage:i}),{type:"precompute",precomputeIndex:s}}case"gltf-animation":return J3(t,e,i);default:throw new r_(t)}}function pr(t,e,i=wi.Uniform){return Yn(t)||Array.isArray(t)&&t.length===0?t:F(t,e,i)}function gr(t,e,i){return t===void 0?t:F(t,e,i)}function Z3(t,e,i){const n={type:"match",input:F(t[1],e,i),cases:[],defaultOutput:F(t[t.length-1],e,i)},s=t.slice(2,-1);for(let o=0;o<s.length;o+=2){const r=s[o].reduce((l,c)=>{typeof c=="boolean"&&l.push(Number(c));const d=F(c,e,i);return cM(d)?l.push(d):console.warn("MatchExpression supports only simple types: string, number, boolean or null",c),l},[]),a={values:new Set(r),output:F(s[o+1],e,i)};n.cases.push(a)}return n}function c0(t,e,i){const n={type:"interpolate",base:1,argument:F(t[2],e,i),steps:[]};t[1][0]==="exponential"&&t[1][1]!==void 0&&(n.base=t[1][1]);const s=t.slice(3);for(let o=0;o<s.length;o+=2){const r={key:F(s[o],e,i),value:F(s[o+1],e,i)};n.steps.push(r)}return n}function $3(t,e,i){return{type:t[0],value:F(t[1],e,i)}}function W3(t,e,i){const n=F(t[1],e,i),s=F(t[2],e,i);return{type:t[0],leftValue:n,rightValue:s}}function X3(t,e,i){return{type:"+",array:t.slice(1).map(n=>F(n,e,i))}}function Y3(t,e,i){return{type:"*",array:t.slice(1).map(n=>F(n,e,i))}}function q3(t,e,i){const n=F(t[1],e,i),s=F(t[2],e,i);return{type:"^",base:n,exponent:s}}function K3(t,e,i){const n=F(t[1],e,i),s=t[2][0];if(s!=="get"&&s!=="global"&&s!=="sourceAttr"&&s!=="literal")throw new Error("InExpression supports only the get, global, source attr and literal expressions as a second argument");const o=F(t[2],e,i);return{type:"in",item:n,collection:o}}function J3(t,e,i){const n={type:"gltf-animation",options:[]},s=t.slice(1);for(let o=0;o<s.length;o++)n.options.push(F(s[o],e,i));return n}function Q3(t,e,i){const n={type:"step",steps:[],value:F(t[1],e,i)},s={key:0,value:F(t[2],e,i)};n.steps.push(s);const o=t.slice(3);for(let r=0;r<o.length;r+=2){const a={key:o[r],value:F(o[r+1],e,i)};n.steps.push(a)}return n}function d0(t,e,i){const n=t[0],s=k3(t[1]),o={type:n,property:s};if(i!==wi.Generator&&e){const r=e.precomputes.length??NaN;return e.precomputes.push({expr:o,usage:i}),s==="selected"&&"selectedIdx"in e&&(e.selectedIdx=r),{type:"precompute",precomputeIndex:r}}else return o}function eA(t,e,i){return{type:"all",array:t.slice(1).map(n=>F(n,e,i))}}function tA(t,e,i){return{type:"coalesce",array:t.slice(1).map(n=>{try{return F(n,e,i)}catch(s){return console.debug(`Unknown expression in coalesce: ${s}`),null}})}}function iA(t,e,i){return{type:"any",array:t.slice(1).map(n=>F(n,e,i))}}function nA(t,e,i){return{type:"time",timeSource:F(t[1],e,i),format:t[2]}}function sA(t,e,i){const n=F(t[1],e,i),s=F(t[2],e,i);return{type:"random",start:n,end:s}}function oA(t,e,i){return{type:"literalArray",array:t[1].map(n=>F(n,e,i))}}function rA(t){return{type:"literalObject",object:{type:"object",value:t[1]}}}function aA(t){if(!(t===void 0||!Array.isArray(t)))switch(t[0]){case"line-to-zigzag":return{type:"zigzag-modifier",step:t[1],width:t[2],stopLines:Number(t[3])}}}function lA(t,e){let i=0;function n(s,o){s.type!=="custom"&&gT(s.filter)&&(i=o)}return t.forEach((s,o)=>{s.type==="group"?s.layers.forEach(r=>n(r,o)):n(s,o)}),e.forEach(s=>{s.type==="point"&&(s.style.iconPriority=Number.MAX_SAFE_INTEGER)}),[...t.slice(0,i+1),...e,...t.slice(i+1)]}function cA(t,e,i,n){var h;const s=c_(t.terrain??{}),o=_0(t.environment??{}),r=m0(t.light,s),a=uA(t.graphicsPresets),l={id:e,revision:0,background:{color:ia(((h=t.background)==null?void 0:h.color)??ZM)},light:r,layers:[],layersById:{[is]:s,[ga]:o},layerIdToInnerId:{},groupsById:{},iconBaseUrl:"",fontUrlTemplate:"",modelsBaseUrl:"",fonts:sc,fontNameToIndex:kv(sc),rasterSets:{byIndex:{},byKey:{}},icons:t.icons||{},models:Object.values(t.models??{}),modelIndex:G3(t.models||{}),labelingGroups:R3(t.labelingGroups??{}),dem:s,graphicsPresets:a,environment:o},c=new zl;let d=t.layers??[];i&&(d=lA(t.layers??[],r0));for(const u of d){const f=h0(u);if(!f)continue;f.type==="group"&&(l.groupsById[f.innerId]=f,l.layerIdToInnerId[f.id]=f.innerId),(f.type==="group"?f.layers:[f]).forEach(p=>{const _=p.lightingMode??r.defaultLightMode;r.lightingModes[_]||console.warn(`Не найден режим освещения ${_} для слоя ${p.type}. Будет использован режим освещения по умолчанию.`),l.layers.push(p),l.layersById[p.innerId]=p,l.layerIdToInnerId[p.id]=p.innerId,(p.type==="point"||p.type==="polygon"||p.type==="metricPoint"||p.type==="embankment"||p.type==="polygon3d")&&u0(p,c).forEach(b=>{l.rasterSets.byKey[b.key]||(l.rasterSets.byIndex[b.index]=b,l.rasterSets.byKey[b.key]=b)})})}return l}function h0(t){return t.type==="group"?hA(t):_t(t)}function u0(t,e){const i=[],{image:n,imageType:s,anchor:o}=a_(t);return n&&Zs(n).forEach(r=>{typeof r!="string"||!r.length||i.push(f0(r,s,e,o))}),i}function f0(t,e,i,n){const s=e==="icon"?Vs(t,n[0],n[1]):ta(t);return{type:ur.Static,index:i.getUniqueIndex(s),key:s,isSvg:!0,name:t,fileName:t,anchorX:n[0],anchorY:n[1],rasters:[]}}function a_(t){if(t.type==="point"){const e=ai(t.style.iconAnchor);return{image:t.style.iconImage,imageType:"icon",anchor:e}}return t.type==="metricPoint"?{image:t.style.iconImage,imageType:"texture",anchor:[0,0]}:{image:t.style.textureImage,imageType:"texture",anchor:[0,0]}}const l_=new zl;function dA(t,e){return t.type==="appearance"?{type:t.type,tipMovementAmplitude:F(t.tipMovementAmplitude,e)}:t.type==="repeat"?{type:t.type,tipMovementAmplitude:F(t.tipMovementAmplitude,e),iterationCount:t.iterationCount}:t}function _t(t,e){if(t.type==="custom")return{type:"custom",id:t.id,innerId:vl(),renderIndex:l_.getIndex(),filter:!1,minzoom:-1/0,maxzoom:1/0,precomputes:[],style:{}};if(!t.style||t.style.visibility==="none")return;let i;try{const n={id:t.id,innerId:vl(),renderIndex:l_.getIndex(),filter:F(t.filter||!1,void 0),minzoom:p0(t.minzoom,-1/0),maxzoom:p0(t.maxzoom,1/0),precomputes:e?e.precomputes.slice(0):[],webglState:t.webglState,lightingMode:t.lightingMode,castShadows:t.castShadows??!0,receiveShadows:t.receiveShadows??!0};switch(t.type){case"line":{const s=TM(t.style);i={...n,type:t.type,interactive:t.interactive??!0,ignoreTier:F(t.ignoreTier??!1,n),style:{visibility:Kt(s.visibility),color:F(s.color,n),width:F(s.width,n),shift:F(s.shift,n),pattern:F(s.pattern,n),startCap:F(s.startCap,n),endCap:F(s.endCap,n),geometryModifier:F(s.geometryModifier,n),withHeight:s.withHeight,lengthUnits:fA(t.style.pattern)}};break}case"lineExtrusion":{const s=AM(t.style);i={...n,type:t.type,style:{visibility:Kt(s.visibility),sideColor:F(s.sideColor,n),strokeWidth:F(s.strokeWidth,n),strokeColor:F(s.strokeColor,n),sideStrokeColor:F(s.sideStrokeColor,n),height:F(s.height,n),nearCameraFade:F(s.nearCameraFade,n)}};break}case"polygon":{const s=xM(t.style),o=d_(s.textureSize)?s.textureSize[1]:s.textureSize;i={...n,type:t.type,interactive:t.interactive??!0,ignoreTier:F(t.ignoreTier??!1,n),style:{visibility:Kt(s.visibility),color:F(s.color,n),textureImage:F(s.textureImage,n),textureSize:pr(o,n),textureOpacity:F(s.textureOpacity,n),strokeColor:F(s.strokeColor,n),strokeWidth:F(s.strokeWidth,n),lengthUnits:_A(s.textureSize)}};break}case"polygon3d":case"embankment":{const s=SM(t.style),o=t.type==="polygon3d"?{depthFunc:WebGLRenderingContext.LEQUAL}:{};i={...n,type:t.type,interactive:t.interactive??!0,style:{visibility:Kt(s.visibility),color:F(s.color,n),textureImage:F(s.textureImage,n),textureSize:pr(s.textureSize,n),textureOpacity:F(s.textureOpacity,n),strokeColor:F(s.strokeColor,n),strokeWidth:F(s.strokeWidth,n),nearCameraFade:F(s.nearCameraFade,n),elevation:F(s.elevation,n)},webglState:{...o,...n.webglState}},t.type==="polygon3d"&&(i.interactiveOcclusion=t.interactiveOcclusion??!0);break}case"metricPoint":{const s=MM(t.style);i={...n,type:t.type,interactive:t.interactive??!0,ignoreTier:F(t.ignoreTier??!1,n),style:{visibility:Kt(s.visibility),iconImage:F(s.iconImage,n),color:F(s.color,n),rotation:F(s.rotation,n),width:F(s.width,n),height:F(s.height,n)}};break}case"polygonExtrusion":{const s=IM(t.style);i={...n,type:t.type,interactive:t.interactive??!0,style:{visibility:Kt(s.visibility),topColor:F(s.topColor,n),sideColor:F(s.sideColor,n),strokeColor:F(s.strokeColor,n),strokeWidth:F(s.strokeWidth,n),sideStrokeColor:F(s.sideStrokeColor,n),height:F(s.height,n,wi.Generator),nearCameraFade:F(s.nearCameraFade,n)}};break}case"dashedLine":{const s=CM(t.style);i={...n,type:t.type,interactive:t.interactive??!0,ignoreTier:F(t.ignoreTier??!1,n),style:{visibility:Kt(s.visibility),color:F(s.color,n),gapColor:F(s.gapColor,n),width:F(s.width,n),shift:F(s.shift,n),gapLength:F(s.gapLength,n),dashLength:F(s.dashLength,n),geometryModifier:F(s.geometryModifier,n),withHeight:s.withHeight}};break}case"shiftedLine":{const s=RM(t.style);i={...n,type:t.type,interactive:t.interactive??!0,ignoreTier:F(t.ignoreTier??!1,n),style:{visibility:Kt(s.visibility),color:F(s.color,n),width:F(s.width,n),shift:F(s.shift,n)}};break}case"oneWayLine":{const s=LM(t.style);i={...n,type:t.type,ignoreTier:F(t.ignoreTier??!1,n),interactive:t.interactive??!1,style:{visibility:Kt(s.visibility),color:F(s.color,n),lineWidth:F(s.lineWidth,n),lineLength:F(s.lineLength,n),tipWidth:s.tipWidth,tipHeight:s.tipHeight,roundingRadius:F(s.roundingRadius,n),priority:s.priority,duplicationSpacing:F(s.duplicationSpacing,n),endingOffsets:s.endingOffsets,labelingGroup:s.labelingGroup}};break}case"buildingModel":{const s=EM(t.style);i={...n,type:t.type,interactive:t.interactive??!0,style:{visibility:Kt(s.visibility),color:F(s.color,n),strokeColor:F(s.strokeColor,n),strokeWidth:F(s.strokeWidth,n),nearCameraFade:F(s.nearCameraFade,n)}};break}case"labelLine":{const s=PM(t.style);i={...n,type:t.type,interactive:t.interactive??!1,ignoreTier:F(t.ignoreTier??!1,n),style:{visibility:Kt(s.visibility),textField:F(s.textField,n,wi.Labeling),textFont:s.textFont,textColor:F(s.textColor,n),textFontSize:F(s.textFontSize,n),textLetterSpacing:s.textLetterSpacing,textHaloColor:F(s.textHaloColor,n),textHaloWidth:s.textHaloWidth,textPriority:F(s.textPriority,n),textLabelingSideMargin:s.textLabelingSideMargin,textDuplicationSpacing:F(s.textDuplicationSpacing,n),labelingGroup:s.labelingGroup,lineEndingOffsets:s.lineEndingOffsets}};break}case"point":{const s=FM(t.style);i={...n,type:t.type,interactive:t.interactive??!0,style:{visibility:Kt(s.visibility),allowOverlap:s.allowOverlap,allowElevation:s.allowElevation,elevation:F(s.elevation,n),iconImage:F(s.iconImage,n),iconAnchor:pr(s.iconAnchor,n),iconOffset:pr(s.iconOffset,n),iconWidth:F(s.iconWidth,n),iconTextField:F(s.iconTextField,n,wi.Labeling),iconTextFont:gr(s.iconTextFont,n),iconTextAnchor:pr(s.iconTextAnchor,n),iconTextOffset:pr(s.iconTextOffset,n),iconTextColor:F(s.iconTextColor,n),iconTextFontSize:F(s.iconTextFontSize,n),iconTextLineHeight:s.iconTextLineHeight,iconTextLetterSpacing:s.iconTextLetterSpacing,iconTextPadding:pr(s.iconTextPadding,n),iconTextHaloWidth:ol(ii(s.iconTextHaloWidth)),iconTextHaloColor:F(s.iconTextHaloColor,n),iconOpacity:F(s.iconOpacity,n),iconPriority:F(s.iconPriority,n),iconLabelingMargin:s.iconLabelingMargin,iconLabelingGroup:s.iconLabelingGroup,iconRotation:F(s.iconRotation,n),textField:F(ii(s.textField),n,wi.Labeling),textFont:F(ii(s.textFont),n),textColor:F(ii(s.textColor),n),textFontSize:F(ii(s.textFontSize),n),textLineHeight:ol(ii(s.textLineHeight),1.2),textLetterSpacing:ol(ii(s.textLetterSpacing)),textField2:gr(Hs(s.textField),n,wi.Labeling),textFont2:gr(Hs(s.textFont),n),textColor2:gr(Hs(s.textColor),n)||F(ii(s.textColor),n),textFontSize2:gr(Hs(s.textFontSize),n)||F(ii(s.textFontSize),n),textMaxLengthPerLine:s.textMaxLengthPerLine,textPlacement:F(s.textPlacement,n),textPriority:F(s.textPriority,n),textOffset:F(ii(s.textOffset),n),textOffset2:gr(Hs(s.textOffset),n),textHaloColor:F(ii(s.textHaloColor),n),textHaloColor2:gr(Hs(s.textHaloColor),n)||F(ii(s.textHaloColor),n),textHaloWidth:ol(ii(s.textHaloWidth)),textHaloWidth2:ol(Hs(s.textHaloWidth)||ii(s.textHaloWidth)),textLabelingMargin:ii(s.textLabelingMargin),textLabelingMargin2:Hs(s.textLabelingMargin)||ii(s.textLabelingMargin),textLabelingGroup:ii(s.textLabelingGroup),textLabelingGroup2:Hs(s.textLabelingGroup)||ii(s.textLabelingGroup),duplicationSpacing:F(s.duplicationSpacing,n),endingOffsets:s.endingOffsets}};break}case"arrow":{const s=DM(t.style);i={...n,type:t.type,interactive:!1,ignoreTier:F(t.ignoreTier??!1,n),style:{visibility:Kt(s.visibility),color:F(s.color,n),strokeColor:F(s.strokeColor,n),lineWidth:F(s.lineWidth,n),strokeWidth:F(s.strokeWidth,n),tipWidth:F(s.tipWidth,n),tipHeight:F(s.tipHeight,n),roundingRadius:F(s.roundingRadius,n),animation:dA(s.animation,n)}};break}case"raster":{const s=OM(t.style);i={...n,type:t.type,ignoreTier:F(t.ignoreTier??!1,n),style:{visibility:Kt(s.visibility),opacity:F(s.opacity,n)}};break}case"circle":{const s=zM(t.style);i={...n,type:t.type,interactive:t.interactive??!0,style:{visibility:Kt(s.visibility),color:F(s.color,n),strokeColor:F(s.strokeColor,n),strokeColor2:F(s.strokeColor2,n),width:F(s.width,n),strokeWidth:F(s.strokeWidth,n),strokeWidth2:F(s.strokeWidth2,n)}};break}case"heatmap":{const s=BM(t.style);i={...n,type:t.type,style:{visibility:Kt(s.visibility),color:F(s.color,n),radius:F(s.radius,n),opacity:F(s.opacity,n),intensity:F(s.intensity,n),weight:F(s.weight,n),downscale:s.downscale},framebufferId:{framebuffer:li}};break}case"model":{const s=NM(t.style);i={...n,interactive:t.interactive??!0,interactiveOcclusion:t.interactiveOcclusion??!0,type:"gltfModel",style:{visibility:Kt(s.visibility),modelSrc:F(s.modelSrc,n),offset:F(s.offset,n,wi.Generator),scale:F(s.scale,n,wi.Generator),rotation:F(s.rotation,n,wi.Generator),color:F(s.color,n),linkedIds:F(s.linkedIds,n),colorTextureUvIndex:s.colorTextureUvIndex,roughness:s.roughness,metallic:s.metallic,preventObjectsHiding:s.preventObjectsHiding,nearCameraFade:F(s.nearCameraFade,n),ignoreGlobalLighting:s.ignoreGlobalLighting,showRatio:F(s.showRatio,n),lightingModel:s.lightingModel,playAnimation:F(s.playAnimation,n)}};break}case"overpass":{const s=UM(t.style);i={...n,type:t.type,style:{visibility:Kt(s.visibility),debug:s.debug,sideColor:F(s.sideColor,n),bottomColor:F(s.bottomColor,n),topColor:F(s.borderTopColor,n),strokeColor:F(s.strokeColor,n),strokeWidth:F(s.strokeWidth,n),thickness:F(s.thickness,n),borderHeight:F(s.borderHeight,n),borderWidth:F(s.borderWidth,n),color:F(s.color,n),nearCameraFade:F(s.nearCameraFade,n),tunnelHeight:F(s.tunnelHeight,n)}};break}case"tunnel":{const s=GM(t.style);i={...n,type:t.type,style:{visibility:Kt(s.visibility),sideColor:F(s.sideColor,n),bottomColor:F(s.bottomColor,n),topColor:F(s.topColor,n),strokeColor:F(s.strokeColor,n),strokeWidth:F(s.strokeWidth,n),color:F(s.color,n),nearCameraFade:F(s.nearCameraFade,n)}};break}}}catch(n){if(n instanceof r_){console.warn(`Problem with layer #${t.id}: ${n}`);return}throw n}return i}function hA(t){var i;const e={id:t.id,innerId:vl(),renderIndex:l_.getIndex(),type:t.type,layers:[],orderBy:[],precomputes:[]};return e.orderBy=((i=t.orderBy)==null?void 0:i.map(n=>d0(n,e,wi.Uniform)))??[],t.layers.forEach((n,s)=>{const o=_t(n,e);o&&(o.groupId=e.innerId,o.groupIndex=s,o.renderIndex=e.renderIndex,e.layers.push(o))}),e}function c_(t){const e=kM(t),i={id:"dem",type:"dem",innerId:is,filter:!0,precomputes:[],minzoom:-1/0,maxzoom:1/0,renderIndex:V3,style:{},framebufferId:{elevation:li,hillshade:li,flatBottom:li},lightingMode:l0};return i.style={visibility:"visible",lightingDirection:typeof e.lightingDirection<"u"?F(e.lightingDirection,i):null,shadingIntensity:F(e.shadingIntensity,i),shadingPalette:c0(e.shadingPalette,i),verticalScale:F(e.verticalScale,i)},i}function _0(t){const e=jM(t),i={id:"sky",type:"custom",innerId:ga,filter:!0,precomputes:[],minzoom:-1/0,maxzoom:1/0,renderIndex:H3,style:{}};return i.style={visibility:"visible",skyColor:F(e.skyColor,i),fogColor:F(e.fogColor,i),starsIntensity:F(e.starsIntensity,i)},i}function m0(t,e){var o,r;const i=VM(t),n={},s={ambientColor:{type:"color",value:[255,255,255,255]},ambientIntensity:0,dir1Color:{type:"color",value:[255,255,255,255]},dir1Altitude:0,dir1Azimuth:0,dir1Intensity:0,dir2Color:{type:"color",value:[255,255,255,255]},dir2Altitude:0,dir2Azimuth:0,dir2Intensity:0,shadowRadius:(o=i.shadows)==null?void 0:o.radius};for(const a in i.lightingModes){const l={ambientColor:{type:"color",value:[255,255,255,255]},ambientIntensity:0,dir1Color:{type:"color",value:[255,255,255,255]},dir1Altitude:0,dir1Azimuth:0,dir1Intensity:0,dir2Color:{type:"color",value:[255,255,255,255]},dir2Altitude:0,dir2Azimuth:0,dir2Intensity:0,shadowRadius:(r=i.shadows)==null?void 0:r.radius},c=i.lightingModes[a].map(u=>i.sources[u]).filter(Boolean),d=i.shadows?i.sources[i.shadows.source]:void 0;let h=0;c.forEach(u=>{u.color||(u.color="#FFFFFF"),u.type==="ambient"?(l.ambientColor=F(u.color,void 0),l.ambientIntensity=F(u.intensity,void 0),a===i.defaultLightingMode&&(s.ambientColor=l.ambientColor,s.ambientIntensity=l.ambientIntensity)):u.type==="directional"&&(u===d&&(l.shadowLightIndex=h),h===0?(h++,l.dir1Color=F(u.color,void 0),l.dir1Altitude=F(u.altitude,void 0),l.dir1Azimuth=F(u.azimuth,void 0),l.dir1Intensity=F(u.intensity,void 0),a===i.defaultLightingMode&&(s.dir1Color=l.dir1Color,s.dir1Intensity=l.dir1Intensity,s.dir1Azimuth=e.style.lightingDirection===null?l.dir1Azimuth:e.style.lightingDirection,s.dir1Intensity=F(u.intensity,void 0),s.dir1Altitude=l.dir1Altitude)):h===1&&(h++,l.dir2Color=F(u.color,void 0),l.dir2Altitude=F(u.altitude,void 0),l.dir2Azimuth=F(u.azimuth,void 0),l.dir2Intensity=F(u.intensity,void 0)))}),n[a]=l}return n[l0]=s,{defaultLightMode:i.defaultLightingMode,lightingModes:n}}function uA(t){return HM(t)}function p0(t,e){return typeof t=="number"&&!Number.isNaN(t)?t:e}function fA(t){return t&&d_(t[2])?vs.Meters:vs.Pixels}function _A(t){return d_(t)?vs.Meters:vs.Pixels}function d_(t){return Array.isArray(t)&&t[0]==="meters-to-pixels"}function Kt(t){return t==="none"?"hidden":t}class h_{constructor(e,i,n){this.id=e,this.modules=i,this.options=n,this.type="geojson",this.idToIndex={},this.worker=new this.modules.workers.parser.GeoJsonSource(this.options,this.id),this.attributes=n.attributes||{},this.dataFilter=n.dataFilter}fetchTile(e){return this.worker.fetchTile(e).then(()=>[{regionId:0,metatileHash:-2}])}async generateTile(e,i,n,s,o,r){const a=this.options.modelsPath,l=await this.worker.generateTile(e.styleState,i,n,s,o,a,this.dataFilter,e.modelShowHideEventsSublayers);return l.results[0]&&l.results[0].idToIndex&&(this.idToIndex[Ce(i)]=l.results[0].idToIndex),l}async getObjectAttributes(e,i){return this.worker.getObjectAttributes(e,i)}abortTileFetch(e){this.worker.abortTileFetch(e)}deleteTile(e){delete this.idToIndex[Ce(e)],this.worker.deleteTile(e)}setAttributes(e){this.worker.setSourceAttrs(e),this.attributes=e}getAttributes(){return this.attributes}destroy(){this.idToIndex={},this.worker.destroy()}setFeatureStateMap(e){this.worker.setFeatureStateMap(e)}async setData(e){return this.idToIndex={},this.options=typeof e=="string"?this.options={...this.options,url:e}:this.options={...this.options,data:e},await this.worker.setData(e)}getComponentIndex(e,i){var n;return i?(n=this.idToIndex[i])==null?void 0:n[e]:(console.warn("Нет tileKey при идентификации объекта из GeoJsonSource. Пытаемся получить index из id по-старому."),Number.isNaN(+e)?void 0:+e%2**32)}setDataFilter(e){e?this.dataFilter=F(e,{precomputes:[]},wi.Generator):this.dataFilter=void 0}}let mA=1;function vr(){return mA++}class Et{constructor(e){this.defs=e.map(i=>new pA(i))}check(e){const i=this.defs;let n=!1;for(let s=0;s<i.length;s++)n?i[s].update(e):n=!i[s].equal(e);return n}}class pA{constructor(e){this.path=Array.isArray(e.path)?e.path:[e.path],this.type=e.type,this.type==="number"?(this.last=NaN,this.compare=this.primitive,this.updateFn=this.primitiveUpdate):this.type==="boolean"?(this.last=void 0,this.compare=this.primitive,this.updateFn=this.primitiveUpdate):this.type==="vec2"?(this.last=[NaN,NaN],this.compare=this.vec2,this.updateFn=this.vec2Update):this.type==="vec3"?(this.last=[NaN,NaN,NaN],this.compare=this.vec3,this.updateFn=this.vec3Update):this.type==="string"?(this.last="",this.compare=this.primitive,this.updateFn=this.primitiveUpdate):this.type==="padding"?(this.last={left:0,right:0,bottom:0,top:0},this.compare=this.padding,this.updateFn=this.paddingUpdate):this.type==="replicas"&&(this.last={min:0,max:0},this.compare=this.replicas,this.updateFn=this.replicasUpdate)}equal(e){const i=this.take(e),n=this.compare(this.last,i);return this.updateFn(i),n}update(e){this.updateFn(this.take(e))}take(e){const i=this.path;let n=0;do e=e[i[n++]];while(n<i.length);return e}primitive(e,i){return e===i}padding(e,i){return e.top===i.top&&e.bottom===i.bottom&&e.left===i.left&&e.right===i.right}paddingUpdate(e){this.last.top=e.top,this.last.bottom=e.bottom,this.last.right=e.right,this.last.left=e.left}vec2(e,i){return e[0]===i[0]&&e[1]===i[1]}vec3(e,i){return e[0]===i[0]&&e[1]===i[1]&&e[2]===i[2]}primitiveUpdate(e){this.last=e}vec2Update(e){this.last[0]=e[0],this.last[1]=e[1]}vec3Update(e){this.last[0]=e[0],this.last[1]=e[1],this.last[2]=e[2]}replicas(e,i){const n=i[0],s=i[i.length-1];return e.min===n&&e.max===s}replicasUpdate(e){this.last.min=e[0],this.last.max=e[e.length-1]}}function Fl(t,e,i){let n,s,o,r;const a=function(){const d=Date.now()-o;d<e&&d>=0?n=setTimeout(a,e-d):(n=null,i||(r=t(...s),n||(s=null)))};function l(){n!==void 0&&(clearTimeout(n),n=null)}function c(...d){s=d,o=Date.now();const h=i&&!n;return n||(n=setTimeout(a,e)),h&&(r=t(...s),s=null),r}return c.cancel=l,c}const g0=15,xd=17;class v0{constructor(e,i,n){this.type="geojson",this.isCustomPromoteId=!1,this.id=vr(),this.modelsAppearStrategy=i.modelsAppearStrategy??qh,this.modules=e.modules,this.mapglApiSource=n,this.identifiedAsDefault=!!i.identifyAsDefaultSource,i.promoteId&&(this.isCustomPromoteId=!0),this.identifiedAsDefault&&!i.promoteId&&(i.promoteId="db_id"),"generateId"in i&&i.promoteId&&(i.generateId=!1),this.sourceCore=new h_(this.id,this.modules,i);const s=i.minZoom??zr.minZoom,o=Math.min(i.maxZoom??g0,xd);this.layer=new os(s,o,s,xd,this.modules,e.state,this.sourceCore,i),this.modules.tileManager.addTileLayer(this.layer)}destroy(){this.modules.tileManager.removeTileLayer(this.layer),this.layer.destroy(),this.modules.sourceStorage.removeSource(this.getId()),this.sourceCore.destroy()}setAttributes(e){this.sourceCore.setAttributes(e),this.layer.redraw(),this.modules.identifier.resetCache()}getAttributes(){return this.sourceCore.getAttributes()}getZoomDirection(){return this.layer.getZoomDirection()}getId(){return this.sourceCore.id}isIdentifiedAsDefault(){return this.identifiedAsDefault}}const Sd={type:"FeatureCollection",features:[]};let Md=class qx extends v0{constructor(e,i,n){i.generateId=!0,super(e,i,n),this.subtype="internal",this.data=i.data,this instanceof qx&&this.modules.sourceStorage.addSource(this)}getFeatureById(e,i){if(this.data.type==="FeatureCollection"){let n;const s=this.sourceCore.getComponentIndex(e,i);return s===void 0?(this.isCustomPromoteId&&(n=this.data.features.find(o=>o.id===e)),n):this.data.features[s]}return this.data}destroy(){super.destroy(),this.data=Sd}async setData(e){await this.sourceCore.setData(e)&&(this.data=e,this.layer.onSourceDataChange(),this.modules.identifier.resetCache())}setDataFilter(e){this.sourceCore.setDataFilter(e)}};class y0 extends v0{constructor(e,i,n){super(e,i,n),this.subtype="external",i.preventInteractions&&(i.promoteId=void 0),this.modules.sourceStorage.addSource(this)}getObjectAttributes(e,i){return this.sourceCore.getObjectAttributes(e,i)}async setDataUrl(e){await this.sourceCore.setData(e)&&(this.layer.onSourceDataChange(),this.modules.identifier.resetCache())}}let Id=class extends Md{constructor(e,i,n){super(e,i,n),this.subtype="viewport-internal",this.destroyed=!1,this.viewportDiffer=new Et([{path:"center",type:"vec3"},{path:"zoom",type:"number"},{path:"size",type:"vec2"},{path:"rotation",type:"number"},{path:"pitch",type:"number"},{path:"padding",type:"padding"},{path:"demMode",type:"boolean"},{path:"elevation",type:"number"},{path:"minElevation",type:"number"}]),this._map=e,this.viewportPadding=i.viewportPadding,this.modules.sourceStorage.addSource(this)}async setDataFn(e){this.setViewportHandler(e)}setViewportPadding(e){this.viewportPadding=e,this.viewportHandler&&this.viewportHandler()}update(){this.viewportDiffer.check(this._map.state)&&this.viewportHandler&&this.viewportHandler()}destroy(){this.destroyed=!0,this.viewportHandler&&(this.viewportHandler.cancel(),this.viewportHandler=void 0),super.destroy()}setViewportHandler(e){if(!e){this.setData(Sd),this.viewportHandler=void 0;return}this.viewportHandler=Fl(async()=>{const i=this._map.getBounds({sizeExtension:this.viewportPadding}),n=i.southWest,s=i.northEast,o=[n[0],n[1],s[0],s[1]],r=e(o);let a=Sd;try{const l=await fetch(r);l.ok||console.error(`Failed to fetch a tile by url "${r}", status: ${l.status}`);const c=l.headers.get("content-type");(!c||!c.includes("application/json"))&&console.error(`Failed to fetch a tile by url "${r}", expected the "application/json" data but got "${c}"`),a=await l.json()}catch(l){console.error(`Failed to fetch a tile by url "${r}", message: ${l.message}`)}this.destroyed||this.setData(a)},500),this.viewportHandler()}},u_=class{constructor(e,i,n){this.options=i,this.type="zenith",this.id=vr(),this.identifyAsDefaultSource=i.identifyAsDefaultSource??!0,this.identifyAsDefaultSource&&!i.promoteId&&(i.promoteId="id"),this.sourceOptions=i,this.modelsAppearStrategy=i.modelsAppearStrategy??qh,this.state=e.state,this.modules=e.modules,this.sourceCore=new o0(this.id,this.modules,this.options),this.tileLayer=new os(i.minZoom??Xe.maxUniverseZoom+1,i.maxZoom??Xe.maxRegionalZoom,i.minZoom??Xe.maxUniverseZoom+1,i.maxDetailLevel??Xe.maxDetailLevel,this.modules,this.state,this.sourceCore,this.options),this.modules.tileManager.addTileLayer(this.tileLayer),this.modules.sourceStorage.addSource(this),this.mapglApiSource=n}getObjectAttributes(e,i){return this.sourceCore.getObjectAttributes(e,i)}getId(){return this.id}getOptions(){return this.sourceOptions}getAttributes(){return this.sourceCore.getAttributes()}getZoomDirection(){return this.tileLayer.getZoomDirection()}setAttributes(e){this.sourceCore.setAttributes(e),this.tileLayer.redraw()}getUrl(e,i){return gs(e,{host:this.options.tileServer,tileSet:this.options.tileSet,protocol:this.options.tileProtocol,subdomain:this.options.subdomains[0],...i})}destroy(){this.modules.tileManager.removeTileLayer(this.tileLayer),this.tileLayer.destroy(),this.modules.sourceStorage.removeSource(this.id),this.sourceCore.destroy()}setFeatureStateMap(e){this.sourceCore.setFeatureStateMap(e),this.tileLayer.onFeatureStateMapChange()}isIdentifiedAsDefault(){return this.identifyAsDefaultSource}};function f_(t,e){const i=new XMLHttpRequest;if(i.open("GET",t.url,!0),i.responseType="arraybuffer",t.headers)for(const n in t.headers)i.setRequestHeader(n,t.headers[n]);return i.onerror=function(){e({status:0,message:"Network error"},new ArrayBuffer(0))},i.onload=function(){i.status>=200&&i.status<300&&i.response?e(void 0,i.response):e({status:i.status,message:i.statusText},new ArrayBuffer(0))},i.send(),i}function gA(t,e){const i=new XMLHttpRequest;if(i.open("GET",t.url,!0),t.headers)for(const n in t.headers)i.setRequestHeader(n,t.headers[n]);return i.onerror=function(){e({status:0,message:"Network error"},{})},i.onload=function(){if(i.status>=200&&i.status<300){if(!i.response||!i.response.length)return e({status:204,message:"No content"},{});let n;try{n=JSON.parse(i.response),e(void 0,n)}catch{e({status:0,message:`Json parse data error from url ${t.url}`},{})}}else e({status:i.status,message:i.statusText},{})},i.send(),i}function w0(t){return t?t>=500&&t<=599:!1}function b0(t){return new Promise(e=>setTimeout(e,t))}class vA{constructor(){this.cache=new Map,this.pendingRequests=new Map}async fetch(e,i=3,n=300){var r;let s=0,o;for(;s<=i;)try{if(o=await this.fetchAttempt(e),!o)return;if(!o.err||!w0((r=o.err)==null?void 0:r.status))return o;throw new Error(`Fetching ${e.coords} attempt ${s} failed.`)}catch{if(s>=i)return{metadata:[]};await b0(Math.pow(2,s)*n),s++}}get(e){return this.cache.get(e)||[]}delete(e){this.cache.delete(e)}abortRequest(e){const i=this.pendingRequests.get(e);i!==void 0&&(i.xhr.abort(),i.resolve(),this.pendingRequests.delete(e))}destroy(){this.cache.clear(),this.pendingRequests.clear()}fetchAttempt({tileUrl:e,coords:i}){return new Promise(n=>{const s=Ce(i),o=f_({url:e},(r,a)=>{if(this.pendingRequests.delete(s),r||a.byteLength===0){r!==void 0&&console.error(r),this.cache.set(s,[]),n({metadata:[],err:r});return}const l=PS(a),c=LS(l);this.cache.set(s,l),n({metadata:c,err:r})});this.pendingRequests.set(s,{xhr:o,resolve:n})})}}class __ extends Map{constructor(e){super(e),this.featureAttrs=(e==null?void 0:e.featureAttrs)||new Set,this.clearAttrs=!0}set(e,i){return super.set(e,i),Object.keys(i).forEach(n=>this.featureAttrs.add(n)),this}}const Lo=0,m_=1,yA={type:ur.Loaded,index:-1,key:Vs("",.5,.5),isSvg:!1,name:"",fileName:"",rasters:[]},wA=["default","marker","markerText","htmlLabel"],bA={default:0,marker:1,markerText:2,htmlLabel:3,pointLabel:4},xA={default:{default:!0,marker:!1,markerText:!0,htmlLabel:!0,pointLabel:!1},marker:{default:!1,marker:!1,markerText:!0,htmlLabel:!1,pointLabel:!1},markerText:{default:!0,marker:!0,markerText:!0,htmlLabel:!1,pointLabel:!1},htmlLabel:{default:!0,marker:!1,markerText:!1,htmlLabel:!1,pointLabel:!1},pointLabel:{default:!1,marker:!1,markerText:!1,htmlLabel:!1,pointLabel:!0}};function rs(t){const e=[],i=Object.keys(yi).length;for(let n=0;n<i;n++)e[n]=NaN;for(const n in t){if(yi[n]===void 0)throw new Error(`No such tile prop '${n}'`);e[yi[n]]=t[n]}return e}class SA{constructor(){this.needRenderIndexRebuild=!1,this.style={id:Lo,revision:0,background:{color:ia("#f6f2de")},light:{defaultLightMode:"global",lightingModes:{}},layers:[],layersById:{},layerIdToInnerId:{},groupsById:{},iconBaseUrl:"",fontUrlTemplate:"",modelsBaseUrl:"",rasterSets:{byIndex:{},byKey:{}},labelingGroups:{indexToGroup:wA,groupToIndex:bA,table:xA},fonts:sc,fontNameToIndex:kv(sc),icons:{},models:[],modelIndex:{},dem:c_({}),environment:_0({}),graphicsPresets:{light:{},normal:{},immersive:{}}},this.zIndexById={};const e=_t({type:"line",id:"debug-tile-bounds",minzoom:-1/0,maxzoom:1/0,style:{color:"#ff0000",width:1}});e&&this.addLayer(e,0)}get hasDynamicObjects(){return this.style.layers.length>1}getRenderIndexById(e){var i;return((i=this.style.layersById[e])==null?void 0:i.renderIndex)||0}getStyle(){return this.style}appendRasterSet(e,i){this.style.rasterSets.byIndex[e.index]=e,i!==void 0&&(this.style.rasterSets.byKey[i]=e)}removeRasterSet(e){this.style.rasterSets.byIndex[e]=yA}getLabelingGroupIndex(e){const{groupToIndex:i}=this.style.labelingGroups;return i[e]!==void 0?i[e]:i.default}addLayer(e,i){this.style.layersById[e.innerId]||(this.style.layers.push(e),this.style.layersById[e.innerId]=e,i!==void 0&&(this.zIndexById[e.innerId]=i),this.needRenderIndexRebuild=!0)}removeLayer(e){const i=this.style.layersById[e];if(!i)return;const n=this.style.layers.indexOf(i);n!==-1&&this.style.layers.splice(n,1),delete this.style.layersById[e],delete this.zIndexById[e]}updateLayerStyle(e,{style:i,precomputes:n}){const s=this.style.layersById[e];s&&(s.style=i,s.precomputes=n)}update(){this.needRenderIndexRebuild&&(this.rebuildRenderIndex(),this.needRenderIndexRebuild=!1)}rebuildRenderIndex(){this.style.layers.sort((e,i)=>{const n=this.zIndexById[e.innerId]??0,s=this.zIndexById[i.innerId]??0;return n-s});for(let e=0;e<this.style.layers.length;e++)this.style.layers[e].renderIndex=e}}function x0(t,e,i){const s=xe,o={x:new Uint16Array([0,s,s,0,0]),y:new Uint16Array([0,0,s,s,0])},r=rs({}),a=di(i,un,yi,r,Hi);vt({collector:t,generator:St.generate,args:[Lo,e,a,Ye([0,0,0,0]),o]})}function p_(){try{return!!localStorage.getItem("debugStatusCompile")}catch(t){return console.warn("Error accessing localStorage in forceGlStatusCheck:",t),!1}}function g_(t){for(let e=1;e<t.length;e++)t[e]=t[e]+t[e-1]}function MA(t){let e=0,i=0,n=0;for(let s=0;s<t.length;s+=2)n=i+t[s],i=n>>>0,t[s]=i,e=e+t[s+1]+(n>4294967295?1:0)>>>0,t[s+1]=e}const S0={1:g_,2:g_,4:g_,8:MA};class M0{constructor(e){this.offset=0,this.buffer=e,this.u8=new Uint8Array(e),this.u16=new Uint16Array(e),this.u32=new Uint32Array(e),this.s8=new Int8Array(e),this.s16=new Int16Array(e),this.s32=new Int32Array(e),this.f32=new Float32Array(e)}readS8(){return this.s8[this.offset++]}readU16(){const e=this.u16[this.offset>>1];return this.offset+=2,e}readU32(){const e=this.u32[this.offset>>2];return this.offset+=4,e}readF32(){const e=this.f32[this.offset>>2];return this.offset+=4,e}readU8Vector(e=1){const n=this.readU32()*e,s=-n&3,o=this.u8.subarray(this.offset,this.offset+n);return this.offset+=n+s,o}readU16Vector(e=1){const n=this.readU32()*e*2,s=-n&3,o=this.u16.subarray(this.offset>>1,this.offset+n>>1);return this.offset+=n+s,o}}function Rt(t,e,i,n){const s=e.BYTES_PER_ELEMENT;t.offset+=-t.offset&s-1;const o=new e(t.buffer,t.offset,i);return t.offset+=s*i,n&&S0[s](o),o}function Td(t,e,i){t.offset+=-t.offset&7;const n=new Uint32Array(t.buffer,t.offset,e*2);return t.offset+=8*e,i&&S0[8](n),n}function I0(t,e,i){t.offset+=-t.offset&3;const n=new Uint32Array(t.buffer,t.offset,e),s=new Float32Array(t.buffer,t.offset,e);t.offset+=4*e;let o;if(i){let r=0;for(o=0;o<e;o++)r=r+n[o]>>>0,s[o]=r/1e3}else for(o=0;o<e;o++)s[o]=n[o]/1e3;return s}function T0(t,e,i){t.offset+=-t.offset&3;const n=new Int32Array(t.buffer,t.offset,e),s=new Float32Array(t.buffer,t.offset,e);t.offset+=4*e;let o;if(i){let r=0;for(o=0;o<e;o++)r=r+n[o]>>>0,s[o]=(r|0)/1e3}else for(o=0;o<e;o++)s[o]=n[o]/1e3;return s}function IA(t,e){let i=t.offset;const n=t.u8,s=t.buffer,o=[];for(;e--;)o.push(n[i++]|0);const r=[];for(;++e<o.length;){let a=o[e];a===255&&(a=n[i++]|n[i++]<<8|n[i++]<<16|0),r.push(new Uint8Array(s,i,a)),i=i+a}return t.offset=i,r}function TA(t,e){t.offset+=-t.offset&3;let i=t.offset;const n=t.u32,s=t.buffer,o=[];for(let a=0;a<e;a++)o.push(n[i>>2]),i+=4;const r=[];for(let a=0;a<e;a++){const l=o[a];i+=-i&7,r.push(new Uint8Array(s,i,l)),i+=l}return t.offset=i,r}function EA(t,e,i){switch(i){case 2:return Rt(t,Uint8Array,e);case 3:return Rt(t,Uint8Array,e,!0);case 4:return Rt(t,Uint16Array,e);case 5:return Rt(t,Uint16Array,e,!0);case 6:return Rt(t,Uint32Array,e);case 7:return Rt(t,Uint32Array,e,!0);case 8:return Td(t,e);case 9:return Td(t,e,!0);case 10:return Rt(t,Uint8Array,e);case 11:return IA(t,e);case 12:return TA(t,e);case 13:return Rt(t,Int8Array,e);case 14:return Rt(t,Int8Array,e,!0);case 15:return Rt(t,Int16Array,e);case 16:return Rt(t,Int16Array,e,!0);case 17:return Rt(t,Int32Array,e);case 18:return Rt(t,Int32Array,e,!0);case 19:return Td(t,e);case 20:return Td(t,e,!0);case 21:return I0(t,e);case 22:return I0(t,e,!0);case 23:return T0(t,e);case 24:return T0(t,e,!0);case 25:return Rt(t,Uint32Array,e);default:throw new Error("Unknown stream type "+i)}}function v_(t){let e=0;for(let i=0;i<t.length;i++)e+=t[i];return e}function AA(t,e,i){return new t.constructor(t.buffer,t.byteOffset+e*t.BYTES_PER_ELEMENT,i)}let Co;const ba=[],as=new Int32Array(256);let y_;const w_=[],E0=[],A0=[],b_=[0,0,0,0,0];let P0=0,x_=0,S_=0,xa={};function PA(t,e,i,n,s,o,r,a,l=!1,c,d,h,u){const{styleState:f,sourceId:m,sourceAttrs:p,tileInfo:_,pixelRatio:g,selectedIds:y,dataFilter:b,floorsEnabled:v,hoverId:I,generateOnlySelectedPoi:S,generateOnlyHoveredPoi:P,modelsPath:T}=s,{data:L}=o,B=new Set(y),O=CS(L);if(O.byteLength<8)return n.getAccumulatedData();ba.length=0;const w=new M0(O);if(w.readU32()!==1279676242)return n.getAccumulatedData();const C=w.readU16();if(C!==2&&C!==3&&C!==4)return console.error(`Unsupported tile format version: "${C}"`),n.getAccumulatedData();Co=C,w.readU16();const V=dr(g);return LA(w),CA(w),RA(Co,t,e,f,i,n,w,_,V,B,b,r,a,v,m,p,l,I,S,P,T,c,d,h,u),n.getAccumulatedData()}function LA(t){const e=Co===4?2:1,i=t.u8;let n=t.offset,s=t.u32[n>>2];for(n+=4,P0=s,x_=n;s--;)n=i[n++]*2+n,n=i[n++]*e+n;t.offset=n+(-n&3)}function CA(t){const e=t.u32[t.offset>>2];t.offset+=4,y_=Rt(t,Uint8Array,e);const i=Rt(t,Uint32Array,e);for(let n=0;n<e;n++){const s=y_[n];ba[n]=EA(t,i[n],s),as[n]=0}}function RA(t,e,i,n,s,o,r,a,l,c,d,h,u,f,m,p,_=!1,g,y,b,v,I,S,P,T){const L=Array.from(s.featureAttrs);Qa(h,L);const B=P0,O=Rt(r,Int32Array,B),w=v_(O),x=Rt(r,Uint8Array,w,!0),C=Rt(r,Uint8Array,v_(x),!0),V=Rt(r,Uint8Array,w,!0),M=Rt(r,Uint8Array,v_(V),!0),A=Rt(r,Uint16Array,w,!0);let E=0,k=0,D=0,U=!0;for(let N=0;N<B;N++){const G=O[N];OA(r,h,u);for(let Q=0;Q<G;Q++){const X=x[E];X>0&&(zA(u,X,C,k,h,t,_),k+=X);const H=V[E];if(H>0&&(FA(u,H,M,D),D+=H),!u[h.tileProps.db_geometry_type]){console.error(`Geometry type not specified for data source ${m}. Metatile version ${h.version}`);return}U=X>0||H>0;const K=h.tileProps;let oe=u[K[P??""]];Number.isNaN(oe)&&(oe=void 0);const Me=di(n,p,K,u,[],oe,a),re=A[E];re>0&&DA(t,e,i,n,Me,s,o,re,a,l,c,d,h,f,m,g,y,b,v,I,U,S,T),E++}}L0()}function zA(t,e,i,n,s,o,r=!1){var a;for(;e--;){const l=i[n++],c=E0[l],d=w_[l],h=y_[c];if(h===8||h===9||h===19||h===20)t[d]=Ty(ba[c][as[c]],ba[c][as[c]+1]),as[c]+=2;else{const u=ba[c][as[c]];switch(d){case s.tileProps.objectLength:case s.tileProps.db_centroid_x:case s.tileProps.db_centroid_y:case s.tileProps.componentDistanceEnd:case s.tileProps.componentDistanceStart:case s.tileProps.previousPointX:case s.tileProps.previousPointY:case s.tileProps.nextPointX:case s.tileProps.nextPointY:t[d]=o===2?u*Nn:u;break;case s.tileProps.db_label:t[d]=Xu(u);break;case s.tileProps.db_label2:t[d]=Xu(u);break;case s.tileProps.db_tiers:const f=u.byteLength/Int32Array.BYTES_PER_ELEMENT,m=new DataView(u.buffer,u.byteOffset,u.byteLength),p=m.getInt32(0,!0);if(f===1&&!p)t[d]=void 0;else{const _=new Array(f);_[0]=p;for(let g=1;g<f;g++)_[g]=m.getInt32(g*Int32Array.BYTES_PER_ELEMENT,!0);t[d]=_}break;default:if(r&&h===11)t[d]=Xu(u);else{const _=s.tilePropsByIndex[d];t[d]=((a=s.reverseDictionaries[_])==null?void 0:a[u])??u}}as[c]++}}}function FA(t,e,i,n){for(;e--;){const s=i[n++],o=w_[s];t[o]=NaN}}let Ed=[];function DA(t,e,i,n,s,o,r,a,l,c,d,h,u,f,m,p,_,g,y,b=[],v,I,S){const{tileProps:P,defaultProps:T}=u,{tileAttrs:L,featureAttrs:B,id:O}=s,w=l.coords[3],x=P.db_hidden_by_plan_id!==void 0;if(!v&&Ed.length===0){for(let M=0;M<S_;M++){const A=b_[M];as[A]=as[A]+a}return}const C=L[P.db_geometry_type],V=Co===4?u.vertexProps:u.vertexPropsLegacy[C];if(!V){console.error(`Couldn't get vertex keys for tile ${Ce(l.coords)} source ${m}. Metatile version ${u.version}`);return}for(let M=0;M<S_;M++){const A=Co===4?A0[M]:M,E=b_[M],k=V[A]??"signed_z";xa[k]=BA(AA(ba[E],as[E],a),M,t),Co===4&&k==="z"&&(xa.signed_z=xa.z),as[E]=as[E]+a}if(!(P.db_sublayer!==void 0&&!Number.isNaN(L[P.db_sublayer])&&rd(L[P.db_sublayer]))&&!(x&&n._activeFloorIds&&L[P.db_hidden_by_plan_id]&&n._activeFloorIds.includes(L[P.db_hidden_by_plan_id]))){for(const M in T){const A=T[M];Number.isNaN(L[A.index])&&(L[A.index]=A.value)}if(!(p&&p!==O)){if(O!==void 0){let M=d.has(O);_&&(M=!0);const A=!!g||!!p&&p===O;if(L[P.selected]=M?1:0,L[P.hovered]=A?1:0,b.length>0){const E={};b.forEach(k=>{E[k]=L[P[k]]}),r.addPromotedObjectAttributes(O,E)}f&&w>=jo.detailLevel&&L[P.db_hidden_by_plan_building_id]&&r.addFloorHidingMap(O,L[P.db_hidden_by_plan_building_id])}else L[P.selected]=0,L[P.hovered]=0;if(o.featureAttrs.size>0){const M=O!==void 0&&o.get(O);if(M)for(const A of o.featureAttrs)o.clearAttrs=!1,B[P[A]]=M[A];else if(o.clearAttrs===!1){o.clearAttrs=!0;for(const A in P)B[P[A]]!==void 0&&(B[P[A]]=void 0)}}if(I){const M=kA(xa,C,l);if(M){const A=NA(s,Ce(l.coords));r.addFeature({type:"Feature",properties:A,geometry:M})}return}v&&(Ed=i.getLayers(e.id,P,L).filter(M=>q(M.filter,s)&&(h?q(h,s):!0))),Ed.length===0&&s.id&&r.idIndexer.addOrphanId(s.id),Ly(r,e,Ed,s,u,Co,w,m,l,c,xa,_||g,y,S)}}}function OA(t,e,i){const n=Object.keys(e.tileProps).length,s=t.u8;let o,r,a=x_;for(r=1;r<n;r++)i[r]=NaN;for(o=s[a++],r=0;r<o;r++)w_[r]=s[a++],E0[r]=s[a++];for(o=s[a++],r=0;r<o;r++)Co===4&&(A0[r]=s[a++]),b_[r]=s[a++];S_=o,x_=a,L0()}function L0(){xa={}}function BA(t,e,i){if(i===2&&e<3&&t instanceof Uint16Array)for(let n=0;n<t.length;n++)t[n]*=Nn;return t}function kA(t,e,i){const n=[],{x:s,y:o,z:r,signed_z:a}=t;for(let l=0;l<t.x.length;l++){const c=el(s[l],o[l],i),d=Z.scaleFactor(c[1]),h=r?r[l]*32:void 0;c[2]=h??(a==null?void 0:a[l])??0,c[2]/=Ge*d,n.push(c)}if(n.length)switch(e){case"point":return{type:"MultiPoint",coordinates:n};case"polyline":return{type:"LineString",coordinates:n};case"polygon":return{type:"Polygon",coordinates:[n.map((l,c)=>n[zi(c,n.length)])]};default:return}}function NA(t,e){const i={tile:e};return Object.keys(t.tileProps).forEach(n=>{const s=t.tileAttrs[t.tileProps[n]];!Number.isNaN(s)&&s!==void 0&&(i[n]=s)}),i}const UA=t=>{if(t.length>2){let e=0;for(let i=t.length-1,n=i,s=0;s<=i;s++){const o=t[n],r=t[s];e+=(o[0]+r[0])*(o[1]-r[1]),n=s}return e/2}else return 0},GA=t=>UA(t)>0;function jA(t){t=t.slice().sort(VA);const e=t.length,i=new Array(e*2);let n=0;for(let o=0;o<e;o++){const r=t[o];for(;n>=2&&C0(i[n-2],i[n-1],r)<=0;)n--;i[n++]=r}const s=n+1;for(let o=e-2;o>=0;o--){const r=t[o];for(;n>=s&&C0(i[n-2],i[n-1],r)<=0;)n--;i[n++]=r}return i.slice(0,n-1)}function C0(t,e,i){return(e[1]-t[1])*(i[0]-t[0])-(e[0]-t[0])*(i[1]-t[1])}function VA(t,e){return t[0]===e[0]?t[1]-e[1]:t[0]-e[0]}function HA(t){const e=[],i=GA(t),n=mo(t[0],t[t.length-1]),s=n?t.length-1:t.length;for(let o=s-1,r=0,a=1;r<s;r++,o=r-1,a=(r+1)%s){const l=[];Q2(l,t[o],t[r],t[a],i),e.push(l)}return n&&e.push(e[0]),e}const Ad=[[0],[0],[0]],R0=[];function ZA(t,e,i,n,s,o,r,a,l){const{matrix:c,offset:d,id:h,selected:u}=o,f=new M0(s),m=[];if(!t)return{objects:n.getAccumulatedData(),textures:m};if(f.readU32()!==1296191066||f.readU16()!==1)return{objects:n.getAccumulatedData(),textures:[]};f.readU16();const p=f.readU32();for(let T=0;T<p;T++)m.push(f.readU8Vector());const{tileProps:_}=r,g=[],y=Object.keys(_).length;for(let T=0;T<y;T++)g[T]=NaN;if(g[_.db_sublayer]="Building_model",g[_.selected]=u?1:0,g[_.db_region]=a,l.featureAttrs.size>0){const T=Array.from(l.featureAttrs);Qa(r,T)}const b=[],v=typeof h!="number"&&l.get(h);if(v)for(const T of l.featureAttrs)l.clearAttrs=!1,b[_[T]]=v[T];else if(l.clearAttrs===!1){l.clearAttrs=!0;for(const T in _)b[_[T]]!==void 0&&(b[_[T]]=void 0)}const I=f.offset,S=di(i,un,_,g,b,h),P=e.getLayers(t.id,_,g).filter(T=>q(T.filter,S));return P.length===0&&S.id&&n.idIndexer.addOrphanId(S.id),P.forEach(T=>{T.type!=="buildingModel"||(Zt(T,S),!q(T.filter,S))||(f.offset=I,$A(t,T,S,n,f,c,d))}),{objects:n.getAccumulatedData(),textures:m}}function $A(t,e,i,n,s,o,r){const a=s.readU32();for(let l=0;l<a;l++){const c=s.readU32(),d=at(s.readF32(),s.readF32(),s.readF32()),h=at(s.readF32(),s.readF32(),s.readF32()),u=vi(Oe(),h,d),f=[];Zp(f,o,d),Ha(f,f,u),f[12]+=r[0],f[13]+=r[1];const m=s.readU16Vector(5),p=s.readU32();for(let b=0;b<p;b++){const v=s.readU32()===1?a2:Ua,I=s.readU16Vector();do Fn.processSubmesh(t.id,e,i,n,m,I,v,c,f);while(n.isOverloaded())}const _=s.readU16Vector();do Fn.processOuterEdge(t.id,e,i,n,m,_,f);while(n.isOverloaded());const g=jA(WA(m)),y=HA(g);for(let b=0;b<g.length-2;b++){for(let v=0;v<3;v++){const I=XA(b+v,g.length);Ad[0][v]=g[I][0],Ad[1][v]=g[I][1],Ad[2][v]=0,R0[v]=y[I]}do hi.generateFloorsBottomFill(n,t.id,Ad,R0,Gc,f);while(n.isOverloaded())}}}function WA(t){const e=[];for(let i=0;i<t.length;i+=5)e.push([t[i],t[i+1]]);return e}function XA(t,e){return t===0?0:t%2?(t+1)/2:e-t/2}function YA(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var M_={};/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */M_.read=function(t,e,i,n,s){var o,r,a=s*8-n-1,l=(1<<a)-1,c=l>>1,d=-7,h=i?s-1:0,u=i?-1:1,f=t[e+h];for(h+=u,o=f&(1<<-d)-1,f>>=-d,d+=a;d>0;o=o*256+t[e+h],h+=u,d-=8);for(r=o&(1<<-d)-1,o>>=-d,d+=n;d>0;r=r*256+t[e+h],h+=u,d-=8);if(o===0)o=1-c;else{if(o===l)return r?NaN:(f?-1:1)*(1/0);r=r+Math.pow(2,n),o=o-c}return(f?-1:1)*r*Math.pow(2,o-n)},M_.write=function(t,e,i,n,s,o){var r,a,l,c=o*8-s-1,d=(1<<c)-1,h=d>>1,u=s===23?Math.pow(2,-24)-Math.pow(2,-77):0,f=n?0:o-1,m=n?1:-1,p=e<0||e===0&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(a=isNaN(e)?1:0,r=d):(r=Math.floor(Math.log(e)/Math.LN2),e*(l=Math.pow(2,-r))<1&&(r--,l*=2),r+h>=1?e+=u/l:e+=u*Math.pow(2,1-h),e*l>=2&&(r++,l/=2),r+h>=d?(a=0,r=d):r+h>=1?(a=(e*l-1)*Math.pow(2,s),r=r+h):(a=e*Math.pow(2,h-1)*Math.pow(2,s),r=0));s>=8;t[i+f]=a&255,f+=m,a/=256,s-=8);for(r=r<<s|a,c+=s;c>0;t[i+f]=r&255,f+=m,r/=256,c-=8);t[i+f-m]|=p*128};var qA=et,Pd=M_;function et(t){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(t)?t:new Uint8Array(t||0),this.pos=0,this.type=0,this.length=this.buf.length}et.Varint=0,et.Fixed64=1,et.Bytes=2,et.Fixed32=5;var I_=65536*65536,z0=1/I_,KA=12,F0=typeof TextDecoder>"u"?null:new TextDecoder("utf8");et.prototype={destroy:function(){this.buf=null},readFields:function(t,e,i){for(i=i||this.length;this.pos<i;){var n=this.readVarint(),s=n>>3,o=this.pos;this.type=n&7,t(s,e,this),this.pos===o&&this.skip(n)}return e},readMessage:function(t,e){return this.readFields(t,e,this.readVarint()+this.pos)},readFixed32:function(){var t=Ld(this.buf,this.pos);return this.pos+=4,t},readSFixed32:function(){var t=O0(this.buf,this.pos);return this.pos+=4,t},readFixed64:function(){var t=Ld(this.buf,this.pos)+Ld(this.buf,this.pos+4)*I_;return this.pos+=8,t},readSFixed64:function(){var t=Ld(this.buf,this.pos)+O0(this.buf,this.pos+4)*I_;return this.pos+=8,t},readFloat:function(){var t=Pd.read(this.buf,this.pos,!0,23,4);return this.pos+=4,t},readDouble:function(){var t=Pd.read(this.buf,this.pos,!0,52,8);return this.pos+=8,t},readVarint:function(t){var e=this.buf,i,n;return n=e[this.pos++],i=n&127,n<128||(n=e[this.pos++],i|=(n&127)<<7,n<128)||(n=e[this.pos++],i|=(n&127)<<14,n<128)||(n=e[this.pos++],i|=(n&127)<<21,n<128)?i:(n=e[this.pos],i|=(n&15)<<28,JA(i,t,this))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var t=this.readVarint();return t%2===1?(t+1)/-2:t/2},readBoolean:function(){return!!this.readVarint()},readString:function(){var t=this.readVarint()+this.pos,e=this.pos;return this.pos=t,t-e>=KA&&F0?fP(this.buf,e,t):uP(this.buf,e,t)},readBytes:function(){var t=this.readVarint()+this.pos,e=this.buf.subarray(this.pos,t);return this.pos=t,e},readPackedVarint:function(t,e){if(this.type!==et.Bytes)return t.push(this.readVarint(e));var i=to(this);for(t=t||[];this.pos<i;)t.push(this.readVarint(e));return t},readPackedSVarint:function(t){if(this.type!==et.Bytes)return t.push(this.readSVarint());var e=to(this);for(t=t||[];this.pos<e;)t.push(this.readSVarint());return t},readPackedBoolean:function(t){if(this.type!==et.Bytes)return t.push(this.readBoolean());var e=to(this);for(t=t||[];this.pos<e;)t.push(this.readBoolean());return t},readPackedFloat:function(t){if(this.type!==et.Bytes)return t.push(this.readFloat());var e=to(this);for(t=t||[];this.pos<e;)t.push(this.readFloat());return t},readPackedDouble:function(t){if(this.type!==et.Bytes)return t.push(this.readDouble());var e=to(this);for(t=t||[];this.pos<e;)t.push(this.readDouble());return t},readPackedFixed32:function(t){if(this.type!==et.Bytes)return t.push(this.readFixed32());var e=to(this);for(t=t||[];this.pos<e;)t.push(this.readFixed32());return t},readPackedSFixed32:function(t){if(this.type!==et.Bytes)return t.push(this.readSFixed32());var e=to(this);for(t=t||[];this.pos<e;)t.push(this.readSFixed32());return t},readPackedFixed64:function(t){if(this.type!==et.Bytes)return t.push(this.readFixed64());var e=to(this);for(t=t||[];this.pos<e;)t.push(this.readFixed64());return t},readPackedSFixed64:function(t){if(this.type!==et.Bytes)return t.push(this.readSFixed64());var e=to(this);for(t=t||[];this.pos<e;)t.push(this.readSFixed64());return t},skip:function(t){var e=t&7;if(e===et.Varint)for(;this.buf[this.pos++]>127;);else if(e===et.Bytes)this.pos=this.readVarint()+this.pos;else if(e===et.Fixed32)this.pos+=4;else if(e===et.Fixed64)this.pos+=8;else throw new Error("Unimplemented type: "+e)},writeTag:function(t,e){this.writeVarint(t<<3|e)},realloc:function(t){for(var e=this.length||16;e<this.pos+t;)e*=2;if(e!==this.length){var i=new Uint8Array(e);i.set(this.buf),this.buf=i,this.length=e}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(t){this.realloc(4),Sa(this.buf,t,this.pos),this.pos+=4},writeSFixed32:function(t){this.realloc(4),Sa(this.buf,t,this.pos),this.pos+=4},writeFixed64:function(t){this.realloc(8),Sa(this.buf,t&-1,this.pos),Sa(this.buf,Math.floor(t*z0),this.pos+4),this.pos+=8},writeSFixed64:function(t){this.realloc(8),Sa(this.buf,t&-1,this.pos),Sa(this.buf,Math.floor(t*z0),this.pos+4),this.pos+=8},writeVarint:function(t){if(t=+t||0,t>268435455||t<0){eP(t,this);return}this.realloc(4),this.buf[this.pos++]=t&127|(t>127?128:0),!(t<=127)&&(this.buf[this.pos++]=(t>>>=7)&127|(t>127?128:0),!(t<=127)&&(this.buf[this.pos++]=(t>>>=7)&127|(t>127?128:0),!(t<=127)&&(this.buf[this.pos++]=t>>>7&127)))},writeSVarint:function(t){this.writeVarint(t<0?-t*2-1:t*2)},writeBoolean:function(t){this.writeVarint(!!t)},writeString:function(t){t=String(t),this.realloc(t.length*4),this.pos++;var e=this.pos;this.pos=_P(this.buf,t,this.pos);var i=this.pos-e;i>=128&&D0(e,i,this),this.pos=e-1,this.writeVarint(i),this.pos+=i},writeFloat:function(t){this.realloc(4),Pd.write(this.buf,t,this.pos,!0,23,4),this.pos+=4},writeDouble:function(t){this.realloc(8),Pd.write(this.buf,t,this.pos,!0,52,8),this.pos+=8},writeBytes:function(t){var e=t.length;this.writeVarint(e),this.realloc(e);for(var i=0;i<e;i++)this.buf[this.pos++]=t[i]},writeRawMessage:function(t,e){this.pos++;var i=this.pos;t(e,this);var n=this.pos-i;n>=128&&D0(i,n,this),this.pos=i-1,this.writeVarint(n),this.pos+=n},writeMessage:function(t,e,i){this.writeTag(t,et.Bytes),this.writeRawMessage(e,i)},writePackedVarint:function(t,e){e.length&&this.writeMessage(t,nP,e)},writePackedSVarint:function(t,e){e.length&&this.writeMessage(t,sP,e)},writePackedBoolean:function(t,e){e.length&&this.writeMessage(t,aP,e)},writePackedFloat:function(t,e){e.length&&this.writeMessage(t,oP,e)},writePackedDouble:function(t,e){e.length&&this.writeMessage(t,rP,e)},writePackedFixed32:function(t,e){e.length&&this.writeMessage(t,lP,e)},writePackedSFixed32:function(t,e){e.length&&this.writeMessage(t,cP,e)},writePackedFixed64:function(t,e){e.length&&this.writeMessage(t,dP,e)},writePackedSFixed64:function(t,e){e.length&&this.writeMessage(t,hP,e)},writeBytesField:function(t,e){this.writeTag(t,et.Bytes),this.writeBytes(e)},writeFixed32Field:function(t,e){this.writeTag(t,et.Fixed32),this.writeFixed32(e)},writeSFixed32Field:function(t,e){this.writeTag(t,et.Fixed32),this.writeSFixed32(e)},writeFixed64Field:function(t,e){this.writeTag(t,et.Fixed64),this.writeFixed64(e)},writeSFixed64Field:function(t,e){this.writeTag(t,et.Fixed64),this.writeSFixed64(e)},writeVarintField:function(t,e){this.writeTag(t,et.Varint),this.writeVarint(e)},writeSVarintField:function(t,e){this.writeTag(t,et.Varint),this.writeSVarint(e)},writeStringField:function(t,e){this.writeTag(t,et.Bytes),this.writeString(e)},writeFloatField:function(t,e){this.writeTag(t,et.Fixed32),this.writeFloat(e)},writeDoubleField:function(t,e){this.writeTag(t,et.Fixed64),this.writeDouble(e)},writeBooleanField:function(t,e){this.writeVarintField(t,!!e)}};function JA(t,e,i){var n=i.buf,s,o;if(o=n[i.pos++],s=(o&112)>>4,o<128||(o=n[i.pos++],s|=(o&127)<<3,o<128)||(o=n[i.pos++],s|=(o&127)<<10,o<128)||(o=n[i.pos++],s|=(o&127)<<17,o<128)||(o=n[i.pos++],s|=(o&127)<<24,o<128)||(o=n[i.pos++],s|=(o&1)<<31,o<128))return QA(t,s,e);throw new Error("Expected varint not more than 10 bytes")}function to(t){return t.type===et.Bytes?t.readVarint()+t.pos:t.pos+1}function QA(t,e,i){return i?e*4294967296+(t>>>0):(e>>>0)*4294967296+(t>>>0)}function eP(t,e){var i,n;if(t>=0?(i=t%4294967296|0,n=t/4294967296|0):(i=~(-t%4294967296),n=~(-t/4294967296),i^4294967295?i=i+1|0:(i=0,n=n+1|0)),t>=18446744073709552e3||t<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");e.realloc(10),tP(i,n,e),iP(n,e)}function tP(t,e,i){i.buf[i.pos++]=t&127|128,t>>>=7,i.buf[i.pos++]=t&127|128,t>>>=7,i.buf[i.pos++]=t&127|128,t>>>=7,i.buf[i.pos++]=t&127|128,t>>>=7,i.buf[i.pos]=t&127}function iP(t,e){var i=(t&7)<<4;e.buf[e.pos++]|=i|((t>>>=3)?128:0),t&&(e.buf[e.pos++]=t&127|((t>>>=7)?128:0),t&&(e.buf[e.pos++]=t&127|((t>>>=7)?128:0),t&&(e.buf[e.pos++]=t&127|((t>>>=7)?128:0),t&&(e.buf[e.pos++]=t&127|((t>>>=7)?128:0),t&&(e.buf[e.pos++]=t&127)))))}function D0(t,e,i){var n=e<=16383?1:e<=2097151?2:e<=268435455?3:Math.floor(Math.log(e)/(Math.LN2*7));i.realloc(n);for(var s=i.pos-1;s>=t;s--)i.buf[s+n]=i.buf[s]}function nP(t,e){for(var i=0;i<t.length;i++)e.writeVarint(t[i])}function sP(t,e){for(var i=0;i<t.length;i++)e.writeSVarint(t[i])}function oP(t,e){for(var i=0;i<t.length;i++)e.writeFloat(t[i])}function rP(t,e){for(var i=0;i<t.length;i++)e.writeDouble(t[i])}function aP(t,e){for(var i=0;i<t.length;i++)e.writeBoolean(t[i])}function lP(t,e){for(var i=0;i<t.length;i++)e.writeFixed32(t[i])}function cP(t,e){for(var i=0;i<t.length;i++)e.writeSFixed32(t[i])}function dP(t,e){for(var i=0;i<t.length;i++)e.writeFixed64(t[i])}function hP(t,e){for(var i=0;i<t.length;i++)e.writeSFixed64(t[i])}function Ld(t,e){return(t[e]|t[e+1]<<8|t[e+2]<<16)+t[e+3]*16777216}function Sa(t,e,i){t[i]=e,t[i+1]=e>>>8,t[i+2]=e>>>16,t[i+3]=e>>>24}function O0(t,e){return(t[e]|t[e+1]<<8|t[e+2]<<16)+(t[e+3]<<24)}function uP(t,e,i){for(var n="",s=e;s<i;){var o=t[s],r=null,a=o>239?4:o>223?3:o>191?2:1;if(s+a>i)break;var l,c,d;a===1?o<128&&(r=o):a===2?(l=t[s+1],(l&192)===128&&(r=(o&31)<<6|l&63,r<=127&&(r=null))):a===3?(l=t[s+1],c=t[s+2],(l&192)===128&&(c&192)===128&&(r=(o&15)<<12|(l&63)<<6|c&63,(r<=2047||r>=55296&&r<=57343)&&(r=null))):a===4&&(l=t[s+1],c=t[s+2],d=t[s+3],(l&192)===128&&(c&192)===128&&(d&192)===128&&(r=(o&15)<<18|(l&63)<<12|(c&63)<<6|d&63,(r<=65535||r>=1114112)&&(r=null))),r===null?(r=65533,a=1):r>65535&&(r-=65536,n+=String.fromCharCode(r>>>10&1023|55296),r=56320|r&1023),n+=String.fromCharCode(r),s+=a}return n}function fP(t,e,i){return F0.decode(t.subarray(e,i))}function _P(t,e,i){for(var n=0,s,o;n<e.length;n++){if(s=e.charCodeAt(n),s>55295&&s<57344)if(o)if(s<56320){t[i++]=239,t[i++]=191,t[i++]=189,o=s;continue}else s=o-55296<<10|s-56320|65536,o=null;else{s>56319||n+1===e.length?(t[i++]=239,t[i++]=191,t[i++]=189):o=s;continue}else o&&(t[i++]=239,t[i++]=191,t[i++]=189,o=null);s<128?t[i++]=s:(s<2048?t[i++]=s>>6|192:(s<65536?t[i++]=s>>12|224:(t[i++]=s>>18|240,t[i++]=s>>12&63|128),t[i++]=s>>6&63|128),t[i++]=s&63|128)}return i}const mP=YA(qA),pP=1,T_={1:({pbf:t})=>t.readBoolean(),2:({pbf:t})=>t.readDouble(),3:({pbf:t})=>t.readString(),5:t=>{const{pbf:e}=t,i=e.readVarint(),n=new Array(i);for(let s=0;s<i;s++)n[s]=E_(t,e.readVarint());return n},4:t=>{const{pbf:e}=t,i=e.readVarint(),n={};for(let o=0;o<i;o++){var s=e.readVarint();n[t.keys[s>>3]]=E_(t,s&7)}return n},6:t=>null};function E_(t,e){const i=t.pbf;if(i.pos<i.length){const n=T_[e];if(!n)throw new Error(`Type ${e} is not supported`);return n(t)}}function B0(t){const e=t.readVarint(),i=[];for(let n=0;n<e;n++){const s=t.readString(),o=t.readVarint();i.push({key:s,type:o})}return i}function gP(t,e){if(!t||!t.byteLength||t.byteLength<4)throw new Error("Bad array or insufficient array length.");const i=new mP(t),n=i.readFixed32(),s=n>>24&255;if(s>pP)throw new Error(`Version ${s} is not supported`);const o=n>>16&255,r=o;if(o===1&&r!==1)throw new Error("Packed with PackMethod.Generic cannot be unpacked with anything than UnpackMethod.Generic");switch(r){case 1:const a=i.readFixed32();if(a>=t.byteLength)return;const l=i.pos;i.pos=a;const c=i.readVarint(),d=new Array(c);for(let u=0;u<c;u++)d[u]=i.readString();i.pos=l;const h=i.readVarint();return E_({keys:d,pbf:i},h);case 2:{const u={keys:[],pbf:i},f=i.readFixed32(),m=B0(i),p={};for(const{key:_,type:g}of m){const y=T_[g],b=[];for(let v=0;v<f;v++)b.push(y(u));p[_]=b}return p}case 3:{const u={keys:[],pbf:i},f=i.readFixed32(),m=B0(i),p=new Array(f);for(let _=0;_<f;_++)p[_]={};for(const{key:_,type:g}of m){const y=T_[g];for(let b=0;b<f;b++)p[b][_]=y(u)}return p}default:throw new Error(`Method ${r} is not supported`)}}function k0(t){const e=new __;if(t instanceof ArrayBuffer){const i=gP(t);if(Array.isArray(i))for(const{id:n,...s}of i)e.set(n,s);else for(const n in i)e.set(n,i[n])}else for(const i in t)e.set(i,t[i]);return e}class vP{constructor(e){this.scope=e,this.tileLoader=new vA,this.tileAttrs=[],this.models={},this.featureStateMap=new __}fetchTile(e,i=3){return this.tileLoader.fetch(e,i)}abortTileRequest(e){this.tileLoader.abortRequest(e)}generateTile(e,i){const{styleManager:n,collector:s,metatiles:o}=this.scope,{tileInfo:r,promoteAttributes:a,promoteId:l,isCustomZenithSource:c,modelShowHideEventsSublayers:d}=e,h=Ce(r.coords),u=this.tileLoader.get(h),f=[],m=[],p=[],_={};return u.forEach(g=>{var S;const{regionId:y,metatileHash:b}=g,v=this.scope.styleManager.getStyle(e.styleId);if(!v)return;if(e.areTileBoundsVisible&&e.isDefaultSource){const T=n.getStyle(Lo).layers.find(L=>L.id==="debug-tile-bounds");x0(s,T,e.styleState)}const I=PA(v,n,this.featureStateMap,s,e,g,o[b],this.tileAttrs,c,a,i,l,d);Object.assign(_,I.promotedObjectAttributes),f.push({regionId:y,metatileHash:b,collectorOutput:I,styleId:v.id}),p.push(...I.transferable),(S=I.debugGeoJsonData)==null||S.forEach(P=>m.push(P))}),this.scope.resetCollector(),this.scope.syncRasterSets(),Promise.resolve({results:f,transferable:p,promotedAttrs:Object.keys(_).length>0?_:void 0,geoJsonData:i?m:void 0})}deleteTile(e){this.tileLoader.delete(e)}setFeatureStateMap(e){this.featureStateMap=k0(e)}generateModel(e){const{regionId:i,metatileHash:n,styleId:s,url:o,id:r}=e,{styleManager:a}=this.scope;return new Promise(l=>{const c=this.models[r];(c?Promise.resolve(c):new Promise(h=>{f_({url:o},(u,f)=>{if(u||f.byteLength===0){const m=this.models[r]=new ArrayBuffer(0);h(m)}else this.models[r]=f,h(f)})})).then(h=>{if(h.byteLength===0){l({objects:this.scope.collector.getAccumulatedData(),textures:{isBitmap:!1,data:[]}});return}const u=this.scope.styleManager.getStyle(s);if(!u){l({objects:this.scope.collector.getAccumulatedData(),textures:{isBitmap:!1,data:[]}});return}const{objects:f,textures:m}=ZA(u,a,e.styleState,this.scope.collector,h,e,this.scope.metatiles[n],i,this.featureStateMap);if(this.scope.createImageBitmap){const p=m.map(_=>{const g=new Blob([_],{type:"image/png"});return createImageBitmap(g)});Promise.all(p).then(_=>{l({objects:f,textures:{isBitmap:!0,data:_},transferable:[...f.transferable,..._]}),this.scope.resetCollector()})}else l({objects:f,textures:{isBitmap:!1,data:m},transferable:[...f.transferable,h]}),this.scope.resetCollector()})})}destroy(){this.tileLoader.destroy(),this.tileAttrs=[],this.models={}}}function N0(t,e){if(e===void 0)return;if(e.sourceId){const n=t.getSourceById(e.sourceId);if(!(n!=null&&n.isIdentifiedAsDefault()))return}const i={id:e.id,symbol:e.symbol};return e.symbol==="point"&&(i.isText=e.instanceId===1),e.sublayer&&(i.isCityCommercial=ny(e.sublayer),i.isPremiumCommercial=sy(e.sublayer),i.isCommercial=rd(e.sublayer),i.isPersonal=lE(e.sublayer),(e.symbol==="point"&&!i.isCommercial||e.symbol==="gltfModel")&&(i.sysCode=e.objectClass)),e.center&&(i.center=Z.toGeo(e.center)),e.symbol==="gltfModel"&&(i.sublayer=e.sublayer,i.isCommercial=!!e.sublayer&&ry(e.sublayer)),i}function yP(t,e){if(e===void 0)return;if(e.sourceId){const n=t.getSourceById(e.sourceId);if(n)switch(n.type){case"geojson":{if(n.subtype==="internal"&&n instanceof Md||n.subtype==="viewport-internal"&&n instanceof Id)return{type:"geojson",id:n.isCustomPromoteId?e.id:void 0,feature:n.getFeatureById(e.id,e.tileKey),source:n};if(n.subtype==="external"&&n instanceof y0)return{type:"geojsonTile",getFeatureProperties:()=>e.tileKey===void 0?Promise.resolve():n.getObjectAttributes(e.id,e.tileKey),source:n}}case"zenith":if(n instanceof u_)return{type:"zenith",id:e.id,source:n,attributes:n.getObjectAttributes(e.tileKey??"",e.id)}}}const i={type:"default",id:e.id};return e.floorId&&(i.floorId=e.floorId),i}function Es(t,e,i,n,s){const o=s.camera,r=[0,0];if(o.unproject(n,r,!0),e&&e.dynamicObjectId!==void 0){const u=t;let f=s.layers.getDynamicObjectLayers().find(p=>p.uniqId===e.dynamicObjectId);if(f!=null&&f.parentObject&&(f=f==null?void 0:f.parentObject),!f)return;const m={lngLat:r,originalEvent:i,point:n,targetData:f};f.emit(u,m);return}const a=N0(s.sourceStorage,e),l=yP(s.sourceStorage,e);if((t==="mousedown"||t==="click")&&e!==void 0&&(a==null?void 0:a.symbol)==="point"&&l!==void 0){const u=bE(s,e,a)||{};u!==void 0&&(l.poiIcon=u)}if(e){const u=s.styleManager.getStyleLayer(e.styleId,e.layerId);u&&l&&(l.layerId=u.id)}const d={lngLat:r,originalEvent:i,point:n,target:a,targetData:l},h=t;s.map.emit(h,d)}class U0 extends Zi{constructor(e,i,n){super(e,i),this.start=s=>{const{modules:o,container:r}=this,{camera:a}=o;if(s.button!==0)return;const l=Ht(r,s.clientX,s.clientY);this.contains(l)&&(o.handler.block(),o.mouseMoveHandler.block(),this.dragStartCursorPoint=l,this.dragStartAnchorPoint=a.project(Z.toGeo(this.getPosition())),document.addEventListener("mouseup",this.stop),document.addEventListener("mousemove",this.move),this.emitEvent("dragstart",s))},this.move=s=>{const{camera:o}=this.modules,{dragStartAnchorPoint:r,dragStartCursorPoint:a,container:l}=this;if(r===void 0||a===void 0)return;const c=Ht(l,s.clientX,s.clientY),d=Kp(r);An(d,d,c),Ai(d,d,a),this.setPosition(Z.fromGeo(o.unproject(d))),this.emitEvent("drag",s)},this.stop=s=>{if(s.button!==0)return;this.dragStartCursorPoint=void 0,this.dragStartAnchorPoint=void 0,document.removeEventListener("mouseup",this.stop),document.removeEventListener("mousemove",this.move);const{modules:o}=this;o.handler.unblock(),o.mouseMoveHandler.unblock(),this.emitEvent("dragend",s),this.interactive&&o.identifier.resetCache()},this.container=e.modules.layout.mapContainer,n&&this.container.addEventListener("mousedown",this.start,!0)}destroy(){super.destroy(),this.container.removeEventListener("mousedown",this.start,!0),document.removeEventListener("mouseup",this.stop),document.removeEventListener("mousemove",this.move)}emitEvent(e,i){const n=this.getPosition(),s=Z.toGeo(n),o=this.modules.camera.flat.project(n),r=this.modules.identifier.searchSync(o),a=r!==void 0&&r.dynamicObjectId===void 0?N0(this.modules.sourceStorage,r):void 0;this.emit(e,{originalEvent:i,target:a,targetData:this,lngLat:s,point:o})}}const wP=!1;let A_=class extends U0{constructor(e,i){super(e,i,i.draggable??wP),this.visible=!0,this.options=i;const n=Z.fromGeo(this.options.coordinates);this.position={userValue:n,normalizedValue:Li(n)};const{dynamicStyle:s,collector:o,tileManager:r,identifier:a,layers:l}=this.modules;if(this.layer=_t({type:"circle",id:`dynamic-circleMarker-${this.uniqId}`,minzoom:this.options.minZoom,maxzoom:this.options.maxZoom,style:{color:this.options.color,strokeColor:this.options.borderColor,strokeColor2:this.options.border2Color,width:this.options.width,strokeWidth:this.options.borderWidth,strokeWidth2:this.options.border2Width}}),!this.layer)return;s.addLayer(this.layer,this.options.zIndex);const c=n[2]??0,d=Wn(this.position.normalizedValue),h=rs({}),u={x:[0],y:[0],z:[c]},f=Ye(d),m=di(this.mapState.styleState,un,yi,h,Hi,this.interactive?"0":"",f);Zt(this.layer,m),vt({collector:o,generator:da.generate,args:[s.getStyle().id,this.layer,m,u]});const p=o.getAccumulatedData(),_=new Ct("dynamicObject",p.data,this.modules,this.mapState,d);r.addObject(_),this.tileObjects.push(_),this.interactive&&this.identifyIds.push(p.identifyIds),l.addLayer(this),o.reset(),this.modules.renderer.addRerenderEvent(),this.interactive&&a.resetCache()}remove(){this.layer&&this.modules.dynamicStyle.removeLayer(this.layer.innerId),this.interactive&&this.modules.identifier.resetCache(),super.destroy()}update(){if(this.mapState.globeMode){const{tileManager:e}=this.modules,i=this.modules.camera.ecef.canSee(this.options.coordinates);this.visible&&!i?this.tileObjects.forEach(n=>e.removeObject(n)):!this.visible&&i&&this.tileObjects.forEach(n=>e.addObject(n)),this.visible=i}}isOutOfMainReplica(){return!1}setPosition(e){const i=this.tileObjects[0];i!==void 0&&(this.position={userValue:e,normalizedValue:Li(e)},i.setTileCoords(Wn(this.position.normalizedValue),this.mapState),this.modules.renderer.addRerenderEvent())}getPosition(){return this.position.userValue}contains(e){if(!this.layer)return!1;const{layer:i}=this,{camera:n}=this.modules,s=n.project(Z.toGeo(this.position.normalizedValue)),o=W(i.style.width,ut(this.mapState.styleZoom,this.mapState.styleState,[])),r=W(i.style.strokeWidth,ut(this.mapState.styleZoom,this.mapState.styleState,[])),a=o/2+r;return po(s,e)<=a}};function G0(t,e,i){const{top:n,right:s,bottom:o,left:r}=t.viewport,{clientWidth:a,clientHeight:l}=e;t.size=[Math.max(1,a-r-s),Math.max(1,l-n-o)],i.updateFrameBuffersSize()}const bP=(t,e,i,n,s={})=>{const o={top:0,right:0,bottom:0,left:0,...n};if(s.animate===!1||s.duration===0)t.viewport=o,G0(t,e,i);else{const r=t.viewport,a=s.easing!==void 0?s.easing:"easeOutCubic",l=s.duration!==void 0?s.duration:300;Bt("viewport",{easing:a},t,[r.top,r.right,r.bottom,r.left],[o.top,o.right,o.bottom,o.left],l,1)}},xP=(t,e,i)=>{kt("viewport",{step:(n,s)=>{n.viewport={top:s[0],right:s[1],bottom:s[2],left:s[3]},G0(n,e,i)}},t)};function SP(t,e){return{top:t.top+e.top,bottom:t.bottom+e.bottom,left:t.left+e.left,right:t.right+e.right}}function MP(t){return{top:Math.max(t.top,0),bottom:Math.max(t.bottom,0),left:Math.max(t.left,0),right:Math.max(t.right,0)}}function IP(t,e){return{top:Math.min(t.top,e[1]),bottom:Math.min(t.bottom,e[1]),left:Math.min(t.left,e[0]),right:Math.min(t.right,e[0])}}function TP(t,e){return IP(MP(t),e)}function j0(t,e){const{top:i,right:n,bottom:s,left:o}=t.padding;t.padding={top:i,right:n,bottom:s,left:o},e.addRerenderEvent(),e.updateFrameBuffersSize()}const EP=(t,e,i,n={})=>{const s=TP(i,t.size);if(n.animate===!1||n.duration===0)t.padding=s,j0(t,e);else{const o=t.padding,r=n.easing!==void 0?n.easing:"easeOutCubic",a=n.duration!==void 0?n.duration:300;Bt("padding",{easing:r},t,[o.top,o.right,o.bottom,o.left],[s.top,s.right,s.bottom,s.left],a,1)}},AP=(t,e)=>{kt("padding",{step:(i,n)=>{i.padding={top:n[0],right:n[1],bottom:n[2],left:n[3]},j0(i,e)}},t)},Cd="inertia",PP=(t,e,i)=>t*Math.pow(1-(i-e)/us.duration,us.nonLinearity),LP=(t,e,i,n,s)=>{Bt(Cd,{easing:"inertia"},t,0,s,us.duration,1,{startPoint:e,startSpeed:i,direction:n,startTime:t.time})},P_=yt.bind(null,Cd),CP=(t,e)=>{kt(Cd,{step:(i,n,s)=>{const{startPoint:o,startSpeed:r,startTime:a,direction:l}=s,c=Or(l);Ni(c,c,n),Ot(c,c,o),i.loopWorld?B2(i.maxBounds,c)||(L_(e,i),jr(c,i.maxBounds,c)):O2(i.maxBounds,c)||(L_(e,i),jr(c,i.maxBounds,c)),i.center=c,i.zoomTypePreserving==="zoom"?i.styleZoom=Xo(i.zoom,c):i.zoom=Ya(i.styleZoom,c);const d=PP(r,a,i.time);lg(d,i.zoom)<us.minSpeed&&L_(e,i)}},t)},L_=(t,e)=>{yt(Cd,e),t.classList.remove("mapgl-inertia")},Rd="center",yr=(t,e,i={})=>{if(yt(Rd,t),P_(t),jr(e,t.maxBounds,e),i.animate===!1||i.duration===0)t.center=e,t.zoomTypePreserving==="zoom"?t.styleZoom=Xo(t.zoom,e):t.zoom=Ya(t.styleZoom,e);else{const n=i.easing!==void 0?i.easing:"linear",s=i.duration!==void 0?i.duration:250;Bt(Rd,{easing:n},t,t.center,e,s,1)}},RP=yt.bind(null,Rd),zP=kt.bind(null,Rd,{step:(t,e)=>{t.center=e,t.zoomTypePreserving==="zoom"?t.styleZoom=Xo(t.zoom,e):t.zoom=Ya(t.styleZoom,e)}}),zd="rotation";function C_(t,e){return t=t-e,t>=Math.PI?t=(t+Math.PI)%(Math.PI*2)-Math.PI:t<-Math.PI&&(t=Math.PI-(Math.PI-t)%(Math.PI*2)),t=t+e,t}function Dl(t,e,i={}){if(yt(zd,t),i.animate===!1||i.duration===0)t.rotation=C_(e,0);else{const n=i.normalize!==void 0?i.normalize:!0;Bt(zd,{easing:i.easing||"linear"},t,t.rotation,n?C_(e,t.rotation):e,i.duration||250,1)}}const FP=yt.bind(null,zd),DP=kt.bind(null,zd,{step:(t,e)=>t.rotation=C_(e,0)}),Fd="pitch";function Dd(t,e,i={}){yt(Fd,t);const n=Be(e,t.minPitch,t.maxPitch);i.animate===!1||i.duration===0?t.pitch=n:Bt(Fd,{easing:i.easing||"linear"},t,t.pitch,n,i.duration||300,1)}const OP=yt.bind(null,Fd),BP=kt.bind(null,Fd,{step:(t,e)=>t.pitch=e}),Od="zoom",io=(t,e,i={})=>{yt(Od,t);const n=Be(e,t.minZoom,t.maxZoom);if(n!==t.zoom)if(i.animate===!1||i.duration===0)i.zoomPoint&&(Ot(t.center,t.center,qa(t,i.zoomPoint,{zoom:n})),jr(t.center,t.maxBounds,t.center)),t.zoom=n,t.styleZoom=Xo(n,t.center);else{const s=i.useHeightForAnimation?Wo(t.zoom,t.size):t.zoom,o=i.useHeightForAnimation?Wo(n,t.size):n,r=i.easing!==void 0?i.easing:"easeOutCubic",a=i.duration!==void 0?i.duration:250;Bt(Od,{easing:r},t,s,o,a,1,{zoomPoint:i.zoomPoint,useHeightForAnimation:!!i.useHeightForAnimation})}},V0=yt.bind(null,Od),kP=kt.bind(null,Od,{step:(t,e,i={})=>{const n=i&&i.useHeightForAnimation?N2(e,t.size):e;i&&i.zoomPoint&&(Ot(t.center,t.center,qa(t,i.zoomPoint,{zoom:n})),jr(t.center,t.maxBounds,t.center)),t.zoom=n,t.styleZoom=Xo(n,t.center)}}),NP=navigator.msPointerEnabled&&navigator.msMaxTouchPoints&&!window.PointerEvent,UP=window.PointerEvent&&navigator.pointerEnabled&&navigator.maxTouchPoints||NP||"ontouchstart"in window||window.DocumentTouch&&document instanceof window.DocumentTouch,GP=wr("webkit"),jP=wr("chrome")||wr("crios"),VP="ActiveXObject"in window,HP=!jP&&wr("safari");wr("gecko")&&!GP&&window.opera;const Bd=navigator.platform.toUpperCase().indexOf("MAC")>=0,ZP=wr("windows"),$P=wr("firefox");function wr(t){return navigator.userAgent.toLowerCase().indexOf(t)>=0}function br(t,e){let i=!1,n;function s(){i=!1,n&&(o(...n),n=!1)}function o(...r){i?n=r:(t(...r),setTimeout(s,e),i=!0)}return o}function As(t){V0(t),RP(t),FP(t),OP(t),P_(t)}class WP{constructor(e,i){this.onWheelScroll=n=>{n.preventDefault(),!(n.deltaMode===void 0&&n.deltaY===void 0)&&(this.state.userHasInteracted=!0,this.screenPoint=Ht(this.container,n.clientX,n.clientY),n.ctrlKey?this.deltaAccumulator-=n.deltaY*10:n.deltaMode===1?this.deltaAccumulator-=n.deltaY*20:this.deltaAccumulator-=n.deltaY,this.eventCount+=1)},this.startZooming=()=>{const n=this.state;let s=this.getDelta();Bd?s*=an.macWheelDeltaToZoomDelta:Number.isInteger(s)?s=gc(s)*an.wheelZoomDelta:s*=an.notMacTrackpadDeltaToZoomDelta;const o=n.zoom+s,r=Be(o,n.minZoom,n.maxZoom);r!==n.zoom&&(As(n),io(n,r,{duration:an.animDuration,animate:!Bd,zoomPoint:n.keepCenterWhileUserZoomRotate?void 0:this.screenPoint}))},this.stop=()=>{this.state.userHasInteracted=!0,V0(this.state)},this.state=e,this.container=i,Bd||(this.startZooming=br(this.startZooming,an.throttleDelay)),this.deltaAccumulator=0,this.eventCount=0,this.screenPoint=[0,0],this.container.addEventListener("wheel",this.onWheelScroll),this.container.addEventListener("mousedown",this.stop)}destroy(){this.container.removeEventListener("wheel",this.onWheelScroll),this.container.removeEventListener("mousedown",this.stop)}update(){this.eventCount!==0&&(this.startZooming(),this.state.rerenderEvents.push({type:"coreNeedRerender"}))}getDelta(){const e=this.deltaAccumulator/this.eventCount;return this.deltaAccumulator=0,this.eventCount=0,e}}class XP{constructor(e,i){this.onMouseUp=n=>{n.which===1&&this.start()},this.onTouchEnd=n=>{n.touches.length===0&&this.start()},this.start=()=>{const n=this.state;n.userHasInteracted=!0;const s=this.getCurrentSpeed(n.time),o=fo(s);if(lg(o,n.zoom)<=us.minSpeed)return;const a=mu(us.maxSpeed,n.zoom),l=Math.min(o,a),c=this.calcDistanceByStartSpeed(l),d=Or(n.center),h=Oe();Ui(h,s),LP(n,d,l,h,c),this.container.classList.add("mapgl-inertia")},this.stop=()=>{P_(this.state),this.container.classList.remove("mapgl-inertia"),this.times=[],this.positions=[]},this.state=e,this.container=i,this.container.addEventListener("mouseup",this.onMouseUp),this.container.addEventListener("mousedown",this.stop),UP&&(this.container.addEventListener("touchend",this.onTouchEnd),this.container.addEventListener("touchstart",this.stop)),this.zoomDiffer=new Et([{path:"zoom",type:"number"}]),this.styleZoomDiffer=new Et([{path:"styleZoom",type:"number"}]),this.centerDiffer=new Et([{path:"center",type:"vec2"}]),this.times=[],this.positions=[]}destroy(){this.container.removeEventListener("mouseup",this.onMouseUp),this.container.removeEventListener("mousedown",this.stop),this.container.removeEventListener("touchend",this.onTouchEnd),this.container.removeEventListener("touchstart",this.stop)}update(){const e=this.state;this.centerDiffer.check(e)&&this.rememberTimeAndPosition(e),(e.zoomTypePreserving==="zoom"?this.zoomDiffer.check(e):this.styleZoomDiffer.check(e))&&this.stop()}removeOldRecords(e){for(;e-this.times[0]>100&&this.times.length;)this.times.shift(),this.positions.shift()}rememberTimeAndPosition(e){const i=e.time;this.removeOldRecords(i),this.times.push(i),this.positions.push(Or(e.center))}getCurrentSpeed(e){if(this.removeOldRecords(e),this.times.length<2)return Oe();const i=Or(this.positions[this.positions.length-1]);return vi(i,i,this.positions[0]),Ni(i,i,1/(this.times[this.times.length-1]-this.times[0])),i}calcDistanceByStartSpeed(e){return e*us.duration/(us.nonLinearity+1)}}class YP{constructor(e){this.emitMouseEvent=i=>{const n=Ht(this.container,i.clientX,i.clientY);this.emitEvent(i,n)},this.emitTouchEvent=i=>{const n=Ht(this.container,i.changedTouches[0].clientX,i.changedTouches[0].clientY);this.emitEvent(i,n)},this.container=e.layout.mapContainer,this.modules=e,this.container.addEventListener("mouseup",this.emitMouseEvent),this.container.addEventListener("touchend",this.emitTouchEvent)}destroy(){this.container.removeEventListener("mouseup",this.emitMouseEvent),this.container.removeEventListener("touchend",this.emitTouchEvent)}update(){}emitEvent(e,i){if(!this.modules.layout.isActionWithCanvas(e))return;const n=e.type;this.modules.identifier.search(n,i).then(s=>{Es(n,s,e,i,this.modules)})}}class qP{constructor(e,i,n){this.rotationDetected=!1,this.onGestureStart=s=>{s.preventDefault(),this.startRotation=this.state.rotation,this.rotationDetected=!1,this.gestureRotation=0,this.isGestureStart=!0,this.startZoom=this.state.zoom,this.screenPoint=Ht(this.container,s.clientX,s.clientY),this.state.userHasInteracted=!0,this.state.disableRotationByUserInteraction||this.container.classList.add("mapgl-rotating"),this.map.emit("interactionstart",{target:"zoom/rotation"})},this.onGestureEnd=s=>{s.preventDefault(),this.isGestureStart&&(this.isGestureStart=!1,this.state.userHasInteracted=!0,this.container.classList.remove("mapgl-rotating"),this.map.emit("interactionend",{target:"zoom/rotation"}))},this.onGestureChange=s=>{if(s.preventDefault(),this.state.userHasInteracted=!0,s.scale>1?this.gestureZoom=s.scale-1:this.gestureZoom=-1/s.scale+1,this.state.disableRotationByUserInteraction)return;const o=ve(s.rotation);!this.rotationDetected&&Math.abs(o)>this.state.touchRotationThreshold&&(this.rotationDetected=!0,this.startRotation=this.state.rotation-o),this.rotationDetected&&(this.gestureRotation=o)},this.state=e,this.container=i,this.map=n,this.isGestureStart=!1,this.gestureRotation=0,this.gestureZoom=0,this.screenPoint=[0,0],this.startRotation=0,this.startZoom=0,this.container.addEventListener("gesturestart",this.onGestureStart),this.container.addEventListener("gestureend",this.onGestureEnd),this.container.addEventListener("gesturechange",this.onGestureChange)}destroy(){this.container.removeEventListener("gesturestart",this.onGestureStart),this.container.removeEventListener("gestureend",this.onGestureEnd),this.container.removeEventListener("gesturechange",this.onGestureChange)}update(){if(this.gestureRotation===0&&this.gestureZoom===0)return;const e=this.state,i=this.startZoom+this.gestureZoom,n=this.startRotation+this.gestureRotation,s=Oe(),o=e.keepCenterWhileUserZoomRotate?Oe():qa(e,this.screenPoint,{zoom:i,rotation:n});Ot(s,e.center,o),As(e),yr(e,s,{animate:!1}),io(e,i,{animate:!1}),e.disableRotationByUserInteraction||Dl(e,n,{animate:!1}),this.gestureRotation=0,this.gestureZoom=0}}class KP extends Qo{constructor(e,i){super(),this.startRenderTime=0,this.catchNextUpdate=!1,this.durations=[],this.badDurations=[],this.countToCheck=75,this.slowFrameTime=100,this.mapState=e,this.mapModules=i,this.originalMapState={center:this.mapState.center.slice(),zoom:this.mapState.zoom,rotation:this.mapState.rotation,pitch:this.mapState.pitch}}update(){const{time:e,needRerender:i,rerenderEvents:n}=this.mapState,s=e-this.startRenderTime;this.catchNextUpdate&&(this.durations.push(s),s>=this.slowFrameTime&&this.badDurations.push(s),this.catchNextUpdate=!1),(i||n.length>0)&&(this.startRenderTime=e,this.catchNextUpdate=!0),this.durations.length>this.countToCheck&&this.check()}getFpsStats(){const e=this.durations.map(o=>1e3/o),i=this.badDurations.map(o=>1e3/o),n=hg(this.originalMapState.center,this.mapState.center)&&this.originalMapState.pitch===this.mapState.pitch&&this.originalMapState.rotation===this.mapState.rotation&&this.originalMapState.zoom===this.mapState.zoom;return{all:{min:e.length>0?Math.min(...e):0,max:e.length>0?Math.max(...e):0,avg:e.length>0?e.reduce((o,r)=>o+r)/e.length:0,count:e.length},bad:{min:i.length>0?Math.min(...i):0,max:i.length>0?Math.max(...i):0,avg:i.length>0?i.reduce((o,r)=>o+r)/i.length:0,count:i.length},isStatic:n}}async getMemoryStats(){const e=await this.getJsMemoryStats(),i=await this.getGpuMemoryStats();return{cpu:e,gpu:i}}check(){const e=JP(this.durations);this.emit("fps",e),e<zp.fpsCaveat&&(this.mapState.performanceCaveatEmitted=!0,this.emit("performancecaveat")),this.durations=[],this.badDurations=[],this.countToCheck=Math.min(1e3,this.countToCheck*2)}async getJsMemoryStats(){const e=await s0(this.mapModules);return Object.values(e).filter(s=>!!s.js).map(s=>s.js).reduce((s,o)=>s+o["--sum"],0)}async getGpuMemoryStats(){const e=await s0(this.mapModules);return Object.values(e).filter(s=>!!s.gpu).map(s=>s.gpu).reduce((s,o)=>s+o["--sum"],0)}}function JP(t){t.sort((i,n)=>i-n);const e=t[Math.floor(t.length*3/4)];return Math.round(1e3/e)}class QP{constructor(){this.differ=new Et([{path:"center",type:"vec2"},{path:"zoom",type:"number"},{path:"rotation",type:"number"},{path:"pitch",type:"number"}]),this.debouncedSet=Fl(e=>{Bt("stillness",{},e,e.stillness,1,400,1)},100,!1),this.stillnessTickerUpdate=kt.bind(null,"stillness",{step:(e,i)=>{e.stillness=i}})}update(e){this.differ.check(e)&&(e.stillness=0,yt("stillness",e),this.debouncedSet(e)),this.stillnessTickerUpdate(e)}}class eL{constructor(e){this.onTouchStart=()=>{this.isTouchStartEmitted=!0},this.onMouseOut=i=>{if(!this.prevGeo)return;const n=Ht(this.container,i.clientX,i.clientY);Es("mouseout",this.prevGeo,i,n,this.modules),this.prevGeo=void 0,this.skipIdentifyEvents=!0,this.modules.defaultSource.resetHoverId(),this.container.classList.remove("mapgl-hover")},this.onMouseMove=i=>{if(this.isTouchStartEmitted){this.isTouchStartEmitted=!1;return}if(this.skipIdentifyEvents=!1,this.isBlocked)return;const n=Ht(this.container,i.clientX,i.clientY);Promise.resolve().then(()=>this.modules.layout.isActionWithCanvas(i)?this.modules.identifier.search("mouseMove",n):void 0).then(s=>{if(this.skipIdentifyEvents)return;const o=s&&this.prevGeo&&(s.id!==this.prevGeo.id||s.instanceId!==this.prevGeo.instanceId||s.dynamicObjectId!==this.prevGeo.dynamicObjectId||s.symbol!==this.prevGeo.symbol);this.prevGeo&&(!s||o)&&(Es("mouseout",this.prevGeo,i,n,this.modules),this.prevGeo=void 0,this.container.classList.remove("mapgl-hover"),this.modules.defaultSource.resetHoverId()),s&&(!this.prevGeo||o)&&(this.prevGeo=s,this.container.classList.add("mapgl-hover"),Es("mouseover",s,i,n,this.modules),this.modules.defaultSource.setHoverId(s.id)),Es("mousemove",s,i,n,this.modules)})},this.modules=e,this.isTouchStartEmitted=!1,this.skipIdentifyEvents=!1,this.isBlocked=!1,this.prevGeo=void 0,this.container=this.modules.layout.mapContainer,this.container.addEventListener("touchstart",this.onTouchStart),this.container.addEventListener("mousemove",this.onMouseMove),this.container.addEventListener("mouseout",this.onMouseOut)}destroy(){this.container.removeEventListener("touchstart",this.onTouchStart),this.container.removeEventListener("mousemove",this.onMouseMove),this.container.removeEventListener("mouseout",this.onMouseOut)}update(){}block(){this.isBlocked=!0}unblock(){this.isBlocked=!1}}const H0=(t,e,i,n)=>{yt("buildingHeight"+n,t),i.animate===!1||i.duration===0?(e.set(n,i.to),t.needLabeling=!0):Bt("buildingHeight"+n,{easing:i.easing},t,i.from,i.to,i.duration,1)},tL=(t,e,i)=>kt.call(null,"buildingHeight"+i,{step:(n,s)=>e.set(i,s),complete:n=>n.needLabeling=!0},t),iL=16;class nL{constructor(e,i){this.state=e,this.modules=i,this.buildingHeights=new Map,this.minZoomBuildingHeight=1/0}getBuildingHeight(e){return e===-1/0?1:e!==void 0?(this.buildingHeights.has(e)||this.addBuildingHeightZoom(e),this.buildingHeights.get(e)||0):this.getDefaultBuildingHeight()}update(){this.buildingHeights.forEach((e,i)=>{this.updateByZoom(i,e),this.isAnimating()&&tL(this.state,this.buildingHeights,i)})}isAnimating(){return Array.from(this.buildingHeights.keys()).some(e=>Al("buildingHeight"+e,this.state)!==void 0)}clearBuildingHeights(){this.buildingHeights.clear(),this.minZoomBuildingHeight=1/0}getDefaultBuildingHeight(){const e=this.minZoomBuildingHeight!==1/0?this.minZoomBuildingHeight:iL;return this.state.styleZoom<e?0:1}updateByZoom(e,i){const n=this.state,s=Al("buildingHeight"+e,n),o=s!==void 0?s.to:i;n.styleZoom>=e&&this.modules.tileManager.viewportTilesReady()&&o!==1?H0(n,this.buildingHeights,{animate:!0,easing:Go.easing,from:i,to:1,duration:Go.duration*(1-i)},e):n.styleZoom<e&&o!==0&&H0(n,this.buildingHeights,{animate:!1,to:0},e)}addBuildingHeightZoom(e){const i=e<this.state.styleZoom?0:1;this.buildingHeights.set(e,i),this.minZoomBuildingHeight>e&&(this.minZoomBuildingHeight=e)}}const kd=.8;class sL{constructor(e,i){this.offset=0,this.stride=i,this.buffer=new ArrayBuffer(e),this.view=new Int32Array(this.buffer),this.comittedOffsets=0,this.maximum=e/i,this.watermark=this.maximum*kd}extend(){const e=this.buffer.byteLength*2;this.maximum=e/this.stride,this.watermark=this.maximum*kd;const i=new ArrayBuffer(e),n=new Int32Array(i);return n.set(this.view),this.buffer=i,this.view=n,i}}class oL{constructor(e){this.offset=0,this.buffer=new Int32Array(e),this.comittedOffsets=0,this.watermark=e*kd}extend(){const e=this.buffer.length*2;this.watermark=e*kd;const i=new Int32Array(e);i.set(this.buffer),this.buffer=i}}class Z0{constructor(e,i,n,s,o,r){this.objectsData={},this.extents=new Uint16Array([rt,rt,rt,0,0,0]),this.maxDiag=0,this.drawMode=o;const a=e!=="buildingModel"?67200:67200*5,l=El(e,i);this.elements=new sL(a,l),this.indices=new oL(a*2/l),this.views={},this.binder=s,s(this,this.elements.buffer),this.attributes=n,this.key=r}static generateKey(e){return JSON.stringify(e)}resetOffsets(){this.elements.offset=0,this.elements.comittedOffsets=0,this.indices.offset=0,this.indices.comittedOffsets=0}resetBuildingsData(){this.objectsData={}}resetInstancesExtents(){this.extents[0]=rt,this.extents[1]=rt,this.extents[2]=rt,this.extents[3]=0,this.extents[4]=0,this.extents[5]=0,this.maxDiag=0}commit(){this.elements.comittedOffsets=this.elements.offset,this.indices.comittedOffsets=this.indices.offset}rollback(){this.elements.offset=this.elements.comittedOffsets,this.indices.offset=this.indices.comittedOffsets}checkWatermarks(){let e=0;const i=this.elements;i.offset>i.watermark&&(i.offset>=i.buffer.byteLength/i.stride&&(e=1),this.binder(this,i.extend()));const n=this.indices;return n.offset>n.watermark&&(n.offset>=n.buffer.length&&(e=1),n.extend()),e}}function en(t,e,i){i=i||{},this.w=t||64,this.h=e||64,this.autoResize=!!i.autoResize,this.shelves=[],this.freebins=[],this.stats={},this.bins={},this.maxId=0}en.prototype.pack=function(t,e){t=[].concat(t),e=e||{};for(var i=[],n,s,o,r,a=0;a<t.length;a++)if(n=t[a].w||t[a].width,s=t[a].h||t[a].height,o=t[a].id,n&&s){if(r=this.packOne(n,s,o),!r)continue;e.inPlace&&(t[a].x=r.x,t[a].y=r.y,t[a].id=r.id),i.push(r)}return this.shrink(),i},en.prototype.packOne=function(t,e,i){var n={freebin:-1,shelf:-1,waste:1/0},s=0,o,r,a,l;if(typeof i=="string"||typeof i=="number"){if(o=this.getBin(i),o)return this.ref(o),o;typeof i=="number"&&(this.maxId=Math.max(i,this.maxId))}else i=++this.maxId;for(l=0;l<this.freebins.length;l++){if(o=this.freebins[l],e===o.maxh&&t===o.maxw)return this.allocFreebin(l,t,e,i);e>o.maxh||t>o.maxw||e<=o.maxh&&t<=o.maxw&&(a=o.maxw*o.maxh-t*e,a<n.waste&&(n.waste=a,n.freebin=l))}for(l=0;l<this.shelves.length;l++)if(r=this.shelves[l],s+=r.h,!(t>r.free)){if(e===r.h)return this.allocShelf(l,t,e,i);e>r.h||e<r.h&&(a=(r.h-e)*t,a<n.waste&&(n.freebin=-1,n.waste=a,n.shelf=l))}if(n.freebin!==-1)return this.allocFreebin(n.freebin,t,e,i);if(n.shelf!==-1)return this.allocShelf(n.shelf,t,e,i);if(e<=this.h-s&&t<=this.w)return r=new R_(s,this.w,e),this.allocShelf(this.shelves.push(r)-1,t,e,i);if(this.autoResize){var c,d,h,u;return c=d=this.h,h=u=this.w,(h<=c||t>h)&&(u=Math.max(t,h)*2),(c<h||e>c)&&(d=Math.max(e,c)*2),this.resize(u,d),this.packOne(t,e,i)}return null},en.prototype.allocFreebin=function(t,e,i,n){var s=this.freebins.splice(t,1)[0];return s.id=n,s.w=e,s.h=i,s.refcount=0,this.bins[n]=s,this.ref(s),s},en.prototype.allocShelf=function(t,e,i,n){var s=this.shelves[t],o=s.alloc(e,i,n);return this.bins[n]=o,this.ref(o),o},en.prototype.shrink=function(){if(this.shelves.length>0){for(var t=0,e=0,i=0;i<this.shelves.length;i++){var n=this.shelves[i];e+=n.h,t=Math.max(n.w-n.free,t)}this.resize(t,e)}},en.prototype.getBin=function(t){return this.bins[t]},en.prototype.ref=function(t){if(++t.refcount===1){var e=t.h;this.stats[e]=(this.stats[e]|0)+1}return t.refcount},en.prototype.unref=function(t){return t.refcount===0?0:(--t.refcount===0&&(this.stats[t.h]--,delete this.bins[t.id],this.freebins.push(t)),t.refcount)},en.prototype.clear=function(){this.shelves=[],this.freebins=[],this.stats={},this.bins={},this.maxId=0},en.prototype.resize=function(t,e){this.w=t,this.h=e;for(var i=0;i<this.shelves.length;i++)this.shelves[i].resize(t);return!0};function R_(t,e,i){this.x=0,this.y=t,this.w=this.free=e,this.h=i}R_.prototype.alloc=function(t,e,i){if(t>this.free||e>this.h)return null;var n=this.x;return this.x+=t,this.free-=t,new rL(i,n,this.y,t,e,t,this.h)},R_.prototype.resize=function(t){return this.free+=t-this.w,this.w=t,!0};function rL(t,e,i,n,s,o,r){this.id=t,this.x=e,this.y=i,this.w=n,this.h=s,this.maxw=o||n,this.maxh=r||s,this.refcount=0}class aL{constructor(){this.packer=new en(Gt[0],Gt[1]),this.currentAtlasIndex=0,this.packedRasters=[],this.rastersToLoad=[],this.newRasterSets=new Map}addNewRasterSet(e,i){let n=this.newRasterSets.get(e);n||(n=[],this.newRasterSets.set(e,n)),n.push(i)}pack(e,i,n){e.isSvg?this.packSvg(e,i.map(s=>({w:s,h:s})),n):this.packPng(e,i,n)}packSvg(e,i,n){const{rasters:s}=e,o=new Set;for(const{w:r,h:a}of s)o.add(`${r}_${a}`);for(const r of i){const a=r.w*n,l=r.h*n;if(o.has(`${a}_${l}`))continue;let c=this.packer.packOne(a+2,l+2);c===null&&(this.packer=new en(Gt[0],Gt[1]),this.currentAtlasIndex++,c=this.packer.packOne(a+2,l+2));const d=s.length,h={rasterSetIndex:e.index,rasterIndex:d,w:a,h:l,x:c.x+1,y:c.y+1,anchorX:e.anchorX,anchorY:e.anchorY,atlasIndex:this.currentAtlasIndex,isPacked:!0};s.push(h),this.packedRasters.push(e.index,d,h.x,h.y,h.w,h.h,this.currentAtlasIndex)}}addRastersToLoad(e,i){this.rastersToLoad.push(e,i.rasterSetIndex,i.rasterIndex)}getNewRasterSets(){const e=this.newRasterSets;return this.newRasterSets=new Map,e}getPackedRasters(){if(this.packedRasters.length===0)return;const e=new Uint16Array(this.packedRasters);return this.packedRasters=[],e}getRastersToLoad(){const e=new Float64Array(this.rastersToLoad);return this.rastersToLoad=[],e}packPng(e,i,n){const{rasters:s}=e;for(const o of i){const r=o*n,a=ma(s,r,!1);if(a===void 0)continue;const l=e.rasters[a];if(l.isPacked)continue;let c=this.packer.packOne(l.w+2,l.h+2);c===null&&(this.packer=new en(Gt[0],Gt[1]),this.currentAtlasIndex++,c=this.packer.packOne(l.w+2,l.h+2)),l.x=c.x+1,l.y=c.y+1,l.atlasIndex=this.currentAtlasIndex,l.isPacked=!0,this.packedRasters.push(e.index,a,l.x,l.y,l.w,l.h,this.currentAtlasIndex)}}}const lL=2**32-1;class cL{constructor(){this.colorById=new Map,this.index=0}getIndex(e){if(!e)return this.nextIndex();const i=this.colorById.get(e);if(i!==void 0)return i;const n=this.nextIndex();return this.colorById.set(e,n),n}nextIndex(){return++this.index%lL}}const $0=2**20,W0=["main","parser","labeling","models"],z_={};for(let t=0;t<W0.length;t++){const e=W0[t];z_[e]={min:1+t*$0,max:(t+1)*$0}}class dL{constructor(e){this.atlasPacker=new aL,this.pointIndexer=new cL,this.floorHidingMap=new Map,this.usedModels=new Set,this.dataModels={},this.promotedObjectAttributes={},this.addedBuckets=[],this.labels=[],this.idIndexer=new zT(e),this.workerName=e,this.dataModelsIndex=z_[e].min,this.buckets={},this.geoJsonData=[],this.reset()}reset(){this.buckets={},this.geoJsonData=[],this.addedBuckets=[],this.floorHidingMap.clear(),this.labels=[],this.usedModels.clear()}getStatsAfterReset(){return{buckets:Object.keys(this.buckets).length,geoJsonData:this.geoJsonData.length,addedBuckets:this.addedBuckets.length,floorHidingMap:this.floorHidingMap.size,labels:this.labels.length,usedModels:this.usedModels.size}}addLabel(e){this.labels.push(e)}addUsedModel(e){this.usedModels.add(e)}getIndexerStats(){return this.idIndexer.getIndexerStats()}getBucketsMemoryFootprint(){return Object.keys(this.buckets).map(e=>{const i=e,n=this.buckets[i];return n?{[e]:Object.keys(n).map(s=>{const o=n[s];if(o&&typeof o=="object"){const r=Object.keys(o).map(a=>{const l=o[a];if(l&&l.elements&&l.elements.buffer)return{elementsBuffer:l.elements.buffer.byteLength,indices:l.indices.buffer.byteLength}});return{[s]:r}}return{[s]:0}})}:{[e]:[]}})}addPromotedObjectAttributes(e,i){this.promotedObjectAttributes[e]=i}addFeature(e){this.geoJsonData.push(e)}addUsedModelByUrl(e){const i=this.dataModels[e];if(i!==void 0)return i;const{min:n,max:s}=z_[this.workerName];this.dataModelsIndex=n+(this.dataModelsIndex+1-n)%(s-n);const o=-this.dataModelsIndex;return this.dataModels[e]=o,o}getDataModelsUrls(){const e={};for(const i in this.dataModels)this.usedModels.has(this.dataModels[i])&&(e[i]=this.dataModels[i]);return e}getBucket(e,i,n,s,o=Ua){let r=this.buckets[e];r===void 0&&(r={},this.buckets[e]=r);let a=r[i];a===void 0&&(a=r[i]={});const l=Z0.generateKey(n),c=a[l];if(c)return this.addedBuckets.push(c),c;const d=new Z0(e,i,n,s,o,l);return a[l]=d,this.addedBuckets.push(d),d}isOverloaded(){const e=this.addedBuckets;let i=0,n=0;for(;n<e.length;)i=i+e[n++].checkWatermarks();const s=i>0;if(s)for(;n--;)e[n].rollback();else for(;n--;)e[n].commit();return e.length=0,s}addFloorHidingMap(e,i){let n=this.floorHidingMap.get(i);n===void 0&&(n=[],this.floorHidingMap.set(i,n)),n.push(e)}getAccumulatedData(){const e=this.buckets,i=[],n=[];for(const u in e){const f=u,m=e[f];for(const p in m){const _=p,g=m[_],y=El(f,_)/4;let b=0;for(const P in g)b+=g[P].indices.offset;if(b===0)continue;const v=[],I=new Int32Array(b*y);let S=0;for(const P in g){const T=g[P],{elements:L,indices:B,attributes:O,meta:w,objectsData:x,extents:C,maxDiag:V}=T,{view:M}=L,{buffer:A}=B;if(L.offset===0)continue;const E=S,k={};for(let D=0;D<B.offset;D++){const U=x?x[D]:null;if(U){const G=S/y;hL(U,G,k)}const N=A[D]*y;for(let G=0;G<y;G++)I[S++]=M[N+G]}v.push({attributes:O,drawMode:T.drawMode,rangeStart:E*4,rangeEnd:S*4,meta:w,objectsData:Object.keys(k).length>0?k:void 0,extents:new Uint16Array(C),maxDiag:V}),T.resetOffsets(),T.resetBuildingsData(),T.resetInstancesExtents(),T.meta=void 0}i.push({symbol:f,sink:_,buffer:I.buffer,generatedObjects:v}),n.push(I.buffer)}}const s=this.idIndexer.getPacked();n.push(s.centerBuffer),n.push(s.instanceIdBuffer),n.push(s.layerIdBuffer),n.push(s.objectClassBuffer),n.push(s.phaseBuffer),n.push(s.styleIdBuffer),n.push(s.sublayerBuffer);const o=this.atlasPacker.getPackedRasters();o!==void 0&&n.push(o.buffer);const r=this.atlasPacker.getRastersToLoad();n.push(r.buffer);const a=this.getDataModelsUrls();this.usedModels=new Set;const l=this.floorHidingMap;this.floorHidingMap=new Map;const c=this.labels;this.labels=[];const d=this.promotedObjectAttributes;this.promotedObjectAttributes={};const h=this.geoJsonData.length?this.geoJsonData:void 0;return this.geoJsonData=[],{data:i,labels:c,floorHidingMap:l,packedRasters:o,rastersToLoad:r,dataModelsUrls:a,identifyIds:s,transferable:n,promotedObjectAttributes:d,debugGeoJsonData:h}}}function hL(t,e,i){const n=t.objectId;i[n]||(i[n]=[]);let s=!1;for(const o of i[n]){const r=o.offset+o.size,a=e+t.size;(o.offset<=e&&r>=e||e<=o.offset&&a>=o.offset)&&(o.offset=Math.min(e,o.offset),o.size=Math.max(r,a)-o.offset,s=!0)}s||i[n].push({offset:e,size:t.size})}let uL=class{constructor(e){if(this.webGlExtensions={},this._canvasElement=null,this._size=[1,1],e=e||{},"canvas"in e){this._canvasElement=typeof e.canvas=="string"?document.getElementById(e.canvas):e.canvas;const i={antialias:e.antialias!==void 0?e.antialias:!0,stencil:e.stencil!==void 0?e.stencil:!1,failIfMajorPerformanceCaveat:e.failIfMajorPerformanceCaveat!==void 0?e.failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:e.preserveDrawingBuffer!==void 0?e.preserveDrawingBuffer:!1};this._gl=e.version===2?this._canvasElement.getContext("webgl2",i):this._canvasElement.getContext("webgl",i)||this._canvasElement.getContext("experimental-webgl",i)}else this._gl=e.gl;this._pixelRatio=e.pixelRatio||1,this.clearColor=e.clearColor||[1,1,1,1],this.webGlExtensions={}}setPixelRatio(e){return this._pixelRatio=e,this}getPixelRatio(){return this._pixelRatio}setSize(e,i){return this._size=[e*this._pixelRatio,i*this._pixelRatio],this._canvasElement&&(this._canvasElement.width=this._size[0],this._canvasElement.height=this._size[1],this._canvasElement.style.width=`${e}px`,this._canvasElement.style.height=`${i}px`),this.setViewport(),this}setViewport(e,i){return e!==void 0&&i!==void 0?this._gl.viewport(0,0,e,i):this._gl.viewport(0,0,this._size[0],this._size[1]),this}getSize(){return this._size}addExtension(e){return this.webGlExtensions[e]=this._gl.getExtension(e),this}};const me=class me{constructor(e=null,i={}){this._src=null,this._glContext=null,this._texture=null,this._src=e,this.options=Object.assign({},me.defaultOptions,i)}enable(e,i){return e.activeTexture(e.TEXTURE0+i),this._texture||this.prepare(e),e.bindTexture(e.TEXTURE_2D,this._texture),this}remove(){return this._texture&&this._glContext&&this._glContext.deleteTexture(this._texture),this._glContext=null,this._texture=null,this._src=null,this}getTexture(){return this._texture}subImage(e,i,n,s){e.bindTexture(e.TEXTURE_2D,this._texture),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,this.options.flipY),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.options.premultiplyAlpha);const o=this._toGlParam(e,this.options.format),r=this._toGlParam(e,this.options.type??me.UnsignedByte);return o===null||r===null?this:(e.texSubImage2D(e.TEXTURE_2D,0,n,s,o,r,i),this)}prepare(e){this._glContext=e,this._texture=e.createTexture(),e.bindTexture(e.TEXTURE_2D,this._texture),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,this.options.flipY),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,this.options.premultiplyAlpha);const i=this._toGlParam(e,this.options.format),n=this._toGlParam(e,this.options.type??me.UnsignedByte),s=this._toGlParam(e,this.options.wrapS),o=this._toGlParam(e,this.options.wrapT),r=this._toGlParam(e,this.options.magFilter??me.LinearFilter),a=this._toGlParam(e,this.options.minFilter??me.LinearMipMapLinearFilter),l=this.options.compareFunc?this._toGlParam(e,this.options.compareFunc):null;if(i!==null&&n!==null){const c=this.hookInternalFormat(i,n,e);ArrayBuffer.isView(this._src)||this._src===null?this.options.size&&e.texImage2D(e.TEXTURE_2D,0,c,this.options.size[0],this.options.size[1],0,i,n,this._src):this._src&&e.texImage2D(e.TEXTURE_2D,0,i,i,n,this._src)}return s!==null&&o!==null&&(e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,s),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,o)),r!==null&&a!==null&&(e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,r),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,a)),l&&!(e instanceof WebGLRenderingContext)&&e.texParameteri(e.TEXTURE_2D,e.TEXTURE_COMPARE_MODE,e.COMPARE_REF_TO_TEXTURE),this.options.generateMipmaps&&this.options.minFilter!==me.NearestFilter&&this.options.minFilter!==me.LinearFilter&&e.generateMipmap(e.TEXTURE_2D),e.bindTexture(e.TEXTURE_2D,null),this}memSizeJs(){const e=this._src;return e===null?0:ArrayBuffer.isView(e)?e.byteLength:e instanceof ImageBitmap?e.height*e.width*4:(console.warn("[Stats] Untracked texture _src size"),0)}memSizeGPU(){var i,n;if(!this._texture)return 0;const e=(((i=this.options.size)==null?void 0:i[0])??0)*(((n=this.options.size)==null?void 0:n[1])??0)*4;return e>0?e:this._src!==null?this.memSizeJs():0}_toGlParam(e,i){return i===me.ClampToEdgeWrapping?e.CLAMP_TO_EDGE:i===me.Repeat?e.REPEAT:i===me.MirroredRepeat?e.MIRRORED_REPEAT:i===me.NearestFilter?e.NEAREST:i===me.NearestMipMapNearestFilter?e.NEAREST_MIPMAP_NEAREST:i===me.NearestMipMapLinearFilter?e.NEAREST_MIPMAP_LINEAR:i===me.LinearFilter?e.LINEAR:i===me.LinearMipMapNearestFilter?e.LINEAR_MIPMAP_NEAREST:i===me.LinearMipMapLinearFilter?e.LINEAR_MIPMAP_LINEAR:i===me.RgbaFormat?e.RGBA:i===me.AlphaFormat?e.ALPHA:i===me.RgbFormat?e.RGB:i===me.DepthComponentFormat?e.DEPTH_COMPONENT:i===me.UnsignedByte?e.UNSIGNED_BYTE:i===me.UnsignedShort?e.UNSIGNED_SHORT:i===me.Float?e.FLOAT:i===me.UnsignedInt?e.UNSIGNED_INT:e instanceof WebGLRenderingContext?null:i===me.RedFormat?e.RED:i===me.CompareRefToTexture?e.COMPARE_REF_TO_TEXTURE:i===me.CompareNone?e.NONE:i===me.DepthComponentFormat32?e.DEPTH_COMPONENT32F:null}hookInternalFormat(e,i,n){return n instanceof WebGLRenderingContext?e:e===n.DEPTH_COMPONENT?n.DEPTH_COMPONENT24:i===n.FLOAT&&e===n.RGBA?n.RGBA32F:i===n.FLOAT&&e===n.RED?n.R32F:i!==n.FLOAT&&e===n.RED?n.R8:e}};me.ClampToEdgeWrapping=1,me.Repeat=2,me.MirroredRepeat=3,me.NearestFilter=4,me.NearestMipMapNearestFilter=5,me.NearestMipMapLinearFilter=6,me.LinearFilter=7,me.LinearMipMapNearestFilter=8,me.LinearMipMapLinearFilter=9,me.DepthComponentFormat=10,me.DepthComponentFormat32=11,me.RgbaFormat=14,me.AlphaFormat=15,me.RgbFormat=16,me.UnsignedByte=17,me.Float=18,me.UnsignedShort=19,me.UnsignedInt=20,me.RedFormat=21,me.CompareNone=22,me.CompareRefToTexture=23,me.defaultOptions={magFilter:me.LinearFilter,minFilter:me.LinearMipMapLinearFilter,wrapS:me.ClampToEdgeWrapping,wrapT:me.ClampToEdgeWrapping,format:me.RgbaFormat,generateMipmaps:!0,flipY:!0,premultiplyAlpha:!0,type:me.UnsignedByte};let j=me;function Nd(t){if(t===void 0)return;const e=window.WebGLRenderingContext,n={[e.CLAMP_TO_EDGE]:j.ClampToEdgeWrapping,[e.REPEAT]:j.Repeat,[e.MIRRORED_REPEAT]:j.MirroredRepeat,[e.NEAREST]:j.NearestFilter,[e.NEAREST_MIPMAP_NEAREST]:j.NearestMipMapNearestFilter,[e.NEAREST_MIPMAP_LINEAR]:j.NearestMipMapLinearFilter,[e.LINEAR]:j.LinearFilter,[e.LINEAR_MIPMAP_NEAREST]:j.LinearMipMapNearestFilter,[e.LINEAR_MIPMAP_LINEAR]:j.LinearMipMapLinearFilter,[e.RGBA]:j.RgbaFormat,[e.ALPHA]:j.AlphaFormat,[e.RGB]:j.RgbFormat,[e.UNSIGNED_BYTE]:j.UnsignedByte,[e.FLOAT]:j.Float}[t];return n===void 0?(console.error(`Failed to translate texture parameter ${t}`),NaN):n}const Hh=class Hh{constructor(e={}){this._texture=null,this._glContext=null,this._frameBuffer=null,this._depthAttachment=null,this.options=Object.assign({},Hh.defaultOptions,e),this.options.hasColorOutput&&(this._texture=new j(null,this.options))}bind(e,i){return this._frameBuffer||this._prepare(e),i?e.bindFramebuffer(i,this._frameBuffer):e.bindFramebuffer(e.FRAMEBUFFER,this._frameBuffer),this}unbind(e){return e.bindFramebuffer(e.FRAMEBUFFER,null),this}remove(){return this._unprepare(),this}setSize(e){return this.options.size=e,this._unprepare(),this}getTexture(){return this._texture}getDepthAttachment(){return this._depthAttachment}memSizeGPU(){const{_texture:e,_depthAttachment:i}=this;let n=0;if(this.options.depthTexture||this.options.useHighDepthPrecision)n=4;else switch(this.options.depthInternalFormat){case WebGL2RenderingContext.DEPTH_COMPONENT16:n=2;break;case WebGL2RenderingContext.DEPTH_COMPONENT24:n=3;break;case WebGL2RenderingContext.DEPTH_STENCIL:n=1;break}return{_texture:e?yd(e):{_texture:0},_depthAttachment:i===null?0:this.options.size[0]*this.options.size[1]*n}}_prepare(e){if(this._glContext=e,!this._texture&&this.options.hasColorOutput&&(this._texture=new j(null,this.options)),this._frameBuffer=e.createFramebuffer(),e.bindFramebuffer(e.FRAMEBUFFER,this._frameBuffer),this._texture&&(this._texture.prepare(e),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this._texture.getTexture(),0)),this.options.depthTexture){const i=this._depthAttachment=new j(null,{magFilter:this.options.magFilter??j.NearestFilter,minFilter:this.options.minFilter??j.NearestFilter,format:j.DepthComponentFormat,size:this.options.size,premultiplyAlpha:!1,generateMipmaps:!1,type:j.UnsignedInt,compareFunc:this.options.compareFunc});i.prepare(e),e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.TEXTURE_2D,i.getTexture(),0)}else{const i=this.options.useHighDepthPrecision?e.DEPTH_STENCIL:this.options.depthInternalFormat,n=this.options.useHighDepthPrecision?e.DEPTH_STENCIL_ATTACHMENT:e.DEPTH_ATTACHMENT;this._depthAttachment=e.createRenderbuffer(),e.bindRenderbuffer(e.RENDERBUFFER,this._depthAttachment),e.renderbufferStorage(e.RENDERBUFFER,i,this.options.size[0],this.options.size[1]),e.framebufferRenderbuffer(e.FRAMEBUFFER,n,e.RENDERBUFFER,this._depthAttachment)}this._checkComplete(e),e.bindRenderbuffer(e.RENDERBUFFER,null),e.bindFramebuffer(e.FRAMEBUFFER,null)}_unprepare(){this._texture&&(this._texture.remove(),this._texture=null),this._glContext&&this._depthAttachment&&(this._depthAttachment instanceof j?this._depthAttachment.remove():this._glContext.deleteRenderbuffer(this._depthAttachment),this._depthAttachment=null),this._glContext&&this._frameBuffer&&(this._glContext.deleteFramebuffer(this._frameBuffer),this._frameBuffer=null)}_checkComplete(e){if(p_()){const i=e.checkFramebufferStatus(e.FRAMEBUFFER);if(i===e.FRAMEBUFFER_COMPLETE)return;i===e.FRAMEBUFFER_UNSUPPORTED?console.log("Framebuffer is unsupported"):i===e.FRAMEBUFFER_INCOMPLETE_ATTACHMENT?console.log("Framebuffer incomplete attachment"):i===e.FRAMEBUFFER_INCOMPLETE_DIMENSIONS?console.log("Framebuffer incomplete dimensions"):i===e.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT?console.log("Framebuffer incomplete missing attachment"):console.log(`Unexpected framebuffer status: ${i}`)}}};Hh.defaultOptions=Object.assign({},j.defaultOptions,{size:[0,0],generateMipmaps:!1,depthTexture:!1,hasColorOutput:!0,useHighDepthPrecision:!1,depthInternalFormat:33189});let Nt=Hh;const Ud={defines:[],hash:""},Lr=class Lr{constructor(e,i,n=Ud,s=Ud){this.shader=null,this.type=e==="vertex"?Lr.Vertex:Lr.Fragment,this.sourceCode=i,this.commonDefinitions=n,this.definitions=s}static createShaderDefinitions(e){return{defines:e,hash:e.map(n=>`${n.type}:${n.value??""}`).join("")}}get(e){return this.shader||this.compile(e),this.shader}remove(e){this.shader&&(e.deleteShader(this.shader),this.shader=null)}getCode(){return this.assembleShaderText().slice()}compile(e){const i=this.type===Lr.Vertex?e.VERTEX_SHADER:e.FRAGMENT_SHADER,n=this.shader=e.createShader(i);if(!n||e.isContextLost())throw new Error(`[2gl] Failed to create shader. Shader is null: ${String(!n)}. Context is lost: ${String(e.isContextLost())}`);const s=this.assembleShaderText();if(e.shaderSource(n,s),e.compileShader(n),p_()&&!e.getShaderParameter(n,e.COMPILE_STATUS)){const o=e.getShaderInfoLog(n),r=(s||"").split(`
`);throw new Error(o?o.replace(/^ERROR:\s*(\d+):(\d+):\s*(.*?)\n/,function(a,l,c,d){const h=r[Number(c)-1];return h?`ERROR ${l}:${c}: ${d}
Erroneous line: <<${h}>>
`:a}):"Unknown shader compilation error")}}assembleShaderText(){const e=this.sourceCode,i=[...this.commonDefinitions.defines,...this.definitions.defines].map(o=>o.value!==void 0?"#define "+o.type+" "+o.value:"#define "+o.type),n=Array.isArray(e)?e:[e||""];let s=!0;for(const o of n)s&&o.indexOf("#version")!==-1?i.unshift(o):i.push(o),s=!1;return i.join(`
`)}};Lr.Vertex=1,Lr.Fragment=2;let Ps=Lr;class fL{constructor(e){this.location=null,this.name=e.name,this.type=e.type}getLocation(e,i){return this.location=e.getUniformLocation(i,this.name),this}bind(e,i){switch(this.type){case"1i":e.uniform1i(this.location,i);break;case"1f":e.uniform1f(this.location,i);break;case"2i":e.uniform2i(this.location,i[0],i[1]);break;case"2f":e.uniform2f(this.location,i[0],i[1]);break;case"3i":e.uniform3i(this.location,i[0],i[1],i[2]);break;case"3f":e.uniform3f(this.location,i[0],i[1],i[2]);break;case"4i":e.uniform4i(this.location,i[0],i[1],i[2],i[3]);break;case"4f":e.uniform4f(this.location,i[0],i[1],i[2],i[3]);break;case"1iv":e.uniform1iv(this.location,i);break;case"1fv":e.uniform1fv(this.location,i);break;case"2iv":e.uniform2iv(this.location,i);break;case"2fv":e.uniform2fv(this.location,i);break;case"3iv":e.uniform3iv(this.location,i);break;case"3fv":e.uniform3fv(this.location,i);break;case"4iv":e.uniform4iv(this.location,i);break;case"4fv":e.uniform4fv(this.location,i);break;case"mat2":e.uniformMatrix2fv(this.location,!1,i);break;case"mat3":e.uniformMatrix3fv(this.location,!1,i);break;case"mat4":e.uniformMatrix4fv(this.location,!1,i);break;default:throw new Error(`[2gl] Unsupported uniform type: '${this.type}'`)}return this}isNonFloatType(){return this.type.includes("i")}}class _L{constructor(e,i,n){this.uniformBlocksNames=n,this.uniforms={},this.attributes={},this._webglProgram=null,this._linked=!1,this._located=!1,this._error=!1,this._uniformBlocksIndices={},this._uboBindings={},e=e||{},e.uniforms=e.uniforms||[],e.uniforms.forEach(s=>{this.uniforms[s.name]=new fL(s)}),e.attributes=e.attributes||[],e.attributes.forEach(s=>{this.attributes[s.name]=new YS(s)}),i=i??Ud,this._vertexShader=e.buildVertex(i),this._fragmentShader=e.buildFragment(i)}enable(e){return this._error?this:(this.link(e),this.locate(e),this._error?this:(e.useProgram(this._webglProgram),this))}bind(e,i,n){if(this._error)return this;if(i)for(const s in i)this.uniforms[s].bind(e,i[s]);if(n)for(const s in n)this.attributes[s].bind(e,n[s]);return this}disable(e){if(this._error)return this;for(const i in this.attributes)this.attributes[i].disable(e);return this}link(e){if(this._linked||this._error)return this;try{if(this._webglProgram=e.createProgram(),!this._webglProgram)throw new Error("Failed to create shader program");const i=this._vertexShader.get(e),n=this._fragmentShader.get(e);i&&e.attachShader(this._webglProgram,i),n&&e.attachShader(this._webglProgram,n);for(const s in this.attributes)this.attributes[s].bindLocation(e,this._webglProgram);if(e.linkProgram(this._webglProgram),p_()&&!e.getProgramParameter(this._webglProgram,e.LINK_STATUS))throw new Error(e.getProgramInfoLog(this._webglProgram)||"Couldn't get shader program Info Log");this._linked=!0}catch(i){throw this._error=!0,i}return this}locate(e){if(this._located||this._error||!this._webglProgram)return this;for(const i in this.attributes)this.attributes[i].getLocation(e,this._webglProgram);for(const i in this.uniforms)this.uniforms[i].getLocation(e,this._webglProgram);return e instanceof WebGLRenderingContext||this.locateUniformBlocks(e,this._webglProgram),this._located=!0,this}getUniformBlockIndex(e){return this._uniformBlocksIndices[e]}getUboBinding(e){return this._uboBindings[e]}getUniformBlockSize(e,i){let n=this._webglProgram;if(n||(this.link(e),this.locate(e)),n=this._webglProgram,!n)return null;const s=this.getUniformBlockIndex(i);return s===void 0?null:e.getActiveUniformBlockParameter(n,s,e.UNIFORM_BLOCK_DATA_SIZE)}getUniformsIndicesOffsetsInBlock(e,i){let n=this._webglProgram;if(n||(this.link(e),this.locate(e)),n=this._webglProgram,!n)return null;const s=e.getUniformIndices(n,i);if(!s)return console.error("Couldn't get UBO uniforms indices."),null;const o=s.filter(l=>l!==e.INVALID_INDEX),r=e.getActiveUniforms(n,o,e.UNIFORM_OFFSET);if(r===null)return console.error("Couldn't get active UBO uniform offsets."),null;const a={};for(let l=0;l<i.length;++l){const c=s[l];if(c!==e.INVALID_INDEX){const d=o.indexOf(c);a[i[l]]=r[d]}}return a}locateUniformBlocks(e,i){if(!this.uniformBlocksNames)return;let n=0;for(const s of this.uniformBlocksNames){const o=e.getUniformBlockIndex(i,s);o!==e.INVALID_INDEX&&(this._uniformBlocksIndices[s]=o,this._uboBindings[s]=n,e.uniformBlockBinding(i,o,n++))}}}const X0=[1,1,1,1],mL=Oe(),pL=Oe(),Y0=Gi(),gL=Gi(),vL=Oe(),yL=at(0,1,0),q0=(t,e,i,n,s)=>{Ls(t,e,{u_float_rounding_factor:i.stillness},s)},Ol=(t,e,i,n,s)=>{Ls(t,e,{u_float_border_width_offset:1/window.devicePixelRatio},s)},Gd=(t,e,i,n,s)=>{const o=(Xh-.5)/2,{size:r}=i;Ls(t,e,{u_vec2_depth_test_half_point_size:[o/r[0],o/r[1]]},s)},ye=(t,e,i,n,s)=>{if(!n.environmentManager.isFogEnabled())return;const o=n.styleManager.getStyle(i.handyStyleId);let r=X0,a=X0;if(o){const c=ut(i.styleZoom,i.styleState,[]);r=Tt(ze(o.environment.style.skyColor,c)),a=Tt(ze(o.environment.style.fogColor,c))}const l=n.camera;Ls(t,e,{u_sky_color:i.globeMode?[0,0,0,0]:r,u_fog_color:i.globeMode?[0,0,0,0]:a,u_fog_distance:i.globeMode?0:l.fogDistance,u_fog_limits:n.environmentManager.fogLimits,u_fog_horizon_blend:n.environmentManager.fogHorizonBlend,u_fog_horizon_level:n.environmentManager.fogHorizonLevel},s)},we=(t,e,i,n,s)=>{Ls(t,e,{u_cam_pos:n.camera.position},s)},ke=(t,e,i,n,s)=>{n.shadowManager.texture&&Ls(t,e,{u_shadow_map_params:n.shadowManager.shadowMapParams,u_shadow_bias:n.shadowManager.bias,u_mat4_clip_to_shadow:n.shadowManager.clipToShadowMatrix},s)},Bl=(t,e,i,n,s)=>{Ls(t,e,{u_vec2_scale_limits:[0,Wh]},s)},K0=(t,e,i,n,s)=>{const o=n.camera.viewMatrixTranspose,r=n.camera.projectionMatrixInverse;Ls(t,e,{u_mat4_view_transposed:o,u_mat4_proj_inverted:r},s)},F_=(t,e,i,n,s)=>{const o=window.devicePixelRatio,r=n.camera.ecef.pixelRadius*o,{left:a,bottom:l,top:c,right:d}=i.padding,[h,u]=i.size,f=[h*o,u*o],m=[(a-d)*o/2,(l-c)*o/2],p=n.environmentManager.globHaloStops.map(I=>(r+I*o)/f[1]),_=n.styleManager.getStyle(i.handyStyleId);if(!_)return;const g=_==null?void 0:_.environment;if(!g)return;const y=ut(i.styleZoom,i.styleState,[]),b=ze(g.style.fogColor,y),v=ze(_.background.color,y);Ls(t,e,{u_vec2_halo_viewport_size:f,u_vec2_halo_viewport_center_shift:m,u_vec4_halo_radius_stops:p,u_vec4_halo_color:Tt(b),u_float_halo_exp_factor:n.environmentManager.globeHaloExpFactor,u_vec4_default_background_color:Tt(v)},s)},J0=(t,e,i,n,s)=>{const o=i.size,r=Math.max(o[0],o[1]),a=o[0]/r,l=o[1]/r;Yp(Y0,-a/2,a/2,-l/2,l/2,.001,1);const c=Z.toGeo(i.center),d=gt(pL,0,0,0),h=gt(mL,0,0,1);m2(h,h,d,ve(c[1])),p2(h,h,d,ve(c[0]));const u=Za(gL,vL,h,yL);ri(u,Y0,u);const f=n.styleManager.getStyle(i.handyStyleId);if(!f)return;const m=f==null?void 0:f.environment;if(!m)return;const p=ut(i.styleZoom,i.styleState,[]),_=W(m.style.starsIntensity,p);Ls(t,e,{u_float_pixelratio:window.devicePixelRatio,u_float_stars_intensity:_,u_mat4_stars:u},s)};function Ls(t,e,i,n){n&&!(t instanceof WebGLRenderingContext)?n.updateData(t,e,i):e.bind(t,i)}function Se(...t){return(e,i,n,s,o)=>{t.forEach(r=>r(e,i,n,s,o))}}const wL=Se(q0,Ol,Gd,ye,we,ke,Bl,K0,F_,J0),Q0=Se(we,ye),$t=(t,e,i)=>{const{size:n}=i,s=window.devicePixelRatio;e.bind(t,{u_vec2_vpt_size:[n[0]*s,n[1]*s]})},e1=(t,e,i,n)=>{const{size:s}=i,o=window.devicePixelRatio;if(i.demMode){const r=n.renderer.getFramebuffer(n.demManager.getFlatFramebufferId());if(!r)return;e.bind(t,{u_vec2_vpt_size:[Math.trunc(r.renderTarget.options.size[0]),Math.trunc(r.renderTarget.options.size[1])]})}else e.bind(t,{u_vec2_vpt_size:[s[0]*o,s[1]*o]})},kl=(t,e,i)=>{const n=sg(i.zoom);e.bind(t,{u_vec3_projection_scale_style_scale_dpi:[n,n,Rr*window.devicePixelRatio]})},t1=(t,e,i)=>{const n=sg(i.styleZoom);e.bind(t,{u_vec3_projection_scale_style_scale_dpi:[n,n,Rr*window.devicePixelRatio]})},jd=(t,e,i,n)=>{e.bind(t,{u_float_height_factor:n.buildingHeightAnimator.getDefaultBuildingHeight()})},Vd=(t,e)=>{e.bind(t,{u_float_z_offset:0})},bL=(t,e)=>{e.bind(t,{u_float_z_offset:-1e-5})},Cs=(t,e)=>{e.bind(t,{u_sr2d_texture:0})},i1=(t,e)=>{e.bind(t,{u_vec4_border_color:[0,0,0,0]})},n1=(t,e)=>{e.bind(t,{u_vec4_space_color:[0,0,0,0]})},s1=(t,e,i,n)=>{const{renderer:s}=n,{labelingTextureBuffer:o,spriteLabelingTextureBuffer:r}=s;let a=i.isLabelingDepthTestDisabled;if(!a){const c=o.getDepthAttachment(),d=o.getTexture();!(c instanceof j)||!d?a=!0:(d.enable(t,Qw),c.enable(t,eb))}const l=r.getTexture();l&&(l.enable(t,tb),e.bind(t,{u_color_text_sprite_labeling:tb})),e.bind(t,{u_bool_depth_test_disable:a}),a||e.bind(t,{u_color_tex_labeling:Qw,u_depth_tex_labeling:eb})};function Nl(...t){return(e,i,n,s)=>{t.forEach(o=>o(e,i,n,s))}}const o1={[rr.none]:{ambientColorIntensity:new Float32Array([1,1,1,0]),dir1ColorIntensity:new Float32Array([1,1,1,0]),dir1Direction:new Float32Array([0,-1,0]),dir2ColorIntensity:new Float32Array([1,1,1,0]),dir2Direction:new Float32Array([0,-1,0]),shadowLightIndex:-1,shadowRadius:1}};function fi(...t){return(e,i,n,s,o,r)=>{t.forEach(a=>a(e,i,n,s,o,r))}}const xL=1,SL=2,ML=4,qe=(t,e,i,n,s,o)=>{let r=rr.none,a=o1[r],l=0;const c=r1(s,n,i);c&&(a=c.lightConfig,r=c.lightingMode,l=(r===rr.none||o?0:xL)+(s.receiveShadows!==!1&&a.shadowLightIndex===0?SL:0)+(s.receiveShadows!==!1&&a.shadowLightIndex===1?ML:0));const d=n.renderer.getUbo(r);if(d&&!(t instanceof WebGLRenderingContext)){d.bind(t,e),e.bind(t,{u_int_light_flags:l});return}e.bind(t,{u_int_light_flags:l,u_vec3_light_dir1_direction:a.dir1Direction,u_vec4_light_dir1_color:a.dir1ColorIntensity,u_vec3_light_dir2_direction:a.dir2Direction,u_vec4_light_dir2_color:a.dir2ColorIntensity,u_vec4_ambient_color:a.ambientColorIntensity})},Rs=(t,e,i,n,s)=>{const o=ut(i.styleZoom,i.styleState,[],!1),r=W(s.style.nearCameraFade,o);e.bind(t,{u_sdtr_distance:r})},Hd=(t,e,i,n,s)=>{const o=ut(i.styleZoom,i.styleState,[],!1),r=s.style.showRatio,a=q(r,o);e.bind(t,{u_float_show_ratio:a})};function r1(t,e,i){const n=e.styleManager.getStyle(i.handyStyleId);if(!n||!n.light.lightingModesResolved)return null;let s=t.lightingMode??n.light.defaultLightMode;t.type==="gltfModel"&&t.style.ignoreGlobalLighting&&(s=rr.none);let o=n.light.lightingModesResolved[s];return o||(o=n.light.lightingModesResolved[n.light.defaultLightMode]),{lightingMode:s,lightConfig:o}}class de{constructor(e,i,n=null){this.isDirty=!1,this._vao=null,this._vaoExt=null,this._gl=null,this.attributesAliases={},this._attributes=i,this._shaderProgram=e,this.indicesBuffer=n}static merge(e){const i=e[0],n={},s={};for(const r of e)Object.assign(n,r._attributes),Object.assign(s,r.attributesAliases);const o=new de(i._shaderProgram,n,i.indicesBuffer);return o.setAttributesAliases(s),o}copy(){const e=new de(this._shaderProgram,{...this._attributes},this.indicesBuffer);return e.setAttributesAliases(this.attributesAliases),e}bind(e){const i=e.extensions.OES_vertex_array_object,n=e.extensions.ANGLE_instanced_arrays;return this._bind(e.gl,i,n),this}unbind(){return this._glBindVertexArray(null),this}setAttribute(e,i){this._attributes[e]=i,this.remove()}remove(){return this._vao&&(this._glDeleteVertexArray(this._vao),this._vao=null),this}getElementsGLType(e){return this.indicesBuffer?this.indicesBuffer.getGLType(e):null}getBuffer(e){return this._attributes[e]}rewriteData(e,i){this._attributes[e].replaceData(i),this.isDirty=!0}setAttributesAliases(e){Object.assign(this.attributesAliases,e),this.remove()}setAttributes(e,i){const n=this._shaderProgram.attributes,s=this._attributes;for(const o in n){const a=this.attributesAliases[o]||o,l=s[a];if(!l)continue;const c=n[o];if(c.index!==!0)for(let d=0;d<c.locationsCount;d++)e.enableVertexAttribArray(c.location+d);l.bind(e,c.location,void 0,i,c.locationsCount)}this.indicesBuffer&&this.indicesBuffer.bind(e)}_bind(e,i,n){this._vao?(this.isDirty&&this.updateDirtyBuffers(e),this._glBindVertexArray(this._vao)):this._prepare(e,i,n)}_prepare(e,i,n){this._gl=e,i&&(this._vaoExt=i),this._vao=this._glCreateVertexArray(),this._glBindVertexArray(this._vao),this.setAttributes(e,n)}_glCreateVertexArray(){const e=this._gl,i=this._vaoExt;return e&&this._isWebGL2(e)?e.createVertexArray():i?i.createVertexArrayOES():null}_glBindVertexArray(e){const i=this._gl,n=this._vaoExt;i&&this._isWebGL2(i)?i.bindVertexArray(e):n?n.bindVertexArrayOES(e):i&&this._shaderProgram.bind(i,void 0,this._attributes)}_glDeleteVertexArray(e){const i=this._gl,n=this._vaoExt;i&&this._isWebGL2(i)?i.deleteVertexArray(e):n&&n.deleteVertexArrayOES(e)}_isWebGL2(e){return typeof window<"u"&&"WebGL2RenderingContext"in window&&e instanceof WebGL2RenderingContext}updateDirtyBuffers(e){const i=this._shaderProgram.attributes,n=this._attributes,s=this.attributesAliases;for(const o in i){const r=s[o]||o,a=n[r];a!=null&&a.isDirty&&a.commitData(e)}this.isDirty=!1}}const IL=(t,e)=>{const i=qi.sinks.fill.stride,n=new z(t,{itemSize:2,dataType:R.UnsignedShort,stride:i,offset:0,normalized:!0});return new de(e,{a_vec2_vertex:n})},TL=(t,e)=>{const i=qi.sinks.shadow.stride,n=new z(t,{itemSize:2,dataType:R.UnsignedShort,stride:i,offset:0,normalized:!0});return new de(e,{a_vec2_vertex:n})},EL=(t,e)=>{const n=new z(t,{itemSize:2,dataType:R.UnsignedShort,stride:8,offset:0,normalized:!0}),s=new z(t,{itemSize:2,dataType:R.UnsignedShort,stride:8,offset:4,normalized:!1});return new de(e,{a_vec2_vertex:n,a_vec2_texcoord:s})},AL=(t,e)=>{const n=new z(t,{itemSize:2,dataType:R.UnsignedShort,stride:8,offset:0,normalized:!0}),s=new z(t,{itemSize:4,dataType:R.UnsignedByte,stride:8,offset:4,normalized:!0});return new de(e,{a_vec2_vertex:n,a_vec4_identifier:s})},PL=(t,e)=>{const n=new z(t,{itemSize:2,dataType:R.UnsignedShort,stride:12,offset:0,normalized:!0}),s=new z(t,{itemSize:4,dataType:R.Byte,stride:12,offset:4,normalized:!1});return new de(e,{a_vec2_vertex:n,a_vec4_normals:s})},LL=(t,e)=>{const i=St.sinks.solid3d.stride,n=new z(t,{itemSize:2,dataType:R.UnsignedShort,stride:i,offset:0,normalized:!0}),s=new z(t,{itemSize:4,dataType:R.Byte,stride:i,offset:4,normalized:!1}),o=new z(t,{itemSize:1,dataType:R.Float,stride:i,offset:8,normalized:!1});return new de(e,{a_vec2_vertex:n,a_vec4_normals:s,a_float_height:o})},CL=(t,e)=>{const i=St.sinks.solid3d.stride,n=new z(t,{itemSize:2,dataType:R.UnsignedShort,stride:i,offset:0,normalized:!0}),s=new z(t,{itemSize:4,dataType:R.Byte,stride:i,offset:4,normalized:!1}),o=new z(t,{itemSize:1,dataType:R.Float,stride:i,offset:8,normalized:!1}),r=new z(t,{itemSize:4,dataType:R.UnsignedByte,stride:i,offset:12,normalized:!0});return new de(e,{a_vec2_vertex:n,a_vec4_normals:s,a_float_height:o,a_vec4_identifier:r})},RL=(t,e)=>{const n=new z(t,{itemSize:2,dataType:R.UnsignedShort,stride:16,offset:0,normalized:!0}),s=new z(t,{itemSize:4,dataType:R.Byte,stride:16,offset:4,normalized:!1}),o=new z(t,{itemSize:2,dataType:R.Float,stride:16,offset:8,normalized:!1});return new de(e,{a_vec2_vertex:n,a_vec4_normals:s,a_vec2_shift:o})},zL=(t,e)=>{const n=new z(t,{itemSize:2,dataType:R.UnsignedShort,stride:12,offset:0,normalized:!0}),s=new z(t,{itemSize:4,dataType:R.Byte,stride:12,offset:4,normalized:!1}),o=new z(t,{itemSize:4,dataType:R.UnsignedByte,stride:12,offset:8,normalized:!0});return new de(e,{a_vec2_vertex:n,a_vec4_normals:s,a_vec4_identifier:o})},FL=(t,e)=>{const i=St.sinks.patterned.stride,n=new z(t,{itemSize:2,dataType:R.UnsignedShort,stride:i,offset:0,normalized:!0}),s=new z(t,{itemSize:2,dataType:R.Short,stride:i,offset:4,normalized:!1}),o=new z(t,{itemSize:1,dataType:R.Float,stride:i,offset:8}),r=new z(t,{itemSize:4,dataType:R.UnsignedByte,stride:i,offset:12,normalized:!0});return new de(e,{a_vec2_vertex:n,a_vec2_widen:s,a_float_texture:o,a_vec4_identifier:r})},DL=(t,e)=>{const i=St.sinks.patterned3d.stride,n=new z(t,{itemSize:2,dataType:R.UnsignedShort,stride:i,offset:0,normalized:!0}),s=new z(t,{itemSize:2,dataType:R.Short,stride:i,offset:4,normalized:!1}),o=new z(t,{itemSize:1,dataType:R.Float,stride:i,offset:8}),r=new z(t,{itemSize:1,dataType:R.Float,stride:i,offset:12,normalized:!1}),a=new z(t,{itemSize:4,dataType:R.UnsignedByte,stride:i,offset:16,normalized:!0});return new de(e,{a_vec2_vertex:n,a_vec2_widen:s,a_float_texture:o,a_float_height:r,a_vec4_identifier:a})},a1=(t,e)=>{const n=new z(t,{itemSize:2,dataType:R.UnsignedShort,stride:28,offset:0,normalized:!0}),s=new z(t,{itemSize:2,dataType:R.Short,stride:28,offset:4,normalized:!1}),o=new z(t,{itemSize:2,dataType:R.Byte,stride:28,offset:8,normalized:!1}),r=new z(t,{itemSize:1,dataType:R.Float,stride:28,offset:12,normalized:!1}),a=new z(t,{itemSize:1,dataType:R.Float,stride:28,offset:16,normalized:!1}),l=new z(t,{itemSize:1,dataType:R.Float,stride:28,offset:20,normalized:!1}),c=new z(t,{itemSize:4,dataType:R.UnsignedByte,stride:28,offset:24,normalized:!0});return new de(e,{a_vec2_vertex:n,a_vec2_texture_widen:o,a_vec2_widen:s,a_float_vertex_distance:r,a_float_component_distance:a,a_float_object_length:l,a_vec4_identifier:c})},l1=(t,e)=>{const i=es.sinks.stroke3d.stride,n=new z(t,{itemSize:2,dataType:R.UnsignedShort,stride:i,offset:0,normalized:!0}),s=new z(t,{itemSize:2,dataType:R.Short,stride:i,offset:4,normalized:!1}),o=new z(t,{itemSize:2,dataType:R.Byte,stride:i,offset:8,normalized:!1}),r=new z(t,{itemSize:1,dataType:R.Float,stride:i,offset:12,normalized:!1}),a=new z(t,{itemSize:1,dataType:R.Float,stride:i,offset:16,normalized:!1}),l=new z(t,{itemSize:1,dataType:R.Float,stride:i,offset:20,normalized:!1}),c=new z(t,{itemSize:1,dataType:R.Float,stride:i,offset:24,normalized:!1}),d=new z(t,{itemSize:4,dataType:R.UnsignedByte,stride:i,offset:28,normalized:!0});return new de(e,{a_vec2_vertex:n,a_vec2_texture_widen:o,a_vec2_widen:s,a_float_vertex_distance:r,a_float_component_distance:a,a_float_object_length:l,a_float_height:c,a_vec4_identifier:d})},c1=(t,e)=>{const n=new z(t,{itemSize:3,dataType:R.UnsignedShort,stride:36,offset:0,normalized:!0}),s=new z(t,{itemSize:3,dataType:R.Short,stride:36,offset:6,normalized:!0}),o=new z(t,{itemSize:2,dataType:R.Short,stride:36,offset:12,normalized:!1}),r=new z(t,{itemSize:2,dataType:R.Short,stride:36,offset:16,normalized:!1}),a=new z(t,{itemSize:2,dataType:R.UnsignedShort,stride:36,offset:20,normalized:!1}),l=new z(t,{itemSize:4,dataType:R.UnsignedByte,stride:36,offset:28,normalized:!0}),c=new z(t,{itemSize:4,dataType:R.UnsignedByte,stride:36,offset:32,normalized:!0});return new de(e,{a_vec3_flat_position:n,a_vec3_ecef_position:s,a_vec2_check_offset:r,a_vec2_offset:o,a_vec2_texcoord:a,a_vec4_tex_identifier:l,a_vec4_sprite_identifier:c})},OL=(t,e)=>{const n=new z(t,{itemSize:3,dataType:R.UnsignedShort,stride:36,offset:0,normalized:!0}),s=new z(t,{itemSize:3,dataType:R.Short,stride:36,offset:6,normalized:!0}),o=new z(t,{itemSize:2,dataType:R.Short,stride:36,offset:12,normalized:!1}),r=new z(t,{itemSize:4,dataType:R.UnsignedByte,stride:36,offset:24,normalized:!0});return new de(e,{a_vec3_flat_position:n,a_vec3_ecef_position:s,a_vec2_offset:o,a_vec4_identifier:r})},Zd=(t,e)=>{const n=new z(t,{itemSize:3,dataType:R.UnsignedShort,stride:28,offset:0,normalized:!0}),s=new z(t,{itemSize:2,dataType:R.UnsignedShort,stride:28,offset:8,normalized:!1}),o=new z(t,{itemSize:2,dataType:R.Float,stride:28,offset:12,normalized:!1}),r=new z(t,{itemSize:2,dataType:R.Float,stride:28,offset:20,normalized:!1});return new de(e,{a_vec4_position:n,a_vec2_offset:o,a_vec2_texcoord:s,a_vec2_style_zoom_limits:r})},d1=(t,e)=>{const i=ee.sinks.fill.stride,n=new z(t,{itemSize:2,dataType:R.UnsignedShort,stride:i,offset:0,normalized:!0}),s=new z(t,{itemSize:1,dataType:R.Float,stride:i,offset:4,normalized:!1}),o=new z(t,{itemSize:3,dataType:R.Byte,stride:i,offset:8,normalized:!1}),r=new z(t,{itemSize:1,dataType:R.Byte,stride:i,offset:11,normalized:!1}),a=new z(t,{itemSize:2,dataType:R.Short,stride:i,offset:16,normalized:!1}),l=new z(t,{itemSize:1,dataType:R.Float,stride:i,offset:16,normalized:!1}),c=new z(t,{itemSize:4,dataType:R.UnsignedByte,stride:i,offset:12,normalized:!0}),d=new z(t,{itemSize:1,dataType:R.UnsignedByte,stride:i,offset:20,normalized:!1});return new de(e,{a_vec2_vertex:n,a_float_z:s,a_vec3_normal:o,a_float_gradient:r,a_vec2_dem_position:a,a_float_abs_z:l,a_vec4_identifier:c,a_float_is_pivot:d})},BL=(t,e)=>{const i=ee.sinks.fill.stride,n=new z(t,{itemSize:2,dataType:R.UnsignedShort,stride:i,offset:0,normalized:!0}),s=new z(t,{itemSize:1,dataType:R.Float,stride:i,offset:4,normalized:!1}),o=new z(t,{itemSize:3,dataType:R.Byte,stride:i,offset:8,normalized:!1}),r=new z(t,{itemSize:1,dataType:R.Byte,stride:i,offset:11,normalized:!1}),a=new z(t,{itemSize:2,dataType:R.Short,stride:i,offset:16,normalized:!1}),l=new z(t,{itemSize:1,dataType:R.Float,stride:i,offset:16,normalized:!1}),c=new z(t,{itemSize:1,dataType:R.UnsignedByte,stride:i,offset:20,normalized:!1}),d=new z(t,{itemSize:4,dataType:R.UnsignedByte,stride:i,offset:24,normalized:!0});return new de(e,{a_vec2_vertex:n,a_float_z:s,a_vec3_normal:o,a_float_gradient:r,a_vec2_dem_position:a,a_float_abs_z:l,a_vec4_identifier:d,a_float_is_pivot:c})},h1=(t,e)=>{const i=ee.sinks.fill.stride,n=new z(t,{itemSize:2,dataType:R.UnsignedShort,stride:i,offset:0,normalized:!0}),s=new z(t,{itemSize:1,dataType:R.Float,stride:i,offset:4,normalized:!1}),o=new z(t,{itemSize:2,dataType:R.Short,stride:i,offset:16,normalized:!1}),r=new z(t,{itemSize:1,dataType:R.Float,stride:i,offset:16,normalized:!1}),a=new z(t,{itemSize:1,dataType:R.UnsignedByte,stride:i,offset:20,normalized:!1});return new de(e,{a_vec2_vertex:n,a_float_z:s,a_vec2_dem_position:o,a_float_abs_z:r,a_float_is_pivot:a})},$d=(t,e)=>{const i=ee.sinks.inverse.stride,n=new z(t,{itemSize:2,dataType:R.UnsignedShort,stride:i,offset:0,normalized:!0}),s=new z(t,{itemSize:1,dataType:R.Float,stride:i,offset:4,normalized:!1}),o=new z(t,{itemSize:2,dataType:R.Short,stride:i,offset:8,normalized:!1}),r=new z(t,{itemSize:1,dataType:R.Float,stride:i,offset:8,normalized:!1}),a=new z(t,{itemSize:1,dataType:R.UnsignedByte,stride:i,offset:12,normalized:!1});return new de(e,{a_vec2_vertex:n,a_float_z:s,a_vec2_dem_position:o,a_float_abs_z:r,a_float_is_pivot:a})},kL=(t,e)=>{const i=ee.sinks.stroke.stride,n=new z(t,{itemSize:2,dataType:R.UnsignedShort,stride:i,offset:0,normalized:!0}),s=new z(t,{itemSize:1,dataType:R.Float,stride:i,offset:4,normalized:!1}),o=new z(t,{itemSize:4,dataType:R.Byte,stride:i,offset:8,normalized:!1}),r=new z(t,{itemSize:2,dataType:R.Short,stride:i,offset:12,normalized:!1}),a=new z(t,{itemSize:1,dataType:R.Float,stride:i,offset:12,normalized:!1}),l=new z(t,{itemSize:1,dataType:R.UnsignedByte,stride:i,offset:16,normalized:!1});return new de(e,{a_vec2_vertex:n,a_float_z:s,a_vec4_direction_distance:o,a_vec2_dem_position:r,a_float_abs_z:a,a_float_is_pivot:l})},Wd=(t,e)=>{const i=ws.sinks.sideFill.stride,n=new z(t,{itemSize:4,dataType:R.UnsignedShort,stride:i,offset:0,normalized:!0}),s=new z(t,{itemSize:2,dataType:R.Short,stride:i,offset:12,normalized:!1});return new de(e,{a_vec4_vertex:n,a_vec2_dem_position:s})},u1=(t,e)=>{const i=ws.sinks.sideFill.stride,n=new z(t,{itemSize:4,dataType:R.UnsignedShort,stride:i,offset:0,normalized:!0}),s=new z(t,{itemSize:4,dataType:R.UnsignedByte,stride:i,offset:8,normalized:!0}),o=new z(t,{itemSize:2,dataType:R.Short,stride:i,offset:12,normalized:!1});return new de(e,{a_vec4_vertex:n,a_vec4_identifier:s,a_vec2_dem_position:o})},f1=(t,e)=>{const i=ws.sinks.sideFill.stride,n=new z(t,{itemSize:4,dataType:R.UnsignedShort,stride:i,offset:0,normalized:!0}),s=new z(t,{itemSize:2,dataType:R.Short,stride:i,offset:12,normalized:!1}),o=new z(t,{itemSize:4,dataType:R.UnsignedByte,stride:i,offset:16,normalized:!0});return new de(e,{a_vec4_vertex:n,a_vec4_identifier:o,a_vec2_dem_position:s})},_1=(t,e)=>{const i=ws.sinks.sideFill.stride,n=new z(t,{itemSize:3,dataType:R.UnsignedShort,stride:i,offset:0,normalized:!0}),s=new z(t,{itemSize:2,dataType:R.Short,stride:i,offset:12,normalized:!1});return new de(e,{a_vec3_vertex:n,a_vec2_dem_position:s})},NL=(t,e)=>{const i=bs.sinks.fill.stride,n=new z(t,{itemSize:4,dataType:R.UnsignedShort,stride:i,offset:0,normalized:!0}),s=new z(t,{itemSize:2,dataType:R.Short,stride:i,offset:8,normalized:!1});return new de(e,{a_vec4_vertex:n,a_vec2_dem_position:s})},UL=(t,e)=>{const i=bs.sinks.fill.stride,n=new z(t,{itemSize:3,dataType:R.UnsignedShort,stride:i,offset:0,normalized:!0}),s=new z(t,{itemSize:2,dataType:R.Short,stride:i,offset:8,normalized:!1});return new de(e,{a_vec3_vertex:n,a_vec2_dem_position:s})},m1=(t,e)=>{const n=new z(t,{itemSize:4,dataType:R.UnsignedShort,stride:20,offset:0,normalized:!0}),s=new z(t,{itemSize:1,dataType:R.Short,stride:20,offset:6,normalized:!0}),o=new z(t,{itemSize:2,dataType:R.Byte,stride:20,offset:8,normalized:!1}),r=new z(t,{itemSize:2,dataType:R.Byte,stride:20,offset:10,normalized:!1}),a=new z(t,{itemSize:3,dataType:R.Byte,stride:20,offset:12,normalized:!1}),l=new z(t,{itemSize:2,dataType:R.Short,stride:20,offset:16,normalized:!1});return new de(e,{a_vec4_vertex:n,a_vec2_normal:o,a_vec2_normal_delta:r,a_vec3_direction:a,a_float_distance:s,a_vec2_dem_position:l})},GL=(t,e)=>{const n=new z(t,{itemSize:3,dataType:R.UnsignedShort,stride:40,offset:0,normalized:!0}),s=new z(t,{itemSize:3,dataType:R.Short,stride:40,offset:6,normalized:!0}),o=new z(t,{itemSize:2,dataType:R.Short,stride:40,offset:12,normalized:!1}),r=new z(t,{itemSize:2,dataType:R.Short,stride:40,offset:16,normalized:!1}),a=new z(t,{itemSize:2,dataType:R.UnsignedShort,stride:40,offset:20,normalized:!1}),l=new z(t,{itemSize:2,dataType:R.Short,stride:40,offset:24,normalized:!1}),c=new z(t,{itemSize:4,dataType:R.UnsignedByte,stride:40,offset:32,normalized:!0});return new de(e,{a_vec3_flat_position:n,a_vec3_ecef_position:s,a_vec2_offset:o,a_vec2_check_offset:r,a_vec2_texcoord:a,a_vec2_range:l,a_vec4_tex_identifier:c})},jL=(t,e)=>{const n=new z(t,{itemSize:3,dataType:R.UnsignedShort,stride:40,offset:0,normalized:!0}),s=new z(t,{itemSize:3,dataType:R.Short,stride:40,offset:6,normalized:!0}),o=new z(t,{itemSize:2,dataType:R.Short,stride:40,offset:12,normalized:!1}),r=new z(t,{itemSize:2,dataType:R.UnsignedShort,stride:40,offset:20,normalized:!1}),a=new z(t,{itemSize:2,dataType:R.Short,stride:40,offset:24,normalized:!1}),l=new z(t,{itemSize:4,dataType:R.UnsignedByte,stride:40,offset:36,normalized:!0});return new de(e,{a_vec3_flat_position:n,a_vec3_ecef_position:s,a_vec2_offset:o,a_vec2_texcoord:r,a_vec2_range:a,a_vec4_identifier:l})},VL=(t,e)=>{const n=new z(t,{itemSize:3,dataType:R.UnsignedShort,stride:40,offset:0,normalized:!0}),s=new z(t,{itemSize:3,dataType:R.Short,stride:40,offset:6,normalized:!0}),o=new z(t,{itemSize:2,dataType:R.Short,stride:40,offset:12,normalized:!1}),r=new z(t,{itemSize:2,dataType:R.UnsignedShort,stride:40,offset:20,normalized:!1}),a=new z(t,{itemSize:2,dataType:R.Short,stride:40,offset:24,normalized:!1}),l=new z(t,{itemSize:4,dataType:R.UnsignedByte,stride:40,offset:28,normalized:!0});return new de(e,{a_vec3_flat_position:n,a_vec3_ecef_position:s,a_vec2_offset:o,a_vec2_texcoord:r,a_vec2_range:a,a_vec4_identifier:l})},HL=(t,e)=>{const n=new z(t,{itemSize:3,dataType:R.UnsignedShort,stride:16,offset:0,normalized:!0}),s=new z(t,{itemSize:2,dataType:R.Short,stride:16,offset:8,normalized:!1}),o=new z(t,{itemSize:4,dataType:R.UnsignedByte,stride:16,offset:12,normalized:!0});return new de(e,{a_vec4_position:n,a_vec2_offset:s,a_vec4_identifier:o})},p1=(t,e)=>{const n=new z(t,{itemSize:2,dataType:R.UnsignedShort,stride:12,offset:0,normalized:!0}),s=new z(t,{itemSize:2,dataType:R.Byte,stride:12,offset:8,normalized:!1}),o=new z(t,{itemSize:2,dataType:R.Byte,stride:12,offset:10,normalized:!1});return new de(e,{a_vec2_position:n,a_vec2_direction:s,a_vec2_widen_direction:o})},ZL=(t,e)=>{const i=Fn.sinks.fill.stride,n=new z(t,{itemSize:3,dataType:R.UnsignedShort,stride:i,offset:0,normalized:!0}),s=new z(t,{itemSize:2,dataType:R.UnsignedShort,stride:i,offset:8,normalized:!1}),o=new z(t,{itemSize:2,dataType:R.Short,stride:i,offset:16,normalized:!1});return new de(e,{a_vec3_vertex:n,a_vec2_texcoord:s,a_vec2_dem_position:o})},$L=(t,e)=>{const i=Fn.sinks.fill.stride,n=new z(t,{itemSize:3,dataType:R.UnsignedShort,stride:i,offset:0,normalized:!0}),s=new z(t,{itemSize:4,dataType:R.UnsignedByte,stride:i,offset:12,normalized:!0}),o=new z(t,{itemSize:2,dataType:R.Short,stride:i,offset:16,normalized:!1});return new de(e,{a_vec3_vertex:n,a_vec4_identifier:s,a_vec2_dem_position:o})},WL=(t,e)=>{const i=Fn.sinks.fill.stride,n=new z(t,{itemSize:3,dataType:R.UnsignedShort,stride:i,offset:0,normalized:!0}),s=new z(t,{itemSize:2,dataType:R.Short,stride:i,offset:16,normalized:!1}),o=new z(t,{itemSize:4,dataType:R.UnsignedByte,stride:i,offset:20,normalized:!0});return new de(e,{a_vec3_vertex:n,a_vec4_identifier:o,a_vec2_dem_position:s})},XL=(t,e)=>{const i=Fn.sinks.fill.stride,n=new z(t,{itemSize:3,dataType:R.UnsignedShort,stride:i,offset:0,normalized:!0}),s=new z(t,{itemSize:2,dataType:R.Short,stride:i,offset:16,normalized:!1});return new de(e,{a_vec3_vertex:n,a_vec2_dem_position:s})},YL=(t,e)=>{const n=new z(t,{itemSize:2,dataType:R.UnsignedShort,stride:8,offset:0,normalized:!0}),s=new z(t,{itemSize:4,dataType:R.Byte,stride:8,offset:4,normalized:!1});return new de(e,{a_vec3_vertex:n,a_vec4_direction_distance:s})},D_=(t,e)=>{const n=new z(t,{itemSize:3,dataType:R.UnsignedShort,stride:16,offset:0,normalized:!0}),s=new z(t,{itemSize:1,dataType:R.Float,stride:16,offset:4,normalized:!1}),o=new z(t,{itemSize:4,dataType:R.Byte,stride:16,offset:8,normalized:!1}),r=new z(t,{itemSize:2,dataType:R.Short,stride:16,offset:12,normalized:!1}),a=new z(t,{itemSize:1,dataType:R.Float,stride:16,offset:12,normalized:!1});return new de(e,{a_vec3_vertex:n,a_float_z:s,a_vec4_direction_distance:o,a_vec2_dem_position:r,a_float_abs_z:a})},g1=(t,e)=>{const n=new z(t,{itemSize:2,dataType:R.UnsignedShort,stride:36,offset:0,normalized:!0}),s=new z(t,{itemSize:2,dataType:R.UnsignedShort,stride:36,offset:4,normalized:!0}),o=new z(t,{itemSize:4,dataType:R.Byte,stride:36,offset:8,normalized:!1}),r=new z(t,{itemSize:2,dataType:R.Short,stride:36,offset:12,normalized:!1}),a=new z(t,{itemSize:2,dataType:R.Short,stride:36,offset:16,normalized:!1}),l=new z(t,{itemSize:1,dataType:R.Float,stride:36,offset:20,normalized:!1}),c=new z(t,{itemSize:1,dataType:R.Float,stride:36,offset:24,normalized:!1}),d=new z(t,{itemSize:1,dataType:R.Float,stride:36,offset:28,normalized:!1}),h=new z(t,{itemSize:4,dataType:R.UnsignedByte,stride:36,offset:32,normalized:!0});return new de(e,{a_vec2_vertex:n,a_vec2_segment_end:s,a_vec4_texture_widen_arrow_widen:o,a_vec2_widen:r,a_vec2_direction:a,a_float_distance_from_start:l,a_float_object_length:c,a_float_type:d,a_vec4_identifier:h})},O_=(t,e)=>{const i=da.sinks.fill.stride,n=new z(t,{itemSize:3,dataType:R.UnsignedShort,stride:i,offset:0,normalized:!0}),s=new z(t,{itemSize:3,dataType:R.Short,stride:i,offset:6,normalized:!0}),o=new z(t,{itemSize:2,dataType:R.Short,stride:i,offset:12,normalized:!1});return new de(e,{a_vec3_flat_position:n,a_vec3_ecef_position:s,a_vec2_widen:o})},qL=(t,e)=>{const i=da.sinks.fill.stride,n=new z(t,{itemSize:3,dataType:R.UnsignedShort,stride:i,offset:0,normalized:!0}),s=new z(t,{itemSize:3,dataType:R.Short,stride:i,offset:6,normalized:!0}),o=new z(t,{itemSize:2,dataType:R.Short,stride:i,offset:12,normalized:!1}),r=new z(t,{itemSize:4,dataType:R.UnsignedByte,stride:i,offset:16,normalized:!0});return new de(e,{a_vec3_flat_position:n,a_vec3_ecef_position:s,a_vec2_widen:o,a_vec4_identifier:r})},KL=(t,e)=>{const i=fa.sinks.fill.stride,n=new z(t,{itemSize:2,dataType:R.UnsignedShort,stride:i,offset:0,normalized:!0}),s=new z(t,{itemSize:2,dataType:R.UnsignedShort,stride:i,offset:4,normalized:!1});return new de(e,{a_vec2_vertex:n,a_vec2_texcoord:s})},JL=(t,e)=>{const i=Js.sinks.framebuffer.stride,n=new z(t,{itemSize:2,dataType:R.UnsignedShort,stride:i,offset:0,normalized:!0}),s=new z(t,{itemSize:1,dataType:R.Float,stride:i,offset:4,normalized:!1}),o=new z(t,{itemSize:2,dataType:R.Byte,stride:i,offset:8,normalized:!1});return new de(e,{a_vec2_position:n,a_vec2_widen:o,a_float_weight:s})},QL=(t,e)=>{const i=new z(t,{itemSize:2,dataType:R.Float,stride:0,offset:0,normalized:!1});return new de(e,{a_vec2_position:i})},v1=(t,e)=>{const n=new z(t,{itemSize:3,dataType:R.Float,stride:12,offset:0});return new de(e,{a_vec3_position:n})},Ma=(t,e)=>new de(e,{a_vec2_position:t}),B_=(t,e)=>{const i=hi.sinks.elevation.stride,n=new z(t,{itemSize:2,dataType:R.UnsignedShort,stride:i,offset:0,normalized:!0}),s=new z(t,{itemSize:3,dataType:R.Float,stride:i,offset:4,normalized:!1}),o=new z(t,{itemSize:1,dataType:R.Float,stride:i,offset:16,normalized:!1});return new de(e,{a_vec2_vertex:n,a_vec3_normal:s,a_float_height:o})},eC=(t,e)=>{const i=hi.sinks.flatBottom.stride,n=new z(t,{itemSize:2,dataType:R.UnsignedShort,stride:i,offset:0,normalized:!0}),s=new z(t,{itemSize:2,dataType:R.Short,stride:i,offset:4,normalized:!1}),o=new z(t,{itemSize:2,dataType:R.Byte,stride:i,offset:8,normalized:!0});return new de(e,{a_vec2_vertex:n,a_vec2_centroid:s,a_vec2_extender:o})},k_=(t,e)=>{const i=hi.sinks.hillshade.stride,n=new z(t,{itemSize:2,dataType:R.UnsignedShort,stride:i,offset:0,normalized:!0}),s=new z(t,{itemSize:2,dataType:R.UnsignedShort,stride:i,offset:4,normalized:!1});return new de(e,{a_vec2_vertex:n,a_vec2_texcoord:s})},Xd=t=>(e,i,n,s)=>{const o=ss.sinks.instances.stride,r=new z(e,{itemSize:3,dataType:R.UnsignedShort,stride:o,offset:0,normalized:!0,instanceDivisor:1}),a=new z(e,{itemSize:3,dataType:R.Short,stride:o,offset:8,normalized:!0,instanceDivisor:1}),l=new z(e,{itemSize:9,dataType:R.Float,stride:o,offset:16,instanceDivisor:1}),c=new z(e,{itemSize:4,dataType:R.UnsignedByte,stride:o,offset:t?56:52,normalized:!0,instanceDivisor:1}),d=new z(e,{itemSize:1,dataType:R.Float,stride:o,offset:60,normalized:!1,instanceDivisor:1});return new de(i,{a_vec3_instance_position:r,a_vec3_instance_ecef_position:a,a_mat3_instance_matrix:l,a_vec4_instance_localid:c,a_float_abs_z:d,...s},n)},N_=(t,e)=>{const i=va.sinks.fill.stride,n=new z(t,{itemSize:2,dataType:R.UnsignedShort,stride:i,offset:0,normalized:!0}),s=new z(t,{itemSize:1,dataType:R.Float,stride:i,offset:4,normalized:!1}),o=new z(t,{itemSize:2,dataType:R.Short,stride:i,offset:8,normalized:!1}),r=new z(t,{itemSize:3,dataType:R.Byte,stride:i,offset:12,normalized:!1}),a=new z(t,{itemSize:1,dataType:R.Byte,stride:i,offset:15,normalized:!1}),l=new z(t,{itemSize:2,dataType:R.Short,stride:i,offset:16,normalized:!1}),c=new z(t,{itemSize:1,dataType:R.Float,stride:i,offset:16,normalized:!1}),d=new z(t,{itemSize:1,dataType:R.UnsignedByte,stride:i,offset:20,normalized:!1});return new de(e,{a_vec2_vertex:n,a_float_z:s,a_vec2_extender:o,a_vec3_normal:r,a_float_gradient:a,a_vec2_dem_position:l,a_float_abs_z:c,a_float_is_pivot:d})},tC=(t,e)=>{const i=new z(t,{itemSize:2,dataType:R.Float,stride:0,offset:0,normalized:!1});return new de(e,{a_vec2_vertex:i})},y1=(t,e)=>{const i=new z(t,{itemSize:2,dataType:R.Byte,stride:0,offset:0,normalized:!1});return new de(e,{a_vec2_vertex:i})},iC=(t,e)=>{const i=new z(t,{itemSize:2,dataType:R.Byte,stride:0,offset:0,normalized:!1});return new de(e,{a_vec2_vertex:i})},w1=(t,e,i)=>{const n=ya.sinks.fill.stride;return new de(e,{a_vec3_ecef_position:new z(t,{itemSize:3,dataType:R.Short,stride:n,normalized:!0,offset:0}),a_vec3_flat_position:new z(t,{itemSize:3,dataType:R.UnsignedShort,stride:n,normalized:!0,offset:6}),a_vec2_texture:new z(t,{itemSize:2,dataType:R.UnsignedShort,stride:n,normalized:!0,offset:12})},i)},nC=(t,e)=>new de(e,{a_vec3_position:new z(t,{itemSize:3,dataType:R.Float,stride:16,offset:0,normalized:!0}),a_fade_opacity:new z(t,{itemSize:1,dataType:R.Float,stride:16,offset:12,normalized:!1})}),Ia=32,b1=1/0,sC="raster";class U_ extends Qf{constructor(e,i,n,s){var r,a;super(sC),this.children=[],this.identifyChildren=[];const o=this;this.setTileCoords(e,i.map.state),(a=(r=i.renderer.symbolSettingsList.dem)==null?void 0:r[s])==null||a.forEach(l=>{const c={id:Vn(),type:Xi.Tile,symbol:"dem",sink:s,tile:this,attributes:{layerId:is,styleId:i.map.state.handyStyleId,tileData:[]},start:0,count:Ia*Ia*6,attributesHash:"",layerSettings:l,vao:n[s],canRender:!0,renderingProperties:{flatTexture:null,hillshadeTexture:null,flatIdentifyTexture:null}};l.identify?o.identifyChildren.push(c):l.depthTest?o.depthTestChildren.push(c):l.shadow?o.shadowChildren.push(c):o.children.push(c)})}setTileCoords(e,i){const n=e[2],s=e[3],o=Mt(n);this.coords=e,this.size=o,this.zoomLevel=n,this.detailLevel=s,this.mvpMatrices.clear(),this.demMatrices.clear(),this.flatMapTexMatrices.clear(),this.syncReplicas(i)}syncReplicas({visibleMapReplicas:e}){const i=Math.pow(2,this.coords[2]),n=this.size/Ia;this.bounds.clear(),this.modelMatrices.clear(),e.forEach(s=>{const o=[this.coords[0]+s*i,this.coords[1],this.coords[2],this.coords[3]],r=Wi(o);r[0]-=n,r[1]-=n,this.bounds.set(s,{min:[r[0],r[1]],max:[r[0]+this.size,r[1]+this.size]});const a=Gi();En(a,r,at(this.size+n,this.size+n,No)),this.modelMatrices.set(s,a)}),this.needSync=!1}}class oC{constructor(e,i){this.meshTiles=new Map,this.groundTiles=new Map,this.destroyed=!1,this.modules=e.modules,this.maxZoom=(i==null?void 0:i.maxZoom)??b1;const n=[];for(let o=0;o<Ia;o++)for(let r=0;r<Ia;r++)n.push(r,o,r+1,o,r,o+1),n.push(r,o+1,r+1,o,r+1,o+1);const s=rt/Ia;for(let o=0;o<n.length;o++)n[o]*=s;this.buffer=new R(new Uint16Array(n),{itemSize:2,dataType:R.UnsignedShort,stride:0,offset:0,normalized:!0}),this.buffer.drawType=R.StaticDraw,this.vaos={mesh:Ma(this.buffer,this.modules.renderer.getShaderProgram("demMesh")),ground:Ma(this.buffer,this.modules.renderer.getShaderProgram("demGround"))},this.update()}destroy(){this.destroyed||(this.meshTiles=new Map,this.groundTiles=new Map,Object.values(this.vaos).forEach(e=>{e.unbind(),e.remove()}),this.buffer.remove(),this.destroyed=!0)}setMaxZoom(e=b1){e!==this.maxZoom&&(this.maxZoom=e,this.update())}update(){if(this.destroyed)return;const e=this.modules.map.state;e.needReplicasUpdate&&(this.meshTiles.forEach(o=>{o.needSync=!0}),this.groundTiles.forEach(o=>{o.needSync=!0}));const i=Math.trunc(e.styleZoom),n=Math.min(i,Math.min(this.maxZoom,i)),s=Du(this.modules.map.state,this.modules,n,0,n).reduce((o,r)=>(o.set(Ce(r),r),o),new Map);this.meshTiles.forEach((o,r)=>{s.has(r)||(this.meshTiles.delete(r),this.groundTiles.delete(r))}),s.forEach((o,r)=>{this.meshTiles.has(r)||(this.meshTiles.set(r,new U_(o,this.modules,this.vaos,"mesh")),this.groundTiles.set(r,new U_(o,this.modules,this.vaos,"ground")))})}updateStyleId(){this.meshTiles.forEach(e=>this.updateTileStyleId(e)),this.groundTiles.forEach(e=>this.updateTileStyleId(e))}updateTileStyleId(e){e.children.forEach(i=>{i.attributes.styleId=this.modules.map.state.handyStyleId}),e.identifyChildren.forEach(i=>{i.attributes.styleId=this.modules.map.state.handyStyleId}),e.depthTestChildren.forEach(i=>{i.attributes.styleId=this.modules.map.state.handyStyleId}),e.shadowChildren.forEach(i=>{i.attributes.styleId=this.modules.map.state.handyStyleId})}}class Ul{constructor(e,i=!1){this.dataType=e,this.pendingRequests=new Map,this.ignoredStatusCodes=i?[204,404]:[204]}async fetch(e,i,n=3,s=300){var r;let o=0;for(;o<=n;)try{const a=await this.fetchAttempt(e,i);if(!a.error||!w0((r=a.error)==null?void 0:r.status))return a;throw new Error(`Fetching ${e} attempt ${o} failed.`)}catch{if(o>=n)return{rejected:!0};await b0(Math.pow(2,o)*s),o++}return{rejected:!0}}destroy(){this.pendingRequests.forEach((e,i)=>{this.abortRequest(i)})}abortRequest(e){const i=this.pendingRequests.get(e);i!==void 0&&(i.xhr.abort(),i.resolve({rejected:!0}),this.pendingRequests.delete(e))}fetchAttempt(e,i){return new Promise(n=>{const s=i(e),o=Ce(e),a=(this.dataType==="json"?gA:f_)({url:s},(l,c)=>{if(this.pendingRequests.delete(o),l!==void 0){this.ignoredStatusCodes.includes(l.status)||console.error(`Failed to fetch a tile by url "${s}" Error: status "${l.status}", message: ${l.message}`),n({error:l});return}n({data:c})});this.pendingRequests.set(o,{xhr:a,resolve:n})})}}class rC{constructor(e,i,n){this.id=e,this.modules=i,this.options=n,this.type="dem",this.tree=lf(),this.tileSize=ra,this.minElevation=0,this.revision=0,this.tileLoader=new Ul("arrayBuffer"),this.attributes={},this.tiles=new Map,this.textureIndices=new Map,this.url=s=>{const[o,r,a]=Jr(s);return this.options.url(o,r,a)}}abortTileFetch(e){this.tileLoader.abortRequest(Ce(e))}deleteTile(e){const i=Ce(e);if(this.tiles.get(i)){const s=xo(e);this.tree.remove({minX:s.min[0],minY:s.min[1],maxX:s.max[0],maxY:s.max[1]},(o,r)=>i===r.key),this.updateRevision()}this.tiles.delete(i);const n=this.textureIndices.get(i);n!==void 0&&this.modules.imageManager.deleteTexture(n),this.updateMinElevation()}fetchTile(e){const i=Ce(e),n=[{regionId:0,metatileHash:-1}];if(this.tiles.has(i))return Promise.resolve(n);const s=this.url(e);return this.tileLoader.fetch(e,()=>s).then(o=>(o.rejected||(this.tiles.set(i,o.data&&o.data.byteLength?this.unpackRaw(o.data,e):void 0),this.updateRevision()),n),()=>Promise.resolve(void 0))}async generateTile(e,i,n,s,o,r){const a=[],l=[],c=Ce(i),d=this.tiles.get(c);if(!d)return Promise.resolve({results:a,transferable:l});const h=this.modules.map.state.handyStyleId,{collector:u}=this.modules,f=Mt(i[2]),m=d.bounds;this.tree.insert({key:c,minX:m.min[0],minY:m.min[1],maxX:m.max[0],maxY:m.max[1],cellSize:f/ra,...d}),this.updateMinElevation();do hi.generateMeshElevation(u,d.mesh,h,is);while(u.isOverloaded());const p=u.getAccumulatedData();return a.push({regionId:0,metatileHash:-1,styleId:h,collectorOutput:p}),l.push(...p.transferable),Promise.resolve({results:a,transferable:l})}unpackRaw(e,i){const[n,s,o,r]=i,a=new Uint8Array(e),l=new Float32Array(this.tileSize**2);let c=1/0,d=-1/0;const h=this.tileSize;for(let m=0;m<h;m++){const p=Z.toGeo(Wi([n,s+m*(1/ra),o,r])),_=Z.scaleFactor(p[1]);for(let g=0;g<h;g++){const y=g+m*h,b=(a[y]+a[h**2+y]*256-1e4)*_;c=Math.min(b,c),d=Math.max(b,d),l[y]=b}}const u=this.getMesh(l),f=Tv(u.vertices,u.indices);return{data:l,mesh:u,tree:f,minZ:c,maxZ:d,bounds:{min:Wi(i),max:Wi([n+1,s+1,o,r])}}}getAttributes(){return this.attributes}setAttributes(e){this.attributes=e}getId(){return this.id}destroy(){const{imageManager:e}=this.modules;this.tileLoader.destroy(),this.tiles.clear(),this.tree.clear(),this.textureIndices.forEach(i=>e.deleteTexture(i)),this.textureIndices.clear()}getElevation(e){const i=this.getElevationTile(e);if(i)return Ev(i,e)}getElevationTile(e){const i=Li(e);return this.tree.search({minX:i[0],minY:i[1],maxX:i[0],maxY:i[1]}).reduce((s,o)=>!s||s.cellSize>o.cellSize?o:s,void 0)}getMinElevation(){return this.minElevation}updateMinElevation(){const e=this.modules.map.state;if(!e.demMode)return;const i=this.modules.camera.position[2],n=bo(e.tilesBounds);if(e.elevation!==void 0){const o=e.elevation*Ge/i+1,r=Math.max(e.pitch/e.maxPitch*30,4);ig(n,Math.min(o,r))}const s=this.tree.search({minX:n.min[0],minY:n.min[1],maxX:n.max[0],maxY:n.max[1]});e.styleZoom-sm>1?this.minElevation=s.reduce((o,r)=>{if(r.data){const a=k2(n,r.bounds);Ai(a.min,a.min,r.bounds.min),Ai(a.max,a.max,r.bounds.min),Ei(a.min,a.min,1/r.cellSize),Ei(a.max,a.max,1/r.cellSize);for(let l=Math.trunc(a.min[0]);l<a.max[0];l++)for(let c=Math.trunc(a.min[1]);c<a.max[1];c++){const d=l+(ra-1-c)*ra,h=r.data[d];o=o===void 0?h:Math.min(o,h)}}return o},void 0):this.minElevation=s.reduce((o,r)=>o===void 0?r.minZ:Math.min(o,r.minZ),void 0)}getRevision(){return this.revision}updateRevision(){this.revision++}getMesh(e){const i=this.tileSize,n=[],s=[];let o=0;for(let r=0;r<i;r++)for(let a=0;a<i;a++){const l=r*i+a;n[3*l+0]=a/(i-1)*xe,n[3*l+1]=(1-r/(i-1))*xe,n[3*l+2]=e[l],a<i-1&&r<i-1&&(s[o++]=l+1,s[o++]=l,s[o++]=l+i,s[o++]=l+1,s[o++]=l+i,s[o++]=l+i+1)}return{vertices:n,indices:s,normals:new Float32Array(i*i*3)}}}var G_,x1;function aC(){if(x1)return G_;x1=1,G_=n;var t=128,e=-128,i=Math.pow(2,31);function n(s,o,r){if(Number.MAX_SAFE_INTEGER&&s>Number.MAX_SAFE_INTEGER)throw n.bytes=0,new RangeError("Could not encode varint");o=o||[],r=r||0;for(var a=r;s>=i;)o[r++]=s&255|t,s/=128;for(;s&e;)o[r++]=s&255|t,s>>>=7;return o[r]=s|0,n.bytes=r-a+1,o}return G_}var j_,S1;function lC(){if(S1)return j_;S1=1,j_=i;var t=128,e=127;function i(n,r){var o=0,r=r||0,a=0,l=r,c,d=n.length;do{if(l>=d||a>49)throw i.bytes=0,new RangeError("Could not decode varint");c=n[l++],o+=a<28?(c&e)<<a:(c&e)*Math.pow(2,a),a+=7}while(c>=t);return i.bytes=l-r,o}return j_}var V_,M1;function cC(){if(M1)return V_;M1=1;var t=Math.pow(2,7),e=Math.pow(2,14),i=Math.pow(2,21),n=Math.pow(2,28),s=Math.pow(2,35),o=Math.pow(2,42),r=Math.pow(2,49),a=Math.pow(2,56),l=Math.pow(2,63);return V_=function(c){return c<t?1:c<e?2:c<i?3:c<n?4:c<s?5:c<o?6:c<r?7:c<a?8:c<l?9:10},V_}var H_,I1;function dC(){return I1||(I1=1,H_={encode:aC(),decode:lC(),encodingLength:cC()}),H_}var hC=dC();const T1=Ja(hC);class uC{constructor(e){const i=ArrayBuffer.isView(e)?e.buffer:e;this.buf=new Uint8Array(i),this.view=new DataView(i),this.pos=0}readBytes(e){const i=this.buf.subarray(this.pos,this.pos+e);return this.pos+=e,i}readUint16(){const e=this.view.getUint16(this.pos,!0);return this.pos+=2,e}readUint32(){const e=this.view.getUint32(this.pos,!0);return this.pos+=4,e}readInt32(){const e=this.view.getInt32(this.pos,!0);return this.pos+=4,e}readVarint(){const e=T1.decode(this.buf,this.pos);return this.pos+=T1.decode.bytes??0,e}readSVarint(){const e=this.readVarint();return e%2===1?(e+1)/-2:e/2}}function fC(t){const e=new uC(t);e.readUint32(),e.readUint16(),e.readUint16(),e.readUint16(),e.readUint16();const i=Z_(e.readInt32()),n=Z_(e.readInt32()),s=e.readUint32(),o=[];for(let r=0;r<s;r++){const a=e.readUint32(),l=new Uint16Array(a*2);for(let _=0;_<a;_++)l[_*2]=e.readUint16(),l[_*2+1]=e.readUint16();const c=[];E1(e,c,a,Z_);const d=[];for(let _=0;_<a;_++)d.push(l[_*2]),d.push(l[_*2+1]),d.push(c[_]);const h=e.readUint32(),u=[];E1(e,u,h);const f={vertices:d,indices:u},m=e.readUint32();if(m>0){const _=[];new Int8Array(e.readBytes(m*3)).forEach(g=>_.push(_C(g))),f.normals=_}const p=e.readUint32();if(p>0){const _={};for(let g=0;g<p;g++){const y=e.readUint16(),b=e.readInt32();_[y]=b}f.attributes=_}o.push(f)}return{dataGroups:o,minZ:i,maxZ:n}}function E1(t,e,i,n){let s=0;for(let o=0;o<i;o++){const a=t.readSVarint()+s;e.push(n?n(a):a),s=a}}function Z_(t){return t/Ge}function _C(t){return t/127}function mC(t){const e=new Sc(t),i=$_(e.readFixed32()),n=$_(e.readFixed32()),s=e.readFixed32(),o=e.readBytes(),r=new Uint16Array(o.buffer.slice(o.byteOffset,o.byteOffset+o.byteLength)),a=[];let l=0;for(let h=0;h<s;h++)a.push(r[h*2]),a.push(r[h*2+1]),a.push($_(e.readSVarint()));const c=[];l=0;const d=e.readFixed32();for(let h=0;h<d;h++){const u=e.readSVarint(),f=l+u;l+=u,c.push(f)}return{dataGroups:[{vertices:a,indices:c}],minZ:i,maxZ:n}}function $_(t){return t/100}class pC{constructor(e,i,n){this.id=e,this.modules=i,this.options=n,this.type="dem",this.tree=lf(),this.minElevation=0,this.revision=0,this.tileLoader=new Ul("arrayBuffer"),this.attributes={},this.tiles=new Map,this.textureIndices=new Map,this.url=s=>{const[o,r,a]=Jr(s);return this.options.url(o,r,a)}}abortTileFetch(e){this.tileLoader.abortRequest(Ce(e))}deleteTile(e){const i=Ce(e);if(this.tiles.get(i)){const s=xo(e);this.tree.remove({minX:s.min[0],minY:s.min[1],maxX:s.max[0],maxY:s.max[1]},(o,r)=>i===r.key),this.updateRevision()}this.tiles.delete(i);const n=this.textureIndices.get(i);n!==void 0&&this.modules.imageManager.deleteTexture(n),this.updateMinElevation()}fetchTile(e){const i=Ce(e),n=[{regionId:0,metatileHash:-1}];if(this.tiles.has(i))return Promise.resolve(n);const s=this.url(e),o=Ye(e);return this.tileLoader.fetch(e,()=>s).then(r=>(r.rejected||(this.tiles.set(i,r.data&&r.data.byteLength?this.tileDataToMesh(this.precomputeNormalsAndMinMaxZ(r.data,o),e):void 0),this.updateRevision()),n),()=>Promise.resolve(void 0))}async generateTile(e,i,n,s,o,r){const a=[],l=[],c=Ce(i),d=this.tiles.get(c);if(!d)return Promise.resolve({results:a,transferable:l});const h=this.modules.map.state.handyStyleId,{collector:u}=this.modules,f=Mt(i[2]),m=d.bounds;this.tree.insert({key:c,minX:m.min[0],minY:m.min[1],maxX:m.max[0],maxY:m.max[1],cellSize:f/ra,...d}),this.updateMinElevation();do hi.generateMeshElevation(u,d.mesh,h,is);while(u.isOverloaded());const p=u.getAccumulatedData();return u.reset(),a.push({regionId:0,metatileHash:-1,styleId:h,collectorOutput:p}),l.push(...p.transferable),Promise.resolve({results:a,transferable:l})}tileDataToMesh(e,i){const[n,s,o,r]=i,a=Tv(e.vertices,e.indices);return{data:void 0,mesh:e,minZ:e.minZ,maxZ:e.maxZ,tree:a,bounds:{min:Wi(i),max:Wi([n+1,s+1,o,r])}}}getAttributes(){return this.attributes}setAttributes(e){this.attributes=e}getId(){return this.id}destroy(){const{imageManager:e}=this.modules;this.tileLoader.destroy(),this.tiles.clear(),this.tree.clear(),this.textureIndices.forEach(i=>e.deleteTexture(i)),this.textureIndices.clear()}getElevation(e){const i=this.getElevationTile(e);if(i)return Ev(i,e)}getElevationTile(e){const i=Li(e);return this.tree.search({minX:i[0],minY:i[1],maxX:i[0],maxY:i[1]}).reduce((s,o)=>!s||s.cellSize>o.cellSize?o:s,void 0)}getMinElevation(){return this.minElevation}updateMinElevation(){const e=this.modules.map.state;if(!e.demMode)return;const i=this.modules.camera.position[2],n=bo(e.tilesBounds);if(e.elevation!==void 0){const o=e.elevation*Ge/i+1,r=Math.max(e.pitch/e.maxPitch*30,4);ig(n,Math.min(o,r))}const s=this.tree.search({minX:n.min[0],minY:n.min[1],maxX:n.max[0],maxY:n.max[1]});e.styleZoom-om>1?this.minElevation=s.reduce((o,r)=>o===void 0?r.minZ:Math.min(o,r.minZ),void 0):this.minElevation=s.reduce((o,r)=>o===void 0?r.minZ:Math.min(o,r.minZ),void 0)}getRevision(){return this.revision}precomputeNormalsAndMinMaxZ(e,i){var y,b;if(e.byteLength===0)return{vertices:[],indices:[],normals:new Float32Array(0),maxZ:0,minZ:0};const n=new Uint32Array(e.slice(0,4))[0]===777275726,{dataGroups:s,minZ:o,maxZ:r}=n?fC(e):mC(e),{vertices:a,indices:l}=s[0],c=Array(),d=new Map,h=[[],[],[]],u=[],f=[],m=[],p=!this.modules.map.state.useFlatDemIrregularMeshNormals,_=Ge*xe/i.size;for(let v=0;v<l.length;v+=3){for(let I=0;I<3;I++){const S=l[v+I];h[I][0]=a[S*3],h[I][1]=a[S*3+1],h[I][2]=a[S*3+2]*_}Ui(u,kr(u,vi(f,h[1],h[0]),vi(m,h[2],h[0])));for(let I=0;I<3;I++){const S=l[v+I],P=a[S*3],T=a[S*3+1],L=a[S*3+2];if(p){d.has(P)||d.set(P,new Map),d.get(P).has(T)||d.get(P).set(T,new Map);let B=d.get(P).get(T).get(L);B===void 0?(B=[...u],d.get(P).get(T).set(L,B)):Ot(B,B,u)}}}if(p){d.forEach(v=>v.forEach(I=>I.forEach(S=>Ui(S,S))));for(let v=0;v<a.length/3;v++){const I=(b=(y=d==null?void 0:d.get(a[v*3]))==null?void 0:y.get(a[v*3+1]))==null?void 0:b.get(a[v*3+2]);I?(c.push(I[0]),c.push(I[1]),c.push(I[2])):(console.log("no normal"),c.push(0,0,0))}}return{vertices:a,indices:l,normals:new Float32Array(c),maxZ:r,minZ:o}}updateRevision(){this.revision++}}const tn=new Float64Array(16);class W_{constructor(e,i,n){this.detailLevel=0,this.mvpMatrix=new Float64Array(16),this.texMatrix=new Float64Array(16),Nr(this.mvpMatrix,e),ri(this.texMatrix,fc,e),this.detailLevel=n,this.viewport=[[0,0,0,1],[1,0,0,1],[1,1,0,1],[0,1,0,1]],Ns(tn,this.texMatrix),this.viewport.forEach(s=>{Tn(s,s,tn),s[0]-=i[0],s[1]-=i[1],s[2]-=i[2],s[2]>=0&&(s[2]=-1),Ui(s,s);const o=-i[2]/s[2];s[0]=i[0]+s[0]*o,s[1]=i[1]+s[1]*o,s[2]=i[2]+s[2]*o})}}class gC{constructor(e){this.destroyed=!1,this.modules=e.modules,this.textures=[]}update(){if(this.destroyed)return;const{center:e,padding:i,rotation:n,size:s,viewport:o,extendedTilesBounds:r,zoom:a,cameraConfig:l,globeMode:c}=this.modules.map.state,d=wo(r[0],r[1]),h=Mc(r[2],d);this.textures=[];const u=ve(45),f=Math.min(this.modules.map.state.pitch,u),m=new hn({pitch:f,center:e,padding:i,rotation:n,size:s,viewport:o,zoom:a,cameraConfig:l,globeMode:c,styleState:{}}),p=Be(Math.pow(this.modules.map.state.pitch/u,3),0,1),[_,g]=this.modules.camera.position,y=hc([],[_,g,0,1],m.viewProjectionMatrix),b=Math.min(y[1]/y[3]+1,-.5);let v=Math.max(b,-1);if(En(tn,[0,-v,0],[1/nn[0],1/nn[1],1]),ri(tn,tn,m.viewProjectionMatrix),this.textures.push(new W_(tn,m.position,0)),Mc(this.textures[0].viewport[2],d)>=h)return!0;if(b<v){const S=Math.max(Math.abs(b-v)/2,1);En(tn,[0,2/S+1,0],[1/nn[0],nn[1]/S,1]),ri(tn,tn,m.viewProjectionMatrix),this.textures.push(new W_(tn,m.position,1))}v+=1;const I=Math.pow(s[1]/749,2);[1.4,3.2,12,31].some((S,P)=>{S=(S-1)*p*I+1,En(tn,[0,-(v*S+1),0],[1/nn[0],S/nn[1],1]),ri(tn,tn,m.viewProjectionMatrix),v+=2/S;const T=this.textures.push(new W_(tn,m.position,P));if(Mc(this.textures[T-1].viewport[2],d)>=h)return!0})}destroy(){this.textures=[]}}const De=(window==null?void 0:window.WebGLRenderingContext)??{},A1={depthMask:!0,depthTest:!0,depthFunc:De.LESS,cullFace:!0,cullFaceMode:De.BACK,blend:!1,blendFunc:{sfactor:De.ONE,dfactor:De.ZERO},blendEquation:De.FUNC_ADD,colorMask:[!0,!0,!0,!0],polygonOffsetFill:!1,polygonOffset:{factor:1,units:2}},wt=t=>Object.assign({},A1,t),vn=(t,e,i,n)=>{var r,a,l,c,d,h,u,f,m,p,_,g,y,b,v,I,S,P,T;const s=i.webglState;if(s.state===e&&s.layerState===(n==null?void 0:n.webglState))return;if(t.depthMask(((r=n==null?void 0:n.webglState)==null?void 0:r.depthMask)??e.depthMask),((a=n==null?void 0:n.webglState)==null?void 0:a.depthTest)??e.depthTest?(t.enable(t.DEPTH_TEST),t.depthFunc(((l=n==null?void 0:n.webglState)==null?void 0:l.depthFunc)??e.depthFunc)):t.disable(t.DEPTH_TEST),((c=n==null?void 0:n.webglState)==null?void 0:c.cullFace)??e.cullFace?(t.enable(t.CULL_FACE),t.cullFace(((d=n==null?void 0:n.webglState)==null?void 0:d.cullFaceMode)??e.cullFaceMode)):t.disable(t.CULL_FACE),((h=n==null?void 0:n.webglState)==null?void 0:h.blend)??e.blend){t.enable(t.BLEND),t.blendEquation(((u=n==null?void 0:n.webglState)==null?void 0:u.blendEquation)??e.blendEquation);const L=((f=n==null?void 0:n.webglState)==null?void 0:f.blendFuncSeparate)??e.blendFuncSeparate;L?t.blendFuncSeparate(L.srcRgb,L.dstRgb,L.srcAlpha,L.dstAlpha):t.blendFunc(((p=(m=n==null?void 0:n.webglState)==null?void 0:m.blendFunc)==null?void 0:p.sfactor)??e.blendFunc.sfactor,((g=(_=n==null?void 0:n.webglState)==null?void 0:_.blendFunc)==null?void 0:g.dfactor)??e.blendFunc.dfactor)}else t.disable(t.BLEND);const o=((y=n==null?void 0:n.webglState)==null?void 0:y.colorMask)??e.colorMask;t.colorMask(o[0],o[1],o[2],o[3]),((b=n==null?void 0:n.webglState)==null?void 0:b.polygonOffsetFill)??e.polygonOffsetFill?(t.enable(t.POLYGON_OFFSET_FILL),t.polygonOffset(((I=(v=n==null?void 0:n.webglState)==null?void 0:v.polygonOffset)==null?void 0:I.factor)??e.polygonOffset.factor,((P=(S=n==null?void 0:n.webglState)==null?void 0:S.polygonOffset)==null?void 0:P.units)??e.polygonOffset.units)):t.disable(t.POLYGON_OFFSET_FILL),(T=e.customStateBinder)==null||T.call(e,t),s.state=e,s.layerState=n==null?void 0:n.webglState},zt=wt({}),X_=wt({blend:!0,blendFunc:{sfactor:De.ONE,dfactor:De.ONE_MINUS_SRC_ALPHA}}),vC=wt({blend:!0,blendFunc:{sfactor:De.ONE,dfactor:De.ONE_MINUS_SRC_ALPHA},depthFunc:De.GREATER,depthMask:!1,cullFace:!1,polygonOffsetFill:!0,polygonOffset:{factor:1,units:2}}),Ta=wt({depthMask:!1,blend:!0,blendFunc:{sfactor:De.ONE,dfactor:De.ONE_MINUS_SRC_ALPHA}}),yC=wt({blend:!0,blendFunc:{sfactor:De.ONE,dfactor:De.ONE_MINUS_SRC_ALPHA},cullFace:!1}),_i=wt({depthMask:!1,depthTest:!1,blend:!0,blendFunc:{sfactor:De.ONE,dfactor:De.ONE_MINUS_SRC_ALPHA}}),wC=wt({depthMask:!1,depthTest:!1,blend:!0,blendFunc:{sfactor:De.SRC_ALPHA,dfactor:De.ONE}}),P1=wt({depthMask:!1,depthTest:!1,colorMask:[!0,!1,!1,!0]}),bC=wt({depthMask:!1,depthTest:!1}),no=wt({depthMask:!1,depthTest:!1}),L1=wt({depthMask:!1}),Yd=wt({colorMask:[!1,!1,!1,!1]}),xC=wt({colorMask:[!1,!1,!1,!1],depthFunc:De.ALWAYS}),C1=wt({blend:!0,blendFunc:{sfactor:De.ONE,dfactor:De.ONE_MINUS_SRC_ALPHA}}),R1=wt({depthFunc:De.EQUAL,blend:!0,blendFunc:{sfactor:De.ONE,dfactor:De.ONE_MINUS_SRC_ALPHA}}),Y_=wt({depthMask:!1,depthTest:!1,blend:!0,blendFunc:{sfactor:De.ONE,dfactor:De.ONE_MINUS_SRC_ALPHA}}),q_=wt({depthMask:!1,depthTest:!0,depthFunc:De.LEQUAL,blend:!0,blendFunc:{sfactor:De.ONE,dfactor:De.ONE_MINUS_SRC_ALPHA}}),K_=wt({depthMask:!1,depthTest:!0,depthFunc:De.GREATER,blend:!0,blendFunc:{sfactor:De.ONE,dfactor:De.ONE_MINUS_SRC_ALPHA}}),z1=wt({polygonOffsetFill:!0,polygonOffset:{factor:1,units:2},blend:!0,blendFunc:{sfactor:De.ONE,dfactor:De.ONE_MINUS_SRC_ALPHA}}),qd=wt({cullFaceMode:De.BACK}),Kd=wt({cullFace:!1}),F1=wt({depthMask:!1,depthTest:!1,blend:!0,blendFunc:{sfactor:De.ONE,dfactor:De.ONE}}),SC=wt({depthTest:!1,cullFace:!1}),MC=wt({depthTest:!1,depthMask:!1,blend:!0,blendFuncSeparate:{srcRgb:De.SRC_ALPHA,dstRgb:De.ONE_MINUS_SRC_ALPHA,srcAlpha:De.ONE,dstAlpha:De.ONE_MINUS_SRC_ALPHA}}),D1=wt({colorMask:[!0,!0,!0,!0],depthMask:!0}),IC=wt({colorMask:[!0,!0,!0,!0],depthMask:!1});function TC(t){return!O1(t)}function O1(t){if(!EC())return"not a browser";if(!PC())return"insufficient Function support";if(!CC())return"insufficient JSON support";if(!RC())return"insufficient worker support";if(!FC())return"insufficient ArrayBuffer support";if(!DC())return"insufficient Canvas/getImageData support";const e=OC(t&&t.failIfMajorPerformanceCaveat||!1);if(!e.ok)return`insufficient WebGL support${e.msg?`: ${e.msg}`:""}`;if(!AC())return"insufficient Array support";if(!LC())return"insufficient Object support";if(!zC())return"insufficient DOM support";if(!kC())return"insufficient ECMAScript 6 support"}function EC(){return typeof window<"u"&&typeof document<"u"}function AC(){return Array.prototype&&Array.prototype.every&&Array.prototype.filter&&Array.prototype.forEach&&Array.prototype.indexOf&&Array.prototype.map&&Array.prototype.some&&Array.prototype.reduce&&Array.isArray}function PC(){return!!(Function.prototype&&Function.prototype.bind)}function LC(){return!!(Object.keys&&Object.assign&&Object.create&&Object.getPrototypeOf&&Object.getOwnPropertyNames&&Object.getOwnPropertyDescriptor&&Object.defineProperty&&Object.freeze)}function CC(){return"JSON"in window&&"parse"in JSON&&"stringify"in JSON}function RC(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;const t=new Blob([""],{type:"text/javascript"}),e=URL.createObjectURL(t);let i,n=null;try{n=new Worker(e),i=!0}catch{i=!1}return n&&n.terminate(),URL.revokeObjectURL(e),i}function zC(){const t=document.createElement("div");return t&&typeof t.after=="function"}function FC(){return!!ArrayBuffer.isView}function DC(){const t=document.createElement("canvas");t.width=t.height=1;const e=t.getContext("2d");if(!e)return!1;const i=e.getImageData(0,0,1,1);return i&&i.width===t.width}const J_={};function OC(t){const e=String(t);return J_[e]===void 0&&(J_[e]=BC(t)),J_[e]}function Jd(t){const e=document.createElement("canvas"),i={antialias:!1,stencil:!0,failIfMajorPerformanceCaveat:t};if("WebGLRenderingContext"in window)return e.getContext("webgl",i)||e.getContext("experimental-webgl",i)}function BC(t){const e=Jd(t);if(!e)return{ok:!1,msg:"error on get context"};for(const n of["OES_element_index_uint","OES_standard_derivatives","OES_vertex_array_object"])if(!e.getExtension(n))return{ok:!1,msg:`${n} extension is not supported`};let i;try{i=e.createShader(e.VERTEX_SHADER)}catch{return{ok:!1,msg:"browser block shader API"}}return!i||e.isContextLost()?{ok:!1}:(e.shaderSource(i,"void main() {}"),e.compileShader(i),{ok:e.getShaderParameter(i,e.COMPILE_STATUS)===!0})}function kC(){return!document.documentMode}let xr;function NC(){return xr=void 0,Q_(),xr}function Q_(){const t=new Float32Array([-1,-1,1,-1,-1,1]),e=2,i=Jd(!1);if(!i)return xr="Failed to obtain WebGL context",!1;for(const m of["OES_element_index_uint","OES_standard_derivatives","OES_vertex_array_object","OES_texture_float","OES_texture_float_linear"])if(!i.getExtension(m))return xr=`Absent ${m} extension`,!1;const n=new Nt({size:[e,e]});n.bind(i);const s=new j(new Float32Array([1,0,1,0]),{size:[2,2],format:j.AlphaFormat,type:j.Float,magFilter:j.LinearFilter,minFilter:j.LinearFilter}).prepare(i),o=`attribute vec2 pos;
    void main () {
        gl_Position = vec4(pos, 0, 1);
    }`,r=`precision mediump float;
    uniform sampler2D tex;
    void main () {
        gl_FragColor = vec4(texture2D(tex, vec2(0.4, 0.4)).a, 0, 0, 0);
    }`,a=i.createShader(i.VERTEX_SHADER),l=i.createShader(i.FRAGMENT_SHADER);if(!a||!l||i.isContextLost())return xr="Cannot create shaders",!1;i.shaderSource(a,o),i.compileShader(a),i.shaderSource(l,r),i.compileShader(l);const c=i.createProgram();if(!c)return xr="Cannot compile shader program",!1;i.attachShader(c,a),i.attachShader(c,l),i.linkProgram(c),i.useProgram(c);const d=i.createBuffer();if(!d)return xr="Cannot create buffer",!1;i.bindBuffer(i.ARRAY_BUFFER,d),i.bufferData(i.ARRAY_BUFFER,t,i.STATIC_DRAW);const h=i.getAttribLocation(c,"pos");i.vertexAttribPointer(h,2,i.FLOAT,!1,0,0),i.enableVertexAttribArray(h),s.enable(i,0);const u=i.getUniformLocation(c,"tex");i.uniform1i(u,0),i.viewport(0,0,e,e),i.drawArrays(i.TRIANGLES,0,3);const f=new Uint8Array(4);return i.readPixels(0,0,1,1,i.RGBA,i.UNSIGNED_BYTE,f),n.unbind(i),f[0]!==255}function Qd(t){return t instanceof WebGLRenderingContext?!!t.getExtension("WEBGL_depth_texture"):!0}let eh=null;const th=(()=>{let t=null;return()=>{if(t!==null)return t;if(eh!==null)return eh;const e=Jd(!1);if(!e)return eh=!0,eh;const i=`
    attribute vec2 pos;
    varying float v1, v2, v3, v4, v5, v6, v7, v8, v9, v10;
    void main () {
        v1 = pos.x;
        v2 = pos.y;
        v3 = pos.x * 2.0;
        v4 = pos.y * 2.0;
        v5 = pos.x + pos.y;
        v6 = pos.x - pos.y;
        v7 = pos.x * pos.x;
        v8 = pos.y * pos.y;
        v9 = pos.x * pos.y;
        v10 = (pos.x + pos.y) / 2.0;

        gl_Position = vec4(pos, 0, 1);
    }`,n=`
    precision mediump float;
    varying float v1, v2, v3, v4, v5, v6, v7, v8, v9, v10;
    void main () {
        float result = v1 + v2 + v3 + v4 + v5 + v6 + v7 + v8 + v9 + v10;
        gl_FragColor = vec4(result / 10.0, 0, 0, 1); // усредняем результат
    }`,s=e.createShader(e.VERTEX_SHADER),o=e.createShader(e.FRAGMENT_SHADER);if(!s||!o||e.isContextLost())return t=!0,t;e.shaderSource(s,i),e.compileShader(s),e.shaderSource(o,n),e.compileShader(o);const r=e.createProgram();return!r||(e.attachShader(r,s),e.attachShader(r,o),e.linkProgram(r),!r||!e.getProgramParameter(r,e.LINK_STATUS))?(t=!0,t):(t=!1,t)}})(),UC=()=>{const t=Jd(!1);if(!t)return!1;if(!ZP)return!0;const e=t.getExtension("WEBGL_debug_renderer_info");return e?!(e?t.getParameter(e.UNMASKED_RENDERER_WEBGL):null).toUpperCase().includes("INTEL"):!1},GC=async()=>{if(!navigator)return!1;try{const t=navigator.gpu;if(typeof(t==null?void 0:t.requestAdapter)!="function"||!await t.requestAdapter({powerPreference:"high-performance"})||!document.createElement("canvas").getContext("webgpu",{}))return!1}catch{return!1}return!0},em=Hn(),tm=Hn(),im=Hn(),nm=Hn(),so=64,B1=5,sm=12,jC=5,om=15,VC=18,HC=12,ZC=18,ih=.001,$C=.1,WC=.3,nn=[1.7,1],XC="relief",YC=300,k1=.001,N1=1,U1=(t,e,i,n,s)=>{const o=Ka(t.tileServer,{subdomain:t.subdomains[Math.abs(e+i)%t.subdomains.length]});return`${t.tileProtocol}://${o}/v2/ald?ts=${s}&x=${e}&y=${i}&z=${n}`},nh=Oe(),Si=new Float64Array(16);class qC{constructor(e){this.demTextureMatrix=new Float64Array(16),this.demCorrectedFbVpToDemTex=new Float32Array(16),this.demTexToCorrectedTex=new Float32Array(16),this.correctedTexToDemTex=new Float32Array(16),this.isDemCorrectionEnabled=!1,this.demCorrectedScale=1,this.demFbVpMatrix=new Float64Array(16),this.demCorrectedFbVpMatrix=new Float64Array(16),this.demFramebufferId=li,this.correctedDemFramebufferId=li,this.flatFramebufferId=li,this.identifyFlatFramebufferId=li,this.hillshadeRampTextureId=NaN,this.hillshadeFramebufferId=li,this.groundFramebufferId=li,this.isGroundBufferValid=!1,this.lastStyleId=NaN,this.tilesRevision=0,this.tileSet=XC,this.modules=e,this.enabled=!1,this.sources=[],this.sourcesRevision=[],this.tileLayers=[],this.terrainAnimationScaleCoef=k1,this.reliefTileType="raster",this.elevationSourceType="regular",this.groundBuffer=new Float32Array,this.differ=new Et([])}enable(){if(this.isTerrainSupported===void 0&&(this.isTerrainSupported=Q_()),this.enabled||!this.isTerrainSupported)return;this.differ=new Et([{path:"center",type:"vec2"},{path:"zoom",type:"number"},{path:"size",type:"vec2"},{path:"rotation",type:"number"},{path:"pitch",type:"number"},{path:"demMode",type:"boolean"},{path:"elevation",type:"number"},{path:"minElevation",type:"number"}]),this.demFramebufferId=this.createDemFramebuffer(),this.correctedDemFramebufferId=this.createCorrectedDemFramebuffer(),this.hillshadeFramebufferId=this.createHillshadeFramebuffer(),this.flatFramebufferId=this.createFlatFramebuffer(),this.identifyFlatFramebufferId=this.createFlatIdentifyFramebuffer(),this.groundFramebufferId=this.createGroundFramebuffer(),this.fullscreenBuffer=new R(new Uint16Array([[0,0,0,0],[1,0,1,0],[0,1,0,1],[0,1,0,1],[1,0,1,0],[1,1,1,1]].reduce((i,n)=>{const[s,o,r,a]=n;return i.push(s*rt,o*rt,Yi(r),Yi(a)),i},[]))),this.hillshadeVao=k_(this.fullscreenBuffer,this.modules.renderer.getShaderProgram("demHillshade"));const e=this.modules.renderer.getShaderProgram("demElevationCopy");this.copyDemVao=k_(this.fullscreenBuffer,e),this.addDefaultSources(),this.modules.styleManager.setFramebufferId(this.modules.map.state.handyStyleId,is,{elevation:this.demFramebufferId,hillshade:this.hillshadeFramebufferId,flatBottom:this.correctedDemFramebufferId,ground:this.groundFramebufferId,ground2:this.groundFramebufferId}),this.updateRampTextureId(),this.enabled=!0,this.startAnimationVerticalScale()}setAnimationTerrain(e){this.modules.demManager.disableAnimation=!e}getAnimationTerrainStatus(){return this.modules.demManager.disableAnimation}onTerrainStyleChange(){this.updateRampTextureId()}disable(){var e,i,n,s,o;this.enabled&&((e=this.meshSource)==null||e.destroy(),this.meshSource=void 0,(i=this.flatMapSource)==null||i.destroy(),this.flatMapSource=void 0,this.tileLayers.forEach(r=>{this.modules.tileManager.removeTileLayer(r)}),this.tileLayers=[],this.sources.forEach(r=>{r.destroy()}),this.sources=[],this.sourcesRevision=[],this.hillshadeTile&&(this.modules.tileManager.removeObject(this.hillshadeTile),this.hillshadeTile=void 0),(n=this.hillshadeVao)==null||n.unbind(),(s=this.hillshadeVao)==null||s.remove(),(o=this.fullscreenBuffer)==null||o.remove(),this.modules.styleManager.removeLayer("demo_raster_layer"),this.modules.styleManager.setFramebufferId(this.modules.map.state.handyStyleId,is,{elevation:li,hillshade:li,flatBottom:li,ground:li,ground2:li}),this.modules.renderer.removeFramebuffer(this.hillshadeFramebufferId),this.modules.renderer.removeFramebuffer(this.demFramebufferId),this.modules.renderer.removeFramebuffer(this.correctedDemFramebufferId),this.modules.renderer.removeFramebuffer(this.flatFramebufferId),this.modules.renderer.removeFramebuffer(this.groundFramebufferId),this.enabled=!1)}update(){var s,o,r,a;if(!this.enabled)return;const e=this.modules.map.state;this.lastStyleId!==e.handyStyleId&&(this.updateRampTextureId(),(s=this.meshSource)==null||s.updateStyleId(),(o=this.hillshadeTile)==null||o.children.forEach(l=>{l.attributes.styleId=e.handyStyleId}),this.modules.styleManager.setFramebufferId(this.modules.map.state.handyStyleId,is,{elevation:this.demFramebufferId,hillshade:this.hillshadeFramebufferId,flatBottom:this.correctedDemFramebufferId,ground:this.groundFramebufferId,ground2:this.groundFramebufferId}),this.updateClearColor(),this.lastStyleId=e.handyStyleId);const i=this.updateTilesRevision(),n=this.differ.check(this.modules.map.state);(i||n)&&(this.isGroundBufferValid=!1),n&&(this.updateMinElevation(),(r=this.flatMapSource)==null||r.update(),(a=this.meshSource)==null||a.update(),this.updateDemFramebufferMatrix(),this.modules.renderer.addRerenderEvent()),this.disableAnimation||kt("changeScale",{step:(l,c)=>{c===N1&&yt("changeScale",e),this.terrainAnimationScaleCoef=c}},e)}isEnabled(){return this.enabled}getDemFramebufferId(){return this.demFramebufferId}getCorrectedDemFramebufferId(){return this.correctedDemFramebufferId}getFlatFramebufferId(){return this.flatFramebufferId}getIdentifyFlatFramebufferId(){return this.identifyFlatFramebufferId}getHillshadeFramebufferId(){return this.hillshadeFramebufferId}getHillshadeRampTextureId(){return this.hillshadeRampTextureId}getElevation(e){if(this.enabled)for(let i=this.sources.length-1;i>=0;i--){const s=this.sources[i].getElevation(e);if(s!==void 0)return s}}getLabelsDemKey(e){if(!this.enabled||e.length===0)return;let i;for(const s of e)if(i=s.labels.find(o=>o.type===Ss.Point),i)break;if(!i)return;ku(nh,i.vertices,0,Ye(i.tileCoords));let n;for(let s=this.sources.length-1;s>=0;s--){const r=this.sources[s].getElevationTile(nh);if(r!==void 0){n=r;break}}if(n)return n.key}enrichWithElevation(e){if(this.enabled)for(const i of e){let n=null;for(const s of i.labels)s.type===Ss.Point&&(n||(n=Ye(s.tileCoords)),ku(nh,s.vertices,0,n),s.demElevation=this.getElevation(nh)??NaN)}}getMinElevation(){return this.sources.reduce((e,i)=>{const n=i.getMinElevation();return n===void 0?e:e===void 0?n:Math.min(e,n)},void 0)}updateMinElevation(){this.sources.forEach(e=>e.updateMinElevation())}getMeshTiles(){return this.reliefTileType==="raster"?this.elevationSourceType==="regular"&&this.meshSource?Array.from(this.meshSource.meshTiles.values()):[]:this.tileLayers.reduce((e,i)=>{const n=i.getDisplayedTileObjects();return e.push(...n),e},[])}getGroundTiles(){return this.reliefTileType==="raster"&&this.elevationSourceType==="regular"&&this.meshSource?Array.from(this.meshSource.groundTiles.values()):[]}getReliefTileType(){return this.reliefTileType}getElevationSourceType(){return this.elevationSourceType}setReliefTileType(e){this.reliefTileType!==e&&(this.reliefTileType=e,this.dangerouslyDestroySourcesAndLayers(),this.elevationSourceType==="regular"?this.addRegularElevationSources():this.addIrregularElevationSources(),this.modules.renderer.addRerenderEvent())}setElevationSourceType(e){this.elevationSourceType!==e&&(this.elevationSourceType=e,this.dangerouslyDestroySourcesAndLayers(),this.elevationSourceType==="regular"?this.addRegularElevationSources():this.addIrregularElevationSources(),this.modules.renderer.addRerenderEvent())}getFlatMapTextures(){return this.flatMapSource?this.flatMapSource.textures.slice():[]}clearTextureBindings(){const e=this.modules.renderer.getRenderingContext();e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,null),e.activeTexture(e.TEXTURE0+em),e.bindTexture(e.TEXTURE_2D,null),e.activeTexture(e.TEXTURE0+nm),e.bindTexture(e.TEXTURE_2D,null),e.activeTexture(e.TEXTURE0+tm),e.bindTexture(e.TEXTURE_2D,null),e.activeTexture(e.TEXTURE0+im),e.bindTexture(e.TEXTURE_2D,null)}setMeshMaxZoom(e){var i;this.meshMaxZoom=e,(i=this.meshSource)==null||i.setMaxZoom(e)}getVerticalScale(){const e=this.modules.map.state,i=this.modules.styleManager.getStyle(e.handyStyleId);if(!i)return 0;const n=i.dem.style,s=ut(e.styleZoom,e.styleState,[]);return this.disableAnimation?W(n.verticalScale,s):W(n.verticalScale,s)*this.terrainAnimationScaleCoef}startAnimationVerticalScale(){const e=this.modules.map.state;if(!this.modules.styleManager.getStyle(e.handyStyleId))return 0;Bt("changeScale",{easing:"linear"},e,k1,N1,YC,1)}getTilesRevision(){return this.tilesRevision}setTileSet(e){this.tileSet=e,this.enabled&&(this.disable(),this.enable())}getGroundPoint(e){if(!this.enabled||(this.updateGround(),!this.isGroundBufferValid))return;const i=this.modules.renderer.getFramebuffer(this.groundFramebufferId);if(!i)return;const n=i.renderTarget.options.size,s=e[0]-this.modules.map.state.viewport.left,o=e[1]-this.modules.map.state.viewport.top;if(s<0||s>n[0]-1||o<0||o>n[1]-1)return;const a=((n[1]-o-1)*n[0]+s)*4;if(this.groundBuffer[a+3]===0)return;const[c,d]=Z.toGeo([this.groundBuffer[a],this.groundBuffer[a+1]]);return[c,d,this.groundBuffer[a+2]]}dangerouslyDestroySourcesAndLayers(){this.sources.forEach(e=>e.destroy()),this.sources=[],this.sourcesRevision=[],this.tileLayers.forEach(e=>{this.modules.tileManager.removeTileLayer(e),e.destroy()}),this.tileLayers=[]}updateRampTextureId(){const e=this.modules.styleManager.getStyle(this.modules.map.state.handyStyleId);if(e!=null&&e.dem){const i=KC(this.modules.map.state,e.dem.style.shadingPalette,256);Number.isNaN(this.hillshadeRampTextureId)?this.hillshadeRampTextureId=this.modules.imageManager.addPreparedTexture(i):this.modules.imageManager.updatePreparedTexture(this.hillshadeRampTextureId,i)}}updateClearColor(){const e=this.modules.styleManager.getStyle(this.modules.map.state.handyStyleId);if(e!=null&&e.dem){const i=this.modules.renderer.getFramebuffer(this.flatFramebufferId);i&&(i.clearColor=Tt(e.background.color))}}updateGround(){if(this.enabled&&!this.isGroundBufferValid){const e=this.modules.renderer.getFramebuffer(this.groundFramebufferId);if(!e)return;const i=this.modules.renderer.getRenderingContext(),n=e.renderTarget.options.size;this.validateGroundBufferSize(n),e.renderTarget.bind(i),i.readPixels(0,0,n[0],n[1],i.RGBA,i.FLOAT,this.groundBuffer),e.renderTarget.unbind(i),this.isGroundBufferValid=!0}}addDefaultSources(){var e;if(!this.enabled){this.elevationSourceType==="irregular"?this.addIrregularElevationSources():this.addRegularElevationSources(),this.flatMapSource=new gC(this.modules.map),this.meshSource=new oC(this.modules.map,{maxZoom:this.meshMaxZoom});const i=this.hillshadeVao,n=(e=this.modules.renderer.symbolSettingsList.dem.hillshade)==null?void 0:e[0];if(i&&n){this.hillshadeTile=new Ct("raster",[],this.modules,this.modules.map.state);const s={id:Vn(),type:Xi.Tile,symbol:"dem",sink:"hillshade",tile:this.hillshadeTile,attributes:{layerId:is,styleId:this.modules.map.state.handyStyleId,tileData:[]},start:0,count:6,attributesHash:"",layerSettings:n,vao:i,canRender:!0,renderingProperties:{}};this.hillshadeTile.children.push(s),this.modules.tileManager.addObject(this.hillshadeTile)}}}addRegularElevationSources(){const e=this.modules.map.state,i=(s,o,r)=>U1(e,s,o,r,this.tileSet),n=this.reliefTileType==="raster";n&&this.addElevationSource({url:i,minZoom:B1,maxZoom:8,attributes:{}}),this.addElevationSource({url:i,minZoom:n?9:B1,maxZoom:sm,attributes:{}})}addIrregularElevationSources(){const e=(i,n,s)=>U1({tileServer:"tileserver.web-staging.2gis.ru",tileProtocol:"https",subdomains:["0","1","2"]},i,n,s,"relief_test");this.addIrregularElevationSource({url:e,minZoom:jC,maxZoom:om,attributes:{}})}updateTilesRevision(){let e=!1;return this.sources.forEach((i,n)=>{const s=i.getRevision();s!==this.sourcesRevision[n]&&(this.sourcesRevision[n]=s,e=!0)}),e&&this.tilesRevision++,e}addElevationSource(e){const i=new rC(vr(),this.modules,e);this.sources.push(i),this.sourcesRevision.push(i.getRevision());const{minZoom:n,maxZoom:s}=e,o=new os(n,s,n,s,this.modules,this.modules.map.state,i);this.modules.tileManager.addTileLayer(o),this.tileLayers.push(o)}addIrregularElevationSource(e){const i=new pC(vr(),this.modules,e);this.sources.push(i),this.sourcesRevision.push(i.getRevision());const{minZoom:n,maxZoom:s}=e,o=new os(n,s,n,s,this.modules,this.modules.map.state,i);this.modules.tileManager.addTileLayer(o),this.tileLayers.push(o)}getDemTextureSize(){const e=this.modules.map.state.cameraConfig,i=this.modules.map.state.size[1]*e.viewportLimitRatio;return Math.min(Math.ceil(Math.hypot(i,i)/256),so)}createGroundFramebuffer(){const e=this.modules.renderer.getRenderingContext(),i=this.modules.map.state.size,n=[0,0,0,0],s=new Nt({size:i,magFilter:j.NearestFilter,minFilter:j.NearestFilter,wrapS:j.ClampToEdgeWrapping,wrapT:j.ClampToEdgeWrapping,flipY:!0,type:j.Float});return s.bind(e),this.modules.renderer.clearWithColor(n,!0),s.unbind(e),this.modules.renderer.addFramebuffer({clearColor:n,useDem:!0,clearDepth:!0,onResize:()=>{const o=this.modules.renderer.getRenderingContext(),r=this.modules.map.state.size;s.setSize(r),s.bind(o),this.modules.renderer.clearWithColor(n,!0),s.unbind(o)},renderTarget:s,renderIndex:5,onRenderStart:()=>{this.clearTextureBindings()},onRenderEnd:()=>{}})}createDemFramebuffer(){const e=this.modules.renderer.getRenderingContext();let i=this.getDemTextureSize()*so;const n=new Nt({size:[i,i],magFilter:j.LinearFilter,minFilter:j.LinearFilter,wrapS:j.ClampToEdgeWrapping,wrapT:j.ClampToEdgeWrapping,flipY:!0,type:j.Float,format:Do.webglVersion===2?j.RedFormat:j.RgbaFormat});return n.bind(e),this.modules.renderer.clearWithColor([0,0,0,1]),n.unbind(e),this.modules.renderer.addFramebuffer({clearColor:[0,0,0,0],onResize:()=>{const s=this.getDemTextureSize()*so;s!==i&&(i=s,n.setSize([i,i]),n.bind(e),this.modules.renderer.clearWithColor([0,0,0,1]),n.unbind(e))},renderTarget:n,getViewProjectionMatrix:()=>this.demFbVpMatrix,renderIndex:0,onRenderStart:()=>{this.clearTextureBindings()},onRenderEnd:()=>{this.isDemCorrectionEnabled=!1}})}createCorrectedDemFramebuffer(){const e=this.modules.renderer,i=e.getRenderingContext(),n=e.webGlExtensions;let s=this.getDemTextureSize()*so;const o=new Nt({size:[s,s],magFilter:j.LinearFilter,minFilter:j.LinearFilter,wrapS:j.ClampToEdgeWrapping,wrapT:j.ClampToEdgeWrapping,flipY:!0,type:j.Float});o.bind(i),this.modules.renderer.clearWithColor([0,0,0,1]),o.unbind(i);const r=this.modules.renderer.lastAppliedGlState;return this.modules.renderer.addFramebuffer({onResize:()=>{const a=this.getDemTextureSize()*so;a!==s&&(s=a,o.setSize([s,s]),o.bind(i),this.modules.renderer.clearWithColor([0,0,0,1]),o.unbind(i))},renderTarget:o,getViewProjectionMatrix:()=>this.demCorrectedFbVpMatrix,renderIndex:1,onRenderStart:()=>{var d;const a=(d=this.modules.renderer.getFramebuffer(this.demFramebufferId))==null?void 0:d.renderTarget.getTexture();if(!a||!this.copyDemVao)return;this.clearTextureBindings(),o.bind(i),i.viewport(0,0,o.options.size[0],o.options.size[1]),vn(i,P1,r);const l=0;a.enable(i,l);const c=this.modules.renderer.getShaderProgram("demElevationCopy");c.enable(i),c.bind(i,{u_mat4_mvp:Xa,u_sr2d_texture:l,u_mat4_dem_corrected:this.correctedTexToDemTex}),this.copyDemVao.bind({gl:i,extensions:n}),i.drawArrays(i.TRIANGLES,0,6),o.unbind(i),this.isDemCorrectionEnabled=!0},useDem:!0})}createHillshadeFramebuffer(){const e=this.modules.renderer.getRenderingContext();let i=this.getDemTextureSize()*so;const n=new Nt({size:[i,i],magFilter:j.LinearFilter,minFilter:j.LinearFilter,wrapS:j.ClampToEdgeWrapping,wrapT:j.ClampToEdgeWrapping,format:j.RgbFormat,flipY:!0});return this.modules.renderer.addFramebuffer({clearColor:[0,0,0,0],onResize:()=>{const s=this.getDemTextureSize()*so;s!==i&&(i=s,n.setSize([i,i]),n.bind(e),n.unbind(e))},renderTarget:n,getViewProjectionMatrix:()=>this.demFbVpMatrix,renderIndex:2,onRenderStart:()=>{this.clearTextureBindings()},useDem:!0})}createFlatFramebuffer(){const e=this.modules.renderer.getRenderingContext(),i=this.modules.renderer.getPixelRatio(),n=this.modules.map.state.size,s=new Nt({size:[Math.trunc(n[0]*nn[0]*i),Math.trunc(n[1]*nn[1]*i)],magFilter:j.LinearFilter,minFilter:j.LinearFilter,wrapS:j.ClampToEdgeWrapping,wrapT:j.ClampToEdgeWrapping});return this.modules.renderer.addFramebuffer({clearColor:this.modules.renderer.clearColor,onResize:()=>{const o=this.modules.map.state.size;s.setSize([Math.trunc(o[0]*nn[0]*i),Math.trunc(o[1]*nn[1]*i)]),s.bind(e),s.unbind(e)},renderTarget:s,renderIndex:3,onRenderStart:()=>{e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,null)}})}createFlatIdentifyFramebuffer(){const e=this.modules.renderer.getRenderingContext(),i=this.modules.map.state.size,n=new Nt({size:[Math.trunc(i[0]*nn[0]*rn.pixelDensity),Math.trunc(i[1]*nn[1]*rn.pixelDensity)],magFilter:j.NearestFilter,minFilter:j.NearestFilter,wrapS:j.ClampToEdgeWrapping,wrapT:j.ClampToEdgeWrapping});return this.modules.renderer.addFramebuffer({clearColor:Os,onResize:()=>{const s=this.modules.map.state.size;n.setSize([Math.trunc(s[0]*nn[0]*rn.pixelDensity),Math.trunc(s[1]*nn[1]*rn.pixelDensity)]),n.bind(e),n.unbind(e)},renderTarget:n,renderIndex:4,onRenderStart:()=>{e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,null)}})}updateDemFramebufferMatrix(){const e=this.modules.map.state,i=Math.trunc(e.styleZoom),n=Math.min(i,this.getReliefTileType()==="raster"?HC:VC),s=Mt(n),o=s*this.getDemTextureSize(),r=s/so,a=[Math.trunc(e.center[0]/r)*r+r/2,Math.trunc(e.center[1]/r)*r+r/2],l=[a[0]-o/2,a[1]-o/2,0],c=[];Ai(c,this.modules.camera.position,e.center);const d=Qp(c);fs(c,c);const h=(o/2-d-r)*Math.sin(e.pitch/e.maxPitch*(Math.PI/2));h>0&&(Ei(c,c,h),c[0]=Math.trunc(c[0]/r)*r,c[1]=Math.trunc(c[1]/r)*r,Ai(l,l,c)),En(Si,l,[o,o,No]),Ns(this.demTextureMatrix,Si),ri(this.demFbVpMatrix,Xa,this.demTextureMatrix);const u=Math.min(i,ZC);this.demCorrectedScale=2**(u-n);const m=Mt(u)*this.getDemTextureSize(),p=[a[0]-m/2,a[1]-m/2,0];En(Si,p,[m,m,No]),Ns(Si,Si),ri(this.demCorrectedFbVpMatrix,Xa,Si),cc(Si,[1/this.demCorrectedScale,1/this.demCorrectedScale,1]),ri(this.demCorrectedFbVpToDemTex,fc,Si),cc(Si,[1/this.demCorrectedScale,1/this.demCorrectedScale,1]),ri(Si,Si,Xa),ri(this.correctedTexToDemTex,fc,Si),cc(Si,[this.demCorrectedScale,this.demCorrectedScale,1]),ri(Si,Si,Xa),ri(this.demTexToCorrectedTex,fc,Si)}validateGroundBufferSize(e){const i=e[0]*e[1]*4;this.groundBuffer.length!==i&&(this.groundBuffer=new Float32Array(i))}}function KC(t,e,i){const n=ut(t.styleZoom,t.styleState,[]),s=[],o=i-1;for(let r=0;r<i;r++){const a=r/o,l=lv(e,a,n)*256;s.push(l)}return new j(new Uint8Array(s),{size:[i,1],format:j.AlphaFormat,magFilter:j.LinearFilter,minFilter:j.LinearFilter,wrapS:j.ClampToEdgeWrapping,wrapT:j.ClampToEdgeWrapping})}const G1=new Float32Array(16),Ea=(t,e,i,n)=>{i=cm(i,t,e),i.length>0&&t.metrics.firstcontent===void 0&&(t.metrics.firstcontent=performance.now()-t.metrics.start),H1(i,n),t.globeMode&&t.globeReady?JC(t,e,i,n):rm(t,e,i,n)},JC=(t,e,i,n)=>{const s=[],{environmentManager:o}=e,r=e.styleManager.getStyle(t.handyStyleId);if(!r||!r.environment)return;const l=ut(t.styleZoom,t.styleState,[]),c=Tt(ze(r.background.color,l)),d=e.renderer.getRenderingContext();o.renderStars(d),o.renderGlobeHaloBackground(d),oR(i).forEach(h=>{if(!h.globeTile){lm(h.children,t).forEach(u=>s.push(u));return}n.useGlobeTile(h.globeTile),e.renderer.clearWithColor(c),h.children.forEach(u=>{if(u.type===Xi.Custom||!h.globeTile)return;const f=h.globeTile.coords,m=u.tile.coords,_=2**(m[2]-f[2]),g=(m[0]-f[0]*_)/_,y=(m[1]-f[1]*_)/_,b=1/_,v=1-b-2;En(G1,[2*g+v,2*y+v,0],[4*b,4*b,1]),u.tile.setMvpMatrix(G1)}),lm(h.children,t).forEach(u=>sh(t,e,u,n)),n.useCanvas(),sh(t,e,h.globeTile.children,n)}),o.renderGlobeHalo(d),s.forEach(h=>{sh(t,e,h,n)})},rm=(t,e,i,n)=>{lm(i,t).forEach(s=>sh(t,e,s,n))},sh=(t,e,i,n)=>{cR(e.styleManager,i,t).forEach(s=>{V1(e.styleManager,s[0])?QC(t,e,s,n):j1(t,e,s,n)})},QC=(t,e,i,n)=>{const s=V1(e.styleManager,i[0]);if(!s)return;const o=(r,a)=>{a>=s.orderBy.length?j1(t,e,r,n):hR(s.orderBy[a],r,t).forEach(l=>o(l,a+1))};o(i,0)},j1=(t,e,i,n)=>{i.sort((s,o)=>s.tile.zoomLevel-o.tile.zoomLevel),lR(e.styleManager,i,t).forEach(s=>eR(t,e,s,n))},eR=(t,e,i,n)=>{dR(i,t).forEach(s=>tR(t,e,s,n))},tR=(t,e,i,n)=>{var a;const s=i[0],o=pR(e.styleManager,s);if(!o||((a=o==null?void 0:o.style)==null?void 0:a.visibility)==="hidden")return;const r=o.selectedIdx;r!==void 0&&i.sort((l,c)=>{const d=Number(l.attributes.tileData[r]??0),h=Number(c.attributes.tileData[r]??0);return d-h}),s.type===Xi.Custom?(n.useCustomLayerState(o),e.styleManager.callCustomLayerRender(s.attributes.layerId)):uR(i,t).forEach(l=>iR(t,e,l,n,o))},iR=(t,e,i,n,s)=>{n.useProgram(i[0],s),fR(i,t).forEach(o=>{nR(t,e,o,n,s)})},nR=(t,e,i,n,s)=>{n.useState(i[0],s),_R(i,t).forEach(o=>{n.drawSymbol(o,s,t,e)})};function V1(t,e){const i=t.getStyle(e.attributes.styleId);if(!i)return;const n=i.layersById[e.attributes.layerId];if(!n||n.groupId===void 0)return;const s=i.groupsById[n.groupId];if(s&&s.type!=="group"){Ze(`Expecting layer with type 'group' but got '${s.type}'`);return}return s}const sR=(t,e)=>Number(t)-Number(e),Aa=t=>(e,i)=>{const n={};for(let r=0;r<e.length;r++){const a=e[r],l=t(a,i),c=n[l];c===void 0?n[l]=[a]:c.push(a)}const s=Object.keys(n);s.sort(sR);const o=[];for(let r=0;r<s.length;r++)o.push(n[s[r]]);return o},am=t=>(e,i)=>{const n=new Map;for(let s=0;s<e.length;s++){const o=e[s],r=t(o,i);n.has(r)?n.get(r).push(o):n.set(r,[o])}return n},oR=t=>{const e=[],i={globeTile:null,children:[]},n=[];for(const s of t)s.type!==Xi.Custom&&(s.tile.purpose==="globe"?n.push({globeTile:s.tile,children:[]}):e.push(s));for(const s of e)if(s.layerSettings.is3dMapAware)i.children.push(s);else for(const o of n)o.globeTile&&RS(o.globeTile.coords,s.tile.coords)&&o.children.push(s);return n.push(i),n},lm=Aa(t=>{const{styleId:e}=t.attributes;return e===Lo?1:-e}),rR=(t,e,i)=>{const n=t.getStyle(e);if(!n)return Ze(`Cannot get style with id=${e} for renderIndex`),NaN;const s=n.layersById[i];return s?s.renderIndex:NaN},aR=(t,e,i)=>{const n=t.getStyle(e);if(!n)return Ze(`Cannot get style with id=${e} for renderIndex`),NaN;const s=n.layersById[i];return s?s.groupIndex||0:NaN},lR=(t,e,i)=>Aa(n=>aR(t,n.attributes.styleId,n.attributes.layerId))(e,i),cR=(t,e,i)=>Aa(n=>rR(t,n.attributes.styleId,n.attributes.layerId))(e,i),dR=Aa(t=>t.type===Xi.Custom?0:t.layerSettings.subRenderIndex||0),H1=(t,e)=>{const i=new Set;t.forEach(n=>{if(n.type===Xi.Custom)return;const s=n.layerSettings.programName;i.has(n.layerSettings.programName)||(i.add(s),e.setProgramBinder(n))})},hR=(t,e,i)=>Aa((n,s)=>{const o=ut(s.styleZoom,s.styleState,n.attributes.tileData);return W(t,o,0)})(e,i),uR=am(t=>{var e;return(e=t.shaderDefinitions)!=null&&e.hash?t.layerSettings.programName+"_"+t.shaderDefinitions.hash:t.layerSettings.programName}),fR=am(t=>t.layerSettings.webglState),_R=am(t=>t.sink+"_"+t.attributesHash+"_"+t.tile.readiness),mR=Aa(t=>t.tile.zoomLevel);function pR(t,e){const i=t.getStyle(e.attributes.styleId);if(i)return i.layersById[e.attributes.layerId]}function cm(t,e,i){for(const n of t)n.type!==Xi.Custom&&(n.canRender=gR(n,i,e));return t.filter(n=>n.canRender)}function gR(t,e,i){var s;if(!t.layerSettings.cullMethod)return!0;const n=e.styleManager.getStyleLayerForObject(t);return!(!n||((s=n==null?void 0:n.style)==null?void 0:s.visibility)==="hidden"||!t.layerSettings.cullMethod(t,e,i,n))}const Ro=(t,e,i,n,s,o)=>{const r=e.renderer.getRenderingContext(),a=e.renderer.lastAppliedGlState,l={terrain3d:!!s,noEffects:!!o,drawSymbol:(c,d,h,u)=>{const f=c[0];if(f)if(wR(f)&&(d.type==="overpass"||d.type==="tunnel"||d.type==="gltfModel")&&!f.layerSettings.shadow){let m;d.type==="gltfModel"&&(m=[0,0,0,0]),l.renderTierTexture(f,d,!1,m),l.useProgram(f,d),l.useState(f),dm(c,d,h,u,l),h.hiddenImmersiveRoutesEnabled&&!f.layerSettings.identify&&d.type!=="gltfModel"&&(l.renderTierTexture(f,d,!0),l.useProgram(f,d),vn(r,vC,a,d),dm(c,d,h,u,l))}else dm(c,d,h,u,l)},useProgram:(c,d)=>{const{layerBinder:h,programName:u,programBinder:f,commonBinder:m}=c.layerSettings,p=e.renderer.getShaderProgram(u,c.shaderDefinitions);p.enable(r),m&&r instanceof WebGLRenderingContext&&m(r,p,t,e),f==null||f(r,p,t,e,s,o),h==null||h(r,p,t,e,d,o)},setProgramBinder:c=>{const d=c.layerSettings.programBinder,h=r instanceof WebGLRenderingContext?c.layerSettings.commonBinder:void 0;if(c.layerSettings.programBinder||h){const u=e.renderer.getShaderProgram(c.layerSettings.programName,c.shaderDefinitions);u.enable(r),h==null||h(r,u,t,e),d==null||d(r,u,t,e,s,o)}},useState:(c,d)=>{vn(r,c.layerSettings.webglState,a,d)},useCustomLayerState:c=>{vn(r,SC,a,c)},useGlobeTile:c=>{const d=e.renderer.getGlobeRenderTarget(rg(t.zoom,c));d&&e.renderer.setRenderTarget(d)},useCanvas:()=>{e.renderer.setRenderTarget(n)},renderTierTexture:(c,d,h,u)=>{const{viewport:f,size:m}=t,p=window.devicePixelRatio,_=!!c.layerSettings.identify,g=_?e.renderer.getMapMeshIdFramebufferId():e.renderer.getMapMeshFramebufferId(),y=e.renderer.getFramebuffer(g);if(!y)return;const b=Ro(t,e,void 0,n,!1,!0);if(r.activeTexture(r.TEXTURE0),r.bindTexture(r.TEXTURE_2D,null),y.renderTarget.bind(r),r.viewport(0,0,y.renderTarget.options.size[0],y.renderTarget.options.size[1]),h)r.clearDepth(-1),_?r.clearColor(Os[0],Os[1],Os[2],Os[3]):r.clearColor(0,0,0,0),r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT);else if(_)e.renderer.clearWithColor(Os,!0);else{const S=ut(t.styleZoom,t.styleState,c.attributes.tileData),P=u??ze(d.style.color,S).value;e.renderer.clearWithColor([P[0]/255,P[1]/255,P[2]/255,P[3]/255],!0)}const v=c.attributes.meshTier,I=i==null?void 0:i[v];if(I){I.tileObjects.forEach(T=>{var L;T.updateMvpMatrix(((L=y.getViewProjectionMatrix)==null?void 0:L.call(y))??e.camera.viewProjectionMatrix,void 0)});const S=h?I.objects.filter(T=>{var L;if(T.type!==Xi.Custom){if(T.layerSettings.webglState.depthTest&&!T.layerSettings.isOverlappedObject)return!0;const B=e.styleManager.getStyleLayer(T.attributes.styleId,T.attributes.layerId);if(B)return((L=B.webglState)==null?void 0:L.depthTest)===!0}return!1}):I.objects,P=cm(S,t,e);rm(t,e,P,b),I.tileObjects.forEach(T=>T.updateMvpMatrix(e.camera.viewProjectionMatrix)),H1(I.objects,l)}n?(n.bind(r),r.viewport(0,0,n.options.size[0],n.options.size[1])):(y.renderTarget.unbind(r),r.viewport(f.left*p,f.bottom*p,m[0]*p,m[1]*p))},copy:(c,d,h)=>Ro(t,e,i,c,d,h)};return l},dm=(t,e,i,n,s)=>{const o=n.renderer.getRenderingContext(),r=t[0],a=r.layerSettings,l=n.renderer.getShaderProgram(a.programName,r.shaderDefinitions);a.objectBinder(o,l,i,n,r,e,s.terrain3d),r.layerSettings.zoomBinder?mR(t,i).forEach(c=>{var d,h;l&&((h=(d=r.layerSettings).zoomBinder)==null||h.call(d,o,l,i,n,c[0],e,s.terrain3d)),c.forEach(u=>Z1(u,n,l,i,s,o,e))}):t.forEach(c=>Z1(c,n,l,i,s,o,e))},Z1=(t,e,i,n,s,o,r)=>{const a=e.renderer.webGlExtensions,l=a.ANGLE_instanced_arrays,c=t.tile;for(const d of c.modelMatrices.keys()){if(c.renderModelMatrix=c.modelMatrices.get(d),c.renderMvpMatrix=c.mvpMatrices.get(d),c.renderDemMatrix=c.demMatrices.get(d),c.renderFlatMapTexMatrix=c.flatMapTexMatrices.get(d),!t.layerSettings.tileBinder(o,i,n,e,t,r,s))continue;t.vao.bind({gl:o,extensions:a});const{start:u,count:f,instanceCount:m}=t,p=t.drawMode??Ua,_=t.vao.getElementsGLType(o);if(_!==null?m?vR(o,p,f,_,u,m,l):o.drawElements(p,f,_,u):m?yR(o,p,u,f,m,l):o.drawArrays(p,u,f),n.collectStats){n.stats.drawCount++,n.stats.vertexCount+=(m??1)*f,n.stats.drawCountBySymbol[t.symbol]?n.stats.drawCountBySymbol[t.symbol]++:n.stats.drawCountBySymbol[t.symbol]=1;let g=0;switch(p){case o.TRIANGLES:g=f/3;break;case o.TRIANGLE_FAN:case o.TRIANGLE_STRIP:g=f-2;break}n.stats.triangleCount+=(m??1)*g}}};function vR(t,e,i,n,s,o,r){if(t instanceof WebGLRenderingContext){if(!r)return;r.drawElementsInstancedANGLE(e,i,n,s,o)}else t.drawElementsInstanced(e,i,n,s,o)}function yR(t,e,i,n,s,o){if(t instanceof WebGLRenderingContext){if(!o)return;o.drawArraysInstancedANGLE(e,i,n,s)}else t.drawArraysInstanced(e,i,n,s)}function wR(t){return t.symbol==="mapMesh"||t.symbol==="gltfModel"&&t.attributes.meshTier!==void 0}const $1=Oe(),bR=Oe(),W1=Gi(),hm=Oe(),xR=at(0,0,1),SR=Oe(),MR=.3,IR=1/2e7,TR=.01,X1=Hn();class ER{constructor(e,i){this.clipToShadowMatrix=new Float32Array(16),this.baseBias=Va.bias,this.bias=0,this.shadowMapParams=new Float32Array([Va.textureSize[0],Va.textureSize[1],Va.shadowRadius,1]),this.volumeMultiplier=2.5,this.volumeMinSize=25e3,this.discreteVolume=!1,this.volumeSizeStep=2**15,this.adaptiveVerticalSize=!0,this.debugDraw=!1,this.shadowMatrix=new Float64Array(16),this.orthoMath=new Float64Array(16),this.renderTarget=null,this.debugSize=400,this.shadowLightDir=null,this.modules=i,this.mapState=e;const n=new R(new Uint8Array([-1,-1,1,-1,1,1,-1,1]));this.copyProgram=this.createDebugProgram(),this.debugVao=y1(n,this.copyProgram)}get texture(){if(!this.renderTarget)return null;const e=this.renderTarget.getDepthAttachment();return e instanceof j?e:this.renderTarget.getTexture()}setShadowResolution(e,i){this.shadowMapParams[0]=e,this.shadowMapParams[1]=i,this.renderTarget&&this.renderTarget.setSize([e,i])}update(){this.shadowLightDir=null;const{handyStyleId:e}=this.mapState,i=this.modules.styleManager.getStyle(e),n=this.modules.map.state.demMode;if(!i||!i.light.lightingModesResolved||n){this.renderTarget&&this.renderTarget.remove();return}const s=i.light.lightingModesResolved;for(const L in s){const B=s[L];if(B.shadowLightIndex===0){this.shadowLightDir=B.dir1Direction,this.shadowMapParams[2]=B.shadowRadius;break}else if(B.shadowLightIndex===1){this.shadowLightDir=B.dir2Direction,this.shadowMapParams[2]=B.shadowRadius;break}}const o=this.shadowLightDir&&!this.modules.map.getFeatureFlag("shadowsOff");if(o?this.renderTarget||(this.renderTarget=this.createRenderTarget()):this.renderTarget&&this.renderTarget.remove(),!o||!this.shadowLightDir||!this.renderTarget||this.modules.renderCacheManager.hasReadyCache())return;const r=this.modules.map.state.center,a=this.modules.camera.position[2];let l=Math.max(this.volumeMultiplier*a);this.discreteVolume&&(l=l-l%this.volumeSizeStep),l=Math.max(l,this.volumeMinSize);const c=this.modules.renderer.getRenderingContext();let d=this.baseBias;!(c instanceof WebGLRenderingContext)&&Qd(c)&&(d*=.5),this.shadowMapParams[3]=d/l,this.bias=d*IR*Math.sqrt(l),this.bias=Math.min(this.bias,TR);let h=1;if(this.adaptiveVerticalSize){const L=Math.abs(nu(this.shadowLightDir,xR));h=Math.max(L,MR)}const u=l,f=h*l,m=3*l;Yp(this.orthoMath,-u,u,-f,f,-m,m);const p=at(this.shadowLightDir[1],-this.shadowLightDir[0],0);Ui(p,p),kr(hm,p,this.shadowLightDir);const _=W1;Za(_,SR,this.shadowLightDir,hm);const g=Tn($1,r,_),y=2*u/this.shadowMapParams[0],b=2*f/this.shadowMapParams[1],v=at(g[0]-g[0]%y,g[1]-g[1]%b,g[2]),I=Ns(_,_),S=Tn(bR,v,I??ou(W1)),P=Ot($1,S,this.shadowLightDir);Za(this.shadowMatrix,S,P,hm),ri(this.shadowMatrix,this.orthoMath,this.shadowMatrix);const T=this.modules.camera.viewProjectionMatrixInverse;ri(this.clipToShadowMatrix,this.shadowMatrix,T)}drawShadowMap(e){if(!this.shadowLightDir||!this.renderTarget||this.modules.renderCacheManager.hasReadyCache())return;const i=this.modules.map.state.demMode,n=Ro(this.mapState,this.modules,void 0,this.renderTarget,i),s=new Set,o=[];for(const l of e)for(const c of l.shadowChildren){const d=this.modules.styleManager.getStyleLayerForObject(c);if(!d||d.castShadows===!1)continue;const h=r1(d,this.modules,this.mapState);!h||h.lightConfig.shadowLightIndex===-1||(o.push(c),s.add(l))}const r=this.modules.renderer.getRenderingContext(),a=i?this.modules.demManager.demTextureMatrix:void 0;s.forEach(l=>{l.updateMvpMatrix(this.shadowMatrix,a)}),this.renderTarget.bind(r),vn(r,D1,this.modules.renderer.lastAppliedGlState),r.clearColor(1,1,1,1),r.clearDepth(1),r.clear(r.COLOR_BUFFER_BIT|r.DEPTH_BUFFER_BIT),r.viewport(0,0,this.renderTarget.options.size[0],this.renderTarget.options.size[1]),Ea(this.mapState,this.modules,o,n),this.renderTarget.unbind(r)}drawDebugFbIfNeeded(){if(!this.debugDraw)return;const e=this.texture;if(!e)return;const i=this.mapState.viewport,n=this.modules.renderer.getViewportSize(),s=this.debugSize,o=this.modules.renderer.getRenderingContext();o.bindFramebuffer(o.FRAMEBUFFER,null),o.viewport(n[0]+i.left-s,i.bottom,s,s);const r=this.modules.renderer.webGlExtensions;vn(o,no,this.modules.renderer.lastAppliedGlState),this.copyProgram.enable(o),this.copyProgram.bind(o,{u_texture:1}),e.enable(o,1),this.debugVao.bind({gl:o,extensions:r}),o.drawArrays(o.TRIANGLE_FAN,0,4)}getMemoryFootprint(){var i;const e={renderTarget:((i=this.renderTarget)==null?void 0:i.memSizeGPU())??0};return{gpu:{...e,"--sum":ui(e)}}}createRenderTarget(){const e=[this.shadowMapParams[0],this.shadowMapParams[1]],i=this.modules.renderer.getRenderingContext();return Qd(i)?new Nt({size:e,magFilter:j.LinearFilter,minFilter:j.LinearFilter,depthTexture:!0,hasColorOutput:!1,compareFunc:j.CompareRefToTexture}):new Nt({size:e,magFilter:j.NearestFilter,minFilter:j.NearestFilter,wrapS:j.ClampToEdgeWrapping,wrapT:j.ClampToEdgeWrapping,flipY:!1,type:j.UnsignedByte,useHighDepthPrecision:!0})}createDebugProgram(){const e=this.modules.renderer.getRenderingContext(),i=[];Qd(e)&&i.push({type:"IS_DEPTH_TEXTURE"});const n=Ps.createShaderDefinitions(i);return this.modules.renderer.getShaderProgram("copy",n)}}class AR{constructor(e,i,n){this.output=e,this.input=i,this.modules=n,this.enabled=!0}}var Y1=(t=>(t.TAA="TAA",t.NO_AA="NO_AA",t))(Y1||{});class PR extends AR{constructor(e,i,n,s){super(e,i,n),this.name=um.TAA,this.jitter=[0,0],this.numMixedFrames=0,this.samples=16;const o=n.renderer.getShaderProgram("antialias");this.jitterSequence=this.generateJitterSequence(this.samples),this.vao=y1(s,o)}onBeforeRender(e){if(this.jitter[0]=0,this.jitter[1]=0,e.disableAntiAliasing||e.globeMode||!this.canRender()){this.enabled=!1,this.numMixedFrames=0;return}if(this.numMixedFrames>=this.samples)return;this.modules.renderer.addRerenderEvent(),this.enabled=!0;const i=window.devicePixelRatio,n=e.size,s=this.jitterSequence[this.numMixedFrames];this.jitter[0]=s[0]/Math.ceil(n[0]*i),this.jitter[1]=s[1]/Math.ceil(n[1]*i)}render(e){var r;this.output.bind(e);const i=this.modules.renderer.webGlExtensions,n=1/(this.numMixedFrames+1);this.vao.bind({gl:e,extensions:i});const s=(r=this.input)==null?void 0:r.getTexture();s==null||s.enable(e,0);const o=this.modules.renderer.getShaderProgram("antialias");o.enable(e),o.bind(e,{u_texture:0,u_float_mix_coef:n}),e.drawArrays(e.TRIANGLE_FAN,0,4),this.numMixedFrames++}onAfterRender(){}resize(e){this.output.setSize(e),this.numMixedFrames=0}isReady(){return this.numMixedFrames>=this.samples}canRender(){return!this.modules.renderer.isNeedRerender()}generateJitterSequence(e){const i=[],n=wM(e),s=n.base2,o=n.base3;i.push([0,0]);for(let r=0;r<s.length;++r)i.push([2*s[r]-1,2*o[r]-1]);return i}}var um=(t=>(t[t.TAA=0]="TAA",t))(um||{});class LR{constructor(e,i){this.renderGraph=[],this.effectsByType={},this.state=e,this.modules=i,this.renderTargetSize=this.modules.renderer.getViewportSize();const n=i.renderer.webglContextState.MAX_TEXTURE_SIZE;if(Math.max(...this.renderTargetSize)>n){Ze(`Disabling post-effects as viewport size ${this.renderTargetSize[0]}x${this.renderTargetSize[1]} exceeds hardware limits of ${n}x${n}`);return}const o=new R(new Uint8Array([-1,-1,1,-1,1,1,-1,1])),r=this.createRenderTarget(this.renderTargetSize,{useHighDepthPrecision:!0});if(this.mainFrameBufferWrapper={renderTarget:r,onResize:()=>{},clearColor:Tt(e.defaultBackgroundColor),clearDepth:!0},!e.disableAntiAliasing){const a=new PR(this.createRenderTarget(this.renderTargetSize),r,i,o);this.effectsByType[0]=a,this.renderGraph.push(a)}}update(){this.renderGraph.forEach(e=>e.onBeforeRender(this.state))}render(e){const i=this.modules.renderer.lastAppliedGlState;vn(e,MC,i),this.renderGraph.forEach(s=>s.render(e));const n=this.renderGraph[this.renderGraph.length-1].output;this.copyRenderTargetToCanvas(e,n),this.renderGraph.forEach(s=>s.onAfterRender(this.state))}invalidateSize(){this.mainFrameBufferWrapper&&(this.renderTargetSize=this.modules.renderer.getViewportSize(),this.mainFrameBufferWrapper.renderTarget.setSize(this.renderTargetSize),this.renderGraph.forEach(e=>e.resize(this.renderTargetSize)))}getEffectByName(e){return this.effectsByType[e]}setClearColor(e){this.mainFrameBufferWrapper&&(this.mainFrameBufferWrapper.clearColor=Tt(e))}hasActiveEffects(){if(!this.modules.postEffectsManager.mainFrameBufferWrapper)return!1;for(const e of this.renderGraph)if(e.enabled)return!0;return!1}isReady(){for(const e of this.renderGraph)if(!e.isReady())return!1;return!0}getMemoryFootprint(){var i;const e={mainFrameBufferWrapper:{renderTarget:((i=this.mainFrameBufferWrapper)==null?void 0:i.renderTarget.memSizeGPU())??0}};return{gpu:{...e,"--sum":ui(e)}}}copyRenderTargetToCanvas(e,i){const{viewport:n}=this.state,s=window.devicePixelRatio,o=this.modules.renderer.clearColor;e.bindFramebuffer(e.FRAMEBUFFER,null),e.viewport(n.left*s,n.bottom*s,this.renderTargetSize[0],this.renderTargetSize[1]),e.clearColor(o[0],o[1],o[2],o[3]),e.clear(e.COLOR_BUFFER_BIT);const r=i.getTexture();r==null||r.enable(e,0);const a=this.modules.renderer.getShaderProgram("copy");a.enable(e),a.bind(e,{u_texture:0}),e.drawArrays(e.TRIANGLE_FAN,0,4)}createRenderTarget(e,i){return new Nt(Object.assign({minFilter:j.NearestFilter,magFilter:j.NearestFilter,size:e},i))}}const CR=[0,0];function dt(...t){return(e,i,n,s,o,r)=>{t.forEach(a=>a(e,i,n,s,o,r))}}const Ke=(t,e,i,n,s)=>{var p,_;if(!s){K1(t,e);return}const o=(p=n.renderer.getFramebuffer(n.demManager.getDemFramebufferId()))==null?void 0:p.renderTarget.getTexture(),r=(_=n.renderer.getFramebuffer(n.demManager.getCorrectedDemFramebufferId()))==null?void 0:_.renderTarget.getTexture(),a=n.imageManager.getTexture(n.demManager.getHillshadeRampTextureId()),l=o==null?void 0:o.options.size,c=n.styleManager.getStyle(i.handyStyleId);if(!o||!r||!a||!c||!l){K1(t,e);return}const d=ut(i.styleZoom,i.styleState,[],!1),h=W(c.dem.style.shadingIntensity,d),u=n.demManager.getElevationSourceType(),f=uu/(Math.pow(2,Math.min(Math.trunc(i.styleZoom),u==="regular"?sm:om))*so);o.enable(t,em),a.enable(t,im),r.enable(t,nm);const m=n.demManager.demCorrectedScale;e.bind(t,{u_float_dem_resolution:l[0],u_float_dem_cell_size:f,u_float_dem_shading_intensity:h,u_tex_dem:em,u_tex_corrected_dem:nm,u_tex_hillshade_ramp:im,u_float_corrected_interval:n.demManager.isDemCorrectionEnabled&&m!==1?.5/m:0,u_mat4_dem_corrected:n.demManager.demTexToCorrectedTex,u_float_map_center_elevation:i.elevation??0})},q1=(t,e)=>{e.bind(t,{u_float_dem_shading_intensity:0})},K1=(t,e)=>{e.bind(t,{u_float_dem_scale:0})},oh=dt($t,Ke),rh=dt(Cs,jd),J1=dt($t,kl),RR=dt($t,t1,jd,Cs,s1,Ke),Q1=dt($t,t1,jd,Ke),ew=dt(Cs,jd,$t,s1,Ke),zR=$t,FR=dt($t,kl),ls=(t,e,i,n,s,o)=>{const r=n.postEffectsManager.getEffectByName(um.TAA),a=!o&&(r!=null&&r.jitter)?r.jitter:CR;e.bind(t,{u_vec2_camera_jitter:a})},sn=(t,e,i,n)=>{const s=n.shadowManager.texture;s&&(s.enable(t,X1),e.bind(t,{u_texture_shadow:X1}))},DR=dt(Ke,ls,sn),Gl=dt(Ke,ls,sn),OR=dt($t,kl),BR=dt(Ke,ls,sn),kR=dt(ls,sn),cs=dt(Ke,ls,sn),tw=dt($t,Ke,sn),jl=dt(Ke,ls,sn),iw=dt($t,kl,i1,n1),nw=dt($t,kl,i1,n1,sn),NR=dt(Ke,nw),UR=dt(Ke,iw),fm=dt($t,sn),GR=dt(Ke,ls,sn),jR=dt(ls,sn),sw=dt(ls,sn),VR=dt(Ke,sw),Vl=new Float32Array(2),Hl=new Float32Array(2),HR=[0,0],ZR=[0,0,0,0],oi=(t,e)=>{e.bind(t,{u_float_opacity:1})},ow=(t,e,i,n,s,o)=>{const r=mi(i,s),a=W(o.style.textureOpacity,r);e.bind(t,{u_float_texture_opacity:s.tile.readiness*a})},mt=(t,e,i,n,s)=>{if(!s.renderingProperties.color)return;const o=Tt(s.renderingProperties.color);Ur(o,o,s.tile.readiness),e.bind(t,{u_vec4_color:o})},Zl=(t,e,i,n,s)=>{e.bind(t,{u_mat4_gradient:s.renderingProperties.mat4_gradient})},$R=(t,e,i,n,s,o)=>{const r=Tt(ze(o.style.strokeColor,mi(i,s)));Ur(r,r,s.tile.readiness),e.bind(t,{u_vec4_border_color:r})},Mi=(t,e,i,n,s)=>{const o=s.renderingProperties.widthResolved||0;e.bind(t,{u_float_width:o*window.devicePixelRatio})},rw=(t,e,i,n,s,o)=>{e.bind(t,{u_float_shift:W(o.style.shift,mi(i,s))*window.devicePixelRatio})},WR=(t,e,i,n,s,o)=>{const r=s.renderingProperties.opacityResolved||0,a=ut(i.styleZoom,i.styleState,s.attributes.tileData,!1),l=o.style.iconOpacity,c=W(l,a);a.isBehind=!0;const d=i.styleState.graphicsPreset==="light"?1:W(l,a);e.bind(t,{u_vec2_opacity:[r*c,r*d]})},zo=(t,e,i,n,s)=>{const o=s.renderingProperties.opacityResolved||0;e.bind(t,{u_float_opacity:o})},_m=(t,e,i,n,s,o)=>{const r=W(o.style.iconRotation,mi(i,s));e.bind(t,{u_vec2_rotation:[Math.cos(r),Math.sin(r)]})},XR=(t,e,i,n,s,o)=>{const r=W(o.style.opacity,mi(i,s));e.bind(t,{u_float_opacity:s.tile.readiness*r})},YR=(t,e,i,n,s,o)=>{const r=W(o.style.opacity,mi(i,s));e.bind(t,{u_float_opacity:r})},mm=(t,e,i,n,s)=>{n.assetManager.textures[s.attributes.atlasIndex].enable(t,0)},Pa=(t,e,i,n,s)=>{const o=s.renderingProperties.fontTexture;o&&o.enable(t,0)},aw=(t,e,i,n,s)=>{const o=s.renderingProperties.texture;o&&o.enable(t,0)},qR=(t,e,i,n,s)=>{const o=s.renderingProperties.rampTexture;o&&(o.enable(t,1),e.bind(t,{u_sr2d_ramp_texture:1}))},ah=(t,e,i,n,s,o)=>{const{tile:r}=s,a=ze(o.style.gapColor,mi(i,s));if(!a)return;const l=Tt(ze(a,mi(i,s)));Ur(l,l,r.readiness),e.bind(t,{u_vec4_space_color:l})},lh=(t,e,i,n,s,o)=>{const{styleZoom:r}=i,a=mi(i,s),{tile:l}=s,c=Tt(ze(o.style.color,a));Ur(c,c,l.readiness),a.styleZoom=Math.floor(r);const d=Math.pow(2,Z2(r)),h=W(o.style.dashLength,a)*d,u=W(o.style.gapLength,a)*d;e.bind(t,{u_vec4_dash_color:c,u_vec2_scaler_params:[0,Wh],u_float_dash_length:Yo(h,l.size),u_float_dash2_length:Yo(h,l.size),u_float_space_length:Yo(u,l.size)})},ot=Wa(),lw=(t,e,i,n,s,o)=>{const r=mi(i,s),{tile:a}=s,{pattern:l,width:c}=s.renderingProperties;if(!l||!c)return;const d=Tt(ze(o.style.color,r));switch(Ur(d,d,a.readiness),l[0]){case Ts.Chess:{const h=l[1];ot[0]=h,ot[1]=.5,ot[2]=.25,ot[3]=-.25;break}case Ts.DoubleDash:{const h=l[1];ot[0]=h,ot[1]=l[2]/c,ot[2]=.5*l[3]/h,ot[3]=.5*l[4]/h,ot[2]>=.5-Number.EPSILON&&(ot[2]=.6),ot[3]>=.5-Number.EPSILON&&(ot[3]=.6);break}case Ts.Stripe:{const h=l[1]+l[2];ot[0]=h,ot[1]=.55,ot[2]=.5*l[1]/h,ot[3]=.5*l[1]/h,ot[2]>=.5-Number.EPSILON&&(ot[2]=.6),ot[3]>=.5-Number.EPSILON&&(ot[3]=.6);break}case Ts.Circle:{const h=l[1]+l[2];ot[0]=h,ot[1]=.5*l[1]/h;break}case Ts.Triangles:{const h=l[1]+l[2];ot[0]=h,ot[1]=l[1]/h,ot[2]=String(l[3])==="right"?-1:1;break}case Ts.Chevron:{const h=l[1]+l[2];ot[0]=h,ot[1]=l[1]/h,ot[2]=l[3]/h,ot[3]=l[4]/c;break}}e.bind(t,{u_vec4_color:d,u_int_pattern_type:l[0],u_vec4_pattern_params:ot})},ch=(t,e,i,n,s,o)=>{const r=mi(i,s),a=W(o.style.tipWidth,r),l=W(o.style.tipHeight,r),c=a,d=0;Vl[0]=-c,Vl[1]=-0,fs(Vl,Vl),Hl[0]=a,Hl[1]=l,fs(Hl,Hl);const h=W(o.style.roundingRadius,r);e.bind(t,{u_vec2_wing_normal:Vl,u_vec2_tip_normal:Hl,u_float_tip_height_multiplier:l,u_float_wing_height_multiplier:d,u_float_wing_width_multiplier:c,u_float_size_factor:Yo(Nn,s.tile.size)/2,u_float_tip_radius_zpt:h,u_float_wing_radius_zpt:h,u_float_tail_radius_zpt:h})},cw=(t,e,i,n,s,o)=>{const r=mi(i,s),a=W(o.style.lineLength,r),l=W(o.style.lineWidth,r);e.bind(t,{u_float_length:a,u_float_width:l,u_float_border_width:0})},dw=(t,e,i,n,s,o)=>{const r=mi(i,s),{tile:a,attributes:l}=s,c=l.isLongArrow,d=s.tile.dynamicObject;let h=0,u=1;d&&(c?u=d.growPosition:h=d.bouncePosition);let f=0;const m=o.style.animation.type;(m==="appearance"||m==="repeat")&&(f=W(o.style.animation.tipMovementAmplitude,r));const p=W(o.style.roundingRadius,r);e.bind(t,{u_float_width_zpt:W(o.style.lineWidth,r),u_float_border_width_zpt:W(o.style.strokeWidth,r),u_float_tip_movement_amplitude:Yo(f,a.size),u_float_vertex_shift:h,u_float_relative_end_position:u,u_float_tip_radius_zpt:p,u_float_wing_radius_zpt:p,u_float_tail_radius_zpt:p})},KR=(t,e,i,n,s)=>{const o=s.renderingProperties.modelTexture;o&&o.enable(t,0)},JR=(t,e,i,n,s)=>(e.bind(t,{u_int_gltf_dem_pos:s.attributes.demPosition,u_vec2_anchor:s.attributes.centroid??HR,u_vec4_axis:s.attributes.axis??ZR}),!0),QR=(t,e,i,n,s)=>{const{styleId:o}=s.attributes,{renderingProperties:r}=s,{resolvedColorTexture:a,resolvedAoTexture:l,resolvedPbrTexture:c,resolvedMetallic:d,resolvedRoughness:h}=r,{modelId:u}=r,f=n.assetManager.getModel(u??NaN,o);if(!f)return;const m={},p=a!==void 0&&f.textures[a];p&&(p.enable(t,0),m.u_sr2d_texture_0=0);const _=l!==void 0&&f.textures[l];_&&(_.enable(t,1),m.u_ao_texture=1);const g=c!==void 0&&f.textures[c];g?(g.enable(t,Eg),m.u_pbr_texture=Eg):(m.u_float_metallic=d,m.u_float_roughness=h),e.bind(t,m)},hw=(t,e,i,n,s,o)=>{const{renderer:r}=n,l=r.getGlobeRenderTarget(rg(i.zoom,s.tile)).getTexture();return l?(l.enable(t,Om),e.bind(t,{u_sr2d_flatmap_texture:Om}),!0):!1},dh=(t,e,i,n,s,o)=>{e.bind(t,{u_float_height_factor:s.renderingProperties.resolvedHeightFactor})},pm=(t,e,i,n,s,o)=>{if(s.attributes.id===void 0)return;const r=n.modelLayer.getOpacity(s.attributes.id,o.minzoom),l=n.modelLayer.getBuildingHeight(s.attributes.id)===1?1:r;e.bind(t,{u_float_height_factor:l})},hh=(t,e,i,n,s,o)=>{const r=mi(i,s),a=W(o.style.height,r);e.bind(t,{u_float_height_factor:Ci(a)})},On=(t,e,i,n,s,o)=>{if(s.symbol==="polygonExtrusion"&&s.attributes.floorId&&s.attributes.isFloorStack){e.bind(t,{u_float_height_factor:n.floorManager.getFloorStackObjectHeight(s.attributes.floorId)});return}let r=n.buildingHeightAnimator.getBuildingHeight(o.minzoom);n.map.state.demMode&&(r=ih+(1-ih)*r);const a=n.modelsScene.objectIdToKey(s.id);a&&n.modelLayer.setBuildingHeight(a,r),e.bind(t,{u_float_height_factor:r})};function mi(t,e){return ut(t.styleZoom,t.styleState,e.attributes.tileData,!1,e.tile.dynamicObject)}const uh=(t,e,i,n,s)=>{const{tile:o}=s,r=s.renderingProperties.widthResolved||0;e.bind(t,{u_float_width:Yo(r,o.size)/2*Nn,u_float_width_offset:Yo(Nn/window.devicePixelRatio,o.size)/2})},ez=(t,e,i,n,s)=>{const o=s.renderingProperties.resolvedRadius;e.bind(t,{u_float_radius:o*window.devicePixelRatio})},tz=(t,e,i,n,s,o)=>{const r=W(o.style.intensity,mi(i,s));e.bind(t,{u_float_intensity:r})},Sr=(t,e,i,n,s,o)=>{const r=mi(i,s);let a=W(o.style.textFontSize,r);if(s.symbol==="point"){const l=s.attributes.labelIndex;l===ts.Second&&o.style.textFontSize2?a=W(o.style.textFontSize2,r):l===ts.Icon&&o.style.iconTextFontSize&&(a=W(o.style.iconTextFontSize,r))}e.bind(t,{u_float_scale:a*window.devicePixelRatio/jt.baseSize})},fh=(t,e,i,n,s,o)=>{const r=ut(i.styleZoom,i.styleState,s.attributes.tileData,!!s.layerSettings.isOverlappedObject),{textFontSize:a,textColor:l,textHaloWidth:c,textHaloColor:d}=o.style,h=W(a,r)/jt.baseSize,u=h*window.devicePixelRatio,f=jt.gamma/u,m=s.layerSettings.uniformSet,p=m==="fontHalo"?(6-W(c,r)/h)/8:.75;let _;m==="fontHalo"?_=Tt(ze(d,r)):_=Tt(ze(l,r)),e.bind(t,{u_float_buffer:p,u_float_gamma:f,u_vec4_color:_})},uw=(t,e,i,n,s,o)=>{const{layerSettings:r}=s,{uniformSet:a}=r,l=s.attributes.labelIndex,c=o.style;let{textFontSize:d,textHaloWidth:h,textColor:u,textHaloColor:f}=c;switch(l){case ts.Icon:d=c.iconTextFontSize,h=c.iconTextHaloWidth,u=c.iconTextColor,f=c.iconTextHaloColor;break;case ts.Second:d=c.textFontSize2,h=c.textHaloWidth2,u=c.textColor2,f=c.textHaloColor2;break}iz(t,e,i,s,d,u,h,f,l,a)},iz=(t,e,i,n,s,o,r,a,l,c)=>{const d=ut(i.styleZoom,i.styleState,n.attributes.tileData,!1,n.tile.dynamicObject),h=W(s,d)/jt.baseSize,u=h*window.devicePixelRatio,f=jt.gamma/u,m=c==="fontHalo"?(6-W(r,d)/h)/8:.75;let p,_;c==="fontHalo"?(p=Tt(ze(a,d)),d.isBehind=!0,_=Tt(ze(a,d))):(p=Tt(ze(o,d)),d.isBehind=!0,_=Tt(ze(o,d))),e.bind(t,{u_float_buffer:m,u_float_gamma:f,u_vec4_color:p,u_vec4_hidden_color:_,u_float_label_index:l})},_h=(t,e,i,n,s)=>{const{attributes:o}=s,{offsetX:r,offsetY:a}=o,l=window.devicePixelRatio;e.bind(t,{u_vec2_offset:[r*l,a*l]})},mh=(t,e,i)=>{e.bind(t,{u_float_style_zoom:i.styleZoom})},zs=(t,e,i,n,s)=>{const{tile:o}=s,{zoom:r}=i,a=256*Math.pow(2,r-o.zoomLevel)*window.devicePixelRatio;e.bind(t,{u_float_tile_to_pixel_ratio:Nn/a})},fw=(t,e,i,n,s,o)=>{const{tile:r}=s,{zoom:a,styleZoom:l}=i,c=o.style.lengthUnits===vs.Meters,d=Xn(Ye(r.coords),[xe/2,xe/2]),h=Nn/(256*Math.pow(2,a-r.zoomLevel)*window.devicePixelRatio),u=c?l:Math.floor(l),f=256*Math.pow(2,u-r.zoomLevel)*window.devicePixelRatio/(Nn*d);e.bind(t,{u_vec2_scales:[f,h]})},_w=(t,e,i,n,s)=>{const o=s.renderingProperties.flatTexture;o&&o.enable(t,0),e.bind(t,{u_flat_tex:0})},mw=(t,e,i,n,s)=>{const o=s.renderingProperties.flatIdentifyTexture;o&&o.enable(t,0),e.bind(t,{u_flat_tex:0})},pw=(t,e,i,n,s)=>{const o=s.renderingProperties.hillshadeTexture;o&&(o.enable(t,tm),e.bind(t,{u_hillshade_tex:tm}))},nz=(t,e,i,{map:n})=>{const s=n.modules.demManager.getElevationSourceType()==="regular"?1:Number(n.state.useFlatDemIrregularMeshNormals);return e.bind(t,{u_use_flat_dem_mesh_normals:s}),!0},sz=(t,e,i,n,s)=>{const o=s.renderingProperties.demTexture;o&&(o.enable(t,0),e.bind(t,{u_tex_dem:0,u_mat4_dem_corrected:n.demManager.demCorrectedFbVpToDemTex}))},$l=(t,e,i,n,s,o)=>{let r=!0;i.globeMode||(r=!!W(o.style.elevation,mi(i,s))),e.bind(t,{u_bool_skip_height_factor:r})},yn=(t,e,i,n,s,o)=>{let r=n.buildingHeightAnimator.getBuildingHeight(o.minzoom);n.map.state.demMode&&(r=ih+(1-ih)*r),e.bind(t,{u_float_height_factor:r})},ds=(t,e,i,n,s)=>{e.bind(t,{u_int_abs_z:s.attributes.absZ?1:0})},gm=(t,e)=>{e.bind(t,{u_int_abs_z:!1})},oz=(t,e)=>{e.bind(t,{u_int_signed_z:1})},ph=(t,e)=>{e.bind(t,{u_int_signed_z:0})},vm=(t,e,i,n,s)=>{e.bind(t,{u_float_tile_size:Mt(s.tile.zoomLevel)})},fe=(t,e,i,n,s,o,r)=>{e.bind(t,{u_float_dem_scale:r?i.elevationScale:0})},ym=(t,e,i,n,s)=>{if(!s.attributes.meshTier)return;const o=s.layerSettings.identify?n.renderer.getMapMeshIdFramebufferId():n.renderer.getMapMeshFramebufferId(),r=n.renderer.getFramebuffer(o),a=r==null?void 0:r.renderTarget.getTexture(),l=r==null?void 0:r.scale;a&&(a.enable(t,Ag),e.bind(t,{u_sampler_map_tex:Ag,u_vec2_tex_scale:l,u_float_tex_shift_scale:1-Math.cos(i.pitch)}))},Fs=(t,e,i,n,s)=>{e.bind(t,{u_int_identify:s.layerSettings.identify||s.layerSettings.depthTest?1:0})};function Y(...t){return(e,i,n,s,o,r,a)=>{t.forEach(l=>l(e,i,n,s,o,r,a))}}const La=(t,e,i,n,s)=>(e.bind(t,{u_bool_is_3d_line:s.symbol==="line"&&s.sink==="solid3d"||s.symbol==="line"&&s.sink==="patterned3d"||s.symbol==="dashedLine"&&s.sink==="stroke3d"}),!0),pt=(t,e,i,n,s)=>{if(!s.attributes.floorId||!s.tile.renderModelMatrix){e.bind(t,{u_float_floor_elevation:0});return}if(s.symbol==="polygonExtrusion"&&s.attributes.isFloorStack){e.bind(t,{u_float_floor_elevation:n.floorManager.getFloorStackObjectElevation(s.attributes.floorId)/s.tile.renderModelMatrix[10]});return}e.bind(t,{u_float_floor_elevation:n.floorManager.getFloorObjectElevation(s.attributes.floorId)/s.tile.renderModelMatrix[10]})},gh=(t,e)=>{e.bind(t,{u_float_floor_elevation:0})},rz={value:[0,0,0]};function bt(t,e){return ut(t.styleZoom,t.styleState,e.attributes.tileData,!1,e.tile.dynamicObject)}const az=(t,e,i,n)=>{switch(t.attributes.side){case ne.top:if(!n.style.strokeColor)return!1;break;case ne.side:if(!n.style.sideColor)return!1;break;case ne.bottom:if(!n.style.bottomColor)return!1;break;default:return!1}return!0},wm=(t,e)=>{const i=e.assetManager.textures[t.attributes.atlasIndex];return i?(t.renderingProperties.atlasTexture=i,!0):!1},gw=(t,e)=>{const i=e.imageManager.getTexture(t.attributes.textureIndex);return i?(t.renderingProperties.texture=i,!0):!1},Ca=(t,e)=>{const{range:i,fontIndex:n,styleId:s}=t.attributes,o=e.styleManager.getStyle(s);if(!o)return!1;const r=o.fonts[n],a=e.assetManager.getFontTextureByName(r,i);return a?(t.renderingProperties.fontTexture=a,!0):!1},bm=(t,e)=>{const i=t.layerSettings.identify?e.renderer.getMapMeshIdFramebufferId():e.renderer.getMapMeshFramebufferId(),n=e.renderer.getFramebuffer(i),s=n==null?void 0:n.renderTarget.getTexture(),o=n==null?void 0:n.scale;return!(!s||!o)},lz=(t,{imageManager:e})=>{const i=e.getTexture(t.attributes.rampTextureIndex);return i?(t.renderingProperties.rampTexture=i,!0):!1},cz=(t,e)=>{var s;const i=e.demManager.getDemFramebufferId(),n=(s=e.renderer.getFramebuffer(i))==null?void 0:s.renderTarget.getTexture();return n?(t.renderingProperties.demTexture=n,!0):!1},vw=(t,{demManager:e,renderer:i,map:n})=>{var r;if(!n.state.demMode)return!1;const s=e.getHillshadeFramebufferId(),o=(r=i.getFramebuffer(s))==null?void 0:r.renderTarget.getTexture();return o?(t.renderingProperties.hillshadeTexture=o,!0):!1},yw=(t,{demManager:e,renderer:i,map:n})=>{if(!n.state.demMode)return!1;const s=e.getFlatFramebufferId(),o=i.getFramebuffer(s);if(!o)return!1;const r=o.renderTarget.getTexture();return r?(t.renderingProperties.flatTexture=r,!0):!1},ww=(t,{demManager:e,renderer:i,map:n})=>{if(!n.state.demMode)return!1;const s=e.getIdentifyFlatFramebufferId(),o=i.getFramebuffer(s);if(!o)return!1;const r=o.renderTarget.getTexture();return r?(t.renderingProperties.flatIdentifyTexture=r,!0):!1},dz=(t,e,i,n)=>{var a;const{renderingProperties:s}=t,{resolvedUvIndex:o}=s,{colorTextureUvIndex:r}=n.style;return r!==void 0&&o!==r&&((((a=t.meta)==null?void 0:a.availableTextureCoords)??[])[r]&&t.vao.setAttributesAliases({texcoord_color:`texcoord_${r}`}),s.resolvedUvIndex=r),!0},hz=(t,e,i,n)=>{const{styleId:s,colorTexture:o,aoTexture:r,pbrTexture:a,meshTier:l}=t.attributes,{renderingProperties:c}=t,{modelId:d}=c,h=e.assetManager.getModel(d??NaN,s);return!h||(o!==void 0&&h.textures[o]&&(c.resolvedColorTexture=o),r!==void 0&&h.textures[r]&&(c.resolvedAoTexture=r),a!==void 0&&h.textures[a]?c.resolvedPbrTexture=a:(c.resolvedMetallic=t.attributes.metallic??n.style.metallic,c.resolvedRoughness=t.attributes.roughness??n.style.roughness),!c.resolvedColorTexture&&!c.color)?!1:l?bm(t,e):!0},bw=(t,{modelsScene:e})=>{const i=e.getModelOpacity(t);return t.renderingProperties.resolvedOpacity=i,i!==0},xw=(t,{modelsScene:e})=>{const i=e.getModelHeightFactor(t);return t.renderingProperties.resolvedHeightFactor=i,i!==0},uz=(t,e,i,n)=>{const s=bt(i,t),o=W(n.style.width,s);if(o===0)return!1;const r=q(n.style.pattern,s);return!r||r[0]===Ts.None?!1:(t.renderingProperties.width=o,t.renderingProperties.pattern=r,!0)},fz=(t,e,i)=>Tm(i,t.attributes.animDirection)!==0,Sw=(t,e,i,n)=>{const s=bt(i,t);return W(n.style.iconOpacity,s)*Tm(i,t.attributes.animDirection)!==0},pe=(t,e,i,n)=>_z(t.tile,i,n),Mw=(t,e,i)=>{var s,o,r,a,l,c;if((s=t.meta)!=null&&s.planId&&(!i.styleState._activeFloorIds||!i.styleState._activeFloorIds.includes(t.meta.planId))||(r=(o=t.meta)==null?void 0:o.linkedIds)!=null&&r.length&&!((a=t.meta)!=null&&a.planId)&&e.floorManager.hasDisplayedFloorBuilding(t.meta.linkedIds))return!1;const n=(l=t.meta)==null?void 0:l.buildingId;return!(n&&((c=t.tile.ids)!=null&&c.isHidden(n)))},_z=(t,e,i)=>{const{purpose:n,detailLevel:s}=t,{styleZoom:o}=e;switch(n){case"zenith":case"traffic":case"geojson":const r=s<Pz(n)?Be(o,s,s+.99999):o;return i.minzoom<=r&&r<i.maxzoom;case"dynamicObject":return i.minzoom<=o&&o<=i.maxzoom;default:return i.minzoom<=o&&o<i.maxzoom}},mz=(t,e,i)=>{const{styleZoom:n}=i,{tile:s}=t;if(s.purpose!=="zenith"||n>Xe.maxUniverseZoom)return!0;let o=Xe.maxUniverseZoom;if(s.sourceId){const r=e.sourceStorage.getSourceById(s.sourceId);o=(r==null?void 0:r.type)==="zenith"?r.getOptions().strokeMinZoom??Xe.maxUniverseZoom:Xe.maxUniverseZoom}return n>o},wn=(t,e,i,n)=>{const{styleZoom:s}=i;return s>=n.minzoom&&s<n.maxzoom},Iw=(t,e)=>t.attributes.id===void 0?!0:!e.modelLayer.isHidden(t.attributes.id),xm=(t,e,i,n)=>{const s=bt(i,t);return W(n.style.iconWidth,s)>0},Tw=(t,e,i,n)=>{const{layerSettings:s}=t,{uniformSet:o}=s,r=t.attributes.labelIndex,a=n.style;if(o==="fontHalo"){let{textHaloColor:l}=a;switch(r){case ts.Icon:l=a.iconTextHaloColor;break;case ts.Second:l=a.textHaloColor2;break}if(!l)return!1}return!0},vh=(t,e,i,n)=>!(t.layerSettings.uniformSet==="fontHalo"&&!n.style.textHaloColor),Sm=(t,e,i,n)=>{const s=bt(i,t),o=n.style;if(t.symbol==="point")switch(t.attributes.labelIndex){case ts.Second:return(W(o.textHaloWidth2??null,s)??0)>0&&!!o.textHaloColor2;case ts.Icon:return(W(o.iconTextHaloWidth??null,s)??0)>0&&!!o.iconTextHaloColor;case ts.First:break}return(W(o.textHaloWidth??null,s)??0)>0&&!!o.textHaloColor},pz=(t,{modelLayer:e})=>{const{texture:i,id:n}=t.attributes;if(n===void 0)return!1;const s=e.getTexture(n,i);return s?(t.renderingProperties.modelTexture=s,!0):!1},Mr=(t,e,i,n)=>{const s=W(n.style.width,bt(i,t));return t.renderingProperties.widthResolved=s,s!==0},Wl=(t,e,i,n)=>{const s=bt(i,t),o=W(n.style.strokeWidth,s);return t.renderingProperties.widthResolved=o,o!==0},gz=(t,e,i,n)=>{const s=bt(i,t),o=W(n.style.strokeWidth,s);if(o===0)return!1;const r=W(n.style.width,s);return t.renderingProperties.widthResolved=r+o*2,!0},vz=(t,e,i,n)=>{const s=bt(i,t),o=W(n.style.strokeWidth2,s);if(o===0)return!1;const r=W(n.style.width,s),a=W(n.style.strokeWidth,s);return t.renderingProperties.widthResolved=r+a*2+o*2,!0},yz=(t,e,i,n)=>{const s=bt(i,t),o=W(n.style.width,s),r=W(n.style.strokeWidth,s),a=W(n.style.strokeWidth2,s),l=o+r*2+a*2;return t.renderingProperties.widthResolved=l,l!==0},oo=(t,e,i)=>{const n=Tm(i,t.attributes.animDirection);return t.renderingProperties.opacityResolved=n,n!==0},wz=(t,e,i,n)=>(t.renderingProperties.resolvedRadius=W(n.style.radius,bt(i,t)),t.renderingProperties.resolvedRadius>0),bz=(t,e,i,n)=>{t.renderingProperties.mat4_gradient||(t.renderingProperties.mat4_gradient=new Float32Array(16));let s;switch(t.attributes.side){case ne.top:s=n.style.topColor??n.style.color;break;case ne.side:s=n.style.sideColor;break;case ne.bottom:s=n.style.bottomColor;break}const o=bt(i,t),r=q(s,o);return t.renderingProperties.mat4_gradient[0]=0,rl(r)?bn(t,r):$u(r)&&Em(r,t.tile.readiness,t.renderingProperties.mat4_gradient),!0},Ew=(t,e,i,n)=>{if(t.renderingProperties.mat4_gradient||(t.renderingProperties.mat4_gradient=new Float32Array(16)),!t.renderingProperties.color)return!1;const s=cv(n.style.sideColor,bt(i,t));return s?(dc(t.renderingProperties.color.value,s.values[0].value),Em(s,t.tile.readiness,t.renderingProperties.mat4_gradient),t.renderingProperties.color.value[3]!==0):(t.renderingProperties.mat4_gradient[0]=0,!0)},Aw=(t,e,i,n)=>{const s=t.renderingProperties.color;if(!s)return!1;t.renderingProperties.mat4_gradient||(t.renderingProperties.mat4_gradient=new Float32Array(16));const o=bt(i,t),r=ze(n.style.sideColor,o).value,a=cu(s.value,r),l=a?n.style.sideColor:n.style.sideStrokeColor,c=cv(l,bt(i,t));return c?(dc(s.value,c.values[0].value),Em(c,t.tile.readiness,t.renderingProperties.mat4_gradient)):t.renderingProperties.mat4_gradient[0]=0,a&&(s.value[3]*=i.stillness),s.value[3]!==0},Bn=(t,e)=>{const{floorManager:i}=e,n=t.attributes.hiddenById;return n?!i.hasDisplayedFloorBuilding([n]):!0},$e=(t,e)=>t.attributes.floorId?t.symbol==="polygonExtrusion"&&t.attributes.isFloorStack?e.floorManager.isVisibleFloorStackObject(t.attributes.floorId):e.floorManager.isVisibleFloorObject(t.attributes.floorId):!0,xz=t=>{const e=t.renderingProperties.color;return e?C2(e.value,0,0,0,.05*255):t.renderingProperties.color=qn([0,0,0,.05*255]),!0},Pw=(t,e,i,n)=>{const s=ut(i.styleZoom,i.styleState,t.attributes.tileData,!!t.layerSettings.isOverlappedObject);return bn(t,ze(n.style.color,s)),t.renderingProperties.color.value[3]!==0},Lw=(t,e,i,n)=>(bn(t,ze(n.style.topColor,bt(i,t))),t.renderingProperties.color.value[3]!==0),Mm=(t,e,i,n)=>(bn(t,ze(n.style.sideColor,bt(i,t))),t.renderingProperties.color.value[3]!==0),Xl=(t,e,i,n)=>(bn(t,ze(n.style.strokeColor,bt(i,t))),t.renderingProperties.color.value[3]!==0),Sz=(t,e,i,n)=>{switch(t.attributes.side){case ne.top:bn(t,ze(n.style.strokeColor,bt(i,t)));break;case ne.side:bn(t,ze(n.style.sideColor,bt(i,t)));break;case ne.bottom:bn(t,ze(n.style.bottomColor,bt(i,t)));break;default:bn(t,rz);break}return t.renderingProperties.color.value[3]!==0},Mz=(t,e,i,n)=>(bn(t,ze(n.style.strokeColor2,bt(i,t))),t.renderingProperties.color.value[3]!==0),Cw=(t,e,i,n)=>{if(t.attributes.id===void 0)return!1;const s=t.renderingProperties.color;return s?(s.value[3]*=e.modelLayer.getOpacity(t.attributes.id,n.minzoom),s.value[3]!==0):!1},Rw=(t,e,i,n)=>{const s=t.renderingProperties.color;if(!s)return!1;const o=bt(i,t),r=ze(n.style.strokeColor,o).value,a=W(n.style.strokeWidth,o);return cu(s.value,r)&&s.value[3]===1&&a<=1&&(s.value[3]*=i.stillness),s.value[3]!==0},Iz=(t,e,i,n)=>{const s=t.renderingProperties.color;if(!s)return!1;const o=bt(i,t),r=ze(n.style.topColor,o).value,a=W(n.style.strokeWidth,o);return cu(s.value,r)&&s.value[3]===1&&a<=1&&(s.value[3]*=i.stillness),s.value[3]!==0},zw=(t,e,i,n)=>{const s=ze(n.style.sideStrokeColor,bt(i,t));return bn(t,s),t.renderingProperties.color.value[3]!==0},Fo=(t,e,i,n)=>(bn(t,ze(n.style.color,bt(i,t))),t.renderingProperties.color.value[3]!==0),Tz=(t,e,i,n)=>{bn(t,ze(n.style.color,bt(i,t)));const{color:s,resolvedOpacity:o}=t.renderingProperties;return D2(s.value,s.value,t.attributes.colorFactor),s.value[3]*=o??0,s.value[3]!==0},Fw=(t,e)=>{const i=t==null?void 0:t.attributes.parentId;if(!i)return!0;const{floorManager:n}=e;if(n.hasDisplayedFloorBuilding([i]))return!0;const o=t==null?void 0:t.tile.ids;return!(o!=null&&o.isHidden(i,Qi.PolygonExtrusion))},Im=ue(pe,Fw,(t,e)=>{if(!t.bboxWorld||t.tile.dynamicObject||t.renderingProperties.animationStack&&t.renderingProperties.animationStack.length>0)return!0;if(e.environmentManager.isAABBInFog(t.bboxWorld))return!1;const i=e.camera.getViewportVertices();return tr(i,t.bboxWorld)},$e,Mw,bw,xw,Tz),Ez=ue(pe,Fw,Mw,bw,xw),Az=ue(dz,hz);function ue(...t){return(e,i,n,s)=>{for(const o of t)if(!o(e,i,n,s))return!1;return!0}}function Pz(t){switch(t){case"zenith":return Xe.maxDetailLevel;case"traffic":return ki.maxDetailLevel;case"geojson":return xd}}function Tm(t,e){return e===eo.none?1:e===eo.fadeIn?t.labelingOpacity:1-t.labelingOpacity}function Em(t,e,i){if(!t.steps.length){i[0]=0;return}i[0]=Be(t.values.length,0,3);for(let n=0;n<i[0];n++){const s=t.values[n],o=Tt(s);Ur(o,o,e),i[n+1]=t.steps[n];const r=(n+1)*4;i[r]=o[0],i[r+1]=o[1],i[r+2]=o[2],i[r+3]=o[3]}}function bn(t,e){t.renderingProperties.color||(t.renderingProperties.color=qn([255,255,255,255])),dc(t.renderingProperties.color.value,e.value)}function Dw(t,e,i){const n=document.createElement("img");return n.width=e,n.height=i,new Promise(s=>{n.onload=()=>s(n),n.src=t})}function Ow(t){let e;try{e={url:`data:image/svg+xml;base64,${btoa(t)}`}}catch{const n=URL.createObjectURL(new Blob([t],{type:"image/svg+xml"}));e={url:n,revokeURL:()=>URL.revokeObjectURL(n)}}return e}function yh(t,e="image/png"){const i=new Blob([t],{type:e}),n=URL.createObjectURL(i),s=document.createElement("img");return new Promise(o=>{s.onload=()=>{URL.revokeObjectURL(n),o(s)},t.byteLength===0?s.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=":s.src=n})}function Bw(t,e){if(e[0]===t.width&&e[1]===t.height)return t;const i=document.createElement("canvas"),n=i.getContext("2d");return i.width=e[0],i.height=e[1],n.shadowColor="transparent",n.shadowBlur=0,n.drawImage(t,0,0,e[0],e[1]),i}const Lz="FRAGMENT",Cz="VERTEX",Rz="FOG",zz="SKY",Fz="METALLIC_ROUGHNESS_DEBUG",Dz="PBR_TEXTURE",Oz="AO_TEXTURE",Bz="MAP_MESH_TEXTURE",kz="COLOR_TEXTURE",kw="LIGHT_MODEL",Nz="1",Uz="2",Gz="DEPTH_TEXTURE_SHADOW",jz="RENDER_SHADOWS",Vz="UBO",Hz="SCREENDOOR",Zz="ENTRANCE_ARROWS_ROUNDING",$z="MALI_GPU";function Nw(t,e,i,n,s){const o=Array();s&&e.forEach(r=>{const a=n[r.outputBufferView],l=Math.round(s.get(r.actionId)||-1);if(a&&s.size>0&&l>=0){const c=new Float32Array(Pm(a),r.outputBufferOffset,r.outputBufferLength);r.outputType==="VEC4"&&(i[r.targetMatIndex[0]][r.targetMatIndex[1]]=Uw(c,l,4)),r.outputType==="VEC3"&&(i[r.targetMatIndex[0]][r.targetMatIndex[1]]=Uw(c,l,3))}});for(let r=0;r<i.length;r++){const a=i[r];if(a.length===3){const l=Gi();M2(l,a[1],a[0],a[2]),o.push(l)}else o.push(a)}iF(t,o)}function Uw(t,e,i){if(i!==3&&i!==4)return console.warn("Invalid animation transform size"),[];const n=[];for(let s=0;s<i;s++)n.push(t[e*i+s]);return n}function Wz(t,e,i,n,s){t.animations.forEach((o,r)=>{o.channels.forEach((a,l)=>{if(a.target.node===i){const c=o.samplers[a.sampler],d=o.name||"default",h=t.accessors[c.input];if(h.bufferView===void 0||t.bufferViews[h.bufferView]===void 0)return;Gw(e,t,h.bufferView,h.componentType);const f=t.accessors[c.output];if(f.bufferView===void 0)return;const m=t.bufferViews[f.bufferView];if(m===void 0)return;Gw(e,t,f.bufferView,f.componentType);const p=Xz(a.target.path);n.push({min:h.min,max:h.max,frameCount:h.count,keyFrameType:"SCALAR",outputType:p.outputType,outputBufferView:f.bufferView,outputBufferOffset:m.byteOffset||0,outputBufferLength:m.byteLength/p.bufferStride,targetMatIndex:[s.length-1,p.targetindex],actionId:`${o.name}_${r}_${l}`,animationIndex:r,animationName:d})}})})}function Xz(t){let e=0,i="VEC3";const n=4;switch(t){case"translation":e=0;break;case"rotation":e=1,i="VEC4";break;case"scale":e=2;break;case"weights":e=3}return{targetindex:e,outputType:i,bufferStride:n}}function Gw(t,e,i,n){const s=e.bufferViews[i];if(s===void 0)return;if(!t.buffers[i]){const r=e.buffers[s.buffer].buffer;if(!r)return;t.buffers[i]=Pm(r)}const o=t.buffers[i];if(!(o instanceof R))return o}function Yz(t,e){for(let i=t.length-1;i>=0;i--){const n=t[i];if(e(n,i,t))return n}}const qz=new Set(["position","texcoord_0","texcoord_1","texcoord_2","texcoord_3","normal","tangent"]),Kz=Array.from(Gi()),Jz={pbrMetallicRoughness:{baseColorFactor:[1,1,1,1],metallicFactor:1,roughnessFactor:1},emissiveFactor:[0,0,0],alphaMode:"OPAQUE",alphaCutoff:.5,doubleSided:!1};function Qz(t){return jw(t,Jz),t}function jw(t,e){for(const i in e)t[i]===void 0?t[i]=e[i]:typeof t[i]=="object"&&jw(t[i],e[i])}var xn=(t=>(t[t.Pending=1]="Pending",t[t.Loaded=2]="Loaded",t[t.Failed=3]="Failed",t))(xn||{});function eF(t){return{buffers:[],objects:[],textures:[],status:1,preserve:t}}function tF(t,e,i,n,s){const o=[],r=[];return Vw(t,i.scenes[i.scene].nodes,i,o,r,e,n,s),t}function Vw(t,e,i,n,s,o,r,a){var c;if(!e)return;const l=o.symbolSettingsList.gltfModel.instances;if(!(!l||l.length===0))for(const d of e){const h=[...n],u=[...s],f=i.nodes[d];if(f.matrix&&h.push(f.matrix),f.translation&&f.rotation&&f.scale){const m=[];m.push(f.translation,f.rotation,f.scale),h.push(m),Wz(i,t,d,u,h)}if(f.mesh!==void 0){const m=i.meshes[f.mesh];let p=fg(f.extras)&&f.extras.dem==="flat"?yl.flat:yl.default;const _=new Float32Array(16);Nw(_,u,h,t.buffers);let g,y;if(f.children){const b=[];for(const v of f.children){const I=i.nodes[v];oF(I)&&b.push(I)}if(b.length){const v=b[0];if(v.extras.dem==="centroid")p=yl.centroid,g=[v.translation[0],v.translation[2]];else if(v.extras.dem==="axis"){p=yl.axis;const I=Yz(b,S=>S.extras.dem==="axis");y=[v.translation[0],v.translation[2],(I??v).translation[0],(I??v).translation[2]]}}}for(const b of m.primitives){const v=[],I={};let S=0,P,T;for(const E in b.attributes){const k=/TEXCOORD_(\d+)/.exec(E);k&&(v[parseInt(k[1],10)]=!0);const D=E.toLowerCase();if(!qz.has(D))continue;const U=b.attributes[E],N=i.accessors[U];if(N.bufferView===void 0)continue;const G=i.bufferViews[N.bufferView];if(G===void 0)continue;const Q=Hw(t,i,N.bufferView,N.componentType);if(Q){if(D==="position"&&(P=N.min,T=N.max),Q.purpose="gltfMesh",I[E.toLowerCase()]=new z(Q,{itemSize:nF(N.type),dataType:Zg(N.componentType),stride:G.byteStride??0,offset:N.byteOffset??0,normalized:!!N.normalized}),!g&&E.toLowerCase()==="position"){const X=N.min,H=N.max;X&&H&&(g=[(H[0]+X[0])/2,(H[2]+X[2])/2])}S===0&&(S=N.count)}}P||(P=[0,0,0]),T||(T=[0,0,0]);let L;if(b.indices!==void 0){const E=i.accessors[b.indices];if(E.bufferView===void 0||(L=Hw(t,i,E.bufferView,E.componentType,!0),!L))continue;L.purpose="gltfIndices",S=E.count}const B=b.material!==void 0?i.materials[b.material]:{},O=Qz(B),w={},x={localMatrix:_,animationStack:u,transformStack:h,availableTextureCoords:v,attributesAliases:w,colorFactor:[...O.pbrMetallicRoughness.baseColorFactor],colorTexture:NaN,aoTexture:NaN,pbrTexture:NaN,centroid:g,axis:y,demPosition:p},C=[],V=O.pbrMetallicRoughness.baseColorTexture;V&&(C.push({type:kz}),w.texcoord_color=`texcoord_${V.texCoord??0}`,Am(t,i,V),x.colorTexture=V.index);const M=O.pbrMetallicRoughness.metallicRoughnessTexture;if(M){C.push({type:Dz}),Am(t,i,M),x.pbrTexture=M.index;const E=typeof M.texCoord=="number"?M.texCoord:0;w.texcoord_pbr=`texcoord_${E}`,v[E]=!1}else x.roughness=O.pbrMetallicRoughness.roughnessFactor??1,x.metallic=O.pbrMetallicRoughness.metallicFactor??1;Number.isNaN(a.style.roughness)||C.push({type:Fz}),((c=f.extras)==null?void 0:c.tier)!==void 0&&(x.meshTier=f.extras.tier,C.push({type:Bz})),a.style.lightingModel==="pbr"?C.push({type:kw,value:Uz}):C.push({type:kw,value:Nz});const A=O.occlusionTexture;if(A){C.push({type:Oz}),Am(t,i,A),x.aoTexture=A.index;const E=typeof A.texCoord=="number"?A.texCoord:0;w.texcoord_ao=`texcoord_${E}`,v[E]=!1}t.objects.push({start:0,count:S,attributes:x,drawMode:b.mode,accessors:I,elementsBuffer:L,shaderDefinitions:C,bbox:{min:P,max:T}})}}f.children&&Vw(t,f.children,i,h,u,o,r,a)}}function Am(t,e,i){const n=i.index??0,s=e.textures[n];if(!s||s.source===void 0||s.sampler===void 0)return;const o=e.images[s.source],r=e.samplers[s.sampler];if(!r||!o)return;const a={flipY:!1};if(r.magFilter&&(a.magFilter=Nd(r.magFilter)),r.minFilter&&(a.minFilter=Nd(r.minFilter)),r.wrapS&&(a.wrapS=Nd(r.wrapS)),r.wrapT&&(a.wrapT=Nd(r.wrapT)),i.texCoord!==void 0&&(a.texcoord=i.texCoord),!o.image&&o.bufferView){sF(e,o).then(l=>{l&&(o.image=l,t.textures[n]=new j(o.image,a))});return}t.textures[n]=new j(o.image,a)}function Hw(t,e,i,n,s=!1){const o=e.bufferViews[i];if(o===void 0)return;if(!t.buffers[i]){const a=e.buffers[o.buffer].buffer;if(!a)return;const l=new DataView(Pm(a),o.byteOffset,o.byteLength),c=new R(l,{dataType:Zg(n)},s);t.buffers[i]=c}const r=t.buffers[i];if(!(r instanceof ArrayBuffer))return r}function iF(t=[],e){if(e.length===0)return Array.from(Kz);Nr(t,e[0]);for(let i=1;i<e.length;i++)Us(t,t,e[i]);return t}function nF(t){switch(t[0]){case"S":return 1;case"V":return Number(t[3]);case"M":return Number(t[3])**2}return console.error(`Failed to determine channels count from accessor type = ${t}`),0}function Pm(t){return t instanceof ArrayBuffer?t:t.buffer}async function sF(t,e){if(!e.bufferView)return!1;const i=t.bufferViews[e.bufferView];if(i===void 0)return!1;const n=t.buffers[i.buffer].buffer;return n?yh(new Uint8Array(n,i.byteOffset,i.byteLength),e.mimeType):!1}function oF(t){return t.mesh===void 0&&fg(t.extras)&&(t.extras.dem==="centroid"||t.extras.dem==="axis")}const rF=_o([1,1,1]),Ir=Oe(),Lm=Oe(),aF=Gi();function lF(t,e){Ns(t,e);const i=Gi();i[12]+=t[12],i[13]+=t[13],Us(t,t,i)}function Cm(t){return t.symbol==="gltfModel"&&t.sink==="instances"}function cF(t,e,i,n,s){const o=t.modelMatrices.get(0);if(!o)return;const r=[i[0]/rt,i[1]/rt,i[2]/rt],a=[i[3]/rt,i[4]/rt,i[5]/rt],l={min:[0,0,0],max:[0,0,0]};if(Tn(l.min,r,o),Tn(l.max,a,o),s)if(n.tMatrix3x3){const c=dF(s,n.tMatrix3x3,e);Ot(l.min,l.min,c.min),Ot(l.max,l.max,c.max)}else{let c=Math.max(_o(s.max),_o(s.min));if(e){const d=Ir,h=Lm;tS(e,d,h);const u=_o(d)/rF;c*=u,c+=_o(h)}c*=n.maxDiag??1,gt(Ir,-c,-c,-c),Ot(l.min,l.min,Ir),gt(Ir,c,c,c),Ot(l.max,l.max,Ir)}return l}function dF(t,e,i){const n=x2(aF,e[0],e[1],e[2],0,e[3],e[4],e[5],0,e[6],e[7],e[8],0,0,0,0,1);i&&Us(n,n,i);const s=Ti(Ir,t.min,t.max,.5),o=Ni(Lm,vi(Lm,t.max,t.min),.5),r=Tn(Ir,s,n),a=at(Math.abs(n[0])*o[0]+Math.abs(n[4])*o[1]+Math.abs(n[8])*o[2],Math.abs(n[1])*o[0]+Math.abs(n[5])*o[1]+Math.abs(n[9])*o[2],Math.abs(n[2])*o[0]+Math.abs(n[6])*o[1]+Math.abs(n[10])*o[2]),l=vi(Oe(),r,a),c=Ot(Oe(),r,a);return{min:l,max:c}}class hF{constructor(e){this.modules=e,this.queue=new Map}enqueue(e,i){this.queue.set(i.id,{batch:e,tile:i,state:void 0})}update(){const{renderer:e,tileManager:i}=this.modules;for(const n of i.getTileObjects()){const s=this.queue.get(n.id);if(!s)continue;const{batch:o}=s,{symbol:r,sink:a}=o,l=qf(e,r,a);if(!l){console.error(`Cannot happen! Symbol ${r} does not have sink ${a}!`);continue}const c=l[0].instanceBinder;if(!c){console.error("Cannot happen! No instanceBinder for batch inside instanceLinker queue.");continue}const d=c(this.modules,o,n,s.state);if(!d){this.queue.delete(n.id);continue}s.state=d}}}function uF(t,e,i,n,s,o,r,a,l,c,d,h){const u=El(o,r),f=qf(e,o,r),{accessors:m,elementsBuffer:p,count:_,drawMode:g,bbox:y}=n,b=Ps.createShaderDefinitions(n.shaderDefinitions);d.linkId=i;for(const v of f){const I=v.uniformSet||"fill",S=JSON.stringify(l)+"_"+I+"_"+s.detailLevel,P=e.getShaderProgram(v.programName,b),T=a.buffer;if(!T){console.error(`Expected existing buffer while linking instance, but ${T} found.`);continue}const L=v.vaoCreator(T,P,p,m);d.attributesAliases&&L.setAttributesAliases(d.attributesAliases);const B={id:Vn(),type:Xi.Tile,layerSettings:v,start:0,count:_,attributes:l,shaderDefinitions:b,renderingProperties:c,meta:d,attributesHash:S,vao:L,drawMode:g,tile:s,bbox:y,bboxWorld:h,symbol:o,sink:r,canRender:!0,instanceCount:(a.rangeEnd-a.rangeStart)/u};s.push(B),t.push(B)}t.length&&e.addRerenderEvent({type:"instanceLink"})}function Zw(t,e,i){fF(e,n=>{var o;const s=((o=n.meta)==null?void 0:o.linkId)===i;return s&&t.push(n),!s})}function fF(t,e){t.children=t.children.filter(e),t.identifyChildren=t.identifyChildren.filter(e),t.depthTestChildren=t.depthTestChildren.filter(e),t.labelTestChildren=t.labelTestChildren.filter(e),t.shadowChildren=t.shadowChildren.filter(e)}const _F={min:[0,0,0],max:[0,0,0]},wh=(t,e,i,n)=>{const{assetManager:s,modelsScene:o,renderer:r}=t;if(n||(n={}),i.destroyed){const l=[];for(const c in n){const d=n[+c];Number.isNaN(d.linkId)||Zw(l,i,d.linkId)}for(const c of l)o.removeSceneObject(c.id);return}const a=[];for(let l=0;l<e.generatedObjects.length;l++){const c=e.generatedObjects[l],d=ss.sinks.instances.unpackObjectAttributes(c.attributes),{extents:h}=c;n[l]||(n[l]={modelId:NaN,linkId:NaN});const u=n[l];let f;const m=!!u.referenceBbox;u.referenceBbox?f=u.referenceBbox:(f=_F,f.min[0]=h[0]/rt,f.min[1]=h[1]/rt,f.min[2]=h[2]/rt,f.max[0]=h[3]/rt,f.max[1]=h[4]/rt,f.max[2]=h[5]/rt);const{styleId:p}=d,_=u.modelId;o.updateModelId(u,d,f,i,m);const g=u.modelId;if(g===void 0||Number.isNaN(g)||_===g)continue;const y=s.getModel(g,p);if(!y||y.status!==xn.Loaded||y.objects.length===0)continue;const b=u.linkId;if(!Number.isNaN(b)){const I=[];Zw(I,i,b);for(const S of I)o.removeSceneObject(S.id)}const v=Vn();u.linkId=v;for(const I of y.objects){const S=i.modelMatrices.get(0),P=new Float32Array(16);lF(P,S);const{attributesAliases:T,availableTextureCoords:L,colorTexture:B,colorFactor:O,aoTexture:w,pbrTexture:x,metallic:C,roughness:V,meshTier:M,animationStack:A,transformStack:E,localMatrix:k,demPosition:D,axis:U,centroid:N}=I.attributes,G=cF(i,k,h,c,I.bbox);!u.referenceBbox&&G&&(u.referenceBbox=G),uF(a,r,v,I,i,e.symbol,e.sink,c,{colorTexture:B,colorFactor:O,aoTexture:w,pbrTexture:x,metallic:C,roughness:V,meshTier:M,demPosition:D,axis:U,centroid:N,...d},{modelId:g,animationStack:A,transformStack:E,localMatrix:new Float32Array(k??[]),transformMatrix:P},{...c.meta,attributesAliases:T,availableTextureCoords:L},G)}}return a.forEach(l=>{o.addSceneObject(l)}),n},bh=new Float32Array(16);let Jt;function te(...t){return(i,n,s,o,r,a,l)=>{for(const c of t)if(!c(i,n,s,o,r,a,l))return!1;return!0}}const se=(t,e,i,n,s)=>(e.bind(t,{u_mat4_mvp:s.tile.renderMvpMatrix}),!0),Ii=(t,e,i,n,s)=>{const{camera:o,styleManager:r}=n,a=r.getStyle(i.handyStyleId);return!(a==null?void 0:a.environment)||!s.tile.renderModelMatrix?!1:(e.bind(t,{u_mat4_flat_mvp:s.tile.renderMvpMatrix,u_mat4_ecef_mvp:o.ecefMvpMatrix,u_float_crossfade:o.globeRatio}),!0)},xh=(t,e,i,n,s)=>(e.bind(t,{u_mat4_flat_map_mvp:s.tile.renderFlatMapTexMatrix}),!0),Pe=(t,e,i,n,s)=>s.tile.renderModelMatrix?(Nr(bh,s.tile.renderModelMatrix),e.bind(t,{u_mat4_model:bh}),!0):!1,Sh=(t,e,i,n,s)=>(e.bind(t,{u_int_abs_z:s.attributes.absZ?1:0}),!0),_e=(t,e,i,n,s,o,r)=>{if(r.terrain3d){if(!s.tile.renderModelMatrix)return!1;e.bind(t,{u_mat4_dem_mvp:s.tile.renderDemMatrix,u_float_vertical_scale:1/s.tile.renderModelMatrix[10]})}return!0};function Rm(t,e){return ut(t.styleZoom,t.styleState,e.attributes.tileData)}const zm=(t,e,i,n,s,o)=>{var p;Jt=void 0;const r=Rm(i,s),a=Ri(o.style.textureImage,r);let l=!1,c;o.type==="polygon"&&(l=o.style.lengthUnits===vs.Meters);const d=n.styleManager.getStyle(s.attributes.styleId);if(!d)return!0;const h=(p=d.rasterSets.byKey[ta(a)])==null?void 0:p.rasters;if(!h)return!0;if(l){const[_,g=_]=q(o.style.textureSize,r),y=_*oa(_,_),b=g*oa(g,g);c=[y,b]}else c=q(o.style.textureSize,r);const[u,f]=Array.isArray(c)?c:[c,c];if(u<=0||f<=0)return!0;const m=ma(h,u*window.devicePixelRatio,!0);return m===void 0||(Jt=h[m]),!0},Fm=(t,e,i,{assetManager:n},s,o)=>{if(!Jt)return e.bind(t,{u_int_is_textured:0}),!0;let r,a,l,c;const{tile:d}=s,{zoom:h}=i,u=n.textures[Jt.atlasIndex];let f=!1;if(!u)return e.bind(t,{u_int_is_textured:0}),!0;o.type==="polygon"&&(f=o.style.lengthUnits===vs.Meters),u.enable(t,0);let m;if(f){const p=Rm(i,s),[_,g=_]=q(o.style.textureSize,p),y=Z.toGeo(Wi(d.coords)),b=Z.scaleFactor(y[1]),v=Mt(d.zoomLevel)/Ge/b;l=v/_,c=v/g,r=d.coords[0]*l%1,a=d.coords[1]*c%1}else m=256*Math.pow(2,Math.round(h)-d.zoomLevel)*window.devicePixelRatio,r=d.coords[0]*m%Jt.w/Jt.w,a=d.coords[1]*m%Jt.h/Jt.h,l=m/Jt.w,c=m/Jt.h;return e.bind(t,{u_int_is_textured:1,u_float_texture_params:[r,a,l,c],u_float_sprite_texture_coords:[(Jt.x+.5)/Gt[0],(Jt.y+Jt.h-1)/Gt[1],(Jt.x+Jt.w-1)/Gt[0],(Jt.y+.5)/Gt[1]]}),!0},mF=(t,e,i,n,s)=>{if(!Jt)return e.bind(t,{u_int_is_textured:0}),!0;const{tile:o}=s,{zoom:r}=i,a=n.assetManager.textures[Jt.atlasIndex];if(!a)return e.bind(t,{u_int_is_textured:0}),!0;a.enable(t,0);const l=256*Math.pow(2,Math.round(r)-o.zoomLevel)*window.devicePixelRatio;return e.bind(t,{u_int_is_textured:1,u_float_texture_vertical_scale:Jt.h*o.size/l}),!0},pF=(t,e,i,{styleManager:n,assetManager:s},o,r)=>{var b;const a=Rm(i,o),l=Ri(r.style.iconImage,a),c=n.getStyle(o.attributes.styleId);if(!c)return!1;const d=(b=c.rasterSets.byKey[ta(l)])==null?void 0:b.rasters;if(!d)return!1;const h=W(r.style.width,a),u=W(r.style.height,a),f=oa(h,u),m=h*f,p=u*f;if(m<=0||p<=0)return!1;const _=ma(d,m*window.devicePixelRatio,!0);if(_===void 0)return!1;const g=d[_],y=s.textures[g.atlasIndex];return y?(y.enable(t,0),e.bind(t,{u_float_sprite_texture_coords:[(g.x+.5)/Gt[0],(g.y+g.h-1)/Gt[1],(g.x+g.w-1)/Gt[0],(g.y+.5)/Gt[1]]}),!0):!1},$w=new Float32Array(16);cc($w,[1/4294967296,1/4294967296,1/4294967296]);const Mh=(t,e,i,{animationManager:n,assetManager:s},o,r)=>{const{styleId:a}=o.attributes,{localMatrix:l,transformMatrix:c,modelId:d}=o.renderingProperties;if(d===void 0)return!1;const h=s.getModel(d,a);return h===void 0?!1:(n.animateGltfObject(o,r,h),e.bind(t,{u_mat4_localmatrix:l,u_mat4_instance:i.globeMode?$w:c}),!0)},gF=(t,e,i,n,s)=>s.tile.renderModelMatrix?(Nr(bh,s.tile.renderModelMatrix),e.bind(t,{u_mat4_model:bh}),!0):!1,vF=(t,e,i,n)=>!n.shadowManager.texture;function yF(){return{line:{solid:[{programName:"road",vaoCreator:PL,webglState:_i,needsVisibilityBuffer:!1,commonBinder:Se(we,ye,ke),programBinder:jR,objectBinder:Y(rw,mt,Mi),layerBinder:qe,zoomBinder:zs,tileBinder:te(Pe,se),cullMethod:ue(pe,Mr,Fo)},{identify:!0,programName:"roadIdentify",vaoCreator:zL,webglState:no,needsVisibilityBuffer:!1,objectBinder:Y(Mi),zoomBinder:zs,tileBinder:se,cullMethod:ue(pe,Mr)}],patterned:[{programName:"patternedLine",vaoCreator:FL,webglState:_i,needsVisibilityBuffer:!1,commonBinder:Se(we,ye,ke),programBinder:sw,layerBinder:qe,objectBinder:Y(lw,Mi,oi,La),zoomBinder:fw,tileBinder:te(Pe,se),cullMethod:ue(pe,Mr,uz)}],solid3d:[{programName:"line3D",vaoCreator:LL,webglState:X_,needsVisibilityBuffer:!1,commonBinder:Se(we,ye,ke),programBinder:DR,objectBinder:Y(mt,Mi,fe),layerBinder:qe,zoomBinder:zs,tileBinder:te(Pe,se,_e),cullMethod:ue(pe,Fo)},{identify:!0,programName:"line3DIdentify",vaoCreator:CL,webglState:zt,needsVisibilityBuffer:!1,programBinder:Ke,objectBinder:Y(Mi,fe),zoomBinder:zs,tileBinder:te(se,_e),cullMethod:pe}],patterned3d:[{programName:"patternedLine3D",vaoCreator:DL,webglState:X_,needsVisibilityBuffer:!1,commonBinder:Se(we,ye,ke),programBinder:VR,layerBinder:qe,objectBinder:Y(lw,Mi,oi,La,fe),zoomBinder:fw,tileBinder:te(Pe,se,_e),cullMethod:pe}]},polygon:{fill:[{programName:"vtxColor",vaoCreator:IL,webglState:_i,needsVisibilityBuffer:!0,commonBinder:Se(we,ye,ke),programBinder:kR,layerBinder:fi(qe,Cs),objectBinder:Y(mt,oi,ow,pt),tileBinder:te(zm,Fm,se,Pe),cullMethod:ue(pe,$e,Fo)},{identify:!0,programName:"vtxColorIdentify",vaoCreator:AL,webglState:no,needsVisibilityBuffer:!0,programBinder:e1,objectBinder:Y(pt),tileBinder:se,cullMethod:ue(pe,$e)}],stroke:[{programName:"simpleLine",vaoCreator:YL,webglState:_i,needsVisibilityBuffer:!0,commonBinder:Se(we,ye,ke),programBinder:Gl,layerBinder:fi(e1,Vd,qe),objectBinder:Y(mt,Mi,ph,pt),tileBinder:te(Pe,se),cullMethod:ue(mz,pe,$e,Wl,Xl,Rw),subRenderIndex:1}],shadow:[{programName:"vtxColor",vaoCreator:TL,webglState:_i,needsVisibilityBuffer:!0,commonBinder:Se(we,ye),programBinder:ls,layerBinder:Cs,objectBinder:Y(mt,oi,pt),tileBinder:te(vF,zm,Fm,se,Pe),cullMethod:ue(pe,$e,xz)}]},metricPoint:{fill:[{programName:"metricPoint",vaoCreator:EL,webglState:_i,needsVisibilityBuffer:!1,commonBinder:Se(we,ke,ye),programBinder:sn,layerBinder:fi(qe,Cs),objectBinder:Y(mt,pt),tileBinder:te(pF,se,Pe),cullMethod:ue(pe,$e,Fo)}]},mesh:{fill:[{programName:"mesh",vaoCreator:d1,webglState:C1,needsVisibilityBuffer:!0,commonBinder:Se(we,ye,ke),programBinder:cs,layerBinder:fi(qe,Rs),objectBinder:Y(mt,Zl,oi,yn,fe,ds,Fs,ow),tileBinder:te(zm,Fm,mF,Pe,se,_e),cullMethod:ue(pe,bz),subRenderIndex:1,is3dMapAware:!0},{identify:!0,programName:"mesh",vaoCreator:d1,webglState:zt,needsVisibilityBuffer:!0,commonBinder:Se(we,ye,ke),programBinder:cs,objectBinder:Y(yn,fe,ds,Fs),tileBinder:te(se,_e),cullMethod:pe,subRenderIndex:1,is3dMapAware:!0},{depthTest:!0,programName:"mesh",vaoCreator:BL,webglState:zt,needsVisibilityBuffer:!0,commonBinder:Se(we,ye,ke),programBinder:cs,objectBinder:Y(yn,fe,ds,Fs),tileBinder:te(se,_e),cullMethod:pe,subRenderIndex:1,is3dMapAware:!0},{programName:"meshShadow",shadow:!0,vaoCreator:h1,webglState:Kd,needsVisibilityBuffer:!0,programBinder:Ke,objectBinder:Y(yn,fe,ds),tileBinder:te(se,_e),cullMethod:pe,is3dMapAware:!0}],inverse:[{programName:"mesh",vaoCreator:$d,webglState:Yd,needsVisibilityBuffer:!0,commonBinder:Se(we,ye,ke),programBinder:cs,objectBinder:Y(yn,fe,Fs),tileBinder:te(se,_e),subRenderIndex:-1,is3dMapAware:!0},{identify:!0,programName:"mesh",vaoCreator:$d,webglState:Yd,needsVisibilityBuffer:!1,commonBinder:Se(we,ye,ke),programBinder:cs,objectBinder:Y(yn,fe,Fs),tileBinder:te(se,_e),subRenderIndex:-1,is3dMapAware:!0},{programName:"meshShadow",shadow:!0,vaoCreator:$d,webglState:Kd,needsVisibilityBuffer:!0,programBinder:Ke,objectBinder:Y(yn,fe,ds),tileBinder:te(se,_e),cullMethod:pe,is3dMapAware:!0}],depthClear:[{programName:"meshDepthClear",vaoCreator:$d,webglState:xC,needsVisibilityBuffer:!0,commonBinder:Se(we,ye,ke),programBinder:cs,objectBinder:Y(yn,fe,Fs,ds),tileBinder:te(se,_e),subRenderIndex:-2,is3dMapAware:!0}],stroke:[{programName:"meshStroke",vaoCreator:kL,webglState:Ta,needsVisibilityBuffer:!0,commonBinder:Se(we,ye,ke),programBinder:Gl,layerBinder:fi($t,Vd,qe),objectBinder:Y(mt,Mi,yn,oz,fe,ds),tileBinder:te(Pe,se,_e),cullMethod:ue(pe,Wl,az,Sz,Rw),subRenderIndex:2,is3dMapAware:!0}]},polygonExtrusion:{sideFill:[{programName:"diffuse",vaoCreator:Wd,webglState:Yd,needsVisibilityBuffer:!0,commonBinder:Se(we,ye,ke),programBinder:jl,tileBinder:te(Pe,se,_e),layerBinder:fi(qe,Rs),objectBinder:Y(mt,On,oi,fe,pt),cullMethod:ue(pe,$e,Mm,Bn),is3dMapAware:!0},{programName:"gradientDiffuse",vaoCreator:Wd,webglState:R1,needsVisibilityBuffer:!0,commonBinder:Se(we,ye,ke),programBinder:jl,layerBinder:fi(qe,Rs),objectBinder:Y(mt,Zl,On,oi,fe,pt),tileBinder:te(Pe,se,_e),cullMethod:ue(pe,$e,Bn,Mm,Ew),subRenderIndex:1,is3dMapAware:!0},{identify:!0,programName:"buildingIdentify",vaoCreator:u1,webglState:zt,needsVisibilityBuffer:!0,programBinder:oh,objectBinder:Y(On,fe,pt),tileBinder:te(se,_e),cullMethod:ue(pe,$e,Bn),is3dMapAware:!0},{depthTest:!0,programName:"buildingIdentify",vaoCreator:f1,webglState:zt,needsVisibilityBuffer:!0,programBinder:oh,objectBinder:Y(On,fe,pt),tileBinder:te(se,_e),cullMethod:ue(pe,$e,Bn),is3dMapAware:!0},{programName:"buildingShadow",shadow:!0,vaoCreator:_1,webglState:qd,needsVisibilityBuffer:!0,programBinder:Ke,objectBinder:Y(On,fe,pt),tileBinder:te(se,_e),cullMethod:ue(pe,$e,Bn),is3dMapAware:!0}],topFill:[{programName:"diffuse",vaoCreator:Wd,webglState:Yd,needsVisibilityBuffer:!0,commonBinder:Se(we,ye,ke),programBinder:jl,layerBinder:qe,objectBinder:Y(mt,On,oi,fe,pt),tileBinder:te(Pe,se,_e),cullMethod:ue(pe,$e,Bn,Lw),is3dMapAware:!0},{programName:"diffuse",vaoCreator:Wd,webglState:R1,needsVisibilityBuffer:!0,commonBinder:Se(we,ye,ke),programBinder:jl,layerBinder:fi(qe,Rs),objectBinder:Y(mt,On,oi,fe,pt),tileBinder:te(Pe,se,_e),cullMethod:ue(pe,$e,Bn,Lw),subRenderIndex:1,is3dMapAware:!0},{identify:!0,programName:"buildingIdentify",vaoCreator:u1,webglState:zt,needsVisibilityBuffer:!0,programBinder:oh,objectBinder:Y(On,fe,pt),tileBinder:te(se,_e),cullMethod:ue(pe,$e,Bn),is3dMapAware:!0},{depthTest:!0,programName:"buildingIdentify",vaoCreator:f1,webglState:zt,needsVisibilityBuffer:!0,programBinder:oh,objectBinder:Y(On,fe,pt),tileBinder:te(se,_e),cullMethod:ue(pe,$e,Bn),is3dMapAware:!0},{programName:"buildingShadow",shadow:!0,vaoCreator:_1,webglState:qd,needsVisibilityBuffer:!0,programBinder:Ke,objectBinder:Y(On,fe,pt),tileBinder:te(se,_e),cullMethod:ue(pe,$e,Bn),is3dMapAware:!0}],sideStroke:[{programName:"line",vaoCreator:m1,webglState:Ta,needsVisibilityBuffer:!0,commonBinder:Se(we,ke,ye),programBinder:tw,layerBinder:qe,objectBinder:Y(mt,Zl,On,oi,fe,pt),tileBinder:te(Pe,se,_e),cullMethod:ue(pe,$e,Bn,zw,Aw),subRenderIndex:3,is3dMapAware:!0}],topStroke:[{programName:"simpleLine",vaoCreator:D_,webglState:Ta,needsVisibilityBuffer:!0,commonBinder:Se(we,ye,ke),programBinder:Gl,layerBinder:fi(qe,$t,bL),objectBinder:Y(mt,Mi,On,ph,fe,pt,gm),tileBinder:te(Pe,se,_e),cullMethod:ue(pe,$e,Bn,Wl,Xl,Iz),subRenderIndex:4,is3dMapAware:!0}]},labelLine:{raster:[{programName:"labelLine",vaoCreator:Zd,webglState:q_,needsVisibilityBuffer:!1,commonBinder:Se(we,ye),programBinder:rh,objectBinder:Y(zo,Pa,Sr,fh,mh),tileBinder:te(se,Pe),zoomBinder:zs,cullMethod:ue($e,oo,wn,Ca,vh,Sm),uniformSet:"fontHalo"},{programName:"labelLine",vaoCreator:Zd,webglState:K_,needsVisibilityBuffer:!1,commonBinder:Se(we,ye),programBinder:rh,objectBinder:Y(zo,Pa,Sr,fh,mh),tileBinder:te(se,Pe),zoomBinder:zs,cullMethod:ue($e,oo,Sm,wn,Ca,vh),uniformSet:"fontHalo",isOverlappedObject:!0},{programName:"labelLine",vaoCreator:Zd,webglState:q_,needsVisibilityBuffer:!1,commonBinder:Se(we,ye),programBinder:rh,objectBinder:Y(zo,Pa,Sr,fh,mh),zoomBinder:zs,tileBinder:te(se,Pe),cullMethod:ue($e,oo,wn,Ca,vh),uniformSet:"fontFill",subRenderIndex:1},{programName:"labelLine",vaoCreator:Zd,webglState:K_,needsVisibilityBuffer:!1,commonBinder:Se(we,ye),programBinder:rh,objectBinder:Y(zo,Pa,Sr,fh,mh),zoomBinder:zs,tileBinder:te(se,Pe),cullMethod:ue($e,oo,wn,Ca,vh),uniformSet:"fontFill",subRenderIndex:1,isOverlappedObject:!0}]},dashedLine:{stroke:[{programName:"stripedLine",vaoCreator:a1,webglState:_i,needsVisibilityBuffer:!1,commonBinder:Se(ke,we,ye),programBinder:nw,layerBinder:qe,objectBinder:Y(lh,uh,ah,oi,La),tileBinder:te(Pe,se),cullMethod:ue(pe,Mr)},{identify:!0,programName:"stripedLineIdentify",vaoCreator:a1,webglState:L1,needsVisibilityBuffer:!1,programBinder:iw,objectBinder:Y(lh,uh,oi,ah,La),tileBinder:se,cullMethod:ue(pe,Mr)}],stroke3d:[{programName:"stripedLine3D",vaoCreator:l1,webglState:X_,needsVisibilityBuffer:!1,commonBinder:Se(ke,we,ye),programBinder:NR,layerBinder:qe,objectBinder:Y(lh,uh,ah,oi,La,fe),tileBinder:te(Pe,se,_e),cullMethod:pe},{identify:!0,programName:"stripedLine3DIdentify",vaoCreator:l1,webglState:zt,needsVisibilityBuffer:!1,programBinder:UR,objectBinder:Y(lh,uh,oi,ah,La,fe),tileBinder:te(se,_e),cullMethod:pe}]},oneWayLine:{raster:[{programName:"oneWayLine",vaoCreator:p1,webglState:q_,needsVisibilityBuffer:!1,commonBinder:Se(Bl,Ol),programBinder:J1,objectBinder:Y(zo,mt,ch,cw),tileBinder:se,cullMethod:ue(oo,wn,Pw)},{programName:"oneWayLine",vaoCreator:p1,webglState:K_,commonBinder:Se(Bl,Ol),programBinder:J1,needsVisibilityBuffer:!1,objectBinder:Y(zo,mt,ch,cw),tileBinder:se,cullMethod:ue(oo,wn,Pw),isOverlappedObject:!0}]},point:{raster:[{programName:"pointSprite",vaoCreator:GL,webglState:Y_,needsVisibilityBuffer:!1,commonBinder:Nl(we,ye,q0,Gd),programBinder:RR,layerBinder:Cs,objectBinder:Y(WR,mm,_m,$l,fe,pt),cullMethod:ue(wn,$e,xm,wm,oo),tileBinder:te(Ii,Pe,_e),is3dMapAware:!0},{identify:!0,programName:"pointSpriteIdentify",vaoCreator:VL,webglState:no,needsVisibilityBuffer:!1,programBinder:Q1,objectBinder:Y(mm,_m,$l,fe,pt),tileBinder:te(Ii,_e),cullMethod:ue(wn,$e,xm,wm,Sw),is3dMapAware:!0},{labelTest:!0,programName:"pointSpriteIdentify",vaoCreator:jL,webglState:no,needsVisibilityBuffer:!1,programBinder:Q1,objectBinder:Y(mm,_m,$l,fe,pt),tileBinder:te(Ii,_e),cullMethod:ue(wn,$e,xm,wm,Sw),is3dMapAware:!0}],text:[{programName:"labelPoint",vaoCreator:c1,webglState:Y_,needsVisibilityBuffer:!1,commonBinder:Nl(we,ye,Gd),programBinder:ew,objectBinder:Y(zo,Pa,Sr,uw,_h,$l,fe,pt),tileBinder:te(Ii,Pe,_e),cullMethod:ue(wn,$e,oo,Ca,Tw,Sm),uniformSet:"fontHalo",subRenderIndex:1,is3dMapAware:!0},{programName:"labelPoint",vaoCreator:c1,webglState:Y_,needsVisibilityBuffer:!1,commonBinder:Se(we,ye,Gd),programBinder:ew,objectBinder:Y(zo,Pa,Sr,uw,_h,$l,fe,pt),tileBinder:te(Ii,Pe,_e),cullMethod:ue(wn,$e,oo,Ca,Tw),uniformSet:"fontFill",subRenderIndex:2,is3dMapAware:!0},{identify:!0,programName:"labelPointIdentify",vaoCreator:OL,webglState:no,needsVisibilityBuffer:!1,programBinder:dt($t,Ke),objectBinder:Y(Sr,_h,fe,pt),tileBinder:te(Ii,_e),cullMethod:ue(wn,$e,fz),subRenderIndex:1,is3dMapAware:!0}],labelingTexture:[{depthTest:!0,programName:"pointDepthTest",vaoCreator:HL,webglState:L1,needsVisibilityBuffer:!1,programBinder:dt($t,Ke),objectBinder:Y(_h,fe,pt),tileBinder:te(se,_e),cullMethod:ue(wn,$e),is3dMapAware:!0}]},buildingModel:{fill:[{programName:"zbmModel",vaoCreator:ZL,webglState:z1,needsVisibilityBuffer:!1,commonBinder:Se(we,ye,ke),programBinder:GR,layerBinder:fi(qe,Cs,Rs),objectBinder:Y(mt,pm,KR,fe),tileBinder:te(Pe,se,_e),cullMethod:ue(Iw,pe,pz,Fo,Cw),subRenderIndex:2,is3dMapAware:!0},{programName:"zbmModelIdentify",vaoCreator:$L,webglState:zt,needsVisibilityBuffer:!1,programBinder:$t,objectBinder:Y(fe),tileBinder:te(se,_e),cullMethod:pe,subRenderIndex:2,identify:!0,is3dMapAware:!0},{programName:"zbmModelIdentify",vaoCreator:WL,webglState:zt,needsVisibilityBuffer:!1,programBinder:$t,objectBinder:Y(fe),tileBinder:te(se,_e),cullMethod:pe,depthTest:!0,is3dMapAware:!0},{programName:"zbmShadow",vaoCreator:XL,webglState:qd,needsVisibilityBuffer:!1,programBinder:Ke,objectBinder:Y(pm,fe),tileBinder:te(se,_e),cullMethod:pe,shadow:!0,is3dMapAware:!0}],stroke:[{programName:"simpleLine",vaoCreator:D_,webglState:Ta,needsVisibilityBuffer:!0,commonBinder:Se(we,ye,ke),programBinder:Gl,layerBinder:fi($t,qe,Vd),objectBinder:Y(mt,Mi,pm,ph,fe,gm),tileBinder:te(se,Pe,_e),cullMethod:ue(pe,Iw,Wl,Xl,Cw),subRenderIndex:5,is3dMapAware:!0}]},shiftedLine:{solid:[{programName:"road",commonBinder:Se(we,ye,ke),programBinder:dt(ls,sn),vaoCreator:RL,webglState:_i,needsVisibilityBuffer:!1,layerBinder:qe,objectBinder:Y(mt,Mi,rw),tileBinder:te(Pe,se),zoomBinder:zs,cullMethod:ue(pe,Mr,Fo)}]},circle:{fill:[{programName:"circleMarker",vaoCreator:O_,webglState:_i,needsVisibilityBuffer:!1,commonBinder:Se(we,ke,ye),programBinder:fm,layerBinder:qe,objectBinder:Y(mt,Mi),cullMethod:ue(pe,Mr,Fo),tileBinder:te(Ii,Pe),subRenderIndex:2,is3dMapAware:!0},{programName:"circleMarker",vaoCreator:O_,webglState:_i,needsVisibilityBuffer:!1,commonBinder:Se(we,ke,ye),programBinder:fm,layerBinder:qe,objectBinder:Y(mt,Mi),cullMethod:ue(pe,gz,Xl),tileBinder:te(Ii,Pe),subRenderIndex:1,is3dMapAware:!0},{programName:"circleMarker",vaoCreator:O_,webglState:_i,needsVisibilityBuffer:!1,commonBinder:Se(we,ke,ye),programBinder:fm,layerBinder:qe,objectBinder:Y(mt,Mi),cullMethod:ue(pe,vz,Mz),tileBinder:te(Ii,Pe),is3dMapAware:!0},{identify:!0,programName:"circleMarkerIdentify",vaoCreator:qL,webglState:no,needsVisibilityBuffer:!1,programBinder:zR,objectBinder:Y(Mi),cullMethod:ue(pe,yz),tileBinder:te(Ii),is3dMapAware:!0}]},arrow:{stroke:[{programName:"entrance",vaoCreator:g1,webglState:_i,needsVisibilityBuffer:!1,commonBinder:Se(Bl,Ol,we,ye),programBinder:OR,objectBinder:Y(mt,ch,$R,dw,oi),tileBinder:te(se,Pe),cullMethod:ue(pe,Fo)},{identify:!0,programName:"entranceIdentify",vaoCreator:g1,webglState:no,needsVisibilityBuffer:!1,commonBinder:Se(Bl,Ol),programBinder:FR,objectBinder:Y(ch,dw,oi),tileBinder:se,cullMethod:pe}]},lineExtrusion:{fill:[{programName:"gradientDiffuse",vaoCreator:NL,webglState:yC,needsVisibilityBuffer:!0,commonBinder:Se(we,ye,ke),programBinder:jl,layerBinder:fi(qe,Rs),objectBinder:Y(hh,mt,Zl,oi,fe,gh),tileBinder:te(Pe,se,_e),cullMethod:ue(pe,$e,Mm,Ew),subRenderIndex:9,is3dMapAware:!0},{programName:"buildingShadow",shadow:!0,vaoCreator:UL,webglState:Kd,needsVisibilityBuffer:!0,programBinder:Ke,objectBinder:Y(hh,fe,gh),tileBinder:te(se,_e),cullMethod:ue(pe,$e),is3dMapAware:!0}],sideStroke:[{programName:"line",vaoCreator:m1,webglState:Ta,needsVisibilityBuffer:!0,commonBinder:Se(we,ke,ye),programBinder:tw,layerBinder:qe,objectBinder:Y(hh,mt,Zl,oi,fe,gh),tileBinder:te(Pe,se,_e),cullMethod:ue(pe,$e,zw,Aw),subRenderIndex:10,is3dMapAware:!0}],topStroke:[{programName:"simpleLine",vaoCreator:D_,webglState:Ta,needsVisibilityBuffer:!0,commonBinder:Se(we,ye,ke),programBinder:Gl,layerBinder:fi(qe,$t,Vd),objectBinder:Y(hh,mt,Mi,ph,fe,gh,gm),tileBinder:te(Pe,se,_e),cullMethod:ue(pe,$e,Wl,Xl),subRenderIndex:11,is3dMapAware:!0}]},gltfModel:{instances:[{programName:"gltfModel",vaoCreator:Xd(!1),instanceBinder:wh,commonBinder:Se(we,ye,ke),programBinder:BR,layerBinder:fi(qe,Rs,Hd),webglState:z1,needsVisibilityBuffer:!1,objectBinder:Y(mt,QR,ym,JR,fe,dh,pt),tileBinder:te(Ii,Mh,gF,_e,Sh),cullMethod:ue(Im,Az),is3dMapAware:!0},{identify:!0,programName:"gltfModelIdentify",instanceBinder:wh,vaoCreator:Xd(!1),webglState:zt,needsVisibilityBuffer:!1,layerBinder:Hd,commonBinder:Nl(we,ye),programBinder:Ke,objectBinder:Y(fe,dh,Fs,pt),tileBinder:te(Ii,Mh,_e,Sh),cullMethod:Im,is3dMapAware:!0},{depthTest:!0,programName:"gltfModelIdentify",instanceBinder:wh,vaoCreator:Xd(!0),webglState:zt,needsVisibilityBuffer:!1,commonBinder:Nl(we,ye),programBinder:Ke,layerBinder:Hd,objectBinder:Y(fe,dh,pt),tileBinder:te(Ii,Mh,_e,Sh),cullMethod:Im,is3dMapAware:!0},{shadow:!0,programName:"gltfModelShadow",instanceBinder:wh,vaoCreator:Xd(!1),webglState:qd,needsVisibilityBuffer:!1,programBinder:Ke,layerBinder:Hd,objectBinder:Y(fe,dh),tileBinder:te(Ii,Mh,_e,Sh),cullMethod:Ez,is3dMapAware:!0}]},raster:{fill:[{programName:"rectWithTexture",vaoCreator:KL,webglState:_i,needsVisibilityBuffer:!1,commonBinder:Nl(we,ye),layerBinder:Cs,objectBinder:Y(aw,XR),tileBinder:te(se,Pe),cullMethod:ue(gw,pe)}]},heatmap:{framebuffer:[{programName:"heatmap",vaoCreator:JL,webglState:F1,needsVisibilityBuffer:!1,commonBinder:Q0,objectBinder:Y(ez,tz),zoomBinder:zs,tileBinder:te(se,Pe),cullMethod:ue(pe,wz)}],fill:[{programName:"heatmapTexture",vaoCreator:QL,webglState:_i,needsVisibilityBuffer:!1,layerBinder:Cs,objectBinder:Y(aw,qR,YR),tileBinder:Pe,cullMethod:ue(pe,gw,lz),subRenderIndex:1}]},dem:{mesh:[{programName:"demMesh",vaoCreator:Ma,commonBinder:Se(we,ye,ke),programBinder:cs,layerBinder:qe,webglState:zt,needsVisibilityBuffer:!1,objectBinder:Y(fe,_w,pw),tileBinder:te(se,Pe,xh,_e),cullMethod:ue(vw,yw),is3dMapAware:!0},{identify:!0,programName:"demMesh",vaoCreator:Ma,programBinder:dt(Ke,q1),webglState:zt,needsVisibilityBuffer:!1,objectBinder:Y(mw,fe),tileBinder:te(se,xh,_e),cullMethod:ww,is3dMapAware:!0}],ground:[{programName:"demGround",vaoCreator:Ma,programBinder:Ke,tileBinder:te(se,Pe,_e),webglState:zt,needsVisibilityBuffer:!1,objectBinder:Y(fe)}],elevation:[{programName:"demElevation",vaoCreator:B_,webglState:bC,needsVisibilityBuffer:!1,tileBinder:se,objectBinder:Y()}],mesh2:[{programName:"demMesh2",vaoCreator:B_,commonBinder:Se(we,ye,ke),programBinder:cs,layerBinder:qe,webglState:zt,needsVisibilityBuffer:!1,objectBinder:Y(_w,pw,fe,nz),tileBinder:te(se,Pe,xh,_e),cullMethod:ue(vw,yw)},{identify:!0,programName:"demMesh2",vaoCreator:B_,programBinder:dt(Ke,q1),webglState:zt,needsVisibilityBuffer:!1,objectBinder:Y(mw,fe),tileBinder:te(se,xh,_e),cullMethod:ww}],ground2:[{programName:"demGround2",vaoCreator:Ma,programBinder:Ke,tileBinder:te(se,Pe,_e),webglState:zt,needsVisibilityBuffer:!1,objectBinder:Y(fe)}],hillshade:[{programName:"demHillshade",vaoCreator:k_,webglState:no,needsVisibilityBuffer:!1,programBinder:Ke,objectBinder:Y(fe),tileBinder:te(se,_e)}],flatBottom:[{programName:"demFlatBottom",vaoCreator:eC,webglState:P1,needsVisibilityBuffer:!1,objectBinder:Y(sz,fe),tileBinder:te(se,_e),cullMethod:cz}]},mapMesh:{fill:[{programName:"mapMesh",vaoCreator:N_,webglState:C1,zoomBinder:Y(vm),commonBinder:Se(we,ye,ke),programBinder:cs,layerBinder:fi(qe,Rs),objectBinder:Y(ym,yn,fe,ds,Fs),tileBinder:te(Pe,se,_e),cullMethod:bm,subRenderIndex:Number.MAX_SAFE_INTEGER,is3dMapAware:!0},{identify:!0,programName:"mapMesh",vaoCreator:N_,webglState:zt,zoomBinder:Y(vm),commonBinder:Se(we,ye,ke),programBinder:cs,layerBinder:fi(qe,Rs),objectBinder:Y(ym,yn,fe,ds,Fs),tileBinder:te(se,_e),cullMethod:bm,subRenderIndex:Number.MAX_SAFE_INTEGER,is3dMapAware:!0},{depthTest:!0,programName:"mapMesh",vaoCreator:N_,webglState:zt,zoomBinder:Y(vm),commonBinder:Se(we,ye,ke),programBinder:cs,layerBinder:fi(qe,Rs),objectBinder:Y(yn,fe,ds,Fs),tileBinder:te(se,_e),subRenderIndex:Number.MAX_SAFE_INTEGER,is3dMapAware:!0},{programName:"meshShadow",shadow:!0,vaoCreator:h1,webglState:Kd,needsVisibilityBuffer:!1,programBinder:Ke,objectBinder:Y(yn,fe,ds),tileBinder:te(se,_e),is3dMapAware:!0}]},globe:{fill:[{programName:"globe",vaoCreator:w1,webglState:zt,objectBinder:Y(hw),tileBinder:Ii,needsVisibilityBuffer:!1,is3dMapAware:!0},{identify:!0,programName:"globe",vaoCreator:w1,webglState:zt,objectBinder:Y(hw),tileBinder:Ii,needsVisibilityBuffer:!1,is3dMapAware:!0}]}}}class wF{constructor(e){this.gl=e,this.ext=e.getExtension("EXT_disjoint_timer_query"),this.queries=[]}addTimer(){if(!this.ext)return;const e=this.ext.createQueryEXT();this.queries.push(e),this.ext.beginQueryEXT(this.ext.TIME_ELAPSED_EXT,e)}stopTimer(){!this.ext||!this.queries.length||this.ext.endQueryEXT(this.ext.TIME_ELAPSED_EXT)}tryToGetFirstTimerValue(){if(!this.ext)return;const e=this.queries[0];if(!e)return;const i=this.ext,n=i.getQueryObjectEXT(e,i.QUERY_RESULT_AVAILABLE_EXT),s=this.gl.getParameter(i.GPU_DISJOINT_EXT);if(!n||s)return;const o=i.getQueryObjectEXT(e,i.QUERY_RESULT_EXT);return i.deleteQueryEXT(e),this.queries.shift(),Number(o)}}const bF=`
float affine_step(const float edge0, const float edge1, const float x)
{
    return clamp((x - edge0) / (edge1 - edge0), 0., 1.);
}
`,Ww=`
vec4 apply_opacity(const vec4 color, const float opacity)
{
return color * opacity;
}
`,xF=`struct ArrowDistanceParameters
{
    vec2 wing_normal;
    vec2 tip_normal;
    vec2 mirrored_wing_normal;
    vec2 mirrored_tip_normal;
    float width;
    float full_length;
    float arrow_height;
    float tip_radius;
    vec2 tip_circle_center;
    float wing_radius;
    vec2 wing_circle_center;
    float border_width;
};
ArrowDistanceParameters calculate_arrow_distance_parameters(
    const vec2 wing_normal,
    const vec2 tip_normal,
    const float width_zpt,
    const float length_zpt,
    const float tip_height_multiplier,
    const float wing_height_multiplier,
    const float tip_radius_zpt,
    const float wing_radius_zpt,
    const float border_width_zpt,
    const vec2 tip_circle_center,
    const vec2 wing_circle_center)
{
    vec2 mirrored_wing_normal = vec2(wing_normal.x, -wing_normal.y);
    vec2 mirrored_tip_normal = vec2(tip_normal.x, -tip_normal.y);
    float width = 0.5 * width_zpt;
    float length = 0.5 * length_zpt;
    float arrow_height = width_zpt * (tip_height_multiplier - wing_height_multiplier);
    return ArrowDistanceParameters(
        wing_normal,
        tip_normal,
        mirrored_wing_normal,
        mirrored_tip_normal,
        width,
        length,
        arrow_height,
        tip_radius_zpt,
        tip_circle_center,
        wing_radius_zpt,
        wing_circle_center,
        border_width_zpt);
}
struct ArrowDistances
{
    float top_tip_cut;
    float bottom_tip_cut;
    float line;
    float bottom_left_wing;
    float bottom_right_wing;
    float top_left_wing;
    float top_right_wing;
    float tip_circle;
    float tip_circle_cut;
    float left_wing_circle;
    float left_wing_circle_cut;
    float right_wing_circle;
    float right_wing_circle_cut;
};
ArrowDistances calculate_arrow_distances(
    const ArrowDistanceParameters arrow_parameters,
    const vec2 texcoord,
    const float offset,
    const mat2 derivatives)
{
    float derivatives_x_multiplier = 1. / max(abs(derivatives[0].x), abs(derivatives[1].x));
    float dt = ( texcoord.x - arrow_parameters.full_length - offset) * derivatives_x_multiplier;
    float d0 = (-texcoord.x - arrow_parameters.full_length - offset) * derivatives_x_multiplier;
    float d1 = (abs(texcoord.y) - arrow_parameters.width - offset) / max(abs(derivatives[0].y), abs(derivatives[1].y));
    float d2 = (dot(texcoord - vec2(arrow_parameters.full_length - arrow_parameters.arrow_height, 0.), arrow_parameters.wing_normal) - offset) / max(abs(dot(derivatives[0], arrow_parameters.wing_normal)), abs(dot(derivatives[1], arrow_parameters.wing_normal)));
    float d3 = (dot(texcoord - vec2(arrow_parameters.full_length - arrow_parameters.arrow_height, 0.), arrow_parameters.mirrored_wing_normal) - offset) / max(abs(dot(derivatives[0], arrow_parameters.mirrored_wing_normal)), abs(dot(derivatives[1], arrow_parameters.mirrored_wing_normal)));
    float d4 = (dot(texcoord - vec2(arrow_parameters.full_length, 0.), arrow_parameters.tip_normal) - offset) / max(abs(dot(derivatives[0], arrow_parameters.tip_normal)), abs(dot(derivatives[1], arrow_parameters.tip_normal)));
    float d5 = (dot(texcoord - vec2(arrow_parameters.full_length, 0.), arrow_parameters.mirrored_tip_normal) - offset) / max(abs(dot(derivatives[0], arrow_parameters.mirrored_tip_normal)), abs(dot(derivatives[1], arrow_parameters.mirrored_tip_normal)));
    
    float tip_circle_cut = sdf_half_planes_cut(
        texcoord,
        arrow_parameters.tip_normal,
        -arrow_parameters.mirrored_tip_normal,
        arrow_parameters.tip_circle_center,
        derivatives);
    float tip_circle = sdf_circle(
        texcoord - arrow_parameters.tip_circle_center,
        arrow_parameters.tip_radius + offset - arrow_parameters.border_width);
    vec2 tip_circle_normal = normalize(texcoord - arrow_parameters.tip_circle_center);
    tip_circle = tip_circle / max(abs(dot(derivatives[0], tip_circle_normal)), abs(dot(derivatives[1], tip_circle_normal)));
    
    vec2 right_wing_circle_center = vec2(arrow_parameters.wing_circle_center.x, -arrow_parameters.wing_circle_center.y);
    vec2 left_wing_circle_normal = normalize(texcoord - arrow_parameters.wing_circle_center);
    vec2 right_wing_circle_normal = normalize(texcoord - right_wing_circle_center);
    float left_wing_circle = sdf_circle(texcoord - arrow_parameters.wing_circle_center,
        arrow_parameters.wing_radius + offset - arrow_parameters.border_width);
        left_wing_circle = left_wing_circle / max(abs(dot(derivatives[0], left_wing_circle_normal)), abs(dot(derivatives[1], left_wing_circle_normal)));
    float right_wing_circle = sdf_circle(texcoord - right_wing_circle_center,
        arrow_parameters.wing_radius + offset - arrow_parameters.border_width);
        right_wing_circle = right_wing_circle / max(abs(dot(derivatives[0], right_wing_circle_normal)), abs(dot(derivatives[1], right_wing_circle_normal)));
    float left_wing_circle_cut = sdf_half_planes_cut(
        texcoord,
        -arrow_parameters.tip_normal,
        arrow_parameters.wing_normal,
        arrow_parameters.wing_circle_center,
        derivatives);
    float right_wing_circle_cut = sdf_half_planes_cut(
        texcoord,
        arrow_parameters.mirrored_tip_normal,
        -arrow_parameters.mirrored_wing_normal,
        right_wing_circle_center,
        derivatives);
    return ArrowDistances(
        dt,
        d0,
        d1,
        d2,
        d3,
        d4,
        d5,
        tip_circle,
        tip_circle_cut,
        left_wing_circle,
        left_wing_circle_cut,
        right_wing_circle,
        right_wing_circle_cut);
}
`,SF=`
#ifdef WEBGL2
#define UNPACK_BOOL1(packedValue) ((packedValue & 0x1) != 0)
#define UNPACK_BOOL2(packedValue) ((packedValue & 0x2) != 0)
#define UNPACK_BOOL3(packedValue) ((packedValue & 0x4) != 0)
#else
#define UNPACK_BOOL1(packedValue) (int(mod(float(packedValue), 2.0)) == 1)
#define UNPACK_BOOL2(packedValue) (int(mod(float(packedValue) / 2.0, 2.0)) == 1)
#define UNPACK_BOOL3(packedValue) (int(mod(float(packedValue) / 4.0, 2.0)) == 1)
#endif
`,Xw=`#ifndef UBO
uniform highp vec3 u_cam_pos;
#endif
`,MF=`
const float g_distance_precision_limit = 1e-4;
struct CircleDistance
{
    float distance;
    float width;
};
CircleDistance circle_color_distance(
    const mat2 derivatives,
    const vec2 circle,
    const float circle_width)
{
    float circle_length = length(circle);
    float distance = circle_length - circle_width;
    
    
    
    vec2 circle_dx = derivatives[0];
    vec2 circle_dy = derivatives[1];
    
    float distance_dx = dot(circle, circle_dx);
    float distance_dy = dot(circle, circle_dy);
    
    float derivative_denominator = circle_length;
    float width = max(abs(distance_dx), abs(distance_dy));
    return CircleDistance(
        distance * derivative_denominator,
        width);
}
vec4 distance_to_color(
    const float fill_distance,
    const float border_distance,
    const vec4 fill_color,
    const vec4 border_color)
{
    float fill_factor = affine_step(-1., 0., fill_distance);
    float border_factor = affine_step(0., 1., border_distance);
    return
        mix(mix(fill_color, border_color, fill_factor), vec4(.0), border_factor);
}
vec4 distance_to_color(
    const CircleDistance circle_distance,
    const vec4 fill_color)
{
    
    
    float fill_factor = circle_distance.distance < g_distance_precision_limit
        ? 0.
        : affine_step(0., circle_distance.width, circle_distance.distance);
    return mix(fill_color, vec4(0.), fill_factor);
}
`,IF=`#ifdef WEBGL1
#extension GL_OES_standard_derivatives: enable
#endif
`,TF=`
#define LINEAR 0
#define EXP 1
#define FOG_EQUATION (LINEAR)
#define EPSILON (0.0001)
#ifndef UBO
# ifdef FOG
uniform vec4 u_fog_color;
uniform vec2 u_fog_limits;
uniform float u_fog_horizon_blend;
uniform float u_fog_horizon_level;
# endif
#endif 
#if defined(FOG) || defined(SKY)
# ifndef UBO
uniform vec4 u_sky_color;
# endif
varying vec3 v_fog_pos;
#endif
#ifdef FOG
float fog_horizon_blending(vec3 camera_dir, float blend) {
    blend = EPSILON + blend;
    float t = max(camera_dir.z / blend, 0.0);
    
    return exp(-3.0 * t * t);
}
float fog_exponential(float t) {
    const float decay = 6.0;
    float falloff = 1.0 - min(1.0, exp(-decay * t));
    
    falloff *= falloff * falloff;
    
    return min(1.0, 1.00747 * falloff);
}
float fog_depth(float depth) {
    float start = u_fog_limits.x;
    float end = u_fog_limits.y;
    float range = end - start;
    float fac = (depth - start) / range;
#if (FOG_EQUATION == LINEAR)
    
    fac = clamp(fac, 0.0, 1.0);
#elif (FOG_EQUATION == EXP)
    fac = fog_exponential(fac);
#endif
    return fac;
}
float calc_depth_fog() {
    float depth = length(v_fog_pos);
    float fac = fog_depth(depth);
    return fac;
}
vec3 calc_fog_color() {
    float depth = length(v_fog_pos);
    vec3 dir = v_fog_pos / depth;
    
    dir.z -= u_fog_horizon_level;
    float fog_blend = fog_horizon_blending(dir, u_fog_horizon_blend);
    if (u_sky_color.a <= 0.01) {
        return u_fog_color.rgb / u_fog_color.a;
    } else {
        
        return mix(u_sky_color.rgb / u_sky_color.a, u_fog_color.rgb / u_fog_color.a, min(fog_blend + (1.0 - u_sky_color.a), 1.0));
    }
}
#endif 
vec4 apply_fog(vec4 color) {
#ifdef FOG
    if (u_fog_color.a <= 0.01) {
        return color;
    }
    float alpha = EPSILON + color.a;
    float fac = calc_depth_fog();
    vec3 fog_color = calc_fog_color();
    color.rgb /= alpha;
    color.rgb = mix(color.rgb, fog_color, fac * u_fog_color.a);
    color.rgb *= alpha;
#endif
    return color;
}
vec4 apply_fog_alpha(vec4 color) {
#ifdef FOG
    if (u_fog_color.a <= 0.01) {
        return color;
    }
    color *= 1.0 - calc_depth_fog();
#endif
    return color;
}
vec4 apply_fog_sky(vec4 color) {
#ifdef FOG
    float alpha = EPSILON + color.a;
    float depth = length(v_fog_pos);
    vec3 dir = v_fog_pos / depth;
    
    dir.z -= u_fog_horizon_level;
    float fac = fog_horizon_blending(dir, u_fog_horizon_blend);
    color.rgb /= alpha;
    color.rgb = mix(color.rgb, u_fog_color.rgb, fac * u_fog_color.a);
    color.rgb *= alpha;
#endif
    return color;
}`,EF=`#define FRAGMENT_NORMAL
vec3 calc_fragment_normal(vec3 vertex) {
    vec3 dx = dFdx(vertex);
    vec3 dy = dFdy(vertex);
    return normalize(cross(dx, dy));
}`,AF=`precision highp float;
`,PF=`#ifdef UBO
uniform LightSettings
{
    vec3 u_vec3_light_dir1_direction;
    vec4 u_vec4_light_dir1_color;
    vec3 u_vec3_light_dir2_direction;
    vec4 u_vec4_light_dir2_color;
    vec4 u_vec4_ambient_color;
};
#else
uniform vec3 u_vec3_light_dir1_direction;
uniform vec4 u_vec4_light_dir1_color;
uniform vec3 u_vec3_light_dir2_direction;
uniform vec4 u_vec4_light_dir2_color;
uniform vec4 u_vec4_ambient_color;
#endif
uniform int u_int_light_flags;
vec4 light_factor(vec3 normal) {
    bool use_light = UNPACK_BOOL1(u_int_light_flags);
    if (!use_light) { 
        return vec4(1.);
    }
    float light_1_factor = max(dot(normal, -u_vec3_light_dir1_direction), 0.0);
    float light_2_factor = max(dot(normal, -u_vec3_light_dir2_direction), 0.0);
    if (UNPACK_BOOL2(u_int_light_flags)) {
        light_1_factor *= compute_shadow_factor();
    } else if (UNPACK_BOOL3(u_int_light_flags)) {
        light_2_factor *= compute_shadow_factor();
    }
    vec3 direct_light_contrib = u_vec4_light_dir1_color[3] * light_1_factor * u_vec4_light_dir1_color.rgb;
    vec3 shading_light_contrib = u_vec4_light_dir2_color[3] * light_2_factor * u_vec4_light_dir2_color.rgb;
    return vec4(u_vec4_ambient_color[3] * u_vec4_ambient_color.rgb + direct_light_contrib + shading_light_contrib, 1.0);
}
float light_factor_dem(vec3 normal) {
    bool use_light = UNPACK_BOOL1(u_int_light_flags);
    if (!use_light) { 
        return 1.;
    }
    float light_1_factor = dot(normal, -u_vec3_light_dir1_direction);
    
    
    
    
    return light_1_factor;
}
vec4 light_factor(vec3 normal, vec3 pos_world) {
    
    if (dot(u_cam_pos - pos_world, normal) < 0.) {
        normal *= vec3(-1.);
    }
    return light_factor(normal);
}
vec4 light_factor_surface() {
    bool use_light = UNPACK_BOOL1(u_int_light_flags);
    if (!use_light) {
        return vec4(1.);
    }
    vec3 normal = vec3(0., 0., 1.);
    float light_1_factor = max(dot(normal, -u_vec3_light_dir1_direction), 0.0);
    float light_2_factor = max(dot(normal, -u_vec3_light_dir2_direction), 0.0);
    if (UNPACK_BOOL2(u_int_light_flags)) {
        light_1_factor *= compute_shadow_factor();
    } else if (UNPACK_BOOL3(u_int_light_flags)) {
        light_2_factor *= compute_shadow_factor();
    }
     return vec4(u_vec4_ambient_color[3] * u_vec4_ambient_color.rgb
         + u_vec4_light_dir1_color[3] * light_1_factor * u_vec4_light_dir1_color.rgb
         + u_vec4_light_dir2_color[3] * light_2_factor * u_vec4_light_dir2_color.rgb, 1.0);
}
`,LF=`
#define LIGHT_MODEL_PBR 2
#ifdef LIGHT_MODEL
#if LIGHT_MODEL == LIGHT_MODEL_PBR
    const float PI = 3.14159265359;
    
    float D(float alpha, vec3 N, vec3 H) {
        float numerator = alpha * alpha;
        float NdotH = max(dot(N, H), 0.);
        float denominator = PI * pow(
            NdotH * NdotH * (alpha * alpha - 1.) + 1.,
            2.
        );
        return numerator / max(denominator, 0.000001);
    }
    
    float G1(float alpha, vec3 N, vec3 X) {
        float numerator = max(dot(N, X), 0.);
        float k = alpha / 2.;
        float denominator = max(dot(N, X), 0.) * (1. - k) + k;
        return numerator / max(denominator, 0.000001);
    }
    
    float G(float alpha, vec3 N, vec3 V, vec3 L) {
        return G1(alpha, N, V) * G1(alpha, N, L);
    }
    
    vec3 F(vec3 F0, vec3 V, vec3 H) {
        return F0 + (vec3(1.) - F0) * pow(1. - max(dot(V, H), 0.), 5.);
    }
    vec3 color_pbr(vec3 fragment_normal, vec3 fragment_pos_world, vec3 albedo, float roughness, float metallic) {
        float alpha = roughness * roughness;
        vec3 F0 = vec3(0.04);
        F0 = mix(F0, vec3(1.), metallic);
        
        vec3 emitted_light = u_vec4_ambient_color.rgb * u_vec4_ambient_color[3];
        vec3 N = fragment_normal;
        
        vec3 V = normalize(u_cam_pos - fragment_pos_world);
        
        vec3 L = -u_vec3_light_dir1_direction;
        
        vec3 H = normalize(V + L);
        float shadow_factor = compute_shadow_factor();
        vec3 Ks = F(F0, V, H);
        vec3 Kd = (vec3(1.0) - Ks) * (1. - metallic);
        vec3 lambert = albedo / PI;
        vec3 cookTorranceNumerator = D(alpha, N, H) * G(alpha, N, V, L) * Ks;
        float cookTorranceDenominator = 4.0 * max(dot(V, N), 0.) * max(dot(L, N), 0.);
        cookTorranceDenominator = max(cookTorranceDenominator, 0.000001);
        vec3 cookTorrance = cookTorranceNumerator / cookTorranceDenominator;
        vec3 BRDF = Kd * lambert + cookTorrance;
        vec3 outgoingLight = BRDF * u_vec4_light_dir1_color.rgb * u_vec4_light_dir1_color[3] * max(dot(L, N), 0.);
        vec3 ambient = u_vec4_ambient_color.rgb * u_vec4_ambient_color[3] * albedo;
        return ambient + outgoingLight * shadow_factor;
    }
#endif
#endif
`,CF=`#define LIGHT_MODEL_PHONG 1
#ifdef LIGHT_MODEL
#if LIGHT_MODEL == LIGHT_MODEL_PHONG
const float g_specular_power_max = 32.0;
const float g_specular_power_min = 2.0;
vec2 pbr_to_gloss(vec3 material_attributes)
{
    float weight = material_attributes.x;
    float roughness = material_attributes.y;
    float metallic = material_attributes.z;
    
    
    float specular_strength = weight * metallic;
    float specular_power = roughness * (g_specular_power_min - g_specular_power_max) + g_specular_power_max;
    return vec2(specular_strength, specular_power);
}
vec3 color_phong(vec3 fragment_normal, vec3 fragment_pos_world, vec3 albedo, float roughness, float metallic) {
    vec2 specular_values = pbr_to_gloss(vec3(1., roughness, metallic));
    float specular_strength = specular_values.x;
    float specular_power = specular_values.y;
    
    float shadow_factor = compute_shadow_factor();
    
    vec3 ambient = u_vec4_ambient_color.rgb * u_vec4_ambient_color[3];
    
    float diff = max(dot(fragment_normal, -u_vec3_light_dir1_direction), 0.0);
    vec3 diffuse = u_vec4_light_dir1_color.rgb * u_vec4_light_dir1_color[3] * diff * shadow_factor;
    
    
    vec3 view_dir = normalize(u_cam_pos - fragment_pos_world);
    
    vec3 reflect_dir = reflect(u_vec3_light_dir1_direction, fragment_normal);
    float spec = pow(max(dot(view_dir, reflect_dir), 0.0), specular_power);
    vec3 specular = u_vec4_light_dir1_color.rgb * u_vec4_light_dir1_color[3] * spec * specular_strength;
    return albedo * (ambient + diffuse) + specular;
}
#endif
#endif
`,RF=`precision lowp float;
`,zF=`precision mediump float;
`,FF=`vec4 pack_float_to_vec4(float depth)
{
    const vec4 bit_shift = vec4(255.0 * 255.0 * 255.0, 255.0 * 255.0, 255.0, 1.0);
    const vec4 bit_mask = vec4(0.0, 1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0);
    vec4 res = fract(depth * bit_shift);
    res -= res.xxyz * bit_mask;
    return res;
}
float unpack_float_from_vec4(vec4 color)
{
    const vec4 bit_shift = vec4(1.0 / (255.0 * 255.0 * 255.0), 1.0 / (255.0 * 255.0), 1.0 / 255.0, 1.0);
    return dot(color, bit_shift);
}`,DF=`#ifdef WEBGL2
#define varying in
#define attribute in
#define texture2D texture
#define gl_FragColor fragColor
out vec4 gl_FragColor;
#endif
#ifdef UBO
uniform CommonSettings
{
    mediump float u_float_rounding_factor;
    mediump float u_float_border_width_offset;
    mediump vec2 u_vec2_scale_limits;
    mediump vec2 u_vec2_depth_test_half_point_size;
    
    mediump vec4 u_fog_color;
    mediump vec2 u_fog_limits;
    mediump float u_fog_horizon_blend;
    mediump float u_fog_horizon_level;
    mediump float u_fog_distance;
    mediump vec4 u_sky_color;
    highp vec3 u_cam_pos; 
    
    
    
    
    
    
    mediump vec4 u_shadow_map_params; 
    highp mat4 u_mat4_clip_to_shadow;
    mediump float u_shadow_bias;
    mediump mat4 u_mat4_view_transposed;
    mediump mat4 u_mat4_proj_inverted;
    
    mediump vec2 u_vec2_halo_viewport_size;
    mediump vec2 u_vec2_halo_viewport_center_shift;
    mediump vec4 u_vec4_halo_radius_stops;
    mediump vec4 u_vec4_halo_color;
    mediump float u_float_halo_exp_factor;
    mediump vec4 u_vec4_default_background_color;
    
    mediump mat4 u_mat4_stars;
    mediump float u_float_pixelratio;
    mediump float u_float_stars_intensity;
};
#endif
`,OF=`#ifdef WEBGL1
#extension GL_EXT_frag_depth : require
#endif`,BF=`uniform float u_sdtr_distance;
#ifdef SCREENDOOR
varying vec3 v_clipspace_pos;
#endif
float interleaved_gradient_noise()
{
    const vec3 m = vec3(0.06711056, 0.00583715, 52.9829189);
    return fract(m.z * fract(dot(gl_FragCoord.xy, m.xy)));
}
void apply_screendoor() {
    #ifdef SCREENDOOR
    if (u_sdtr_distance == 0.) {
        return;
    }
    float factor = smoothstep(0., u_sdtr_distance, v_clipspace_pos.z);
    float patternValue = interleaved_gradient_noise();
    float shaped = factor - patternValue;
    if (shaped <= 0.) {
        discard;
    }
    #endif
    return;
}
`,kF=`#ifdef RENDER_SHADOWS
# if defined(WEBGL2) && defined(DEPTH_TEXTURE_SHADOW)
uniform mediump sampler2DShadow u_texture_shadow;
# else
uniform sampler2D u_texture_shadow;
# endif
# ifndef UBO
uniform mediump vec4 u_shadow_map_params;
# endif 
varying float v_depth_metric;
varying vec4 v_pos_from_light;
float get_shadow(vec3 coords) {
# if defined(WEBGL2) && defined(DEPTH_TEXTURE_SHADOW)
    
    return texture2D( u_texture_shadow, coords );
# else
# ifdef DEPTH_TEXTURE_SHADOW
    
    float shadow_depth = texture2D(u_texture_shadow, coords.xy, 0.).r;
# else
    
    
    float shadow_depth = unpack_float_from_vec4(texture2D(u_texture_shadow, coords.xy, 0.));
# endif
    float depth_diff = v_depth_metric - shadow_depth;
    if (depth_diff <= 0.) {
        return 1.0;
    }
    return 0.0;
# endif
}
float sample_shadow_texture(vec3 shadow_coord) {
    vec2 shadow_map_size = u_shadow_map_params.xy;
    float radius = u_shadow_map_params.z;
    vec2 texelSize = vec2( 1.0 ) / shadow_map_size;
    float dx0 = - texelSize.x * radius;
    float dy0 = - texelSize.y * radius;
    float dx1 = + texelSize.x * radius;
    float dy1 = + texelSize.y * radius;
    float dx2 = dx0 / 2.0;
    float dy2 = dy0 / 2.0;
    float dx3 = dx1 / 2.0;
    float dy3 = dy1 / 2.0;
    
    
    return (
        get_shadow( shadow_coord + vec3( dx0, dy0, 0.0 ) ) +
        get_shadow( shadow_coord + vec3( 0.0, dy0, 0.0 ) ) +
        get_shadow( shadow_coord + vec3( dx1, dy0, 0.0 ) ) +
        get_shadow( shadow_coord + vec3( dx2, dy2, 0.0 ) ) +
        get_shadow( shadow_coord + vec3( 0.0, dy2, 0.0 ) ) +
        get_shadow( shadow_coord + vec3( dx3, dy2, 0.0 ) ) +
        get_shadow( shadow_coord + vec3( dx0, 0.0, 0.0 ) ) +
        get_shadow( shadow_coord + vec3( dx2, 0.0, 0.0 ) ) +
        get_shadow( shadow_coord) +
        get_shadow( shadow_coord + vec3( dx3, 0.0, 0.0 ) ) +
        get_shadow( shadow_coord + vec3( dx1, 0.0, 0.0 ) ) +
        get_shadow( shadow_coord + vec3( dx2, dy3, 0.0 ) ) +
        get_shadow( shadow_coord + vec3( 0.0, dy3, 0.0 ) ) +
        get_shadow( shadow_coord + vec3( dx3, dy3, 0.0 ) ) +
        get_shadow( shadow_coord + vec3( dx0, dy1, 0.0 ) ) +
        get_shadow( shadow_coord + vec3( 0.0, dy1, 0.0 ) ) +
        get_shadow( shadow_coord + vec3( dx1, dy1, 0.0 ) )
    ) * ( 1.0 / 17.0 );
}
float compute_shadow_factor()
{
    vec4 light_pos = v_pos_from_light;
# ifdef FRAGMENT_NORMAL
    
    
    float normal_bias = u_shadow_map_params[3];
    vec3 norm_from_light = calc_fragment_normal(light_pos.xyz);
    light_pos.xyz -= normal_bias * norm_from_light;
# endif
    vec3 clip_space = light_pos.xyz / light_pos.w;
    
    float clip_factor = smoothstep(0.5, 1.0, length(clip_space));
    if (clip_factor >= 1.0) {
        return 1.0;
    }
# if defined(DEPTH_TEXTURE_SHADOW) && defined(WEBGL2)
    vec3 lightPovPositionInTexture = 0.5 * light_pos.xyz + 0.5;
    float shadow_factor = sample_shadow_texture(lightPovPositionInTexture);
# else
    vec3 uv = 0.5 * clip_space + vec3(0.5);
    float shadow_factor = sample_shadow_texture(uv);
# endif
    
    shadow_factor = mix(shadow_factor, 1.0, clip_factor);
    return shadow_factor;
}
#else  
float compute_shadow_factor()
{
    return 1.0;
}
#endif `,Yw=`#ifndef SIGNED_DISTANCE_FUNCTIONS_FSH
#define SIGNED_DISTANCE_FUNCTIONS_FSH
float sdf_intersect(const float distance1, const float distance2)
{
    return max(distance1, distance2);
}
float sdf_merge(const float distance1, const float distance2)
{
    return min(distance1, distance2);
}
float sdf_difference(const float distance1, const float distance2)
{
    return max(distance1, -distance2);
}
float sdf_half_plane(const vec2 coords, const vec2 normal)
{
    return dot(coords, normal);
}
float sdf_circle(const vec2 coords, const float radius)
{
    return length(coords) - radius;
}
float sdf_half_planes_cut(const vec2 coords, const vec2 normal1, const vec2 normal2, const vec2 cut_point, const mat2 derivatives)
{
    vec2 cut_normal1 = vec2(normal1.y, -normal1.x);
    float cut1 = sdf_half_plane(coords - cut_point, cut_normal1) /
        max(abs(dot(derivatives[0], cut_normal1)), abs(dot(derivatives[1], cut_normal1)));
    vec2 cut_normal2 = vec2(normal2.y, -normal2.x);
    float cut2 = sdf_half_plane(coords - cut_point, cut_normal2) /
        max(abs(dot(derivatives[0], cut_normal2)), abs(dot(derivatives[1], cut_normal2)));
    return sdf_merge(cut1, cut2);
}
float sdf_box( in vec2 p, in vec2 b )
{
    vec2 d = abs(p)-b;
    return length(max(d,0.0)) + min(max(d.x,d.y),0.0);
}
float sdf_triangle(in vec2 p, in float width) {
    return abs(p.x) - (p.y + .5) * width * .5;
}
float dot2(in vec2 p) {
    return dot(p, p);
}
float sdf_chevron(in vec2 p, float width, float skew, float rounding)
{
    p.x = abs(p.x);
    if (p.y + p.x > 1.0) {
        return sqrt(dot2(p - vec2(0.25, 0.75))) - sqrt(2.0)/4.0;
    }
    return sqrt(min(dot2(p - vec2(0.00, 1.00)),
                    dot2(p - 0.5 * max(p.x + p.y, 0.0)))) * sign(p.x - p.y);
}
#endif
`,NF=`#ifdef TAA
uniform float u_float_mix_coef;
vec4 taa(sampler2D tex, vec2 texcoord) {
    vec4 texColor = texture2D(tex, texcoord);
    return vec4(texColor.rgb, texColor.a * u_float_mix_coef);
}
#endif`,UF=`#include <mediump_float>
#include <prelude>
#include <taa>
uniform sampler2D u_texture;
varying vec2 v_vec2_texcoord;
void main()
{
#ifdef TAA
    vec4 color = taa(u_texture, v_vec2_texcoord);
#else 
    vec4 color = texture2D(u_texture, v_vec2_texcoord);
#endif
    gl_FragColor = color;
}
`,GF=`#include <enable_standard_derivatives>
#include <highp_float>
#include <prelude>
#include <affine_step>
#include <signed_distance_functions>
#include <arrow_functions>
#include <circle_functions>
#include <fog>
uniform float u_float_tip_height_multiplier;
uniform float u_float_wing_height_multiplier;
uniform float u_float_wing_width_multiplier;
varying vec2 v_vec2_line_type_arrow_tail;
varying vec4 v_vec4_arrow_width_length_border_outer;
varying vec4 v_vec4_texcoord_arrow_line;
varying vec4 v_vec4_distance_vertex_hiding;
#ifdef ENTRANCE_ARROWS_ROUNDING
varying vec3 v_vec3_radius_tip_wing_tail;
#endif
varying vec4 v_vec4_circle_center_tip_wing;
varying vec4 v_vec4_color;
varying vec4 v_vec4_border_color;
const float g_type_arrow = 1.;
const float g_type_start_border = 2.;
bool lookalike(const float a, const float b)
{
    return abs(a - b) < 1e-4;
}
float filter_border(const float start, const float value)
{
    return step(start, value) * 2. - 1.;
}
float arrow_distance(
    const ArrowDistanceParameters arrow_parameters,
    const vec2 texcoord,
    const float offset,
    const mat2 derivatives,
    const float line_distance,
    const float line_distance_no_offset,
    
    
    const float border_width,
    const vec2 wing_normal)
{
    ArrowDistances ad = calculate_arrow_distances(arrow_parameters, texcoord, offset, derivatives);
    float derivatives_x_multiplier = 1. / max(abs(derivatives[0].x), abs(derivatives[1].x));
    
    
    float intersection_point = arrow_parameters.full_length - arrow_parameters.arrow_height
        - arrow_parameters.width * wing_normal.y / wing_normal.x;
    float tail_arrow_intersection = filter_border(-1., (texcoord.x - intersection_point) * derivatives_x_multiplier);
    
    float top_wings;
    float bottom_wings;
    #ifdef ENTRANCE_ARROWS_ROUNDING
    top_wings = sdf_intersect(sdf_intersect(ad.top_left_wing, ad.top_right_wing), ad.tip_circle_cut);
    top_wings = sdf_merge(top_wings, ad.tip_circle);
    top_wings = sdf_intersect(top_wings, ad.top_tip_cut);
    float wings_circles = sdf_merge(ad.left_wing_circle, ad.right_wing_circle);
    float wings_radius_cut = sdf_intersect(ad.left_wing_circle_cut, ad.right_wing_circle_cut);
    bottom_wings = sdf_merge(ad.bottom_left_wing, ad.bottom_right_wing);
    bottom_wings = sdf_intersect(bottom_wings, wings_radius_cut);
    bottom_wings = sdf_merge(bottom_wings, wings_circles);
    #else
    top_wings = sdf_intersect(ad.top_left_wing, ad.top_right_wing);
    bottom_wings = sdf_merge(ad.bottom_left_wing, ad.bottom_right_wing);
    #endif
    float line_without_offset = filter_border(0., line_distance_no_offset);
    float bottom_wings_with_tail = sdf_merge(bottom_wings, line_without_offset);
    float wings_with_tail = sdf_intersect(bottom_wings_with_tail, top_wings);
    
    float tail_hide_part = v_vec2_line_type_arrow_tail.y;
    float tail_hide_mask = (-texcoord.x - tail_hide_part) * derivatives_x_multiplier;
    float clipped_tail = sdf_intersect(tail_hide_mask, sdf_intersect(line_distance, top_wings));
    return (v_vec4_distance_vertex_hiding.x < v_vec4_distance_vertex_hiding.y)
        ? sdf_intersect(-sdf_intersect(tail_arrow_intersection, line_without_offset), wings_with_tail)
        : sdf_merge(clipped_tail, sdf_intersect(-sdf_intersect(tail_arrow_intersection, line_without_offset), wings_with_tail));
}
vec4 distance_to_arrow_line_color(
    const float fill_distance,
    const float border_distance)
{
    return distance_to_color(fill_distance, border_distance, v_vec4_color, v_vec4_border_color);
}
vec4 arrow_color(
    const vec2 texcoord,
    const ArrowDistanceParameters arrow_parameters,
    const float line_fill_distance,
    const float line_border_distance,
    const vec2 wing_normal)
{
    mat2 derivatives = mat2(dFdx(texcoord), dFdy(texcoord));
    
    float border_clipping = (abs(texcoord.y) - v_vec4_arrow_width_length_border_outer.w) / max(abs(derivatives[0].y), abs(derivatives[1].y));
    float border_width = v_vec4_arrow_width_length_border_outer.z;
    float arrow_border_distance = arrow_distance(
        arrow_parameters,
        texcoord,
        v_vec4_arrow_width_length_border_outer.z,
        derivatives,
        line_border_distance,
        line_fill_distance,
        border_width,
        wing_normal);
    float border_factor = max(border_clipping, affine_step(0., 1., arrow_border_distance));
    return distance_to_arrow_line_color(
        arrow_distance(arrow_parameters, texcoord, 0., derivatives, line_fill_distance, line_fill_distance, border_width, wing_normal),
        border_factor);
}
float line_start_distance(
    const vec2 texcoord,
    const float offset,
    const mat2 derivatives,
    const float line_distance,
    const float half_width,
    const float border_width,
    const float tail_radius)
{
    float derivatives_x_multiplier = 1. / max(abs(derivatives[0].x), abs(derivatives[1].x));
    
    float tail_hide_part = v_vec2_line_type_arrow_tail.y;
    float d0 = (-texcoord.x - offset) * derivatives_x_multiplier;
    float dh = (texcoord.x - tail_hide_part) * derivatives_x_multiplier;
    float rect = max(d0, max(line_distance, dh));
    
    float radius_offset = tail_radius - border_width;
    float circle_radius = radius_offset + offset;
    vec2 left_circle_center = vec2(radius_offset, half_width - radius_offset);
    vec2 right_circle_center = vec2(radius_offset, -half_width + radius_offset);
    vec2 left_circle_normal = normalize(texcoord - left_circle_center);
    vec2 right_circle_normal = normalize(texcoord - right_circle_center);
    float cut_x = (-texcoord.x + radius_offset) * derivatives_x_multiplier;
    float cut_y = (abs(texcoord.y) - half_width + radius_offset) / max(abs(derivatives[0].y), abs(derivatives[1].y));
    float circles_cut = min(cut_x, cut_y);
    float left_circle = length(texcoord - left_circle_center) - circle_radius;
    left_circle = left_circle / max(abs(dot(derivatives[0], left_circle_normal)), abs(dot(derivatives[1], left_circle_normal)));
    float right_circle = length(texcoord - right_circle_center) - circle_radius;
    right_circle = right_circle / max(abs(dot(derivatives[0], right_circle_normal)), abs(dot(derivatives[1], right_circle_normal)));
    float circles = min(left_circle, right_circle);
    rect = min(max(rect, circles_cut), circles);
    return rect;
}
vec4 line_color(
    const float line_fill_distance,
    const float line_border_distance,
    const float line_half_width,
    const float border_width,
    const float tail_radius)
{
    float type = v_vec2_line_type_arrow_tail.x;
    float fill_distance = line_fill_distance;
    float border_distance = line_border_distance;
    if (lookalike(type, g_type_start_border))
    {
        vec2 texcoord = v_vec4_texcoord_arrow_line.xy;
        mat2 derivatives = mat2(dFdx(texcoord), dFdy(texcoord));
        fill_distance = line_start_distance(
            texcoord, 0.,
            derivatives,
            line_fill_distance,
            line_half_width,
            border_width,
            tail_radius);
        border_distance = line_start_distance(
            texcoord,
            v_vec4_arrow_width_length_border_outer.z,
            derivatives,
            line_border_distance,
            line_half_width,
            border_width,
            tail_radius);
    }
    return distance_to_arrow_line_color(fill_distance, border_distance);
}
vec4 arrow_line_color()
{
    if (lookalike(min(v_vec4_distance_vertex_hiding.y, 1.), 1.)
        || lookalike(v_vec4_distance_vertex_hiding.w, 1.)
        || !lookalike(v_vec2_line_type_arrow_tail.x, g_type_arrow) && (v_vec4_distance_vertex_hiding.x < v_vec4_distance_vertex_hiding.y || v_vec4_distance_vertex_hiding.x > v_vec4_distance_vertex_hiding.z))
    {
        discard;
    }
    vec2 wing_normal = -normalize(vec2(u_float_wing_width_multiplier, u_float_wing_height_multiplier));
    vec2 tip_normal = normalize(vec2(u_float_wing_width_multiplier, u_float_tip_height_multiplier));
    float tip_radius;
    float wing_radius;
    float tail_radius;
    #ifdef ENTRANCE_ARROWS_ROUNDING
    tip_radius = v_vec3_radius_tip_wing_tail.x;
    wing_radius = v_vec3_radius_tip_wing_tail.y;
    tail_radius = v_vec3_radius_tip_wing_tail.z;
    #else
    tip_radius = 0.;
    wing_radius = 0.;
    tail_radius = 0.;
    #endif
    ArrowDistanceParameters arrow_parameters = calculate_arrow_distance_parameters(
        wing_normal,
        tip_normal,
        v_vec4_arrow_width_length_border_outer.x,
        v_vec4_arrow_width_length_border_outer.y,
        u_float_tip_height_multiplier,
        u_float_wing_height_multiplier,
        tip_radius,
        wing_radius,
        v_vec4_arrow_width_length_border_outer.z,
        v_vec4_circle_center_tip_wing.xy,
        v_vec4_circle_center_tip_wing.zw);
    float line_width = arrow_parameters.width;
    float line_border = v_vec4_arrow_width_length_border_outer.z;
    
    vec2 line_texcoord = v_vec4_texcoord_arrow_line.zw;
    mat2 line_derivatives = mat2(dFdx(line_texcoord), dFdy(line_texcoord));
    CircleDistance circle_fill_distance = circle_color_distance(line_derivatives, line_texcoord, line_width);
    CircleDistance circle_border_distance = circle_color_distance(line_derivatives, line_texcoord, line_width + line_border);
    float line_fill_distance = affine_step(-1., 0., circle_fill_distance.distance / circle_fill_distance.width) - 1.;
    float line_border_distance = affine_step(0., circle_border_distance.width, circle_border_distance.distance);
    return lookalike(v_vec2_line_type_arrow_tail.x, g_type_arrow)
        ? arrow_color(v_vec4_texcoord_arrow_line.xy, arrow_parameters, line_fill_distance, line_border_distance, wing_normal)
        : line_color(line_fill_distance, line_border_distance, line_width, line_border, tail_radius);
}
void main()
{
    vec4 color = arrow_line_color();
    gl_FragColor = apply_fog(color);
}
`,jF=`#include <highp_float>
#include <prelude>
varying vec2 v_vec2_line_type_arrow_tail;
varying vec4 v_vec4_distance_vertex_hiding;
varying vec4 v_vec4_identifier;
const float g_type_arrow = 1.;
bool lookalike(const float a, const float b)
{
    return abs(a - b) < 1e-5;
}
void main()
{
    if (lookalike(min(v_vec4_distance_vertex_hiding.y, 1.), 1.)
        || lookalike(v_vec4_distance_vertex_hiding.w, 1.)
        || !lookalike(v_vec2_line_type_arrow_tail.x, g_type_arrow) && (v_vec4_distance_vertex_hiding.x < v_vec4_distance_vertex_hiding.y || v_vec4_distance_vertex_hiding.x > v_vec4_distance_vertex_hiding.z))
    {
        discard;
    }
    gl_FragColor = v_vec4_identifier;
}
`,VF=`#include <highp_float>
#include <prelude>
#include <cam_pos>
#include <affine_step>
#include <fog>
#include <bit_mask>
#include <pack_depth>
#include <shadow>
#include <light>
uniform vec4 u_vec4_color;
varying vec2 v_vec2_circle;
varying float v_float_width;
void main() {
    float center_distance = dot(v_vec2_circle, v_vec2_circle);
    vec4 light = light_factor_surface();
    vec4 color = u_vec4_color * affine_step(1.0, 1.0 - 4.0 / v_float_width, center_distance) * light;
    gl_FragColor = apply_fog_alpha(color);
}
`,HF=`#include <lowp_float>
#include <prelude>
#include <fog>
varying vec4 v_vec4_color;
void main()
{
    gl_FragColor = apply_fog(v_vec4_color);
}
`,ZF=`#include <lowp_float>
#include <prelude>
varying vec4 v_vec4_identifier;
void main()
{
    gl_FragColor = v_vec4_identifier;
}
`,$F=`#include <enable_standard_derivatives>
#include <highp_float>
#include <prelude>
#include <cam_pos>
#include <fog>
#include <screendoor_transparency>
#include <fragment_normal>
#include <bit_mask>
#include <pack_depth>
#include <shadow>
#include <light>
varying vec4 v_vec4_color;
varying vec4 v_vec4_rotated_scaled_vertex;
void main()
{
    apply_screendoor();
    vec3 normal = calc_fragment_normal(v_vec4_rotated_scaled_vertex.xyz);
    vec4 light = light_factor(normal);
    vec4 color = v_vec4_color * light;
    gl_FragColor = apply_fog(color);
}
`,WF=`#include <mediump_float>
#include <prelude>
#if defined(IS_DEPTH_TEXTURE) && defined(WEBGL2)
uniform mediump sampler2DShadow u_texture;
#else
uniform sampler2D u_texture;
#endif
varying vec2 v_vec2_texcoord;
void main()
{
#if defined(IS_DEPTH_TEXTURE) && defined(WEBGL2)
    gl_FragColor = vec4(vec3(texture2D(u_texture, vec3(v_vec2_texcoord, 1.0))), 1.0);
#else
    gl_FragColor = texture2D(u_texture, v_vec2_texcoord);
#endif
}
`,XF=`#include <require_frag_depth>
#include <mediump_float>
#include <prelude>
#include <apply_opacity>
uniform sampler2D u_texture;
uniform sampler2D u_depth;
varying vec2 v_vec2_texcoord;
void main()
{
    float depthR = texture2D(u_depth, v_vec2_texcoord).r;
    vec4 color = texture2D(u_texture, v_vec2_texcoord);
    gl_FragColor = color;
    #ifdef WEBGL1
    gl_FragDepthEXT = depthR;
    #else
    gl_FragDepth = depthR;
    #endif
}
`,YF=`#include <mediump_float>
#include <prelude>
varying float v_float_height;
void main()
{
  gl_FragColor = vec4(v_float_height, 0., 0., 1.);
}
`,qF=`#include <mediump_float>
#include <prelude>
uniform sampler2D u_sr2d_texture;
varying vec2 v_vec2_texcoord;
void main()
{
  gl_FragColor = texture2D(u_sr2d_texture, v_vec2_texcoord);
}
`,KF=`#include <mediump_float>
#include <prelude>
varying vec4 v_vec4_color;
void main()
{
    gl_FragColor = v_vec4_color;
}
`,JF=`#include <mediump_float>
#include <prelude>
varying vec4 v_vec4_coords;
void main()
{
    gl_FragColor = v_vec4_coords;
}
`,QF=`#include <mediump_float>
#include <prelude>
varying vec4 v_vec4_coords;
void main()
{
    gl_FragColor = v_vec4_coords;
}
`,eD=`#include <enable_standard_derivatives>
#include <mediump_float>
#include <prelude>
#include <cam_pos>
#include <fog>
#include <bit_mask>
#include <pack_depth>
#include <shadow>
#include <light>
uniform sampler2D u_flat_tex;
uniform sampler2D u_hillshade_tex;
uniform sampler2D u_tex_hillshade_ramp;
uniform float u_float_dem_shading_intensity;
varying vec4 v_vec4_texcoord;
varying vec2 hs_tex_pos;
void main()
{
    
    if (v_vec4_texcoord.z > 0.) {
        discard;
    }
    vec4 vec4_texcoord = v_vec4_texcoord / v_vec4_texcoord.w;
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
     
    if (vec4_texcoord.x < 0. || vec4_texcoord.x > 1. || vec4_texcoord.y < 0. || vec4_texcoord.y > 1.) {
        discard;
    } else {
        vec4 flatMapColor = texture2D(u_flat_tex, vec4_texcoord.xy);
        
        if (u_float_dem_shading_intensity > 0.) {
            
            vec3 normal = texture2D(u_hillshade_tex, hs_tex_pos).rgb * 2. - vec3(1.);
            
            float light_raw = light_factor_dem(normal);
            float dir1_intensity = u_vec4_light_dir1_color[3];
            float amb_intensity = u_vec4_ambient_color[3];
            float total_intensity = dir1_intensity + amb_intensity;
            
            
            float amb_intensity_shifted = u_vec4_ambient_color[3];
            float dir_intensity_shifted = dir1_intensity;
            
            float horizonatal_surface_light_dir_dot = light_factor_dem(vec3(0, 0, 1));
            float horizonatal_surface_light_intensity = amb_intensity + dir1_intensity * horizonatal_surface_light_dir_dot;
            if (u_float_dem_shading_intensity > 0.5) { 
                amb_intensity_shifted = mix(amb_intensity, 0., (u_float_dem_shading_intensity - 0.5) / 0.5);
                dir_intensity_shifted = (horizonatal_surface_light_intensity - amb_intensity_shifted) / horizonatal_surface_light_dir_dot;
            } else if (u_float_dem_shading_intensity < 0.5) { 
                dir_intensity_shifted = mix(0., dir1_intensity, u_float_dem_shading_intensity / 0.5);
                amb_intensity_shifted = horizonatal_surface_light_intensity - dir_intensity_shifted * horizonatal_surface_light_dir_dot;
            } 
            
            float tex_coord = clamp(dir_intensity_shifted * light_raw * 0.5 + 0.5, 0., 0.99);
            
            float dir_light_factor = 2. * (texture2D(u_tex_hillshade_ramp, vec2(tex_coord, 0.5)).a - 0.5);
            vec3 light_color = amb_intensity_shifted * u_vec4_ambient_color.rgb + dir_light_factor * u_vec4_light_dir1_color.rgb;
            
            gl_FragColor.rgb = light_color * flatMapColor.rgb;
            
            
            gl_FragColor.a = flatMapColor.a;
        } else {
            gl_FragColor = flatMapColor * light_factor_surface();
        }
        gl_FragColor = apply_fog(gl_FragColor);
    }
}
`,tD=`#include <enable_standard_derivatives>
#include <mediump_float>
#include <prelude>
#include <cam_pos>
#include <fog>
#include <bit_mask>
#include <pack_depth>
#include <shadow>
#include <light>
#include <fragment_normal>
uniform sampler2D u_flat_tex;
uniform sampler2D u_hillshade_tex;
uniform sampler2D u_tex_hillshade_ramp;
uniform mediump float u_use_flat_dem_mesh_normals;
varying vec4 v_vec4_texcoord;
varying vec3 v_vec3_position;
varying vec3 v_vec3_normal;
void main() {
    vec4 vec4_texcoord = v_vec4_texcoord / v_vec4_texcoord.w;
    if(vec4_texcoord.x < 0. || vec4_texcoord.x > 1. || vec4_texcoord.y < 0. || vec4_texcoord.y > 1.) {
        discard;
    }
    vec4 flatMapColor = texture2D(u_flat_tex, vec4_texcoord.xy);
    vec3 normal = u_use_flat_dem_mesh_normals == 1.0 ? calc_fragment_normal(v_vec3_position) : v_vec3_normal;
    vec4 lf = light_factor(normal);
    gl_FragColor = vec4(lf.rgb * flatMapColor.rgb, flatMapColor.a);
    
    
}
`,iD=`#include <lowp_float>
#include <prelude>
uniform sampler2D u_tex_dem;
const float DEM_INVALID_VALUE = -9999.;
uniform float u_float_dem_resolution;
uniform float u_float_dem_cell_size;
uniform float u_float_dem_scale;
const float M_PI = 3.1415926535897932384626433832795;
varying vec2 v_vec2_texcoord;
mat3 get_kernel(vec2 pos, float step, float defval) {
    mat3 kernel;
    for (int x = 0; x < 3; x++) {
        vec3 col;
        for (int y = 0; y < 3; y++) {
            col[y] = texture2D(u_tex_dem, vec2(pos.x + float(x - 1) * step, pos.y + float(y - 1) * step)).r;
            if (col[y] == DEM_INVALID_VALUE) {
                col[y] = defval;
            }
        }
        kernel[x] = col;
    }
    return kernel;
}
float calc_aspect(mat3 kernel) {
    float dzdx = ((kernel[2].z + 2.0 * kernel[2].y + kernel[2].x) - (kernel[0].z + 2.0 * kernel[0].y + kernel[0].x)) / 8.;
    float dzdy = ((kernel[0].x + 2.0 * kernel[1].x + kernel[2].x) - (kernel[0].z + 2.0 * kernel[1].z + kernel[2].z)) / 8.;
    
    if (dzdx == 0. && dzdy == 0.) {
        return 0.;
    }
    
    return atan(-dzdx, dzdy);
}
float calc_slope(mat3 kernel, float cell_size) {
    float dzdx = ((kernel[2].z + 2. * kernel[2].y + kernel[2].x) - (kernel[0].z + 2. * kernel[0].y + kernel[0].x)) / (8. * cell_size);
    float dzdy = ((kernel[0].x + 2. * kernel[1].x + kernel[2].x) - (kernel[0].z + 2. * kernel[1].z + kernel[2].z)) / (8. * cell_size);
    float rise_run = sqrt(dzdx * dzdx + dzdy * dzdy);
    return atan(rise_run);
}
vec3 dem_normal(const vec2 tex_pos)
{
    
    float tex_step = 1. / u_float_dem_resolution;
    
    if (u_float_dem_scale == 0.) {
        return vec3(0.);
    }
    
    vec4 e = texture2D(u_tex_dem, tex_pos);
    if (e.a == 0. || e.r == DEM_INVALID_VALUE) {
        
        return vec3(0.);
    }
    mat3 kernel = get_kernel(tex_pos.xy, tex_step, e.r);
    
    float aspect = calc_aspect(kernel);
    
    
    float slope = calc_slope(kernel, u_float_dem_cell_size);
    
    slope = M_PI * 0.5 - slope; 
    aspect = aspect - M_PI * 0.5; 
    float cosSlope = cos(slope);
    vec3 normal = normalize(vec3(cosSlope * cos(aspect), -1. * cosSlope * sin(aspect), sin(slope)));
    
    return normal * 0.5 + vec3(0.5);
}
void main() {
    gl_FragColor = vec4(dem_normal(v_vec2_texcoord), 1);
}
`,nD=`#include <require_frag_depth>
#include <highp_float>
void main()
{
    
    
    
    #ifdef WEBGL1
        gl_FragDepthEXT = 1.0;
    #else
        gl_FragDepth = 1.0;
    #endif
}
`,sD=`#include <mediump_float>
#include <prelude>
uniform sampler2D u_sr2d_flatmap_texture;
varying vec2 v_vec2_texture;
void main() {
    gl_FragColor = texture2D(u_sr2d_flatmap_texture, v_vec2_texture);
}
`,oD=`#include <mediump_float>
#include <prelude>
#ifndef UBO
uniform mediump vec4 u_vec4_halo_color;
uniform mediump vec2 u_vec2_halo_viewport_size;
uniform mediump vec2 u_vec2_halo_viewport_center_shift;
uniform mediump vec4 u_vec4_halo_radius_stops;
uniform mediump float u_float_halo_exp_factor;
#endif
varying vec2 v_vec2_uv;
void main() {
    float dist = length(v_vec2_uv);
    float halo_alpha = u_vec4_halo_color.a;
    vec4 halo_color = vec4(u_vec4_halo_color.rgb, 0.);
    vec4 empty_color = vec4(0.0);
    vec4 white_color1 = vec4(1., 1., 1., halo_alpha);
    vec4 white_color2 = vec4(white_color1.rgb, halo_alpha * 0.9);
    float r0 = u_vec4_halo_radius_stops[0];
    float r1 = u_vec4_halo_radius_stops[1];
    float r2 = u_vec4_halo_radius_stops[2];
    float r3 = u_vec4_halo_radius_stops[3];
    float t0 = max(0.0, (dist - r1) / (r3 - r1));
    float t0e = 1.0 - exp(u_float_halo_exp_factor * t0);
    
    vec4 color = mix(white_color2, halo_color, t0e);
    
    color = mix(white_color1, color, smoothstep(r1, r2, dist));
    
    color = mix(empty_color, color, smoothstep(r0, r1, dist));
    gl_FragColor = color;
}
`,rD=`#include <mediump_float>
#include <prelude>
#ifndef UBO
uniform mediump vec4 u_vec4_default_background_color;
uniform mediump vec4 u_vec4_halo_radius_stops;
#endif
varying vec2 v_vec2_uv;
void main() {
    float dist = length(v_vec2_uv);
    float r1 = u_vec4_halo_radius_stops[1];
    if(dist > r1) {
        discard;
    }
    gl_FragColor = u_vec4_default_background_color;
}
`,aD=`#include <enable_standard_derivatives>
#include <highp_float>
#include <prelude>
#include <cam_pos>
#include <fog>
#include <screendoor_transparency>
#include <bit_mask>
#include <pack_depth>
#include <shadow>
#include <light>
#include <light_pbr>
#include <light_phong>
uniform vec4 u_vec4_color;
#ifdef MAP_MESH_TEXTURE
uniform sampler2D u_sampler_map_tex;
#endif
#ifdef COLOR_TEXTURE
uniform sampler2D u_sr2d_texture_0;
#endif
#ifdef AO_TEXTURE
uniform sampler2D u_ao_texture;
#endif
#ifdef PBR_TEXTURE
uniform sampler2D u_pbr_texture;
#endif
#ifdef LIGHT_MODEL
#if  (LIGHT_MODEL == LIGHT_MODEL_PBR || LIGHT_MODEL == LIGHT_MODEL_PHONG)
uniform float u_float_metallic;
uniform float u_float_roughness;
#endif
#endif
varying vec3 v_vec3_normal;
varying vec3 v_vec3_fragment_pos_world;
#ifdef MAP_MESH_TEXTURE
uniform vec2 u_vec2_tex_scale;
uniform float u_float_tex_shift_scale;
varying vec4 v_tex_coord;
#endif
#ifdef COLOR_TEXTURE
varying vec2 v_vec2_texcoord_color;
#endif
#ifdef AO_TEXTURE
varying vec2 v_vec2_texcoord_ao;
#endif
#ifdef PBR_TEXTURE
varying vec2 v_vec2_texcoord_pbr;
#endif
varying float v_float_opacity;
void main()
{
    apply_screendoor();
    vec4 color = u_vec4_color;
    #ifdef COLOR_TEXTURE
        color *= texture2D(u_sr2d_texture_0, v_vec2_texcoord_color);
    #endif
    #ifdef MAP_MESH_TEXTURE
        
        vec2 coord = v_tex_coord.xy / v_tex_coord.w;
        
        coord = coord / u_vec2_tex_scale;
        
        coord.y += u_float_tex_shift_scale / u_vec2_tex_scale.y;
        
        coord = (coord / 2.) + vec2(0.5, 0.5);
        vec4 texture_color = texture2D(u_sampler_map_tex, coord);
        
        color.rgb = mix(color.rgb, texture_color.rgb, texture_color.a);
    #endif
    #ifdef AO_TEXTURE
        
        
        vec4 ao_tex_color = texture2D(u_ao_texture, v_vec2_texcoord_ao);
        color *= ao_tex_color;
    #endif
    vec3 fragment_normal = normalize(v_vec3_normal);
    color *= v_float_opacity;
    bool use_light = UNPACK_BOOL1(u_int_light_flags);
    if (!use_light) {
        gl_FragColor = apply_fog(color);
        return;
    }
    #ifdef LIGHT_MODEL
        float metallic = max(u_float_metallic, 0.1);
        float roughness = max(u_float_roughness, 0.1);
        #ifndef METALLIC_ROUGHNESS_DEBUG
            #ifdef PBR_TEXTURE
                vec4 pbr_tex_color = texture2D(u_pbr_texture, v_vec2_texcoord_pbr);
                roughness = max(pbr_tex_color.g, 0.1);
                metallic = max(pbr_tex_color.b, 0.1);
            #endif
        #endif
        #if (LIGHT_MODEL == LIGHT_MODEL_PBR)
            color.rgb = color_pbr(fragment_normal, v_vec3_fragment_pos_world, color.rgb, roughness, metallic);
        #elif (LIGHT_MODEL == LIGHT_MODEL_PHONG)
            color.rgb = color_phong(fragment_normal, v_vec3_fragment_pos_world, color.rgb, roughness, metallic);
        #endif
    #endif
    gl_FragColor = apply_fog(color);
}
`,lD=`#include <enable_standard_derivatives>
#include <highp_float>
#include <prelude>
#include <cam_pos>
#include <fog>
#include <screendoor_transparency>
#include <fragment_normal>
#include <bit_mask>
#include <pack_depth>
#include <shadow>
#include <light>
varying mat4 v_mat4_gradient;
varying vec4 v_vec4_color;
varying vec4 v_vec4_rotated_scaled_vertex;
void main()
{
    apply_screendoor();
    vec4 color = v_vec4_color;
    if (v_mat4_gradient[0][0] != 0.) {
        float height_gradient = v_vec4_rotated_scaled_vertex.w;
        color = mix(v_mat4_gradient[1], v_mat4_gradient[2], smoothstep(v_mat4_gradient[0][1], v_mat4_gradient[0][2], height_gradient));
    }
    vec3 normal = calc_fragment_normal(v_vec4_rotated_scaled_vertex.xyz);
    color *= light_factor(normal);
    gl_FragColor = apply_fog(color);
}`,cD=`#include <mediump_float>
#include <prelude>
#include <fog>
uniform highp float u_float_intensity;
varying float v_float_weight;
varying vec2 v_vec2_extrude;
#define GAUSS_COEF 0.3989422804014327
void main() {
    float d = -0.5 * 3.0 * 3.0 * dot(v_vec2_extrude, v_vec2_extrude);
    float val = v_float_weight * u_float_intensity * GAUSS_COEF * exp(d);
    float fog_alpha = apply_fog_alpha(vec4(1)).r;
    gl_FragColor = vec4(val, fog_alpha, 1.0, 1.0);
}
`,dD=`#include <mediump_float>
#include <prelude>
#include <cam_pos>
uniform sampler2D u_sr2d_texture;
uniform sampler2D u_sr2d_ramp_texture;
uniform float u_float_opacity;
varying vec2 v_vec2_position;
void main() {
    vec2 color_and_alpha = texture2D(u_sr2d_texture, v_vec2_position).rg;
    vec4 color = texture2D(u_sr2d_ramp_texture, vec2(color_and_alpha.r, 0.5));
    gl_FragColor = color * u_float_opacity;
    
    
    #ifdef FOG
        gl_FragColor *= color_and_alpha.g;
    #endif
}
`,hD=`#include <mediump_float>
#include <prelude>
#include <apply_opacity>
#include <fog>
uniform sampler2D u_sr2d_texture;
uniform float u_float_buffer;
uniform float u_float_gamma;
uniform vec4 u_vec4_color;
uniform vec4 u_vec4_hidden_color;
uniform float u_float_opacity;
uniform sampler2D u_color_text_sprite_labeling;
uniform float u_float_label_index;
varying vec2 v_vec2_texcoord;
varying float v_float_behind_factor;
varying vec4 v_vec4_text_identifier;
varying vec2 v_vec2_labeling_texcoord;
void main() {
    float dist = texture2D(u_sr2d_texture, v_vec2_texcoord).a;
    float alpha = smoothstep(
        u_float_buffer - u_float_gamma,
        u_float_buffer + u_float_gamma,
        dist
    );
    vec4 color = mix(u_vec4_hidden_color, u_vec4_color, v_float_behind_factor);
    color = apply_fog_alpha(color);
    vec4 clearColor = vec4(1, 1, 1, 1);
    vec4 text_sprite_color = texture2D(u_color_text_sprite_labeling, v_vec2_labeling_texcoord);
    if (u_float_label_index < 0.0000001 && text_sprite_color != v_vec4_text_identifier && text_sprite_color != clearColor) {
        discard;
    }
    gl_FragColor = apply_opacity(color * alpha, u_float_opacity);
}
`,uD=`#include <highp_float>
#include <prelude>
#include <apply_opacity>
#include <fog>
uniform sampler2D u_sr2d_texture;
uniform float u_float_buffer;
uniform float u_float_gamma;
uniform vec4 u_vec4_color;
uniform float u_float_opacity;
varying vec2 v_vec2_texcoord;
void main() {
    float dist = texture2D(u_sr2d_texture, v_vec2_texcoord).a;
    float alpha = smoothstep(
        u_float_buffer - u_float_gamma,
        u_float_buffer + u_float_gamma,
        dist
    );
    vec4 color = apply_fog_alpha(u_vec4_color);
    gl_FragColor = apply_opacity(color * alpha, u_float_opacity);
}
`,fD=`#include <mediump_float>
#include <prelude>
#include <cam_pos>
#include <fog>
#include <bit_mask>
#include <pack_depth>
#include <shadow>
#include <light>
varying vec4 v_vec4_color;
varying mat4 v_mat4_gradient;
varying vec3 v_vec3_normal;
varying vec2 v_vec2_height_gradient;
uniform mat4 u_mat4_gradient;
void main()
{ 
    vec4 color = v_vec4_color;
    if (u_mat4_gradient[0][0] != 0.) {
        color = mix(v_mat4_gradient[1], v_mat4_gradient[2], smoothstep(v_mat4_gradient[0][1], v_mat4_gradient[0][2], v_vec2_height_gradient[0]));
    }
    color *= (1. - abs(v_vec2_height_gradient[1] * gl_FragCoord.w));
    gl_FragColor = apply_fog(color * light_factor(v_vec3_normal));
}
`,_D=`#include <highp_float>
#include <prelude>
#include <pack_depth>
varying float v_depth_metric;
void main()
{
#ifdef DEPTH_TEXTURE_SHADOW
return;
#endif
gl_FragColor = pack_float_to_vec4(v_depth_metric);
}`,mD=`#include <highp_float>
#include <prelude>
#include <cam_pos>
#include <fog>
#include <screendoor_transparency>
#include <bit_mask>
#include <pack_depth>
#include <shadow>
#include <light>
uniform sampler2D u_sampler_map_tex;
uniform vec2 u_vec2_tex_scale;
uniform float u_float_tex_shift_scale;
uniform mediump float u_float_light_intensity;
uniform int u_int_identify;
varying vec4 v_tex_coord;
varying vec4 v_vec4_normal_gradient;
void main()
{
vec2 coord = v_tex_coord.xy / v_tex_coord.w;
coord = coord / u_vec2_tex_scale;
coord.y += u_float_tex_shift_scale / u_vec2_tex_scale.y;
coord = (coord / 2.) + vec2(0.5, 0.5);
if (coord.x < 0. || coord.x > 1. || coord.y < 0. || coord.y > 1.) {
gl_FragColor = vec4(0, 0, 0, 0);
} else {
gl_FragColor = texture2D(u_sampler_map_tex, coord);
if (u_int_identify == 0) {
apply_screendoor();
gl_FragColor.rgb *= 1. - u_float_light_intensity * smoothstep(0.85, 1., abs(v_vec4_normal_gradient.w));
gl_FragColor *= light_factor(v_vec4_normal_gradient.xyz);
gl_FragColor = apply_fog(gl_FragColor);
}
}
}
`,pD=`#include <highp_float>
#include <prelude>
#include <cam_pos>
#include <apply_opacity>
#include <fog>
#include <screendoor_transparency>
#include <bit_mask>
#include <pack_depth>
#include <shadow>
#include <light>
uniform sampler2D u_sr2d_texture;
uniform float u_float_texture_opacity;
uniform vec4 u_float_sprite_texture_coords;
uniform lowp int u_int_is_textured;
uniform mediump vec4 u_vec4_color;
uniform mediump mat4 u_mat4_gradient;
uniform mediump float u_float_opacity;
uniform mediump int u_int_identify;
varying vec4 v_vec4_color;
varying mat4 v_mat4_gradient;
varying vec2 v_vec2_tex_coord;
varying vec4 v_vec4_normal_gradient;
varying vec4 v_vec4_identifier;
void main()
{
    if (u_int_identify != 0) {
        gl_FragColor = v_vec4_identifier;
    } else {
        apply_screendoor();
        vec4 light = light_factor(v_vec4_normal_gradient.xyz);
        if (u_int_is_textured != 0)  {
            vec2 spritecoord = mix(u_float_sprite_texture_coords.xy, u_float_sprite_texture_coords.zw, fract(v_vec2_tex_coord));
            vec4 color = texture2D(u_sr2d_texture, spritecoord);
            vec4 texcolor = apply_opacity(color, u_float_texture_opacity);
            gl_FragColor = texcolor + v_vec4_color * (1. - texcolor.a);
        } else if (u_mat4_gradient[0][0] != 0.) {
    gl_FragColor = mix(v_mat4_gradient[1], v_mat4_gradient[2], smoothstep(v_mat4_gradient[0][1], v_mat4_gradient[0][2], v_vec4_normal_gradient.w));
        } else {
            gl_FragColor = v_vec4_color;
        }
        gl_FragColor = apply_fog(gl_FragColor * light);
    }
}
`,gD=`#include <mediump_float>
#include <prelude>
#include <cam_pos>
#include <apply_opacity>
#include <fog>
#include <bit_mask>
#include <pack_depth>
#include <shadow>
#include <light>
uniform vec4 u_vec4_color;
uniform sampler2D u_sr2d_texture;
uniform vec4 u_float_sprite_texture_coords;
varying vec2 v_vec2_texcoord;
void main()
{
    vec2 spritecoord = mix(u_float_sprite_texture_coords.xy, u_float_sprite_texture_coords.zw, v_vec2_texcoord);
    vec4 color = texture2D(u_sr2d_texture, spritecoord) * u_vec4_color;
    gl_FragColor = apply_fog(color * light_factor_surface());
}
`,vD=`#include <enable_standard_derivatives>
#include <highp_float>
#include <prelude>
#include <affine_step>
#include <apply_opacity>
#include <signed_distance_functions>
#include <arrow_functions>
#include <fog>
uniform vec2 u_vec2_wing_normal;
uniform vec2 u_vec2_tip_normal;
uniform mediump float u_float_width;
uniform mediump float u_float_length;
uniform mediump vec2 u_vec2_vpt_size;
uniform float u_float_tip_height_multiplier;
uniform float u_float_wing_height_multiplier;
varying vec4 v_vec4_color;
varying vec4 v_vec4_border_color;
varying vec2 v_vec2_texcoord;
varying float v_float_border_width;
varying float v_float_zpt_to_texcoord_factor;
varying float v_float_outer_width;
varying float v_float_opacity;
float one_way_line_distance(const ArrowDistances ad)
{
    return max(max(max(ad.top_tip_cut, ad.bottom_tip_cut), max(ad.top_left_wing, ad.top_right_wing)), min(ad.line, min(ad.bottom_left_wing, ad.bottom_right_wing)));
}
void main()
{
    mat2 derivatives = mat2(dFdx(v_vec2_texcoord), dFdy(v_vec2_texcoord));
    ArrowDistanceParameters arrow_parameters = calculate_arrow_distance_parameters(
        u_vec2_wing_normal,
        u_vec2_tip_normal,
        u_float_width * v_float_zpt_to_texcoord_factor,
        u_float_length * v_float_zpt_to_texcoord_factor,
        u_float_tip_height_multiplier,
        u_float_wing_height_multiplier,
        0.,
        0.,
        0.,
        vec2(0., 0.),
        vec2(0., 0.));
    
    float border_clipping = (abs(v_vec2_texcoord.y) - v_float_outer_width) / max(abs(derivatives[0].y), abs(derivatives[1].y));
    float fill_factor = affine_step(-1., 0., one_way_line_distance(calculate_arrow_distances(arrow_parameters, v_vec2_texcoord, 0., derivatives)));
    float border_factor = max(border_clipping, affine_step(0., 1., one_way_line_distance(calculate_arrow_distances(arrow_parameters, v_vec2_texcoord, v_float_border_width, derivatives))));
    gl_FragColor = apply_opacity(mix(mix(v_vec4_color, v_vec4_border_color, fill_factor), vec4(0.), border_factor), v_float_opacity);
}
`,yD=`#include <highp_float>
#include <prelude>
#include <cam_pos>
#include <affine_step>
#include <fog>
#include <bit_mask>
#include <pack_depth>
#include <shadow>
#include <light>
#include <signed_distance_functions>
uniform int u_int_pattern_type;
varying vec4 v_vec4_color;
varying vec2 v_vec2_uv;
varying float v_float_width;
varying vec4 v_vec4_pattern_parameters;
void main()
{
    float pattern_length = v_vec4_pattern_parameters.x;
    float full_width = v_float_width + 1.;
    
    float smooth_base = max(15., max(v_float_width, pattern_length));
    float smooth_scale = (smooth_base + 1.) / smooth_base;
    float smooth_factor = smooth_scale - 1.;
    
    vec2 sdf_pos = vec2(mod(v_vec2_uv.x, 1.) - 0.5, v_vec2_uv.y * smooth_scale);
float sdf = 1.;
    
    if (u_int_pattern_type < 4) {
        
        float width = v_vec4_pattern_parameters.y;
        float left  = v_vec4_pattern_parameters.z;
        float right = v_vec4_pattern_parameters.w;
        
        
        vec2 offset;
        if (right < 0.) {
            offset = vec2(.25, .5);
        } else {
            offset = vec2(.0, .5);
        }
        
        if (width > EPSILON) {
            float leftSdf = 1.;
            if (left > EPSILON) {
                leftSdf = sdf_box(sdf_pos + offset, vec2(left, width));
            }
            float rightSdf = 1.;
            if (abs(right) > EPSILON) {
                rightSdf = sdf_box(sdf_pos - offset, vec2(abs(right), width));
            }
            sdf = min(leftSdf, rightSdf);
        }
    } else if (u_int_pattern_type == 5) {
        
        float radius = v_vec4_pattern_parameters.y;
        
        if (radius > EPSILON) {
            sdf = sdf_circle(sdf_pos, radius);
        }
    } else if (u_int_pattern_type == 4) {
        
        float width = v_vec4_pattern_parameters.y;
        float orientation = v_vec4_pattern_parameters.z;
        
        if (width > EPSILON) {
            sdf = sdf_triangle(sdf_pos * vec2(1., orientation), width);
        }
    } else if (u_int_pattern_type == 6) {
        
        sdf = sdf_chevron(sdf_pos.yx, 0., 0., 0.);
    }
    
    sdf = max(sdf, abs(sdf_pos.y) - 0.5);
    
    vec4 color = mix(
        v_vec4_color,
        vec4(0.),
        affine_step(-smooth_factor, smooth_factor, sdf)
    );
    color *= light_factor_surface();
    gl_FragColor = apply_fog(color);
}
`,wD=`#include <mediump_float>
#include <prelude>
#include <apply_opacity>
#include <fog>
uniform sampler2D u_sr2d_texture;
uniform vec2 u_vec2_opacity;
varying vec2 v_vec2_texcoord;
varying float v_float_behind_factor;
void main()
{
    vec4 color = texture2D(u_sr2d_texture, v_vec2_texcoord);
    float opacity = mix(u_vec2_opacity[1], u_vec2_opacity[0], v_float_behind_factor);
    color = apply_fog_alpha(color);
    gl_FragColor = apply_opacity(color, opacity);
}
`,bD=`#include <mediump_float>
#include <prelude>
uniform sampler2D u_sr2d_texture;
varying vec2 v_vec2_texcoord;
varying vec4 v_vec4_identifier;
void main()
{
    vec4 color = texture2D(u_sr2d_texture, v_vec2_texcoord);
    if (color.a < 0.3) {
        discard;
    } else {
        gl_FragColor = v_vec4_identifier;
    }
}
`,xD=`#include <lowp_float>
#include <prelude>
#include <fog>
uniform vec4 u_vec4_color;
void main()
{
    gl_FragColor = u_vec4_color;
}
`,SD=`#include <mediump_float>
#include <prelude>
#include <apply_opacity>
#include <fog>
uniform sampler2D u_sr2d_texture;
uniform float u_float_opacity;
varying vec2 v_vec2_texcoord;
void main()
{
    vec4 color = texture2D(u_sr2d_texture, v_vec2_texcoord);
    color = apply_fog_alpha(color);
    gl_FragColor = apply_opacity(color, u_float_opacity);
}
`,MD=`#include <enable_standard_derivatives>
#include <highp_float>
#include <prelude>
#include <cam_pos>
#include <affine_step>
#include <fog>
#include <bit_mask>
#include <pack_depth>
#include <shadow>
#include <light>
uniform vec4 u_vec4_color;
varying vec2 v_vec2_normal;
varying float v_float_half_width;
void main()
{
    
    float opacity = 1.0 - affine_step(
        v_float_half_width - length(fwidth(v_vec2_normal)),
        v_float_half_width,
        length(v_vec2_normal)
    );
    vec4 color = light_factor_surface() * u_vec4_color;
    color = apply_fog(color);
    gl_FragColor = color * opacity;
}
`,ID=`#include <enable_standard_derivatives>
#include <lowp_float>
#include <prelude>
varying vec4 v_vec4_identifier;
varying vec2 v_vec2_normal;
varying float v_float_half_width;
void main()
{
    if (dot(v_vec2_normal, v_vec2_normal) > v_float_half_width * v_float_half_width) {
        discard;
    }
    gl_FragColor = v_vec4_identifier;
}
`,TD=`#include <lowp_float>
#include <prelude>
#include <cam_pos>
#include <fog>
#include <bit_mask>
#include <pack_depth>
#include <shadow>
#include <light>
uniform vec4 u_vec4_color;
varying float v_float_distance;
varying float v_float_distance_offset;
void main()
{
    vec4 light = light_factor_surface();
    vec4 color = u_vec4_color * clamp(
        1. + v_float_distance_offset - abs(v_float_distance * gl_FragCoord.w),
        0.,
        1.) * light;
    gl_FragColor = apply_fog(color);
}
`,ED=`#include <highp_float>
#include <prelude>
#include <enable_standard_derivatives>
varying vec3 v_position;
void main() {
    vec3 dx = dFdx(v_position);
    vec3 dy = dFdy(v_position);
    vec3 normal = normalize(cross(dx, dy));
    vec3 lightDir = normalize(vec3(1.0, 1.0, 1.0));
    float diffuse = max(dot(normal, lightDir), 0.0);
    
    gl_FragColor = vec4(normal * (0.2 + 0.8 * diffuse), 1.0);
}
`,AD=`#include <mediump_float>
#include <prelude>
#include <fog>
#define SKY_ALPHA_HORIZON_BLEND (6.0)
#define DEFAULT_SKY_COLOR (vec4(0.0))
vec4 add_sky_alpha_blend(vec4 color) {
#ifdef SKY
    
    float depth = length(v_fog_pos);
    vec3 dir = v_fog_pos / depth;
    float alpha_dir = dir.z + 0.15; 
    float alpha = clamp(1.0 + SKY_ALPHA_HORIZON_BLEND * alpha_dir, 0.0, 1.0);
    color *= alpha;
#endif
    return color;
}
void main() {
#ifdef SKY
    vec4 color = add_sky_alpha_blend(u_sky_color);
#else
    vec4 color = DEFAULT_SKY_COLOR;
#endif
    gl_FragColor = apply_fog_sky(color);
}
`,PD=`#include <mediump_float>
#include <prelude>
varying mediump float v_intensity;
void main() {
    gl_FragColor = vec4(v_intensity);
}
`,LD=`#include <enable_standard_derivatives>
#include <highp_float>
#include <prelude>
#include <cam_pos>
#include <affine_step>
#include <fog>
#include <bit_mask>
#include <pack_depth>
#include <shadow>
#include <light>
varying vec4 v_vec4_dash_color;
varying vec4 v_vec4_space_color;
varying vec4 v_vec4_border_color;
varying vec2 v_vec2_circle;
varying float v_float_width;
varying float v_float_part_color_swap_threshold;
varying float v_float_distance_in_parts;
vec4 distance_func_smooth(in vec4 main_color, in vec4 border_color, in vec2 circle)
{
    float circle_length = length(circle);
    float distance = circle_length - v_float_width;
    mat2 derivatives = mat2(dFdx(v_vec2_circle), dFdy(v_vec2_circle));
    
    
    
    vec2 circle_dx = derivatives[0];
    vec2 circle_dy = derivatives[1];
    
    float distance_dx = dot(v_vec2_circle, circle_dx);
    float distance_dy = dot(v_vec2_circle, circle_dy);
    
    float derivative_denominator = circle_length;
    float width = max(abs(distance_dx), abs(distance_dy));
    vec4 from_main_to_border = mix(
        main_color,
        border_color,
        affine_step(-width, 0., distance * derivative_denominator));
    vec4 from_color_to_fade = mix(
        from_main_to_border,
        vec4(0.),
        affine_step(0., +width, distance * derivative_denominator));
    return from_color_to_fade;
}
float calculate_segment_color_factor(in float distance_in_parts, in float threshold)
{
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    float color_factor = abs(fract(distance_in_parts + 0.5 - 0.5 * threshold) - 0.5);
    
    float parts_affine_step_width = fwidth(distance_in_parts);
    
    float smoothed_color_factor = affine_step(
        0.5 * threshold - 0.5 * parts_affine_step_width,
        0.5 * threshold + 0.5 * parts_affine_step_width,
        color_factor);
    return smoothed_color_factor;
}
void main()
{
    vec4 current_segment_color = mix(
        v_vec4_dash_color,
        v_vec4_space_color,
        calculate_segment_color_factor(
            v_float_distance_in_parts,
            v_float_part_color_swap_threshold));
    
    vec4 final_border_color = (1.0 - v_vec4_border_color.a) * current_segment_color + v_vec4_border_color;
    vec4 color = distance_func_smooth(current_segment_color, final_border_color, v_vec2_circle);
    vec4 light = light_factor_surface();
    gl_FragColor = apply_fog(light * color);
}
`,CD=`#include <mediump_float>
#include <prelude>
#include <cam_pos>
#include <apply_opacity>
#include <fog>
#include <bit_mask>
#include <pack_depth>
#include <shadow>
#include <light>
uniform sampler2D u_sr2d_texture;
uniform float u_float_texture_opacity;
uniform vec4 u_float_texture_params;
uniform vec4 u_float_sprite_texture_coords;
uniform int u_int_is_textured;
varying vec4 v_vec4_color;
varying vec2 v_vec2_texcoord;
void main()
{
    vec4 light = light_factor_surface();
    vec4 color;
    if (u_int_is_textured == 0) {
        color = v_vec4_color * light;
    } else {
        vec2 texcoord = fract(v_vec2_texcoord * u_float_texture_params.zw + u_float_texture_params.xy);
        vec2 spritecoord = mix(u_float_sprite_texture_coords.xy, u_float_sprite_texture_coords.zw, texcoord);
        color = texture2D(u_sr2d_texture, spritecoord);
        vec4 texcolor = apply_opacity(color, u_float_texture_opacity);
        color = texcolor + v_vec4_color * (1. - texcolor.a) * light;
    }
    gl_FragColor = apply_fog(color);
}
`,RD=`#include <enable_standard_derivatives>
#include <highp_float>
#include <prelude>
#include <cam_pos>
#include <fog>
#include <screendoor_transparency>
#include <fragment_normal>
#include <bit_mask>
#include <pack_depth>
#include <shadow>
#include <light>
uniform sampler2D u_sr2d_texture;
uniform vec4 u_vec4_color;
varying vec3 v_vec3_rotated_scaled_vertex;
varying vec2 v_vec2_texcoord;
void main()
{
    apply_screendoor();
    vec3 normal = calc_fragment_normal(v_vec3_rotated_scaled_vertex);
    vec4 light = light_factor(normal);
    vec4 color = texture2D(u_sr2d_texture, v_vec2_texcoord) * u_vec4_color * light;
    gl_FragColor = apply_fog(color);
}
`,zD={affine_step:bF,apply_opacity:Ww,arrow_functions:xF,bit_mask:SF,cam_pos:Xw,circle_functions:MF,enable_standard_derivatives:IF,fog:TF,fragment_normal:EF,highp_float:AF,light:PF,light_pbr:LF,light_phong:CF,lowp_float:RF,mediump_float:zF,pack_depth:FF,prelude:DF,require_frag_depth:OF,screendoor_transparency:BF,shadow:kF,signed_distance_functions:Yw,taa:NF},FD={antialias:UF,arrow_line:GF,arrow_line_identify:jF,circle_marker:VF,color:HF,color_identify:ZF,color_with_z_fade:$F,copy:WF,copy_depth:XF,dem_elevation:YF,dem_elevation_copy:qF,dem_flat_bottom:KF,dem_ground:JF,dem_ground2:QF,dem_mesh:eD,dem_mesh2:tD,dem_normal:iD,depth_clear:nD,globe:sD,globe_halo:oD,globe_halo_background:rD,gltf_model:aD,gradient_with_z_fade:lD,heatmap:cD,heatmap_texture:dD,label:hD,label_directional:uD,line:fD,main_shadow:_D,map_mesh:mD,mesh:pD,metric_point:gD,one_way_line:vD,patterned_line:yD,pointsprite:wD,pointsprite_identify:bD,rect:xD,rect_with_texture:SD,road:MD,road_identify:ID,simple_line:TD,simple_mesh:ED,sky:AD,stars:PD,striped_line:LD,textured_color:CD,zbm_model:RD},DD=`vec4 apply_height_factor(in vec3 vertex, const float height_factor)
{
    vertex.z *= height_factor;
    return vec4(vertex, 1.0);
}
`,OD=`
vec2 multiply_complex(const vec2 lhs, const vec2 rhs)
{
    return vec2(lhs.x * rhs.x - lhs.y * rhs.y, lhs.x * rhs.y + lhs.y * rhs.x);
}
struct ArrowParameters
{
    float zpt_to_texcoord_factor;
    float final_size;
    float outer_width;
    vec2 widen_size;
    vec2 wing_normal;
    vec2 tip_normal;
};
ArrowParameters calculate_arrow_parameters(
    const float calculation_scale,
    const float width_zpt,
    const float border_width_zpt,
    const float segment_length_zpt,
    const float wing_width_multiplier,
    const float wing_height_multiplier,
    const float tip_height_multiplier,
    const float size_factor)
{
    float quad_width = 2.0 * border_width_zpt + 2.0 * wing_width_multiplier * width_zpt;
    float quad_height = 2.0 * border_width_zpt + segment_length_zpt;
    float max_quad_dimension = max(quad_width, quad_height);
    float zpt_to_texcoord_factor = 2.0 / max_quad_dimension;
    float final_size = calculation_scale * size_factor * max_quad_dimension;
    vec2 widen_size = 0.5 * vec2(quad_height, quad_width) * zpt_to_texcoord_factor;
    float outer_width = (width_zpt * wing_width_multiplier + border_width_zpt) * zpt_to_texcoord_factor;
    vec2 wing_normal = -normalize(vec2(wing_width_multiplier, wing_height_multiplier));
    vec2 tip_normal = normalize(vec2(wing_width_multiplier, tip_height_multiplier));
    return ArrowParameters(
        zpt_to_texcoord_factor,
        final_size,
        outer_width,
        widen_size,
        wing_normal,
        tip_normal);
}
struct VertexShiftParameters
{
    vec4 clip_space_vertex;
    float limited_factor;
};
VertexShiftParameters calculate_vertex_shift_parameters(
    const mat4 mvp,
    const vec2 vpt_size,
    const vec2 vertex,
    const vec2 widen,
    const float shift_pixels)
{
    vec2 widen_perp = vec2(-widen.y, widen.x);
    
    vec4 clip_space_widen = mvp * vec4(widen, 0., 0.);
    vec4 clip_space_widen_perp = mvp * vec4(widen_perp, 0., 0.);
    vec2 half_viewport = vpt_size / 2.;
    
    vec4 clip_space_vertex = mvp * vec4(vertex, 0.0, 1.0) + clip_space_widen;
    
    float limited_factor = calculate_multiplication_factor(
        half_viewport,
        clip_space_widen,
        clip_space_widen_perp,
        clip_space_vertex,
        shift_pixels);
    return VertexShiftParameters(
        clip_space_vertex + clip_space_widen * limited_factor,
        limited_factor);
}
`,BD=`struct Scale
{
    float projection;
    float style;
    float style_clamped;
    float calculation;
};
Scale calculate_scale(const vec3 projection_scale_style_scale_dpi, const vec2 scale_limits)
{
    float style_scale_clamped = clamp(projection_scale_style_scale_dpi.y, scale_limits.x, scale_limits.y);
    float scale_ratio = projection_scale_style_scale_dpi.x / projection_scale_style_scale_dpi.y;
    float calculation_scale = style_scale_clamped * scale_ratio;
    return Scale(
        projection_scale_style_scale_dpi.x,
        projection_scale_style_scale_dpi.y,
        style_scale_clamped,
        calculation_scale);
}
const float g_min_scale_factor = 1e-2;
const float g_max_scale_factor = 1e2;
const float g_base_scale_numerator = 1e2;
float normalize_scale_to_tile(const float scale, const float tile_size)
{
    return clamp(
        (scale - g_min_scale_factor) / (tile_size - g_min_scale_factor),
        g_min_scale_factor,
        g_max_scale_factor);
}
`,kD=`
#ifdef SCREENDOOR
varying vec3 v_clipspace_pos;
#endif
void save_clipspace_pos () {
    #ifdef SCREENDOOR
    v_clipspace_pos = gl_Position.xyz;
    #endif
}
`,ND=`
uniform sampler2D u_tex_dem;
uniform sampler2D u_tex_corrected_dem;
uniform float u_float_corrected_interval;
uniform mat4 u_mat4_dem_corrected;
uniform mat4 u_mat4_dem_mvp;
uniform float u_float_dem_scale;
uniform float u_float_map_center_elevation;
uniform float u_float_vertical_scale;
const float DEM_INVALID_VALUE = -9999.;
const float UNPACK_CENTROID = 8. / 65535.;
const float MAP_POINTS_IN_METER = 107.17318796639701;
float dem_height_direct_meters(vec2 tex_pos) {
    
    if (u_float_dem_scale == 0.) {
        return 0.;
    }
    if (tex_pos.x < 0. || tex_pos.x > 1. || tex_pos.y < 0. || tex_pos.y > 1.) {
        return DEM_INVALID_VALUE;
    }
    vec4 elevation;
    
    if (u_float_corrected_interval == 0.) {
        elevation = texture2D(u_tex_dem, tex_pos);
    }
    else {
        vec2 test_tex_pos = abs(tex_pos - vec2(0.5, 0.5));
        if (test_tex_pos.x < u_float_corrected_interval && test_tex_pos.y < u_float_corrected_interval) {
            elevation = texture2D(u_tex_corrected_dem, (u_mat4_dem_corrected * vec4(tex_pos, 0, 1)).xy);
        } else {
            elevation = texture2D(u_tex_dem, tex_pos);
        }
    }
    
    if (elevation.a == 0.) {
        
        return DEM_INVALID_VALUE;
    } else {
        return elevation.r;
    }
}
float meters_to_tile_height(float height) {
    return (height - u_float_map_center_elevation) * MAP_POINTS_IN_METER * u_float_vertical_scale * u_float_dem_scale;
}
float dem_height_direct(vec2 tex_pos) {
    float height = dem_height_direct_meters(tex_pos);
    if (height == DEM_INVALID_VALUE) {
        return DEM_INVALID_VALUE;
    } else {
        return meters_to_tile_height(height);  
    }  
}
 
float dem_height(const vec2 coords) {
    
    if (u_float_dem_scale == 0.) {
        return 0.;
    }
    vec4 tex_pos = u_mat4_dem_mvp * vec4(coords, 0.0, 1.0);
    return dem_height_direct(tex_pos.xy);
}
float abs_height(float height) {
    return (height - u_float_map_center_elevation * MAP_POINTS_IN_METER) * u_float_dem_scale * u_float_vertical_scale;
}
vec2 unpack_dem_position(const vec2 pos) {
    return pos * UNPACK_CENTROID;
}
`,UD=`#ifndef UBO
uniform vec2 u_vec2_depth_test_half_point_size;
#endif
uniform bool u_bool_depth_test_disable;
uniform sampler2D u_color_tex_labeling;
uniform sampler2D u_depth_tex_labeling;
float color_test(const vec2 pos, const vec4 color)
{
    vec2 halfPointSize = u_vec2_depth_test_half_point_size;
    float result = 0.;
    
    if (texture2D(u_color_tex_labeling, (vec2(pos.x - halfPointSize.x, pos.y + halfPointSize.y) + 1.) / 2.) == color) {
        result++;
    }
    if (texture2D(u_color_tex_labeling, (pos + halfPointSize + 1.) / 2.) == color) {
        result++;
    }
    if (texture2D(u_color_tex_labeling, (pos - halfPointSize + 1.) / 2.) == color) {
        result++;
    }
    if (texture2D(u_color_tex_labeling, (vec2(pos.x + halfPointSize.x, pos.y - halfPointSize.y) + 1.) / 2.) == color) {
        result++;
    }
    
    return step(3., result);
}
float depth_test(const vec2 pos, const float depth, const vec4 color)
{
    if (u_bool_depth_test_disable == true) {
        return 1.;
    }
    float colorCheck = color_test(pos, color);
    if (colorCheck == 1.) {
        return 1.;
    }
    float d = (depth + 1.) / 2.;
    float delta = 0.001;
    float texDepth = texture2D(u_depth_tex_labeling, (pos + 1.) / 2.).r;
    if (d <= texDepth) {
        return 1.;
    }
    if (d - texDepth > delta) {
        return 0.;
    }
    return 1. - (d - texDepth) / delta;
}
`,GD=`uniform mat4 u_mat4_flat_mvp;
uniform mat4 u_mat4_ecef_mvp;
uniform float u_float_crossfade;
const float ECEF_CF_E = 2e-16;
const float ECEF_WORLD = 4294967296.;
vec4 get_clipspace(const vec3 fpos) {
    return u_mat4_flat_mvp * vec4(fpos, 1.);
}
vec4 get_clipspace(const vec3 fpos, const vec3 epos) {
    if (u_float_crossfade < ECEF_CF_E) {
        return u_mat4_flat_mvp * vec4(fpos, 1.);
    } else if (u_float_crossfade > (1. - ECEF_CF_E)) {
        return u_mat4_ecef_mvp * vec4(epos * ECEF_WORLD, 1.);
    }
    vec4 fclip = u_mat4_flat_mvp * vec4(fpos, 1.);
    vec4 eclip = u_mat4_ecef_mvp * vec4(epos * ECEF_WORLD, 1.);
    return mix(fclip, eclip, u_float_crossfade);
}
vec4 get_clipspace(const vec3 fpos, const vec3 epos, const float elevation) {
    float R = ECEF_WORLD + elevation;
    if (u_float_crossfade < ECEF_CF_E) {
        return u_mat4_flat_mvp * vec4(fpos, 1.);
    } else if (u_float_crossfade > (1. - ECEF_CF_E)) {
        return u_mat4_ecef_mvp * vec4(epos * R, 1.);
    }
    vec4 fclip = u_mat4_flat_mvp * vec4(fpos, 1.);
    vec4 eclip = u_mat4_ecef_mvp * vec4(epos * R, 1.);
    return mix(fclip, eclip, u_float_crossfade);
}
`,jD=`#ifndef UBO
# ifdef FOG
uniform float u_fog_distance;
# endif
# ifdef SKY
uniform mat4 u_mat4_view_transposed;
uniform mat4 u_mat4_proj_inverted;
# endif
#endif 
#if defined(FOG) || defined(SKY)
varying vec3 v_fog_pos;
#endif
void calc_fog_pos(vec3 world_pos) {
#ifdef FOG
    v_fog_pos = (world_pos - u_cam_pos) / u_fog_distance;
#endif
}
void calc_fog_pos_sky(vec4 pos) {
#ifdef SKY
    v_fog_pos = mat3(u_mat4_view_transposed) * (u_mat4_proj_inverted * pos).xyz;
#endif
}`,VD=`#ifdef TAA
uniform vec2 u_vec2_camera_jitter;
void apply_vertex_jitter(inout vec4 clipPos) {
    clipPos.xy += clipPos.w * u_vec2_camera_jitter;
}
#endif`,HD=`float calculate_final_width(
    const Scale scale,
    const float width,
    const float width_offset)
{
    
    float final_width = max(0., scale.calculation * width - scale.projection * width_offset);
    return final_width;
}
`,ZD=`uniform mat4 u_mat4_mvp;
`,$D=`
vec2 normalize_s08(vec2 value)
{
    return value * (1. / 127.);
}
vec3 normalize_s08(vec3 value)
{
    return value * (1. / 127.);
}
float normalize_s16(float value)
{
    return value * (1. / 32767.);
}
vec2 normalize_s16(vec2 value)
{
    return value * (1. / 32767.);
}
vec3 normalize_s16(vec3 value)
{
    return value * (1. / 32767.);
}
vec2 unpack_widen(vec2 widen_packed)
{
    
    return normalize_s08(widen_packed) * sqrt(2.);
}
vec2 unpack_texcoord(vec2 texcoord)
{
    return texcoord * (1. / 32768.);
}
vec2 unpack_model_texcoord(vec2 texcoord)
{
    const float min_value = -3.0;
    const float max_value = 5.0;
    return texcoord * (max_value - min_value) / 65536.0 + min_value;
}
`,WD=`
const float g_min_denominator = 1e-7;
const float g_max_factor = 10000.;
float calculate_multiplication_factor(
    vec2 half_viewport,
    
    vec4 clip_space_widen,
    vec4 clip_space_widen_perp,
    
    vec4 clip_space_vertex,
    float shift_pixels)
{
    float limited_factor = 0.;
    {
        
        vec2 screen_space_widen = (clip_space_widen.xy * clip_space_vertex.w - clip_space_vertex.xy * clip_space_widen.w) * half_viewport;
        vec2 screen_space_widen_perp = (clip_space_widen_perp.xy * clip_space_vertex.w - clip_space_vertex.xy * clip_space_widen_perp.w) * half_viewport;
        
        vec2 perp = vec2(screen_space_widen_perp.y, -screen_space_widen_perp.x);
        
        float perp_length = length(perp);
        vec4 v = clip_space_vertex;
        vec4 n = clip_space_widen;
        float denominator = dot(perp, screen_space_widen) / shift_pixels - n.w * v.w * perp_length;
        if (abs(denominator) > g_min_denominator)
        {
            float factor = v.w * v.w * perp_length / denominator;
            
            
            
            
            
            
            
            
            
            if (factor != factor){
                return limited_factor;
            }
            limited_factor = sign(factor) * min(g_max_factor, abs(factor));
        }
    }
    return limited_factor;
}
`,XD=`uniform mat4 u_mat4_model;
vec3 calc_pos_world(vec4 pos) {
    
    
    
    return (u_mat4_model * pos).xyz;
}
vec3 calc_pos_world(vec3 pos) {
    return calc_pos_world(vec4(pos, 1.0));
}
vec3 calc_pos_world(vec2 pos) {
    return calc_pos_world(vec4(pos, 0.0, 1.0));
}`,YD=`
const float g_circle_scale_precision_factor = 1e8;
`,qD=`#ifdef WEBGL2
#define varying out
#define attribute in
#define texture2D texture
#endif
#ifdef UBO
uniform CommonSettings
{
    mediump float u_float_rounding_factor;
    mediump float u_float_border_width_offset;
    mediump vec2 u_vec2_scale_limits;
    mediump vec2 u_vec2_depth_test_half_point_size;
    
    mediump vec4 u_fog_color;
    mediump vec2 u_fog_limits;
    mediump float u_fog_horizon_blend;
    mediump float u_fog_horizon_level;
    mediump float u_fog_distance;
    mediump vec4 u_sky_color;
    highp vec3 u_cam_pos;
    
    
    
    
    
    
    mediump vec4 u_shadow_map_params;
    highp mat4 u_mat4_clip_to_shadow;
    mediump float u_shadow_bias;
    mediump mat4 u_mat4_view_transposed;
    mediump mat4 u_mat4_proj_inverted;
    
    mediump vec2 u_vec2_halo_viewport_size;
    mediump vec2 u_vec2_halo_viewport_center_shift;
    mediump vec4 u_vec4_halo_radius_stops;
    mediump vec4 u_vec4_halo_color;
    mediump float u_float_halo_exp_factor;
    mediump vec4 u_vec4_default_background_color;
    
    mediump mat4 u_mat4_stars;
    mediump float u_float_pixelratio;
    mediump float u_float_stars_intensity;
};
#endif
`,KD=`
float unpack_scale(float value)
{
    return exp(abs(value) / 256.) * sign(value);
}
float unpack_positive_value(float value)
{
    return exp(value / 256.);
}
vec2 make_position(const vec2 position, const float w, const vec2 inv_half_size, const float rounding_factor)
{
    vec2 non_rounded_position = (position + w) / (w * inv_half_size);
    vec2 rounded_position = floor(non_rounded_position + 0.5);
    vec2 rounding_delta = rounded_position - non_rounded_position;
    vec2 pixel_coord = non_rounded_position + rounding_factor * rounding_delta - 0.5;
    return (pixel_coord * inv_half_size) * w - w;
}
vec2 overlay_transform(const vec2 position, const vec2 inv_half_size)
{
    
    
    return position * inv_half_size;
}
float clipw(const float w, const vec2 range, const float scale)
{
    return w * (step(unpack_scale(range.x), scale) - step(unpack_positive_value(range.y), scale));
}
vec2 rescale(const vec2 corner, const vec2 rescale, const vec2 scale_range, const float style_scale)
{
    
    
    if (scale_range.x < 0.)
    {
        float default_scale_denominator = unpack_positive_value(rescale.x);
        float rescale_coeff = unpack_positive_value(rescale.y);
        float min_scale = unpack_positive_value(-scale_range.x);
        float stretch_exponent = floor(0.5 + log2(
            max(1., 1. + rescale_coeff * (1. / max(min_scale, style_scale) - default_scale_denominator))));
        return corner.xy * exp2(stretch_exponent);
    }
    return corner;
}
`,JD=`
vec4 round_position(const vec4 position, const vec2 half_viewport)
{
    if (
        position.w < 0.
        || position.x < -position.w
        || position.x > position.w
        || position.y < -position.w
        || position.y > position.w
        || position.z < -position.w
        || position.z > position.w)
    {
        return position;
    }
    else
    {
        
        return vec4(
            sign(position.xy) * floor(abs(position.xy) * half_viewport / position.w + .5)
                * position.w / half_viewport,
            position.zw);
    }
}
`,QD=`#ifdef RENDER_SHADOWS
varying vec4 v_pos_from_light;
varying float v_depth_metric;
#ifndef UBO
uniform mat4 u_mat4_clip_to_shadow;
uniform mediump vec4 u_shadow_map_params;
uniform mediump float u_shadow_bias;
#endif
void compute_shadow_vertex(vec4 clip_pos)
{
    v_pos_from_light = u_mat4_clip_to_shadow * clip_pos;
    v_pos_from_light.z -= u_shadow_bias;
    v_depth_metric = 0.5 * v_pos_from_light.z + 0.5;
}
void compute_shadow_vertex(vec4 clip_pos, vec3 normal, mat4 mvp_mat)
{
    
    float normal_bias = u_shadow_map_params[3];
    vec3 norm_from_light = (u_mat4_clip_to_shadow * mvp_mat * vec4(normal, 0.0)).xyz;
    v_pos_from_light = u_mat4_clip_to_shadow * clip_pos;
    v_pos_from_light.xyz += normal_bias * normalize(norm_from_light);
    v_pos_from_light.z -= u_shadow_bias;
    v_depth_metric = 0.5 * v_pos_from_light.z + 0.5;
}
#else 
void compute_shadow_vertex(vec4 clip_pos) { }
void compute_shadow_vertex(vec4 clip_pos, vec3 normal, mat4 mvp_mat) { }
#endif `,eO=`struct PolylineDistance
{
    
    float vertex_distance_from_start;
    
    float segment_distance_from_start;
    
    float total_length;
};
struct StripedLineInParams
{
    float dash_length;
    float space_length;
    float dash2_length;
    float line_width;
};
struct StripedLineOutParams
{
    
    float part_color_swap_threshold;
    float distance_in_parts;
};
void calculate_line_params(in PolylineDistance polyline_distance, in StripedLineInParams striped_line_params, out StripedLineOutParams line_params)
{
    
    float requested_part_length =
        striped_line_params.dash_length
        + striped_line_params.space_length;
    
    float space2_length = requested_part_length - striped_line_params.dash2_length;
    
    float part_count = max(
        floor(polyline_distance.total_length / requested_part_length + 0.5),
        1.0);
    
    float part_length = polyline_distance.total_length / part_count;
    
    float dash_length = (part_length / requested_part_length) * striped_line_params.dash2_length;
    float part_color_swap_threshold = dash_length / part_length;
    
    
    float segment_start = fract((polyline_distance.segment_distance_from_start + 0.5 * dash_length) / part_length);
    float vertex_normalized_distance = segment_start + polyline_distance.vertex_distance_from_start / part_length;
    line_params = StripedLineOutParams(
        part_color_swap_threshold,
        vertex_normalized_distance);
}
`,tO=`#include <prelude>
#include <mvp_mat>
#include <packed_attributes>
#include <pixel_offset>
#include <signed_distance_functions>
#include <arrow_functions>
#include <calculate_scale>
#include <apply_opacity>
#include <pos_world>
#include <cam_pos>
#include <fog>
#ifndef UBO
uniform float u_float_border_width_offset;
uniform vec2 u_vec2_scale_limits;
#endif
uniform vec4 u_vec4_color;
uniform vec4 u_vec4_border_color;
uniform mediump vec2 u_vec2_vpt_size;
uniform vec3 u_vec3_projection_scale_style_scale_dpi;
uniform float u_float_width_zpt;
uniform float u_float_wing_height_multiplier;
uniform float u_float_wing_width_multiplier;
uniform float u_float_border_width_zpt;
uniform float u_float_size_factor;
uniform float u_float_tip_height_multiplier;
uniform float u_float_relative_end_position;
uniform float u_float_tip_movement_amplitude;
uniform float u_float_vertex_shift; 
uniform float u_float_opacity;
uniform float u_float_tip_radius_zpt;
uniform float u_float_wing_radius_zpt;
uniform float u_float_tail_radius_zpt;
attribute vec2 a_vec2_vertex;
attribute vec2 a_vec2_segment_end;
attribute vec4 a_vec4_texture_widen_arrow_widen;
attribute vec2 a_vec2_widen;
attribute vec2 a_vec2_direction; 
attribute float a_float_distance_from_start;
attribute float a_float_object_length;
attribute float a_float_type;
attribute vec4 a_vec4_identifier; 
varying vec2 v_vec2_line_type_arrow_tail;
varying vec4 v_vec4_arrow_width_length_border_outer;
varying vec4 v_vec4_texcoord_arrow_line;
varying vec4 v_vec4_distance_vertex_hiding;
varying vec4 v_vec4_identifier;
varying vec4 v_vec4_color;
varying vec4 v_vec4_border_color;
#ifdef ENTRANCE_ARROWS_ROUNDING
varying vec3 v_vec3_radius_tip_wing_tail;
#endif
varying vec4 v_vec4_circle_center_tip_wing;
const float g_w_factor = 1e-7;
const float g_type_line = 0.;
const float g_type_arrow = 1.;
const float g_type_start_border = 2.;
const float g_type_line_ending = 3.;
const float g_type_line_cut = 4.;
const float g_shift_pixels = 2.;
const float g_line_overlapping_part = .2;
struct ArrowLineViewParameters
{
    float vertex_type;
    float width_zpt;
    float border_width_zpt;
    float border_width_offset;
    float tip_radius_zpt;
    float wing_radius_zpt;
    float tail_radius_zpt;
    float arrow_segment_length_zpt;
    float tip_height_multiplier;
    float wing_height_multiplier;
    float wing_width_multiplier;
    float size_factor;
    vec2 vertex_position;
    vec2 vertex_widen;
    vec2 line_texture_widen;
    vec2 arrow_texture_widen;
    vec2 segment_direction;
    float segment_length;
    float distance_to_end;
};
struct DistanceShiftParameters
{
    float shift;
    bool invisible;
};
vec2 perp(const vec2 vector)
{
    return vec2(-vector.y, vector.x);
}
vec2 vertex_shift(const Scale scale)
{
    return u_float_vertex_shift * u_float_tip_movement_amplitude * normalize_s08(a_vec2_direction) * scale.calculation;
}
vec2 arrow_shift(const ArrowLineViewParameters view)
{
    
    
    
    return view.segment_direction * view.distance_to_end;
}
float erase_length_end()
{
    return clamp(u_float_relative_end_position, 0., 1.) * a_float_object_length;
}
void set_texcoord_varyings(const vec2 arrow_texcoord, const vec2 line_texcoord)
{
    v_vec4_texcoord_arrow_line = vec4(arrow_texcoord, line_texcoord);
}
void set_arrow_varyings(
    const float arrow_width,
    const float arrow_length,
    const float arrow_border,
    const float arrow_outer_width,
    const float arrow_tail_hide_part,
    const float arrow_tip_radius,
    const float arrow_wing_radius,
    const float tail_radius,
    const vec2 tip_circle_center,
    const vec2 wing_circle_center)
{
    v_vec4_arrow_width_length_border_outer = vec4(
        arrow_width,
        arrow_length,
        arrow_border,
        arrow_outer_width);
    v_vec2_line_type_arrow_tail = vec2(
        a_float_type,
        arrow_tail_hide_part);
    #ifdef ENTRANCE_ARROWS_ROUNDING
    v_vec3_radius_tip_wing_tail = vec3(
        arrow_tip_radius,
        arrow_wing_radius,
        tail_radius);
    #endif
    v_vec4_circle_center_tip_wing = vec4(tip_circle_center.xy, wing_circle_center.xy);
}
DistanceShiftParameters calculate_entrance_arrow_distances(
    const ArrowLineViewParameters view,
    const float signed_distance_shift,
    const float arrow_final_size,
    const float entrance_arrow_distance_shift)
{
    DistanceShiftParameters line_distance_parameters = DistanceShiftParameters(
        signed_distance_shift + entrance_arrow_distance_shift,
        false);
    if (a_float_type == g_type_arrow)
    {
        
        
        bool outside_of_current_segment = view.distance_to_end > view.segment_length + entrance_arrow_distance_shift;
        
        bool inside_end_hide = a_float_distance_from_start + entrance_arrow_distance_shift > erase_length_end();
        return DistanceShiftParameters(
            
            line_distance_parameters.shift + view.distance_to_end,
            outside_of_current_segment || inside_end_hide
        );
    }
    else
    {
        return line_distance_parameters;
    }
}
void set_distance_varyings(
    const ArrowLineViewParameters view,
    const float arrow_final_size,
    const float signed_shift_distance)
{
    float entrance_arrow_distance_shift = arrow_final_size * (2. - g_line_overlapping_part);
    DistanceShiftParameters distance_shift_parameters = calculate_entrance_arrow_distances(
        view,
        signed_shift_distance,
        arrow_final_size,
        entrance_arrow_distance_shift);
    v_vec4_distance_vertex_hiding =
        vec4(
            a_float_distance_from_start + distance_shift_parameters.shift,
            0.,
            erase_length_end(),
            distance_shift_parameters.invisible
                ? a_float_object_length
                : 0.
        ) / a_float_object_length;
}
ArrowLineViewParameters decode_arrow_line_view_parameters()
{
    float width_zpt = u_float_width_zpt;
    float border_width_zpt = u_float_border_width_zpt;
    float arrow_segment_length_zpt = width_zpt * u_float_tip_height_multiplier + border_width_zpt;
    float vertex_type = a_float_type;
    
    vec2 segment_direction = (vertex_type == g_type_line_ending || vertex_type == g_type_line_cut)
        ? normalize(a_vec2_vertex - a_vec2_segment_end)
        : normalize(a_vec2_segment_end - a_vec2_vertex);
    float segment_length = length(a_vec2_segment_end - a_vec2_vertex);
    float distance_to_end = erase_length_end() - a_float_distance_from_start;
    return ArrowLineViewParameters(
        vertex_type,
        width_zpt,
        border_width_zpt,
        u_float_border_width_offset,
        u_float_tip_radius_zpt,
        u_float_wing_radius_zpt,
        u_float_tail_radius_zpt,
        arrow_segment_length_zpt,
        u_float_tip_height_multiplier,
        u_float_wing_height_multiplier,
        u_float_wing_width_multiplier,
        u_float_size_factor,
        a_vec2_vertex,
        unpack_widen(a_vec2_widen),
        unpack_widen(a_vec4_texture_widen_arrow_widen.xy),
        unpack_widen(a_vec4_texture_widen_arrow_widen.zw),
        segment_direction,
        segment_length,
        distance_to_end);
}
vec4 process_arrow_line_vertex(const Scale scale, const mat4 mvp, const vec2 vpt_size)
{
    ArrowLineViewParameters view = decode_arrow_line_view_parameters();
    
    ArrowParameters arrow_parameters = calculate_arrow_parameters(
        scale.calculation,
        view.width_zpt,
        view.border_width_zpt,
        view.arrow_segment_length_zpt,
        view.wing_width_multiplier,
        view.wing_height_multiplier,
        view.tip_height_multiplier,
        view.size_factor);
    vec2 vertex_widen = view.vertex_widen;
    vec2 texture_widen_with_sign = view.line_texture_widen;
    
    
    float shift_sign = sign(dot(vertex_widen, texture_widen_with_sign));
    vec2 line_texture_widen = shift_sign * texture_widen_with_sign;
    
    float line_final_size = (view.width_zpt + 2. * view.border_width_zpt) * view.size_factor * scale.calculation;
    float final_size = (view.vertex_type == g_type_arrow)
        ? arrow_parameters.final_size
        : line_final_size;
    
    
    
    
    vec2 line_texture_widen_perp = perp(line_texture_widen);
    float shift_distance = abs(dot(vertex_widen, line_texture_widen_perp)) * final_size;
    vec2 shift_direction = line_texture_widen_perp * sign(dot(vertex_widen, line_texture_widen_perp));
    vec2 line_vertex_shift = vertex_widen * final_size - shift_direction * max(0., shift_distance - .5 * view.segment_length);
    
    vec2 arrow_vertex_widen = vertex_widen * arrow_parameters.final_size;
    vec2 scene_vertex_shift = (view.vertex_type == g_type_arrow)
        ? arrow_vertex_widen
        : line_vertex_shift;
    vec2 arrow_position_shift = (view.vertex_type == g_type_arrow)
        ? arrow_shift(view)
        : vec2(0.);
    
    float shift_pixels = g_shift_pixels * sqrt(2.);
    VertexShiftParameters line_shift_parameters = calculate_vertex_shift_parameters(
        mvp,
        vpt_size,
        view.vertex_position + (vertex_shift(scale) + arrow_position_shift),
        scene_vertex_shift,
        shift_pixels);
    float arrow_line_texcoord_scale = line_final_size / arrow_parameters.final_size;
    float line_texcoord_scale = (view.vertex_type != g_type_arrow)
        ? arrow_line_texcoord_scale
        : 1.;
    vec2 line_texcoord = line_texture_widen * (1. + line_shift_parameters.limited_factor) * line_texcoord_scale;
    
    float arrow_texcoord_scale = (view.vertex_type == g_type_start_border)
        ? arrow_line_texcoord_scale
        : 1.;
    vec2 arrow_texcoord = view.arrow_texture_widen * (1. + line_shift_parameters.limited_factor) * arrow_texcoord_scale;
    set_texcoord_varyings(arrow_texcoord, line_texcoord);
    float arrow_width = view.width_zpt * arrow_parameters.zpt_to_texcoord_factor;
    float arrow_length = view.arrow_segment_length_zpt * arrow_parameters.zpt_to_texcoord_factor;
    float arrow_tip_radius = view.tip_radius_zpt * arrow_parameters.zpt_to_texcoord_factor;
    float arrow_wing_radius = view.wing_radius_zpt * arrow_parameters.zpt_to_texcoord_factor;
    float tail_radius = view.tail_radius_zpt * arrow_parameters.zpt_to_texcoord_factor;
    
    float texcoord_border_width = view.border_width_zpt * arrow_parameters.zpt_to_texcoord_factor;
    float border_width_texcoord_offset = view.border_width_offset * arrow_parameters.zpt_to_texcoord_factor;
    float arrow_border = max(0., texcoord_border_width - scale.style / scale.style_clamped * border_width_texcoord_offset);
    
    float tail_shift_direction = (view.vertex_type == g_type_line_ending || view.vertex_type == g_type_start_border) ? 1. : -1.;
    float tail_hide_shift = dot(arrow_vertex_widen, tail_shift_direction * view.segment_direction);
    float arrow_tail_hide_part = (view.distance_to_end - tail_hide_shift) * arrow_parameters.zpt_to_texcoord_factor / view.size_factor;
    
    
    float half_length = arrow_length / 2.;
    float arrow_height = arrow_width * (view.tip_height_multiplier - view.wing_height_multiplier);
    float A1 = arrow_parameters.tip_normal.x;
    float B1 = arrow_parameters.tip_normal.y;
    float C1 = -half_length * A1 - arrow_border + arrow_wing_radius;
    float A2 = arrow_parameters.wing_normal.x;
    float B2 = arrow_parameters.wing_normal.y;
    float C2 = (arrow_height - half_length) * A2 - arrow_border + arrow_wing_radius;
    float denominator = A1 * B2 - A2 * B1;
    float wing_circle_center_x = (C2 * B1 - C1 * B2) / denominator;
    float wing_circle_center_y = (A2 * C1 - A1 * C2) / denominator;
    vec2 wing_circle_center = vec2(wing_circle_center_x, wing_circle_center_y);
    vec2 tip_circle_center = vec2(half_length - (arrow_tip_radius - arrow_border) / arrow_parameters.tip_normal.x, 0.);
    set_arrow_varyings(
        arrow_width,
        arrow_length,
        arrow_border,
        arrow_parameters.outer_width,
        arrow_tail_hide_part,
        arrow_tip_radius,
        arrow_wing_radius,
        tail_radius,
        tip_circle_center,
        wing_circle_center);
    set_distance_varyings(
        view,
        arrow_parameters.final_size,
        shift_sign * shift_distance);
    
    
    return line_shift_parameters.clip_space_vertex / final_size;
}
void main()
{
    v_vec4_identifier = a_vec4_identifier; 
    Scale scale = calculate_scale(u_vec3_projection_scale_style_scale_dpi, u_vec2_scale_limits);
    vec4 processed_vertex = process_arrow_line_vertex(scale, u_mat4_mvp, u_vec2_vpt_size);
    gl_Position = processed_vertex * g_w_factor;
    v_vec4_color = apply_opacity(u_vec4_color, u_float_opacity);
    v_vec4_border_color = apply_opacity(u_vec4_border_color, u_float_opacity);
    
    vec3 pos_world = calc_pos_world(a_vec2_vertex);
    calc_fog_pos(pos_world);
}
`,iO=`#include <prelude>
#include <mvp_mat>
#include <dem>
#include <apply_height_factor>
uniform float u_float_height_factor;
uniform float u_float_floor_elevation;
attribute vec3 a_vec3_vertex;
attribute vec2 a_vec2_dem_position;
attribute float a_float_visibility;
varying float v_depth_metric;
void main()
{
    float height = dem_height(unpack_dem_position(a_vec2_dem_position));
    
    
    
    if (height == DEM_INVALID_VALUE || a_float_visibility == 0.0) {
        gl_Position = vec4(0, 0, 1, 1);
        return;
    }
    height += u_float_floor_elevation;
    vec4 vertex_hf = apply_height_factor(a_vec3_vertex, u_float_height_factor);
    vertex_hf.z += height;
    
    vertex_hf.z = max(vertex_hf.z, height);
    gl_Position = u_mat4_mvp * vertex_hf;
    v_depth_metric = (gl_Position.z + 1.0) / 2.0;
}`,nO=`#include <prelude>
#include <ecef_mvp_mat>
#include <pos_world>
#include <cam_pos>
#include <shadow>
#include <fog>
attribute vec3 a_vec3_flat_position;
attribute vec3 a_vec3_ecef_position;
attribute vec2 a_vec2_widen;
uniform vec2 u_vec2_vpt_size;
uniform float u_float_width;
varying vec2 v_vec2_circle;
varying float v_float_width;
void main() {
    vec4 pos = get_clipspace(a_vec3_flat_position, a_vec3_ecef_position);
    vec4 ndc_position = pos / pos.w;
    ndc_position.xy += a_vec2_widen * u_float_width / u_vec2_vpt_size;
    gl_Position = ndc_position;
    v_vec2_circle = a_vec2_widen;
    v_float_width = u_float_width;
    vec3 pos_world = calc_pos_world(a_vec3_flat_position);
    calc_fog_pos(pos_world);
}
`,sO=`#include <prelude>
#include <ecef_mvp_mat>
attribute vec3 a_vec3_flat_position;
attribute vec3 a_vec3_ecef_position;
attribute vec2 a_vec2_widen;
attribute vec4 a_vec4_identifier;
uniform vec2 u_vec2_vpt_size;
uniform float u_float_width;
varying vec2 v_vec2_circle;
varying vec4 v_vec4_identifier;
void main() {
    v_vec2_circle = a_vec2_widen;
    v_vec4_identifier = a_vec4_identifier;
    if (vec4(1., 1., 1., 1.) != a_vec4_identifier)
    {
        vec4 pos = get_clipspace(a_vec3_flat_position, a_vec3_ecef_position);
        vec4 ndc_position = pos / pos.w;
        ndc_position.xy += a_vec2_widen * u_float_width / u_vec2_vpt_size;
        gl_Position = ndc_position;
    }
    else
    {
        gl_Position = vec4(1., 1., 1., 1.);
    }
}
`,oO=`#include <prelude>
#include <mvp_mat>
#include <apply_opacity>
#include <pos_world>
#include <cam_pos>
#include <fog>
#include <jitter>
#include <shadow>
uniform vec4 u_vec4_color;
uniform float u_float_opacity;
uniform float u_float_floor_elevation;
attribute vec2 a_vec2_vertex;
attribute float a_float_visibility;
varying vec4 v_vec4_color;
varying vec2 v_vec2_texcoord;
void main()
{
    if (a_float_visibility == 0.0) {
        gl_Position = vec4(0, 0, 0, 1);
        return;
    }
    v_vec4_color = apply_opacity(u_vec4_color, u_float_opacity);
    gl_Position = u_mat4_mvp * vec4(a_vec2_vertex, u_float_floor_elevation, 1.0);
    vec3 pos_world = calc_pos_world(a_vec2_vertex);
    calc_fog_pos(pos_world);
    
    
    
    
    
    
    v_vec2_texcoord = fract(abs((a_vec2_vertex - 0.25) * 2.));
#ifdef TAA
    apply_vertex_jitter(gl_Position);
#endif
    compute_shadow_vertex(gl_Position, vec3(0.0, 0.0, 1.0), u_mat4_mvp);
}
`,rO=`#include <prelude>
#include <mvp_mat>
#include <round_position>
uniform vec2 u_vec2_vpt_size;
uniform float u_float_floor_elevation;
attribute vec2 a_vec2_vertex;
attribute vec4 a_vec4_identifier;
attribute float a_float_visibility;
varying vec4 v_vec4_identifier;
void main()
{
    v_vec4_identifier = a_vec4_identifier;
    if (vec4(1., 1., 1., 1.) != a_vec4_identifier && a_float_visibility != 0.0)
    {
        gl_Position = round_position(u_mat4_mvp * vec4(a_vec2_vertex, u_float_floor_elevation, 1.), .5 * u_vec2_vpt_size);
    }
    else
    {
        gl_Position = vec4(1., 1., 1., 1.);
    }
}
`,aO=`#include <prelude>
#include <mvp_mat>
#include <packed_attributes>
attribute vec2 a_vec2_vertex;
attribute float a_float_height;
varying float v_float_height;
void main()
{
    gl_Position = u_mat4_mvp * vec4(a_vec2_vertex, 0.0, 1.0);
    v_float_height = a_float_height;
}
`,lO=`#include <prelude>
#include <mvp_mat>
#include <packed_attributes>
uniform mat4 u_mat4_dem_corrected;
attribute vec2 a_vec2_vertex;
attribute vec2 a_vec2_texcoord;
varying vec2 v_vec2_texcoord;
void main()
{
    gl_Position = u_mat4_mvp * vec4(a_vec2_vertex, 0.0, 1.0);
    v_vec2_texcoord = (u_mat4_dem_corrected * vec4(unpack_texcoord(a_vec2_texcoord), 0, 1)).xy;
}
`,cO=`#include <prelude>
#include <mvp_mat>
#include <dem>
attribute vec2 a_vec2_vertex;
attribute vec2 a_vec2_centroid;
attribute vec2 a_vec2_extender;
varying vec4 v_vec4_color;
void main()
{
    vec4 tex_pos = u_mat4_dem_corrected * u_mat4_mvp * vec4(unpack_dem_position(a_vec2_centroid), 0.0, 1.0);
    v_vec4_color = texture2D(u_tex_dem, tex_pos.xy);
    gl_Position = u_mat4_mvp * vec4(a_vec2_vertex + a_vec2_extender * 1./64., 0.0, 1.0);
}
`,dO=`#include <prelude>
#include <mvp_mat>
#include <dem>
uniform mat4 u_mat4_model;
attribute vec2 a_vec2_position;
varying vec4 v_vec4_coords;
void main()
{
    vec4 tex_pos = u_mat4_dem_mvp * vec4(a_vec2_position, 0.0, 1.0);
    float height = dem_height_direct_meters(tex_pos.xy / tex_pos.w);
    if (height == DEM_INVALID_VALUE) {
        gl_Position = u_mat4_mvp * vec4(a_vec2_position, 0.0, 1.0);
        v_vec4_coords = vec4(0);
    } else {
        float tile_height = meters_to_tile_height(height);
        gl_Position = u_mat4_mvp * vec4(a_vec2_position, tile_height, 1.0);
        v_vec4_coords = u_mat4_model * vec4(a_vec2_position, 0, 1.0);
        
        v_vec4_coords[2] = height;
    }
}
`,hO=`#include <prelude>
#include <mvp_mat>
#include <dem>
uniform mat4 u_mat4_model;
attribute vec2 a_vec2_vertex;
attribute float a_float_height;
varying vec4 v_vec4_coords;
void main()
{
    float tile_height = meters_to_tile_height(a_float_height);
    gl_Position = u_mat4_mvp * vec4(a_vec2_vertex, tile_height, 1.0);
    v_vec4_coords = u_mat4_model * vec4(a_vec2_vertex, 0, 1.0);
    
    v_vec4_coords[2] = a_float_height;
}
`,uO=`#include <prelude>
#include <mvp_mat>
#include <dem>
#include <pos_world>
#include <cam_pos>
#include <shadow>
#include <fog>
#include <jitter>
uniform mat4 u_mat4_flat_map_mvp;
attribute vec2 a_vec2_position;
varying vec4 v_vec4_texcoord;
varying vec2 hs_tex_pos;
void main()
{
    vec4 coords = u_mat4_mvp * vec4(a_vec2_position, 0.0, 1.0);
    vec4 tex_pos = u_mat4_dem_mvp * vec4(a_vec2_position, 0.0, 1.0);
    float height = dem_height_direct(tex_pos.xy / tex_pos.w);
    if (height == DEM_INVALID_VALUE) {
        gl_Position = coords;
        v_vec4_texcoord = vec4(a_vec2_position, 1., 0);
    } else {
        gl_Position = u_mat4_mvp * vec4(a_vec2_position, height, 1.0);
        vec4 flat_coord = u_mat4_flat_map_mvp * vec4(a_vec2_position, 0.0, 1.0);
        v_vec4_texcoord = vec4(flat_coord.xy, 0., flat_coord.w);
        hs_tex_pos = tex_pos.xy;
    }
    vec3 pos_world = calc_pos_world(vec4(a_vec2_position, height, 1.0));
    calc_fog_pos(pos_world);
#ifdef TAA
    apply_vertex_jitter(gl_Position);
#endif
    
    compute_shadow_vertex(gl_Position, vec3(0.0, 0.0, 1.0), u_mat4_mvp);
}
`,fO=`#include <prelude>
#include <mvp_mat>
#include <dem>
#include <pos_world>
#include <cam_pos>
#include <shadow>
#include <fog>
#include <jitter>
uniform mat4 u_mat4_flat_map_mvp;
attribute vec2 a_vec2_vertex;
attribute float a_float_height;
attribute vec3 a_vec3_normal;
varying vec4 v_vec4_texcoord;
varying vec3 v_vec3_position;
varying vec3 v_vec3_normal;
uniform mediump float u_use_flat_dem_mesh_normals;
void main() {
    
    
    v_vec3_normal = a_vec3_normal;
    float height_tile = meters_to_tile_height(a_float_height);
    vec4 tex_pos = u_mat4_dem_mvp * vec4(a_vec2_vertex, 0.0, 1.0);
    gl_Position = u_mat4_mvp * vec4(a_vec2_vertex, height_tile, 1.0);
    vec4 flat_coord = u_mat4_flat_map_mvp * vec4(a_vec2_vertex, 0., 1.0);
    v_vec4_texcoord = vec4(flat_coord.xy, 1., flat_coord.w);
    vec3 pos_world = calc_pos_world(vec4(a_vec2_vertex, height_tile, 1.0));
    
    
    mat4 rotation_scale_mat = u_mat4_model;
    rotation_scale_mat[3].xyz = vec3(0);
    v_vec3_position = (rotation_scale_mat * vec4(a_vec2_vertex, height_tile, 1)).xyz;
    calc_fog_pos(pos_world);
#ifdef TAA
    apply_vertex_jitter(gl_Position);
#endif
    
    compute_shadow_vertex(gl_Position, vec3(0.0, 0.0, 1.0), u_mat4_mvp);
}
`,_O=`#include <prelude>
#include <mvp_mat>
#include <packed_attributes>
attribute vec2 a_vec2_vertex;
attribute vec2 a_vec2_texcoord;
varying vec2 v_vec2_texcoord;
void main()
{
    gl_Position = vec4((a_vec2_vertex * 2. - vec2(1, 1)), 0.0, 1.0);
    v_vec2_texcoord = unpack_texcoord(a_vec2_texcoord);
}
`,mO=`#include <prelude>
#include <mvp_mat>
#include <dem>
#include <packed_attributes>
#include <apply_height_factor>
#include <apply_opacity>
#include <pos_world>
#include <cam_pos>
#include <fog>
#include <clipspace_pos>
#include <jitter>
#include <shadow>
uniform vec4 u_vec4_color;
uniform mat4 u_mat4_gradient;
uniform float u_float_height_factor;
uniform float u_float_opacity;
uniform float u_float_floor_elevation;
attribute vec4 a_vec4_vertex; 
attribute vec2 a_vec2_dem_position;
attribute float a_float_visibility;
varying vec4 v_vec4_color;
varying mat4 v_mat4_gradient;
varying vec4 v_vec4_rotated_scaled_vertex;
const float g_wall_offset_isometric = .001;
const float g_wall_offset_perspective = 8.;
void main()
{
    float height = dem_height(unpack_dem_position(a_vec2_dem_position));
    
    
    
    if (height == DEM_INVALID_VALUE || a_float_visibility == 0.0) {
        gl_Position = vec4(0, 0, 1, 1);
        return;
    }
    height += u_float_floor_elevation;
    vec4 vertex_hf = apply_height_factor(a_vec4_vertex.xyz, u_float_height_factor);
    vertex_hf.z += height;
    
    vertex_hf.z = max(vertex_hf.z, height);
    vec4 clip_pos = u_mat4_mvp * vertex_hf;
    gl_Position = clip_pos;
    
    
    
    if (a_vec4_vertex.w == .0)
    {
        
        if ((u_mat4_mvp[0][3] == 0.) && (u_mat4_mvp[1][3] == 0.) && (u_mat4_mvp[2][3] == 0.))
        {
            gl_Position.z += g_wall_offset_isometric;
        }
        else
        {
            
            
            
            if (height == 0.) {
                gl_Position.z += g_wall_offset_perspective;
            } else {
                gl_Position.z += g_wall_offset_isometric;
            }
        }
    }
    vec3 pos_world = calc_pos_world(vertex_hf);
    calc_fog_pos(pos_world);
    save_clipspace_pos();
#ifdef TAA
    apply_vertex_jitter(gl_Position);
#endif
    
    
    mat4 rotation_scale_mat = u_mat4_model;
    rotation_scale_mat[3].xyz = vec3(0);
    v_vec4_rotated_scaled_vertex.xyz = (rotation_scale_mat * a_vec4_vertex).xyz;
    v_vec4_color = apply_opacity(u_vec4_color, u_float_opacity);
    if (u_mat4_gradient[0][0] !=0.)
    {
        
        if (a_vec4_vertex.z > 0.0)
        {
            v_vec4_rotated_scaled_vertex.w = 1.;
        } else {
            v_vec4_rotated_scaled_vertex.w = 0.;
        }
        v_mat4_gradient = u_mat4_gradient;
        for (int i = 1; i <= 2; i++) {
            v_mat4_gradient[i] = apply_opacity(v_mat4_gradient[i], u_float_opacity);
        }
    }
    
    compute_shadow_vertex(clip_pos);
}
`,pO=`#include <prelude>
#include <mvp_mat>
#include <dem>
#include <round_position>
#include <apply_height_factor>
uniform vec2 u_vec2_vpt_size;
uniform float u_float_height_factor;
uniform float u_float_floor_elevation;
attribute vec3 a_vec4_vertex;
attribute vec4 a_vec4_identifier;
attribute vec2 a_vec2_dem_position;
attribute float a_float_visibility;
varying vec4 v_vec4_identifier;
void main()
{
    float height = dem_height(unpack_dem_position(a_vec2_dem_position));
    
    
    
    
    if (height == DEM_INVALID_VALUE || a_float_visibility == 0.0 || a_vec4_identifier == vec4(1., 1., 1., 1.)) {
        gl_Position = vec4(0, 0, 1, 1);
        return;
    }
    height += u_float_floor_elevation;
    v_vec4_identifier = a_vec4_identifier;
    vec4 vertex_hf = apply_height_factor(a_vec4_vertex.xyz, u_float_height_factor);
    vertex_hf.z += height;
    
    vertex_hf.z = max(vertex_hf.z, height);
    gl_Position = round_position(
        u_mat4_mvp * vertex_hf,
        .5 * u_vec2_vpt_size);
}
`,gO=`#include <prelude>
#include <ecef_mvp_mat>
attribute vec3 a_vec3_ecef_position;
attribute vec3 a_vec3_flat_position;
attribute vec2 a_vec2_texture;
uniform vec4 u_vec4_extent;
varying vec2 v_vec2_texture;
void main()
{
    v_vec2_texture = a_vec2_texture;
    vec4 pos = get_clipspace(a_vec3_flat_position, a_vec3_ecef_position);
    gl_Position = pos;
}`,vO=`#include <prelude>
#ifndef UBO
uniform mediump vec2 u_vec2_halo_viewport_size;
uniform mediump vec2 u_vec2_halo_viewport_center_shift;
uniform mediump vec4 u_vec4_halo_radius_stops;
uniform mediump float u_float_halo_exp_factor;
#endif
attribute vec2 a_vec2_vertex;
varying vec2 v_vec2_uv;
void main() {
    
    
    
    
    
    
    
    float globe_halo_padding_factor = log(0.005) / u_float_halo_exp_factor;
    
    vec4 pixel_radius_stops = u_vec4_halo_radius_stops * u_vec2_halo_viewport_size.y;
    
    
    
    
    float maxR = pixel_radius_stops[1] + (pixel_radius_stops[3] - pixel_radius_stops[1]) * globe_halo_padding_factor;
    
    float scale = maxR / u_vec2_halo_viewport_size.y;
    v_vec2_uv = a_vec2_vertex * scale;
    vec2 center = u_vec2_halo_viewport_size / 2.0 + u_vec2_halo_viewport_center_shift;
    vec2 p = center - a_vec2_vertex * maxR;
    vec2 p_result = 2.0 * (p - 0.5 * u_vec2_halo_viewport_size) / u_vec2_halo_viewport_size;
    gl_Position = vec4(p_result, 0.0, 1.0);
}
`,yO=`#include <prelude>
#include <ecef_mvp_mat>
#include <dem>
#include <packed_attributes>
#include <pos_world>
#include <cam_pos>
#include <fog>
#include <clipspace_pos>
#include <jitter>
#include <shadow>
#define EPSILON (0.0001)
#define DEM_POS_INSTANCE 0
#define DEM_POS_FLAT 1
#define DEM_POS_AXIS 2
#define DEM_POS_CENTROID 3
uniform mat4 u_mat4_instance;
uniform vec2 u_vec2_anchor;
uniform vec4 u_vec4_axis;
uniform int u_int_gltf_dem_pos;
uniform mat4 u_mat4_localmatrix;
uniform float u_float_height_factor;
uniform float u_float_show_ratio;
uniform mediump int u_int_identify;
uniform float u_float_floor_elevation;
attribute vec3 a_position;
attribute vec3 a_normal;
attribute vec2 a_tangent;
attribute vec3 a_vec3_instance_position;
#ifndef MALI_GPU
attribute vec3 a_vec3_instance_ecef_position;
#endif
attribute mat3 a_mat3_instance_matrix;
attribute vec4 a_vec4_instance_localid;
attribute float a_float_abs_z;
#ifdef COLOR_TEXTURE
attribute vec2 texcoord_color;
#endif
#ifdef AO_TEXTURE
attribute vec2 texcoord_ao;
#endif
#ifdef PBR_TEXTURE
attribute vec2 texcoord_pbr;
#endif
varying vec4 v_vec4_identifier;
varying vec3 v_vec3_normal;
varying vec3 v_vec3_fragment_pos_world;
#ifdef MAP_MESH_TEXTURE
varying vec4 v_tex_coord;
#endif
#ifdef COLOR_TEXTURE
varying vec2 v_vec2_texcoord_color;
#endif
#ifdef AO_TEXTURE
varying vec2 v_vec2_texcoord_ao;
#endif
#ifdef PBR_TEXTURE
varying vec2 v_vec2_texcoord_pbr;
#endif
varying float v_float_opacity;
void calc_texcoords(vec4 vh) {
    #ifdef MAP_MESH_TEXTURE
    v_tex_coord = u_mat4_mvp * vec4(vh.xy, 0, 1.0);
    #endif
    #if defined(COLOR_TEXTURE)
    v_vec2_texcoord_color = texcoord_color;
    #endif
    #ifdef AO_TEXTURE
    v_vec2_texcoord_ao = texcoord_ao;
    #endif
    #ifdef PBR_TEXTURE
    v_vec2_texcoord_pbr = texcoord_pbr;
    #endif
}
float interleaved_gradient_noise(vec3 coords)
{
    const vec3 m = vec3(0.06711056, 0.00583715, 52.9829189);
    return fract(m.z * fract(dot(coords.xy, m.xy)));
}
const float FADE_AMMOUNT = 0.12;
void main()
{
    if (u_int_identify != 0 && a_vec4_instance_localid == vec4(1., 1., 1., 1.)) {
        gl_Position = vec4(0, 0, 0, 0);
        return;
    }
    mat4 instance_matrix = mat4(
        vec4(a_mat3_instance_matrix[0], 0),
        vec4(a_mat3_instance_matrix[1], 0),
        vec4(a_mat3_instance_matrix[2], 0),
        vec4(0, 0, 0, 1)
    );
    float height = 0.;
    
    if (u_int_gltf_dem_pos == DEM_POS_CENTROID) {
        vec4 center = (instance_matrix * u_mat4_localmatrix) * vec4(u_vec2_anchor.x, 0, u_vec2_anchor.y, 1);
        center *= u_mat4_instance;
        center.xy += a_vec3_instance_position.xy;
        height = dem_height(center.xy);
    } else if (u_int_gltf_dem_pos == DEM_POS_AXIS)  {
        vec2 a = a_position.xz - u_vec4_axis.xy;
        vec2 b = u_vec4_axis.zw - u_vec4_axis.xy;
        float b_length = length(b);
        a /= b_length;
        b /= b_length;
        float coef = clamp(dot(a, b), 0., 1.);
        vec4 axis_start = (instance_matrix * u_mat4_localmatrix) * vec4(u_vec4_axis.x, 0, u_vec4_axis.y, 1);
        axis_start *= u_mat4_instance;
        axis_start.xy += a_vec3_instance_position.xy;
        float height_start = dem_height(axis_start.xy);
        vec4 axis_end = (instance_matrix * u_mat4_localmatrix) * vec4(u_vec4_axis.z, 0, u_vec4_axis.w, 1);
        axis_end *= u_mat4_instance;
        axis_end.xy += a_vec3_instance_position.xy;
        float height_end = dem_height(axis_end.xy);
        height = mix(height_start, height_end, coef);
    } else if (u_int_gltf_dem_pos == DEM_POS_FLAT) {
        vec4 pos = (instance_matrix * u_mat4_localmatrix) * vec4(a_position, 1);
        pos *= u_mat4_instance;
        pos.xy += a_vec3_instance_position.xy;
        height = dem_height(pos.xy);
    } else {
        height = dem_height(a_vec3_instance_position.xy);
    }
    
    if (height == DEM_INVALID_VALUE) {
        gl_Position = vec4(0, 0, 1, 1);
        return;
    }
    height += u_float_floor_elevation;
    if (u_float_show_ratio < 1.0) {
        vec3 instance_wp = a_mat3_instance_matrix * a_vec3_instance_position;
        float noise = interleaved_gradient_noise(instance_wp);
        if (noise > u_float_show_ratio) {
            gl_Position = vec4(0,0,0,0);
            return;
        }
        v_float_opacity = clamp(u_float_show_ratio - noise, 0., FADE_AMMOUNT) / FADE_AMMOUNT;
    } else {
        v_float_opacity = 1.;
    }
    v_vec4_identifier = a_vec4_instance_localid;
    vec4 vertex = (instance_matrix * u_mat4_localmatrix) * vec4(a_position, 1.);
    vertex *= u_mat4_instance;
    vertex.xyz *= v_float_opacity;
    vertex.z *= u_float_height_factor;
    vec4 vflat = vec4(a_vec3_instance_position, 1.);
    vflat.z += height;
    vflat.xyz += vertex.xyz;
    vec3 pos_world = calc_pos_world(vflat);
    calc_fog_pos(pos_world);
#ifdef MALI_GPU
    
    
    
    gl_Position = get_clipspace(vflat.xyz);
#else
    vec4 vecef = vec4(a_vec3_instance_ecef_position, 1.);
    vecef.xyz += vertex.xyz;
    gl_Position = get_clipspace(vflat.xyz, vecef.xyz, a_float_abs_z);
#endif
    calc_texcoords(vflat);
    
    v_vec3_normal = ((instance_matrix * u_mat4_localmatrix) * vec4(a_normal, 0)).xyz;
    v_vec3_fragment_pos_world = pos_world;
#ifdef TAA
    apply_vertex_jitter(gl_Position);
#endif
    save_clipspace_pos();
    compute_shadow_vertex(gl_Position, v_vec3_normal, u_mat4_flat_mvp);
}
`,wO=`#include <prelude>
#include <ecef_mvp_mat>
#include <dem>
#include <packed_attributes>
uniform mat4 u_mat4_instance;
uniform mat4 u_mat4_localmatrix;
uniform float u_float_height_factor;
uniform float u_float_show_ratio;
attribute vec3 a_position;
attribute vec3 a_vec3_instance_position;
#ifndef MALI_GPU
attribute vec3 a_vec3_instance_ecef_position;
#endif
attribute mat3 a_mat3_instance_matrix;
attribute float a_float_abs_z;
varying float v_depth_metric;
const float FADE_AMMOUNT = 0.12;
float interleaved_gradient_noise(vec3 coords)
{
    const vec3 m = vec3(0.06711056, 0.00583715, 52.9829189);
    return fract(m.z * fract(dot(coords.xy, m.xy)));
}
void main()
{
    float height = dem_height(a_vec3_instance_position.xy);
    
    if (height == DEM_INVALID_VALUE) {
        gl_Position = vec4(0, 0, 1, 1);
        return;
    }
    float opacity = 1.0;
    if (u_float_show_ratio < 1.0) {
        vec3 instance_wp = a_mat3_instance_matrix * a_vec3_instance_position;
        float noise = interleaved_gradient_noise(instance_wp);
        if (noise > u_float_show_ratio) {
            gl_Position = vec4(0,0,0,0);
            return;
        }
        opacity = clamp(u_float_show_ratio - noise, 0., FADE_AMMOUNT) / FADE_AMMOUNT;
    }
    mat4 instance_matrix = mat4(
        vec4(a_mat3_instance_matrix[0], 0),
        vec4(a_mat3_instance_matrix[1], 0),
        vec4(a_mat3_instance_matrix[2], 0),
        vec4(0, 0, 0, 1)
    );
    vec4 vertex = (instance_matrix * u_mat4_localmatrix) * vec4(a_position, 1);
    vertex *= u_mat4_instance;
    vertex.xyz *= opacity;
    vertex.z *= u_float_height_factor;
    vec4 vflat = vec4(a_vec3_instance_position, 1.);
    vflat.z += height;
    vflat.xyz += vertex.xyz;
#ifdef MALI_GPU
    
    
    
    gl_Position = get_clipspace(vflat.xyz);
#else
    vec4 vecef = vec4(a_vec3_instance_ecef_position, 1.);
    vecef.xyz += vertex.xyz;
    gl_Position = get_clipspace(vflat.xyz, vecef.xyz, a_float_abs_z);
#endif
    v_depth_metric = (gl_Position.z + 1.0) / 2.0;
}
`,bO=`#include <prelude>
#include <mvp_mat>
#include <pos_world>
#include <cam_pos>
#include <fog>
attribute vec2 a_vec2_position;
attribute vec2 a_vec2_widen;
attribute float a_float_weight;
varying vec2 v_vec2_extrude;
varying float v_float_weight;
uniform float u_float_radius;
uniform float u_float_intensity;
uniform float u_float_tile_to_pixel_ratio;
const highp float ZERO = 1.0 / 255.0 / 16.0;
#define GAUSS_COEF 0.3989422804014327
void main(void) {
    float S = sqrt(-2.0 * log(ZERO / a_float_weight / u_float_intensity / GAUSS_COEF)) / 3.0;
    v_vec2_extrude = S * a_vec2_widen;
    v_float_weight = a_float_weight;
    vec2 pos = a_vec2_position + a_vec2_widen * u_float_radius * u_float_tile_to_pixel_ratio;
    calc_fog_pos(calc_pos_world(pos));
    gl_Position = u_mat4_mvp * vec4(pos, 0.0, 1.0);
}
`,xO=`#include <prelude>
#include <pos_world>
#include <cam_pos>
#include <fog>
attribute vec2 a_vec2_position;
varying vec2 v_vec2_position;
void main() {
    gl_Position = vec4(a_vec2_position, 0.0, 1.0);
    v_vec2_position = clamp(a_vec2_position, vec2(0,0), vec2(1,1));
}
`,SO=`#include <prelude>
#include <mvp_mat>
#include <packed_attributes>
#include <pos_world>
#include <cam_pos>
#include <fog>
attribute vec4 a_vec4_position;
attribute vec2 a_vec2_offset;
attribute vec2 a_vec2_texcoord;
attribute vec2 a_vec2_style_zoom_limits;
uniform float u_float_style_zoom;
uniform float u_float_scale;
uniform float u_float_tile_to_pixel_ratio;
varying vec2 v_vec2_texcoord;
float clipw(const float w, const vec2 range, const float zoom) {
    return w * (step(range.x, zoom) - step(range.y, zoom));
}
void main() {
    vec4 newPosition = a_vec4_position;
    newPosition.xy += a_vec2_offset * u_float_scale * u_float_tile_to_pixel_ratio;
    vec3 pos_world = calc_pos_world(newPosition);
    calc_fog_pos(pos_world);
    newPosition = u_mat4_mvp * newPosition;
    gl_Position = vec4(newPosition.xyz, clipw(newPosition.w, a_vec2_style_zoom_limits, u_float_style_zoom));
    v_vec2_texcoord = unpack_texcoord(a_vec2_texcoord);
}
`,MO=`#include <prelude>
#include <ecef_mvp_mat>
#include <dem>
#include <packed_attributes>
#include <apply_height_factor>
#include <depth_test>
#include <pos_world>
#include <cam_pos>
#include <fog>
attribute vec3 a_vec3_flat_position;
attribute vec3 a_vec3_ecef_position;
attribute vec2 a_vec2_offset;
attribute vec2 a_vec2_texcoord;
attribute vec2 a_vec2_check_offset;
attribute vec4 a_vec4_tex_identifier;
attribute vec4 a_vec4_sprite_identifier;
uniform vec2 u_vec2_offset;
uniform float u_float_scale;
uniform float u_float_height_factor;
uniform bool u_bool_skip_height_factor;
uniform vec2 u_vec2_vpt_size;
uniform float u_float_floor_elevation;
varying vec2 v_vec2_texcoord;
varying vec2 v_vec2_labeling_texcoord;
varying float v_float_behind_factor;
varying vec4 v_vec4_text_identifier;
void main() {
    float height = dem_height(a_vec3_flat_position.xy);
    
    if (height == DEM_INVALID_VALUE) {
        gl_Position = vec4(0, 0, 1, 1);
        return;
    }
    height += u_float_floor_elevation;
    vec4 pos;
    
    
    
    if (u_bool_skip_height_factor == true) {
        pos = vec4(a_vec3_flat_position, 1.0);
    } else {
        pos = apply_height_factor(a_vec3_flat_position, u_float_height_factor);
    }
    pos.z += height;
    vec3 pos_world = calc_pos_world(a_vec3_flat_position);
    calc_fog_pos(pos_world);
    pos = get_clipspace(pos.xyz, a_vec3_ecef_position);
    pos.xyz = pos.xyz / pos.w;
    pos.w = 1.0;
    v_float_behind_factor = depth_test(pos.xy + a_vec2_check_offset / u_vec2_vpt_size, pos.z, a_vec4_tex_identifier);
    pos.xy += (a_vec2_offset * u_float_scale + u_vec2_offset) / u_vec2_vpt_size * 2.0;
    gl_Position = pos;
    v_vec2_texcoord = unpack_texcoord(a_vec2_texcoord);
    v_vec4_text_identifier = a_vec4_sprite_identifier;
    v_vec2_labeling_texcoord = (pos.xy + 1.) / 2.;
}
`,IO=`#include <prelude>
#include <ecef_mvp_mat>
#include <dem>
attribute vec3 a_vec3_flat_position;
attribute vec3 a_vec3_ecef_position;
attribute vec2 a_vec2_offset;
attribute vec4 a_vec4_identifier;
uniform vec2 u_vec2_offset;
uniform vec2 u_vec2_vpt_size;
uniform float u_float_scale;
uniform float u_float_floor_elevation;
varying vec4 v_vec4_identifier;
void main() {
    float height = dem_height(a_vec3_flat_position.xy);
    
    if (height == DEM_INVALID_VALUE) {
        gl_Position = vec4(0, 0, 1, 1);
        return;
    }
    height += u_float_floor_elevation;
    v_vec4_identifier = a_vec4_identifier;
    if (vec4(1., 1., 1., 1.) != a_vec4_identifier)
    {
        
        vec4 pos = get_clipspace(a_vec3_flat_position, a_vec3_ecef_position);
        pos.xyz = pos.xyz / pos.w;
        pos.w = 1.0;
        pos.xy += (a_vec2_offset * u_float_scale + u_vec2_offset) / u_vec2_vpt_size * 2.0;
        gl_Position = pos;
    }
    else
    {
        gl_Position = vec4(1., 1., 1., 1.);
    }
}
`,TO=`#include <prelude>
#include <mvp_mat>
#include <dem>
#include <packed_attributes>
#include <apply_height_factor>
#include <apply_opacity>
#include <pos_world>
#include <cam_pos>
#include <fog>
#include <jitter>
#include <shadow>
uniform vec2 u_vec2_vpt_size;
uniform vec4 u_vec4_color;
uniform float u_float_height_factor;
uniform float u_float_opacity;
uniform mediump mat4 u_mat4_gradient;
uniform float u_float_floor_elevation;
attribute vec4 a_vec4_vertex;
attribute vec2 a_vec2_normal;
attribute vec2 a_vec2_normal_delta;
attribute vec3 a_vec3_direction;
attribute float a_float_distance;
attribute vec2 a_vec2_dem_position;
attribute float a_float_visibility;
varying vec4 v_vec4_color;
varying mat4 v_mat4_gradient;
varying vec3 v_vec3_normal;
varying vec2 v_vec2_height_gradient;
const float g_shift_pixels = 1.;
const float g_min_denominator = 1e-4;
const float g_w_factor = 1e-6;
vec2 multiply_complex(vec2 lhs, vec2 rhs)
{
    return vec2(lhs.x * rhs.x - lhs.y * rhs.y, lhs.x * rhs.y + lhs.y * rhs.x);
}
void main()
{
    float height = dem_height(unpack_dem_position(a_vec2_dem_position));
    
    
    
    if (height == DEM_INVALID_VALUE || a_float_visibility == 0.0) {
        gl_Position = vec4(0, 0, 1, 1);
        return;
    }
    height += u_float_floor_elevation;
    vec2 half_viewport = u_vec2_vpt_size / vec2(2.);
    
    if (a_vec4_vertex.z > 0.0)
    {
        v_vec2_height_gradient[0] = 1.;
    } else {
        v_vec2_height_gradient[0] = 0.;
    }
    
    vec4 clip_space_direction = u_mat4_mvp * vec4(normalize_s08(vec3(a_vec3_direction.xy, a_vec3_direction.z + height)), 0.);
    vec4 vertex_hf = apply_height_factor(a_vec4_vertex.xyz, u_float_height_factor);
    vertex_hf.z += height;
    
    vertex_hf.z = max(vertex_hf.z, height);
    vec4 clip_space_vertex = u_mat4_mvp * vertex_hf;
    vec2 screen_space_direction = (clip_space_direction.xy * clip_space_vertex.w - clip_space_vertex.xy * clip_space_direction.w) * half_viewport;
    vec2 screen_space_perp = vec2(-screen_space_direction.y, screen_space_direction.x);
    float denominator = max(g_min_denominator, length(screen_space_perp));
    vec2 bevel_normal = normalize_s08(a_vec2_normal);
    vec2 normal_delta = normalize_s08(a_vec2_normal_delta);
    vec4 clip_space_bevel_normal = u_mat4_mvp * vec4(bevel_normal, 0., 0.);
    vec2 screen_space_bevel_normal = (clip_space_bevel_normal.xy * clip_space_vertex.w - clip_space_vertex.xy * clip_space_bevel_normal.w) * half_viewport;
    float bevel_denominator = max(g_min_denominator, length(screen_space_bevel_normal));
    
    float normal_factor = -dot(screen_space_bevel_normal, screen_space_perp) / denominator / bevel_denominator;
    vec2 wall_normal = multiply_complex(bevel_normal, vec2(normal_delta.x, sign(normal_factor) * normal_delta.y));
    gl_Position = g_w_factor * (clip_space_vertex + vec4(screen_space_perp / half_viewport, 0., 0.) * g_shift_pixels * a_float_distance / denominator * clip_space_vertex.w);
    vec3 pos_world = calc_pos_world(vertex_hf);
    v_vec4_color = u_vec4_color;
    v_vec3_normal = vec3(wall_normal, 0.0);
    if (u_mat4_gradient[0][0] !=0.)
    {
        v_mat4_gradient = u_mat4_gradient;
        for (int i = 1; i <= 2; i++) {
            v_mat4_gradient[i] = apply_opacity(v_mat4_gradient[i], u_float_opacity);
        }
    }
    v_vec2_height_gradient.y = a_float_distance * gl_Position.w;
    calc_fog_pos(pos_world);
#ifdef TAA
    apply_vertex_jitter(gl_Position);
#endif
    
    
    compute_shadow_vertex(clip_space_vertex);
}
`,EO=`#include <prelude>
#include <mvp_mat>
#include <pos_world>
#include <cam_pos>
#include <fog>
#include <jitter>
#include <shadow>
#include <dem>
attribute vec2 a_vec2_vertex;
attribute vec4 a_vec4_normals;
attribute float a_float_height;
uniform float u_float_width;
uniform float u_float_tile_to_pixel_ratio;
varying vec2 v_vec2_normal;
varying float v_float_half_width;
const float g_w_factor = 1e-6;
const float normal_unpack_multiplier = 0.011135539861205473;
void main()
{
    float height = dem_height(a_vec2_vertex);
    if (height == DEM_INVALID_VALUE) {
        gl_Position = vec4(0, 0, 1, 1);
        return;
    }
    
    float half_width = 0.5 * (u_float_width + 1.0);
    
    vec4 normals = a_vec4_normals * normal_unpack_multiplier * half_width;
    vec2 extender = normals.xy;
    vec2 normal = normals.zw;
    
    vec4 shifted_vertex = vec4(
        a_vec2_vertex + extender * u_float_tile_to_pixel_ratio,
        height + a_float_height / (65535. * 32.),
        1.0
    );
    vec4 clip_pos = u_mat4_mvp * shifted_vertex;
    gl_Position = g_w_factor * clip_pos;
    v_vec2_normal = normal;
    v_float_half_width = half_width;
    vec3 pos_world = calc_pos_world(shifted_vertex);
    calc_fog_pos(pos_world);
#ifdef TAA
    apply_vertex_jitter(gl_Position);
#endif
    compute_shadow_vertex(clip_pos, vec3(0.0, 0.0, 1.0), u_mat4_mvp);
}
`,AO=`#include <prelude>
#include <mvp_mat>
#include <dem>
attribute vec2 a_vec2_vertex;
attribute vec4 a_vec4_normals;
attribute float a_float_height;
attribute vec4 a_vec4_identifier;
uniform float u_float_width;
uniform float u_float_tile_to_pixel_ratio;
varying vec2 v_vec2_normal;
varying vec4 v_vec4_identifier;
varying float v_float_half_width;
const float g_w_factor = 1e-6;
const float normal_unpack_multiplier = 0.011135539861205473;
void main()
{
    float height = dem_height(a_vec2_vertex);
    if (height == DEM_INVALID_VALUE) {
        gl_Position = vec4(0, 0, 1, 1);
        return;
    }
    
    float half_width = 0.5 * (u_float_width + 1.0);
    
    vec4 normals = a_vec4_normals * normal_unpack_multiplier * half_width;
    vec2 extender = normals.xy;
    vec2 normal = normals.zw;
    if (vec4(1., 1., 1., 1.) != a_vec4_identifier) {
        
        vec4 shifted_vertex = vec4(
            a_vec2_vertex + extender * u_float_tile_to_pixel_ratio,
            height + a_float_height / (65535. * 32.),
            1.0
        );
        gl_Position = g_w_factor * u_mat4_mvp * shifted_vertex;
    } else {
        gl_Position = vec4(1., 1., 1., 1.);
    }
    v_vec2_normal = normal;
    v_vec4_identifier = a_vec4_identifier;
    v_float_half_width = half_width;
}
`,PO=`#include <prelude>
#include <mvp_mat>
#include <dem>
#include <packed_attributes>
#include <pos_world>
#include <cam_pos>
#include <shadow>
#include <fog>
#include <clipspace_pos>
#include <jitter>
attribute vec2 a_vec2_vertex;
attribute float a_float_z;
attribute vec2 a_vec2_extender;
attribute vec3 a_vec3_normal;
attribute float a_float_gradient;
attribute vec2 a_vec2_dem_position;
attribute float a_float_abs_z;
attribute float a_float_is_pivot;
uniform float u_float_tile_size;
uniform float u_float_height_factor;
uniform int u_int_abs_z;
varying vec4 v_tex_coord;
varying vec4 v_vec4_normal_gradient;
void main()
{
    float height = 0.;
    if (u_int_abs_z == 0) {
        height = dem_height(unpack_dem_position(a_vec2_dem_position));
    } else {
        if (a_float_is_pivot == 1.) {
            height = dem_height(a_vec2_vertex);
        } else {
            height = abs_height(a_float_abs_z);
        }
    }
    
    if (height == DEM_INVALID_VALUE) {
        gl_Position = vec4(0, 0, 1, 1);
        return;
    }
    
    vec3 vec3_vertex = vec3(a_vec2_vertex, a_float_z / (65535. * 32.));
    v_tex_coord = u_mat4_mvp * vec4(vec3_vertex.xy, 0, 1.0);
    v_vec4_normal_gradient.xyz = normalize_s08(a_vec3_normal);
    v_vec4_normal_gradient.w = a_float_gradient;
    vec4 pos = vec4(vec3_vertex.xy, vec3_vertex.z * u_float_height_factor + height, 1.0);
    vec3 world_pos = calc_pos_world(pos);
    calc_fog_pos(world_pos);
    gl_Position = u_mat4_mvp * pos;
#ifdef TAA
    apply_vertex_jitter(gl_Position);
#endif
    save_clipspace_pos();
    compute_shadow_vertex(gl_Position, v_vec4_normal_gradient.xyz, u_mat4_mvp);
}`,LO=`#include <prelude>
#include <mvp_mat>
#include <dem>
#include <packed_attributes>
#include <apply_height_factor>
#include <apply_opacity>
#include <pos_world>
#include <cam_pos>
#include <shadow>
#include <fog>
#include <clipspace_pos>
#include <jitter>
uniform mediump vec4 u_vec4_color;
uniform mediump mat4 u_mat4_gradient;
uniform float u_float_height_factor;
uniform int u_int_abs_z;
uniform lowp int u_int_is_textured;
uniform mediump float u_float_opacity;
uniform vec4 u_float_texture_params;
uniform float u_float_texture_vertical_scale;
uniform mediump int u_int_identify;
attribute vec2 a_vec2_vertex;
attribute float a_float_z;
attribute vec3 a_vec3_normal;
attribute float a_float_gradient;
attribute vec2 a_vec2_dem_position;
attribute float a_float_abs_z;
attribute vec4 a_vec4_identifier;
attribute float a_float_visibility;
attribute float a_float_is_pivot;
varying vec4 v_vec4_color;
varying mat4 v_mat4_gradient;
varying vec2 v_vec2_tex_coord;
varying vec4 v_vec4_normal_gradient;
varying vec4 v_vec4_identifier;
void main()
{
    if (u_int_identify != 0 && a_vec4_identifier == vec4(1., 1., 1., 1.)) {
        gl_Position = vec4(0, 0, 0, 0);
        return;
    }
    float height = 0.;
    if (u_int_abs_z == 0) {
        height = dem_height(unpack_dem_position(a_vec2_dem_position));
    } else {
        if (a_float_is_pivot == 1.) {
            height = dem_height(a_vec2_vertex);
        } else {
            height = abs_height(a_float_abs_z);
        }
    }
    
    if (height == DEM_INVALID_VALUE || a_float_visibility == 0.0) {
        gl_Position = vec4(0, 0, 1, 1);
        v_vec4_color = vec4(0, 0, 0, 0);
        return;
    }
    v_vec4_identifier = a_vec4_identifier;
    
    vec4 vec4_pos = apply_height_factor(vec3(a_vec2_vertex.xy, a_float_z / (65535. * 32.)), u_float_height_factor);
    vec4_pos.z += height;
    vec3 pos_world = calc_pos_world(vec4_pos);
    calc_fog_pos(pos_world);
    gl_Position = u_mat4_mvp * vec4_pos;
    vec3 vec3_normal = normalize(a_vec3_normal);
    v_vec4_normal_gradient.xyz = vec3_normal;
    v_vec4_normal_gradient.w = a_float_gradient / 127.; 
    if (u_int_is_textured != 0) {
        
        vec2 vec2_vertex = a_vec2_vertex * 2. - 0.5;
        
        
        vec3 tex_coord = abs(vec3(
            vec2_vertex * u_float_texture_params.zw + u_float_texture_params.xy,
            a_float_z / u_float_texture_vertical_scale
        ));
        
        if (vec3_normal.x == 0. && vec3_normal.y == 0.) {
            v_vec2_tex_coord = tex_coord.xy;
        } else {
            float scale = abs(vec3_normal.z);
            tex_coord.z /= sqrt(1.0 - vec3_normal.z * vec3_normal.z);;
            if (abs(vec3_normal).y > abs(vec3_normal).x) {
                v_vec2_tex_coord = tex_coord.xz;
            } else {
                v_vec2_tex_coord = tex_coord.yz;
            }
        }
        v_vec4_color = apply_opacity(u_vec4_color, u_float_opacity);
    }
    
    else if (u_mat4_gradient[0][0] != 0.)
    {
        v_mat4_gradient = u_mat4_gradient;
        for (int i = 1; i <= 2; i++) {
            v_mat4_gradient[i] = apply_opacity(v_mat4_gradient[i], u_float_opacity);
        }
    } else {
        v_vec4_color = apply_opacity(u_vec4_color, u_float_opacity);
    }
#ifdef TAA
    apply_vertex_jitter(gl_Position);
#endif
    save_clipspace_pos();
    compute_shadow_vertex(gl_Position, vec3_normal, u_mat4_mvp);
}
`,CO=`#include <prelude>
#include <mvp_mat>
#include <dem>
#include <apply_height_factor>
attribute vec2 a_vec2_vertex;
attribute float a_float_z;
attribute vec2 a_vec2_dem_position;
attribute float a_float_abs_z;
attribute float a_float_visibility;
attribute float a_float_is_pivot;
uniform float u_float_height_factor;
uniform int u_int_abs_z;
varying float v_depth_metric;
void main()
{
    float height = 0.;
    if (u_int_abs_z == 0) {
        height = dem_height(unpack_dem_position(a_vec2_dem_position));
    } else {
        if (a_float_is_pivot == 1.) {
            height = dem_height(a_vec2_vertex);
        } else {
            height = abs_height(a_float_abs_z);
        }
    }
    
    if (height == DEM_INVALID_VALUE || a_float_visibility == 0.0) {
        gl_Position = vec4(0, 0, 1, 1);
        return;
    }
    
    vec4 vec4_pos = apply_height_factor(vec3(a_vec2_vertex.xy, a_float_z / (65535. * 32.)), u_float_height_factor);
    vec4_pos.z += height;
    gl_Position = u_mat4_mvp * vec4_pos;
    v_depth_metric = 0.5 * gl_Position.z + 0.5;
}`,RO=`#include <prelude>
#include <mvp_mat>
#include <dem>
#include <packed_attributes>
#include <apply_height_factor>
#include <pos_world>
#include <cam_pos>
#include <fog>
#include <jitter>
#include <shadow>
uniform vec2 u_vec2_vpt_size;
uniform float u_float_width;
uniform float u_float_height_factor;
uniform int u_int_signed_z;
uniform int u_int_abs_z;
uniform float u_float_z_offset;
attribute vec2 a_vec2_vertex;
attribute float a_float_z;
attribute vec4 a_vec4_direction_distance;
attribute vec2 a_vec2_dem_position;
attribute float a_float_abs_z;
attribute float a_float_visibility;
attribute float a_float_is_pivot;
varying float v_float_distance;
varying float v_float_distance_offset;
const float g_smooth_width = 1.;
const float g_min_denominator = 1e-4;
const float g_w_factor = 1e-6;
void main()
{
    float height = 0.;
    if (u_int_abs_z == 0) {
        height = dem_height(unpack_dem_position(a_vec2_dem_position));
    } else {
        if (a_float_is_pivot == 1.) {
            height = dem_height(a_vec2_vertex);
        } else {
            height = abs_height(a_float_abs_z);
        }
    }
    
    
    
    if (height == DEM_INVALID_VALUE || a_float_visibility == 0.0) {
        gl_Position = vec4(0, 0, 1, 1);
        return;
    }
    float shift_pixels = 0.5 * max(u_float_width - 1., 0.);
    float shift_pixels_added = shift_pixels + g_smooth_width;
    vec3 direction = a_vec4_direction_distance.xyz;
    float distance = a_vec4_direction_distance.w;
    vec2 half_viewport = u_vec2_vpt_size / vec2(2.);
    
    
    vec4 clip_space_direction = normalize(u_mat4_mvp * vec4(normalize_s08(direction), 0.));
    vec3 a_vec3_vertex = vec3(a_vec2_vertex, a_float_z / (65535. * 32.));
    
    vec4 vertex_hf = apply_height_factor(a_vec3_vertex, u_float_height_factor);
    vertex_hf.z += height;
    vec4 clip_space_vertex = u_mat4_mvp * vertex_hf;
    vec2 screen_space_direction =
        (clip_space_direction.xy * clip_space_vertex.w - clip_space_vertex.xy * clip_space_direction.w) * half_viewport;
    vec2 screen_space_perp = vec2(-screen_space_direction.y, screen_space_direction.x);
    float denominator = max(g_min_denominator, length(screen_space_perp));
    gl_Position = g_w_factor * (clip_space_vertex + vec4(screen_space_perp / half_viewport, 0., 0.)
        * distance * shift_pixels_added / denominator * clip_space_vertex.w);
    gl_Position.z += u_float_z_offset;
    v_float_distance = shift_pixels_added * distance * gl_Position.w;
    v_float_distance_offset = shift_pixels;
    vec3 pos_world = calc_pos_world(vertex_hf.xyz);
    calc_fog_pos(pos_world);
#ifdef TAA
    apply_vertex_jitter(gl_Position);
#endif
    
    
    compute_shadow_vertex(clip_space_vertex);
}
`,zO=`#include <prelude>
#include <mvp_mat>
#include <apply_opacity>
#include <packed_attributes>
#include <pos_world>
#include <cam_pos>
#include <shadow>
#include <fog>
uniform float u_float_floor_elevation;
attribute vec2 a_vec2_vertex;
attribute vec2 a_vec2_texcoord;
varying vec2 v_vec2_texcoord;
void main()
{
    gl_Position = u_mat4_mvp * vec4(a_vec2_vertex, u_float_floor_elevation, 1.0);
    vec3 pos_world = calc_pos_world(a_vec2_vertex);
    calc_fog_pos(pos_world);
    compute_shadow_vertex(gl_Position, vec3(0,0,1), u_mat4_mvp);
    v_vec2_texcoord = unpack_texcoord(a_vec2_texcoord);
}
`,FO=`#include <prelude>
#include <mvp_mat>
#include <packed_attributes>
#include <pixel_offset>
#include <signed_distance_functions>
#include <arrow_functions>
#include <apply_opacity>
#include <pos_world>
#include <cam_pos>
#include <fog>
#include <jitter>
#ifndef UBO
uniform float u_float_border_width_offset;
uniform vec2 u_vec2_scale_limits;
#endif
uniform vec4 u_vec4_color;
uniform vec4 u_vec4_border_color;
uniform mediump vec2 u_vec2_vpt_size;
uniform vec3 u_vec3_projection_scale_style_scale_dpi;
uniform float u_float_border_width;
uniform float u_float_size_factor;
uniform mediump float u_float_width;
uniform mediump float u_float_length;
uniform float u_float_wing_width_multiplier;
uniform float u_float_wing_height_multiplier;
uniform float u_float_tip_height_multiplier;
uniform float u_float_opacity;
attribute vec2 a_vec2_position;
attribute vec2 a_vec2_direction;
attribute vec2 a_vec2_widen_direction;
varying vec4 v_vec4_color;
varying vec4 v_vec4_border_color;
varying vec2 v_vec2_texcoord;
varying float v_float_border_width;
varying float v_float_zpt_to_texcoord_factor;
varying float v_float_outer_width;
varying float v_float_opacity;
const float g_shift_pixels = 2.;
const float g_w_factor = 1e-7;
void main()
{
    float style_scale_clamped = clamp(u_vec3_projection_scale_style_scale_dpi.y, u_vec2_scale_limits.x, u_vec2_scale_limits.y);
    float scale_ratio = u_vec3_projection_scale_style_scale_dpi.x / u_vec3_projection_scale_style_scale_dpi.y;
    float calculation_scale = style_scale_clamped * scale_ratio;
    ArrowParameters arrow_parameters = calculate_arrow_parameters(
        calculation_scale,
        u_float_width,
        u_float_border_width,
        u_float_length,
        u_float_wing_width_multiplier,
        u_float_wing_height_multiplier,
        u_float_tip_height_multiplier,
        u_float_size_factor);
    v_float_zpt_to_texcoord_factor = arrow_parameters.zpt_to_texcoord_factor;
    v_float_outer_width = arrow_parameters.outer_width;
    vec2 direction = normalize_s08(a_vec2_direction);
    vec2 untransformed_widen = a_vec2_widen_direction * arrow_parameters.widen_size;
    vec2 widen = multiply_complex(untransformed_widen * arrow_parameters.final_size, direction);
    
    float shift_pixels = g_shift_pixels * sqrt(2.) / min(abs(untransformed_widen.x), abs(untransformed_widen.y));
    VertexShiftParameters shift_parameters = calculate_vertex_shift_parameters(
        u_mat4_mvp,
        u_vec2_vpt_size,
        a_vec2_position,
        widen,
        shift_pixels);
    
    
    gl_Position = shift_parameters.clip_space_vertex / arrow_parameters.final_size * g_w_factor;
    v_vec2_texcoord = untransformed_widen * (1. + shift_parameters.limited_factor);
    
    float border_width = u_float_border_width * v_float_zpt_to_texcoord_factor;
    float border_width_offset = u_float_border_width_offset * v_float_zpt_to_texcoord_factor;
    v_float_border_width = max(0., border_width - u_vec3_projection_scale_style_scale_dpi.y / style_scale_clamped * border_width_offset);
    v_vec4_color = apply_opacity(u_vec4_color, u_float_opacity);
    v_vec4_border_color = apply_opacity(u_vec4_border_color, u_float_opacity);
    v_float_opacity = u_float_opacity;
    vec3 pos_world = calc_pos_world(a_vec2_position);
    calc_fog_pos(pos_world);
}
`,DO=`#include <prelude>
#include <mvp_mat>
#include <packed_attributes>
#include <pixel_offset>
#include <calculate_scale>
#include <line_width>
#include <apply_opacity>
#include <precision_constants>
#include <striped_line_functions>
#include <pos_world>
#include <cam_pos>
#include <shadow>
#include <fog>
#include <jitter>
#include <dem>
attribute vec2 a_vec2_vertex;
attribute vec2 a_vec2_widen;
attribute float a_float_texture;
attribute float a_float_height;
uniform vec2 u_vec2_scales;
uniform float u_float_width;
uniform vec4 u_vec4_color;
uniform float u_float_opacity;
uniform vec4 u_vec4_pattern_params;
uniform bool u_bool_is_3d_line;
varying vec2 v_vec2_uv;
varying float v_float_period;
varying float v_float_width;
varying vec4 v_vec4_color;
varying vec4 v_vec4_pattern_parameters;
const float g_w_factor = 1e-6;
void main() {
    float height = 0.;
    if (u_bool_is_3d_line == true) {
        height = dem_height(a_vec2_vertex);
    }
    if (height == DEM_INVALID_VALUE) {
        gl_Position = vec4(0, 0, 1, 1);
        return;
    }
    if (u_bool_is_3d_line == true) {
        height += a_float_height / (65535. * 32.);
    }
    
    v_float_width = u_float_width;
    v_vec4_color = apply_opacity(u_vec4_color, u_float_opacity);
    v_vec2_uv = vec2(abs(a_float_texture), sign(a_float_texture) / 2.);
    v_vec2_uv.x *= u_vec2_scales.x / u_vec4_pattern_params.x;
    v_vec4_pattern_parameters = u_vec4_pattern_params;
    
    float full_width = u_float_width + 1.;
    
    vec2 widen = unpack_widen(a_vec2_widen);
    vec2 extender = widen * full_width * 0.5;
    
    
    vec2 shift = vec2(0.);
    vec4 shifted_vertex = vec4(a_vec2_vertex + (shift + extender) * u_vec2_scales.y, height, 1.0);
    vec3 pos_world = calc_pos_world(shifted_vertex); 
    calc_fog_pos(pos_world);
    gl_Position = u_mat4_mvp * shifted_vertex;
#ifdef TAA
    apply_vertex_jitter(gl_Position);
#endif
    compute_shadow_vertex(gl_Position, vec3(0.0, 0.0, 1.0), u_mat4_mvp);
    gl_Position *= g_w_factor;
}
`,OO=`#include <prelude>
#include <mvp_mat>
#include <dem>
attribute vec4 a_vec4_position;
attribute vec2 a_vec2_offset;
attribute vec4 a_vec4_identifier;
uniform vec2 u_vec2_offset;
uniform vec2 u_vec2_vpt_size;
uniform float u_float_floor_elevation;
varying vec4 v_vec4_identifier;
void main() {
    float height = dem_height(a_vec4_position.xy);
    
    if (height == DEM_INVALID_VALUE) {
        gl_Position = vec4(0, 0, 1, 1);
        return;
    }
    height += u_float_floor_elevation;
    vec4 ndcPosition = u_mat4_mvp * vec4(a_vec4_position.xy, a_vec4_position.z + height, a_vec4_position.w);
    ndcPosition.xyz = ndcPosition.xyz / ndcPosition.w;
    ndcPosition.w = 1.0;
    ndcPosition.xy += (a_vec2_offset + u_vec2_offset) / u_vec2_vpt_size * 2.0;
    gl_Position = ndcPosition;
    v_vec4_identifier = a_vec4_identifier;
}
`,BO=`#include <prelude>
#include <ecef_mvp_mat>
#include <pos_world>
#include <cam_pos>
#include <fog>
#include <dem>
#include <packed_attributes>
#include <apply_height_factor>
#include <raster_functions>
#include <depth_test>
#ifndef UBO
uniform float u_float_rounding_factor;
#endif
uniform vec3 u_vec3_projection_scale_style_scale_dpi;
uniform float u_float_height_factor;
uniform vec2 u_vec2_rotation; 
uniform bool u_bool_skip_height_factor;
uniform vec2 u_vec2_vpt_size;
uniform float u_float_floor_elevation;
attribute vec3 a_vec3_flat_position;
attribute vec3 a_vec3_ecef_position;
attribute vec2 a_vec2_offset;
attribute vec2 a_vec2_check_offset;
attribute vec2 a_vec2_texcoord;
attribute vec2 a_vec2_range;
attribute vec2 a_vec2_rescale;
attribute vec4 a_vec4_tex_identifier;
varying vec2 v_vec2_texcoord;
varying float v_float_behind_factor;
void main()
{
    float height = dem_height(a_vec3_flat_position.xy);
    
    if (height == DEM_INVALID_VALUE) {
        gl_Position = vec4(0, 0, 1, 1);
        return;
    }
    height += u_float_floor_elevation;
    mat2 rotation_matrix = mat2(
        u_vec2_rotation.x, -u_vec2_rotation.y,
        u_vec2_rotation.y, u_vec2_rotation.x
    );
    vec2 inv_half_size = 2.0 / u_vec2_vpt_size;
    vec4 anchor;
    
    
    
    if (u_bool_skip_height_factor == true) {
        anchor = vec4(a_vec3_flat_position, 1.0);
    } else {
        anchor = apply_height_factor(a_vec3_flat_position, u_float_height_factor);
    }
    anchor.z += height;
    vec3 pos_world = calc_pos_world(anchor);
    calc_fog_pos(pos_world);
    anchor = get_clipspace(anchor.xyz, a_vec3_ecef_position);
    vec2 offset = rescale(rotation_matrix * a_vec2_offset, a_vec2_rescale, a_vec2_range, u_vec3_projection_scale_style_scale_dpi.y);
    vec2 pos_2d = anchor.xy + overlay_transform(offset, inv_half_size) * anchor.w;
    vec2 corner = make_position(pos_2d, anchor.w, inv_half_size, u_float_rounding_factor);
    v_float_behind_factor = depth_test(anchor.xy / anchor.w + a_vec2_check_offset / u_vec2_vpt_size, anchor.z / anchor.w, a_vec4_tex_identifier);
    gl_Position = vec4(corner, anchor.z, clipw(anchor.w, a_vec2_range, u_vec3_projection_scale_style_scale_dpi.y));
    v_vec2_texcoord = unpack_texcoord(a_vec2_texcoord);
}
`,kO=`#include <prelude>
#include <ecef_mvp_mat>
#include <dem>
#include <packed_attributes>
#include <apply_height_factor>
#include <raster_functions>
uniform vec2 u_vec2_vpt_size;
uniform vec3 u_vec3_projection_scale_style_scale_dpi;
uniform float u_float_height_factor;
uniform vec2 u_vec2_rotation; 
uniform bool u_bool_skip_height_factor;
uniform float u_float_floor_elevation;
attribute vec3 a_vec3_flat_position;
attribute vec3 a_vec3_ecef_position;
attribute vec2 a_vec2_offset;
attribute vec2 a_vec2_texcoord;
attribute vec2 a_vec2_range;
attribute vec2 a_vec2_rescale;
attribute vec4 a_vec4_identifier;
varying vec2 v_vec2_texcoord;
varying vec4 v_vec4_identifier;
void main()
{
    if (vec4(1., 1., 1., 1.) != a_vec4_identifier)
    {
        float height = dem_height(a_vec3_flat_position.xy);
        
        if (height == DEM_INVALID_VALUE) {
            gl_Position = vec4(0, 0, 1, 1);
            return;
        }
        height += u_float_floor_elevation;
        
        mat2 rotation_matrix = mat2(
            u_vec2_rotation.x, -u_vec2_rotation.y,
            u_vec2_rotation.y, u_vec2_rotation.x
        );
        vec2 inv_half_size = 2.0 / u_vec2_vpt_size;
        vec4 anchor;
        
        
        
        if (u_bool_skip_height_factor == true) {
            anchor = vec4(a_vec3_flat_position, 1.0);
        } else {
            anchor = apply_height_factor(a_vec3_flat_position, u_float_height_factor);
        }
        anchor.z += height;
        anchor = get_clipspace(anchor.xyz, a_vec3_ecef_position);
        vec2 offset = rescale(rotation_matrix * a_vec2_offset, a_vec2_rescale, a_vec2_range, u_vec3_projection_scale_style_scale_dpi.y);
        vec2 pos_2d = anchor.xy + overlay_transform(offset, inv_half_size) * anchor.w;
        vec2 corner = make_position(pos_2d, anchor.w, inv_half_size, 1.0);
        gl_Position = vec4(corner, anchor.z, clipw(anchor.w, a_vec2_range, u_vec3_projection_scale_style_scale_dpi.y));
    }
    else
    {
        gl_Position = vec4(1., 1., 1., 1.);
    }
    v_vec2_texcoord = unpack_texcoord(a_vec2_texcoord);
    v_vec4_identifier = a_vec4_identifier;
}
`,NO=`#include <prelude>
attribute vec2 a_vec2_vertex;
varying vec2 v_vec2_texcoord;
void main()
{
    gl_Position = vec4(a_vec2_vertex, 0.0, 1.0);
    v_vec2_texcoord = 0.5 * a_vec2_vertex + 0.5;
}
`,UO=`#include <prelude>
#include <mvp_mat>
#include <pos_world>
#include <cam_pos>
#include <fog>
attribute vec2 a_vec2_vertex;
void main()
{
    gl_Position = u_mat4_mvp * vec4(a_vec2_vertex, 0.0, 1.0);
}
`,GO=`#include <prelude>
#include <mvp_mat>
#include <packed_attributes>
#include <apply_opacity>
#include <raster_functions>
#include <pos_world>
#include <cam_pos>
#include <fog>
attribute vec2 a_vec2_vertex;
attribute vec2 a_vec2_texcoord;
varying vec2 v_vec2_texcoord;
void main()
{
    gl_Position = u_mat4_mvp * vec4(a_vec2_vertex, 0.0, 1.0);
    calc_fog_pos(calc_pos_world(a_vec2_vertex));
    v_vec2_texcoord = unpack_texcoord(a_vec2_texcoord);
}
`,jO=`#include <prelude>
#include <mvp_mat>
#include <pos_world>
#include <cam_pos>
#include <fog>
#include <jitter>
#include <shadow>
attribute vec2 a_vec2_vertex;
attribute vec4 a_vec4_normals;
attribute vec2 a_vec2_shift;
uniform float u_float_width;
uniform float u_float_tile_to_pixel_ratio;
uniform float u_float_shift;
varying vec2 v_vec2_normal;
varying float v_float_half_width;
const float g_w_factor = 1e-6;
const float normal_unpack_multiplier = 0.011135539861205473;
void main()
{
    
    float half_width = 0.5 * (u_float_width + 1.0);
    
    vec4 normals = a_vec4_normals * normal_unpack_multiplier * half_width;
    vec2 extender = normals.xy;
    vec2 normal = normals.zw;
    vec2 shift = a_vec2_shift * u_float_shift;
    
    vec4 shifted_vertex = vec4(a_vec2_vertex + (shift + extender) * u_float_tile_to_pixel_ratio, 0.0, 1.0);
    vec4 clip_pos = u_mat4_mvp * shifted_vertex;
    gl_Position = g_w_factor * clip_pos;
    v_vec2_normal = normal;
    v_float_half_width = half_width;
    vec3 pos_world = calc_pos_world(shifted_vertex);
    calc_fog_pos(pos_world);
#ifdef TAA
    apply_vertex_jitter(gl_Position);
#endif
    compute_shadow_vertex(clip_pos, vec3(0.0, 0.0, 1.0), u_mat4_mvp);
}
`,VO=`#include <prelude>
#include <mvp_mat>
attribute vec2 a_vec2_vertex;
attribute vec4 a_vec4_normals;
attribute vec4 a_vec4_identifier;
uniform float u_float_width;
uniform float u_float_tile_to_pixel_ratio;
varying vec2 v_vec2_normal;
varying vec4 v_vec4_identifier;
varying float v_float_half_width;
const float g_w_factor = 1e-6;
const float normal_unpack_multiplier = 0.011135539861205473;
void main()
{
    
    float half_width = 0.5 * (u_float_width + 1.0);
    
    vec4 normals = a_vec4_normals * normal_unpack_multiplier * half_width;
    vec2 extender = normals.xy;
    vec2 normal = normals.zw;
    if (vec4(1., 1., 1., 1.) != a_vec4_identifier) {
        
        vec4 shifted_vertex = vec4(a_vec2_vertex + extender * u_float_tile_to_pixel_ratio, 0.0, 1.0);
        gl_Position = g_w_factor * u_mat4_mvp * shifted_vertex;
    } else {
        gl_Position = vec4(1., 1., 1., 1.);
    }
    v_vec2_normal = normal;
    v_vec4_identifier = a_vec4_identifier;
    v_float_half_width = half_width;
}
`,HO=`#include <prelude>
#include <mvp_mat>
#include <dem>
#include <packed_attributes>
#include <apply_height_factor>
#include <pos_world>
#include <cam_pos>
#include <fog>
#include <jitter>
#include <shadow>
uniform vec2 u_vec2_vpt_size;
uniform float u_float_width;
uniform float u_float_height_factor;
uniform int u_int_signed_z;
uniform int u_int_abs_z;
uniform float u_float_z_offset;
uniform float u_float_floor_elevation;
attribute vec3 a_vec3_vertex;
attribute float a_float_z;
attribute vec4 a_vec4_direction_distance;
attribute vec2 a_vec2_dem_position;
attribute float a_float_abs_z;
attribute float a_float_visibility;
varying float v_float_distance;
varying float v_float_distance_offset;
const float g_smooth_width = 1.;
const float g_min_denominator = 1e-4;
const float g_w_factor = 1e-6;
void main()
{
    float height = 0.;
    if (u_int_abs_z == 0) {
        height = dem_height(unpack_dem_position(a_vec2_dem_position));
    } else {
        height = abs_height(a_float_abs_z);
    }
    
    
    
    if (height == DEM_INVALID_VALUE || a_float_visibility == 0.0) {
        gl_Position = vec4(0, 0, 1, 1);
        return;
    }
    height += u_float_floor_elevation;
    float shift_pixels = 0.5 * max(u_float_width - 1., 0.);
    float shift_pixels_added = shift_pixels + g_smooth_width;
    vec3 direction = a_vec4_direction_distance.xyz;
    float distance = a_vec4_direction_distance.w;
    vec2 half_viewport = u_vec2_vpt_size / vec2(2.);
    
    
    vec4 clip_space_direction = normalize(u_mat4_mvp * vec4(normalize_s08(direction), 0.));
    vec3 a_vec3_vertex_copy = vec3(a_vec3_vertex);
    
    if (u_int_signed_z == 1) {
        a_vec3_vertex_copy.z = a_float_z / (65535. * 32.);
    }
    
    vec4 vertex_hf = apply_height_factor(a_vec3_vertex_copy, u_float_height_factor);
    vertex_hf.z += height;
    vec4 clip_space_vertex = u_mat4_mvp * vertex_hf;
    vec2 screen_space_direction =
        (clip_space_direction.xy * clip_space_vertex.w - clip_space_vertex.xy * clip_space_direction.w) * half_viewport;
    vec2 screen_space_perp = vec2(-screen_space_direction.y, screen_space_direction.x);
    float denominator = max(g_min_denominator, length(screen_space_perp));
    gl_Position = g_w_factor * (clip_space_vertex + vec4(screen_space_perp / half_viewport, 0., 0.)
        * distance * shift_pixels_added / denominator * clip_space_vertex.w);
    gl_Position.z += u_float_z_offset;
    v_float_distance = shift_pixels_added * distance * gl_Position.w;
    v_float_distance_offset = shift_pixels;
    vec3 pos_world = calc_pos_world(vertex_hf.xyz);
    calc_fog_pos(pos_world);
#ifdef TAA
    apply_vertex_jitter(gl_Position);
#endif
    
    
    compute_shadow_vertex(clip_space_vertex);
}
`,ZO=`#include <prelude>
#include <mvp_mat>
uniform float u_float_scale;
uniform vec3 u_vec3_transform;
attribute vec3 a_vec3_position;
varying vec3 v_position;
void main() {
    vec3 scaled_transformed = u_vec3_transform + a_vec3_position * u_float_scale;
    v_position = scaled_transformed;
    gl_Position = u_mat4_mvp * vec4(scaled_transformed, 1.0);
}
`,$O=`#include <prelude>
#include <pos_world>
#include <cam_pos>
#include <fog>
attribute vec2 a_vec2_vertex;
void main()
{
    gl_Position = vec4(a_vec2_vertex, 1.0, 1.0);
    calc_fog_pos_sky(gl_Position);
}
`,WO=`#include <prelude>
attribute vec3 a_vec3_position;
attribute float a_fade_opacity;
#ifndef UBO
uniform mat4 u_mat4_stars;
uniform float u_float_stars_intensity;
uniform float u_float_pixelratio;
#endif
varying mediump float v_intensity;
void main() {
    v_intensity = a_fade_opacity * u_float_stars_intensity;
    gl_PointSize = u_float_pixelratio;
    gl_Position = u_mat4_stars * vec4(a_vec3_position, 1.0);
}
`,XO=`#include <prelude>
#include <mvp_mat>
#include <packed_attributes>
#include <pixel_offset>
#include <calculate_scale>
#include <line_width>
#include <apply_opacity>
#include <precision_constants>
#include <striped_line_functions>
#include <pos_world>
#include <cam_pos>
#include <fog>
#include <jitter>
#include <shadow>
#include <dem>
uniform vec4 u_vec4_dash_color;
uniform vec4 u_vec4_space_color;
uniform vec4 u_vec4_border_color;
uniform mediump vec2 u_vec2_vpt_size;
uniform vec3 u_vec3_projection_scale_style_scale_dpi;
uniform float u_float_width;
uniform float u_float_width_offset;
uniform vec2 u_vec2_scaler_params;
uniform float u_float_dash_length;
uniform float u_float_space_length;
uniform float u_float_dash2_length;
uniform float u_float_opacity;
uniform bool u_bool_is_3d_line;
attribute vec2 a_vec2_vertex;
attribute vec2 a_vec2_texture_widen;
attribute vec2 a_vec2_widen;
attribute float a_float_vertex_distance;
attribute float a_float_component_distance;
attribute float a_float_object_length;
attribute float a_float_height;
varying vec4 v_vec4_dash_color;
varying vec4 v_vec4_space_color;
varying vec4 v_vec4_border_color;
varying vec2 v_vec2_circle;
varying float v_float_width;
varying float v_float_part_color_swap_threshold;
varying float v_float_distance_in_parts;
const float g_shift_pixels = 2.;
const float g_w_factor = 1e-7;
PolylineDistance decode_line_distance()
{
    return PolylineDistance(
        a_float_vertex_distance,
        a_float_component_distance,
        a_float_object_length);
}
StripedLineInParams decode_line_params(const Scale scale)
{
    float width = calculate_final_width(scale, u_float_width, u_float_width_offset);
    float dash_length  = scale.calculation * u_float_dash_length;
    float space_length = scale.calculation * u_float_space_length;
    float dash2_length = scale.calculation * u_float_dash2_length;
    return StripedLineInParams(
        dash_length,
        space_length,
        dash2_length,
        width);
}
void main()
{
    float height = 0.;
    if (u_bool_is_3d_line == true) {
        height = dem_height(a_vec2_vertex);
    }
    if (height == DEM_INVALID_VALUE) {
        gl_Position = vec4(0, 0, 1, 1);
        return;
    }
    if (u_bool_is_3d_line == true) {
        height += a_float_height / (65535. * 32.);
    }
    Scale scale = calculate_scale(u_vec3_projection_scale_style_scale_dpi, u_vec2_scaler_params);
    StripedLineInParams params = decode_line_params(scale);
    vec2 widen = unpack_widen(a_vec2_widen);
    vec2 widen_perp = vec2(-widen.y, widen.x);
    
    vec4 clip_space_widen = u_mat4_mvp * vec4(widen, 0., 0.);
    vec4 clip_space_widen_perp = u_mat4_mvp * vec4(widen_perp, 0., 0.);
    
    vec4 clip_space_vertex = u_mat4_mvp * vec4(a_vec2_vertex, height, 1.0) + clip_space_widen * params.line_width;
    vec2 half_viewport = 0.5 * u_vec2_vpt_size;
    
    float limited_factor = calculate_multiplication_factor(
        half_viewport,
        clip_space_widen,
        clip_space_widen_perp,
        clip_space_vertex,
        g_shift_pixels);
    PolylineDistance distance_decoded = decode_line_distance();
    StripedLineOutParams output_params;
    calculate_line_params(distance_decoded, params, output_params);
    
    
    vec2 texture_widen_with_shift_sign = unpack_widen(a_vec2_texture_widen);
    float shift_sign = sign(dot(widen, texture_widen_with_shift_sign));
    vec2 texture_widen = shift_sign * texture_widen_with_shift_sign;
    vec2 texture_widen_perp = vec2(-texture_widen.y, texture_widen.x);
    float distance_shift = shift_sign * abs(dot(widen, texture_widen_perp)) * params.line_width;
    float circle_factor = g_circle_scale_precision_factor / scale.calculation;
    v_vec2_circle = texture_widen * (params.line_width + limited_factor) * circle_factor;
    v_float_width = params.line_width * circle_factor;
    v_float_part_color_swap_threshold = output_params.part_color_swap_threshold;
    v_float_distance_in_parts = output_params.distance_in_parts;
    v_vec4_dash_color = apply_opacity(u_vec4_dash_color, u_float_opacity);
    v_vec4_space_color = apply_opacity(u_vec4_space_color, u_float_opacity);
    v_vec4_border_color = apply_opacity(u_vec4_border_color, u_float_opacity);
    gl_Position = clip_space_vertex + clip_space_widen * limited_factor;
    vec3 pos_world = calc_pos_world(a_vec2_vertex);
    calc_fog_pos(pos_world);
#ifdef TAA
    apply_vertex_jitter(gl_Position);
#endif
    gl_Position *= g_w_factor;
    compute_shadow_vertex(clip_space_vertex, vec3(0.0, 0.0, 1.0), u_mat4_mvp);
}
`,YO=`#include <prelude>
#include <mvp_mat>
#include <packed_attributes>
#include <pixel_offset>
#include <calculate_scale>
#include <line_width>
#include <apply_opacity>
#include <precision_constants>
#include <striped_line_functions>
#include <dem>
uniform vec4 u_vec4_dash_color;
uniform vec4 u_vec4_space_color;
uniform vec4 u_vec4_border_color;
uniform mediump vec2 u_vec2_vpt_size;
uniform vec3 u_vec3_projection_scale_style_scale_dpi;
uniform float u_float_width;
uniform float u_float_width_offset;
uniform vec2 u_vec2_scaler_params;
uniform float u_float_dash_length;
uniform float u_float_space_length;
uniform float u_float_dash2_length;
uniform float u_float_opacity;
uniform bool u_bool_is_3d_line;
attribute vec2 a_vec2_vertex;
attribute vec2 a_vec2_texture_widen;
attribute vec2 a_vec2_widen;
attribute float a_float_vertex_distance;
attribute float a_float_component_distance;
attribute float a_float_object_length;
attribute vec4 a_vec4_identifier;
attribute float a_float_height;
varying vec4 v_vec4_identifier;
const float g_shift_pixels = 2.;
const float g_w_factor = 1e-7;
PolylineDistance decode_line_distance()
{
    return PolylineDistance(
        a_float_vertex_distance,
        a_float_component_distance,
        a_float_object_length);
}
StripedLineInParams decode_line_params(const Scale scale)
{
    float width = calculate_final_width(scale, u_float_width, u_float_width_offset);
    float dash_length  = scale.calculation * u_float_dash_length;
    float space_length = scale.calculation * u_float_space_length;
    float dash2_length = scale.calculation * u_float_dash2_length;
    return StripedLineInParams(
        dash_length,
        space_length,
        dash2_length,
        width);
}
void main()
{
    float height = 0.;
    if (u_bool_is_3d_line == true) {
        height = dem_height(a_vec2_vertex);
    }
    if (height == DEM_INVALID_VALUE) {
        gl_Position = vec4(0, 0, 1, 1);
        return;
    }
    if (u_bool_is_3d_line == true) {
        height += a_float_height / (65535. * 32.);
    }
    Scale scale = calculate_scale(u_vec3_projection_scale_style_scale_dpi, u_vec2_scaler_params);
    StripedLineInParams params = decode_line_params(scale);
    vec2 widen = unpack_widen(a_vec2_widen);
    vec2 widen_perp = vec2(-widen.y, widen.x);
    
    vec4 clip_space_widen = u_mat4_mvp * vec4(widen, 0., 0.);
    vec4 clip_space_widen_perp = u_mat4_mvp * vec4(widen_perp, 0., 0.);
    
    vec4 clip_space_vertex = u_mat4_mvp * vec4(a_vec2_vertex, height, 1.0) + clip_space_widen * params.line_width;
    vec2 half_viewport = 0.5 * u_vec2_vpt_size;
    
    float limited_factor = calculate_multiplication_factor(
        half_viewport,
        clip_space_widen,
        clip_space_widen_perp,
        clip_space_vertex,
        g_shift_pixels);
    PolylineDistance distance_decoded = decode_line_distance();
    StripedLineOutParams output_params;
    calculate_line_params(distance_decoded, params, output_params);
    v_vec4_identifier = a_vec4_identifier;
    if (vec4(1., 1., 1., 1.) != a_vec4_identifier)
    {
        gl_Position = (clip_space_vertex + clip_space_widen * limited_factor) * g_w_factor;
    }
    else
    {
        gl_Position = vec4(1., 1., 1., 1.);
    }
}
`,qO=`#include <prelude>
#include <mvp_mat>
#include <dem>
#include <packed_attributes>
#include <apply_height_factor>
#include <pos_world>
#include <cam_pos>
#include <fog>
#include <clipspace_pos>
#include <jitter>
#include <shadow>
uniform float u_float_height_factor;
attribute vec3 a_vec3_vertex;
attribute vec2 a_vec2_texcoord;
attribute vec2 a_vec2_dem_position;
varying vec2 v_vec2_texcoord;
varying vec3 v_vec3_rotated_scaled_vertex;
void main()
{
    float height = dem_height(unpack_dem_position(a_vec2_dem_position));
    
    if (height == DEM_INVALID_VALUE) {
        gl_Position = vec4(0, 0, 1, 1);
        return;
    }
    v_vec2_texcoord = unpack_model_texcoord(a_vec2_texcoord);
    vec4 vh = apply_height_factor(a_vec3_vertex, u_float_height_factor);
    vh.z += height;
    vec3 pos_world = calc_pos_world(vh);
    calc_fog_pos(pos_world);
    gl_Position = u_mat4_mvp * vh;
    
    
    mat4 rotation_scale_mat = u_mat4_model;
    rotation_scale_mat[3].xyz = vec3(0);
    v_vec3_rotated_scaled_vertex = (rotation_scale_mat * vec4(a_vec3_vertex, 1)).xyz;
    save_clipspace_pos();
#ifdef TAA
    apply_vertex_jitter(gl_Position);
#endif
    
    compute_shadow_vertex(gl_Position);
}
`,KO=`#include <prelude>
#include <mvp_mat>
#include <dem>
#include <round_position>
uniform vec2 u_vec2_vpt_size;
attribute vec3 a_vec3_vertex;
attribute vec4 a_vec4_identifier;
attribute vec2 a_vec2_dem_position;
varying vec4 v_vec4_identifier;
void main()
{
    float height = dem_height(unpack_dem_position(a_vec2_dem_position));
    
    if (height == DEM_INVALID_VALUE) {
        gl_Position = vec4(0, 0, 1, 1);
        return;
    }
    v_vec4_identifier = a_vec4_identifier;
    if (vec4(1., 1., 1., 1.) != a_vec4_identifier)
    {
        gl_Position = round_position(u_mat4_mvp * vec4(a_vec3_vertex.xy, a_vec3_vertex.z + height, 1.), .5 * u_vec2_vpt_size);
    }
    else
    {
        gl_Position = vec4(1., 1., 1., 1.);
    }
}
`,JO=`#include <prelude>
#include <mvp_mat>
#include <dem>
#include <apply_height_factor>
uniform float u_float_height_factor;
attribute vec3 a_vec3_vertex;
attribute vec2 a_vec2_dem_position;
varying float v_depth_metric;
void main()
{
    float height = dem_height(unpack_dem_position(a_vec2_dem_position));
    
    if (height == DEM_INVALID_VALUE) {
        gl_Position = vec4(0, 0, 1, 1);
        return;
    }
    vec4 vh = apply_height_factor(a_vec3_vertex, u_float_height_factor);
    vh.z += height;
    gl_Position = u_mat4_mvp * vh;
    v_depth_metric = (gl_Position.z + 1.0) / 2.0;
}
`,QO={apply_height_factor:DD,apply_opacity:Ww,arrow_functions:OD,calculate_scale:BD,cam_pos:Xw,clipspace_pos:kD,dem:ND,depth_test:UD,ecef_mvp_mat:GD,fog:jD,jitter:VD,line_width:HD,mvp_mat:ZD,packed_attributes:$D,pixel_offset:WD,pos_world:XD,precision_constants:YD,prelude:qD,raster_functions:KD,round_position:JD,shadow:QD,signed_distance_functions:Yw,striped_line_functions:eO},eB={arrow_line_entrance:tO,building_shadow:iO,circle_marker:nO,circle_marker_identify:sO,color:oO,color_identify:rO,dem_elevation:aO,dem_elevation_copy:lO,dem_flat_bottom:cO,dem_ground:dO,dem_ground2:hO,dem_mesh:uO,dem_mesh2:fO,dem_normal:_O,diffuse:mO,diffuse_identify:pO,globe:gO,globe_halo:vO,gltf_model:yO,gltf_shadow:wO,heatmap:bO,heatmap_texture:xO,label_directional:SO,label_fixed_anchor:MO,label_fixed_anchor_identify:IO,line:TO,line3d:EO,line3d_identify:AO,map_mesh:PO,mesh:LO,mesh_shadow:CO,mesh_stroke:RO,metric_point:zO,one_way_line:FO,patterned_line:DO,point_anchor:OO,pointsprite:BO,pointsprite_identify:kO,posteffect:NO,rect:UO,rect_with_texture:GO,road:jO,road_identify:VO,simple_line:HO,simple_mesh:ZO,sky:$O,stars:WO,striped_line:XO,striped_line_identify:YO,zbm_model:qO,zbm_model_identify:KO,zbm_shadow:JO},tB=/^\s*#include\s+<(.+)>.*$/gim,iB=(t,e)=>(i,n)=>{const s=n.trim(),o=t==="vertex"?QO[s]:zD[s];if(!o)throw new Error(`Cannot resolve "include <${s}>" in ${t} shader "${e}"`);return o+`
`};function qw(t,e){return[(t==="vertex"?eB[e]:FD[e]).replace(tB,iB(t,e))]}function le(t){const e=Do.webglVersion===2?["#version 300 es"]:[],i=Ps.createShaderDefinitions([{type:`WEBGL${Do.webglVersion}`,value:""},{type:Cz,value:""}]);return n=>new Ps("vertex",e.concat(qw("vertex",t)),i,n)}function ce(t){const e=Do.webglVersion===2?["#version 300 es"]:[],i=Ps.createShaderDefinitions([{type:`WEBGL${Do.webglVersion}`,value:""},{type:Lz,value:""}]);return n=>new Ps("fragment",e.concat(qw("fragment",t)),i,n)}const Ae={name:"u_mat4_mvp",type:"mat4"},Ds=[{name:"u_mat4_flat_mvp",type:"mat4"},{name:"u_mat4_ecef_mvp",type:"mat4"},{name:"u_float_crossfade",type:"1f"}],je={name:"u_mat4_model",type:"mat4"},Dm=[{name:"u_vec2_anchor",type:"2f"},{name:"u_vec4_axis",type:"4f"},{name:"u_int_gltf_dem_pos",type:"1i"}],We=[{name:"u_tex_dem",type:"1i"},{name:"u_tex_corrected_dem",type:"1i"},{name:"u_float_corrected_interval",type:"1f"},{name:"u_mat4_dem_corrected",type:"mat4"},{name:"u_tex_hillshade_ramp",type:"1i"},{name:"u_mat4_dem_mvp",type:"mat4"},{name:"u_float_dem_scale",type:"1f"},{name:"u_float_vertical_scale",type:"1f"},{name:"u_float_dem_resolution",type:"1f"},{name:"u_float_dem_cell_size",type:"1f"},{name:"u_float_dem_shading_intensity",type:"1f"},{name:"u_float_map_center_elevation",type:"1f"}],ro=[{name:"u_int_abs_z",type:"1i"}],tt=[{name:"u_cam_pos",type:"3f"}],Ft=[{name:"u_int_light_flags",type:"1i"},{name:"u_vec4_ambient_color",type:"4fv"},{name:"u_vec3_light_dir1_direction",type:"3fv"},{name:"u_vec4_light_dir1_color",type:"4fv"},{name:"u_vec3_light_dir2_direction",type:"3fv"},{name:"u_vec4_light_dir2_color",type:"4fv"}],Dt=[{name:"u_texture_shadow",type:"1i"},{name:"u_mat4_clip_to_shadow",type:"mat4"},{name:"u_shadow_map_params",type:"4f"},{name:"u_shadow_bias",type:"1f"}],it=[{name:"u_fog_color",type:"4f"},{name:"u_sky_color",type:"4f"},{name:"u_fog_limits",type:"2f"},{name:"u_fog_horizon_blend",type:"1f"},{name:"u_fog_horizon_level",type:"1f"},{name:"u_mat4_model",type:"mat4"},{name:"u_fog_distance",type:"1f"},{name:"u_mat4_proj_inverted",type:"mat4"},{name:"u_mat4_view_transposed",type:"mat4"}],Wt=[{name:"u_vec2_camera_jitter",type:"2f"}];function nB(){return{simpleMesh:{buildFragment:ce("simple_mesh"),buildVertex:le("simple_mesh"),attributes:[{name:"a_vec3_position",location:0},{name:"a_vec3_normal",location:1}],uniforms:[Ae,{name:"u_float_scale",type:"1f"},{name:"u_vec3_transform",type:"3fv"}]},diffuse:{buildVertex:le("diffuse"),buildFragment:ce("color_with_z_fade"),uniforms:[Ae,je,{name:"u_vec4_color",type:"4fv"},{name:"u_float_height_factor",type:"1f"},{name:"u_float_opacity",type:"1f"},{name:"u_sdtr_distance",type:"1f"},{name:"u_float_floor_elevation",type:"1f"},...tt,...Ft,...Dt,...We,...it,...Wt],attributes:[{name:"a_vec4_vertex",location:0},{name:"a_vec2_dem_position",location:1},{name:"a_float_visibility",location:2}]},gradientDiffuse:{buildVertex:le("diffuse"),buildFragment:ce("gradient_with_z_fade"),uniforms:[Ae,je,{name:"u_vec4_color",type:"4fv"},{name:"u_float_height_factor",type:"1f"},{name:"u_float_opacity",type:"1f"},{name:"u_mat4_gradient",type:"mat4"},{name:"u_sdtr_distance",type:"1f"},{name:"u_float_floor_elevation",type:"1f"},...tt,...Ft,...Dt,...We,...it,...Wt],attributes:[{name:"a_vec4_vertex",location:0},{name:"a_vec2_dem_position",location:1},{name:"a_float_visibility",location:2}]},labelLine:{buildVertex:le("label_directional"),buildFragment:ce("label_directional"),uniforms:[Ae,je,{name:"u_float_tile_to_pixel_ratio",type:"1f"},{name:"u_sr2d_texture",type:"1i"},{name:"u_float_buffer",type:"1f"},{name:"u_float_gamma",type:"1f"},{name:"u_float_scale",type:"1f"},{name:"u_vec4_color",type:"4fv"},{name:"u_float_style_zoom",type:"1f"},{name:"u_float_height_factor",type:"1f"},{name:"u_float_opacity",type:"1f"},...tt,...it],attributes:[{name:"a_vec4_position",location:0},{name:"a_vec2_offset",location:1},{name:"a_vec2_texcoord",location:2},{name:"a_vec2_style_zoom_limits",location:3}]},labelPoint:{buildVertex:le("label_fixed_anchor"),buildFragment:ce("label"),uniforms:[...Ds,je,{name:"u_vec2_vpt_size",type:"2f"},{name:"u_sr2d_texture",type:"1i"},{name:"u_float_buffer",type:"1f"},{name:"u_float_gamma",type:"1f"},{name:"u_float_scale",type:"1f"},{name:"u_vec4_color",type:"4fv"},{name:"u_vec4_hidden_color",type:"4fv"},{name:"u_float_label_index",type:"1f"},{name:"u_float_opacity",type:"1f"},{name:"u_vec2_offset",type:"2f"},{name:"u_float_height_factor",type:"1f"},{name:"u_depth_tex_labeling",type:"1i"},{name:"u_color_tex_labeling",type:"1i"},{name:"u_color_text_sprite_labeling",type:"1i"},{name:"u_vec2_depth_test_half_point_size",type:"2f"},{name:"u_bool_skip_height_factor",type:"1i"},{name:"u_bool_depth_test_disable",type:"1i"},{name:"u_float_floor_elevation",type:"1f"},...tt,...We,...it],attributes:[{name:"a_vec3_flat_position",location:0},{name:"a_vec3_ecef_position",location:1},{name:"a_vec2_offset",location:2},{name:"a_vec2_texcoord",location:3},{name:"a_vec2_check_offset",location:4},{name:"a_vec4_tex_identifier",location:5},{name:"a_vec4_sprite_identifier",location:6}]},labelPointIdentify:{buildVertex:le("label_fixed_anchor_identify"),buildFragment:ce("color_identify"),uniforms:[...Ds,{name:"u_vec2_vpt_size",type:"2f"},{name:"u_float_scale",type:"1f"},{name:"u_vec2_offset",type:"2f"},{name:"u_float_floor_elevation",type:"1f"},...We],attributes:[{name:"a_vec3_flat_position",location:0},{name:"a_vec3_ecef_position",location:1},{name:"a_vec2_offset",location:2},{name:"a_vec4_identifier",location:3}]},line:{buildVertex:le("line"),buildFragment:ce("line"),uniforms:[Ae,je,{name:"u_vec2_vpt_size",type:"2fv"},{name:"u_vec4_color",type:"4fv"},{name:"u_float_height_factor",type:"1f"},{name:"u_float_opacity",type:"1f"},{name:"u_mat4_gradient",type:"mat4"},{name:"u_float_floor_elevation",type:"1f"},...tt,...Ft,...Dt,...We,...it,...Wt],attributes:[{name:"a_vec4_vertex",location:0},{name:"a_vec2_normal",location:1},{name:"a_vec2_normal_delta",location:2},{name:"a_vec3_direction",location:3},{name:"a_float_distance",location:4},{name:"a_vec2_dem_position",location:5},{name:"a_float_visibility",location:6}]},pointSprite:{buildVertex:le("pointsprite"),buildFragment:ce("pointsprite"),uniforms:[...Ds,je,{name:"u_vec2_vpt_size",type:"2fv"},{name:"u_vec3_projection_scale_style_scale_dpi",type:"3fv"},{name:"u_sr2d_texture",type:"1i"},{name:"u_float_rounding_factor",type:"1f"},{name:"u_float_height_factor",type:"1f"},{name:"u_vec2_opacity",type:"2f"},{name:"u_vec2_rotation",type:"2fv"},{name:"u_depth_tex_labeling",type:"1i"},{name:"u_color_tex_labeling",type:"1i"},{name:"u_color_text_sprite_labeling",type:"1i"},{name:"u_vec2_depth_test_half_point_size",type:"2f"},{name:"u_bool_skip_height_factor",type:"1i"},{name:"u_bool_depth_test_disable",type:"1i"},{name:"u_float_floor_elevation",type:"1f"},...tt,...We,...it],attributes:[{name:"a_vec3_flat_position",location:0},{name:"a_vec3_ecef_position",location:1},{name:"a_vec2_offset",location:2},{name:"a_vec2_check_offset",location:3},{name:"a_vec2_texcoord",location:4},{name:"a_vec2_range",location:5},{name:"a_vec2_rescale",location:6},{name:"a_vec4_tex_identifier",location:7}]},pointSpriteIdentify:{buildVertex:le("pointsprite_identify"),buildFragment:ce("pointsprite_identify"),uniforms:[...Ds,{name:"u_vec2_vpt_size",type:"2fv"},{name:"u_vec3_projection_scale_style_scale_dpi",type:"3fv"},{name:"u_sr2d_texture",type:"1i"},{name:"u_float_height_factor",type:"1f"},{name:"u_vec2_rotation",type:"2fv"},{name:"u_bool_skip_height_factor",type:"1i"},{name:"u_float_floor_elevation",type:"1f"},...We],attributes:[{name:"a_vec3_flat_position",location:0},{name:"a_vec3_ecef_position",location:1},{name:"a_vec2_offset",location:2},{name:"a_vec2_texcoord",location:3},{name:"a_vec2_range",location:4},{name:"a_vec2_rescale",location:5},{name:"a_vec4_identifier",location:6}]},pointDepthTest:{buildVertex:le("point_anchor"),buildFragment:ce("color_identify"),uniforms:[Ae,{name:"u_vec2_vpt_size",type:"2f"},{name:"u_vec2_offset",type:"2f"},{name:"u_float_floor_elevation",type:"1f"},...We],attributes:[{name:"a_vec4_position",location:0},{name:"a_vec2_offset",location:1},{name:"a_vec4_identifier",location:2}]},stripedLine:{buildVertex:le("striped_line"),buildFragment:ce("striped_line"),uniforms:[Ae,je,{name:"u_vec2_vpt_size",type:"2fv"},{name:"u_vec3_projection_scale_style_scale_dpi",type:"3fv"},{name:"u_vec2_scaler_params",type:"2fv"},{name:"u_float_dash_length",type:"1f"},{name:"u_float_space_length",type:"1f"},{name:"u_float_dash2_length",type:"1f"},{name:"u_vec4_dash_color",type:"4fv"},{name:"u_vec4_space_color",type:"4fv"},{name:"u_vec4_border_color",type:"4fv"},{name:"u_float_width",type:"1f"},{name:"u_float_width_offset",type:"1f"},{name:"u_float_opacity",type:"1f"},{name:"u_bool_is_3d_line",type:"1i"},...tt,...it,...Wt,...Ft,...Dt],attributes:[{name:"a_vec2_vertex",location:0},{name:"a_vec2_texture_widen",location:1},{name:"a_vec2_widen",location:2},{name:"a_float_vertex_distance",location:3},{name:"a_float_component_distance",location:4},{name:"a_float_object_length",location:5},{name:"a_vec4_identifier",location:6}]},stripedLine3D:{buildVertex:le("striped_line"),buildFragment:ce("striped_line"),uniforms:[Ae,je,{name:"u_vec2_vpt_size",type:"2fv"},{name:"u_vec3_projection_scale_style_scale_dpi",type:"3fv"},{name:"u_vec2_scaler_params",type:"2fv"},{name:"u_float_dash_length",type:"1f"},{name:"u_float_space_length",type:"1f"},{name:"u_float_dash2_length",type:"1f"},{name:"u_vec4_dash_color",type:"4fv"},{name:"u_vec4_space_color",type:"4fv"},{name:"u_vec4_border_color",type:"4fv"},{name:"u_float_width",type:"1f"},{name:"u_float_width_offset",type:"1f"},{name:"u_float_opacity",type:"1f"},{name:"u_bool_is_3d_line",type:"1i"},...We,...tt,...it,...Wt,...Ft,...Dt],attributes:[{name:"a_vec2_vertex",location:0},{name:"a_vec2_texture_widen",location:1},{name:"a_vec2_widen",location:2},{name:"a_float_vertex_distance",location:3},{name:"a_float_component_distance",location:4},{name:"a_float_object_length",location:5},{name:"a_vec4_identifier",location:6},{name:"a_float_height",location:7}]},patternedLine:{buildVertex:le("patterned_line"),buildFragment:ce("patterned_line"),uniforms:[Ae,{name:"u_vec2_scales",type:"2fv"},{name:"u_vec4_color",type:"4fv"},{name:"u_float_width",type:"1f"},{name:"u_float_opacity",type:"1f"},{name:"u_int_pattern_type",type:"1i"},{name:"u_vec4_pattern_params",type:"4fv"},{name:"u_bool_is_3d_line",type:"1i"},je,...tt,...it,...Wt,...Ft,...Dt],attributes:[{name:"a_vec2_vertex",location:0},{name:"a_vec2_widen",location:1},{name:"a_float_texture",location:2},{name:"a_vec4_identifier",location:3}]},patternedLine3D:{buildVertex:le("patterned_line"),buildFragment:ce("patterned_line"),uniforms:[Ae,{name:"u_vec2_scales",type:"2fv"},{name:"u_vec4_color",type:"4fv"},{name:"u_float_width",type:"1f"},{name:"u_float_opacity",type:"1f"},{name:"u_int_pattern_type",type:"1i"},{name:"u_vec4_pattern_params",type:"4fv"},{name:"u_bool_is_3d_line",type:"1i"},je,...We,...tt,...it,...Wt,...Ft,...Dt],attributes:[{name:"a_vec2_vertex",location:0},{name:"a_vec2_widen",location:1},{name:"a_float_texture",location:2},{name:"a_vec4_identifier",location:3},{name:"a_float_height",location:4}]},stripedLineIdentify:{buildVertex:le("striped_line_identify"),buildFragment:ce("color_identify"),uniforms:[Ae,{name:"u_vec2_vpt_size",type:"2fv"},{name:"u_vec3_projection_scale_style_scale_dpi",type:"3fv"},{name:"u_vec2_scaler_params",type:"2fv"},{name:"u_float_dash_length",type:"1f"},{name:"u_float_space_length",type:"1f"},{name:"u_float_dash2_length",type:"1f"},{name:"u_vec4_dash_color",type:"4fv"},{name:"u_vec4_space_color",type:"4fv"},{name:"u_vec4_border_color",type:"4fv"},{name:"u_float_width",type:"1f"},{name:"u_float_width_offset",type:"1f"},{name:"u_float_opacity",type:"1f"},{name:"u_bool_is_3d_line",type:"1i"}],attributes:[{name:"a_vec2_vertex",location:0},{name:"a_vec2_texture_widen",location:1},{name:"a_vec2_widen",location:2},{name:"a_float_vertex_distance",location:3},{name:"a_float_component_distance",location:4},{name:"a_float_object_length",location:5},{name:"a_vec4_identifier",location:6}]},stripedLine3DIdentify:{buildVertex:le("striped_line_identify"),buildFragment:ce("color_identify"),uniforms:[Ae,{name:"u_vec2_vpt_size",type:"2fv"},{name:"u_vec3_projection_scale_style_scale_dpi",type:"3fv"},{name:"u_vec2_scaler_params",type:"2fv"},{name:"u_float_dash_length",type:"1f"},{name:"u_float_space_length",type:"1f"},{name:"u_float_dash2_length",type:"1f"},{name:"u_vec4_dash_color",type:"4fv"},{name:"u_vec4_space_color",type:"4fv"},{name:"u_vec4_border_color",type:"4fv"},{name:"u_float_width",type:"1f"},{name:"u_float_width_offset",type:"1f"},{name:"u_float_opacity",type:"1f"},{name:"u_bool_is_3d_line",type:"1i"},...We],attributes:[{name:"a_vec2_vertex",location:0},{name:"a_vec2_texture_widen",location:1},{name:"a_vec2_widen",location:2},{name:"a_float_vertex_distance",location:3},{name:"a_float_component_distance",location:4},{name:"a_float_object_length",location:5},{name:"a_vec4_identifier",location:6},{name:"a_float_height",location:7}]},vtxColor:{buildVertex:le("color"),buildFragment:ce("textured_color"),uniforms:[Ae,je,{name:"u_vec4_color",type:"4fv"},{name:"u_float_opacity",type:"1f"},{name:"u_sr2d_texture",type:"1i"},{name:"u_float_texture_opacity",type:"1f"},{name:"u_float_texture_params",type:"4fv"},{name:"u_float_sprite_texture_coords",type:"4fv"},{name:"u_int_is_textured",type:"1i"},{name:"u_float_floor_elevation",type:"1f"},...tt,...Ft,...Dt,...it,...Wt],attributes:[{name:"a_vec2_vertex",location:0},{name:"a_float_visibility",location:1}]},vtxColorIdentify:{buildVertex:le("color_identify"),buildFragment:ce("color_identify"),uniforms:[Ae,{name:"u_vec2_vpt_size",type:"2fv"},{name:"u_float_floor_elevation",type:"1f"}],attributes:[{name:"a_vec2_vertex",location:0},{name:"a_vec4_identifier",location:1},{name:"a_float_visibility",location:2}]},metricPoint:{buildVertex:le("metric_point"),buildFragment:ce("metric_point"),uniforms:[Ae,je,{name:"u_vec4_color",type:"4fv"},{name:"u_sr2d_texture",type:"1i"},{name:"u_float_sprite_texture_coords",type:"4fv"},{name:"u_float_floor_elevation",type:"1f"},...tt,...it,...Ft,...Dt],attributes:[{name:"a_vec2_vertex",location:0},{name:"a_vec2_texcoord",location:1}]},zbmModelIdentify:{buildVertex:le("zbm_model_identify"),buildFragment:ce("color_identify"),uniforms:[Ae,{name:"u_vec2_vpt_size",type:"2fv"},...We],attributes:[{name:"a_vec3_vertex",location:0},{name:"a_vec4_identifier",location:1},{name:"a_vec2_dem_position",location:2}]},buildingIdentify:{buildVertex:le("diffuse_identify"),buildFragment:ce("color_identify"),uniforms:[Ae,{name:"u_vec2_vpt_size",type:"2fv"},{name:"u_float_height_factor",type:"1f"},{name:"u_float_floor_elevation",type:"1f"},...We],attributes:[{name:"a_vec4_vertex",location:0},{name:"a_vec4_identifier",location:1},{name:"a_vec2_dem_position",location:2},{name:"a_float_visibility",location:3}]},oneWayLine:{buildVertex:le("one_way_line"),buildFragment:ce("one_way_line"),uniforms:[Ae,je,{name:"u_vec2_vpt_size",type:"2f"},{name:"u_vec3_projection_scale_style_scale_dpi",type:"3fv"},{name:"u_vec4_color",type:"4f"},{name:"u_vec4_border_color",type:"4f"},{name:"u_vec2_wing_normal",type:"2f"},{name:"u_vec2_tip_normal",type:"2f"},{name:"u_float_width",type:"1f"},{name:"u_float_length",type:"1f"},{name:"u_float_tip_radius_zpt",type:"1f"},{name:"u_float_wing_radius_zpt",type:"1f"},{name:"u_float_tail_radius_zpt",type:"1f"},{name:"u_float_border_width",type:"1f"},{name:"u_float_border_width_offset",type:"1f"},{name:"u_float_size_factor",type:"1f"},{name:"u_vec2_scale_limits",type:"2fv"},{name:"u_float_tip_height_multiplier",type:"1f"},{name:"u_float_wing_height_multiplier",type:"1f"},{name:"u_float_wing_width_multiplier",type:"1f"},{name:"u_float_opacity",type:"1f"},...tt,...it,...Wt],attributes:[{name:"a_vec2_position",location:0},{name:"a_vec2_direction",location:1},{name:"a_vec2_widen_direction",location:2}]},zbmModel:{buildVertex:le("zbm_model"),buildFragment:ce("zbm_model"),uniforms:[Ae,je,{name:"u_vec4_color",type:"4fv"},{name:"u_sr2d_texture",type:"1i"},{name:"u_float_height_factor",type:"1f"},{name:"u_sdtr_distance",type:"1f"},...tt,...We,...it,...Wt,...Ft,...Dt],attributes:[{name:"a_vec3_vertex",location:0},{name:"a_vec2_texcoord",location:1},{name:"a_vec2_dem_position",location:2}]},zbmShadow:{buildVertex:le("zbm_shadow"),buildFragment:ce("main_shadow"),uniforms:[Ae,{name:"u_float_height_factor",type:"1f"},...We],attributes:[{name:"a_vec3_vertex",location:0},{name:"a_vec2_dem_position",location:1}]},gltfModel:{buildVertex:le("gltf_model"),buildFragment:ce("gltf_model"),uniforms:[...Ds,je,{name:"u_mat4_instance",type:"mat4"},{name:"u_mat4_localmatrix",type:"mat4"},{name:"u_vec4_color",type:"4fv"},{name:"u_sr2d_texture_0",type:"1i"},{name:"u_ao_texture",type:"1i"},{name:"u_pbr_texture",type:"1i"},{name:"u_float_identify",type:"1f"},{name:"u_sdtr_distance",type:"1f"},{name:"u_float_height_factor",type:"1f"},{name:"u_float_show_ratio",type:"1f"},{name:"u_float_metallic",type:"1f"},{name:"u_float_roughness",type:"1f"},{name:"u_sampler_map_tex",type:"1i"},{name:"u_vec2_tex_scale",type:"2f"},{name:"u_float_tex_shift_scale",type:"1f"},{name:"u_float_floor_elevation",type:"1f"},...tt,...Wt,...it,...We,...Ft,...Dt,...ro,...Dm],attributes:[{name:"position",location:0},{name:"normal",location:1},{name:"tangent",location:2},{name:"a_vec3_instance_position",location:3},{name:"a_vec3_instance_ecef_position",location:4},{name:"a_mat3_instance_matrix",location:5,locationsCount:3},{name:"a_vec4_instance_localid",location:8},{name:"texcoord_color",location:9},{name:"texcoord_ao",location:10},{name:"texcoord_pbr",location:11},{name:"a_float_abs_z",location:12}]},gltfModelIdentify:{buildVertex:le("gltf_model"),buildFragment:ce("color_identify"),uniforms:[...Ds,je,{name:"u_mat4_instance",type:"mat4"},{name:"u_mat4_localmatrix",type:"mat4"},{name:"u_vec4_color",type:"4fv"},{name:"u_sr2d_texture_0",type:"1i"},{name:"u_float_identify",type:"1f"},{name:"u_float_height_factor",type:"1f"},{name:"u_float_show_ratio",type:"1f"},{name:"u_int_identify",type:"1i"},{name:"u_float_floor_elevation",type:"1f"},...tt,...it,...We,...ro,...Dm],attributes:[{name:"position",location:0},{name:"normal",location:1},{name:"tangent",location:2},{name:"a_vec3_instance_position",location:3},{name:"a_vec3_instance_ecef_position",location:4},{name:"a_mat3_instance_matrix",location:5,locationsCount:3},{name:"a_vec4_instance_localid",location:8},{name:"a_float_abs_z",location:12}]},gltfModelShadow:{buildVertex:le("gltf_shadow"),buildFragment:ce("main_shadow"),uniforms:[...Ds,{name:"u_mat4_instance",type:"mat4"},{name:"u_mat4_localmatrix",type:"mat4"},{name:"u_float_height_factor",type:"1f"},{name:"u_float_show_ratio",type:"1f"},...We,...ro,...Dm],attributes:[{name:"position",location:0},{name:"a_vec3_instance_position",location:3},{name:"a_vec3_instance_ecef_position",location:4},{name:"a_mat3_instance_matrix",location:5,locationsCount:3},{name:"a_float_abs_z",location:12}]},simpleLine:{buildVertex:le("simple_line"),buildFragment:ce("simple_line"),uniforms:[Ae,je,{name:"u_vec2_vpt_size",type:"2fv"},{name:"u_vec4_color",type:"4fv"},{name:"u_float_width",type:"1f"},{name:"u_float_height_factor",type:"1f"},{name:"u_int_signed_z",type:"1i"},{name:"u_float_z_offset",type:"1f"},{name:"u_float_floor_elevation",type:"1f"},...tt,...Wt,...Ft,...it,...Dt,...We,...ro],attributes:[{name:"a_vec3_vertex",location:0},{name:"a_float_z",location:1},{name:"a_vec4_direction_distance",location:2},{name:"a_vec2_dem_position",location:3},{name:"a_float_abs_z",location:4},{name:"a_float_visibility",location:5}]},road:{buildVertex:le("road"),buildFragment:ce("road"),uniforms:[Ae,je,{name:"u_vec4_color",type:"4fv"},{name:"u_float_width",type:"1f"},{name:"u_float_tile_to_pixel_ratio",type:"1f"},{name:"u_float_shift",type:"1f"},...tt,...Ft,...it,...Wt,...Dt],attributes:[{name:"a_vec2_vertex",location:0},{name:"a_vec4_normals",location:1},{name:"a_vec2_shift",location:2}]},roadIdentify:{buildVertex:le("road_identify"),buildFragment:ce("road_identify"),uniforms:[Ae,{name:"u_float_width",type:"1f"},{name:"u_float_tile_to_pixel_ratio",type:"1f"}],attributes:[{name:"a_vec2_vertex",location:0},{name:"a_vec4_normals",location:1},{name:"a_vec4_identifier",location:2}]},line3D:{buildVertex:le("line3d"),buildFragment:ce("road"),uniforms:[Ae,je,{name:"u_vec4_color",type:"4fv"},{name:"u_float_width",type:"1f"},{name:"u_float_tile_to_pixel_ratio",type:"1f"},...We,...tt,...Ft,...it,...Wt,...Dt],attributes:[{name:"a_vec2_vertex",location:0},{name:"a_vec4_normals",location:1},{name:"a_float_height",location:2}]},line3DIdentify:{buildVertex:le("line3d_identify"),buildFragment:ce("road_identify"),uniforms:[Ae,{name:"u_float_width",type:"1f"},{name:"u_float_tile_to_pixel_ratio",type:"1f"},...We],attributes:[{name:"a_vec2_vertex",location:0},{name:"a_vec4_normals",location:1},{name:"a_float_height",location:2},{name:"a_vec4_identifier",location:3}]},entrance:{buildVertex:le("arrow_line_entrance"),buildFragment:ce("arrow_line"),uniforms:[Ae,je,{name:"u_vec2_vpt_size",type:"2f"},{name:"u_vec3_projection_scale_style_scale_dpi",type:"3fv"},{name:"u_vec2_scale_limits",type:"2fv"},{name:"u_vec4_color",type:"4f"},{name:"u_vec4_border_color",type:"4f"},{name:"u_vec2_wing_normal",type:"2f"},{name:"u_vec2_tip_normal",type:"2f"},{name:"u_float_width_zpt",type:"1f"},{name:"u_float_tip_radius_zpt",type:"1f"},{name:"u_float_wing_radius_zpt",type:"1f"},{name:"u_float_tail_radius_zpt",type:"1f"},{name:"u_float_tip_height_multiplier",type:"1f"},{name:"u_float_wing_width_multiplier",type:"1f"},{name:"u_float_wing_height_multiplier",type:"1f"},{name:"u_float_border_width_zpt",type:"1f"},{name:"u_float_size_factor",type:"1f"},{name:"u_float_border_width_offset",type:"1f"},{name:"u_float_total_line_length",type:"1f"},{name:"u_float_relative_end_position",type:"1f"},{name:"u_float_vertex_shift",type:"1f"},{name:"u_float_tip_movement_amplitude",type:"1f"},{name:"u_vec2_bounce_direction",type:"2f"},{name:"u_float_opacity",type:"1f"},...tt,...it],attributes:[{name:"a_vec2_vertex",location:0},{name:"a_vec2_segment_end",location:1},{name:"a_vec4_texture_widen_arrow_widen",location:2},{name:"a_vec2_widen",location:3},{name:"a_vec2_direction",location:4},{name:"a_float_distance_from_start",location:5},{name:"a_float_object_length",location:6},{name:"a_float_type",location:7},{name:"a_vec4_identifier",location:8}]},entranceIdentify:{buildVertex:le("arrow_line_entrance"),buildFragment:ce("arrow_line_identify"),uniforms:[Ae,je,{name:"u_vec2_vpt_size",type:"2f"},{name:"u_vec3_projection_scale_style_scale_dpi",type:"3fv"},{name:"u_vec2_scale_limits",type:"2fv"},{name:"u_vec4_color",type:"4f"},{name:"u_vec4_border_color",type:"4f"},{name:"u_vec2_wing_normal",type:"2f"},{name:"u_vec2_tip_normal",type:"2f"},{name:"u_float_width_zpt",type:"1f"},{name:"u_float_tip_radius_zpt",type:"1f"},{name:"u_float_wing_radius_zpt",type:"1f"},{name:"u_float_tail_radius_zpt",type:"1f"},{name:"u_float_tip_height_multiplier",type:"1f"},{name:"u_float_wing_width_multiplier",type:"1f"},{name:"u_float_wing_height_multiplier",type:"1f"},{name:"u_float_border_width_zpt",type:"1f"},{name:"u_float_size_factor",type:"1f"},{name:"u_float_border_width_offset",type:"1f"},{name:"u_float_total_line_length",type:"1f"},{name:"u_float_relative_end_position",type:"1f"},{name:"u_float_vertex_shift",type:"1f"},{name:"u_float_tip_movement_amplitude",type:"1f"},{name:"u_vec2_bounce_direction",type:"2f"},{name:"u_float_opacity",type:"1f"}],attributes:[{name:"a_vec2_vertex",location:0},{name:"a_vec2_segment_end",location:1},{name:"a_vec4_texture_widen_arrow_widen",location:2},{name:"a_vec2_widen",location:3},{name:"a_vec2_direction",location:4},{name:"a_float_distance_from_start",location:5},{name:"a_float_object_length",location:6},{name:"a_float_type",location:7},{name:"a_vec4_identifier",location:8}]},circleMarker:{buildVertex:le("circle_marker"),buildFragment:ce("circle_marker"),uniforms:[...Ds,je,{name:"u_vec2_vpt_size",type:"2fv"},{name:"u_vec4_color",type:"4fv"},{name:"u_float_width",type:"1f"},...tt,...it,...Ft,...Dt],attributes:[{name:"a_vec3_flat_position",location:0},{name:"a_vec3_ecef_position",location:1},{name:"a_vec2_widen",location:2}]},rect:{buildVertex:le("rect"),buildFragment:ce("rect"),uniforms:[Ae,{name:"u_vec4_color",type:"4fv"}],attributes:[{name:"a_vec2_vertex",location:0}]},rectWithTexture:{buildVertex:le("rect_with_texture"),buildFragment:ce("rect_with_texture"),uniforms:[Ae,je,{name:"u_sr2d_texture",type:"1i"},{name:"u_float_opacity",type:"1f"},...it,...tt],attributes:[{name:"a_vec2_vertex",location:0},{name:"a_vec2_texcoord",location:1}]},circleMarkerIdentify:{buildVertex:le("circle_marker_identify"),buildFragment:ce("color_identify"),uniforms:[...Ds,{name:"u_vec2_vpt_size",type:"2fv"},{name:"u_float_width",type:"1f"}],attributes:[{name:"a_vec3_flat_position",location:0},{name:"a_vec3_ecef_position",location:1},{name:"a_vec2_widen",location:2},{name:"a_vec4_identifier",location:3}]},heatmap:{buildVertex:le("heatmap"),buildFragment:ce("heatmap"),uniforms:[Ae,je,...tt,{name:"u_float_radius",type:"1f"},{name:"u_float_intensity",type:"1f"},{name:"u_float_tile_to_pixel_ratio",type:"1f"},...it],attributes:[{name:"a_vec2_position",location:0},{name:"a_vec2_widen",location:1},{name:"a_float_weight",location:2}]},heatmapTexture:{buildVertex:le("heatmap_texture"),buildFragment:ce("heatmap_texture"),uniforms:[je,{name:"u_sr2d_texture",type:"1i"},{name:"u_sr2d_ramp_texture",type:"1i"},{name:"u_float_opacity",type:"1f"},...tt,...it],attributes:[{name:"a_vec2_position",location:0}]},demMesh:{buildVertex:le("dem_mesh"),buildFragment:ce("dem_mesh"),uniforms:[Ae,je,{name:"u_mat4_flat_map_mvp",type:"mat4"},{name:"u_flat_tex",type:"1i"},{name:"u_hillshade_tex",type:"1i"},...tt,...We,...it,...Wt,...Ft,...Dt],attributes:[{name:"a_vec2_position",location:0}]},demGround:{buildVertex:le("dem_ground"),buildFragment:ce("dem_ground"),uniforms:[Ae,je,...We],attributes:[{name:"a_vec2_position",location:0}]},demMesh2:{buildVertex:le("dem_mesh2"),buildFragment:ce("dem_mesh2"),uniforms:[Ae,je,{name:"u_mat4_flat_map_mvp",type:"mat4"},{name:"u_flat_tex",type:"1i"},{name:"u_hillshade_tex",type:"1i"},...tt,...We,...it,...Wt,...Ft,...Dt,{name:"u_use_flat_dem_mesh_normals",type:"1f"}],attributes:[{name:"a_vec2_vertex",location:0},{name:"a_vec3_normal",location:1},{name:"a_float_height",location:2}]},demGround2:{buildVertex:le("dem_ground2"),buildFragment:ce("dem_ground2"),uniforms:[Ae,je,...We],attributes:[{name:"a_vec2_vertex",location:0},{name:"a_float_height",location:1}]},demElevationCopy:{buildVertex:le("dem_elevation_copy"),buildFragment:ce("dem_elevation_copy"),uniforms:[Ae,{name:"u_sr2d_texture",type:"1i"},{name:"u_mat4_dem_corrected",type:"mat4"}],attributes:[{name:"a_vec2_vertex",location:0},{name:"a_vec2_texcoord",location:1}]},demElevation:{buildVertex:le("dem_elevation"),buildFragment:ce("dem_elevation"),uniforms:[Ae],attributes:[{name:"a_vec2_vertex",location:0},{name:"a_float_height",location:1}]},demHillshade:{buildVertex:le("dem_normal"),buildFragment:ce("dem_normal"),uniforms:[...We,...Ft,...Dt,Ae,{name:"u_sr2d_texture",type:"1i"}],attributes:[{name:"a_vec2_vertex",location:0},{name:"a_vec2_texcoord",location:1}]},demFlatBottom:{buildVertex:le("dem_flat_bottom"),buildFragment:ce("dem_flat_bottom"),uniforms:[Ae,...We],attributes:[{name:"a_vec2_vertex",location:0},{name:"a_vec2_centroid",location:1},{name:"a_vec2_extender",location:2}]},mesh:{buildVertex:le("mesh"),buildFragment:ce("mesh"),uniforms:[Ae,je,...tt,...We,...ro,...Ft,...Dt,...it,...Wt,{name:"u_float_opacity",type:"1f"},{name:"u_vec4_color",type:"4fv"},{name:"u_float_height_factor",type:"1f"},{name:"u_sdtr_distance",type:"1f"},{name:"u_mat4_gradient",type:"mat4"},{name:"u_int_identify",type:"1i"},{name:"u_sr2d_texture",type:"1i"},{name:"u_float_texture_opacity",type:"1f"},{name:"u_float_texture_params",type:"4fv"},{name:"u_float_sprite_texture_coords",type:"4fv"},{name:"u_int_is_textured",type:"1i"},{name:"u_float_texture_vertical_scale",type:"1f"}],attributes:[{name:"a_vec2_vertex",location:0},{name:"a_float_z",location:1},{name:"a_vec3_normal",location:2},{name:"a_float_gradient",location:3},{name:"a_vec2_dem_position",location:4},{name:"a_float_abs_z",location:5},{name:"a_vec4_identifier",location:6},{name:"a_float_visibility",location:7},{name:"a_float_is_pivot",location:8}]},meshDepthClear:{buildVertex:le("mesh"),buildFragment:ce("depth_clear"),uniforms:[Ae,je,...tt,...We,...ro,...Ft,...Dt,...it,...Wt,{name:"u_float_opacity",type:"1f"},{name:"u_vec4_color",type:"4fv"},{name:"u_float_height_factor",type:"1f"},{name:"u_sdtr_distance",type:"1f"},{name:"u_mat4_gradient",type:"mat4"},{name:"u_int_identify",type:"1i"},{name:"u_float_texture_params",type:"4fv"},{name:"u_int_is_textured",type:"1i"},{name:"u_float_texture_vertical_scale",type:"1f"}],attributes:[{name:"a_vec2_vertex",location:0},{name:"a_float_z",location:1},{name:"a_vec3_normal",location:2},{name:"a_float_gradient",location:3},{name:"a_vec2_dem_position",location:4},{name:"a_float_abs_z",location:5},{name:"a_vec4_identifier",location:6},{name:"a_float_visibility",location:7},{name:"a_float_is_pivot",location:8}]},meshStroke:{buildVertex:le("mesh_stroke"),buildFragment:ce("simple_line"),uniforms:[Ae,je,{name:"u_vec2_vpt_size",type:"2fv"},{name:"u_vec4_color",type:"4fv"},{name:"u_float_width",type:"1f"},{name:"u_float_height_factor",type:"1f"},{name:"u_int_signed_z",type:"1i"},{name:"u_float_z_offset",type:"1f"},...tt,...Wt,...Ft,...it,...Dt,...We,...ro],attributes:[{name:"a_vec2_vertex",location:0},{name:"a_float_z",location:1},{name:"a_vec4_direction_distance",location:2},{name:"a_vec2_dem_position",location:3},{name:"a_float_abs_z",location:4},{name:"a_float_visibility",location:5},{name:"a_float_is_pivot",location:6}]},mapMesh:{buildVertex:le("map_mesh"),buildFragment:ce("map_mesh"),uniforms:[Ae,je,...tt,...We,...Ft,...Dt,...ro,...it,...Wt,{name:"u_float_tile_size",type:"1f"},{name:"u_sampler_map_tex",type:"1i"},{name:"u_vec2_tex_scale",type:"2f"},{name:"u_float_tex_shift_scale",type:"1f"},{name:"u_float_height_factor",type:"1f"},{name:"u_sdtr_distance",type:"1f"},{name:"u_int_identify",type:"1i"}],attributes:[{name:"a_vec2_vertex",location:0},{name:"a_float_z",location:1},{name:"a_vec2_extender",location:2},{name:"a_vec3_normal",location:3},{name:"a_float_gradient",location:4},{name:"a_vec2_dem_position",location:5},{name:"a_float_abs_z",location:6},{name:"a_float_is_pivot",location:7}]},sky:{buildVertex:le("sky"),buildFragment:ce("sky"),uniforms:[je,...tt,...it,{name:"u_sky_color",type:"4f"}],attributes:[{name:"a_vec2_vertex",location:0}]},antialias:{buildVertex:le("posteffect"),buildFragment:ce("antialias"),uniforms:[{name:"u_texture",type:"1i"},{name:"u_float_mix_coef",type:"1f"}],attributes:[{name:"a_vec2_vertex",location:0}]},copy:{buildVertex:le("posteffect"),buildFragment:ce("copy"),uniforms:[{name:"u_texture",type:"1i"}],attributes:[{name:"a_vec2_vertex",location:0}]},copyDepth:{buildVertex:le("posteffect"),buildFragment:ce("copy_depth"),uniforms:[{name:"u_texture",type:"1i"},{name:"u_depth",type:"1i"}],attributes:[{name:"a_vec2_vertex",location:0}]},buildingShadow:{buildVertex:le("building_shadow"),buildFragment:ce("main_shadow"),uniforms:[...We,Ae,{name:"u_float_height_factor",type:"1f"},{name:"u_float_floor_elevation",type:"1f"}],attributes:[{name:"a_vec3_vertex",location:0},{name:"a_vec2_dem_position",location:1},{name:"a_float_visibility",location:2}]},meshShadow:{buildVertex:le("mesh_shadow"),buildFragment:ce("main_shadow"),uniforms:[Ae,{name:"u_float_height_factor",type:"1f"},...We,...ro],attributes:[{name:"a_vec2_vertex",location:0},{name:"a_float_z",location:1},{name:"a_vec2_dem_position",location:2},{name:"a_float_abs_z",location:3},{name:"a_float_visibility",location:4},{name:"a_float_is_pivot",location:5}]},globe:{buildVertex:le("globe"),buildFragment:ce("globe"),uniforms:[...Ds,{name:"u_sr2d_flatmap_texture",type:"1i"},{name:"u_vec4_extent",type:"4f"}],attributes:[{name:"a_vec3_ecef_position",location:0},{name:"a_vec3_flat_position",location:1},{name:"a_vec2_texture",location:2}]},globeHalo:{buildVertex:le("globe_halo"),buildFragment:ce("globe_halo"),uniforms:[{name:"u_vec2_halo_viewport_size",type:"2f"},{name:"u_vec2_halo_viewport_center_shift",type:"2f"},{name:"u_vec4_halo_radius_stops",type:"4f"},{name:"u_vec4_halo_color",type:"4f"},{name:"u_float_halo_exp_factor",type:"1f"},{name:"u_vec4_default_background_color",type:"4f"}],attributes:[{name:"a_vec2_vertex",location:0}]},stars:{buildVertex:le("stars"),buildFragment:ce("stars"),uniforms:[{name:"u_mat4_stars",type:"mat4"},{name:"u_float_pixelratio",type:"1f"},{name:"u_float_stars_intensity",type:"1f"}],attributes:[{name:"a_vec3_position",location:0},{name:"a_fade_opacity",location:1}]},globeHaloBackground:{buildVertex:le("globe_halo"),buildFragment:ce("globe_halo_background"),uniforms:[{name:"u_vec2_halo_viewport_size",type:"2f"},{name:"u_vec2_halo_viewport_center_shift",type:"2f"},{name:"u_vec4_halo_radius_stops",type:"4f"},{name:"u_vec4_halo_color",type:"4f"},{name:"u_float_halo_exp_factor",type:"1f"},{name:"u_vec4_default_background_color",type:"4f"}],attributes:[{name:"a_vec2_vertex",location:0}]}}}function sB(t,e){if(window.requestIdleCallback){const i=t.getRenderingContext();for(const n in e){const s=n;window.requestIdleCallback(()=>{if(i.isContextLost())return;const o=t.getShaderProgram(s);o.link(i),setTimeout(()=>{window.requestIdleCallback(()=>{i.isContextLost()||o.locate(i)})},2e3)})}}}class Kw{constructor(e){this.params=e,this._uniformsMap={},this._buffer=null,this._data=null}prepare(e,i){this._buffer||(this._buffer=e.createBuffer());const n=i.getUniformBlockSize(e,this.params.blockName);if(n===null){console.error("Failed to initialize UBO. Invalid UBO block is provided.");return}this._data=new Float32Array(new ArrayBuffer(n));const s=i.getUniformsIndicesOffsetsInBlock(e,this.params.uniformNames);if(!s){console.error("Failed to initialize UBO. Couldn't retrieve uniforms information.");return}this._uniformsMap=s}bind(e,i){const n=i.getUboBinding(this.params.blockName);n!==void 0&&(this._buffer||this.prepare(e,i),e.bindBufferBase(e.UNIFORM_BUFFER,n,this._buffer))}updateData(e,i,n){this._buffer||this.prepare(e,i);const s=this._data;for(const o in n){const r=n[o],a=this._uniformsMap[o]/4,l=i.uniforms[o];if(l!=null&&l.isNonFloatType()&&Ze(`[UBO Warn]: Currenty only float uniform types are supported. Uniform "${o}" has unsupported type`),hy(r)||Yn(r))for(let c=0;c<r.length;++c)s[a+c]=r[c];else s[a]=r}}commitData(e){this._data&&(e.bindBuffer(e.UNIFORM_BUFFER,this._buffer),e.bufferData(e.UNIFORM_BUFFER,this._data,e.DYNAMIC_DRAW),e.bindBuffer(e.UNIFORM_BUFFER,null))}cleanup(e){this._buffer&&e.deleteBuffer(this._buffer)}}const oB=["CommonSettings","LightSettings"],Jw={CommonSettings:["u_float_rounding_factor","u_float_border_width_offset","u_vec2_scale_limits","u_vec2_depth_test_half_point_size","u_sky_color","u_fog_color","u_fog_distance","u_fog_limits","u_fog_horizon_blend","u_fog_horizon_level","u_cam_pos","u_shadow_map_params","u_shadow_bias","u_mat4_clip_to_shadow","u_mat4_view_transposed","u_mat4_proj_inverted","u_vec2_halo_viewport_size","u_vec2_halo_viewport_center_shift","u_vec4_halo_radius_stops","u_vec4_halo_color","u_float_halo_exp_factor","u_vec4_default_background_color","u_float_pixelratio","u_mat4_stars","u_float_stars_intensity"],LightSettings:["u_vec4_ambient_color","u_vec3_light_dir1_direction","u_vec4_light_dir1_color","u_vec3_light_dir2_direction","u_vec4_light_dir2_color"]},rB=1.3,aB=2,Qw=Hn(),eb=Hn(),tb=Hn(),lB=16,cB=0,Os=[1,1,1,1],ib=new Float64Array(16),Om=Hn(),Ba=class Ba extends uL{constructor(e,i){const n=i.layout.canvas,s=e.webglVersion,o={antialias:!1,stencil:s!==2,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:e.preserveDrawingBuffer};let r=null;if((!s||s===2)&&(r=n.getContext("webgl2",o),Ba.webglVersion=2),(r===null||s===1)&&(r=n.getContext("webgl",o)||n.getContext("experimental-webgl",o),Ba.webglVersion=1),r===null||!(r instanceof WebGLRenderingContext||r instanceof WebGL2RenderingContext))throw new Error("Failed to obtain WebGL context");super({gl:r,clearColor:Tt(e.defaultBackgroundColor)}),this.commonShaderDefines=Ud,this.lastAppliedGlState={webglState:{state:null}},this.framebuffers=[],this.globeRenderTargets=[],this.lastRenderedFramebuffers=[],this.mapMeshMvpMatrix=new Float64Array(16),this.ubosMap={},this.trackContextLost=l=>{l.preventDefault(),this.modules.map.destroy()},this.state=e,this.modules=i;const a=r.getExtension("WEBGL_debug_renderer_info");this.webglContextState={MAX_TEXTURE_SIZE:r.getParameter(r.MAX_TEXTURE_SIZE),MAX_VIEWPORT_DIMS:r.getParameter(r.MAX_VIEWPORT_DIMS),MAX_UNIFORM_BUFFER_BINDINGS:r instanceof WebGLRenderingContext?0:r.getParameter(r.MAX_UNIFORM_BUFFER_BINDINGS),MAX_COMBINED_UNIFORM_BLOCKS:r instanceof WebGLRenderingContext?0:r.getParameter(r.MAX_COMBINED_UNIFORM_BLOCKS),RENDERER:a?r.getParameter(a.UNMASKED_RENDERER_WEBGL):r.getParameter(r.RENDERER),VENDOR:a?r.getParameter(a.UNMASKED_VENDOR_WEBGL):r.getParameter(r.VENDOR)},this.identifyBuffer=new Nt({minFilter:j.NearestFilter,magFilter:j.NearestFilter}),this.labelingTextureBuffer=new Nt({size:this.getViewportSize(),magFilter:j.NearestFilter,minFilter:j.NearestFilter,depthTexture:!0}),this.spriteLabelingTextureBuffer=new Nt({size:this.getViewportSize(),magFilter:j.NearestFilter,minFilter:j.NearestFilter,depthTexture:!1}),this.shaderProgramOptions=nB(),this.shaderPrograms={},i.map.once("idle",()=>sB(this,this.shaderProgramOptions)),this.symbolSettingsList=yF(),this.addExtension("OES_vertex_array_object").addExtension("OES_element_index_uint").addExtension("OES_standard_derivatives").addExtension("OES_texture_float").addExtension("OES_texture_float_linear").addExtension("ANGLE_instanced_arrays").addExtension("WEBGL_depth_texture").addExtension("EXT_frag_depth"),Ba.webglVersion===2&&this.addExtension("EXT_color_buffer_float").addExtension("EXT_frag_depth"),this.setPixelRatio(window.devicePixelRatio).setSize(i.layout.mapContainer.clientWidth,i.layout.mapContainer.clientHeight),e.collectStats&&(this.timers=new wF(this._gl)),i.layout.canvas.addEventListener("webglcontextlost",this.trackContextLost)}getViewportSize(e=1){const i=this.getPixelRatio();return this.state.size.map(n=>Math.floor(n*i/e))}setClearColor(e){const i=Tt(e);if(!go(i,this.clearColor))return this.clearColor=i,this.addRerenderEvent(),this}setSize(e,i){return this.modules.layout.setCanvasSize(e,i),this.updateFrameBuffersSize(),this}updateFrameBuffersSize(){var n;this.framebuffers.forEach(s=>{s&&s.onResize()});const e=this.getPixelRatio(),i=this.state.size.map(s=>Math.ceil(s*e));(n=this.modules.postEffectsManager)==null||n.invalidateSize(),this.identifyBuffer.setSize(i.map(s=>Math.ceil(s*rn.pixelDensity))),this.labelingTextureBuffer.setSize(i),this.spriteLabelingTextureBuffer.setSize(i)}clear(e=!0){return this.clearWithColor(this.clearColor,e),this}addRerenderEvent(e){this.state.rerenderEvents.push(e||{type:"coreNeedRerender"})}isNeedRerender(){return this.state.needRerender||this.state.rerenderEvents.length>0}clearWithColor(e,i=!0){const n=this._gl,s=i===!0?n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT:n.COLOR_BUFFER_BIT;vn(n,i?D1:IC,this.modules.renderer.lastAppliedGlState),n.clearDepth(1),n.clearColor(e[0],e[1],e[2],e[3]),n.clear(s)}getGlobeRenderTarget(e){if(e=Be(Math.trunc(e),1,4),!this.globeRenderTargets[e]){const i=this._gl,n=Be(self.devicePixelRatio,1,2),s=Math.min(this.webglContextState.MAX_TEXTURE_SIZE,c2*e*n),o=new Nt({size:[s,s],magFilter:j.LinearFilter,minFilter:j.LinearFilter,wrapS:j.ClampToEdgeWrapping,wrapT:j.ClampToEdgeWrapping});this.addFramebuffer({clearColor:[0,0,0,0],renderTarget:o,renderIndex:0,onResize:()=>{},onRenderStart:()=>{i.activeTexture(i.TEXTURE0+Om),i.bindTexture(i.TEXTURE_2D,null)}}),this.globeRenderTargets[e]=o}return this.globeRenderTargets[e]}renderTileObjects(e){this.state.collectStats&&this.timers&&this.timers.addTimer();let i=!1;const n=this.getRenderObjectsByGroups(e,!1);if(this.lastRenderedFramebuffers.forEach(s=>{n.groups.some(o=>o.framebuffer===s)||this.clearFramebuffer(s)}),this.lastRenderedFramebuffers=[],n.groups.forEach(({objects:s,tileObjects:o,framebuffer:r})=>{var m,p,_;const a=this.modules.map.state.demMode&&(r===void 0||r.useDem===!0),l=!r,c=(r==null?void 0:r.isCacheFramebuffer)&&!this.modules.renderCacheManager.hasReadyCache(),d=!r&&this.modules.postEffectsManager.hasActiveEffects();d&&(r=this.modules.postEffectsManager.mainFrameBufferWrapper);const h=Ro(this.state,this.modules,n.tiers,r==null?void 0:r.renderTarget,a);if(r)(m=r.onRenderStart)==null||m.call(r),this.lastRenderedFramebuffers.push(r),r.renderTarget.bind(this._gl),this._gl.viewport(0,0,r.renderTarget.options.size[0],r.renderTarget.options.size[1]),r.clearColor&&this.clearWithColor(r.clearColor,!!r.clearDepth);else{const{size:g,viewport:y}=this.state,b=window.devicePixelRatio;this._gl.bindFramebuffer(this._gl.FRAMEBUFFER,null),this._gl.viewport(y.left*b,y.bottom*b,g[0]*b,g[1]*b),this.clear(!0)}(l||c)&&(this.modules.environmentManager.renderSky(this._gl),a&&n.flatObjectsGroup&&!this.modules.renderCacheManager.hasReadyCache()&&!i&&(i=!0,this.renderDemMesh(h,n.flatObjectsGroup,!1,r))),l&&this.modules.renderCacheManager.render();const u=((p=r==null?void 0:r.getViewProjectionMatrix)==null?void 0:p.call(r))??this.modules.camera.viewProjectionMatrix,f=a?this.modules.demManager.demTextureMatrix:void 0;o.forEach(g=>{g.updateMvpMatrix(u,f)}),Ea(this.state,this.modules,s,h),r==null||r.renderTarget.unbind(this._gl),(_=r==null?void 0:r.onRenderEnd)==null||_.call(r),d&&this.modules.postEffectsManager.render(this._gl)}),this.state.collectStats&&this.timers){this.timers.stopTimer();const s=this.timers.tryToGetFirstTimerValue();s&&this.modules.map.emit("gpuRenderTime",s)}return this}renderSpriteLabelingTexture(e){if(this.modules.renderCacheManager.hasReadyCache())return;const i=this._gl,n=[],s=Ro(this.state,this.modules,void 0,this.spriteLabelingTextureBuffer),o=e.filter(r=>r.labelTestChildren[0]);o.forEach(r=>{r.updateMvpMatrix(this.modules.camera.viewProjectionMatrix)}),o.forEach(r=>{r.labelTestChildren.forEach(a=>{a.attributes.labelTest===!0&&n.push(a)})}),this.spriteLabelingTextureBuffer.bind(i),this.clearWithColor([1,1,1,1]),i.viewport(0,0,this.spriteLabelingTextureBuffer.options.size[0],this.spriteLabelingTextureBuffer.options.size[1]),Ea(this.state,this.modules,n,s),this.spriteLabelingTextureBuffer.unbind(i)}renderLabelingTexture(e){if(this.modules.renderCacheManager.hasReadyCache()||(this.state.isLabelingDepthTestDisabled=!0,this.state.styleZoom<lB||this.state.pitch===cB||this.state.disableHidingPois))return;const i=this._gl,n=[],s=Ro(this.state,this.modules,void 0,this.labelingTextureBuffer),o=e.filter(r=>r.depthTestChildren[0]);o.forEach(r=>{r.updateMvpMatrix(this.modules.camera.viewProjectionMatrix)}),o.forEach(r=>{r.depthTestChildren.forEach(a=>{const l=this.modules.styleManager.getStyleLayer(a.attributes.styleId,a.attributes.layerId);(l&&l.type!=="gltfModel"||!(l!=null&&l.style.preventObjectsHiding))&&n.push(a)})}),this.state.isLabelingDepthTestDisabled=!1,this.labelingTextureBuffer.bind(i),this.clearWithColor([1,1,1,1]),i.viewport(0,0,this.labelingTextureBuffer.options.size[0],this.labelingTextureBuffer.options.size[1]),Ea(this.state,this.modules,n,s),this.labelingTextureBuffer.unbind(i)}renderIdentify(e){const i=this._gl,n=this.getRenderObjectsByGroups(e,!0);n.groups.forEach(({objects:s,tileObjects:o,framebuffer:r})=>{var u,f;const a=this.modules.map.state.demMode&&(r===void 0||r.useDem===!0),l=r?r.renderTarget:this.identifyBuffer,c=Ro(this.state,this.modules,n.tiers,l,a);l.bind(i),this.clearIdentify(),a&&n.flatObjectsGroup&&this.renderDemMesh(c,n.flatObjectsGroup,!0),l.bind(i),i.viewport(0,0,l.options.size[0],l.options.size[1]);const d=((u=r==null?void 0:r.getViewProjectionMatrix)==null?void 0:u.call(r))??this.modules.camera.viewProjectionMatrix,h=a?this.modules.demManager.demTextureMatrix:void 0;o.forEach(m=>{m.updateMvpMatrix(d,h)}),Ea(this.state,this.modules,s,c),l.unbind(i),r==null||r.renderTarget.unbind(this._gl),(f=r==null?void 0:r.onRenderEnd)==null||f.call(r)}),this.addRerenderEvent()}readIdentifyPixels(){const e=this._gl,i=this.identifyBuffer.options.size,n=new Uint8Array(i[0]*i[1]*4);return this.identifyBuffer.bind(e),e.readPixels(0,0,i[0],i[1],e.RGBA,e.UNSIGNED_BYTE,n),this.identifyBuffer.unbind(e),n}getRenderingContext(){return this._gl}getShaderProgram(e,i){let n=this.shaderPrograms[e];n||(n={},this.shaderPrograms[e]=n);let s=n[this.commonShaderDefines.hash];s||(s={},n[this.commonShaderDefines.hash]=s);const o=(i==null?void 0:i.hash)??"",r=(i==null?void 0:i.defines)??[];let a=s[o];return a||(a=new _L(this.shaderProgramOptions[e],Ps.createShaderDefinitions([...this.commonShaderDefines.defines,...r]),oB),s[o]=a),a}destroy(){this.lastRenderedFramebuffers=[],this.framebuffers.forEach(i=>{i==null||i.renderTarget.remove()}),this.modules.layout.canvas.removeEventListener("webglcontextlost",this.trackContextLost);const e=this._gl.getExtension("WEBGL_lose_context");e&&e.loseContext(),this.modules.layout.destroy(),this.mapMeshFramebufferId=void 0,this.mapMeshIdFramebufferId=void 0}addFramebuffer(e){return this.framebuffers.push(e),this.framebuffers.length-1}getFramebuffer(e){if(e!==li)return this.framebuffers[e]}removeFramebuffer(e){var i;(i=this.framebuffers[e])==null||i.renderTarget.remove(),this.framebuffers[e]=void 0}setRenderTarget(e){this.currentTarget=e;const i=this._gl;if(e)e.bind(i),i.viewport(0,0,e.options.size[0],e.options.size[1]);else{i.bindFramebuffer(i.FRAMEBUFFER,null);const{size:n,viewport:s}=this.state,o=window.devicePixelRatio;i.viewport(s.left*o,s.bottom*o,n[0]*o,n[1]*o)}}getRenderTarget(){return this.currentTarget}renderDemMesh(e,i,n=!1,s){const{framebuffer:o,tiles:r}=i;if(!o)return;let a=this.modules.demManager.getFlatMapTextures();if(n&&(a=a.filter(T=>T.detailLevel===0)),!a.length)return;const l=this.modules.demManager.getMeshTiles();if(!l.length)return;const c=l[0],h=(n?c.identifyChildren:c.children).filter(({sink:T})=>T==="mesh"||T==="mesh2")[0];if(!h)return;const u=this.state.handyStyleId,f=this.modules.styleManager.getStyleLayer(u,is);if(!f||Cm(h))return;const{size:m,viewport:p}=this.state,_=window.devicePixelRatio,{commonBinder:g,programBinder:y,layerBinder:b,programName:v}=h.layerSettings,I=this.modules.renderer.getShaderProgram(v),S=[];r.forEach((T,L)=>{S.push({objects:T,tile:L})});const P=e.copy(o.renderTarget,!1,!0);a.forEach(T=>{var O,w;const B=S.filter(x=>nb(T.viewport,x.tile.bounds.values())).reduce((x,C)=>(C.tile.updateMvpMatrix(T.mvpMatrix,this.modules.demManager.demTextureMatrix),x.concat(C.objects)),[]);if((O=o.onRenderStart)==null||O.call(o),o.renderTarget.bind(this._gl),this._gl.viewport(0,0,o.renderTarget.options.size[0],o.renderTarget.options.size[1]),o.clearColor&&this.clearWithColor(o.clearColor,!1),Ea(this.state,this.modules,B,P),o.renderTarget.unbind(this._gl),(w=o.onRenderEnd)==null||w.call(o),n){this.identifyBuffer.bind(this._gl);const x=this.identifyBuffer.options.size;this._gl.viewport(0,0,x[0],x[1])}else s?(this._gl.viewport(0,0,s.renderTarget.options.size[0],s.renderTarget.options.size[1]),s.renderTarget.bind(this._gl)):this._gl.viewport(p.left*_,p.bottom*_,m[0]*_,m[1]*_);I.enable(this._gl),this._gl instanceof WebGLRenderingContext&&(g==null||g(this._gl,I,this.state,this.modules)),y==null||y(this._gl,I,this.state,this.modules,!0),b==null||b(this._gl,I,this.state,this.modules,f),e.useState(h,f),l.forEach(x=>{if(x instanceof U_&&x.needSync&&x.syncReplicas(this.state),nb(T.viewport,x.bounds.values())){x.updateMvpMatrix(this.modules.camera.viewProjectionMatrix,this.modules.demManager.demTextureMatrix,T.texMatrix);const C=(n?x.identifyChildren:x.children).filter(({sink:V})=>V==="mesh"||V==="mesh2");cm(C,this.state,this.modules),e.drawSymbol(C,f,this.state,this.modules)}}),n&&this.identifyBuffer.unbind(this._gl)})}getMapMeshFramebufferId(){return this.mapMeshFramebufferId===void 0&&(this.mapMeshFramebufferId=this.createMapMeshFramebuffer()),this.mapMeshFramebufferId}getMapMeshIdFramebufferId(){return this.mapMeshIdFramebufferId===void 0&&(this.mapMeshIdFramebufferId=this.createMapMeshFramebuffer(!0)),this.mapMeshIdFramebufferId}prerenderUpdate(){const e=this.rebuildExternalShaderDefinitions();this.updateUbos(e)}getRenderObjectsByGroups(e,i){const{demManager:n,map:s}=this.modules,{demMode:o}=s.state,r={},a={framebuffer:void 0,objects:[],tileObjects:new Set},l={};let c;if(o){const h=i?n.getIdentifyFlatFramebufferId():n.getFlatFramebufferId(),u=this.getFramebuffer(h);u&&(c={framebuffer:u,tiles:new Map})}i||a.objects.push(...this.modules.styleManager.getCustomSceneObjects()),e.forEach(h=>{(i?h.identifyChildren:h.children).forEach(f=>{var g;const m=this.modules.demManager.getReliefTileType();if(m==="raster"&&f.sink==="ground2"||m==="vector"&&f.sink==="ground"||f.sink==="mesh2")return;const p=this.modules.styleManager.getFramebufferId(f.attributes.styleId,f.attributes.layerId),_=p?p[f.sink]:void 0;if(_!==li){if(_===void 0){const y=f.attributes.tiers;if(this.state.immersiveLevel.tiers&&y){let v=!1;if(y.forEach(I=>{if(!I){v=!0;return}l[I]||(l[I]={objects:[],tileObjects:new Set}),l[I].objects.push(f),l[I].tileObjects.add(h)}),!v)return}if(o&&!f.layerSettings.is3dMapAware)c!=null&&c.tiles.has(h)?(g=c==null?void 0:c.tiles.get(h))==null||g.push(f):c==null||c.tiles.set(h,[f]),this.modules.renderCacheManager.checkFlatObjectAnimation(f);else{if(!i&&this.modules.renderCacheManager.tryToCacheObjects(r,f,h))return;a.objects.push(f),a.tileObjects.add(h)}return}r[_]||(r[_]={framebuffer:this.getFramebuffer(_),objects:[],tileObjects:new Set}),r[_].objects.push(f),r[_].tileObjects.add(h)}})});const d=Object.values(r).filter(h=>!!h.framebuffer);return d.sort((h,u)=>{var p,_;const f=((p=h.framebuffer)==null?void 0:p.renderIndex)??0,m=((_=u.framebuffer)==null?void 0:_.renderIndex)??0;return f-m}),d.push(a),{flatObjectsGroup:c,groups:d,tiers:l}}getUbo(e){return this.ubosMap[e]}getMemoryFootprint(){const e={framebuffers:this.framebuffers.filter(i=>i!==void 0).map(i=>i.renderTarget.memSizeGPU()),identifyBuffer:this.identifyBuffer.memSizeGPU(),labelingTextureBuffer:this.labelingTextureBuffer.memSizeGPU()};return{gpu:{...e,"--sum":ui(e)}}}updateUbos(e=!1){const i=this._gl;if(i instanceof WebGLRenderingContext)return;e&&this.cleanupUbos(i);const n=this.getShaderProgram("diffuse");n.link(i),n.locate(i);let s=this.ubosMap.CommonSettings;(!s||e)&&(s=new Kw({blockName:"CommonSettings",uniformNames:Jw.CommonSettings}),this.ubosMap.CommonSettings=s,s.bind(i,n)),wL(i,n,this.state,this.modules,s),s.commitData(i);const o=this.modules.map.state,r=!isNaN(o.handyStyleId)&&this.modules.styleManager.getStyle(o.handyStyleId)||void 0,a=(r==null?void 0:r.light.lightingModesResolved)??o1;for(const l in a){let c=this.ubosMap[l];(!c||e)&&(c=new Kw({blockName:"LightSettings",uniformNames:Jw.LightSettings}));const d=a[l];c.updateData(i,n,{u_vec3_light_dir1_direction:d.dir1Direction,u_vec4_light_dir1_color:d.dir1ColorIntensity,u_vec3_light_dir2_direction:d.dir2Direction,u_vec4_light_dir2_color:d.dir2ColorIntensity,u_vec4_ambient_color:d.ambientColorIntensity}),this.ubosMap[l]=c,c.commitData(i)}}cleanupUbos(e){for(const i in this.ubosMap)this.ubosMap[i].cleanup(e);this.ubosMap={};for(let i=0;i<this.webglContextState.MAX_UNIFORM_BUFFER_BINDINGS;i++)e.bindBufferBase(e.UNIFORM_BUFFER,i,null)}rebuildExternalShaderDefinitions(){const e=this.prepareExternalShaderDefinitions();return this.commonShaderDefines.hash!==e.hash?(this.commonShaderDefines=e,!0):!1}clearIdentify(){const e=this._gl;e.depthMask(!0),e.clearColor(Os[0],Os[1],Os[2],Os[3]),e.clearDepth(1),e.clearStencil(0),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT|e.STENCIL_BUFFER_BIT)}clearFramebuffer(e){e.clearColor&&(e.renderTarget.bind(this._gl),this._gl.viewport(0,0,e.renderTarget.options.size[0],e.renderTarget.options.size[1]),this.clearWithColor(e.clearColor,!1),e.renderTarget.unbind(this._gl))}createMapMeshFramebuffer(e){const i=this.modules.renderer.getRenderingContext(),n=e?j.NearestFilter:j.LinearFilter,{scale:s,size:o}=this.calculateMapMeshParams(e),r=new Nt({size:o,magFilter:n,minFilter:n,wrapS:j.ClampToEdgeWrapping,wrapT:j.ClampToEdgeWrapping}),a={getViewProjectionMatrix:()=>{const l=1-Math.cos(this.modules.map.state.pitch),c=a.scale??this.calculateMapMeshParams(e).scale;return En(ib,[0,l/c[1],0],[1/c[0],1/c[1],1]),ri(this.mapMeshMvpMatrix,ib,this.modules.camera.viewProjectionMatrix),this.mapMeshMvpMatrix},onResize:()=>{const l=this.calculateMapMeshParams(e);a.scale=l.scale,r.setSize(l.size),r.bind(i),r.unbind(i)},renderTarget:r,scale:s};return this.modules.renderer.addFramebuffer(a)}calculateMapMeshParams(e){const i=e?rn.pixelDensity:1,n=window.devicePixelRatio,s=Ei([],this.modules.map.state.size,n),o=Math.min(rB,Math.min(this.webglContextState.MAX_TEXTURE_SIZE,this.webglContextState.MAX_VIEWPORT_DIMS[0])/s[0]),r=Math.min(aB,Math.min(this.webglContextState.MAX_TEXTURE_SIZE,this.webglContextState.MAX_VIEWPORT_DIMS[1])/s[1]),a=[Math.trunc(s[0]*i*o),Math.trunc(s[1]*i*r)];return{scale:[o,r],size:a}}prepareExternalShaderDefinitions(){const e=[];return this.modules.environmentManager.isFogEnabled()&&e.push({type:Rz}),this.modules.environmentManager.isSkyEnabled()&&e.push({type:zz}),this.modules.shadowManager.texture&&e.push({type:jz}),this.state.disableAntiAliasing||e.push({type:Y1.TAA}),Qd(this._gl)&&e.push({type:Gz}),this.webglContextState.MAX_UNIFORM_BUFFER_BINDINGS>0&&e.push({type:Vz}),this.state.isDeprecatedSystem||(e.push({type:Hz}),e.push({type:Zz})),this.webglContextState.RENDERER.toLowerCase().includes("mali")&&this.webglContextState.VENDOR.toLowerCase().includes("arm")&&e.push({type:$z}),Ps.createShaderDefinitions(e)}};Ba.webglVersion=NaN;let Do=Ba;function nb(t,e){for(const i of e)if(tr(t,i))return!0;return!1}class dB{constructor(e,i){this.idScopes={},this.isIdle=()=>this.searchQueue.size===0,this.state=e,this.modules=i,this.identifyData=[],this.needsUpdate=!1,this.forceUpdate=!1,this.searchQueue=new Map,this.stateDiffer=new Et([{path:"center",type:"vec2"},{path:"zoom",type:"number"},{path:"size",type:"vec2"},{path:"rotation",type:"number"},{path:"pitch",type:"number"},{path:"padding",type:"padding"},{path:"demMode",type:"boolean"}]),this.debouncedFillCache=Fl(()=>{this.needsUpdate=!0},rn.cacheDebounceTime),this.throttledFillCache=br(()=>{this.needsUpdate=!0},rn.cacheThrottleTime)}getMemoryFootprint(){var i;const e={colorBuffer:((i=this.colorBuffer)==null?void 0:i.byteLength)??0};return{js:{...e,"--sum":ui(e)}}}resetCache(){this.colorBuffer=void 0,this.debouncedFillCache()}search(e,i,n=!1){return this.colorBuffer===void 0&&n&&(this.needsUpdate=!0),this.forceUpdate=n,new Promise(s=>{this.searchQueue.set(e,{point:i,resolve:s})})}searchSync(e){return this.searchHigherPriority(e)}update(){this.stateDiffer.check(this.state)&&(this.resetCache(),this.searchQueue.size>0&&this.searchQueue.clear()),this.needsUpdate&&(this.forceUpdate||this.modules.dynamicStyle.hasDynamicObjects||this.modules.tileManager.isIdle()&&this.modules.labeler.isIdle()&&this.modules.layers.entranceAnimationFinished()&&this.modules.modelLayer.isIdle()&&!this.modules.buildingHeightAnimator.isAnimating()&&this.modules.assetManager.isIdle())&&(this.fillCache(),this.needsUpdate=!1,this.forceUpdate=!1),this.colorBuffer!==void 0&&this.searchQueue.size>0&&(this.searchQueue.forEach(e=>{e.resolve(this.searchHigherPriority(e.point))}),this.searchQueue.clear())}getIdScope(e){return this.idScopes[e]||(this.idScopes[e]=new t4(this)),this.idScopes[e]}searchHigherPriority(e){const{viewport:i}=this.state,n=au(e[0]-i.left,e[1]-i.top),s=this.state.identifyPickDistance*window.devicePixelRatio;let o=1/0,r,a=!1;const l=xt();for(l[0]=n[0]-s;l[0]<n[0]+s;l[0]++)for(l[1]=n[1]-s;l[1]<n[1]+s;l[1]++){const c=this.searchPointInCache(l);if(!c)continue;const d=c.dynamicObjectId!==void 0;if(d&&(c.phase=this.modules.dynamicStyle.getRenderIndexById(c.layerId)),a&&!d)continue;const h=Un(n,l);(!r||!a&&d||c.phase>r.phase||c.phase===r.phase&&h<o)&&(r=c,o=h,d&&(a=!0))}return r}searchPointInCache(e){if(this.colorBuffer===void 0)return;const i=rn.pixelDensity*window.devicePixelRatio,n=this.modules.renderer.identifyBuffer.options.size,s=this.state.size;if(e[0]<0||e[0]>s[0]-1||e[1]<0||e[1]>s[1]-1)return;const o=Math.floor(e[0]*i),a=((n[1]-1-Math.floor(e[1]*i))*n[0]+o)*4,l=(this.colorBuffer[a+3]<<24|this.colorBuffer[a+2]<<16|this.colorBuffer[a+1]<<8|this.colorBuffer[a])>>>0;return this.indexToIdentifierResponse(l)}fillCache(){const e=this.modules.tileManager.getTileObjects();this.modules.renderer.renderIdentify(e),this.colorBuffer=this.modules.renderer.readIdentifyPixels();const i=this.state.metrics;i.interactive===void 0&&(i.interactive=performance.now()-i.start),this.identifyData=this.modules.tileManager.getDisplayedIdentifyData(),this.modules.modelLayer.getDisplayedIdentifyData().forEach(s=>this.identifyData.push(s));const n=this.modules.personalPoiManager.getIdentifyDataChunk();n!==void 0&&this.identifyData.push(n),this.modules.layers.getDynamicObjectLayers().forEach(s=>{s.getIdentifyData().forEach(o=>this.identifyData.push(o))})}indexToIdentifierResponse(e){var i,n;for(let s=0;s<this.identifyData.length;s++){const o=this.identifyData[s],{dynamicObjectId:r,ids:a,metatileHash:l,sourceId:c,tileKey:d}=o,{startIndex:h,endIndex:u,idBuffer:f,floorIdBuffer:m,phaseBuffer:p,sublayerBuffer:_,styleIdBuffer:g,layerIdBuffer:y,instanceIdBuffer:b,objectClassBuffer:v,centerBuffer:I,strings:S}=a;if(e<h||e>u)continue;const P=e-h,T=f[P],L=new Uint32Array(_)[P],B=new Uint8Array(b)[P],O=new Uint32Array(v)[P];let w,x="";const C=m[P],V=this.modules.assetManager.getMetatile(l);if(V){(i=V.reverseDictionaries.db_sublayer)!=null&&i[L]&&(w=V.reverseDictionaries.db_sublayer[L]);const D=S[e];D!==void 0?x=D.objectClass:x=((n=V==null?void 0:V.reverseDictionaries.db_object_class)==null?void 0:n[O])??""}const M=new Uint16Array(g)[P],A=new Uint32Array(y)[P],E=this.modules.styleManager.getStyleLayer(M,A);if(!E||E.type==="custom")return;const k=new Int32Array(I,P*Int32Array.BYTES_PER_ELEMENT*2,2);return{id:T,styleId:M,layerId:A,floorId:C,phase:new Float32Array(p)[P],dynamicObjectId:r,sourceId:c,tileKey:d,sublayer:w,symbol:E.type,instanceId:B,objectClass:x,center:k[0]!==oc||k[1]!==oc?[k[0],k[1]]:void 0}}}}class sb{constructor(e){this.map=(e==null?void 0:e.map)||{}}set(e,i,n){this.map[e]===void 0&&(this.map[e]={}),this.map[e][i]=n}get(e,i){const n=this.map[e];if(n!==void 0)return n[i]}has(e,i){const n=this.map[e];return n===void 0?!1:n[i]!==void 0}reduce(e,i){return Object.values(this.map).reduce((n,s)=>Object.values(s).reduce((o,r,a,l)=>e(o,r,a,l),n),i)}}const hB=17,Ih=6;class uB{constructor(){this.name="",this.range="",this.glyphs={}}}class fB{constructor(){this.id=0,this.range=0,this.bitmap=null,this.top=0,this.left=0,this.advance=0,this.x=0,this.y=0,this.width=0,this.height=0,this.texTop=0,this.texLeft=0,this.texRight=0,this.texBottom=0}}class _B{constructor(e,i){this.stacks=e.readFields(mB,[],i)}}function mB(t,e,i){if(t===1){const n=i.readMessage(pB,new uB);e.push(n)}}function pB(t,e,i){switch(t){case 1:e.name=i.readString();break;case 2:e.range=i.readString();break;case 3:{const n=i.readMessage(gB,new fB);e.glyphs[n.id]=n;break}}}function gB(t,e,i){switch(t){case 1:e.id=i.readVarint(),e.range=qu(e.id);break;case 2:e.bitmap=i.readBytes();break;case 3:e.width=i.readVarint()+Ih;break;case 4:e.height=i.readVarint()+Ih;break;case 5:e.left=i.readSVarint()-Ih/2;break;case 6:e.top=i.readSVarint()+hB+Ih/2;break;case 7:e.advance=i.readVarint();break}}class vB{constructor(e,i,n){const s=[];let o=0;for(let r=0;r<e.length;r++){const a=e.charCodeAt(r),l=i&&i[a];l?(s.push(l),o=o+l.advance):a!==jt.bomCharCode&&pM(e[r],a)}this.glyphs=s,this.width=o+jt.baseSize*n*(e.length-1)}}function yB(t,e,i){const n={lines:[],maxWidth:0},s=t.split(`
`);for(let o=0;o<s.length;o++){const r=new vB(s[o],i,e);n.lines.push(r),r.width>n.maxWidth&&(n.maxWidth=r.width)}return n}function wB(t){const e=new _B(new Sc(new Uint8Array(t))).stacks[0].glyphs,{width:i,height:n}=bB(e);xB(e,i,n);const s=SB(e,i,n);return{glyphData:e,bitmap:s,width:i,height:n}}function bB(t){const e=[],i=new en(512,512,{autoResize:!0}),n=Object.keys(t);for(let s=0;s<n.length;s++){const o=t[Number(n[s])];o.bitmap&&e.push({glyph:o,width:o.width,height:o.height})}i.pack(e,{inPlace:!0}),i.shrink();for(let s=0;s<e.length;s++){const o=e[s].glyph;o.x=e[s].x,o.y=e[s].y}return{width:cg(i.w),height:cg(i.h)}}function xB(t,e,i){const n=Object.keys(t);for(let s=0;s<n.length;s++){const o=t[Number(n[s])];o.bitmap&&(o.texTop=Yi(o.y/i),o.texLeft=Yi(o.x/e),o.texBottom=Yi((o.y+o.height)/i),o.texRight=Yi((o.x+o.width)/e))}}function SB(t,e,i){const n=new Uint8Array(e*i),s=Object.keys(t);for(let o=0;o<s.length;o++){const r=t[Number(s[o])];if(r.bitmap)for(let a=0;a<r.height;a++){const l=e*(r.y+a)+r.x,c=r.width*a;for(let d=0;d<r.width;d++)n[l+d]=r.bitmap[c+d]}}return n.buffer}function MB(t,e,i){var o;if(t.id===void 0)throw new Error("The layer id must be set.");if(e.layerIdToInnerId[t.id])throw new Error(`The layer with id «${t.id}» already exists in the map style.`);let n=-1;if(i){const r=Object.values(e.groupsById).find(a=>a&&a.id===i);if(r)n=e.layers.findIndex(a=>a.groupId===r.innerId);else{n=e.layers.findIndex(l=>l.id===i);const a=(o=e.layers[n])==null?void 0:o.groupId;if(a!==void 0&&t.type==="group")throw new Error(`Group layer with id «${t.id}» can't be added before layer with id «${i}» in group with innerId «${a}». Layer groups doesn't support nesting.`)}}else n=e.layers.length;if(n===-1)throw new Error(`The layer with beforeId «${i}» doesn't exist in the map style.`);let s=[];if(t.type!=="group"){s=[t];const r=n!==e.layers.length?e.layers[n]:void 0;if(r&&r.groupId!==void 0){const a=e.groupsById[r.groupId];if(!a){Ze(`Для слоя с id «${r.id}» находящегося в группе с groupId «${r.groupId}» отсутствует группа id в стиле c id «${e.id}»`);return}const l=a.layers.findIndex(c=>c.id===r.id);if(l===-1){Ze(`Слой с id «${r.id}» и groupId «${r.groupId}» отсутствует группе в стиле c id «${e.id}»`);return}t.groupId=a.innerId,a.layers.splice(l,0,t),a.layers.forEach((c,d)=>c.groupIndex=d)}}else e.groupsById[t.innerId]=t,e.layerIdToInnerId[t.id]=t.innerId,s=t.layers;e.revision++,e.layers.splice(n,0,...s),s.forEach(r=>{if(e.layersById[r.innerId]=r,e.layerIdToInnerId[r.id]=r.innerId,r.type==="point"||r.type==="polygon"||r.type==="metricPoint"||r.type==="embankment"||r.type==="polygon3d"){const a=Math.max(0,...Object.keys(e.rasterSets.byIndex).map(d=>Number(d))),l=new zl(a+1);u0(r,l).forEach(d=>{e.rasterSets.byKey[d.key]||(e.rasterSets.byIndex[d.index]=d,e.rasterSets.byKey[d.key]=d)})}}),ob(e)}function IB(t,e,i){const n=e.layerIdToInnerId[t];if(n===void 0)return;e.revision++;let s=[];const o=e.groupsById[n];if(o){if(s=o.layers,delete e.groupsById[n],delete e.layerIdToInnerId[o.id],s.length===0)return}else{const a=e.layersById[n];if(!a){Ze(`Слой с id «${t}» есть в списке идентификаторов слоев стиля, но при этом отсутствует в стиле c id «${e.id}»`);return}if(a.groupId!==void 0&&a.groupIndex!==void 0){const l=e.groupsById[a.groupId];l&&(l.layers.splice(a.groupIndex,1),l.layers.forEach((c,d)=>c.groupIndex=d))}s=[a]}const r=e.layers.findIndex(a=>a.id===s[0].id);r!==-1&&(s.forEach(a=>{const{styleManager:l,map:{state:c}}=i,d=l.getRemoveLayerHook(a.innerId);d&&(d(c),l.clearRemoveLayerHook(a.innerId)),delete e.layersById[a.innerId],delete e.layerIdToInnerId[a.id]}),e.layers.splice(r,s.length),ob(e))}function ob(t){const e=new zl;let i;for(const n of t.layers)n.groupId!==void 0&&i&&n.groupId===i.groupId?n.renderIndex=i.renderIndex:n.renderIndex=e.getIndex(),i=n;for(const n in t.groupsById){const s=t.groupsById[n];s&&s.layers[0]&&(s.renderIndex=s.layers[0].renderIndex)}}function TB(t,e,i){const{map:{state:n},collector:s,imageManager:o,renderer:r,tileManager:a}=i;let l;try{l=EB(n,t,256)}catch(b){console.error(b);return}const c=o.addPreparedTexture(l),d=r.getRenderingContext(),{downscale:h}=t.style,{size:u}=n,f=new Nt({size:[Math.ceil(u[0]*window.devicePixelRatio/h),Math.ceil(u[1]*window.devicePixelRatio/h)],magFilter:j.LinearFilter,minFilter:j.LinearFilter,wrapS:j.ClampToEdgeWrapping,wrapT:j.ClampToEdgeWrapping}),m=f.getTexture();if(!m){console.error("Can't init HeatMap Layer. Missing FrameBuffer texture");return}const p=o.addPreparedTexture(m),_=r.addFramebuffer({renderTarget:f,clearColor:[0,0,0,0],onResize:()=>{f.setSize([Math.ceil(n.size[0]*window.devicePixelRatio/h),Math.ceil(n.size[1]*window.devicePixelRatio/h)]),f.bind(d),f.unbind(d);const b=f.getTexture();b&&o.updatePreparedTexture(p,b)}});vt({collector:s,generator:Js.generateTexture,args:[e,t,p,c]});const g=s.getAccumulatedData(),y=new Ct("dynamicObject",g.data,i,n);return a.addObject(y),s.reset(),t.framebufferId={framebuffer:_},b=>{a.removeObject(y),y.clean(b),o.deleteTexture(p),o.deleteTexture(c),r.removeFramebuffer(_)}}function EB(t,e,i){const n=ut(t.styleZoom,t.styleState,[]),s=e.style.color,o=[];if(!AB(s.argument))throw new Error(`Heatmap color must be interpolate expression with 'heatmap-density' argument in layer ${e.id}`);const r=i-1;for(let a=0;a<i;a++){const l=a/r,c=dv(s,l,n);o.push(...c.value)}return new j(new Uint8Array(o),{size:[i,1]})}function AB(t){return typeof t=="object"&&t.type==="heatmap-density"}const rb=1,ab={type:"color",value:[0,0,0,0]};class PB{constructor(e){this.modules=e,this.customLayers=new Map,this.maxCountStyleLayers=1e4,this.styleIndex=rb,this.handyStylesMap=new Map,this.waitingStyleRequests=new Map,this.onRemoveLayerHooks=new Map}createStyle(e,i,n,s){const{state:o}=this.modules.map;if(!Number.isNaN(o.handyStyleId)){const c=this.getStyle(o.handyStyleId);c&&(c.layers.forEach(d=>{const h=this.onRemoveLayerHooks.get(d.innerId);h&&h(o)}),this.onRemoveLayerHooks.clear())}const r=this.styleIndex++,a=cA(e,r,n);pE(a,i),this.handyStylesMap.set(a.id,a),this.setMaxLayersCount(a.layers.length);const l=this.waitingStyleRequests.get(r);return l&&l.resolve(a),this.modules.workers.syncStyle(a),a.layers.forEach(c=>this.initHandyLayer(r,c)),a}hasLayer(e){const i=this.getStyle(this.modules.map.state.handyStyleId);return(i==null?void 0:i.layerIdToInnerId[e])!==void 0}addLayer(e,i){const n=this.getStyle(this.modules.map.state.handyStyleId);if(!n){console.error('Cannot add layer before map style was completely set. Please use "styleload" event.');return}const s=h0(e);s&&(MB(s,n,i),this.setMaxLayersCount(n.layers.length),e.type==="custom"&&s.type==="custom"?this.initCustomLayer(n.id,s,e.render,e.onRemove,e.onAdd):this.initHandyLayer(n.id,s),this.modules.workers.syncStyle(n))}setTerrainStyle(e){const i=this.getStyle(this.modules.map.state.handyStyleId);i&&(i.dem=c_(e),this.modules.demManager.onTerrainStyleChange(),this.modules.renderer.addRerenderEvent())}addIcon(e,i){const n=this.getStyle(this.modules.map.state.handyStyleId);if(!n)return console.error('Cannot add icons before map style was completely set. Please use "styleload" event.'),!1;const s=n.layers.filter(c=>(c.type==="point"||c.type==="metricPoint")&&c.style.iconImage!==void 0&&Zs(c.style.iconImage).some(d=>d===e)),o=n.layers.filter(c=>(c.type==="polygon"||c.type==="embankment"||c.type==="polygon3d")&&!!c.style.textureImage&&Zs(c.style.textureImage).some(d=>d===e));if(!!n.icons[e])return console.error(`The icon with the name ${e} already exists.`),!1;const a=Math.max(0,...Object.keys(n.rasterSets.byIndex).map(c=>Number(c))),l=new zl(a+1);return[...s,...o].forEach(c=>{const{imageType:d,anchor:h}=a_(c),u=f0(e,d,l,h);n.rasterSets.byIndex[u.index]=u,n.rasterSets.byKey[u.key]=u}),n.icons[e]=i,n.revision++,this.modules.workers.syncStyle(n),!0}removeIcon(e){const i=this.getStyle(this.modules.map.state.handyStyleId);if(!i)return console.error('Cannot remove icons before map style was completely set. Please use "styleload" event.'),!1;delete i.icons[e];let n=!1;return i.layers.filter(s=>s.type==="point"&&!!s.style.iconImage||s.type==="polygon"&&!!s.style.textureImage||s.type==="metricPoint"&&!!s.style.iconImage||s.type==="embankment"&&!!s.style.textureImage||s.type==="polygon3d"&&!!s.style.textureImage).forEach(s=>{const{image:o,imageType:r,anchor:a}=a_(s);Zs(o).forEach(l=>{if(l===e){const c=r==="icon"?Vs(l,a[0],a[1]):ta(l),d=i.rasterSets.byKey[c];d&&(this.modules.assetManager.removeRasterSet(d,i.id),n=!0)}})}),n?(i.revision++,this.modules.workers.syncStyle(i),!0):!1}addModel(e,i){const n=this.getStyle(this.modules.map.state.handyStyleId);return n?n.modelIndex[e]!==void 0?(console.error(`The model with the name ${e} already exists.`),!1):(n.models.push(i),n.modelIndex[e]=n.models.length-1,n.revision++,this.modules.workers.syncStyle(n),!0):(console.error('Cannot add models before map style was completely set. Please use "styleload" event.'),!1)}removeLayer(e){const i=this.getStyle(this.modules.map.state.handyStyleId);if(!i){console.error('Cannot remove layer before map style was completely set. Please use "styleload" event.');return}r0.some(n=>n.id===e)||(IB(e,i,this.modules),this.modules.workers.syncStyle(i))}showLayers(e){const i=this.getStyle(this.modules.map.state.handyStyleId);if(!i){console.error('Cannot hide layer before map style was completely set. Please use "styleload" event.');return}this.setLayerVisibility("visible",e,i)}hideLayers(e){const i=this.getStyle(this.modules.map.state.handyStyleId);if(!i){console.error('Cannot hide layer before map style was completely set. Please use "styleload" event.');return}this.setLayerVisibility("hidden",e,i)}setDynamicStyle(e){this.handyStylesMap.set(Lo,e),this.modules.workers.syncStyle(e)}getStyle(e){return this.handyStylesMap.get(e)}getStyleLayer(e,i){var n;return(n=this.handyStylesMap.get(e))==null?void 0:n.layersById[i]}getStyleRevision(e){var i;return((i=this.getStyle(e))==null?void 0:i.revision)||0}setFramebufferId(e,i,n){var o;const s=(o=this.handyStylesMap.get(e))==null?void 0:o.layersById[i];s&&(s.framebufferId=n)}getFramebufferId(e,i){var n,s;return(s=(n=this.handyStylesMap.get(e))==null?void 0:n.layersById[i])==null?void 0:s.framebufferId}waitForStyle(e){const i=this.handyStylesMap.get(e);if(i)return Promise.resolve(i);const n=this.waitingStyleRequests.get(e);if(n)return n.promise;const s={resolve:void 0,promise:void 0};return s.promise=new Promise(o=>{s.resolve=o}),this.waitingStyleRequests.set(e,s),s.promise}addRemoveLayerHook(e,i){this.onRemoveLayerHooks.set(e,i)}getRemoveLayerHook(e){return this.onRemoveLayerHooks.get(e)}clearRemoveLayerHook(e){this.onRemoveLayerHooks.delete(e)}callCustomLayerRender(e){const i=this.customLayers.get(e);i&&i.renderFunction(this.modules.renderer.getRenderingContext())}getCustomSceneObjects(){const e=[];return this.customLayers.forEach(i=>e.push(i.sceneObject)),e}getMaxLayersCount(){return this.maxCountStyleLayers}getStyleLayerForObject(e){const i=this.getStyle(e.attributes.styleId);return i?i.layersById[e.attributes.layerId]:null}getFeatureFlag(e){if(!this.modules.map.state.graphicsPresetMode)return!1;const i=this.getStyle(this.modules.map.state.handyStyleId);if(!i)return!1;const n=this.modules.map.core.state.styleState.graphicsPreset;return n?i.graphicsPresets[n][e]===!0:!1}getClearColor(){const{map:e,camera:i}=this.modules,{state:n}=e,s=this.handyStylesMap.get(n==null?void 0:n.handyStyleId);if(!s)return n.defaultBackgroundColor;const o=ut(n.styleZoom,n.styleState,[]),r=ze(s.environment.style.skyColor,o),a=n.globeMode?i.globeRatio:0;return F2(ab.value,s.background.color.value,r.value,a),ab}update(){const e=this.getStyle(this.modules.map.state.handyStyleId);e&&(e.light.lightingModesResolved=vI(e.light.lightingModes,ut(this.modules.map.state.styleZoom,this.modules.map.state.styleState,[],!1)))}setLayerVisibility(e,i,n){const{id:s,type:o}=i;if(s&&n.layersById){const r=n.layerIdToInnerId[s];if(r){const a=n.layersById[r];a&&a.style&&(a.style.visibility=e)}}o&&n.layers.forEach(r=>{r.type===o&&(r.style.visibility=e)})}initHandyLayer(e,i){let n;switch(i.type){case"group":i.layers.forEach(s=>this.initHandyLayer(e,s));return;case"heatmap":n=TB(i,e,this.modules);break}n&&this.modules.styleManager.addRemoveLayerHook(i.innerId,n)}setMaxLayersCount(e){this.maxCountStyleLayers<e&&(this.maxCountStyleLayers=e)}initCustomLayer(e,i,n,s,o){const r={sceneObject:{type:Xi.Custom,attributes:{styleId:e,layerId:i.innerId,tileData:[]},tile:{zoomLevel:0},layerSettings:{},canRender:!0},layer:i,renderFunction:n};o==null||o(),this.customLayers.set(i.innerId,r),this.modules.styleManager.addRemoveLayerHook(i.innerId,()=>{s==null||s(),this.customLayers.delete(i.innerId)})}}const LB={point:{point:!0,heatmap:!0,gltfModel:!0,metricPoint:!0},polygon:{polygon:!0,polygonExtrusion:!0,mesh:!0,embankment:!0,polygon3d:!0,overpass:!0},line:{line:!0,lineExtrusion:!0,labelLine:!0,dashedLine:!0,oneWayLine:!0,metricPoint:!0,overpass:!0}};function CB(t,e){return!!LB[t][e]}function RB(t){const e=t.vertices.x,i=t.vertices.y;let n=0;for(let s=0;s<e.length-1;s++)n+=Math.hypot(e[s]-e[s+1],i[s]-i[s+1]);return n}function Bm(t,e){const i=new Set(e[0].map((n,s)=>e[0][s]===t[0]&&t[1]===e[1][s]?s:-1));return Array.from(i)}function zB(t,e,i,n){e>=0&&i>=0&&Math.abs(e-i)===1&&(t[2][0]=1),i>=0&&n>=0&&Math.abs(i-n)===1&&(t[2][1]=1),e>=0&&n>=0&&Math.abs(e-n)===1&&(t[2][2]=1)}function lb(t,e){const i=Bm([t[0][0],t[1][0]],e),n=Bm([t[0][1],t[1][1]],e),s=Bm([t[0][2],t[1][2]],e);i.forEach(o=>n.forEach(r=>s.forEach(a=>{zB(t,o,r,a)})))}function cb(){return pS(["id","db_label","db_label2","selected","hovered","componentDistanceStart","componentDistanceEnd","objectLength","beginningIsCut","endingIsCut","db_geometry_type","db_plan_id"],["GEOJSON_METATILE_UNKNOWN_SUBLAYER","Commercial_poi_default","Commercial_poi_city","Commercial_poi_premium","Commercial_model","Immersive_model","Immersive_model_multipart","Animated_immersive_model"])}class ao{constructor(){this.events={}}on(e,i){let n=this.events[e];return n||(n=this.events[e]=[]),n.push(i),this}once(e,i){const n=s=>{this.off(e,n),i.call(this,s)};return this.on(e,n),this}off(e,i){const n=this.events[e];if(!n)return this;const s=n.indexOf(i);return s!==-1&&n.splice(s,1),this}emit(e,i){const n=this.events[e];if(!n)return this;const s=n.slice();for(let o=0;o<s.length;o++)s[o].call(this,i);return this}}class FB extends ao{constructor(e,i){super(),this.loadFont=(o,r)=>{let a=this.requestFontRanges.get(o,r);return a||(a=this.createLoadFontRequest(o,r),this.requestFontRanges.set(o,r,a)),a},this.invalidateUsedGltfModels=br(()=>{var l;const o=new Set,r=this.modules.tileManager.getTileObjects();for(const c of r)for(const d of c.children){if(!Cm(d))continue;const{styleId:h,layerId:u,modelIndices:f}=d.attributes,m=this.modules.styleManager.getStyleLayer(h,u);if(!m||m.type!=="gltfModel")continue;const p=this.modules.modelsScene.getCurrentLayerModelId(d.attributes,d.tile);f.forEach(_=>{const g=this.getModel(_,h);if(g){o.add(g);return}if(p===_){const y=this.dataModelIdToUrl[_];y?this.loadModel(y,_,h,!1,m):this.loadModelByIndex(_,h,m)}})}const a=this.modules.tileManager.getCachedMods();for(const c of a)(l=c.objects)==null||l.forEach(d=>{for(const h of d.children){if(!Cm(h))continue;const{styleId:u,layerId:f,modelIndices:m}=h.attributes,p=this.modules.styleManager.getStyleLayer(u,f);if(!p||p.type!=="gltfModel")return;m.forEach(_=>{const g=this.getModel(_,h.attributes.styleId);g&&o.add(g)})}});for(const c in this.models){const d=this.models[c];!d.preserve&&!o.has(d)&&d.status===xn.Loaded&&this.removeModel(c)}},Pp),this.state=e,this.modules=i,this.modelsWorker=new this.modules.workers.models.ModelsSource,this.requestedMetatiles=new Set,this.metatiles={},this.loadedRasters={},this.failedRasters={},this.requestedRasters={},this.requestedSvgs={},this.disableIconCache=e.disableIconCache,this.textures=[],this.fontGlyphs={},this.fontTextures=new sb,this.requestFontRanges=new sb,this.pendingFontRanges=0,this.loadedFontRanges=0,this.models={},this.dataModelIdToUrl={},this.visibleBuildingIds=new Set,this.metatileLoader=(o,r,a)=>{const l=Lu(r);fetch(o).then(c=>{if(!c.ok)throw new Error(`Failed to load metatile "${l}"`);return c.json()}).then(c=>this.setMetatile(r,a,c)).catch(c=>console.error(c))};const n=(o,r)=>{const a=this.modules.styleManager.getStyle(o);if(!a){console.error(`Not found style ${o} in AssetManager#addNewRasterSets`);return}const{rasterSets:l}=a;r.forEach(c=>{l.byIndex[c.index]=c,l.byKey[c.key]=c})},{fnRegistry:s}=this.modules.workers;s.set("addNewRasterSets",n),s.set("loadFont",this.loadFont),this.setPreparedMetatile(-1,Gs),this.setPreparedMetatile(Tp,cb())}getMemoryFootprint(){const e={textures:this.textures.map(Rl),fontTextures:this.fontTextures.reduce((n,s)=>(n.push(Rl(s)),n),[]),fontGlyphs:Object.values(this.fontGlyphs).reduce((n,s)=>Object.values(s).reduce((o,r)=>{var a;return o.push({bitmap:((a=r.bitmap)==null?void 0:a.byteLength)??0}),o},n),[]),models:Object.values(this.models).map(P3).filter(n=>n.buffers.length>0||n.textures.length>0)},i={textures:this.textures.map(yd),fontTextures:this.fontTextures.reduce((n,s)=>(n.push(yd(s)),n),[]),models:Object.values(this.models).map(L3).filter(n=>n.buffers.length>0||n.textures.length>0)};return{js:{...e,"--sum":ui(e)},gpu:{...i,"--sum":ui(i)}}}fillDataModelUrlMap(e){for(const i in e)this.dataModelIdToUrl[e[i]]=i}getDataModelUrlById(e){return this.dataModelIdToUrl[e]}loadMetatile(e,i,n){this.requestedMetatiles.has(i)||(this.requestedMetatiles.add(i),this.metatileLoader(e,i,n))}setMetatile(e,i,n){U3(n),n.tileProps=n.tileProps.map(O3);const s=Ig(n);this.setPreparedMetatile(e,s),this.projectMetatileMetadata===void 0&&(this.projectMetatileMetadata={regionId:i,metatileHash:e})}setPreparedMetatile(e,i){this.metatiles[e]=i,this.modules.workers.parser.setMetatile(e,i)}prepareRasters(e,i,n){var c,d;const s=this.modules.styleManager.getStyle(e);if(!s){console.error(`Not found style ${e} in AssetManager#prepareRasters`);return}const{rasterSets:o}=s,r=this.modules.renderer.getRenderingContext(),a=7,l=i.length/a;for(let h=0;h<l;h++){const u=i[h*a],f=i[h*a+1],m=i[h*a+6],p=i[h*a+2],_=i[h*a+3],g=i[h*a+4],y=i[h*a+5],b=o.byIndex[u];if(b.isSvg){const S={rasterIndex:f,rasterSetIndex:u,x:p,y:_,w:g,h:y,anchorX:b.anchorX,anchorY:b.anchorY,atlasIndex:m,isPacked:!0};b.rasters[f]=S,(d=(c=this.requestedSvgs[s.id])==null?void 0:c[u])==null||d.then(P=>{const T=this.textures[S.atlasIndex],{url:L,revokeURL:B}=Ow(P);Dw(L,S.w,S.h).then(O=>{T.subImage(r,O,S.x,S.y),this.modules.renderer.addRerenderEvent(),B&&B()})})}else{const S=b.rasters[f];S.x=p,S.y=_,S.atlasIndex=m,S.isPacked=!0}this.textures[m]===void 0&&(this.textures[m]=new j(void 0,{size:Gt,flipY:!1,premultiplyAlpha:!$P,magFilter:j.LinearFilter,minFilter:j.LinearFilter}).prepare(r));const v=this.textures[m],I=n&&n[h];if(I!==void 0){v.subImage(r,I,p,_),this.modules.renderer.addRerenderEvent();continue}}this.modules.workers.labeling.updatePackingInfo(e,i)}loadRasters(e){const n=e.length/3;for(let s=0;s<n;s++){const o=e[s*3],r=e[s*3+1],a=e[s*3+2],l=r<<16|a,c=this.modules.styleManager.getStyle(o);if(!c){console.error(`Not found style ${o} in AssetManager#loadRasters`);continue}if(this.loadedRasters[o]||(this.loadedRasters[o]=new Set,this.failedRasters[o]=new Set,this.requestedRasters[o]=new Set),this.requestedRasters[o].has(l))continue;const{rasterSets:d}=c,h=d.byIndex[r];if(h.rasters[a].isPacked===!1){console.error(`Try to load not packed raster ${h.key}`);continue}this.requestedRasters[o].add(l),h.isSvg?this.loadSvg(l,c,r):this.loadPng(l,c,r,a)}}removeRasterSet(e,i){const{key:n,index:s,rasters:o}=e;delete this.requestedSvgs[i][s],o.forEach(({rasterSetIndex:a,rasterIndex:l})=>{var d,h,u;const c=a<<16|l;(d=this.loadedRasters[i])==null||d.delete(c),(h=this.failedRasters[i])==null||h.delete(c),(u=this.requestedRasters[i])==null||u.delete(c)}),e.rasters.length=0;const r=this.modules.styleManager.getStyle(i);r&&(delete r.rasterSets.byIndex[s],delete r.rasterSets.byKey[n])}getMetatile(e){return this.metatiles[e]}getProjectMetadata(){return this.projectMetatileMetadata}getFontGlyphs(e){return this.fontGlyphs[e]||{}}getFontTextureByName(e,i){return this.fontTextures.get(e,i)}isIdle(){let e=0,i=0;for(const n in this.requestedRasters)e+=this.requestedRasters[n].size,i+=this.loadedRasters[n].size+this.failedRasters[n].size;return e===i&&this.pendingFontRanges===this.loadedFontRanges&&this.allModelsLoaded()}dangerouslySetMetatiles(e){this.metatiles=e}dangerouslySetRasters(e,i){this.loadedRasters=e,this.failedRasters=i}loadModelByIndex(e,i,n){const s=this.getModelUniqueKey(e,i);if(this.models[s]!==void 0)return;const o=this.modules.styleManager.getStyle(i);if(o===void 0){Ku({layer:"prepare",message:"Style not found. Can't determine url"});return}const r=o.models[e];if(r===void 0){Ku({layer:"prepare",message:`Model with index "${e}" is missing in the style.`});return}const a=uE(r.url,o);this.fetchModel(a,e,s,!1,n)}loadModel(e,i,n,s,o,r){const a=this.getModelUniqueKey(i,n);if(this.models[a]!==void 0){r==null||r();return}this.fetchModel(e,i,a,s,o,r)}getModel(e,i){return this.models[this.getModelUniqueKey(e,i)]}allModelsLoaded(){for(const e in this.models)if(this.models[e].status===xn.Pending)return!1;return!0}isModelLoaded(e,i){const n=this.models[this.getModelUniqueKey(e,i)];return n&&n.status===xn.Loaded}removeModel(e){const i=this.models[e];i&&(i.objects.forEach(n=>{n.elementsBuffer&&n.elementsBuffer.remove()}),i.objects=[],i.buffers.forEach(n=>{n instanceof R&&n.remove()}),i.buffers=[],i.textures.forEach(n=>n.remove()),i.textures=[],delete this.models[e])}fetchModel(e,i,n,s,o,r){const{renderer:a}=this.modules,l=this.models[n]=eF(s);this.modelsWorker.loadModel(e,this.state.dracoDecoderUrl).then(c=>{if(c.type==="ok"){if(l.status=xn.Loaded,!c.result)return;tF(l,a,c.result,i,o),this.emit("modelloaded",i),this.modules.renderer.addRerenderEvent(),r==null||r()}else Ku(c),l.status=xn.Failed})}getModelUniqueKey(e,i){return e>=0?`${i},${e}`:String(e)}async createLoadFontRequest(e,i){this.pendingFontRanges+=1;const n=Number.isNaN(this.state.handyStyleId)?rb:this.state.handyStyleId;try{const s=await this.modules.styleManager.waitForStyle(n),o=await fetch(ay(e,i,s)).then(a=>{if(!a.ok)throw new Error;return a}).catch(()=>(console.error(`Could not load font ${e} for range ${i} fallback to the default font ${ho}`),fetch(ay(ho,i,s)).then(a=>{if(!a.ok)throw new Error(`Could not load default font ${ho} for range ${i}`);return a}))).then(a=>a.arrayBuffer()),r=wB(o);return this.prepareFontAtlas(e,i,r),this.modules.workers.labeling.appendFont(e,r.glyphData),this.loadedFontRanges+=1,this.modules.workers.labeling.markFontAsLoaded(e,i)}catch(s){return console.error(s),this.loadedFontRanges+=1,this.modules.workers.labeling.markFontAsLoaded(e,i)}}prepareFontAtlas(e,i,n){const{bitmap:s,width:o,height:r,glyphData:a}=n;this.fontGlyphs[e]||(this.fontGlyphs[e]={});for(const c in a)this.fontGlyphs[e][c]=a[c];const l=new j(new Uint8Array(s),{size:[o,r],magFilter:j.LinearFilter,minFilter:j.LinearFilter,format:j.AlphaFormat,premultiplyAlpha:!1,flipY:!1});this.fontTextures.set(e,i,l),this.state.needLabeling=!0}loadPng(e,i,n,s){const o=this.modules.renderer.getRenderingContext(),{rasterSets:r}=i,a=r.byIndex[n],l=a.rasters[s],c=this.textures[l.atlasIndex];let d="";if(a.type===ur.Unique){const h=a.id;a.url?d=ly(a.url,l.w,l.h):d=gs("dynamicPoi",{host:this.state.tileServer,tileSet:this.state.tileSet,protocol:this.state.tileProtocol,subdomain:Wr(this.state.subdomains,h),id:h,width:l.w.toString(),height:l.h.toString(),regionId:String(a.regionId)})}else if(a.type===ur.Static){const h=i.icons[a.name];if(!h){console.error(`There is no appropriate icon config in the style for raster set: "${a.name}"`),this.failedRasters[i.id].add(e);return}d=ld(h.url,i,Wr(this.state.subdomains,a.name))}this.modules.workers.parser.prepareAtlas(d).then(h=>{h?(h.isBitmap?(c.subImage(o,h.data[0],l.x,l.y),this.modules.renderer.addRerenderEvent()):yh(h.data[0]).then(u=>{c.subImage(o,u,l.x,l.y),this.modules.renderer.addRerenderEvent()}),this.loadedRasters[i.id].add(e)):this.failedRasters[i.id].add(e)})}loadSvg(e,i,n){const s=this.modules.renderer.getRenderingContext(),o=i.rasterSets.byIndex[n];if(!i.iconBaseUrl){console.error(`Attempt to load svg without existing style for raster set: "${o.name}"`),this.failedRasters[i.id].add(e);return}const r=i.icons[o.name];if(!r){console.error(`There is no appropriate icon config in the style for raster set: "${o.name}"`),this.failedRasters[i.id].add(e);return}const a=ld(r.url,i,Wr(this.state.subdomains,o.name));this.requestedSvgs[i.id]||(this.requestedSvgs[i.id]={});let l=this.requestedSvgs[i.id][n];(!l||this.disableIconCache)&&(l=this.requestedSvgs[i.id][n]=fetch(a,{cache:this.disableIconCache?"no-cache":"default"}).then(c=>{if(!c.ok)throw new Error("Not 2xx response");return c.text()})),l.then(c=>{const{url:d,revokeURL:h}=Ow(c),u=[];for(const f of o.rasters){if(f.w<=0||f.h<=0)continue;const m=this.textures[f.atlasIndex],p=Dw(d,f.w,f.h);p.then(_=>{m.subImage(s,_,f.x,f.y),_.remove(),this.modules.renderer.addRerenderEvent()}),u.push(p)}h&&Promise.all(u).then(h),this.loadedRasters[i.id].add(e)}).catch(c=>{console.error(`Can't load an SVG for the "${o.name}" raster set. Error: `,c),this.failedRasters[i.id].add(e)})}}class DB{constructor(e,i,n,s,o,r,a,l){this.modules=e,this.mapState=i,this.cache=n,this.maxStyleZoom=-1/0,this.minStyleZoom=1/0,this.ready=!1,this.useful=!1,this.status="initial",this.model=s,this.key=o,this.selectedIds=r,this.styleId=a,this.styleRevision=l,this.modelRevision=s.revision,this.objects=[]}update(){switch(this.status){case"initial":{this.useful&&(this.loadModel(),this.status="generating");break}case"generating":{if(this.useful&&this.processResponse&&this.model.texturesLoaded){const{objects:{data:e}}=this.processResponse;this.objects=BB(e,this.modules),this.updateMinAndMaxStyleZoom(this.objects),this.status="generated",this.ready=!0,this.cache.add(this.key,this)}break}}}getIdentifyIds(){var e;return(e=this.processResponse)==null?void 0:e.objects.identifyIds}remove(){this.status==="generated"&&this.cache.remove(this.key),this.status="initial",this.objects.length&&(this.objects.forEach(e=>e.clean(this.mapState)),this.objects=[]),this.ready=!1}canBeRemoved(){return this.status==="initial"}loadModel(){const{model:{regionId:e,metatileHash:i,id:n,sourceModel:{fileName:s,matrix:o,offset:r}}}=this,l={url:gs("model",{host:this.mapState.tileServer,tileSet:this.mapState.tileSet,protocol:this.mapState.tileProtocol,subdomain:Wr(this.mapState.subdomains,s),regionId:e.toString(),name:s}),id:n,regionId:e,metatileHash:i,selected:this.selectedIds.some(c=>c===n),pixelRatio:window.devicePixelRatio,styleState:this.mapState.styleState,styleId:this.mapState.handyStyleId,offset:r,matrix:o};this.modules.defaultSource.generateModel(l).then(c=>{this.model.prepareTextures(c.textures),this.processResponse=c})}updateMinAndMaxStyleZoom(e){this.minStyleZoom=Math.min(...e.map(i=>Math.min(...i.children.map(n=>{const s=this.modules.styleManager.getStyleLayer(n.attributes.styleId,n.attributes.layerId);return(s==null?void 0:s.type)==="dem"?1/0:(s==null?void 0:s.minzoom)??-1/0})))),this.maxStyleZoom=Math.max(...e.map(i=>Math.max(...i.children.map(n=>{const s=this.modules.styleManager.getStyleLayer(n.attributes.styleId,n.attributes.layerId);return(s==null?void 0:s.type)==="dem"?-1/0:(s==null?void 0:s.maxzoom)??1/0}))))}}function OB(t,e,i,n,s){const o=e.join("|");return`model=${t}_sId=${i}_sRev=${n}_mRev=${s}_sel=${o}`}function BB(t,e){const i=new hb(t,e),n=[],s=db(i.children[0]??i.identifyChildren[0]??i.depthTestChildren[0]??i.shadowChildren[0]);return s&&["children","identifyChildren","depthTestChildren","shadowChildren"].forEach(o=>{const r=i.modelMatrices.get(0)??Gi();Nr(r,s),i.modelMatrices.set(0,r);let a=i[o].length;for(;a--;){const l=i[o][a],c=db(l);if(!c||qp(r,c))continue;let d=n.find(h=>{const u=h.modelMatrices.get(0);return u?qp(u,c):!1});d||(d=new hb([],e),d.modelMatrices.set(0,Nr(Gi(),c)),n.push(d)),d[o].push(l),l.tile=d,i[o].splice(a,1)}}),[i,...n]}function db(t){if(t&&"matrix"in t.attributes)return t.attributes.matrix}class hb extends Qf{constructor(e,i){super("model");const{identifier:n}=i;Ry(i,e,this,n.getIdScope(mn)),this.size=Mt(this.coords[2]),this.zoomLevel=this.coords[2],this.detailLevel=this.coords[3]}setTileCoords(e,i){}syncReplicas(e){}}class kB{constructor(e,i,n,s,o,r){this.modules=e,this.mapState=i,this.cache=n,this.regionId=s,this.metatileHash=o,this.sourceModel=r,this.revision=0,this.texturesLoaded=!1,this.textures=[],this.readiness=0,this.id=r.id,this.attributes=r.attributes??{},this.readinessTickerName=`model-readiness-${this.id}`,this.ids=e.identifier.getIdScope(mn)}update(){var e,i;(e=this.currentMod)!=null&&e.useful&&this.currentMod.update(),(i=this.newMod)!=null&&i.useful&&this.newMod.update(),kt(this.readinessTickerName,{step:(n,s)=>this.readiness=s},this.mapState)}isAnimating(){return Jf(this.readinessTickerName,this.mapState)}commitMod(){this.newMod&&this.newMod.ready&&(this.currentMod=this.newMod,this.newMod=void 0)}setUsefulMod(){const e=this.mapState.handyStyleId,i=this.modules.styleManager.getStyleRevision(e),n=this.ids.getSelected().filter(s=>s===this.id);if(!this.currentMod&&!this.newMod){this.createNewMod(n,e,i,this.revision);return}if(this.currentMod&&go(this.currentMod.selectedIds,n)&&this.currentMod.styleId===e&&this.currentMod.styleRevision===i&&this.currentMod.modelRevision===this.revision){this.currentMod.useful=!0,this.newMod=void 0;return}if(this.newMod){go(this.newMod.selectedIds,n)&&this.newMod.styleId===e&&this.newMod.styleRevision===i&&this.newMod.modelRevision===this.revision?this.newMod.useful=!0:this.createNewMod(n,e,i,this.revision);return}this.createNewMod(n,e,i,this.revision)}getUsefulMod(){if(this.currentMod&&this.currentMod.useful)return this.currentMod;if(this.newMod&&this.newMod.useful)return this.newMod}getCurrentMod(){return this.currentMod}setAllModsNeedless(){this.currentMod&&(this.currentMod.useful=!1),this.newMod&&(this.newMod.useful=!1)}getOpacity(e){return this.readiness*this.modules.buildingHeightAnimator.getBuildingHeight(e)}getTexture(e){return this.textures[e]}prepareTextures(e){this.texturesLoaded||(e.isBitmap?(this.textures=e.data.map(i=>new j(i,{flipY:!1})),this.texturesLoaded=!0,this.startReadinessTicker()):Promise.all(e.data.map(i=>yh(i))).then(i=>{this.textures=i.map(n=>new j(n,{flipY:!1})),this.texturesLoaded=!0,this.startReadinessTicker()}))}clean(){this.canBeCleaned()&&(this.texturesLoaded&&(this.textures.forEach(e=>e.remove()),this.textures=[],this.texturesLoaded=!1),this.stopReadinessTicker())}canBeCleaned(){return(!this.currentMod||this.currentMod.canBeRemoved())&&(!this.newMod||this.newMod.canBeRemoved())}createNewMod(e,i,n,s){const o=OB(this.id,e,i,n,s),r=this.cache.get(o);r?(this.newMod=r,this.newMod.useful=!0):this.newMod=new DB(this.modules,this.mapState,this.cache,this,o,e,i,n)}startReadinessTicker(){this.readiness=0,Bt(this.readinessTickerName,{easing:Go.easing},this.mapState,0,1,Go.duration,1)}stopReadinessTicker(){this.readiness=0,yt(this.readinessTickerName,this.mapState)}}class NB{constructor(e,i){this.mapState=e,this.modules=i,this.buildingsHeight=new Map,this.models=new Map,this.displayedMods=new Map,this.viewportModels=[],this.requestedModelsInfo=new Set,this.loadedModelsInfo=new Set,this.isStyleUpdateInProgress=!1,this.hiddenBuildingIds=new Set,this.cache=new Gy(Ap,(n,s)=>s.remove()),this.ids=i.identifier.getIdScope(mn)}onFeatureStateMapChange(){this.models.forEach(e=>{e.revision++})}update(){this.findViewportModels(),this.mapState.styleZoom>Kh&&this.modules.tileManager.getViewportTiles().forEach(e=>{e.type==="zenith"&&e.serverMetadata&&e.serverMetadata.forEach(i=>{const n=this.modules.sourceStorage.getSourceById(e.sourceId);if(n!==void 0&&"getUrl"in n){const s=n.getUrl("modelInfo",{regionId:i.regionId.toString()});this.loadModelsInfo(s,i.regionId,i.metatileHash)}else{const s=gs("modelInfo",{host:this.mapState.tileServer,tileSet:this.mapState.tileSet,protocol:this.mapState.tileProtocol,subdomain:this.mapState.subdomains[0],regionId:i.regionId.toString()});this.loadModelsInfo(s,i.regionId,i.metatileHash)}})}),this.models.forEach(e=>e.setAllModsNeedless()),this.viewportModels.forEach(e=>e.setUsefulMod()),this.models.forEach(e=>e.update()),this.isStyleUpdateInProgress||this.models.forEach(e=>e.commitMod()),this.updateScene(),this.cleanUnnessasaryModels(),this.updateObjectsVisibility()}activateStyleUpdating(){this.isStyleUpdateInProgress=!0}finishStyleUpdating(){this.isStyleUpdateInProgress=!1}redraw(){this.cache.reset(),this.cleanUnnessasaryModels()}isModelsInfoLoaded(e){return this.loadedModelsInfo.has(e)}getTexture(e,i){var n;return(n=this.models.get(e))==null?void 0:n.getTexture(i)}getDisplayedIdentifyData(){const e=[];return this.viewportModels.forEach(i=>{const n=i.getUsefulMod();if(!n)return;const s=n.getIdentifyIds();s&&e.push({metatileHash:i.metatileHash,ids:s})}),e}getOpacity(e,i){var n;return((n=this.models.get(e))==null?void 0:n.getOpacity(i))||0}hasModel(e){return this.models.has(e)}setBuildingHeight(e,i){this.buildingsHeight.set(e,i)}getBuildingHeight(e){return this.buildingsHeight.get(e)||0}isHidden(e){return this.ids.isHidden(e)}getVisibleModelData(e){const i=this.models.get(e);if(!i)return;const n=i.getCurrentMod();if(!n||!n.ready)return;const s=Math.max(i.sourceModel.minZoom,n.minStyleZoom),o=Math.min(i.sourceModel.maxZoom,n.maxStyleZoom),{styleZoom:r}=this.mapState;if(!(r<s||r>=o))return{minStyleZoom:s,maxStyleZoom:o,opacity:this.getOpacity(e,s)}}isIdle(){return this.viewportModelsReady()&&!this.viewportModels.some(e=>e.isAnimating())}viewportModelsReady(){return this.viewportModels.every(e=>{const i=e.getUsefulMod();return i&&i.ready})}setHiddenBuildingIds(e){e.forEach(i=>{this.hiddenBuildingIds.add(i)})}unsetHiddenBuildingIds(e){e.forEach(i=>{this.hiddenBuildingIds.delete(i)})}findViewportModels(){const{styleZoom:e}=this.mapState;this.viewportModels=[],this.models.forEach(i=>{const{bound:n,minZoom:s,maxZoom:o}=i.sourceModel;if(e<s||e>=o)return;const r=this.mapState.styleState._activeFloorIds,a=i.attributes.db_hidden_by_plan_id;if(a&&r.includes(a)||this.modules.floorManager.hasDisplayedFloorBuilding([i.id])||!!!this.modules.assetManager.getMetatile(i.metatileHash)||this.hiddenBuildingIds.has(i.id))return;tr(this.mapState.extendedTilesBounds,n)&&this.viewportModels.push(i)})}updateScene(){let e=!1;const i=new Map;this.viewportModels.forEach(n=>{const s=n.getCurrentMod();s&&s.ready&&i.set(s.key,s)}),this.displayedMods.forEach((n,s)=>{i.has(s)||(n.objects.length&&n.objects.forEach(o=>this.modules.tileManager.removeObject(o)),e=!0)}),i.forEach((n,s)=>{this.displayedMods.has(s)||(n.objects.length&&n.objects.forEach(o=>this.modules.tileManager.addObject(o)),e=!0),this.cache.get(s)}),e&&(this.displayedMods=i,this.modules.renderer.addRerenderEvent(),this.modules.identifier.resetCache())}cleanUnnessasaryModels(){const e=new Set(this.cache.getData().map(i=>i.model));this.models.forEach(i=>{e.has(i)||i.clean()})}loadModelsInfo(e,i,n){this.requestedModelsInfo.has(i)||(this.requestedModelsInfo.add(i),fetch(e).then(s=>{if(!s.ok)throw new Error(`Failed to load models info for region ${i}`);return s.json()}).then(s=>{s.forEach(o=>{const r=new kB(this.modules,this.mapState,this.cache,i,n,o);this.models.set(r.id,r)}),this.loadedModelsInfo.add(i)}).catch(s=>{this.loadedModelsInfo.add(i),console.error(s)}))}updateObjectsVisibility(){const e=this.ids;this.models.forEach(i=>{var o;const n=((o=this.getVisibleModelData(i.id))==null?void 0:o.opacity)||0,s=e.isHidden(i.id,Qi.PolygonExtrusion);n>=.5&&!s?e.hide([i.id],Qi.PolygonExtrusion):n<.5&&s&&e.show([i.id])})}}class UB{constructor(e){this.modules=e,this.isIdle=()=>!this.isGenerating,this.modCache=new Map,this.isGenerating=!1,this.currentPois=[],this.currentIdSet=new Set,this.currentTrafficState=!1,this.currentSelectedIds=[],this.currentModKey=ub(this.currentTrafficState,this.currentSelectedIds),this.ids=e.identifier.getIdScope(mn)}setPersonalPoi(e){this.currentPois=e;const i=new Set;for(const n of e)i.add(n.id);this.currentIdSet=i,this.modCache.clear(),this.displayedModKey=void 0}redraw(){this.modCache.clear(),this.displayedModKey=void 0}getIdentifyDataChunk(){return this.identifyDataChunk}update(){if(this.regionMetadata===void 0&&(this.regionMetadata=this.modules.assetManager.getProjectMetadata()),this.regionMetadata===void 0)return;this.updateModKey();const e=this.currentModKey,i=this.modCache.get(e);i===void 0&&!this.isGenerating&&this.generate(e,this.currentPois,this.regionMetadata),i!==void 0&&e!==this.displayedModKey&&this.show(e,i,this.regionMetadata)}generate(e,i,n){const{regionId:s,metatileHash:o}=n,r=this.modules.map.state;this.isGenerating=!0,this.modules.workers.parser.generatePersonalPoi(i,s,o,window.devicePixelRatio,this.ids.getSelected(),r.handyStyleId,r.styleState,this.modules.defaultSource.getId()).then(a=>{if(a===void 0){this.isGenerating=!1;return}const{collectorOutput:l,styleId:c}=a,{packedRasters:d,rastersToLoad:h}=l;d!==void 0&&this.modules.assetManager.prepareRasters(c,d),this.modules.assetManager.loadRasters(h),this.modCache.set(e,a),this.isGenerating=!1})}show(e,i,n){const{metatileHash:s}=n,{collectorOutput:{labels:o,identifyIds:r},styleId:a}=i;this.modules.labeler.removeLabels("ppoi"),o.length&&this.modules.labeler.addLabels("ppoi",Eo.PersonalPoi,[{metatileHash:s,labels:o,styleId:a}]),this.identifyDataChunk={metatileHash:s,ids:r},this.modules.identifier.resetCache(),this.displayedModKey=e}updateModKey(){const e=this.ids.getSelected().filter(n=>this.currentIdSet.has(n)),i=this.modules.trafficTileLayer.isEnabled();(!go(this.currentSelectedIds,e)||this.currentTrafficState!==i)&&(this.currentTrafficState=i,this.currentSelectedIds=e,this.currentModKey=ub(i,e))}}function ub(t,e){return`ppoi_${t}_${e.join("|")}`}var Ue=(t=>(t[t.Main=0]="Main",t[t.Parser=1]="Parser",t[t.Labeling=2]="Labeling",t[t.Models=3]="Models",t[t.All=4]="All",t))(Ue||{}),Yl=(t=>(t[t.FunctionUse=0]="FunctionUse",t[t.FunctionResult=1]="FunctionResult",t))(Yl||{});class GB extends Qo{constructor(){super(),this.workers=new Map}addWorker(e,i){this.workers.set(e,i),i.addEventListener("message",n=>{const{to:s,msg:o,transferable:r}=n.data,a={from:e,to:s,msg:o,transferable:r};this.routeMessage(a)})}send(e,i,n){const s=this.workers.get(e);if(s){const o={to:e,from:Ue.Main,msg:i,transferable:n};n!==void 0?s.postMessage(o,n):s.postMessage(o)}}broadcast(e){this.workers.forEach((i,n)=>{const s={to:n,from:Ue.Main,msg:e};i.postMessage(s)})}routeMessage(e){const{from:i,to:n,transferable:s,msg:{type:o}}=e;if(n===Ue.Main)this.emit("message",e);else if(n===Ue.All)i!==Ue.Main&&this.emit(o,e),this.workers.forEach((r,a)=>{a!==i&&(s!==void 0?r.postMessage(e,s):r.postMessage(e))});else{const r=this.workers.get(n);r&&(s!==void 0?r.postMessage(e,s):r.postMessage(e))}}}class jB{constructor(e){this.onMessage=i=>{const{from:n,msg:s}=i;switch(s.type){case Yl.FunctionUse:this.onFunctionUse(s,n);break;case Yl.FunctionResult:this.onFunctionResult(s);break}},this.connector=e,this.functions=new Map,this.functionIdCounter=0,this.pendingFunctions=new Map,e.on("message",this.onMessage)}set(e,i){this.functions.set(e,i)}get(e,i){return(...n)=>{const s=this.functionIdCounter++,o=new Promise(a=>{this.pendingFunctions.set(s,a)}),r={type:Yl.FunctionUse,data:{id:s,name:i,args:n}};return this.connector.send(e,r),o}}onFunctionUse(e,i){const{data:{name:n,args:s,id:o}}=e,r=this.functions.get(n);if(r){const a=r(...s);a&&a.then?Promise.resolve(a).then(l=>this.sendFunctionResult(i,o,l)):this.sendFunctionResult(i,o,a)}else console.error(`FnRegistry#onFunctionUse: function ${n} not found`)}sendFunctionResult(e,i,n){const s={type:Yl.FunctionResult,data:{id:i,result:n}};n&&n.transferable?this.connector.send(e,s,n.transferable):this.connector.send(e,s)}onFunctionResult(e){const{data:{id:i,result:n}}=e,s=this.pendingFunctions.get(i);s?(s(n),this.pendingFunctions.delete(i)):console.error(`FnRegistry#onFunctionResult: pending function ${i} not found`)}}class VB{constructor(e){this.fnRegistry=e,this.onClassCreate=({id:i,name:n,args:s})=>{const o=this.classes.get(n);if(!o){console.error(`ClassRegistry#onClassCreate: class ${n} not found`);return}const r=o.scope?new o.ClassConstructor(o.scope,...s):new o.ClassConstructor(...s);o.hosts.set(i,r)},this.onMethodUse=({id:i,name:n,method:s,args:o})=>{const r=this.classes.get(n);if(!r){console.error(`ClassRegistry#onMethodUse: class ${n} not found`);return}const a=r.hosts.get(i);if(!a){console.error(`ClassRegistry#onMethodUse: instance ${i} in class ${n} not found when calling the ${s} method`);return}if(!a[s]){console.error(`ClassRegistry#onMethodUse: method ${s} in instance ${i} in class ${n} not found`);return}return s==="destroy"&&r.hosts.delete(i),a[s](...o)},this.classes=new Map,this.idCounter=0,this.fnRegistry.set("createClass",this.onClassCreate),this.fnRegistry.set("classMethodUse",this.onMethodUse)}set(e,i,n){const s=this,o={ClassConstructor:i,hosts:new Map,proxies:new Map,scope:n};return this.classes.set(e,o),{get:r=>{class a{constructor(...d){this.id=s.idCounter++,s.fnRegistry.get(r,"createClass")({id:this.id,args:d,name:e})}}return Object.getOwnPropertyNames(i.prototype).forEach(c=>{c!=="constructor"&&(a.prototype[c]=function(...d){return s.fnRegistry.get(r,"classMethodUse")({id:this.id,name:e,method:c,args:d})})}),a}}}}function km(t,e,i,n,s=2){const o=s+2;let r=n;const a=i-e>>1;let l=i-e,c;const d=t[e],h=t[e+1],u=t[i],f=t[i+1];for(let m=e+o;m<i;m+=o){const p=HB(t[m],t[m+1],d,h,u,f);if(p>r)c=m,r=p;else if(p===r){const _=Math.abs(m-a);_<l&&(c=m,l=_)}}r>n&&(c-e>o&&km(t,e,c,n,s),t[c+2]=r,i-c>o&&km(t,c,i,n,s))}function HB(t,e,i,n,s,o){let r=s-i,a=o-n;if(r!==0||a!==0){const l=((t-i)*r+(e-n)*a)/(r*r+a*a);l>1?(i=s,n=o):l>0&&(i+=r*l,n+=a*l)}return r=t-i,a=e-n,r*r+a*a}function ql(t,e,i,n,s,o=4){const r={id:t??null,index:s,type:e,geometry:i,tags:n,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};if(e==="Point"||e==="MultiPoint"||e==="LineString")Th(r,i,o);else if(e==="Polygon")Th(r,i[0],o);else if(e==="MultiLineString")for(const a of i)Th(r,a,o);else if(e==="MultiPolygon")for(const a of i)Th(r,a[0],o);return r}function Th(t,e,i=4){for(let n=0;n<e.length;n+=i)t.minX=Math.min(t.minX,e[n]),t.minY=Math.min(t.minY,e[n+1]),t.maxX=Math.max(t.maxX,e[n]),t.maxY=Math.max(t.maxY,e[n+1])}function ZB(t,e){const i=[];if(t.type==="FeatureCollection")for(let n=0;n<t.features.length;n++)Eh(i,t.features[n],e,n);else t.type==="Feature"?Eh(i,t,e,0):Eh(i,{geometry:t},e,0);return i}function Eh(t,e,i,n){if(!e.geometry)return;const s=e.geometry.coordinates,o=e.geometry.type,r=Math.pow(i.tolerance/((1<<i.maxZoom)*i.extent),2);let a=[],l=e.id;if(i.promoteId?l=e.properties[i.promoteId]:i.generateId&&(l=n||0),o==="Point")fb(s,a,i.dimensions);else if(o==="MultiPoint")for(const c of s)fb(c,a,i.dimensions);else if(o==="LineString")Nm(s,a,r,!1,i.dimensions);else if(o==="MultiLineString")if(i.lineMetrics){for(const c of s)a=[],Nm(c,a,r,!1,i.dimensions),t.push(ql(l,"LineString",a,e.properties,n,i.dimensions+2));return}else Um(s,a,r,!1,i.dimensions);else if(o==="Polygon")Um(s,a,r,!0,i.dimensions);else if(o==="MultiPolygon")for(const c of s){const d=[];Um(c,d,r,!0,i.dimensions),a.push(d)}else if(o==="GeometryCollection"){for(const c of e.geometry.geometries)Eh(t,{id:l,geometry:c,properties:e.properties},i,n);return}else throw new Error("Input data is not a valid GeoJSON object.");t.push(ql(l,o,a,e.properties,n,i.dimensions+2))}function fb(t,e,i=2){e.push(_b(t[0]),mb(t[1]),0,1);for(let n=2;n<i;n++)e.push(t[n])}function Nm(t,e,i,n,s=2){let o,r,a=0;for(let c=0;c<t.length;c++){const d=_b(t[c][0]),h=mb(t[c][1]);e.push(d,h,0,1);for(let u=2;u<s;u++)e.push(t[c][u]);c>0&&(n?a+=(o*h-d*r)/2:a+=Math.sqrt(Math.pow(d-o,2)+Math.pow(h-r,2))),o=d,r=h}const l=e.length-(s+2);e[2]=1,km(e,0,l,i,s),e[l+2]=1,e.size=Math.abs(a),e.start=0,e.end=e.size}function Um(t,e,i,n,s=2){for(let o=0;o<t.length;o++){const r=[];Nm(t[o],r,i,n,s),e.push(r)}}function _b(t){return t/360+.5}function mb(t){const e=Math.sin(t*Math.PI/180),i=.5-.25*Math.log((1+e)/(1-e))/Math.PI;return i<0?0:i>1?1:i}function lo(t,e,i,n,s,o,r,a){const l=(a.dimensions===void 0?2:a.dimensions)+2;if(i/=e,n/=e,o>=i&&r<n)return t;if(r<i||o>=n)return null;const c=[];for(const d of t){const h=d.geometry;let u=d.type;const f=s===0?d.minX:d.minY,m=s===0?d.maxX:d.maxY;if(f>=i&&m<n){c.push(d);continue}else if(m<i||f>=n)continue;let p=[];if(u==="Point"||u==="MultiPoint")$B(h,p,i,n,s,l);else if(u==="LineString")pb(h,p,i,n,s,!1,a.lineMetrics,l);else if(u==="MultiLineString")Gm(h,p,i,n,s,!1,l);else if(u==="Polygon")Gm(h,p,i,n,s,!0,l);else if(u==="MultiPolygon")for(const _ of h){const g=[];Gm(_,g,i,n,s,!0,l),g.length&&p.push(g)}if(p.length){if(a.lineMetrics&&u==="LineString"){for(const _ of p)c.push(ql(d.id,u,_,d.tags,d.index,l));continue}(u==="LineString"||u==="MultiLineString")&&(p.length===1?(u="LineString",p=p[0]):u="MultiLineString"),(u==="Point"||u==="MultiPoint")&&(u=p.length===l?"Point":"MultiPoint"),c.push(ql(d.id,u,p,d.tags,d.index,l))}}return c.length?c:null}function $B(t,e,i,n,s,o=4){for(let r=0;r<t.length;r+=o){const a=t[r+s];if(a>=i&&a<=n){Ra(e,t[r],t[r+1],t[r+2]);for(let l=3;l<o;l++)e.push(t[r+l])}}}function pb(t,e,i,n,s,o,r,a=4){let l=gb(t);const c=s===0?WB:XB;let d=t.start,h,u;for(let y=0;y<t.length-a;y+=a){const b=t[y],v=t[y+1],I=t[y+2],S=t[y+a],P=t[y+a+1],T=s===0?b:v,L=s===0?S:P;let B=!1;if(r&&(h=Math.sqrt(Math.pow(b-S,2)+Math.pow(v-P,2))),T<i){if(L>i){u=c(l,b,v,S,P,i),l.push(0);for(let O=4;O<a;O++){const w=t[y+O];l.push((t[y+a+O]-w)*u+w)}r&&(l.start=d+h*u)}}else if(T>n){if(L<n){u=c(l,b,v,S,P,n),l.push(0);for(let O=4;O<a;O++){const w=t[y+O];l.push((t[y+a+O]-w)*u+w)}r&&(l.start=d+h*u)}}else{Ra(l,b,v,I);for(let O=3;O<a;O++)l.push(t[y+O])}if(L<i&&T>=i){u=c(l,b,v,S,P,i),l.push(0);for(let O=4;O<a;O++){const w=t[y+O];l.push((t[y+a+O]-w)*u+w)}B=!0}if(L>n&&T<=n){u=c(l,b,v,S,P,n),l.push(0);for(let O=4;O<a;O++){const w=t[y+O];l.push((t[y+a+O]-w)*u+w)}B=!0}!o&&B&&(r&&(l.end=d+h*u),e.push(l),l=gb(t)),r&&(d+=h)}let f=t.length-a;const m=t[f],p=t[f+1],_=t[f+2],g=s===0?m:p;if(g>=i&&g<=n){Ra(l,m,p,_);for(let y=3;y<a;y++)l.push(t[f+y])}if(f=l.length-a,o&&f>=3&&(l[f]!==l[0]||l[f+1]!==l[1])){Ra(l,l[0],l[1],l[2]);for(let y=3;y<a;y++)l.push(l[y])}l.length&&e.push(l)}function gb(t){const e=[];return e.size=t.size,e.start=t.start,e.end=t.end,e}function Gm(t,e,i,n,s,o,r){for(const a of t)pb(a,e,i,n,s,o,!1,r)}function Ra(t,e,i,n){t.push(e,i,n)}function WB(t,e,i,n,s,o){const r=(o-e)/(n-e);return Ra(t,o,i+(s-i)*r,1),r}function XB(t,e,i,n,s,o){const r=(o-i)/(s-i);return Ra(t,e+(n-e)*r,o,1),r}function YB(t,e){const i=e.buffer/e.extent,n=e.dimensions+2;let s=t;const o=lo(t,1,-1-i,i,0,-1,2,e),r=lo(t,1,1-i,2+i,0,-1,2,e);return(o||r)&&(s=lo(t,1,-i,1+i,0,-1,2,e)||[],o&&(s=vb(o,1,n).concat(s)),r&&(s=s.concat(vb(r,-1,n)))),s}function vb(t,e,i=4){const n=[];for(let s=0;s<t.length;s++){const o=t[s],r=o.type;let a;if(r==="Point"||r==="MultiPoint"||r==="LineString")a=jm(o.geometry,e,i);else if(r==="MultiLineString"||r==="Polygon"){a=[];for(const l of o.geometry)a.push(jm(l,e,i))}else if(r==="MultiPolygon"){a=[];for(const l of o.geometry){const c=[];for(const d of l)c.push(jm(d,e,i));a.push(c)}}n.push(ql(o.id,r,a,o.tags,o.index,i))}return n}function jm(t,e,i=4){const n=[];n.size=t.size,t.start!==void 0&&(n.start=t.start,n.end=t.end);for(let s=0;s<t.length;s+=i){n.push(t[s]+e,t[s+1],t[s+2],t[s+3]);for(let o=4;o<i;o++)n.push(t[s+o])}return n}function yb(t,e,i){if(t.transformed)return t;const n=1<<t.z,s=t.x,o=t.y;for(const r of t.features){const a=r.geometry,l=r.type;r.geometry=[];const c=i.cuts&&l!==1?1:0,d=i.dimensions+c;if(l===1)for(let h=0;h<a.length;h+=d)r.geometry.push(bb(a,h,d,e,n,s,o));else if(l===2)r.geometry=wb(a,e,n,s,o,d);else for(let h=0;h<a.length;h++)r.geometry.push(wb(a[h],e,n,s,o,d))}return t.transformed=!0,t}function wb(t,e,i,n,s,o=3){const r=[];for(let a=0;a<t.length;a++){const l=[];for(let c=0;c<t[a].length;c+=o)l.push(bb(t[a],c,o,e,i,n,s));r.push(l)}return r}function bb(t,e,i,n,s,o,r){const a=[Math.round(n*(t[e]*s-o)),Math.round(n*(t[e+1]*s-r))];for(let l=2;l<i;l++)a.push(t[e+l]);return a}function qB(t,e,i,n,s){const o=e===s.maxZoom?0:s.tolerance/((1<<e)*s.extent),r={features:[],numPoints:0,numSimplified:0,numFeatures:t.length,source:null,x:i,y:n,z:e,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0};for(const a of t)KB(r,a,o,s);return r}function KB(t,e,i,n){const s=e.geometry,o=e.type,r=n.dimensions+2;let a=[];if(t.minX=Math.min(t.minX,e.minX),t.minY=Math.min(t.minY,e.minY),t.maxX=Math.max(t.maxX,e.maxX),t.maxY=Math.max(t.maxY,e.maxY),o==="Point"||o==="MultiPoint")for(let l=0;l<s.length;l+=r){a.push(s[l],s[l+1]);for(let c=4;c<r;c++)a.push(s[l+c]);t.numPoints++,t.numSimplified++}else if(o==="LineString")Vm(a,s,t,i,!1,!1,n);else if(o==="MultiLineString"||o==="Polygon"){for(let l=0;l<s.length;l++)Vm(a,s[l],t,i,o==="Polygon",l===0,n);o==="Polygon"&&a.length&&(a=[a])}else if(o==="MultiPolygon")for(let l=0;l<s.length;l++){const c=s[l],d=[];for(let h=0;h<c.length;h++)Vm(d,c[h],t,i,!0,h===0,n);d.length&&a.push(d)}if(a.length){let l=e.tags||null;if(o==="LineString"&&n.lineMetrics){l={};for(const d in e.tags)l[d]=e.tags[d];l.mapbox_clip_start=s.start/s.size,l.mapbox_clip_end=s.end/s.size}const c={geometry:a,type:o==="Polygon"||o==="MultiPolygon"?3:o==="LineString"||o==="MultiLineString"?2:1,tags:l};e.id!==null&&(c.id=e.id),n.generateIndex&&(c.index=e.index),t.features.push(c)}}function Vm(t,e,i,n,s,o,r){const a=n*n,l=r&&!!r.cuts,c=r.dimensions+2;if(n>0&&e.size<(s?a:n)){i.numPoints+=e.length/c;return}const d=[];for(let h=0;h<e.length;h+=c){if(n===0||e[h+2]>a){i.numSimplified++,d.push(e[h],e[h+1]);for(let u=4;u<c;u++)d.push(e[h+u]);l&&d.push(e[h+3])}i.numPoints++}s&&JB(d,o,c-(l?1:2)),t.push(d)}function JB(t,e,i=3){let n=0;for(let s=0,o=t.length,r=o-i;s<o;r=s,s+=i)n+=(t[s]-t[r])*(t[s+1]+t[r+1]);if(n>0===e)for(let s=0,o=t.length;s<o/2;s+=i)for(let r=0;r<i;r++){const a=t[s+r],l=o-s-(i-r);t[s+r]=t[l],t[l]=a}return t}const Hm={Points:1,Lines:2,Polygons:3},QB={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,generateIndex:!1,debug:0,dimensions:2,cuts:!1};class ek{constructor(e,i){i=this.options=tk(Object.create(QB),i);const n=i.debug;if(n&&console.time("preprocess data"),i.maxZoom<0||i.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(i.promoteId&&i.generateId)throw new Error("promoteId and generateId cannot be used together.");let s=ZB(e,i);this.tiles={},this.tileCoords=[],n&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",i.indexMaxZoom,i.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),s=YB(s,i),s.length&&this.splitTile(s,0,0,0),n&&(s.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}splitTile(e,i,n,s,o,r,a){const l=[e,i,n,s],c=this.options,d=c.debug;for(;l.length;){s=l.pop(),n=l.pop(),i=l.pop(),e=l.pop();const h=1<<i,u=Zm(i,n,s);let f=this.tiles[u];if(!f&&(d>1&&console.time("creation"),f=this.tiles[u]=qB(e,i,n,s,c),this.tileCoords.push({z:i,x:n,y:s}),d)){d>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",i,n,s,f.numFeatures,f.numPoints,f.numSimplified),console.timeEnd("creation"));const T=`z${i}`;this.stats[T]=(this.stats[T]||0)+1,this.total++}if(f.source=e,o==null){if(i===c.indexMaxZoom||f.numPoints<=c.indexMaxPoints)continue}else{if(i===c.maxZoom||i===o)continue;if(o!=null){const T=o-i;if(n!==r>>T||s!==a>>T)continue}}if(f.source=null,e.length===0)continue;d>1&&console.time("clipping");const m=.5*c.buffer/c.extent,p=.5-m,_=.5+m,g=1+m;let y=null,b=null,v=null,I=null,S=lo(e,h,n-m,n+_,0,f.minX,f.maxX,c),P=lo(e,h,n+p,n+g,0,f.minX,f.maxX,c);e=null,S&&(y=lo(S,h,s-m,s+_,1,f.minY,f.maxY,c),b=lo(S,h,s+p,s+g,1,f.minY,f.maxY,c),S=null),P&&(v=lo(P,h,s-m,s+_,1,f.minY,f.maxY,c),I=lo(P,h,s+p,s+g,1,f.minY,f.maxY,c),P=null),d>1&&console.timeEnd("clipping"),l.push(y||[],i+1,n*2,s*2),l.push(b||[],i+1,n*2,s*2+1),l.push(v||[],i+1,n*2+1,s*2),l.push(I||[],i+1,n*2+1,s*2+1)}}getTile(e,i,n){e=+e,i=+i,n=+n;const s=this.options,{extent:o,debug:r}=s;if(e<0||e>24)return null;const a=1<<e;i=i+a&a-1;const l=Zm(e,i,n);if(this.tiles[l])return yb(this.tiles[l],o,s);r>1&&console.log("drilling down to z%d-%d-%d",e,i,n);let c=e,d=i,h=n,u;for(;!u&&c>0;)c--,d=d>>1,h=h>>1,u=this.tiles[Zm(c,d,h)];return!u||!u.source?null:(r>1&&(console.log("found parent tile z%d-%d-%d",c,d,h),console.time("drilling down")),this.splitTile(u.source,c,d,h,e,i,n),r>1&&console.timeEnd("drilling down"),this.tiles[l]?yb(this.tiles[l],o,s):null)}}function Zm(t,e,i){return((1<<t)*i+e)*32+t}function tk(t,e){for(const i in e)t[i]=e[i];return t}function ik(t,e){return new ek(t,e)}var Ah={exports:{}},xb;function nk(){if(xb)return Ah.exports;xb=1,Ah.exports=t,Ah.exports.default=t;function t(M,A,E){E=E||2;var k=A&&A.length,D=k?A[0]*E:M.length,U=e(M,0,D,E,!0),N=[];if(!U||U.next===U.prev)return N;var G,Q,X,H,K,oe,Me;if(k&&(U=l(M,A,U,E)),M.length>80*E){G=X=M[0],Q=H=M[1];for(var re=E;re<D;re+=E)K=M[re],oe=M[re+1],K<G&&(G=K),oe<Q&&(Q=oe),K>X&&(X=K),oe>H&&(H=oe);Me=Math.max(X-G,H-Q),Me=Me!==0?32767/Me:0}return n(U,N,E,G,Q,Me,0),N}function e(M,A,E,k,D){var U,N;if(D===V(M,A,E,k)>0)for(U=A;U<E;U+=k)N=w(U,M[U],M[U+1],N);else for(U=E-k;U>=A;U-=k)N=w(U,M[U],M[U+1],N);return N&&v(N,N.next)&&(x(N),N=N.next),N}function i(M,A){if(!M)return M;A||(A=M);var E=M,k;do if(k=!1,!E.steiner&&(v(E,E.next)||b(E.prev,E,E.next)===0)){if(x(E),E=A=E.prev,E===E.next)break;k=!0}else E=E.next;while(k||E!==A);return A}function n(M,A,E,k,D,U,N){if(M){!N&&U&&f(M,k,D,U);for(var G=M,Q,X;M.prev!==M.next;){if(Q=M.prev,X=M.next,U?o(M,k,D,U):s(M)){A.push(Q.i/E|0),A.push(M.i/E|0),A.push(X.i/E|0),x(M),M=X.next,G=X.next;continue}if(M=X,M===G){N?N===1?(M=r(i(M),A,E),n(M,A,E,k,D,U,2)):N===2&&a(M,A,E,k,D,U):n(i(M),A,E,k,D,U,1);break}}}}function s(M){var A=M.prev,E=M,k=M.next;if(b(A,E,k)>=0)return!1;for(var D=A.x,U=E.x,N=k.x,G=A.y,Q=E.y,X=k.y,H=D<U?D<N?D:N:U<N?U:N,K=G<Q?G<X?G:X:Q<X?Q:X,oe=D>U?D>N?D:N:U>N?U:N,Me=G>Q?G>X?G:X:Q>X?Q:X,re=k.next;re!==A;){if(re.x>=H&&re.x<=oe&&re.y>=K&&re.y<=Me&&g(D,G,U,Q,N,X,re.x,re.y)&&b(re.prev,re,re.next)>=0)return!1;re=re.next}return!0}function o(M,A,E,k){var D=M.prev,U=M,N=M.next;if(b(D,U,N)>=0)return!1;for(var G=D.x,Q=U.x,X=N.x,H=D.y,K=U.y,oe=N.y,Me=G<Q?G<X?G:X:Q<X?Q:X,re=H<K?H<oe?H:oe:K<oe?K:oe,Le=G>Q?G>X?G:X:Q>X?Q:X,be=H>K?H>oe?H:oe:K>oe?K:oe,ge=p(Me,re,A,E,k),ie=p(Le,be,A,E,k),J=M.prevZ,ae=M.nextZ;J&&J.z>=ge&&ae&&ae.z<=ie;){if(J.x>=Me&&J.x<=Le&&J.y>=re&&J.y<=be&&J!==D&&J!==N&&g(G,H,Q,K,X,oe,J.x,J.y)&&b(J.prev,J,J.next)>=0||(J=J.prevZ,ae.x>=Me&&ae.x<=Le&&ae.y>=re&&ae.y<=be&&ae!==D&&ae!==N&&g(G,H,Q,K,X,oe,ae.x,ae.y)&&b(ae.prev,ae,ae.next)>=0))return!1;ae=ae.nextZ}for(;J&&J.z>=ge;){if(J.x>=Me&&J.x<=Le&&J.y>=re&&J.y<=be&&J!==D&&J!==N&&g(G,H,Q,K,X,oe,J.x,J.y)&&b(J.prev,J,J.next)>=0)return!1;J=J.prevZ}for(;ae&&ae.z<=ie;){if(ae.x>=Me&&ae.x<=Le&&ae.y>=re&&ae.y<=be&&ae!==D&&ae!==N&&g(G,H,Q,K,X,oe,ae.x,ae.y)&&b(ae.prev,ae,ae.next)>=0)return!1;ae=ae.nextZ}return!0}function r(M,A,E){var k=M;do{var D=k.prev,U=k.next.next;!v(D,U)&&I(D,k,k.next,U)&&L(D,U)&&L(U,D)&&(A.push(D.i/E|0),A.push(k.i/E|0),A.push(U.i/E|0),x(k),x(k.next),k=M=U),k=k.next}while(k!==M);return i(k)}function a(M,A,E,k,D,U){var N=M;do{for(var G=N.next.next;G!==N.prev;){if(N.i!==G.i&&y(N,G)){var Q=O(N,G);N=i(N,N.next),Q=i(Q,Q.next),n(N,A,E,k,D,U,0),n(Q,A,E,k,D,U,0);return}G=G.next}N=N.next}while(N!==M)}function l(M,A,E,k){var D=[],U,N,G,Q,X;for(U=0,N=A.length;U<N;U++)G=A[U]*k,Q=U<N-1?A[U+1]*k:M.length,X=e(M,G,Q,k,!1),X===X.next&&(X.steiner=!0),D.push(_(X));for(D.sort(c),U=0;U<D.length;U++)E=d(D[U],E);return E}function c(M,A){return M.x-A.x}function d(M,A){var E=h(M,A);if(!E)return A;var k=O(E,M);return i(k,k.next),i(E,E.next)}function h(M,A){var E=A,k=M.x,D=M.y,U=-1/0,N;do{if(D<=E.y&&D>=E.next.y&&E.next.y!==E.y){var G=E.x+(D-E.y)*(E.next.x-E.x)/(E.next.y-E.y);if(G<=k&&G>U&&(U=G,N=E.x<E.next.x?E:E.next,G===k))return N}E=E.next}while(E!==A);if(!N)return null;var Q=N,X=N.x,H=N.y,K=1/0,oe;E=N;do k>=E.x&&E.x>=X&&k!==E.x&&g(D<H?k:U,D,X,H,D<H?U:k,D,E.x,E.y)&&(oe=Math.abs(D-E.y)/(k-E.x),L(E,M)&&(oe<K||oe===K&&(E.x>N.x||E.x===N.x&&u(N,E)))&&(N=E,K=oe)),E=E.next;while(E!==Q);return N}function u(M,A){return b(M.prev,M,A.prev)<0&&b(A.next,M,M.next)<0}function f(M,A,E,k){var D=M;do D.z===0&&(D.z=p(D.x,D.y,A,E,k)),D.prevZ=D.prev,D.nextZ=D.next,D=D.next;while(D!==M);D.prevZ.nextZ=null,D.prevZ=null,m(D)}function m(M){var A,E,k,D,U,N,G,Q,X=1;do{for(E=M,M=null,U=null,N=0;E;){for(N++,k=E,G=0,A=0;A<X&&(G++,k=k.nextZ,!!k);A++);for(Q=X;G>0||Q>0&&k;)G!==0&&(Q===0||!k||E.z<=k.z)?(D=E,E=E.nextZ,G--):(D=k,k=k.nextZ,Q--),U?U.nextZ=D:M=D,D.prevZ=U,U=D;E=k}U.nextZ=null,X*=2}while(N>1);return M}function p(M,A,E,k,D){return M=(M-E)*D|0,A=(A-k)*D|0,M=(M|M<<8)&16711935,M=(M|M<<4)&252645135,M=(M|M<<2)&858993459,M=(M|M<<1)&1431655765,A=(A|A<<8)&16711935,A=(A|A<<4)&252645135,A=(A|A<<2)&858993459,A=(A|A<<1)&1431655765,M|A<<1}function _(M){var A=M,E=M;do(A.x<E.x||A.x===E.x&&A.y<E.y)&&(E=A),A=A.next;while(A!==M);return E}function g(M,A,E,k,D,U,N,G){return(D-N)*(A-G)>=(M-N)*(U-G)&&(M-N)*(k-G)>=(E-N)*(A-G)&&(E-N)*(U-G)>=(D-N)*(k-G)}function y(M,A){return M.next.i!==A.i&&M.prev.i!==A.i&&!T(M,A)&&(L(M,A)&&L(A,M)&&B(M,A)&&(b(M.prev,M,A.prev)||b(M,A.prev,A))||v(M,A)&&b(M.prev,M,M.next)>0&&b(A.prev,A,A.next)>0)}function b(M,A,E){return(A.y-M.y)*(E.x-A.x)-(A.x-M.x)*(E.y-A.y)}function v(M,A){return M.x===A.x&&M.y===A.y}function I(M,A,E,k){var D=P(b(M,A,E)),U=P(b(M,A,k)),N=P(b(E,k,M)),G=P(b(E,k,A));return!!(D!==U&&N!==G||D===0&&S(M,E,A)||U===0&&S(M,k,A)||N===0&&S(E,M,k)||G===0&&S(E,A,k))}function S(M,A,E){return A.x<=Math.max(M.x,E.x)&&A.x>=Math.min(M.x,E.x)&&A.y<=Math.max(M.y,E.y)&&A.y>=Math.min(M.y,E.y)}function P(M){return M>0?1:M<0?-1:0}function T(M,A){var E=M;do{if(E.i!==M.i&&E.next.i!==M.i&&E.i!==A.i&&E.next.i!==A.i&&I(E,E.next,M,A))return!0;E=E.next}while(E!==M);return!1}function L(M,A){return b(M.prev,M,M.next)<0?b(M,A,M.next)>=0&&b(M,M.prev,A)>=0:b(M,A,M.prev)<0||b(M,M.next,A)<0}function B(M,A){var E=M,k=!1,D=(M.x+A.x)/2,U=(M.y+A.y)/2;do E.y>U!=E.next.y>U&&E.next.y!==E.y&&D<(E.next.x-E.x)*(U-E.y)/(E.next.y-E.y)+E.x&&(k=!k),E=E.next;while(E!==M);return k}function O(M,A){var E=new C(M.i,M.x,M.y),k=new C(A.i,A.x,A.y),D=M.next,U=A.prev;return M.next=A,A.prev=M,E.next=D,D.prev=E,k.next=E,E.prev=k,U.next=k,k.prev=U,k}function w(M,A,E,k){var D=new C(M,A,E);return k?(D.next=k.next,D.prev=k,k.next.prev=D,k.next=D):(D.prev=D,D.next=D),D}function x(M){M.next.prev=M.prev,M.prev.next=M.next,M.prevZ&&(M.prevZ.nextZ=M.nextZ),M.nextZ&&(M.nextZ.prevZ=M.prevZ)}function C(M,A,E){this.i=M,this.x=A,this.y=E,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}t.deviation=function(M,A,E,k){var D=A&&A.length,U=D?A[0]*E:M.length,N=Math.abs(V(M,0,U,E));if(D)for(var G=0,Q=A.length;G<Q;G++){var X=A[G]*E,H=G<Q-1?A[G+1]*E:M.length;N-=Math.abs(V(M,X,H,E))}var K=0;for(G=0;G<k.length;G+=3){var oe=k[G]*E,Me=k[G+1]*E,re=k[G+2]*E;K+=Math.abs((M[oe]-M[re])*(M[Me+1]-M[oe+1])-(M[oe]-M[Me])*(M[re+1]-M[oe+1]))}return N===0&&K===0?0:Math.abs((K-N)/N)};function V(M,A,E,k){for(var D=0,U=A,N=E-k;U<E;U+=k)D+=(M[N]-M[U])*(M[U+1]+M[N+1]),N=U;return D}return t.flatten=function(M){for(var A=M[0][0].length,E={vertices:[],holes:[],dimensions:A},k=0,D=0;D<M.length;D++){for(var U=0;U<M[D].length;U++)for(var N=0;N<A;N++)E.vertices.push(M[D][U][N]);D>0&&(k+=M[D-1].length,E.holes.push(k))}return E},Ah.exports}var sk=nk();const $m=Ja(sk);function ok(t){const e=Ye(t),i=Z.scaleFactor(el(0,0,e)[1]),n=Z.scaleFactor(el(0,xe,e)[1]);return{min:i,max:n,range:n-i}}function rk(t,e,i,n){const s=[];return t.geometry.forEach(o=>{const r=[],a=[],l=[];o.forEach(u=>{l.push(...hk(u,e)),r.length&&a.push(r.length),r.push(...u)});const c=[];for(let u=0;u<r.length;u++)for(let f=0;f<i;f++)c.push(r[u][f]);const d=$m(c,a,i),h=new Array(i);for(let u=0;u<d.length;u+=3){const f=[];for(let m=0;m<i+1;m++)f.push([]);for(let m=0;m<3;m++)Wm(h,r[d[u+2-m]],e,n),f[0][m]=h[0],f[1][m]=h[1],f[2][m]=0,i>2&&(f[3][m]=h[2]),i>3&&(f[4][m]=h[3]);l.forEach(m=>{const p=[[],[],[]];m.forEach((_,g)=>{p[0][g]=_[0],p[1][g]=_[1]}),lb(f,p)}),s.push({tags:t.tags,id:t.id,index:t.index,type:"polygon",vertices:{x:f[0],y:f[1],cut:f[2],signed_z:f[3],abs_z:f[4]}})}}),s}function ak(t,e,i,n){const s=Array(i);return t.geometry.map(o=>{const r=[];for(let a=0;a<i;a++)r.push([]);return o.forEach((a,l)=>{Wm(s,a,e,n),r[0][l]=s[0],r[1][l]=s[1],i>2&&(r[2][l]=s[2]),i>3&&(r[3][l]=s[3])}),{tags:t.tags,id:t.id,index:t.index,type:"line",vertices:{x:r[0],y:r[1],z:r[2],signed_z:r[2],abs_z:r[3]}}})}function lk(t,e,i,n){const s=Array(i);return t.geometry.map(o=>{Wm(s,o,e,n);const r={x:[s[0]],y:[s[1]],z:i>2?[s[2]??0]:void 0,abs_z:i>3&&s[3]!==void 0?[s[3]]:void 0};return{tags:t.tags,id:t.id,index:t.index,type:"point",vertices:r}})}function Wm(t,e,i,n){const s=Sb(e,i);t[0]=s[0],t[1]=s[1];const o=n.min+s[1]/xe*n.range;e[2]===void 0?t[2]=0:t[2]=e[2]*Ge*o,e[3]!==void 0&&(t[3]=e[3]*Ge*o)}function Sb(t,e){return[Be(t[0]/e*xe,0,xe),Be((e-t[1])/e*xe,0,xe)]}function ck(t,e){return t[0]<0||t[0]>e||t[1]<0||t[1]>e}function dk(t,e,i){return t[0]>i&&e[0]>i||t[0]<0&&e[0]<0||t[1]>i&&e[1]>i||t[1]<0&&e[1]<0}function hk(t,e){const i=[];let n=[];for(let s=0;s<t.length;s++){const o=t[s];if(n.push(Sb(o,e)),!ck(o,e))continue;const r=t[s+1];if(!r)break;dk(o,r,e)&&(n.length>1&&i.push(n),n=[])}return n.length>1&&i.push(n),i}const Mb=4096,Ib=2,za={maxZoom:g0,tolerance:3,extent:Mb,buffer:1,debug:0,lineMetrics:!1,promoteId:null,generateId:!1,generateIndex:!0,indexMaxZoom:0,indexMaxPoints:1e5,dimensions:Ib};class Xm{constructor(e){this.options=e}get geoJsonVtInstance(){return this.geoJsonVT||(this.geoJsonVT=ik(this.options.data,{...za,maxZoom:this.options.maxZoom??za.maxZoom,dimensions:this.options.dimensions??za.dimensions,extent:this.options.extent??za.extent,buffer:this.options.buffer??za.buffer,promoteId:this.options.promoteId,tolerance:this.options.tolerance??za.tolerance})),this.geoJsonVT}fetchTile(e){const[i,n,s]=Jr(e),o={components:[],byId:new Map},r=this.geoJsonVtInstance.getTile(s,i,n),a=this.options.dimensions??Ib,l=this.options.extent??Mb,c=ok(e);if(!r)return Promise.resolve(o);for(const d of r.features)switch(d.type){case Hm.Points:o.components=o.components.concat(lk(d,l,a,c));break;case Hm.Lines:o.components=o.components.concat(ak(d,l,a,c));break;case Hm.Polygons:o.components=o.components.concat(rk(d,l,a,c));break;default:console.warn("unsupported type ",r);break}return Promise.resolve(o)}destroy(){this.geoJsonVT=void 0}}function uk(t,e,i){const n={components:[],byId:new Map};return t.features.forEach((s,o)=>{n.components.push(...Tb(s.geometry,e).map(r=>({...r,index:o,id:s.id,tags:s.properties||{}})))}),n}function Tb(t,e,i){switch(t.type){case"GeometryCollection":{let n=[];return t.geometries.forEach(s=>{n=n.concat(Tb(s,e))}),n}case"Point":case"MultiPoint":return fk(t,e);case"LineString":case"MultiLineString":return _k(t,e);case"Polygon":case"MultiPolygon":return mk(t,e)}}function fk(t,e){return t.type==="Point"?[Eb(t.coordinates,e)]:t.coordinates.map(i=>Eb(i,e))}function _k(t,e){return t.type==="LineString"?[Ab(t.coordinates,e)]:t.coordinates.map(i=>Ab(i,e))}function mk(t,e,i){return t.type==="Polygon"?Pb(t.coordinates,e):t.coordinates.reduce((n,s)=>n.concat(Pb(s,e)),[])}function Eb(t,e){const i=[0,0,0];return Pt(i,Z.fromGeo(t),e),{type:"point",vertices:{x:[i[0]],y:[i[1]]}}}function Ab(t,e){const i=[[],[]],n=[0,0,0];return t.forEach((s,o)=>{Pt(n,Z.fromGeo(s),e),i[0][o]=n[0],i[1][o]=n[1]}),{type:"line",vertices:{x:i[0],y:i[1]}}}function Pb(t,e,i){const n=[],s=[],o=[],r=[],a=[];t.forEach(d=>{const h=d.map(u=>(Pt(a,Z.fromGeo(u),e),[Be(a[0],0,xe),Be(a[1],0,xe)]));r.push(h),s.length&&o.push(s.length),s.push(...h)});const l=[];for(let d=0;d<s.length;d++)l.push(s[d][0]),l.push(s[d][1]);const c=$m(l,o);for(let d=0;d<c.length;d+=3){const h=[[],[],[],[]];for(let f=0;f<3;f++)h[0][f]=s[c[d+f]][0],h[1][f]=s[c[d+f]][1],h[2][f]=0,h[3][f]=s[c[d+f]][2];r.forEach(f=>{const m=[[],[],[]];f.forEach((p,_)=>{m[0][_]=p[0],m[1][_]=p[1]}),lb(h,m)});const u={type:"polygon",vertices:{x:h[0],y:h[1],cut:h[2]}};n.push(u)}return n}class Ph{constructor(e){this.tileLoader=new Ul("json",e.ignoreMissingTiles),this.options=e,this.url=i=>{const n=this.options.flipY?i:Jr(i);return Ka(this.options.url,{x:n[0].toString(),y:n[1].toString(),z:n[2].toString(),subdomain:Dg(n)})}}fetchTile(e){return this.tileLoader.fetch(e,this.url).then(i=>i.data?uk(i.data,Ye(e)):{components:[],byId:new Map})}abortTile(e){this.tileLoader.abortRequest(Ce(e))}destroy(){this.tileLoader.destroy()}}const Lh=4;class pk{constructor(e,i,n){this.scope=e,this.options=i,this.id=n,this.featureStateMap=new __,e.sources[n]=this,this.tileData={},this.styleManager=e.styleManager,this.collector=e.collector,this.sourceAttrs=this.options.attributes||{},this.metatile=cb(),this.tileServer="url"in i?new Ph(i):new Xm(i)}fetchTile(e){const i=Ce(e);return this.tileData[i]?Promise.resolve(this.tileData[i]):this.tileServer.fetchTile(e).then(n=>(this.tileData[i]=n,n))}abortTileFetch(e){this.tileServer instanceof Ph&&this.tileServer.abortTile(e)}generateTile(e,i,n,s,o,r,a,l){const c=Ce(i),d=this.tileData[c],h=Ye(i),u=[],f=[],m=this.styleManager.getStyle(n),p=new Set(s),{promoteId:_}=this.options,g={},y="generateId"in this.options?this.options.generateId:!1;if(!m)return Promise.resolve({results:u,transferable:f});d&&d.components.forEach((S,P)=>{const{tileProps:T}=this.metatile,L=[],B=[];if(S.tags){const D=Object.keys(S.tags);Qa(this.metatile,D);for(const U of D)L[T[U]]=S.tags[U]}const O=Object.keys(this.sourceAttrs);Qa(this.metatile,O);const w=Array.from(this.featureStateMap.featureAttrs);Qa(this.metatile,w);for(const D of O)L[T[D]]=this.sourceAttrs[D];const x=L[T.db_hidden_by_plan_id];if(x&&e._activeFloorIds.includes(x))return;const C=y?String(S.index+this.id*2**32):_?L[T[_]]:void 0;if(C!==void 0){const D=p.has(C);if(L[T.selected]=D?1:0,d.byId.set(C,P),g[C]=S.index,this.featureStateMap.featureAttrs.size>0){const U=C!==void 0&&this.featureStateMap.get(C);if(U)for(const N of this.featureStateMap.featureAttrs)this.featureStateMap.clearAttrs=!1,B[T[N]]=U[N];else if(this.featureStateMap.clearAttrs===!1){this.featureStateMap.clearAttrs=!0;for(const N in T)B[T[N]]!==void 0&&(B[T[N]]=void 0)}}}const{coords:V}=h,M=V[3],A=dr(o),E=di(e,this.sourceAttrs,T,L,B,C,h),k=this.styleManager.getLayers(m.id,T,L).filter(D=>CB(S.type,D.type)&&q(D.filter,E)&&(a?q(a,E):!0));if(k.length===0&&E.id&&this.collector.idIndexer.addOrphanId(E.id),L[T.db_geometry_type]=S.type==="line"?"polyline":S.type,(S.type==="point"||S.type==="line")&&(L[T.db_label]===void 0&&(L[T.db_label]=NaN),L[T.db_label2]===void 0&&(L[T.db_label2]=NaN)),S.type==="line"){const D=RB(S);L[T.componentDistanceStart]=0,L[T.componentDistanceEnd]=D,L[T.objectLength]=D,typeof L[T.beginningIsCut]!="number"&&(L[T.beginningIsCut]=0),typeof L[T.endingIsCut]!="number"&&(L[T.endingIsCut]=0)}Ly(this.collector,m,k,E,this.metatile,Lh,M,this.id,h,A,S.vertices,void 0,r,l)});const b=this.collector.getAccumulatedData(),v={regionId:0,metatileHash:Tp,collectorOutput:b,styleId:m.id};Object.keys(g).length>0&&(v.idToIndex=g),u.push(v),f.push(...b.transferable),this.scope.debouncedResetCollector(),this.scope.syncNewRasterSets();const I={results:u,transferable:f};return Promise.resolve(I)}getObjectAttributes(e,i){const n=this.tileData[i];if(n){const s=n.byId.get(e);if(s===void 0)return;const o=n.components[s];return o===void 0?void 0:o.tags}}deleteTile(e){delete this.tileData[Ce(e)]}setSourceAttrs(e){this.sourceAttrs=e}destroy(){delete this.scope.sources[this.id],this.tileData={},this.sourceAttrs={},this.tileServer.destroy()}setFeatureStateMap(e){this.featureStateMap=k0(e)}setData(e){if(typeof e=="string"){if(this.tileServer instanceof Ph)return this.tileServer.destroy(),this.options={...this.options,url:e},this.tileServer=new Ph(this.options),this.tileData={},Promise.resolve(!0)}else if(this.tileServer instanceof Xm)return this.tileServer.destroy(),this.options={...this.options,data:e},this.tileServer=new Xm(this.options),this.tileData={},Promise.resolve(!0);return Promise.resolve(!1)}}function gk(t,e){return{path:e,extensions:t.extensions,extensionsRequired:t.extensionsRequired??[],extensionsUsed:t.extensionsUsed??[],extras:t.extras,accessors:yk(t.accessors),buffers:bk(t.buffers),bufferViews:xk(t.bufferViews),cameras:Sk(t.cameras),scene:t.scene??0,scenes:Tk(t.scenes),nodes:Ek(t.nodes),materials:Ik(t.materials),meshes:Mk(t.meshes),asset:vk(t.asset),animations:wk(t.animations),images:Ak(t.images),textures:Pk(t.textures),samplers:Lk(t.samplers),skins:Ck(t.skins)}}function vk(t){return{copyright:t.copyright,generator:t.generator,version:t.version,minVersion:t.minVersion}}function yk(t=[]){return t.map(e=>({bufferView:e.bufferView,byteOffset:e.byteOffset??0,componentType:e.componentType,normalized:e.normalized,count:e.count,type:e.type,max:e.max,min:e.min,sparse:e.sparse,name:e.name,extensions:e.extensions,extras:e.extras}))}function wk(t=[]){return t.map(e=>({channels:e.channels,samplers:e.samplers,name:e.name,extensions:e.extensions,extras:e.extras}))}function bk(t=[]){return t.map(e=>({uri:e.uri,byteLength:e.byteLength,name:e.name,extensions:e.extensions,extras:e.extras,buffer:void 0}))}function xk(t=[]){return t.map(e=>({buffer:e.buffer,byteOffset:e.byteOffset,byteLength:e.byteLength,byteStride:e.byteStride,target:e.target,name:e.name,extensions:e.extensions,extras:e.extras}))}function Sk(t=[]){return t.map(e=>({type:e.type,orthographic:e.orthographic,perspective:e.perspective,name:e.name,extensions:e.extensions,extras:e.extras}))}function Mk(t=[]){return t.map(e=>({primitives:e.primitives,name:e.name,weights:e.weights,extensions:e.extensions,extras:e.extras}))}function Ik(t=[]){return t.map(e=>({alphaCutoff:e.alphaCutoff,alphaMode:e.alphaMode,doubleSided:e.doubleSided,emissiveFactor:e.emissiveFactor,emissiveTexture:e.emissiveTexture,normalTexture:e.normalTexture,occlusionTexture:e.occlusionTexture,pbrMetallicRoughness:e.pbrMetallicRoughness,name:e.name,extras:e.extras,extensions:e.extensions}))}function Tk(t=[]){return t.map(e=>({nodes:e.nodes,extensions:e.extensions,extras:e.extras,name:e.name}))}function Ek(t=[]){return t.map(e=>{const i=e.rotation??[0,0,0,1],n=e.scale??[1,1,1],s=e.translation??[0,0,0];return{camera:e.camera,children:e.children,matrix:e.matrix?b2(...e.matrix):void 0,rotation:L2(...i),scale:at(...n),translation:at(...s),name:e.name,mesh:e.mesh,skin:e.skin,extras:e.extras,extensions:e.extensions}})}function Ak(t=[]){return t.map(e=>({bufferView:e.bufferView,mimeType:e.mimeType,name:e.name,uri:e.uri,extensions:e.extensions,extras:e.extras,image:void 0}))}function Pk(t=[]){return t.map(e=>({extensions:e.extensions,extras:e.extras,name:e.name,sampler:e.sampler,source:e.source}))}function Lk(t=[]){return t.map(e=>({extensions:e.extensions,extras:e.extras,name:e.name,magFilter:e.magFilter,minFilter:e.minFilter,wrapS:e.wrapS,wrapT:e.wrapT}))}function Ck(t=[]){return t.map(e=>({joints:e.joints,extensions:e.extensions,extras:e.extras,inverseBindMatrices:e.inverseBindMatrices,name:e.name,skeleton:e.skeleton}))}const Kl={JPEG:"image/jpeg",PNG:"image/png",GLTEXTURE:"image/texture"};function Lb(t){return t.substring(0,t.lastIndexOf("/")+1)}function Rk(t){if(t.startsWith("data:image"))return t.split(";")[0].split(":")[1];switch(t.substring(t.lastIndexOf("."))){case".png":return Kl.PNG;case".jpg":case".jpeg":default:return Kl.JPEG}}function Cb(t){const e=atob(t.split(",")[1]),i=new ArrayBuffer(e.length),n=new Uint8Array(i);for(let s=0;s<e.length;s++)n[s]=e.charCodeAt(s);return i}const Xt=class Xt{constructor(e){this.data=e}static isGlb(e){const i=new Uint32Array(e,0,Xt.glbHeaderInts),n=i[0],s=i[1];return n===this.glbMagic&&s===this.glbVersion}extractGlbData(){if(this.getCheckedGlbInfo()===void 0)return{json:Km,buffers:[]};let i;const n=[],s=this.getAllChunkInfos();for(const o of s)o.type===Xt.jsonChunkType&&!i?i=this.getJsonFromChunk(o):o.type===Xt.binaryChunkType&&n.push(this.getBufferFromChunk(o));return{json:i||Km,buffers:n}}getCheckedGlbInfo(){const e=new Uint32Array(this.data,0,Xt.glbHeaderInts),i=e[0],n=e[1],s=e[2];if(!(!this.checkEquality(i,Xt.glbMagic,"glb magic")||!this.checkEquality(n,Xt.glbVersion,"glb header version")||!this.checkEquality(s,this.data.byteLength,"glb byte length")))return{magic:i,version:n,length:s}}getAllChunkInfos(){const e=[];let i=Xt.glbHeaderInts*4;for(;i<this.data.byteLength;){const n=this.getChunkInfo(i);e.push(n),i+=n.length+Xt.glbChunkHeaderInts*4}return e}getChunkInfo(e){const i=new Uint32Array(this.data,e,Xt.glbChunkHeaderInts),n=e+Xt.glbChunkHeaderInts*4,s=i[0],o=i[1];return{start:n,length:s,type:o}}getJsonFromChunk(e){const i=e.length,n=(Xt.glbHeaderInts+Xt.glbChunkHeaderInts)*4,s=new Uint8Array(this.data,n,i),o=new TextDecoder("utf-8").decode(s);return JSON.parse(o)}getBufferFromChunk(e){return this.data.slice(e.start,e.start+e.length)}checkEquality(e,i,n){return e===i?!0:(console.error(`[GLB MODEL PARSING ERROR] Found invalid/unsupported ${n}, expected: ${i}, but was: ${e}`),!1)}};Xt.glbHeaderInts=3,Xt.glbChunkHeaderInts=2,Xt.glbMagic=1179937895,Xt.glbVersion=2,Xt.jsonChunkType=1313821514,Xt.binaryChunkType=5130562;let Ch=Xt;const Rb=5120,zk=5121,Fk=5122,Dk=5123,Ok=5124,zb=5125,Bk=5126,kk=4;let Ym;function Nk(t){Ym=Gk(t).then(e=>e).catch(e=>{const i="Draco decoder module failed to initialize"+(e!=null&&e.message?` with the following error: ${e.message}`:".");throw new Error(i)})}async function Uk(t){let e=await fetch(t).then(s=>s.text());const n=e.indexOf("if (typeof exports === 'object' && typeof module === 'object')");return n!==0&&(e=e.slice(0,n),e=e+"return DracoDecoderModule;"),e}async function Gk(t){const e=await Uk(t);return new Function(e)()()}function jk(t){switch(t){case Rb:return"Int8Array";case zk:return"Uint8Array";case Fk:return"Int16Array";case Dk:return"Uint16Array";case Ok:return"Int32Array";case zb:return"Uint32Array";case Bk:return"Float32Array";default:return"Float32Array"}}function Vk(t,e,i,n,s,o){const r=s.num_components(),l=i.num_points()*r;let c,d,h;switch(o){case"Float32Array":h=l*4,c=t._malloc(h),e.GetAttributeDataArrayForAllPoints(i,s,t.DT_FLOAT32,h,c),d=new Float32Array(t.HEAPF32.buffer,c,l).slice(),t._free(c);break;case"Int8Array":c=t._malloc(l),e.GetAttributeDataArrayForAllPoints(i,s,t.DT_INT8,l,c),d=new Int8Array(t.HEAP8.buffer,c,l).slice(),t._free(c);break;case"Int16Array":h=l*2,c=t._malloc(h),e.GetAttributeDataArrayForAllPoints(i,s,t.DT_INT16,h,c),d=new Int16Array(t.HEAP16.buffer,c,l).slice(),t._free(c);break;case"Int32Array":h=l*4,c=t._malloc(h),e.GetAttributeDataArrayForAllPoints(i,s,t.DT_INT32,h,c),d=new Int32Array(t.HEAP32.buffer,c,l).slice(),t._free(c);break;case"Uint8Array":c=t._malloc(l),e.GetAttributeDataArrayForAllPoints(i,s,t.DT_UINT8,l,c),d=new Uint8Array(t.HEAPU8.buffer,c,l).slice(),t._free(c);break;case"Uint16Array":h=l*2,c=t._malloc(h),e.GetAttributeDataArrayForAllPoints(i,s,t.DT_UINT16,h,c),d=new Uint16Array(t.HEAPU16.buffer,c,l).slice(),t._free(c);break;case"Uint32Array":h=l*4,c=t._malloc(h),e.GetAttributeDataArrayForAllPoints(i,s,t.DT_UINT32,h,c),d=new Uint32Array(t.HEAPU32.buffer,c,l).slice(),t._free(c);break;default:throw new Error("DRACOLoader: Unexpected attribute type.")}return{name:n,array:d,itemSize:r,componentType:o}}function Hk(t,e,i,n,s,o){let r,a;const l=e.GetEncodedGeometryType(i);if(l===t.TRIANGULAR_MESH)r=new t.Mesh,a=e.DecodeBufferToMesh(i,r);else throw new Error("DRACOLoader: Unexpected geometry type.");if(!a.ok()||r.ptr===0)throw new Error("DRACOLoader: Decoding failed: "+a.error_msg());const c={index:null,attributes:{}},d=r.num_points();for(const h in n){let u=Rb,f;for(const[_,g]of Object.entries(o))if(_===h){u=s.accessors[g].componentType,f=s.accessors[g].count;break}if(d!==f)throw new Error(`DRACOLoader: Accessor vertex count ${f} does not match draco decoder vertex count  ${d}`);u=jk(u);const m=e.GetAttributeByUniqueId(r,n[h]),p=Vk(t,e,r,h,m,u);c.attributes[p.name]=p}if(l===t.TRIANGULAR_MESH){const u=r.num_faces()*3,f=u*4,m=t._malloc(f);e.GetTrianglesUInt32Array(r,f,m);const p=new Uint32Array(t.HEAPU32.buffer,m,u).slice();t._free(m),c.index={array:p,itemSize:1}}return t.destroy(r),c}function Zk(t,e,i,n){const s=t.bufferView,o=e.bufferViews[s],r=e.buffers[o.buffer],l=new Int8Array(r.buffer).slice(o.byteOffset,o.byteOffset+o.byteLength),c=new i.Decoder,d=new i.DecoderBuffer;d.Init(l,o.byteLength);const h=Hk(i,c,d,t.attributes,e,n);return i.destroy(d),h}function Bs(t,e,i,n,s){const o={buffer:t,byteLength:t.byteLength,extensions:void 0,extras:void 0,name:void 0,uri:void 0};e.buffers.push(o);const r={buffer:e.buffers.length-1,byteLength:t.byteLength,byteOffset:0,byteStride:0,extensions:void 0,extras:void 0,name:s,target:n};e.bufferViews.push(r),e.accessors[i].byteOffset=0,e.accessors[i].bufferView=e.bufferViews.length-1}function co(t,e){let i;switch(e){case"Int8Array":i=new ArrayBuffer(t.length),new Int8Array(i).set(t);break;case"Uint8Array":i=new ArrayBuffer(t.length),new Uint8Array(i).set(t);break;case"Int16Array":i=new ArrayBuffer(t.length*2),new Int16Array(i).set(t);break;case"Uint16Array":i=new ArrayBuffer(t.length*2),new Uint16Array(i).set(t);break;case"Int32Array":i=new ArrayBuffer(t.length*4),new Int32Array(i).set(t);break;case"Uint32Array":i=new ArrayBuffer(t.length*4),new Uint32Array(i).set(t);break;default:case"Float32Array":i=new ArrayBuffer(t.length*4),new Float32Array(i).set(t);break}return i}function $k(t,e,i,n){const s=e.index.array;if(n!==void 0&&(Bs(s,t,n,34963,"index buffer view"),t.accessors[n].componentType=zb),e.attributes.POSITION!==void 0){const o=co(e.attributes.POSITION.array,e.attributes.POSITION.componentType);Bs(o,t,i.POSITION,34962,"position buffer view")}if(e.attributes.NORMAL!==void 0){const o=co(e.attributes.NORMAL.array,e.attributes.NORMAL.componentType);Bs(o,t,i.NORMAL,34962,"normal buffer view")}for(let o=0;o<kk;++o){const r=`TEXCOORD_${o}`;if(e.attributes[r]!==void 0){const a=co(e.attributes[r].array,e.attributes[r].componentType);Bs(a,t,i[r],34962,`${r} buffer view`)}}if(e.attributes.TANGENT!==void 0){const o=co(e.attributes.TANGENT.array,e.attributes.TANGENT.componentType);Bs(o,t,i.TANGENT,34962,"Tangent buffer view")}if(e.attributes.COLOR_0!==void 0){const o=co(e.attributes.COLOR_0.array,e.attributes.COLOR_0.componentType);Bs(o,t,i.COLOR_0,34962,"color buffer view")}if(e.attributes.JOINTS_0!==void 0){const o=co(e.attributes.JOINTS_0.array,e.attributes.JOINTS_0.componentType);Bs(o,t,i.JOINTS_0,34963,"JOINTS_0 buffer view")}if(e.attributes.WEIGHTS_0!==void 0){const o=co(e.attributes.WEIGHTS_0.array,e.attributes.WEIGHTS_0.componentType);Bs(o,t,i.WEIGHTS_0,34963,"WEIGHTS_0 buffer view")}if(e.attributes.JOINTS_1!==void 0){const o=co(e.attributes.JOINTS_1.array,e.attributes.JOINTS_1.componentType);Bs(o,t,i.JOINTS_1,34963,"JOINTS_1 buffer view")}if(e.attributes.WEIGHTS_1!==void 0){const o=co(e.attributes.WEIGHTS_1.array,e.attributes.WEIGHTS_1.componentType);Bs(o,t,i.WEIGHTS_1,34963,"WEIGHTS_1 buffer view")}}async function Wk(t,e){var i;if(!Array.isArray(t.meshes))return Promise.resolve();for(const n of t.meshes)if(Array.isArray(n.primitives))for(const s of n.primitives){if(((i=s.extensions)==null?void 0:i.KHR_draco_mesh_compression)===void 0)continue;Ym||Nk(e);const o=await Ym;if(!o)continue;const r=Zk(s.extensions.KHR_draco_mesh_compression,t,o,s.attributes);$k(t,r,s.attributes,s.indices)}}async function qm(t){const e=await self.fetch(t);if(!e.ok)throw new Error(`${e.status} ${e.statusText}: ${e.url}`);return e}const Km={asset:{version:""}};async function Xk(t,e){if(e){t.buffers[0].buffer=e[0]||[];return}await Promise.all(t.buffers.map(async i=>{if(i.buffer){console.error("Buffer is already loaded");return}if(!i.uri){console.error("Buffer can not be loaded. No uri");return}if(i.uri.startsWith("data:"))i.buffer=Cb(i.uri);else{const n=Qs(i.uri)?i.uri:Lb(t.path)+i.uri,s=await qm(n).then(o=>o.arrayBuffer());i.buffer=s}}))}async function Yk(t,e,i){if(!e.bufferView)return!1;const n=t.bufferViews[e.bufferView];if(n===void 0)return!1;await i;const s=t.buffers[n.buffer].buffer;if(!s)return!1;const o=new Uint8Array(s,n.byteOffset,n.byteLength);if(typeof createImageBitmap<"u")if(Qk(o)){const r=new Blob([o],{type:e.mimeType});e.image=await createImageBitmap(r)}else return console.error(`Unsupported image type ${e.mimeType??""}`),!1;else return!1;return!0}async function qk(t,e){if(e.uri===void 0)return!1;const i=e.mimeType||Rk(e.uri);if(e.mimeType=i,typeof createImageBitmap<"u"&&(i===Kl.JPEG||i===Kl.PNG))if(e.uri.startsWith("data:image")){const n=Cb(e.uri);e.image=await createImageBitmap(new Blob([n],{type:i}))}else{const n=Qs(e.uri)?e.uri:`${Lb(t.path)}${e.uri}`,o=await(await qm(n)).arrayBuffer();e.image=await createImageBitmap(new Blob([o],{type:i}))}else return console.error(`Unsupported image type ${i}`),!1;return!0}async function Kk(t,e){await Promise.all(t.images.map(async i=>{if(i.image){i.mimeType!==Kl.GLTEXTURE&&console.error("Image has already been loaded");return}await Yk(t,i,e)||await qk(t,i)||console.error(`Was not able to resolve image with uri ${i.uri}`)}))}async function Jk(t,e){const i=hS(t,self.origin);try{const n=await qm(i);let s=Km,o;try{const r=await n.arrayBuffer();if(Ch.isGlb(r)){const u=new Ch(r).extractGlbData();s=u.json,o=u.buffers}else{const h=new TextDecoder("utf-8"),u=new Uint8Array(r);s=JSON.parse(h.decode(u))}const a=gk(s,i),l=Xk(a,o),c=Kk(a,l),d=Wk(a,e);return await Promise.all([l,c,d]),{type:"ok",result:a}}catch(r){return{type:"error",layer:"parsing",originalError:r}}}catch(n){return{type:"error",layer:"network",originalError:n}}}function Qk(t){const e=t[0]===137&&t[1]===80&&t[2]===78&&t[3]===71&&t[4]===13&&t[5]===10&&t[6]===26&&t[7]===10,i=t[0]===255&&t[1]===216&&t[2]===255;return e||i}class eN{async loadModel(e,i){return await Jk(e,i)}}function tN(t){return new Worker(""+(typeof document>"u"&&typeof location>"u"?require("url").pathToFileURL(__dirname+"/assets/index-u9DjJkrT.js").href:new URL("assets/index-u9DjJkrT.js",typeof document>"u"?location.href:document.currentScript&&document.currentScript.tagName.toUpperCase()==="SCRIPT"&&document.currentScript.src||document.baseURI).href),{name:t==null?void 0:t.name})}function iN(t){return new Worker(""+(typeof document>"u"&&typeof location>"u"?require("url").pathToFileURL(__dirname+"/assets/index-kCfosY-K.js").href:new URL("assets/index-kCfosY-K.js",typeof document>"u"?location.href:document.currentScript&&document.currentScript.tagName.toUpperCase()==="SCRIPT"&&document.currentScript.src||document.baseURI).href),{name:t==null?void 0:t.name})}function nN(t){return new Worker(""+(typeof document>"u"&&typeof location>"u"?require("url").pathToFileURL(__dirname+"/assets/index-Bi9Dq8mW.js").href:new URL("assets/index-Bi9Dq8mW.js",typeof document>"u"?location.href:document.currentScript&&document.currentScript.tagName.toUpperCase()==="SCRIPT"&&document.currentScript.src||document.baseURI).href),{name:t==null?void 0:t.name})}function sN(t,e){return{setMetatile:t.get(Ue.Parser,"setMetatile"),getMemoryFootprint:t.get(Ue.Parser,"getMemoryFootprint"),prepareAtlas:t.get(Ue.Parser,"prepareAtlas"),packRasters:t.get(Ue.Parser,"packRasters"),fetchTrafficTile:t.get(Ue.Parser,"fetchTrafficTile"),deleteTrafficTile:t.get(Ue.Parser,"deleteTrafficTile"),abortTrafficTileRequest:t.get(Ue.Parser,"abortTrafficTileRequest"),generateTrafficTile:t.get(Ue.Parser,"generateTrafficTile"),generatePersonalPoi:t.get(Ue.Parser,"generatePersonalPoi"),syncStyle:t.get(Ue.Parser,"syncStyle"),GeoJsonSource:e.set("GeoJsonSource",pk).get(Ue.Parser),ZenithSource:e.set("ZenithWorker",vP).get(Ue.Parser)}}function oN(t){return{setCommercialPoiRandomSeed:t.get(Ue.Labeling,"setComPoiRandomSeed"),getMemoryFootprint:t.get(Ue.Labeling,"getMemoryFootprint"),appendFont:t.get(Ue.Labeling,"appendFont"),markFontAsLoaded:t.get(Ue.Labeling,"markFontAsLoaded"),addNewRasterSets:t.get(Ue.Labeling,"addNewRasterSets"),updatePackingInfo:t.get(Ue.Labeling,"updatePackingInfo"),syncStyle:t.get(Ue.Labeling,"syncStyle"),loadRtlPlugin:t.get(Ue.Labeling,"loadRtlPlugin"),markRtlPluginLoaded:t.get(Ue.Labeling,"markRtlPluginLoaded")}}function rN(t){return{ModelsSource:t.set("ModelsWorker",eN).get(Ue.Models)}}class aN{constructor(){this.connector=new GB,this.fnRegistry=new jB(this.connector),this.classRegistry=new VB(this.fnRegistry),this.parserWorker=new tN,this.connector.addWorker(Ue.Parser,this.parserWorker),this.labelingWorker=new iN,this.connector.addWorker(Ue.Labeling,this.labelingWorker),this.modelsWorker=new nN,this.connector.addWorker(Ue.Models,this.modelsWorker),this.parser=sN(this.fnRegistry,this.classRegistry),this.labeling=oN(this.fnRegistry),this.models=rN(this.classRegistry)}syncStyle(e){this.parser.syncStyle(e),this.labeling.syncStyle(e)}destroy(){this.parserWorker.terminate(),this.labelingWorker.terminate(),this.modelsWorker.terminate()}}let Jl=(Cr=class extends Qo{constructor(e,i){super(),this.fogFactorBreakpoint=.4,this.demElevation=0,this.demTilesRevision=NaN,this.options=Cn(i,Cr.options),this.uniqId=String(Vn()),this.labelKey=`html-${this.uniqId}`;const n=Z.fromGeo(this.options.coordinates);this.position={userValue:n,normalizedValue:Li(n)},this.screenPoint=[0,0],this.html=lN(this.options),this.isHidden=!0,this.targetOpacity=0,this.modules=e.modules,this.modules.layers.addLayer(this),this.mapState=e.state,this.rounder=cN(!this.options.disableRounding);let{offset:s}=this.options;const{labeling:o}=this.options;o.type!=="none"&&(o.offset!==void 0&&(s=o.offset),this.modules.labeler.addLabelBox(this.labelKey,{id:this.uniqId,width:o.width,height:o.height,position:this.position.normalizedValue,offset:s,labelingGroup:this.getLabelingGroup(),parentPoiId:o.type==="pinnedToPoi"?o.poiId:void 0}))}destroy(){this.removeHtml(),this.modules.labeler.removeLabels(this.labelKey),this.modules.layers.removeLayer(this)}update(){const e=this.checkZoom(),i=this.checkFog(),n=!this.isInvolvedInLabeling()||this.modules.labeler.isLabelBoxSurvived(this.uniqId);e&&i&&n?this.show():this.hide(),this.updatePosition()}setZIndex(e){this.options.zIndex=e,this.html.style.zIndex=String(e)}setContent(e){this.options.html=e,this.html.innerHTML="";const i=document.createElement("div");typeof e=="string"?i.innerHTML=e:i.append(e),this.html.append(i)}setLabelingSize(e,i){this.options.labeling.type!=="none"&&(this.options.labeling.width=e,this.options.labeling.height=i,this.updateLabelBox())}setPosition(e){const i=Z.fromGeo(e);this.position={userValue:i,normalizedValue:Li(i)},this.updateLabelBox()}setOffset(e){this.options.offset=[e[0],e[1]],this.updateLabelBox()}setMinZoom(e){this.options.minZoom=e}setMaxZoom(e){this.options.maxZoom=e}getZIndex(){return this.options.zIndex}getOffset(){return this.options.offset}getPosition(){return Z.toGeo(this.position.userValue)}getHtmlElement(){return this.html.firstChild}dangerouslyGetRootElement(){return this.html}isShown(){return!this.isHidden}show(){if(this.isHidden&&(this.isHidden=!1,this.appendHtml(),this.emit("shown",{id:this.uniqId.toString(),point:[this.screenPoint[0],this.screenPoint[1]],object:this}),this.options.animate)){if(this.showAnimationTimer)return;this.hideAnimationTimer&&(clearTimeout(this.hideAnimationTimer),this.hideAnimationTimer=void 0),this.targetOpacity!==1&&(this.showAnimationTimer=window.setTimeout(()=>{this.setHtmlOpacity(1),this.showAnimationTimer=void 0},0))}}hide(){if(!this.isHidden)if(this.isHidden=!0,this.options.animate){if(this.hideAnimationTimer)return;this.showAnimationTimer&&(clearTimeout(this.showAnimationTimer),this.showAnimationTimer=void 0),this.setHtmlOpacity(0),this.hideAnimationTimer=window.setTimeout(()=>{this.removeHtml(),this.hideAnimationTimer=void 0},this.options.duration)}else this.removeHtml()}setHtmlOpacity(e){this.html.style.opacity=String(e),this.targetOpacity=e}removeHtml(){this.html.remove(),this.screenPoint=[0,0]}appendHtml(){this.getMarkerContainer().appendChild(this.html)}getMarkerContainer(){return this.options.preventMapInteractions?this.modules.layout.htmlContainerOutMap:this.modules.layout.htmlContainerInMap}nearCenterScreenPosition(){const e=this.modules.demManager,i=this.mapState;let n=0;if(i.demMode){const a=e.getTilesRevision();this.demTilesRevision!==a&&(this.demElevation=e.getElevation(this.position.normalizedValue)??0,this.demTilesRevision=a),n=(this.demElevation-(i.elevation??0))*i.elevationScale}const s=this.mapState.visibleMapReplicas.map(a=>{const l=[this.position.normalizedValue[0]+4294967296*a,this.position.normalizedValue[1],this.position.normalizedValue[2]+n*Ge];return Z.toGeo(l,l),this.modules.camera.project(l,!0)}),o=s.map(a=>Math.abs(this.mapState.size[0]/2-(isNaN(a[0])?-1/0:a[0]))),r=o.findIndex(a=>a===Math.min(...o));return s[r]}updatePosition(){const e=this.nearCenterScreenPosition();this.html.hidden=Number.isNaN(e[0]),this.rounder(e,e[0]+this.options.offset[0],e[1]+this.options.offset[1],this.mapState.stillness),this.mapState.globeMode&&(this.html.hidden=!this.modules.camera.ecef.canSee(this.getPosition())),P2(this.screenPoint,e)||(this.html.style.transform=`translate3d(${e[0]}px, ${e[1]}px, 0px)`,this.screenPoint=e)}updateLabelBox(){if(this.options.labeling.type==="none")return;const{labeling:{width:e,height:i},offset:n}=this.options;this.modules.labeler.removeLabels(this.labelKey),this.modules.labeler.addLabelBox(this.labelKey,{id:this.uniqId,width:e,height:i,position:this.position.normalizedValue,offset:n,labelingGroup:this.getLabelingGroup(),parentPoiId:this.options.labeling.type==="pinnedToPoi"?this.options.labeling.poiId:void 0})}getLabelingGroup(){return this.isInvolvedInLabeling()?"markerText":"htmlLabel"}checkZoom(){const{zoom:e}=this.mapState,{minZoom:i,maxZoom:n}=this.options;return e>=i&&e<n}checkFog(){if(!this.modules.environmentManager.isFogEnabled()||this.mapState.globeMode)return!0;const{fogLimits:e}=this.modules.environmentManager,{fogDistance:i,position:n}=this.modules.camera,s=(this.position.normalizedValue[0]-n[0])/i,o=(this.position.normalizedValue[1]-n[1])/i,r=Math.sqrt(s**2+o**2),a=e[1]-e[0];return Be((r-e[0])/a,0,1)<this.fogFactorBreakpoint}isInvolvedInLabeling(){return this.options.labeling.type==="full"||this.options.labeling.type==="pinnedToPoi"}},Cr.options={coordinates:[0,0],html:"",offset:[0,0],animate:!0,duration:500,labeling:{type:"none"},interactive:!0,preventMapInteractions:!1,zIndex:0,minZoom:-1/0,maxZoom:1/0,disableRounding:!1},Cr);function lN(t){const e=document.createElement("div");e.style.position="absolute",e.style.top="0",e.style.left="0",e.style.zIndex=String(t.zIndex),t.interactive||(e.style.pointerEvents="none"),t.animate&&(e.style.opacity="0",e.style.transition=`opacity ${t.duration}ms`,e.style.willChange="opacity");const i=document.createElement("div");return typeof t.html=="string"?i.innerHTML=t.html:i.append(t.html),e.append(i),e}function cN(t){return t?dN:hN}const dN=(t,e,i,n)=>{const s=Math.round(e),o=Math.round(i),r=s-e,a=o-i;t[0]=e+n*r,t[1]=i+n*a},hN=(t,e,i)=>{t[0]=e,t[1]=i},uN="#0085a0",fN="#ffffff",_N=4,mN=1,pN=2,gN=1.5,vN=2.8,Fb=6,yN=!0,wN=17.1,Jm=Dr.iterationCount,Qm=Oe();class Db extends Zi{constructor(e,i){super(e,{interactive:!1}),this.options=i,this.vectors=this.options.coordinates.map(p=>p.map(_=>Z.fromGeo(_))),this.bouncePosition=0,this.growPosition=1;const{tileManager:n,dynamicStyle:s,collector:o,layers:r}=this.modules,a=this.options.animate??yN;let l;if(a){const p=this.options.iterationCount??Jm;p>1?l={type:"repeat",tipMovementAmplitude:this.options.tipMovementAmplitude||Fb,iterationCount:p}:p===1&&(l={type:"appearance",tipMovementAmplitude:this.options.tipMovementAmplitude||Fb})}const c=_t({type:"arrow",id:`dynamic-entrance-${this.uniqId}`,minzoom:this.options.minZoom??wN,maxzoom:this.options.maxZoom,style:{color:this.options.color??uN,strokeColor:this.options.borderColor??fN,lineWidth:this.options.width??_N,strokeWidth:this.options.borderWidth??mN,tipWidth:this.options.wingWidthMultiplier??gN,tipHeight:this.options.tipHeightMultiplier??vN,roundingRadius:this.options.roundingRadius??pN,animation:l}});if(!c)return;s.addLayer(c,this.options.zIndex),this.layerId=c.innerId;const d=this.getTileInfo(),h=[],u=di(this.mapState.styleState,un,yi,h,Hi);Zt(c,u);for(let p=0;p<this.vectors.length;p++){const _=this.vectors[p],g=this.getVertices(_,d);u.id=String(p),vt({collector:o,generator:_l.generate,args:[s.getStyle().id,c,u,g]})}const f=o.getAccumulatedData(),m=new Ct("dynamicObject",f.data,this.modules,this.mapState,d.coords,this);this.tileObjects.push(m),n.addObject(m),this.identifyIds.push(f.identifyIds),a?(this.bounceTickerId=`entrance-bounce-${this.uniqId}`,this.growTickerId=`entrance-grow-${this.uniqId}`,this.bounceTickerUpdate=kt.bind(null,this.bounceTickerId,{step:(p,_)=>this.bouncePosition=_,complete:()=>{this.bounceTickerUpdate=void 0}},this.mapState),this.growTickerUpdate=kt.bind(null,this.growTickerId,{step:(p,_)=>this.growPosition=_,complete:()=>{this.growTickerUpdate=void 0}},this.mapState),Bt(this.bounceTickerId,{easing:Dr.bounceType},this.mapState,-1,0,Dr.bounceTime,this.options.iterationCount??Jm,{layerId:this.layerId,styleId:s.getStyle().id}),Bt(this.growTickerId,{easing:Dr.growType},this.mapState,0,1,Dr.growTime,this.options.iterationCount??Jm,{layerId:this.layerId,styleId:s.getStyle().id})):(this.bouncePosition=0,this.growPosition=1),r.addLayer(this),o.reset(),this.modules.renderer.addRerenderEvent()}update(){super.update(),this.bounceTickerUpdate&&this.bounceTickerUpdate(),this.growTickerUpdate&&this.growTickerUpdate()}isOutOfMainReplica(){return!1}entranceAnimationInProgress(){return this.bounceTickerUpdate!==void 0||this.growTickerUpdate!==void 0}remove(){this.layerId!==void 0&&this.modules.dynamicStyle.removeLayer(this.layerId),this.destroy()}destroy(){this.bounceTickerUpdate=void 0,this.growTickerUpdate=void 0,this.bounceTickerId&&yt(this.bounceTickerId,this.mapState),this.growTickerId&&yt(this.growTickerId,this.mapState),super.destroy()}getTileInfo(){const e=ji();for(let i=0;i<this.vectors.length;i++){const n=this.vectors[i];for(let s=0;s<n.length;s++)Vi(e,n[s])}return Ye(ir(e))}getVertices(e,i){const n=[],s=[];for(let o=0;o<e.length;o++)Pt(Qm,e[o],i),n[o]=Qm[0],s[o]=Qm[1];return{x:n,y:s}}}class bN{constructor(e){this.layers=[],this.renderer=e.renderer}addLayer(e){this.layers.push(e),this.renderer.addRerenderEvent()}removeLayer(e){const i=this.layers.indexOf(e);i!==-1&&(this.layers.splice(i,1),this.renderer.addRerenderEvent())}getLayers(){return this.layers}getDynamicObjectLayers(){return this.layers.filter(e=>e instanceof Zi)}getHtmlMarkers(){return this.layers.filter(e=>e instanceof Jl)}entranceAnimationFinished(){return this.layers.every(e=>e instanceof Db?!e.entranceAnimationInProgress():!0)}}const Ob=()=>"",xN=[.5,.5];class SN{constructor(e){this.loadingCounter=0,this.isIdle=()=>this.loadingCounter===0,this.modules=e,this.cache={}}async getRasterSet(e,i,n,s){const o=this.getKey(e,n,s),r=this.getFromCache(o,i);if(r)return r;const a=await this.loadIcon(e,i,n,s);return a&&this.storeInCache(a,o,i),a}decreaseLoadingCounter(){this.loadingCounter=Math.max(this.loadingCounter-1,0)}async loadIcon(e,i,n,s){const{dynamicStyle:o,workers:r,assetManager:a}=this.modules;let l=e;this.loadingCounter++,i&&(l=await this.loadImageForTransformer(e).then(d=>i(d)).catch(()=>e));const c=await this.loadImage(l);return c?Promise.resolve().then(()=>{n=n!==void 0?n:[c.width,c.height];const d=s!==void 0?[s[0]/n[0],s[1]/n[1]]:xN,h=[n[0]*window.devicePixelRatio,n[1]*window.devicePixelRatio],u=NT([{w:h[0],h:h[1],x:0,y:0,atlasIndex:0,isPacked:!1,anchorX:d[0],anchorY:d[1]}]);o.appendRasterSet(u),r.labeling.addNewRasterSets(o.getStyle().id,[u]);const f=new Uint16Array(3);return f[0]=h[0],f[1]=h[1],f[2]=u.index,r.parser.packRasters(f).then(m=>({packedRasters:m.packedRasters,rasterSet:u,scaledSize:h}))}).then(d=>{const{packedRasters:h,rasterSet:u,scaledSize:f}=d;return h!==void 0&&a.prepareRasters(o.getStyle().id,h,[Bw(c,f)]),this.decreaseLoadingCounter(),u}):(this.decreaseLoadingCounter(),Promise.resolve(void 0))}getFromCache(e,i){const n=this.cache[e];if(n)return n.get(i||Ob)}storeInCache(e,i,n){this.cache[i]||(this.cache[i]=new Map),this.cache[i].set(n||Ob,e)}getKey(e,i,n){const s=i!==void 0?`${i[0]},${i[1]}`:"",o=n!==void 0?`${n[0]},${n[1]}`:"";return`${e}_${s}_${o}`}loadImage(e){return new Promise(i=>{const n=new Image;n.crossOrigin="Anonymous",n.src=e,n.onload=()=>i(n),n.onerror=()=>i(void 0)})}loadImageForTransformer(e){return e.indexOf(".svg")===-1?new Promise(i=>{const n=new Image;n.crossOrigin="Anonymous",n.src=e,n.onload=()=>{i({type:"raster",source:n})},n.onerror=()=>{i({type:"unknown"})}}):new Promise(i=>{const n=new XMLHttpRequest;n.open("GET",e,!0),n.onload=function(){if(n.status!==200||n.response.byteLength===0){i({type:"unknown"});return}i({type:"vector",source:n.response})},n.onerror=function(){i({type:"unknown"})},n.send()})}}const Bb={trafficOn:!1,parkingOn:!1,navigatorOn:!1,immersiveRoadsOn:!1,_floorStackOn:!1,terrainEnabled:!1,graphicsPreset:th()?"light":"immersive",_activeFloorIds:[],_activeFloorBuildingIds:[],_activeFloorIsMetro:!1,_floorHeight:3.5,_customUserTimeOffset:0};let Oo=!1;function MN(){return{...Bb}}function Rh(t,e){return t={...t},(e==null?void 0:e.immersiveRoadsOff)===!0?(Oo=!0,t.immersiveRoadsOn=!1):Oo&&(t.immersiveRoadsOn=Oo,Oo=!1),{...Bb,...t}}function ep(t,e,i){return e={...e},(i==null?void 0:i.immersiveRoadsOff)===!0?(Oo=!0,e.immersiveRoadsOn=!1):Oo&&(e.immersiveRoadsOn=Oo,Oo=!1),{...t,...e,_activeFloorIds:t._activeFloorIds,_activeFloorBuildingIds:t._activeFloorBuildingIds,_activeFloorIsMetro:t._activeFloorIsMetro,_floorHeight:t._floorHeight}}function kb(t,e=[],i=[],n=!1){return{...t,_activeFloorIds:e,_activeFloorBuildingIds:i,_activeFloorIsMetro:n}}const tp="floorStackTicker";class IN{constructor(e,i){this.floorLevelOffsets=new Map,this.activeFloorIds=new Set,this.activeDescriptors=[],this.stackAnimationReadiness=0,this.activeGroup="default",this.state=e,this.modules=i,this.complexDescriptors={default:new Map,metro:new Map},this.allowedFloors=new Set,this.floorIdsToObjectIds=new Map,this.requestedFloors=new Set,this.failedRequestedFloors=new Set,this.needUpdate=!1,this.ids=i.identifier.getIdScope(mn),this.floorIds=i.identifier.getIdScope(Xf),this.hiddenObjectIds=new Set,this.stateDiffer=new Et([{path:"center",type:"vec2"},{path:"zoom",type:"number"},{path:"size",type:"vec2"},{path:"rotation",type:"number"},{path:"pitch",type:"number"},{path:"padding",type:"padding"},{path:"demMode",type:"boolean"},{path:"floorsEnabled",type:"boolean"}])}get maxFloorOffset(){const e=this.state.styleState._floorHeight??0;return Math.floor(jo.maxStackHeight/e)}get floorHeight(){const e=this.state.styleState._floorHeight??0,i=Z.toGeo(this.state.center);return e*Ge*Z.scaleFactor(i[1])}get isStackEnabled(){return this.state.styleState._floorStackOn&&this.activeGroup==="default"&&this.floorHeight>0}update(){if(this.stateDiffer.check(this.state)||this.needUpdate){this.needUpdate=!1;const e=this.findActiveFloor();if(!yu(e,this.activeFloorIds)){for(const i of this.activeFloorIds.values())this.modules.map.emit("floorcomplexhide",{id:i});this.activeFloorIds.clear(),this.activeDescriptors=[];for(const i of e.values()){const n=this.complexDescriptors[this.activeGroup].get(i);if(n&&this.state.floorsEnabled){const{id:s,defaultFloor:o,floors:r}=n;this.setFloorIdx(o),this.activeDescriptors.push(n),this.modules.map.emit("floorcomplexshow",{id:s,currentFloor:o,floorNames:r.map(({name:a})=>a),firmsToFloorIndexMap:n.firmsToFloorIndexMap})}this.activeFloorIds.add(i)}this.floorLevelOffsets.clear(),this.activeDescriptors.forEach(i=>{i.floors.forEach((n,s)=>{const o=s-i.defaultFloor;n.ids.forEach(r=>{this.floorLevelOffsets.set(r,o)})})})}}this.updateStyleState(),this.updateHiddenIds(),this.updateReadiness()}getActiveFloorHiddenIds(){return Array.from(this.hiddenObjectIds)}prepareFloors(e,i,n,s){s==="zenith"&&n.forEach((o,r)=>{let a=this.floorIdsToObjectIds.get(r);a===void 0&&(a=new Set,this.floorIdsToObjectIds.set(r,a));for(const l of o)a.add(l);this.loadFloor(r,e,i)})}changeFloorNumber(e,i){const n=this.complexDescriptors[this.activeGroup].get(e);n&&(this.setFloorIdx(i),this.modules.map.emit("floorcomplexlevelchange",{id:e,floorIndex:i,floorName:n.floors[i].name}),this.needUpdate=!0)}hasDisplayedFloorBuilding(e){if(this.activeFloorIds.size===0)return!1;if(e.some(i=>this.activeFloorIds.has(i)))return!0;for(const i of this.activeFloorIds.values()){const n=this.complexDescriptors[this.activeGroup].get(i);for(let s=0;s<n.buildings.length;s++){const o=this.floorIdsToObjectIds.get(n.buildings[s]);if(o&&(Array.isArray(e)&&e.some(r=>o.has(r))||typeof e=="string"&&o.has(e)))return!0}}return!1}floorsReady(){return Array.from(this.requestedFloors).every(e=>this.failedRequestedFloors.has(e)||this.complexDescriptors.default.has(e)||this.complexDescriptors.metro.has(e))}configure(e){this.activeGroup=e.activeGroup,this.allowedFloors=new Set(e.allowedFloorIds??[]),this.needUpdate=!0,this.modules.map.emit("floorsactivegroupchange",this.activeGroup)}isVisibleFloorObject(e){return this.activeDescriptors.length===0?!1:this.state.styleState._activeFloorIds.includes(e)}isVisibleFloorStackObject(e){if(!this.isStackEnabled||this.activeDescriptors.length===0||this.activeFloorIdx===void 0)return!1;const i=this.activeFloorIdx-this.activeDescriptors[0].defaultFloor,n=this.floorLevelOffsets.get(e);return n<this.maxFloorOffset&&i>0&&n>=0&&n<i}getFloorObjectElevation(e){if(!this.isStackEnabled||!this.floorLevelOffsets.has(e))return 0;const i=this.floorLevelOffsets.get(e),n=this.floorHeight*i;return i<=0?0:i>this.maxFloorOffset?this.floorHeight*this.maxFloorOffset:$r((i-1)/i,1,this.stackAnimationReadiness)*n}getFloorStackObjectElevation(e){return this.floorLevelOffsets.has(e)?this.floorLevelOffsets.get(e)*this.floorHeight:0}getFloorStackObjectHeight(e){return!this.isStackEnabled||this.activeDescriptors[0].floors.findIndex(s=>s.ids.includes(e))<this.activeFloorIdx-1?1:this.stackAnimationReadiness}loadFloor(e,i,n){if(this.requestedFloors.has(e))return;const s=gs("floorMeta",{protocol:this.state.tileProtocol,tileSet:this.state.tileSet,host:this.state.tileServer,subdomain:this.state.subdomains[0],regionId:i.toString(10),floorComplexId:e});this.requestedFloors.add(e),fetch(s).then(o=>(o.ok===!1&&this.failedRequestedFloors.add(e),o.json())).then(o=>{let r=o.default_floor_idx,a="default";"is_metro"in o&&o.is_metro&&(r=o.default_metro_floor_idx,a="metro");const l=o.floors.reduce((c,d,h)=>(c[d.id]=h,c),{});this.complexDescriptors[a].set(e,{id:e,regionId:i,metatileHash:n,center:o.center,bound:o.bound,defaultFloor:r,floors:o.floors.map(c=>({ids:c.linked_floors_ids?[c.id,...c.linked_floors_ids]:[c.id],name:c.name})),buildings:o.linked_buildings_ids?o.linked_buildings_ids.concat(e):[e],firmsToFloorIndexMap:Object.entries(o.firm_id_to_floor_id??{}).reduce((c,[d,h])=>(c[d]=l[h],c),{})}),this.needUpdate=!0}).catch(()=>{this.failedRequestedFloors.add(e)})}updateStyleState(){const{styleState:e}=this.state;if(this.activeFloorIds.size===0){(e._activeFloorIds||e._activeFloorBuildingIds)&&(this.state.styleState=kb(e,[],[],!1));return}const i=new Set,n=new Set;for(const s of this.activeFloorIds.values()){const o=this.complexDescriptors[this.activeGroup].get(s);if(!o||this.activeFloorIdx===void 0)continue;const r=o.floors[this.activeFloorIdx];r&&(r.ids.forEach(a=>{i.add(a)}),o.buildings.forEach(a=>n.add(a)))}this.state.styleState=kb(e,Array.from(i),Array.from(n),this.activeGroup==="metro")}updateHiddenIds(){if(this.activeFloorIds.size===0){this.markHiddenObjectsForUpdate();return}const e=new Set;for(const i of this.activeFloorIds.values()){const n=this.complexDescriptors[this.activeGroup].get(i);if(n&&this.activeFloorIdx!==void 0)for(let s=0;s<n.buildings.length;s++){const o=this.floorIdsToObjectIds.get(n.buildings[s]);o&&o.forEach(r=>e.add(r))}}this.markHiddenObjectsForUpdate(e)}markHiddenObjectsForUpdate(e){if(e){const i=this.ids.getHidden(Qi.PolygonExtrusion),n=Cy(e,i),s=Cy(this.hiddenObjectIds,e);this.ids.hide(Array.from(n),Qi.PolygonExtrusion);const o=this.floorIds.getHidden(),r=QE(n,o);this.ids.hide(Array.from(r),Qi.All),this.ids.show(Array.from(s)),this.hiddenObjectIds=new Set(e)}else this.ids.show(Array.from(this.hiddenObjectIds)),this.hiddenObjectIds.clear()}updateReadiness(){kt(tp,{step:(e,i)=>this.stackAnimationReadiness=i},this.state)}setFloorIdx(e){this.prevActiveFloorIdx=this.activeFloorIdx,this.activeFloorIdx=e,this.isStackEnabled&&this.prevActiveFloorIdx!==void 0&&this.activeFloorIdx>this.prevActiveFloorIdx?(this.stackAnimationReadiness=0,Bt(tp,{easing:"easeOutQuint"},this.state,0,1,500,1)):(this.stackAnimationReadiness=1,yt(tp,this.state))}findActiveFloor(){const e=new Set;if(!this.state.floorsEnabled||this.state.styleZoom<jo.displayStyleZoom)return e;const{center:i,zoom:n,rotation:s,size:o,pitch:r,viewport:a,padding:l,cameraConfig:c,globeMode:d}=this.state;if(this.activeGroup==="metro")if(this.allowedFloors.size>0)this.allowedFloors.forEach(p=>e.add(p));else{for(const p of this.complexDescriptors.metro.keys())e.add(p);return e}const u=new hn({center:i,zoom:n,rotation:s,size:[Math.floor(o[0]*(1-jo.viewportPadding)),Math.floor(o[1]*(1-jo.viewportPadding))],styleState:{},pitch:r,viewport:a,padding:l,cameraConfig:c,globeMode:d}).getViewportVertices();if(this.allowedFloors.size>0){const p=this.complexDescriptors[this.activeGroup];let _;return this.allowedFloors.forEach(g=>{const y=p.get(g);y&&tr(u,y.bound)&&(_=g)}),_&&e.add(_),e}let f=1/0,m;return this.complexDescriptors.default.forEach(p=>{const _=Un(this.state.center,p.center);_<f&&tr(u,p.bound)&&(f=_,m=p)}),m&&e.add(m.id),e}}class TN{constructor(e,i){this.state=e,this.modules=i,this.tileLayers=[],this.objects=[],this.viewportDiffer=new Et([{path:"center",type:"vec3"},{path:"zoom",type:"number"},{path:"size",type:"vec2"},{path:"rotation",type:"number"},{path:"pitch",type:"number"},{path:"padding",type:"padding"},{path:"demMode",type:"boolean"},{path:"globeMode",type:"boolean"},{path:"elevation",type:"number"},{path:"minElevation",type:"number"},{path:"handyStyleId",type:"string"}])}getMemoryFootprint(e=()=>!0){const i={tileLayers:this.tileLayers.filter(e).map(s=>({[s.getSourceType()]:s.memSizeJs()})),objects:this.objects.filter(s=>s.purpose==="dynamicObject").map(s=>({[s.purpose]:n0(s)}))},n={tileLayers:this.tileLayers.filter(e).map(s=>({[s.getSourceType()]:s.memSizeGpu()})),objects:this.objects.filter(s=>s.purpose==="dynamicObject").map(s=>({[s.purpose]:o_(s)}))};return{js:{...i,"--sum":ui(i)},gpu:{...n,"--sum":ui(n)}}}addTileLayer(e){this.tileLayers.indexOf(e)===-1&&(this.tileLayers.push(e),e.redraw(),this.modules.identifier.resetCache(),this.state.needLabeling=!0,this.modules.renderer.addRerenderEvent())}removeTileLayer(e){vo(this.tileLayers,e)&&(e.resetHoverId(),this.modules.identifier.resetCache(),this.state.needLabeling=!0,this.modules.renderer.addRerenderEvent())}redraw(){this.modules.labeler.clearPreviousLabels();for(const e of this.tileLayers)e.resetHoverId(),e.redraw();this.modules.renderer.addRerenderEvent()}activateStyleUpdating(){this.tileLayers.forEach(e=>e.activateStyleUpdating())}finishStyleUpdating(){this.tileLayers.forEach(e=>e.finishStyleUpdating())}getViewportTiles(){const e=[];for(const i of this.tileLayers)e.push(...i.getViewportTiles());return e}viewportTilesReady(){return this.tileLayers.every(e=>e.viewportTilesReady())}displayedTilesAnimationFinished(){return this.tileLayers.every(e=>e.displayedTilesAnimationFinished())}getDisplayedIdentifyData(){const e=[];for(const i of this.tileLayers)e.push(...i.getDisplayedIdentifyData());return e}getLabelingData(){return this.tileLayers.map(e=>e.getLabelingData())}isIdle(){return this.viewportTilesReady()&&this.displayedTilesAnimationFinished()}update(){const e=this.state;this.viewportDiffer.check(e)&&(this.tileLayers.forEach(i=>i.updateViewport()),this.modules.map.emit("viewportchange"));for(const i of this.tileLayers)i.update();if(this.updateTickers(),e.collectStats){this.state.stats.tileCount=0;for(const i of this.tileLayers)this.state.stats.tileCount+=i.getTileCount();this.state.stats.globeTileCount=this.objects.filter(i=>i.purpose==="globe").length,this.state.stats.dynamicTileCount=this.objects.filter(i=>i.purpose==="dynamicObject"||i.purpose==="floor").length}}getTileObjects(){return this.objects}addObject(e,i){if(this.objects.indexOf(e)===-1){if(this.objects.push(e),i)return;this.modules.renderer.addRerenderEvent()}}removeObject(e,i){if(vo(this.objects,e)){if(i)return;this.modules.renderer.addRerenderEvent()}}getCachedMods(){const e=[];for(const i of this.tileLayers){const n=i.gridState.tileModsCache.getData();for(const s of n)e.push(s)}return e}destroy(){for(const e of this.tileLayers)e.destroy();this.objects.forEach(e=>e.clean(this.state))}updateTickers(){this.objects.forEach(e=>e.updateTicker(this.state))}}const EN=(t,e,i,n,s)=>{Bt("labelingOpacity",{easing:e},t,i,n,s,1)},AN=kt.bind(null,"labelingOpacity",{step:(t,e)=>t.labelingOpacity=e});function PN(t){return t?Object.keys(t).map(Number).sort((e,i)=>e-i):[]}function LN(t,e){const{config:i,ascSortedZoomNumbers:n}=e;if(n.length===0)return{city:uo.commercialMargins.city};if(t<n[0])return{city:i[n[0]]};if(t>=n[n.length-1])return{city:i[n[n.length-1]]};for(let s=1;s<n.length;s++)if(t<n[s])return{city:i[n[s-1]]};return{city:uo.commercialMargins.city}}const CN=t=>({appendLabels:t.get(Ue.Labeling,"appendLabels"),appendLabelBox:t.get(Ue.Labeling,"appendLabelBox"),removeLabels:t.get(Ue.Labeling,"removeLabels"),processLabels:t.get(Ue.Labeling,"processLabels"),clearPreviousLabels:t.get(Ue.Labeling,"clearPreviousLabels")});class RN{constructor(e,i){this.state=e,this.modules=i,this.labelTileRevision=0,this.viewportDiffer=new Et([{path:"center",type:"vec2"},{path:"zoom",type:"number"},{path:"size",type:"vec2"},{path:"rotation",type:"number"},{path:"pitch",type:"number"},{path:"padding",type:"padding"},{path:"demMode",type:"boolean"}]),this.useThrottleUpdate=!0,this.isLabelingInProgress=!1,this.skipHysteresisInNextLabeling=!1,this.alwaysActiveLabelKeys=[],this.survivedLabelBoxes=new Set,this.prevSurvivedCommPoiIds=new Set,this.demKeys={},this.labelTiles=[],this.worker=CN(this.modules.workers.fnRegistry),this.setLabelingInterval(uo.interval)}disableThrottleUpdateOnce(){this.useThrottleUpdate=!1}update(){AN(this.state),this.state.needReplicasUpdate&&this.labelTiles.forEach(e=>{e.needSync=!0}),(this.viewportDiffer.check(this.state)||this.state.needLabeling)&&!this.isLabelingInProgress&&(this.state.needLabeling=!1,this.isLabelingInProgress=!0,this.useThrottleUpdate?this.throttledUpdateLabeling():(this.useThrottleUpdate=!0,this.generateLabelingTile()))}isIdle(){return this.state.tickers.labelingOpacity===void 0&&!this.isLabelingInProgress&&!this.state.needLabeling}setLabelingInterval(e){this.throttledUpdateLabeling=br(()=>{this.generateLabelingTile()},e)}addLabels(e,i,n){this.worker.appendLabels(e,i,n,this.state.styleState,this.state.styleZoom),this.enrichWithElevation(n,e),this.alwaysActiveLabelKeys.push(e),this.state.needLabeling=!0}addTileLabels(e,i,n){this.worker.appendLabels(e,i,n,this.state.styleState,this.state.styleZoom),this.enrichWithElevation(n,e),this.state.needLabeling=!0}addLabelBox(e,i){this.worker.appendLabelBox(e,i),this.state.needLabeling=!0}removeLabels(e){this.worker.removeLabels(e);const i=this.alwaysActiveLabelKeys.indexOf(e);i!==-1&&this.alwaysActiveLabelKeys.splice(i,1),this.state.needLabeling=!0}isLabelBoxSurvived(e){return this.survivedLabelBoxes.has(e)}clearPreviousLabels(){this.worker.clearPreviousLabels()}resetHysteresis(){this.skipHysteresisInNextLabeling=!0,this.state.needLabeling=!0}getLabelingRevision(){return this.labelTileRevision}getMemoryFootprint(){const e={labelTiles:this.labelTiles.map(i=>({[i.purpose]:o_(i)}))};return{gpu:{...e,"--sum":ui(e)}}}generateLabelingTile(){const e=ir(bo(this.state.tilesBounds),uo.tileMultiplier);let i=[{coords:e,center:this.state.center,tilesBounds:this.state.tilesBounds}];if(!this.state.globeMode)if(e[2]<0)i=[{coords:[0,0,0,0],center:[0,0,0],tilesBounds:[[-2147483648,-2147483648,0],[2147483648,-2147483648,0],[2147483648,2147483648,0],[-2147483648,2147483648,0]]}];else{const r=xo(e),a=2**e[2],l=r.min[0]<-2147483648,c=r.max[0]>2147483648;if(l||c){const d=[...e];d[0]+=l?a:-a;const h=[...this.state.center];h[0]+=l?4294967296:-4294967296;const{min:u,max:f}=xo(d);i.push({coords:d,center:h,tilesBounds:[[u[0],u[1],0],[f[0],u[1],0],[f[0],f[1],0],[u[0],f[1],0]]})}}const n=this.modules.tileManager.getLabelingData(),s=i.map(({coords:r,center:a,tilesBounds:l})=>({center:a,elevation:this.state.elevation,zoom:this.state.zoom,styleZoom:this.state.styleZoom,rotation:this.state.rotation,size:this.state.size,pitch:this.state.pitch,viewport:this.state.viewport,padding:this.state.padding,globeMode:this.state.globeMode,styleState:this.state.styleState,buildingHeight:this.modules.buildingHeightAnimator.getDefaultBuildingHeight(),tilesBounds:l,debugLabels:this.modules.labelsDebug.isEnabled(),disableSurvivedPoiPrevalence:this.state.disableSurvivedPoiPrevalence,tileInfo:Ye(r),cameraConfig:this.state.cameraConfig})),o=LN(this.state.styleZoom,this.state.cityCommPoiLabeling);this.worker.processLabels(n,this.alwaysActiveLabelKeys,s,window.devicePixelRatio,this.modules.floorManager.getActiveFloorHiddenIds(),{...uo.commercialMargins,...o},this.skipHysteresisInNextLabeling).then(r=>{this.survivedLabelBoxes.clear(),this.labelTiles.forEach(u=>{this.modules.tileManager.removeObject(u),u.clean(this.state)}),this.labelTiles.length=0;const a=[];r.forEach((u,f)=>{u.survivedLabelBoxIds.forEach(p=>this.survivedLabelBoxes.add(p)),a.push(...u.survivedCommPois),this.modules.assetManager.loadRasters(u.collectorOutput.rastersToLoad);const m=new Ct("labeling",u.collectorOutput.data,this.modules,this.state,i[f].coords,void 0,void 0);this.labelTiles.push(m),this.modules.tileManager.addObject(m)}),this.processSurvivedCommPoiIds(a),this.labelTileRevision++;const l=this.state.metrics;l.firstlabeling===void 0&&r.some(({collectorOutput:u})=>u.data.length>0)&&(l.firstlabeling=performance.now()-l.start);const{animationTime:c,animationType:d,interval:h}=uo;EN(this.state,d,0,1,Math.min(c,h)),this.modules.renderer.addRerenderEvent(),r[0].labels&&e[2]>=0&&this.modules.labelsDebug.drawLabels(r[0].labels),this.isLabelingInProgress=!1}),this.skipHysteresisInNextLabeling=!1}processSurvivedCommPoiIds(e){if(e.length===0){this.prevSurvivedCommPoiIds.clear();return}const i=e.filter(n=>!this.prevSurvivedCommPoiIds.has(n.id));i.length!==0&&this.modules.map.emit("commpoishow",{commPois:i}),this.prevSurvivedCommPoiIds=new Set(e.map(n=>n.id))}enrichWithElevation(e,i){const{demManager:n,map:s}=this.modules;if(s.state.demMode){const o=this.demKeys[i],r=n.getLabelsDemKey(e);if(r===void 0||r===o)return;n.enrichWithElevation(e),this.demKeys[i]=r}}}const Ve={jointPhase:10,jointWidth:7,jointBorderWidth:3,jointBorder2Width:2,jointSmallWidth:0,jointSmallBorderWidth:4,jointSmallBorder2Width:2,jointColor:"#ffffff",jointBorderColor:"#667799",jointBorder2Color:"#ffffff",linePhase:5,lineWidth:4,lineBorderWidth:2,lineBorder2Width:1,lineColor:"#667799",lineBorderColor:"#ffffff",lineBorder2Color:"#00000026",previewLineColor:"#66779966",labelFontSize:13},Bo={start:{en:"Start",ru:"Старт"},addPoint:{en:"Add point",ru:"Добавить точку"},meter:{en:"m",ru:"м"},kilometer:{en:"km",ru:"км"}};function Nb(t,e,i){return e?Bo.start[i]||Bo.start.en:t<1e3?`${t} ${Bo.meter[i]||Bo.meter.en}`:`${(t/1e3).toFixed(1)} ${Bo.kilometer[i]||Bo.kilometer.en}`}function zN(t){return Bo.addPoint[t]||Bo.addPoint.en}function FN(t,e){return e*.55*t.length}function Ub(t,e){return`
        <div style="font-size: ${e}px;
            color: #667799;
            user-select: none;
            font-family: SuisseIntl, Helvetica, Arial, sans-serif;
            text-shadow: 1px 0px 1px #fff, -1px 0px 1px #fff, 0px 1px 1px #fff, 0px -1px 1px #fff;
            white-space: nowrap;
            cursor: pointer;
        ">
            ${t}
        </div>
    `}function DN(t,e){return`
        <div style="text-shadow: 1px 0px 1px #fff, -1px 0px 1px #fff, 0px 1px 1px #fff, 0px -1px 1px #fff;
            user-select: none;
            color: #667799;
            font-family: SuisseIntl, Helvetica, Arial, sans-serif;
            font-size: 13px;
            margin: -12px 0 0 12px; /** отступы от точки наведения */
            white-space: nowrap;
            cursor: pointer;
        ">
            ${t}
            <br>
            ${zN(e)}
        </div>
    `}function ON(){return`
        <img style="
            user-select: none;
            width: 24px;
            height: 24px;
            margin-top: -4px;
            cursor: pointer;
        " src="data:image/svg+xml;base64,${kN}" alt="close">
    `}function Gb(t,e,i,n){return new A_(n,{coordinates:t,interactive:i,draggable:i,width:e?Ve.jointWidth:Ve.jointSmallWidth,borderWidth:e?Ve.jointBorderWidth:Ve.jointSmallBorderWidth,border2Width:e?Ve.jointBorder2Width:Ve.jointSmallBorder2Width,color:Ve.jointColor,borderColor:Ve.jointBorderColor,border2Color:Ve.jointBorder2Color,zIndex:Ve.jointPhase})}function jb(t,e,i){return new up(i,{coordinates:t,zIndex:Ve.linePhase,zIndex2:Ve.linePhase-1,zIndex3:Ve.linePhase-2,width:Ve.lineWidth,width2:e?0:Ve.lineWidth+2*Ve.lineBorderWidth,width3:e?0:Ve.lineWidth+2*(Ve.lineBorderWidth+Ve.lineBorder2Width),color:e?Ve.previewLineColor:Ve.lineColor,color2:Ve.lineBorderColor,color3:Ve.lineBorder2Color,interactive:!e})}function BN(t,e,i,n){const s=Ub(i,Ve.labelFontSize),o=FN(i,Ve.labelFontSize),r=Ve.labelFontSize,a=e?Ve.jointWidth:Ve.jointSmallWidth,l=e?Ve.jointBorderWidth:Ve.jointSmallBorderWidth,c=e?Ve.jointBorder2Width:Ve.jointSmallBorder2Width,d=a+l*2+c*2;return new Jl(n,{coordinates:t,html:s,offset:[d/2+2,-13/2-2],labeling:{type:"full",width:o,height:r},animate:!1,zIndex:Ve.linePhase+1})}const kN="PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMjIiIGhlaWdodD0iMjIiPjxkZWZzPjxwYXRoIGlkPSJBIiBkPSJNMTIgMTAuNTg2bDMuNzkzLTMuNzkzIDEuNDE0IDEuNDE0TDEzLjQxNCAxMmwzLjc5MyAzLjc5My0xLjQxNCAxLjQxNEwxMiAxMy40MTRsLTMuNzkzIDMuNzkzLTEuNDE0LTEuNDE0TDEwLjU4NiAxMiA2Ljc5MyA4LjIwN2wxLjQxNC0xLjQxNEwxMiAxMC41ODZ6Ii8+PC9kZWZzPjxnIGZpbGwtcnVsZT0iZXZlbm9kZCIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTEgLTEpIj48Y2lyY2xlIGN4PSIxMiIgY3k9IjEyIiByPSIxMC41IiBmaWxsPSIjZmZmIiBzdHJva2U9IiMwMDAiIHN0cm9rZS1vcGFjaXR5PSIuMTUiLz48bWFzayBpZD0iQiIgZmlsbD0iI2ZmZiI+PHVzZSB4bGluazpocmVmPSIjQSIvPjwvbWFzaz48dXNlIGZpbGw9IiMwMDAiIGZpbGwtcnVsZT0ibm9uemVybyIgeGxpbms6aHJlZj0iI0EiLz48ZyBmaWxsPSIjMjYyNjI2IiBtYXNrPSJ1cmwoI0IpIj48cGF0aCBkPSJNMCAwaDI0djI0SDB6Ii8+PC9nPjwvZz48L3N2Zz4=";class NN extends Qo{constructor(e,i,n,s){super(),this.markerOrLabelMouseover=()=>{this.markerOrLabelHovered||(this.markerOrLabelHovered=!0,this.hoverTimer===void 0&&this.emit("mouseover"))},this.markerOrLabelMouseout=()=>{this.markerOrLabelHovered&&(this.markerOrLabelHovered=!1,this.hoverTimer=window.setTimeout(()=>{this.markerOrLabelHovered||(this.emit("mouseout"),this.hoverTimer=void 0)},100))},this.onClick=()=>this.emit("click"),this.labelText=Nb(s,n,e.state.lang),this.point=i,this.distance=s,this.label=BN(i,n,this.labelText,e),this.marker=Gb(i,n,!0,e),this.markerOrLabelHovered=!1;const o=this.label.dangerouslyGetRootElement();o.addEventListener("mouseover",this.markerOrLabelMouseover),o.addEventListener("mouseout",this.markerOrLabelMouseout),o.addEventListener("click",this.onClick),this.marker.on("mouseover",()=>this.markerOrLabelMouseover()),this.marker.on("mouseout",()=>this.markerOrLabelMouseout()),this.marker.on("dragstart",r=>{const{lngLat:a,originalEvent:l,point:c,target:d}=r;this.emit("dragstart",{lngLat:a,originalEvent:l,point:c,targetData:this,target:d})}),this.marker.on("dragend",r=>{const{lngLat:a,originalEvent:l,point:c,target:d}=r;this.emit("dragend",{lngLat:a,originalEvent:l,point:c,targetData:this,target:d})})}getDistance(){return this.distance}getPoint(){return this.point}getMarkerUniqId(){return this.marker.uniqId}getLabelUniqId(){return this.label.uniqId}setPoint(e){this.point=e}remove(){this.marker.destroy();const e=this.label.dangerouslyGetRootElement();e.removeEventListener("mouseover",this.markerOrLabelMouseover),e.removeEventListener("mouseout",this.markerOrLabelMouseout),e.removeEventListener("click",this.onClick),this.label.destroy()}activateHover(){this.label.setContent(ON())}deactivateHover(){this.label.setContent(Ub(this.labelText,Ve.labelFontSize))}}class UN{constructor(e,i){this.onDocumentMouseMove=n=>{this.mousePos=Ht(this.modules.layout.rootContainer,n.clientX,n.clientY),this.needsUpdate=!0},this.modules=i,this.state=e,this.joints=[],this.enabled=!1,this.needsUpdate=!1,this.hidePreviewLine=!1,this.hideMouseElem=!1,this.mousePos=[0,0],document.addEventListener("mousemove",this.onDocumentMouseMove),this.langDiffer=new Et([{path:"lang",type:"string"}])}destroy(){document.removeEventListener("mousemove",this.onDocumentMouseMove)}enable(){this.enabled||(this.enabled=!0,this.state.identifyPickDistance=rn.pickDistance*2,this.popup=new Jl(this.modules.map,{coordinates:[0,0],html:"",interactive:!1,animate:!1,zIndex:1}))}disable(){this.enabled=!1,this.reset(),this.mouseElem!==void 0&&(this.mouseElem.destroy(),this.mouseElem=void 0),this.state.identifyPickDistance=rn.pickDistance,this.popup&&(this.popup.destroy(),this.popup=void 0)}update(){this.enabled&&(this.langDiffer.check(this.state)&&this.recalculate(),this.needsUpdate&&(this.needsUpdate=!1,this.drawMousePoint(),this.drawPreviewLine()))}setPoints(e){this.reset(),e.forEach(i=>this.addPointToEnd(i)),this.drawPolyline(),this.sendRulerChangeEvent(!1)}handleClick(e,i){const n=this.getJointByUniqId(i&&i.dynamicObjectId);if(n){const s=this.getJointIndexByReferer(n);s!==void 0&&(n.remove(),this.joints.splice(s,1),this.recalculate(),this.hidePreviewLine=!1,this.hideMouseElem=!1),this.popup&&this.popup.setContent("")}else if(i&&this.polyline&&this.polyline.uniqId===i.dynamicObjectId){const s=this.polyline.snapPoint(e),o=this.getJointIndexByDistance(s.distance),r=this.createJoint(s.point,!1,s.distance);this.joints.splice(o,0,r),this.hidePreviewLine=!0,this.hideMouseElem=!0,this.drawPolyline(),this.sendRulerChangeEvent(!0),this.popup&&this.popup.setContent("")}else{const s=this.modules.camera.unproject(e);this.addPointToEnd(s),this.drawPolyline(),this.sendRulerChangeEvent(!0)}}recalculate(){const e=[];this.joints.forEach((i,n)=>{i.remove();const s=n===0;let o=0;if(!s){const a=e[n-1];o=a.getDistance()+qo(a.getPoint(),i.getPoint())}const r=this.createJoint(i.getPoint(),s,o);e.push(r)}),this.joints=e,this.drawPolyline(),this.sendRulerChangeEvent(!0)}sendRulerChangeEvent(e){this.modules.map.emit("rulerchange",{points:this.getPoints(),isUser:e})}getJointByUniqId(e){if(e!==void 0){for(const i of this.joints)if(e===i.getMarkerUniqId()||e===i.getLabelUniqId())return i}}getJointIndexByDistance(e){let i=0;for(const n of this.joints){if(e<n.getDistance())break;i++}return i}getJointIndexByReferer(e){let i=0;for(const n of this.joints){if(n===e)return i;i++}}getPoints(){return this.joints.map(e=>e.getPoint())}reset(){this.joints.forEach(e=>e.remove()),this.joints=[],this.polyline!==void 0&&(this.polyline.remove(),this.polyline=void 0),this.previewLine!==void 0&&(this.previewLine.remove(),this.previewLine=void 0),this.hidePreviewLine=!1,this.hideMouseElem=!1,this.popup&&this.popup.setContent("")}createJoint(e,i,n){const s=new NN(this.modules.map,e,i,n);return s.on("mouseover",()=>{this.draggableJointIndex===void 0&&(this.requestUpdate(!0,!0),s.activateHover())}),s.on("mouseout",()=>{this.draggableJointIndex===void 0&&(this.requestUpdate(!1,!0),s.deactivateHover())}),s.on("dragstart",()=>{this.requestUpdate(!1,!0),this.draggableJointIndex=this.getJointIndexByReferer(s)}),s.on("dragend",o=>{this.requestUpdate(!1,!0),this.draggableJointIndex=void 0,s.setPoint(o.lngLat),this.recalculate()}),s.on("click",()=>{const o=this.getJointIndexByReferer(s);o!==void 0&&(s.remove(),this.joints.splice(o,1),this.recalculate(),this.hidePreviewLine=!1,this.hideMouseElem=!1),this.popup&&this.popup.setContent("")}),s}addPointToEnd(e){let i=!0,n=0;if(this.joints.length>0){i=!1;const o=this.joints[this.joints.length-1];n=o.getDistance()+qo(o.getPoint(),e)}const s=this.createJoint(e,i,n);this.joints.push(s)}drawPolyline(){this.polyline!==void 0&&(this.polyline.remove(),this.polyline=void 0);const e=this.getPoints();if(e.length<2)return;const i=jb(e,!1,this.modules.map);i.on("mousemove",n=>{if(this.draggableJointIndex===void 0){if(this.popup){const s=i.snapPoint(n.point),o=Nb(s.distance,!1,this.state.lang);this.popup.setPosition(s.point),this.popup.setContent(DN(o,this.state.lang)),this.snapPoint=s.point}this.requestUpdate(!0,!1)}}),i.on("mouseout",()=>{this.draggableJointIndex===void 0&&(this.popup&&this.popup.setContent(""),this.requestUpdate(!1,!0))}),this.polyline=i}requestUpdate(e,i){this.hidePreviewLine=e,this.hideMouseElem=i,this.needsUpdate=!0}getPreviewPoints(){const e=this.getPoints();if(this.hidePreviewLine||e.length<1)return[];const i=this.draggableJointIndex,n=this.modules.camera.unproject(this.mousePos);if(i===void 0||e.length===1)return[];if(i===this.joints.length-1)return[e[e.length-2],n];if(i===0)return[e[1],n];const s=this.joints[i-1],o=this.joints[i+1];return[s.getPoint(),n,o.getPoint()]}drawPreviewLine(){this.previewLine!==void 0&&(this.previewLine.remove(),this.previewLine=void 0);const e=this.getPreviewPoints();e.length<1||(this.previewLine=jb(e,!0,this.modules.map))}drawMousePoint(){this.mouseElem!==void 0&&(this.mouseElem.destroy(),this.mouseElem=void 0),!(this.hideMouseElem||this.snapPoint===void 0)&&(this.mouseElem=Gb(this.snapPoint,!0,!1,this.modules.map))}}class Fa{constructor(e,i,n){this.type=e,this.handler=n,this.mouseDownPoint=i,this.handler.mapState.userHasInteracted=!0,this.handler.modules.map.emit("interactionstart",{target:"pitch/rotation"})}processAction(e){switch(e.type){case"mousemove":return this.processMouseMoveAction(e);case"mouseup":return this.processMouseUpAction(e);case"keyup":return this.processKeyUpAction(e);default:return this}}processMouseMoveAction(e){const i=Ht(this.handler.container,e.clientX,e.clientY);return new Vb(this.type,this.mouseDownPoint,i,this.handler)}processMouseUpAction(e){switch(this.type){case"keyPrimary":if(e.button===0&&(e.ctrlKey||e.metaKey))return this.returnToInitialState();break;case"secondary":if(e.button===2){const i=Ht(this.handler.container,e.clientX,e.clientY);return this.handler.modules.identifier.search("contextmenu",i,!0).then(n=>{Es("contextmenu",n,e,i,this.handler.modules)}),this.returnToInitialState()}break;case"auxiliary":if(e.button===1)return this.returnToInitialState();break}return this}processKeyUpAction(e){return this.type==="keyPrimary"&&(e.key==="Control"||e.key==="Meta")?(this.handler.modules.map.emit("interactionend",{target:"pitch/rotation"}),new zh(this.mouseDownPoint,this.handler)):this}returnToInitialState(){return this.handler.mapState.userHasInteracted=!0,this.handler.modules.map.emit("interactionend",{target:"pitch/rotation"}),new Sn(this.handler)}}class Vb{constructor(e,i,n,s){this.type=e,this.mouseDownPoint=i,this.mouseMovePoint=n,this.handler=s,this.handler.mapState.userHasInteracted=!0,(!this.handler.mapState.disablePitchByUserInteraction||!this.handler.mapState.disableRotationByUserInteraction)&&this.handler.container.classList.add("mapgl-rotating"),this.update(this.handler.mapState)}processAction(e){switch(e.type){case"mousemove":return this.processMouseMoveAction(e);case"mouseleave":return this.returnToInitialState();case"mouseup":return this.processMouseUpAction(e);case"keyup":return this.processKeyUpAction(e);default:return this}}update(e){this.mouseDownPoint[0]===0&&this.mouseDownPoint[1]===0&&(this.mouseDownPoint=this.mouseMovePoint);const i=vc(e.size,this.mouseDownPoint),n=vc(e.size,this.mouseMovePoint),s=(i[0]-n[0])*an.mouseRotateDelta,o=(n[1]-i[1])*an.mousePitchDelta;As(e),e.disableRotationByUserInteraction||Dl(e,e.rotation+s,{animate:!1}),e.disablePitchByUserInteraction||Dd(e,Be(e.pitch+o,e.minPitch,e.maxPitch),{animate:!1}),this.mouseDownPoint=this.mouseMovePoint,this.handler.modules.renderer.addRerenderEvent()}processMouseMoveAction(e){return this.mouseMovePoint=Ht(this.handler.container,e.clientX,e.clientY),this.handler.mapState.userHasInteracted=!0,this.update(this.handler.mapState),this}processMouseUpAction(e){switch(this.type){case"keyPrimary":if(e.button===0&&(e.ctrlKey||e.metaKey))return this.returnToInitialState();break;case"secondary":if(e.button===2)return this.returnToInitialState();break;case"auxiliary":if(e.button===1)return this.returnToInitialState();break}return this}processKeyUpAction(e){return this.type==="keyPrimary"&&(e.key==="Control"||e.key==="Meta")?(this.handler.container.classList.remove("mapgl-rotating"),this.handler.modules.map.emit("interactionend",{target:"pitch/rotation"}),new zh(this.mouseMovePoint,this.handler)):this}returnToInitialState(){return this.handler.mapState.userHasInteracted=!0,this.handler.container.classList.remove("mapgl-rotating"),this.handler.modules.map.emit("interactionend",{target:"pitch/rotation"}),new Sn(this.handler)}}class zh{constructor(e,i){this.handler=i,this.toInitialOnMouseUp=!1,this.mouseDownPoint=e,this.dragStartPoint=e,this.isTimerStarted=this.handler.dblClickTimer!==void 0,this.handler.mapState.userHasInteracted=!0,this.handler.modules.map.emit("interactionstart",{target:"center"}),this.isTimerStarted&&(window.clearTimeout(this.handler.dblClickTimer),this.handler.dblClickTimer=void 0)}processAction(e){switch(e.type){case"mousedown":return this.toInitialOnMouseUp=!0,this;case"mouseup":return this.processMouseUpAction(e);case"mousemove":return this.processMouseMoveAction(e);case"click":return this.processMouseClickAction(e);case"keydown":return this.processKeyDownAction(e);default:return this}}processMouseUpAction(e){return e.button===0&&(this.toInitialOnMouseUp||!this.handler.modules.layout.isActionWithCanvas(e))?(this.handler.mapState.userHasInteracted=!0,this.handler.modules.map.emit("interactionend",{target:"center"}),new Sn(this.handler)):this}processMouseMoveAction(e){const i=Ht(this.handler.container,e.clientX,e.clientY);return this.handler.mapState.disableDragging?(this.mouseDownPoint=i,this.dragStartPoint=i,this.toInitialOnMouseUp=!0,this):Un(this.mouseDownPoint,i)<ks.dragThreshold?(this.dragStartPoint=i,this):new Hb(i,this.dragStartPoint,this.handler)}processMouseClickAction(e){if(!this.handler.modules.layout.isActionWithCanvas(e))return this;if(this.isTimerStarted){if(this.handler.mapState.zoom<this.handler.mapState.maxZoom){const i=this.handler.mapState,n=Math.min(i.zoom+1,i.maxZoom),s=Ht(this.handler.container,e.clientX,e.clientY);As(i),io(i,n,{duration:an.animDuration,zoomPoint:i.keepCenterWhileUserZoomRotate?void 0:s}),this.handler.modules.renderer.addRerenderEvent()}}else{const i=Ht(this.handler.container,e.clientX,e.clientY);this.handler.modules.identifier.search("mouseClick",i,!0).then(n=>{const s=this.handler.modules.ruler;if(s.enabled){s.handleClick(i,n);return}this.handler.dblClickTimer||(this.handler.dblClickTimer=window.setTimeout(()=>{Es("click",n,e,i,this.handler.modules),this.handler.dblClickTimer=void 0},ks.doubleClickTime))})}return this.handler.mapState.userHasInteracted=!0,this.handler.modules.map.emit("interactionend",{target:"center"}),new Sn(this.handler)}processKeyDownAction(e){return e.key==="Control"||e.key==="Meta"?(this.handler.modules.map.emit("interactionend",{target:"center"}),new Fa("keyPrimary",this.mouseDownPoint,this.handler)):this}}class Hb{constructor(e,i,n){this.mouseMovePoint=e,this.dragStartPoint=i,this.handler=n,this.handler.container.classList.add("mapgl-dragging"),this.handler.mapState.userHasInteracted=!0,this.update(this.handler.mapState)}processAction(e){switch(e.type){case"mousemove":return this.processMouseMoveAction(e);case"mouseup":return this.processMouseUpAction(e);case"keydown":return this.processKeyDownAction(e);default:return this}}update(e){const i=this.handler.modules.camera,n=i.flat.unproject(this.dragStartPoint),s=i.flat.unproject(this.mouseMovePoint);if(e.globeMode){const r=ag(i.globeRatio,Z.toGeo(e.center));Ni(n,n,r),Ni(s,s,r)}const o=Or(e.center);Ot(o,o,n),vi(o,o,s),As(e),yr(e,o,{animate:!1}),this.dragStartPoint=this.mouseMovePoint,this.handler.modules.renderer.addRerenderEvent()}processMouseMoveAction(e){return this.mouseMovePoint=Ht(this.handler.container,e.clientX,e.clientY),this.handler.mapState.userHasInteracted=!0,this.update(this.handler.mapState),this}processMouseUpAction(e){return e.button===0?this.returnToInitialState():this}processKeyDownAction(e){return e.key==="Control"||e.key==="Meta"?(this.handler.container.classList.remove("mapgl-dragging"),this.handler.modules.map.emit("interactionend",{target:"center"}),new Fa("keyPrimary",this.mouseMovePoint,this.handler)):this}returnToInitialState(){return this.handler.container.classList.remove("mapgl-dragging"),this.handler.modules.map.emit("interactionend",{target:"center"}),this.handler.mapState.userHasInteracted=!0,new Sn(this.handler)}}class Zb{constructor(e,i,n){this.handler=n,this.touchStartPoints=i,this.touchMovePoints=e,this.handler.mapState.userHasInteracted=!0,this.handler.mapState.disablePitchByUserInteraction||this.handler.container.classList.add("mapgl-rotating"),this.update(this.handler.mapState)}processAction(e){switch(e.type){case"touchstart":return this.processTouchStartAction(e);case"touchmove":return this.processTouchMoveAction(e);case"touchend":return this.processTouchEndAction(e);default:return this}}processTouchStartAction(e){return this.handler.container.classList.remove("mapgl-rotating"),this.handler.modules.map.emit("interactionend",{target:"pitch/zoom/rotation"}),new Da(e,this.handler,!1)}processTouchMoveAction(e){return e.preventDefault(),this.touchMovePoints=Ko(e.touches,this.handler.container),this.handler.mapState.userHasInteracted=!0,this.update(this.handler.mapState),this}processTouchEndAction(e){return this.handler.container.classList.remove("mapgl-rotating"),this.handler.modules.map.emit("interactionend",{target:"pitch/zoom/rotation"}),e.touches.length===0?(this.handler.mapState.userHasInteracted=!0,new Sn(this.handler)):new Da(e,this.handler,!1)}}class Fh extends Zb{constructor(e,i,n){super(e,i,n),this.startPxAngle=0,this.rotationDetected=!1,i.length>1&&(this.startPxAngle=wc(i[0],i[1]))}update(e){if(this.touchStartPoints.length<2||this.touchMovePoints.length<2)return;const i=Tu(this.touchMovePoints[0],this.touchMovePoints[1]),n=po(this.touchMovePoints[0],this.touchMovePoints[1]),s=po(this.touchStartPoints[0],this.touchStartPoints[1]),o=n/s,r=e.zoom+Math.log(o)/Math.log(2)*an.mobilePinchDelta;let a=0,l=0;if(!this.rotationDetected){const h=wc(this.touchMovePoints[0],this.touchMovePoints[1]);l=Math.abs(this.startPxAngle-h),l>Math.PI&&(l=2*Math.PI-l),l>=this.handler.mapState.touchRotationThreshold&&(this.rotationDetected=!0)}if(this.rotationDetected){const h=this.handler.modules.camera.flat.unproject(this.touchStartPoints[0]),u=this.handler.modules.camera.flat.unproject(this.touchStartPoints[1]),f=this.handler.modules.camera.flat.unproject(this.touchMovePoints[0]),m=this.handler.modules.camera.flat.unproject(this.touchMovePoints[1]);if(h&&u&&f&&m){const p=wc(h,u),_=wc(f,m);a=p-_}}const c=e.rotation+a,d=e.center;e.keepCenterWhileUserZoomRotate||Ot(d,e.center,qa(e,i,{zoom:r,rotation:c})),As(e),yr(e,d,{animate:!1}),io(e,r,{animate:!1}),this.handler.mapState.disableRotationByUserInteraction||Dl(e,c,{animate:!1}),this.touchStartPoints=this.touchMovePoints,this.handler.modules.renderer.addRerenderEvent()}}class $b extends Zb{constructor(e,i,n){super(e,i,n)}update(e){const i=this.touchStartPoints.map(a=>vc(e.size,a)),n=this.touchMovePoints.map(a=>vc(e.size,a)),s=Tu(i[0],i[1]),r=(Tu(n[0],n[1])[1]-s[1])*an.mousePitchDelta;As(e),Dd(e,Be(e.pitch+r,e.minPitch,e.maxPitch),{animate:!1}),this.touchStartPoints=this.touchMovePoints,this.handler.modules.renderer.addRerenderEvent()}}class Da{constructor(e,i,n){this.handler=i,this.needClickOnTouchEnd=n,this.toZoomRotate=!1,this.touchStartPoints=Ko(e.touches,this.handler.container),this.handler.mapState.userHasInteracted=!0,this.isTimerStarted=this.handler.dblClickTimer!==void 0,Eu(e)?this.startedInteractionTarget="pitch/zoom/rotation":this.isTimerStarted?(this.startedInteractionTarget="zoom/rotation",window.clearTimeout(this.handler.dblClickTimer),this.handler.dblClickTimer=void 0):this.startedInteractionTarget="center",this.handler.modules.map.emit("interactionstart",{target:this.startedInteractionTarget})}processAction(e){switch(e.type){case"touchstart":return this.processTouchStartAction(e);case"touchmove":return this.processTouchMoveAction(e);case"touchend":return this.processTouchEndAction(e);default:return this}}getStartedInteractionTarget(){return this.startedInteractionTarget}processTouchStartAction(e){return e.preventDefault(),this.touchStartPoints.length===1&&(this.needClickOnTouchEnd=!1,this.handler.modules.map.emit("interactionend",{target:"center"}),this.startedInteractionTarget="pitch/zoom/rotation",this.handler.modules.map.emit("interactionstart",{target:this.startedInteractionTarget}),this.handler.mapState.userHasInteracted=!0),this.touchStartPoints=Ko(e.touches,this.handler.container),this}processTouchMoveAction(e){e.preventDefault();const i=Ko(e.touches,this.handler.container);if(!Eu(e))return Un(this.touchStartPoints[0],i[0])<ks.dragThreshold?(this.touchStartPoints=i,this):this.isTimerStarted?new Wb(i[0],this.touchStartPoints[0],this.handler):this.handler.mapState.disableDragging?(this.touchStartPoints=i,this.needClickOnTouchEnd=!1,this):new ip(i[0],this.touchStartPoints[0],this.handler);if(this.touchStartPoints.length<2)return this.processTouchStartAction(e);const n=xt(),s=xt();Ai(n,i[0],this.touchStartPoints[0]),Ai(s,i[1],this.touchStartPoints[1]);const o=Vo(n,s);if(o>0){if(this.handler.mapState.enableTwoFingerDragging&&this.touchStartPoints.length===2)return Un(this.touchStartPoints[0],i[0])<ks.dragThreshold?(this.touchStartPoints=i,this):new ip(i[0],this.touchStartPoints[0],this.handler);const a=Un(this.touchStartPoints[0],i[0]),l=Un(this.touchStartPoints[1],i[1]);return a<ks.pitchThreshold||l<ks.pitchThreshold?(this.touchStartPoints=i,this):this.handler.mapState.disablePitchByUserInteraction?this:new $b(i,this.touchStartPoints,this.handler)}return o<0?new Fh(i,this.touchStartPoints,this.handler):vg(n)||vg(s)?this.pitchWaitingTimer?this:this.toZoomRotate?(this.toZoomRotate=!1,new Fh(i,this.touchStartPoints,this.handler)):(this.pitchWaitingTimer=window.setTimeout(()=>{this.toZoomRotate=!0,this.pitchWaitingTimer=void 0},ks.pitchWaitingTime),this):new Fh(i,this.touchStartPoints,this.handler)}processTouchEndAction(e){return e.cancelable&&e.preventDefault(),e.touches.length===0?e.changedTouches.length===1&&this.needClickOnTouchEnd?this.processTouchClickAction(this.touchStartPoints[0],e):(this.handler.mapState.userHasInteracted=!0,this.handler.modules.map.emit("interactionend",{target:e.changedTouches.length>1?"pitch/zoom/rotation":"center"}),new Sn(this.handler)):(Eu(e)||(this.handler.modules.map.emit("interactionend",{target:"pitch/zoom/rotation"}),this.startedInteractionTarget="center",this.handler.modules.map.emit("interactionstart",{target:this.startedInteractionTarget}),this.handler.mapState.userHasInteracted=!0),this.touchStartPoints=Ko(e.touches,this.handler.container),this)}processTouchClickAction(e,i){if(this.isTimerStarted){if(this.handler.mapState.zoom<this.handler.mapState.maxZoom){const n=this.handler.mapState,s=Math.min(n.zoom+1,n.maxZoom),o=n.keepCenterWhileUserZoomRotate?void 0:e;As(n),io(n,s,{duration:an.animDuration,zoomPoint:o}),this.handler.modules.renderer.addRerenderEvent()}}else if(this.handler.modules.layout.isActionWithCanvas(i))this.handler.modules.identifier.search("mouseClick",e,!0).then(n=>{const s=this.handler.modules.ruler;if(s.enabled){s.handleClick(e,n);return}this.handler.dblClickTimer||(this.handler.dblClickTimer=window.setTimeout(()=>{Es("click",n,i,e,this.handler.modules),this.handler.dblClickTimer=void 0},ks.doubleClickTime))});else{const n=i.changedTouches[0];i.target&&n&&i.target.dispatchEvent(new MouseEvent("click",{bubbles:!0,cancelable:!0,clientX:n.clientX,clientY:n.clientY}))}return this.handler.mapState.userHasInteracted=!0,this.handler.modules.map.emit("interactionend",{target:"center"}),new Sn(this.handler)}}class ip{constructor(e,i,n){this.handler=n,this.touchMovePoint=e,this.touchStartPoint=i,this.handler.mapState.userHasInteracted=!0,this.handler.container.classList.add("mapgl-dragging"),this.update(this.handler.mapState)}processAction(e){switch(e.type){case"touchstart":return this.processTouchStartAction(e);case"touchmove":return this.processTouchMoveAction(e);case"touchend":return this.processTouchEndAction();default:return this}}update(e){const i=this.handler.modules.camera,n=i.flat.unproject(this.touchStartPoint),s=i.flat.unproject(this.touchMovePoint);if(e.globeMode){const r=ag(i.globeRatio,Z.toGeo(e.center));Ni(n,n,r),Ni(s,s,r)}const o=Or(e.center);Ot(o,o,n),vi(o,o,s),As(e),yr(e,o,{animate:!1}),this.touchStartPoint=this.touchMovePoint,this.handler.modules.renderer.addRerenderEvent()}processTouchStartAction(e){return this.handler.container.classList.remove("mapgl-dragging"),this.handler.modules.map.emit("interactionend",{target:"center"}),new Da(e,this.handler,!1)}processTouchMoveAction(e){e.preventDefault();const i=Ko(e.touches,this.handler.container);return this.touchMovePoint=i[0],this.handler.mapState.userHasInteracted=!0,this.update(this.handler.mapState),this}processTouchEndAction(){return this.handler.container.classList.remove("mapgl-dragging"),this.handler.modules.map.emit("interactionend",{target:"center"}),this.handler.mapState.userHasInteracted=!0,new Sn(this.handler)}}class Wb{constructor(e,i,n){this.handler=n,this.mapHeight=n.mapState.size[1],this.startZoom=n.mapState.zoom,this.touchMovePointY=e[1],this.touchStartPoint=i,this.handler.mapState.userHasInteracted=!0,this.update(this.handler.mapState)}processAction(e){switch(e.type){case"touchstart":return this.processTouchStartAction(e);case"touchmove":return this.processTouchMoveAction(e);case"touchend":return this.processTouchEndAction();default:return this}}update(e){const i=this.touchMovePointY-this.touchStartPoint[1];if(i===0)return;const n=i/this.mapHeight,s=Be(this.startZoom+n*an.mobileTapDelta,e.minZoom,e.maxZoom),o=e.center;e.keepCenterWhileUserZoomRotate||Ot(o,e.center,qa(e,this.touchStartPoint,{zoom:s})),As(e),yr(e,o,{animate:!1}),io(e,s,{animate:!1}),this.handler.modules.renderer.addRerenderEvent()}processTouchStartAction(e){return this.handler.modules.map.emit("interactionend",{target:"zoom/rotation"}),new Da(e,this.handler,!1)}processTouchMoveAction(e){e.preventDefault();const i=Ko(e.touches,this.handler.container);return this.touchMovePointY=i[0][1],this.handler.mapState.userHasInteracted=!0,this.update(this.handler.mapState),this}processTouchEndAction(){return this.handler.modules.map.emit("interactionend",{target:"zoom/rotation"}),this.handler.mapState.userHasInteracted=!0,new Sn(this.handler)}}class Sn{constructor(e){this.handler=e}processAction(e){switch(e.type){case"mousedown":return this.processMouseDownAction(e);case"touchstart":return this.processTouchStartAction(e);default:return this}}processMouseDownAction(e){const i=Ht(this.handler.container,e.clientX,e.clientY);switch(e.button){case 0:if(e.ctrlKey||e.metaKey)return new Fa("keyPrimary",i,this.handler);if(this.handler.modules.layout.isActionWithCanvas(e)){const n=this.handler.modules.identifier.searchSync(i);Es("mousedown",n,e,i,this.handler.modules)}return new zh(i,this.handler);case 1:return new Fa("auxiliary",i,this.handler);case 2:return new Fa("secondary",i,this.handler);default:return this}}processTouchStartAction(e){if(e.preventDefault(),!e.touches)return this;if(this.handler.modules.layout.isActionWithCanvas(e)){const i=Ht(this.handler.container,e.changedTouches[0].clientX,e.changedTouches[0].clientY),n=this.handler.modules.identifier.searchSync(i);Es("touchstart",n,e,i,this.handler.modules)}return new Da(e,this.handler,e.touches.length===1)}}class Dh{processAction(){return this}}class GN{constructor(e,i){this.preventDefault=n=>{n.preventDefault()},this.onMouseMove=n=>{this.dblClickTimer&&(this.dblClickTimer=void 0),this.switchState(n)},this.onTouchStart=n=>{this.modules.layout.isActionWithMap(n)&&this.switchState(n)},this.switchState=n=>{this.state;const s=this.state.processAction(n);this.state instanceof Dh||(this.state=s)},this.state=new Sn(this),this.mapState=e,this.modules=i,this.container=i.layout.mapContainer,document.addEventListener("mouseup",this.switchState),document.addEventListener("keydown",this.switchState),document.addEventListener("keyup",this.switchState),document.addEventListener("mouseleave",this.switchState),document.addEventListener("mousemove",this.onMouseMove),this.container.addEventListener("click",this.switchState),this.container.addEventListener("mousedown",this.switchState),this.container.addEventListener("mouseout",this.switchState),document.addEventListener("touchstart",this.onTouchStart),document.addEventListener("touchend",this.switchState),document.addEventListener("touchmove",this.switchState),this.container.addEventListener("dragstart",this.preventDefault),this.container.addEventListener("drag",this.preventDefault),this.container.addEventListener("dragend",this.preventDefault),this.container.addEventListener("contextmenu",this.preventDefault),this.container.addEventListener("touchmove",this.preventDefault)}destroy(){document.removeEventListener("mouseup",this.switchState),document.removeEventListener("keydown",this.switchState),document.removeEventListener("keyup",this.switchState),document.removeEventListener("mouseleave",this.switchState),document.removeEventListener("mousemove",this.onMouseMove),this.container.removeEventListener("click",this.switchState),this.container.removeEventListener("mousedown",this.switchState),this.container.removeEventListener("mouseout",this.switchState),document.removeEventListener("touchstart",this.onTouchStart),document.removeEventListener("touchend",this.switchState),document.removeEventListener("touchmove",this.switchState),this.container.removeEventListener("dragstart",this.preventDefault),this.container.removeEventListener("drag",this.preventDefault),this.container.removeEventListener("dragend",this.preventDefault),this.container.removeEventListener("contextmenu",this.preventDefault),this.container.removeEventListener("touchmove",this.preventDefault)}block(){if(this.state instanceof Dh)return;const{map:e}=this.modules;switch(this.container.classList.remove("mapgl-dragging"),this.container.classList.remove("mapgl-rotating"),this.state.constructor){case zh:case Hb:case ip:e.emit("interactionend",{target:"center"});break;case Fa:case Vb:e.emit("interactionend",{target:"pitch/rotation"});break;case Wb:e.emit("interactionend",{target:"zoom/rotation"});break;case Fh:case $b:e.emit("interactionend",{target:"pitch/zoom/rotation"});break;case Da:{const i=this.state.getStartedInteractionTarget();e.emit("interactionend",{target:i});break}}this.state=new Dh}unblock(){this.state instanceof Sn||this.state instanceof Dh&&(this.state=new Sn(this))}}const jN=new Set([l2]);class np extends Error{constructor(e,i){super(e),this.name="TrafficFetchMetaError",this.noRetry=i}}class VN{constructor(e,i){this.mapState=e,this.modules=i,this.fetchMetaRetryAttempt=null,this.enabled=!1,this.justEnabled=!1,this.isMetaLoading=!1,this.lastUpdateTime=-1/0,this.regionIds=new Set,this.id=Vn();const n=i.identifier.getIdScope(mn);this.gridState=$y("traffic",0,this.id,e.trafficMinZoom,e.trafficMaxZoom,e.trafficMinZoom,e.trafficMaxDetailLevel,i,e,n),this.viewportDiffer=new Et([{path:"center",type:"vec2"},{path:"zoom",type:"number"},{path:"size",type:"vec2"},{path:"rotation",type:"number"},{path:"pitch",type:"number"},{path:"demMode",type:"boolean"}])}show(){this.enabled||(this.enabled=!0,this.justEnabled=!0,this.modules.map.emit("trafficshow"))}hide(){this.enabled&&(Ll(this.gridState),this.enabled=!1,this.modules.map.emit("traffichide"))}isEnabled(){return this.enabled}destroy(){Ll(this.gridState)}redraw(){this.enabled&&(Ll(this.gridState),Cl(this.gridState,this.mapState,this.modules))}activateStyleUpdating(){this.enabled&&e0(this.gridState,this.mapState.handyStyleId,this.modules.styleManager.getStyleRevision(this.mapState.handyStyleId),this.modules.map.core.getIsFirstStyleUpdate())}finishStyleUpdating(){this.enabled&&t0(this.gridState)}update(){if(!this.enabled)return;let e=!1;if(yu(this.regionIds,this.mapState.shownRegionIds)||(this.regionIds=new Set(this.mapState.shownRegionIds),e=!0),Date.now()-this.lastUpdateTime>ki.updateInterval&&(e=!0,this.fetchMetaRetryAttempt=null),this.fetchMetaRetryAttempt!==null&&this.fetchMetaRetryAttempt<ki.fetchMetaRetryDelays.length&&Date.now()-this.lastUpdateTime>ki.fetchMetaRetryDelays[this.fetchMetaRetryAttempt]&&(this.fetchMetaRetryAttempt++,e=!0),e&&this.fetchMeta(),this.timestamp===void 0)return;(this.viewportDiffer.check(this.mapState)||this.justEnabled)&&(this.justEnabled=!1,Cl(this.gridState,this.mapState,this.modules),this.modules.renderer.addRerenderEvent());const i={...this.gridState.displayedMods};Ky(this.gridState,this.mapState,this.modules),this.fetch(jy(this.gridState),this.timestamp),this.abortFetch(Vy(this.gridState)),this.generate(Hy(this.gridState)),this.clearTiles(Zy(this.gridState)),Xy(this.modules,this.mapState,this.gridState,i)}viewportTilesReady(){return n_(this.gridState.tiles,this.gridState.viewportTiles)}getMemoryFootprint(){const e=this.gridState,i={gridState:{displayedMods:Object.keys(e.displayedMods).map(s=>wd(e.displayedMods[s])),tileModsCache:e.tileModsCache.keys().filter(s=>!e.displayedMods[s]).map(s=>wd(e.tileModsCache.get(s)))}},n={gridState:{displayedMods:Object.keys(e.displayedMods).map(s=>bd(e.displayedMods[s])),tileModsCache:e.tileModsCache.keys().filter(s=>!e.displayedMods[s]).map(s=>bd(e.tileModsCache.get(s)))}};return{js:{...i,"--sum":ui(i)},gpu:{...i,"--sum":ui(n)}}}fetch(e,i){e.sort((n,s)=>Yr(this.mapState.center,n,s)).forEach(n=>HN(n,this.modules,this.mapState,this.regionIds,i))}abortFetch(e){e.forEach(i=>{this.modules.workers.parser.abortTrafficTileRequest(i.key)})}generate(e){e.sort((i,n)=>Yr(this.mapState.center,i,n)).forEach(i=>{const n=Uy(i);n&&this.modules.workers.parser.generateTrafficTile({styleId:this.mapState.handyStyleId,coords:i.coords,pixelRatio:window.devicePixelRatio,styleState:this.mapState.styleState,sourceId:this.modules.defaultSource.getId()}).then(s=>{if(!s){tv("traffic");return}Array.isArray(s.results)&&Dy(n,s.results)})})}clearTiles(e){for(const i of e)this.modules.workers.parser.deleteTrafficTile(i.key),delete this.gridState.tiles[i.key]}fetchMeta(){if(this.isMetaLoading||!this.regionIds.size)return;if(yu(this.regionIds,jN)){console.warn("Traffic metadata request skip: only Universe"),this.lastUpdateTime=Date.now();return}this.isMetaLoading=!0;const e=this.mapState,i=Jo(ki.timestampUrl,{host:e.trafficServer,protocol:e.trafficProtocol||e.tileProtocol,regions:Array.from(this.regionIds).join(",")});fetch(i).then(n=>{if(n.ok)return n.json();throw new np(`Request traffic timestamp error with status ${n.status}`,!1)}).then(n=>{var o,r;if(!n.length||((o=n[0])==null?void 0:o.time)===void 0||((r=n[0])==null?void 0:r.score)===void 0)throw new np(`Bad traffic timestamp and score response ${n.toString()}`,!0);let s=0;n.forEach(a=>s+=a.score),s=Math.round(s/n.length),this.modules.map.emit("trafficscore",{score:s}),this.timestamp=n[0].time,this.isMetaLoading=!1,this.lastUpdateTime=Date.now(),this.fetchMetaRetryAttempt=null,this.redraw()}).catch(n=>{!(n instanceof np)||!n.noRetry?this.fetchMetaRetryAttempt=this.fetchMetaRetryAttempt??0:this.fetchMetaRetryAttempt=null,this.lastUpdateTime=Date.now(),this.isMetaLoading=!1,console.error(n)})}}function HN(t,e,i,n,s){n.size&&e.workers.parser.fetchTrafficTile({coords:t.coords,tileServer:i.trafficServer,tileProtocol:i.trafficProtocol||i.tileProtocol,regionIds:Array.from(n),timestamp:s}).then(()=>{t.status===mr.Loading&&(t.serverMetadata=[{regionId:0,metatileHash:-2}])})}class ZN{constructor(e){this.externalContainer=e,this.rootContainer=document.createElement("div"),this.rootContainer.style.position="relative",this.rootContainer.style.height="100%",this.rootContainer.style.width="100%",this.rootContainer.style.overflow="hidden",this.externalContainer.appendChild(this.rootContainer),this.mapContainer=document.createElement("div"),this.mapContainer.style.position="relative",this.mapContainer.style.height="100%",this.mapContainer.style.width="100%",this.mapContainer.style.touchAction="none",this.mapContainer.style.webkitUserSelect="none",this.mapContainer.style.userSelect="none",this.rootContainer.appendChild(this.mapContainer),this.canvas=document.createElement("canvas"),this.canvas.style.display="block",this.mapContainer.appendChild(this.canvas),this.htmlContainerInMap=document.createElement("div"),this.htmlContainerInMap.style.position="absolute",this.htmlContainerInMap.style.left="0",this.htmlContainerInMap.style.top="0",this.htmlContainerInMap.style.width="100%",this.htmlContainerInMap.style.height="0",this.htmlContainerInMap.style.webkitUserSelect="auto",this.htmlContainerInMap.style.userSelect="auto",this.mapContainer.appendChild(this.htmlContainerInMap),this.htmlContainerOutMap=document.createElement("div"),this.htmlContainerOutMap.style.position="absolute",this.htmlContainerOutMap.style.left="0",this.htmlContainerOutMap.style.top="0",this.htmlContainerOutMap.style.width="100%",this.htmlContainerOutMap.style.height="0",this.mapContainer.after(this.htmlContainerOutMap)}setCanvasSize(e,i){const n=window.devicePixelRatio;return this.canvas.width=e*n,this.canvas.height=i*n,this.canvas.style.width=e+"px",this.canvas.style.height=i+"px",this}destroy(){for(;this.externalContainer.lastChild;)this.externalContainer.removeChild(this.externalContainer.lastChild)}isActionWithCanvas(e){return e.target===this.canvas}isActionWithMap(e){return e instanceof MouseEvent||e instanceof KeyboardEvent?this.isTargetInMap(e.target):Array.from(e.touches).map(n=>n.target).some(n=>this.isTargetInMap(n))}isTargetInMap(e){return!e||!(e instanceof Node)?!1:this.mapContainer.contains(e)}}class $N{constructor(e){this.loadingCounter=0,this.isIdle=()=>this.loadingCounter===0,this.modules=e,this.textureKeys=[],this.texturesMap=new Map}async addTexture(e,i){this.loadingCounter++;const n=await yh(e);return this.storeTexture(n,i)}addPreparedTexture(e){const i=`prepared-${Vn()}`;return this.textureKeys.push(i),this.texturesMap.set(i,e),this.textureKeys.length-1}updatePreparedTexture(e,i){this.deleteTexture(e),this.texturesMap.set(this.textureKeys[e],i)}async loadTexture(e,i){this.loadingCounter++;const n=await this.loadImage(e);if(!n){this.decreaseLoadingCounter();return}return this.storeTexture(n,i)}getTexture(e){return this.texturesMap.get(this.textureKeys[e])}destroy(){this.textureKeys=[],this.texturesMap.clear()}deleteTexture(e){var n;const i=this.textureKeys[e];return(n=this.texturesMap.get(i))==null||n.remove(),this.texturesMap.delete(i)}getMemoryFootprint(){const e={texturesMap:Array.from(this.texturesMap.values()).map(Rl)},i={texturesMap:Array.from(this.texturesMap.values()).map(yd)};return{js:{...e,"--sum":ui(e)},gpu:{...i,"--sum":ui(i)}}}decreaseLoadingCounter(){this.loadingCounter=Math.max(this.loadingCounter-1,0)}storeTexture(e,i){const n=i==null?void 0:i.size,s=(i==null?void 0:i.pixelRatio)??window.devicePixelRatio,o=(i==null?void 0:i.imagePadding)??1;this.decreaseLoadingCounter();const r=e.getAttribute("src")||e.currentSrc,a=WN(r,n),l=this.textureKeys.indexOf(a);if(l>-1&&this.texturesMap.has(a))return l;const c=this.modules.renderer.getRenderingContext(),d=(n?[n[0],n[1]]:[e.width,e.height]).map(m=>m*s),h=Bw(e,d);e.remove();const u=d.map(m=>m+2*o);if(!(i!=null&&i.skipAtlasSizeChecking)&&(u[0]>Gt[0]||u[1]>Gt[1]))throw new Error(`Image texture dimensions ${u} are larger than the maximum possible ${Gt}`);const f=new j(void 0,{size:u,flipY:!1,magFilter:j.LinearFilter,minFilter:j.LinearFilter}).prepare(c);return f.subImage(c,h,o,o),h.remove(),this.texturesMap.set(a,f),this.textureKeys.push(a),this.modules.renderer.addRerenderEvent(),this.textureKeys.length-1}async loadImage(e){return new Promise(i=>{const n=new Image;n.crossOrigin="Anonymous",n.src=e,n.onload=()=>i(n),n.onerror=()=>i(void 0)})}}function WN(t,e){const i=e!==void 0?`_${e[0]},${e[1]}`:"";return`${t}${i}`}const Xb=!0,Yb=!1,qb=!1,Kb=[0];class XN{constructor(e){this.isLoading=!1,this.attempts=0,this.getKeyInfo=async()=>await this.request,this.isIdle=()=>!this.isLoading;const{tileKey:i,keyUrl:n}=e;if(i===Xe.tileKey)this.request=Promise.resolve({showCommPoi:!1,urbi:!1,hideCopyright:!0});else{const s=Ka(n,{keyID:i});this.isLoading=!0;const o=async()=>Kb.length>=this.attempts?(this.attempts&&(await new Promise(r=>{this.lastTimeout=window.setTimeout(r,Kb[this.attempts]*1e3)}),this.clearLastTimeout()),this.attempts++,fetch(s).then(r=>r.ok?r.json():o(),o)):(console.error("Could not load tile key info. A style layers with commercial POI will be added to applied styles."),Promise.resolve(void 0));this.request=o().then(r=>{if(this.isLoading=!1,!r||!r.result||r.meta.code!==200)return{showCommPoi:Xb,hideCopyright:qb,urbi:Yb,error:!0};const{showCommPoi:a,hideCopyright:l,urbi:c}=r.result.service.properties.public;return{showCommPoi:wu(a)?Xb:!!a,hideCopyright:wu(l)?qb:!!l,urbi:wu(c)?Yb:!!c}})}}destroy(){this.clearLastTimeout()}clearLastTimeout(){this.lastTimeout!==void 0&&(clearTimeout(this.lastTimeout),this.lastTimeout=void 0)}}class YN{constructor(){this.sources=[],this.viewportSources=[]}addSource(e){this.sources.push(e),e.type==="geojson"&&e.subtype==="viewport-internal"&&e instanceof Id&&this.viewportSources.push(e)}removeSource(e){this.sources=this.sources.filter(i=>i.getId()!==e),this.viewportSources=this.viewportSources.filter(i=>i.getId()!==e)}getSourceById(e){return this.sources.find(i=>i.getId()===e)}updateViewportSources(){this.viewportSources.forEach(e=>e.update())}}class qN{constructor(e){this.modules=e,this.id=vr(),this.type="globe"}destroy(){}update(){}fetchTile(e,i){return Promise.resolve([])}generateTile(e,i,n,s,o,r){const a=Ye(i),l=this.modules.collector,c=this.modules.styleManager.getStyle(n);if(!c||!c.environment)return Promise.resolve({results:[]});vt({collector:l,generator:ya.sinks.fill.generate,args:[c,c.environment,a]});const d=l.getAccumulatedData();return Promise.resolve({results:[{styleId:n,metatileHash:-1,regionId:-1,collectorOutput:d}]})}abortTileFetch(e){}deleteTile(e){}setAttributes(e){}getAttributes(){return{}}}const Jb="gltfModels";let Qb=class{constructor(e,i){this.modules=i,this.type="default",this.id=vr(),this.state=e,this.options={tileServer:e.tileServer,tileSet:e.tileSet,tileProtocol:e.tileProtocol,tileKey:e.tileKey,subdomains:e.subdomains,appId:e.appId,defaultLang:e.tileServerDefaultLang,sessionId:e.tileSessionId??e.sessionId,isDefaultSource:!0,modelsPath:e.defaultSourceModelsRootUrl,promoteId:"id",idScope:mn,identifyAsDefaultSource:!0},this.modelsAppearStrategy=e.defaultSourceModelsAppearStrategy??qh,this.zenithSource=new o0(this.id,this.modules,this.options),this.universeTileLayer=new os(0,Xe.maxUniverseZoom,0,Xe.maxUniverseZoom,this.modules,e,this.zenithSource,{requestOddTiles:e.mobileSdkMode}),this.universeTileLayer.getLabelingData=()=>{const n=os.prototype.getLabelingData.call(this.universeTileLayer);return this.regionalTileLayer.isBlank()||(n.labelsKeys=[]),n},this.modules.tileManager.addTileLayer(this.universeTileLayer),this.regionalTileLayer=new os(Xe.maxUniverseZoom+1,Xe.maxRegionalZoom,Xe.maxUniverseZoom+1,Xe.maxDetailLevel,this.modules,e,this.zenithSource,{requestOddTiles:e.mobileSdkMode}),this.modules.tileManager.addTileLayer(this.regionalTileLayer),this.commercialPoiSource=new h_(this.id,this.modules,{url:Pu("commercialPoi",{host:e.tileServer,tileSet:e.commercialTileSet,protocol:Xe.protocol,lang:e.lang}),flipY:!0,identifyAsDefaultSource:!0,promoteId:"db_id"}),this.commercialPoiTileLayer=new os(Fr.minZoom,Fr.maxZoom,Fr.minZoom,xd,this.modules,e,this.commercialPoiSource,{viewportPadding:Yh}),this.modules.tileManager.addTileLayer(this.commercialPoiTileLayer),this.createModelsSource(),this.modules.sourceStorage.addSource(this)}destroyModelsSource(){this.modelsSource&&(this.modelsSource=null,this.modelsTileLayer&&this.modules.tileManager.removeTileLayer(this.modelsTileLayer))}createModelsSource(){this.modelsSource||(this.modelsSource=new h_(this.id,this.modules,{minZoom:Uo.minZoom,maxZoom:Uo.maxZoom,url:Pu({url:this.state.modelsTilesUrl},{host:this.state.tileServer,tileSet:this.state.modelsTileSet,protocol:Xe.protocol,lang:this.state.lang}),ignoreMissingTiles:!0,identifyAsDefaultSource:!0,promoteId:"building_id",modelsPath:this.state.defaultSourceModelsRootUrl??Pu("gltfModel",{host:this.state.tileServer,tileSet:this.state.tileSet,protocol:Xe.protocol,lang:this.state.lang}),flipY:!0,attributes:{sourceName:Jb}}),this.modelsTileLayer=new os(Uo.minZoom,Uo.maxZoom,Uo.minZoom,Xe.maxDetailLevel,this.modules,this.state,this.modelsSource,{viewportPadding:Yh}),this.modules.tileManager.addTileLayer(this.modelsTileLayer))}getMemoryFootprint(){const e={regionalTileLayer:this.regionalTileLayer.memSizeJs(),universeTileLayer:this.universeTileLayer.memSizeJs(),modelsTileLayer:this.modelsTileLayer?this.modelsTileLayer.memSizeJs():{},...this.commercialPoiTileLayer&&{commercialPoiTileLayer:this.commercialPoiTileLayer.memSizeJs()}},i={regionalTileLayer:this.regionalTileLayer.memSizeGpu(),universeTileLayer:this.universeTileLayer.memSizeGpu(),modelsTileLayer:this.modelsTileLayer?this.modelsTileLayer.memSizeGpu():{},...this.commercialPoiTileLayer&&{commercialPoiTileLayer:this.commercialPoiTileLayer.memSizeGpu()}};return{js:{...e,"--sum":ui(e)},gpu:{...i,"--sum":ui(i)}}}destroy(){var e,i;this.modules.tileManager.removeTileLayer(this.universeTileLayer),this.universeTileLayer.destroy(),this.modules.tileManager.removeTileLayer(this.regionalTileLayer),this.regionalTileLayer.destroy(),this.zenithSource.destroy(),this.commercialPoiTileLayer&&(this.modules.tileManager.removeTileLayer(this.commercialPoiTileLayer),this.commercialPoiTileLayer.destroy()),(e=this.commercialPoiSource)==null||e.destroy(),this.modelsTileLayer&&(this.modules.tileManager.removeTileLayer(this.modelsTileLayer),this.modelsTileLayer.destroy()),(i=this.modelsSource)==null||i.destroy(),this.modules.sourceStorage.removeSource(this.id),this.removeGlobeSource()}setAttributes(e){var i,n,s;this.zenithSource.setAttributes({...e,...Tg}),this.universeTileLayer.redraw(),this.regionalTileLayer.redraw(),(i=this.commercialPoiSource)==null||i.setAttributes(e),(n=this.commercialPoiTileLayer)==null||n.redraw(),(s=this.modelsSource)==null||s.setAttributes({...e,sourceName:Jb}),this.modelsTileLayer&&this.modelsTileLayer.redraw()}getAttributes(){return this.zenithSource.getAttributes()}getId(){return this.id}getZoomDirection(){return this.regionalTileLayer.getZoomDirection()}setHoverId(e){this.regionalTileLayer.setHoverId(e)}setDisabledRegionsId(e){this.regionalTileLayer.disabledRegions=e,this.universeTileLayer.disabledRegions=e}resetHoverId(){this.regionalTileLayer.resetHoverId()}setFeatureStateMap(e){var i,n;this.zenithSource.setFeatureStateMap(e),(i=this.modelsSource)==null||i.setFeatureStateMap(e),this.universeTileLayer.onFeatureStateMapChange(),this.regionalTileLayer.onFeatureStateMapChange(),(n=this.modelsTileLayer)==null||n.onFeatureStateMapChange(),this.modules.modelLayer.onFeatureStateMapChange()}generateHoverTile(e,i,n,s,o,r,a,l){return this.zenithSource.generateTile(e,i,n,s,o,r,a,l)}generateModel(e){return this.zenithSource.generateModel(e)}isIdentifiedAsDefault(){return!0}setDataType(e){this.options.dt!==e&&(!this.options.dt||!e||!hg(this.options.dt,e))&&(this.options.dt=e,this.regionalTileLayer.redraw())}getDataType(){return this.options.dt}setDataFilter(e){var i;this.zenithSource.setDataFilter(e),(i=this.modelsSource)==null||i.setDataFilter(e)}hasLayer(e){return this.modelsTileLayer===e||this.regionalTileLayer===e||this.universeTileLayer===e||this.commercialPoiTileLayer===e}addGlobeSource(){const{modules:e}=this,i=e.map.state;e.styleManager.getStyleLayer(i.handyStyleId,ga)&&(this.globeSource=new qN(this.modules),this.globeTileLayer=new os(i.minZoom,In.globeMaxZoom,i.minZoom,In.globeMaxZoom,e,e.map.state,this.globeSource),e.tileManager.addTileLayer(this.globeTileLayer))}removeGlobeSource(){this.globeSource&&(this.globeSource.destroy(),this.globeSource=void 0),this.globeTileLayer&&(this.modules.tileManager.removeTileLayer(this.globeTileLayer),this.globeTileLayer.destroy(),this.globeTileLayer=void 0)}isGlobeTilesReady(){return this.globeTileLayer?this.globeTileLayer.viewportTilesReady()&&!this.globeTileLayer.isEmpty():!1}};const KN={dead:!0,alive:!0,unused:!0,commercialDead:!1,commercialAlive:!1};class JN{constructor(e,i){this.mapState=e,this.modules=i,this.options={},this.viewportDiffer=new Et([{path:"center",type:"vec2"},{path:"zoom",type:"number"},{path:"size",type:"vec2"},{path:"rotation",type:"number"},{path:"pitch",type:"number"},{path:"padding",type:"padding"},{path:"demMode",type:"boolean"}]),this.sizeDiffer=new Et([{path:"size",type:"vec2"}])}update(){this.isEnabled()&&(this.sizeDiffer.check(this.mapState)&&this.updateSize(),this.viewportDiffer.check(this.mapState)&&this.clear())}isEnabled(){return!!this.canvas}show(e=KN){this.options=e,Object.values(e).every(n=>n===!1)?this.hide():(this.createCanvas(),this.mapState.needLabeling=!0)}hide(){this.canvas&&(this.modules.layout.mapContainer.removeChild(this.canvas),this.ctx=void 0,this.canvas=void 0)}drawLabels(e){if(!this.canvas||!this.ctx)return;const i=this.ctx,n=this.options,s={[xi.Dead]:"#ff0000",[xi.Alive]:"#30763c",[xi.Unused]:"#aaa",[xi.CommercialAlive]:"#3a9f22",[xi.CommercialDead]:"#ff0000"},o=new Int32Array(e),r={[xi.Dead]:[],[xi.Alive]:[],[xi.Unused]:[],[xi.CommercialAlive]:[],[xi.CommercialDead]:[]};for(let c=0;c<o.length;c+=5){const d=o[c+4];r[d].push({x:o[c],y:o[c+1],width:o[c+2],height:o[c+3]})}this.clear();const a=window.devicePixelRatio,l=c=>{i.strokeStyle=s[c],r[c].forEach(d=>i.strokeRect(d.x*a+.5,d.y*a+.5,d.width*a,d.height*a))};i.setLineDash([]),n.unused&&l(xi.Unused),n.dead&&l(xi.Dead),n.alive&&l(xi.Alive),i.setLineDash([6]),n.commercialDead&&l(xi.CommercialDead),n.commercialAlive&&l(xi.CommercialAlive)}clear(){if(this.canvas&&this.ctx){const{clientWidth:e,clientHeight:i}=this.canvas;this.ctx.clearRect(0,0,e*window.devicePixelRatio,i*window.devicePixelRatio)}}createCanvas(){this.canvas||(this.canvas=document.createElement("canvas"),this.canvas.style.position="absolute",this.canvas.style.left="0",this.canvas.style.top="0",this.canvas.style.pointerEvents="none",this.modules.layout.mapContainer.appendChild(this.canvas),this.ctx=this.canvas.getContext("2d")||void 0,this.updateSize())}updateSize(){if(!this.canvas)return;const{clientWidth:e,clientHeight:i}=this.modules.layout.rootContainer;this.canvas.width=e*window.devicePixelRatio,this.canvas.height=i*window.devicePixelRatio,this.canvas.style.width=e+"px",this.canvas.style.height=i+"px"}}const QN=Oe();class e5{constructor(e){this.globHaloStops=[-2.5,0,1.5,13],this.globeHaloExpFactor=-1,this.fogLimits=new Float32Array([3.7,4.5]),this.fogHorizonBlend=.12,this.fogHorizonLevel=-.07,this.squaredDistMaxFog=0,this.lastStyleId=NaN,this.starsCount=2e4,this.starsGenerationCtx={randomSeed:12345},this.starsUpdateNeeded=!0,this.modules=e;const i=this.modules.renderer.getShaderProgram("sky"),n=new R(new Float32Array([-1,-1,1,-1,1,1,-1,1]));this.vao=tC(n,i)}update(){this.updateFog();const e=this.modules.map.state;isNaN(e.handyStyleId)||this.lastStyleId!==e.handyStyleId&&(this.updateSky(),this.updateStars(),this.lastStyleId=e.handyStyleId)}setParameters(e){const i=this.modules.map.state;e.min!==void 0&&(this.fogLimits[0]=e.min),e.max!==void 0&&(this.fogLimits[1]=e.max),e.horizonBlend!==void 0&&(this.fogHorizonBlend=e.horizonBlend),e.horizonLevel!==void 0&&(this.fogHorizonLevel=e.horizonLevel);const n=this.modules.styleManager.getStyleLayer(i.handyStyleId,ga);n&&(e.fogColor!==void 0&&(n.style.fogColor=Yn(e.fogColor)?qn(e.fogColor):e.fogColor),e.skyColor!==void 0&&(n.style.skyColor=Yn(e.skyColor)?qn(e.skyColor):e.skyColor),this.modules.renderer.addRerenderEvent())}renderSky(e){if(!this.isSkyEnabled())return;const i=this.modules.renderer.webGlExtensions,n=this.modules.renderer.lastAppliedGlState;vn(e,_i,n);const s=this.modules.renderer.getShaderProgram("sky");s.enable(e),e instanceof WebGLRenderingContext&&(K0(e,s,this.modules.map.state,this.modules),we(e,s,this.modules.map.state,this.modules),ye(e,s,this.modules.map.state,this.modules)),this.vao.bind({gl:e,extensions:i}),e.drawArrays(e.TRIANGLE_FAN,0,4)}renderStars(e){if(!this.starsVao)return;const i=this.modules.renderer.lastAppliedGlState;vn(e,_i,i);const n=this.modules.renderer.getShaderProgram("stars");n.enable(e),e instanceof WebGLRenderingContext&&J0(e,n,this.modules.map.state,this.modules),this.starsVao.bind({gl:e,extensions:this.modules.renderer.webGlExtensions}),e.drawArrays(e.POINTS,0,this.starsCount)}renderGlobeHaloBackground(e){const i=this.modules.renderer.webGlExtensions,n=this.modules.renderer.lastAppliedGlState;vn(e,_i,n);const s=this.modules.renderer.getShaderProgram("globeHaloBackground");s.enable(e),e instanceof WebGLRenderingContext&&F_(e,s,this.modules.map.state,this.modules),this.vao.bind({gl:e,extensions:i}),e.drawArrays(e.TRIANGLE_FAN,0,4)}renderGlobeHalo(e){const i=this.modules.renderer.webGlExtensions,n=this.modules.renderer.lastAppliedGlState;vn(e,wC,n);const s=this.modules.renderer.getShaderProgram("globeHalo");s.enable(e),e instanceof WebGLRenderingContext&&F_(e,s,this.modules.map.state,this.modules),this.vao.bind({gl:e,extensions:i}),e.drawArrays(e.TRIANGLE_FAN,0,4)}isFogEnabled(){var o,r;if(this.modules.map.getFeatureFlag("fogOff")||!((o=this.envStyleLayer)!=null&&o.style.fogColor))return!1;const{styleZoom:e,styleState:i}=this.modules.map.state,n=ut(e,i,[]),s=ze((r=this.envStyleLayer)==null?void 0:r.style.fogColor,n);return s&&s.value[3]!==0}isSkyEnabled(){var o,r;if(this.modules.map.getFeatureFlag("skyOff")||!((o=this.envStyleLayer)!=null&&o.style.skyColor))return!1;const{styleZoom:e,styleState:i}=this.modules.map.state,n=ut(e,i,[]),s=ze((r=this.envStyleLayer)==null?void 0:r.style.skyColor,n);return s&&s.value[3]!==0}isPointInFog(e){const i=this.modules.camera;return w2(e,i.position)>this.squaredDistMaxFog}isAABBInFog(e){if(!this.modules.environmentManager.isFogEnabled())return!1;const i=this.modules.camera,n=wg(i.position,e.min,e.max,QN);return this.isPointInFog(n)}updateSky(){const e=this.modules.styleManager.getStyleLayer(this.modules.map.state.handyStyleId,ga);this.envStyleLayer=e}updateStars(){if(!this.starsUpdateNeeded)return;this.starsUpdateNeeded=!1;const e=bM(this.starsGenerationCtx,this.starsCount),i=4,n=new Float32Array(i*e.length);for(let r=0;r<e.length;++r){const a=e[r],l=Lc(this.starsGenerationCtx,0,1);n[i*r]=a[0],n[i*r+1]=a[1],n[i*r+2]=a[2],n[i*r+3]=l}const s=new R(n),o=this.modules.renderer.getShaderProgram("stars");this.starsVao=nC(s,o)}updateFog(){const e=this.modules.camera;this.squaredDistMaxFog=(e.fogDistance*this.fogLimits[1])**2}}class t5{constructor(e,i){this.mapState=e,this.mapModules=i,this.state={}}add(e,i=0,n=1,s=Go.easing,o=Go.duration){this.state[e]||(this.state[e]={tickerConfig:{start:i,end:n,duration:o,easing:s},tickerKey:"",readiness:i===n?1:0})}has(e){return!!this.state[e]}remove(e){this.state[e]&&delete this.state[e];const i=this.buildTickerKey(e);Jf(i,this.mapState)&&yt(i,this.mapState)}getReadiness(e){var i;return(i=this.state[e])==null?void 0:i.readiness}isAnimating(e){if(!e){for(const i in this.state)if(Al(this.state[i].tickerKey,this.mapState)!==void 0)return!0;return!1}return this.state[e]?Al(this.state[e].tickerKey,this.mapState)!==void 0:!1}update(){const e=[];for(const i in this.state){const n=this.state[i];if(this.mapModules.tileManager.viewportTilesReady()){const s=n.readiness,{start:o,end:r,duration:a,easing:l}=n.tickerConfig;if(n.tickerKey)kt(n.tickerKey,{step:(c,d)=>{n.readiness=d}},this.mapState);else{const c=this.buildTickerKey(i);n.tickerKey=c,Bt(c,{easing:l},this.mapState,o,r,a,1)}n.readiness===1&&s!==1&&e.push(i)}}return e}buildTickerKey(e){return`gltf-${e}`}}const i5=!1,n5=!0,sp="#ffffffff",s5=0,o5=0,r5=1,op=15,a5=Mt(op)/Ge,Oh=xe/2,l5=["coordinates","rotation","scale","offset"];let ex=class bp extends Zi{constructor(e,i){var S,P,T;super(e,{interactive:i.interactive??!1}),this.map=e,this.needRerender=()=>this.isVisible()&&Xr(Wn(this.position.normalizedValue),this.mapState.tilesBounds,this.modules,Yh),this.hovered=!1,this.selected=!1,this.status=i.hideOnInit?"hidden":"visible",this.interactiveOcclusion=i.interactiveOcclusion??n5,this.throttledIdentifierUpdate=i.throttledIdentifierUpdate??i5,this.disableAnimation=i.disableAnimation,this.linkedIds=i.linkedIds,this.planId=i.planId,this.tickerNames=new Map;const n=Z.fromGeo(i.coordinates);this.position={userValue:n,normalizedValue:Li(n)};const{dynamicStyle:s,collector:o,tileManager:r,layers:a,assetManager:l}=this.modules,{ignoreGlobalLighting:c,colorTextureUvIndex:d,nearCameraFade:h,showRatio:u,playAnimation:f}=i,m=sx(i.rotation??s5),p=i.scale??r5,_=ox(i.offset??o5,i.coordinates[1]);if(this.appliedTransformations={scale:p,rotation:m,offset:_},this.layer=_t({type:"model",id:`dynamic-gltf-model-${this.uniqId}`,style:{modelSrc:["get","model_src"],rotation:Array.isArray(m)?["literal",m]:m,scale:Array.isArray(p)?["literal",p]:p,offset:Array.isArray(_)?["literal",_]:_,linkedIds:["get","linkedIds"],ignoreGlobalLighting:c,colorTextureUvIndex:d,nearCameraFade:h,showRatio:u,playAnimation:f,color:["match",["objectAttr","hovered"],[!0],((S=i.hover)==null?void 0:S.color)||sp,["match",["objectAttr","selected"],[!0],((P=i.select)==null?void 0:P.color)||sp,i.color||sp]]},minzoom:i.minZoom,maxzoom:i.maxZoom,interactive:this.interactive,interactiveOcclusion:this.interactiveOcclusion}),!this.layer)return;(T=i.hover)!=null&&T.color&&(this.on("mouseover",this.switchToHoveredColor),this.on("mouseout",this.switchToNormalColor)),s.addLayer(this.layer,i.zIndex);const g=Kr(this.position.normalizedValue,op),y=rs({model_src:i.modelSrc,linkedIds:i.linkedIds,db_plan_id:i.planId}),b=di(this.mapState.styleState,un,yi,y,Hi,i.interactive?"0":"");Zt(this.layer,b),vt({collector:o,generator:ss.generateInstances,args:[s.getStyle(),this.layer,b,{x:[Oh],y:[Oh],abs_z:[this.position.userValue[2]??0]},Ye(g),NaN]});const v=o.getAccumulatedData(),I=new Ct("dynamicObject",v.data,this.modules,this.mapState,g,this);l.fillDataModelUrlMap(v.dataModelsUrls),this.modelId=v.dataModelsUrls[i.modelSrc],this.modelId!==void 0&&(l.loadModel(i.modelSrc,this.modelId,Lo,!0,this.layer,()=>{this.status==="visible"&&(r.addObject(I),this.modules.renderer.addRerenderEvent(),this.linkedIds&&this.map.hideBuildingsById(this.linkedIds),this.updateIdentifier()),setTimeout(()=>this.emit("modelloaded"),0)}),this.tileObjects.push(I),i.interactive&&this.identifyIds.push(v.identifyIds),a.addLayer(this),o.reset(),this.status==="visible"&&this.hideLinkedObjects())}update(){if(super.update(),!this.tickerNames.size)return;const e=[],i={};this.tickerNames.forEach((n,s)=>{kt(n,{step:(o,r)=>{i[s]=r},complete:()=>{e.push(s)}},this.mapState)}),(i.coordinates!==void 0||i.rotation!==void 0||i.scale!==void 0||i.offset!==void 0)&&this.applyTransformations(i.coordinates,i.rotation,i.scale,i.offset),e.forEach(n=>{this.tickerNames.delete(n)}),this.interactive&&this.needRerender()&&(this.throttledIdentifierUpdate?this.mapState.stillness===1&&this.modules.identifier.throttledFillCache():this.tickerNames.size||this.modules.identifier.debouncedFillCache())}setState({hovered:e,selected:i}){e!==void 0&&e!==this.hovered&&(this.hovered=e,this.modules.renderer.addRerenderEvent()),i!==void 0&&i!==this.selected&&(this.selected=i,this.modules.renderer.addRerenderEvent())}isAnimationDisabled(){return this.disableAnimation}getLinkedIds(){return this.linkedIds}isVisible(){return this.status==="visible"}hide(){this.status==="visible"&&(this.status="hidden",this.tileObjects.forEach(e=>{this.modules.tileManager.removeObject(e)}),this.showHiddenBuildings(),this.showLinkedObjects(),this.mapState.shouldIsIdleWaitForUpdates=!0,this.modules.renderer.addRerenderEvent(),this.updateIdentifier())}isOutOfMainReplica(){return!1}show(){this.status==="hidden"&&(this.status="visible",this.tileObjects.forEach(e=>{this.modules.tileManager.addObject(e)}),this.linkedIds&&this.map.hideBuildingsById(this.linkedIds),this.hideLinkedObjects(),this.mapState.shouldIsIdleWaitForUpdates=!0,this.modules.renderer.addRerenderEvent(),this.updateIdentifier())}destroy(e){this.status!=="destroyed"&&(this.stopTransformation(),this.status="destroyed",this.modelId!==void 0&&!this.modules.layers.getDynamicObjectLayers().filter(n=>n instanceof bp&&n!==this).some(n=>n.modelId===this.modelId)&&!e&&this.modules.assetManager.removeModel(String(this.modelId)),this.updateIdentifier(),this.layer&&this.modules.dynamicStyle.removeLayer(this.layer.innerId),this.showHiddenBuildings(),this.off("mouseover",this.switchToHoveredColor),this.off("mouseout",this.switchToNormalColor),this.showLinkedObjects(),super.destroy())}transform(e){var s;if(this.status==="destroyed"||!this.layer)return;this.stopTransformation();const i={};e.forEach(o=>{const r=d5(o);if(!r)return;const{duration:a=0,easing:l="linear"}=o;i[r]={value:o[r],duration:a,easing:l}});const n={};for(const o in i){if(!c5(o)||i[o]===void 0)continue;let r;if(o==="coordinates"?r=Z.fromGeo(i[o].value):o==="offset"?r=ox(i[o].value,((s=i.coordinates)==null?void 0:s.value[1])??Z.toGeo(this.position.userValue)[1]):r=i[o].value,!i[o].duration){n[o]=r;continue}const a=`dynamicGltfModel-${o}-${this.uniqId}`;let l,c;if(o==="coordinates")l=this.position.userValue,c=r;else{const d=[0,0,0];Gn(this.appliedTransformations[o],d),l=d;const h=[0,0,0];Gn(r,h),c=h}Bt(a,{easing:i[o].easing,renderAfterUpdate:this.needRerender},this.mapState,l,c,i[o].duration,1,{layerId:this.layer.innerId,styleId:Lo}),this.tickerNames.set(o,a)}(n.coordinates!==void 0||n.rotation!==void 0||n.scale!==void 0||n.offset!==void 0)&&(this.applyTransformations(n.coordinates,n.rotation,n.scale,n.offset),this.modules.renderer.addRerenderEvent(),this.updateIdentifier())}stopTransformation(){this.tickerNames.forEach(e=>{yt(e,this.mapState)}),this.tickerNames.clear()}getCoordinates(){return Z.toGeo(this.position.userValue)}getScale(){const e=[0,0,0];return Gn(this.appliedTransformations.scale,e),e}getRotation(){const e=[0,0,0];return Gn(this.appliedTransformations.rotation,e),e}getOffset(){const e=[0,0,0];return Gn(this.appliedTransformations.offset,e),e}applyTransformations(e,i,n,s){var l;const o=this.tileObjects[0];if(!o)return;const r=o.buffers[0];if(!r)return;if(e&&(this.position={userValue:e,normalizedValue:Li(e)},o.setTileCoords(Kr(this.position.normalizedValue,op),this.mapState)),i!==void 0||n!==void 0){const c=sx(i??this.appliedTransformations.rotation),d=n??this.appliedTransformations.scale;this.appliedTransformations.rotation=c,this.appliedTransformations.scale=d}if(s!==void 0){const c=s??this.appliedTransformations.offset;this.appliedTransformations.offset=c}const a=this.modules.renderer.getRenderingContext();Gn(this.appliedTransformations.offset,nx),Gn(this.appliedTransformations.scale,tx),Gn(this.appliedTransformations.rotation,ix),ss.patchBuffer(a,r,0,Ye(o.coords),[Oh,Oh,this.position.userValue[2]??0],nx,tx,ix,(((l=this.layer)==null?void 0:l.minzoom)??0)<In.globeMaxZoom)}switchToHoveredColor(){this.hovered=!0,this.modules.renderer.addRerenderEvent()}switchToNormalColor(){this.hovered=!1,this.modules.renderer.addRerenderEvent()}updateIdentifier(){this.interactive&&this.modules.identifier.resetCache()}showLinkedObjects(){const e=this.planId?Xf:Yf;this.linkedIds&&this.modules.identifier.getIdScope(e).show(this.linkedIds)}hideLinkedObjects(){const e=this.planId?Xf:Yf;this.linkedIds&&this.modules.identifier.getIdScope(e).hide(this.linkedIds)}showHiddenBuildings(){if(!this.linkedIds)return;const e=this.modules.layers.getDynamicObjectLayers().filter(i=>i instanceof bp&&i!==this&&i.isVisible());this.linkedIds.forEach(i=>{e.every(s=>{var o;return!((o=s.getLinkedIds())!=null&&o.includes(i))})&&this.map.showHiddenBuildingsById([i])})}};const tx=[0,0,0],ix=[0,0,0],nx=[0,0,0];function sx(t){return Array.isArray(t)?t.map(e=>e%360):t%360}function ox(t,e){const i=a5/Z.scaleFactor(e),n=["x","y"].filter((s,o)=>{const r=Array.isArray(t)?t[o]:t;return r<-i||r>i});return n.length&&console.warn(`
            The offset is too big along ${n.map(s=>`${s}-axis`).join(" and ")} at the current latitude.
            Please, use more accurate coordinates to place the model.
        `),Array.isArray(t)?[t[0]%i,t[1]%i,t[2]]:[t%i,t%i,t]}function c5(t){return l5.includes(t)}function d5(t){if("coordinates"in t)return"coordinates";if("rotation"in t)return"rotation";if("scale"in t)return"scale";if("offset"in t)return"offset"}const h5=[0,0,0],u5=[0,0,0],f5=[0,0,0],_5="modelshow",m5="modelhide",Bh=0,rx=.1;class p5{constructor(e,i){this.sceneObjects=new Map,this.sceneObjectsVisibilityMap=new Map,this.viewportDiffer=new Et([{path:"center",type:"vec3"},{path:"zoom",type:"number"},{path:"size",type:"vec2"},{path:"rotation",type:"number"},{path:"pitch",type:"number"},{path:"padding",type:"padding"},{path:"demMode",type:"boolean"},{path:"elevation",type:"number"},{path:"minElevation",type:"number"}]),this.mapState=e,this.mapModules=i,this.modelsAnimator=new t5(e,i),this.modelInfo={},this.buildingIds=new Set,this.objectIdToLayerModelKey={},this.linkedIdToObjectId={},this.layerModelKeyBySourceTile=new Map,this.disabled=!1}addLayerModelToSourceTileMap(e){const i=Tr(e.attributes),n=rp(e.attributes.styleId,e.attributes.sourceId,e.tile.coords),s=this.layerModelKeyBySourceTile.get(n);s?s.add(i):this.layerModelKeyBySourceTile.set(n,new Set([i]))}clearSourceTileMapByTiles(e,i){i.map(n=>rp(this.mapState.handyStyleId,e,n.coords)).forEach(n=>this.layerModelKeyBySourceTile.delete(n))}clearSourceTileMapBySource(e){Array.from(this.layerModelKeyBySourceTile).map(n=>n[0]).filter(n=>n.split("_")[1]===String(e)).forEach(n=>this.layerModelKeyBySourceTile.delete(n))}getCurrentLayerModelId(e,i){var s;const n=Tr(e);return(s=this.modelInfo[n])==null?void 0:s.modelIds[i.id]}getModelOpacity(e){if(e===void 0)return Bh;const i=Tr(e.attributes);return i?this.modelsAnimator.getReadiness(i)??Bh:Bh}getModelHeightFactor(e){if(!e)return 1;const i=Tr(e.attributes);return this.modelsAnimator.getReadiness(i)??1}isAnimating(e){if(!e)return this.modelsAnimator.isAnimating();const i=this.linkedIdToLayerModelKey(e);return i?this.modelsAnimator.isAnimating(i):!1}objectIdToKey(e){return this.objectIdToLayerModelKey[e]}update(){this.syncStateWithSceneObjects(),this.modelsAnimator.update().length&&this.addNewSceneObjectsToVisibilityMap(),this.viewportDiffer.check(this.mapState)&&this.checkSceneObjectsVisibilityMap(),this.updateObjectsVisibility()}addSceneObject(e){const i=Tr(e.attributes);let n=this.modelInfo[i];n?this.objectIdToLayerModelKey[e.id]||this.indexateObject(i,e,n):n=this.addLayerModel(e,i),n&&(n.modelIds[e.tile.id]=e.renderingProperties.modelId,this.sceneObjects.set(e.id,e),this.addLayerModelToSourceTileMap(e))}removeSceneObject(e){this.sceneObjects.delete(e)}allObjectsHaveCurrentModelId(e,i,n){var r;const s=rp(n,e,i),o=this.layerModelKeyBySourceTile.get(s);if(!o)return!0;for(const a of o){const l=(r=this.modelInfo[a])==null?void 0:r.modelIds;if(!l)return!1;for(const c in l)if(l[c]===void 0)return!1}return!0}finishStyleUpdating(){Array.from(this.layerModelKeyBySourceTile).map(i=>i[0]).filter(i=>i.split("_")[0]!==String(this.mapState.handyStyleId)).forEach(i=>this.layerModelKeyBySourceTile.delete(i))}updateModelId(e,i,n,s,o){const{assetManager:r,sourceStorage:a,styleManager:l,camera:c}=this.mapModules,d=this.mapState;e.modelId=void 0;const{styleId:h,layerId:u,sourceId:f,modelIndices:m,modelStepValues:p,modelStepSource:_}=i;if(!m.length)return;let g;switch(_){case ns.None:g=0;break;case ns.Zoom:g=ax(p,d.styleZoom);break;case ns.Distance:g=g5(s,n,c.position,p,o);break;default:return}if(g===-1)return;const y=m[g];if(y===void 0)return;const b=r.getModel(y,h);if(b)switch(b.status){case xn.Loaded:e.modelId=y;return;case xn.Failed:e.modelId=NaN;return}else{const I=l.getStyleLayer(h,u),S=r.getDataModelUrlById(y);I&&!this.disabled&&(S===void 0?r.loadModelByIndex(y,h,I):S.length&&r.loadModel(S,y,h,!1,I))}if(m.length===1)return;const v=a.getSourceById(f);v&&(_===ns.Zoom?e.modelId=this.getModelIdByZoom(v,i,s,g):_===ns.Distance&&(e.modelId=this.getModelIdByDistance(i,s)))}getModelIdByDistance(e,i){return this.getCurrentModelId(e,i)}getModelIdByZoom(e,i,n,s){const{styleId:o,modelIndices:r}=i,a=e.getZoomDirection();if(a===pn.Stationary)return this.getCurrentModelId(i,n);const l=r.slice(0,s).reverse(),c=r.slice(s+1),d=a===pn.ZoomingIn?l.concat(c):c.concat(l);for(let h=0;h<d.length;h++){const u=this.mapModules.assetManager.getModel(d[h],o);if(u&&u.status===xn.Loaded)return d[h];if((u==null?void 0:u.status)===xn.Failed)return NaN}}getCurrentModelId(e,i){const n=this.getCurrentLayerModelId(e,i);if(!n)return;const s=this.mapModules.assetManager.getModel(n,e.styleId);if(s&&s.status===xn.Loaded)return n;if((s==null?void 0:s.status)===xn.Failed)return NaN}syncStateWithSceneObjects(){const e=new Set;if(this.disabled=this.mapModules.map.getFeatureFlag("modelsOff"),this.disabled){this.mapModules.defaultSource.destroyModelsSource();for(const n in this.modelInfo){const s=this.modelInfo[n];this.removeLayerModel(n,s)}return}for(const n of this.sceneObjects.values()){const s=Tr(n.attributes),o=this.modelInfo[s],r=this.mapState.disableModelsGrowthAnimation||n.tile.dynamicObject instanceof ex&&n.tile.dynamicObject.isAnimationDisabled();e.add(s),o&&!this.modelsAnimator.has(s)&&!this.disabled&&(this.mapModules.defaultSource.createModelsSource(),this.startAnimation(s,o,r)),this.modelInfo[s]?this.objectIdToLayerModelKey[n.id]||this.indexateObject(s,n,o):this.addLayerModel(n,s)}const i=this.mapState.styleZoom;for(const n in this.modelInfo){const s=this.modelInfo[n];e.has(n)?(i<s.layer.minzoom||i>=s.layer.maxzoom)&&this.removeLayerModel(n,s):this.removeLayerModel(n,s)}}addLayerModel(e,i){var o,r;const n=this.mapModules.styleManager.getStyleLayer(e.attributes.styleId,e.attributes.layerId);if(!n)return;const s={layer:n,ids:e.tile.ids,linkedIds:[],ownerIds:new Set,modelIds:{}};return s.buildingId=((o=e.meta)==null?void 0:o.buildingId)||"",(r=e.meta)!=null&&r.planId&&(s.planId=e.meta.planId),this.indexateObject(i,e,s),this.modelInfo[i]=s,s}startAnimation(e,i,n){if(n){this.modelsAnimator.add(e,1,1);return}const s=i.layer.minzoom??NaN;i.linkedIds.length>0&&this.mapModules.buildingHeightAnimator.getBuildingHeight(s)>.5?this.modelsAnimator.add(e,.5,1):this.modelsAnimator.add(e)}maybeEmitModelEvent(e,i,n){const s=!i.onKeyRemove&&!!n&&tr(n,{min:e.mapPoint,max:e.mapPoint}),o=e.visible;s!==o&&(e.visible=s,this.emitEvent(s&&!o?_5:m5,e))}addNewSceneObjectsToVisibilityMap(){var i,n,s,o;const e=this.mapModules.camera.getViewportVertices(rx);for(const r of this.sceneObjects.values())if((i=r.attributes)!=null&&i.emitShowHideEvents&&((n=r.meta)!=null&&n.buildingId)&&r.attributes.lngLat){const a=Tr(r.attributes),l={visible:!1,mapPoint:Z.fromGeo(r.attributes.lngLat),buildingId:((s=r.meta)==null?void 0:s.buildingId)||"",sublayer:((o=r.meta)==null?void 0:o.sublayer)||"",key:a};let c=this.sceneObjectsVisibilityMap.get(a);c||(c=new Map,this.sceneObjectsVisibilityMap.set(a,c)),c.get(r.meta.buildingId)||(c.set(r.meta.buildingId,l),this.maybeEmitModelEvent(l,{onKeyShow:!0},e))}}checkSceneObjectsVisibilityMap(){const e=this.mapModules.camera.getViewportVertices(rx);this.sceneObjectsVisibilityMap.forEach(i=>i.forEach(n=>this.maybeEmitModelEvent(n,{},e)))}indexateObject(e,i,n){var o,r;this.objectIdToLayerModelKey[i.id]=e,n.ownerIds.add(i.id),n.buildingId=((o=i.meta)==null?void 0:o.buildingId)||"",n.buildingId&&this.buildingIds.add(n.buildingId);const s=((r=i.meta)==null?void 0:r.linkedIds)??[];if(n.linkedIds.push(...s),i.tile.purpose!=="c3d")for(const a of s)this.linkedIdToObjectId[a]=i.id}removeLayerModel(e,i){var s;(s=i.ids)==null||s.show(i.linkedIds);for(const o of i.ownerIds)delete this.objectIdToLayerModelKey[o];i.buildingId&&this.buildingIds.delete(i.buildingId),this.modelsAnimator.remove(e);const n=this.sceneObjectsVisibilityMap.get(e);n&&(n.forEach(o=>this.maybeEmitModelEvent(o,{onKeyRemove:!0})),this.sceneObjectsVisibilityMap.delete(e)),delete this.modelInfo[e]}linkedIdToLayerModelKey(e){const i=this.linkedIdToObjectId[e];if(!i)return null;const n=this.objectIdToLayerModelKey[i];return n||null}emitEvent(e,i){const{buildingId:n,sublayer:s}=i;if(!s){console.warn(`No sublayer for model ${i.key}`);return}if(!n){console.warn(`No buildingId for model ${i.key}`);return}const o=ry(s);this.mapModules.map.emit(e,{sublayer:s,id:n,isCommercial:o})}updateObjectsVisibility(){const e=this.mapModules.identifier.getIdScope(Yf),i=this.mapModules.identifier.getIdScope(mn);e.getHidden().forEach(n=>{i.hide([n],Qi.All)});for(const n in this.modelInfo){const s=this.modelInfo[n],o=s.ids;if(!o)continue;const r=this.modelsAnimator.getReadiness(n)??Bh;for(const a of s.linkedIds){if(o.isHidden(a))continue;const l=s.planId!==void 0?Qi.FloorPolygons:Qi.PolygonExtrusion,c=o.isHidden(a,l);r>.5&&!c?o.hide([a],l):r<.5&&c&&o.show([a])}}}}function Tr(t){const{layerId:e,modelIndices:i}=t;return`${e}${i}`}function rp(t,e,i){return`${t}_${e}_${JSON.stringify(i)}`}function g5(t,e,i,n,s){const o=t.modelMatrices.get(0);if(!o)return-1;let r=e.min,a=e.max;s||(r=Tn(u5,r,o),a=Tn(f5,a,o));const l=wg(i,r,a,h5),c=Z.toGeo(l),d=Z.scaleFactor(c[1]),h=su(i,l)/Ge/d;return ax(n,h)}function ax(t,e){let i=0;for(;i<t.length&&!(e<t[i]);)i++;return i-1}const Oa=1/0;class v5{constructor(e,i){this.prevFrameAnimationLayerindex=void 0,this.cacheObjectsCount=0,this.needRerenderCore=!1,this.animationLayersMinIndex=Oa,this.state=e,this.modules=i,this.copyProgram=this.modules.renderer.getShaderProgram("copyDepth");const n=new R(new Uint8Array([-1,-1,1,-1,1,1,-1,1]));this.vao=iC(n,this.copyProgram),this.cacheFramebufferId=void 0,this.isReadyCache=!1,this._gl=this.modules.renderer.getRenderingContext(),this.isLowZoom=this.state.zoom<6,this.cacheDisabled=this.state.disableRenderingCache,this.animationLayersUniqueIds=new Set,this.needRerenderCore=!1,this.debugMode=!1}frameEnd(){this.needRerenderCore&&this.modules.renderer.addRerenderEvent()}initInDebugMode(){this.debugMode=!0}frameStart(){this.cacheObjectsCount=0,this.isLowZoom=this.state.zoom<6,this.isReadyCache=!1;let e=!1;this.needRerenderCore=!1,!this.cacheDisabled&&(this.animationLayersUniqueIds.clear(),this.cacheFramebufferId===void 0&&(this.cacheFramebufferId=this.createCacheFramebuffer()),this.animationLayersMinIndex=Oa,this.state.rerenderEvents.forEach(i=>{if(i.type==="layerAnimationTicker"){const n=this.getUniqueRenderIndex(i.styleId,i.layerId);this.animationLayersUniqueIds.add(n),this.animationLayersMinIndex=Math.min(this.animationLayersMinIndex,n)}else e=!0}),this.animationLayersMinIndex!==Oa&&this.animationLayersMinIndex===this.prevFrameAnimationLayerindex&&(this.isReadyCache=!0),(this.state.needRerender||e)&&(this.prevFrameAnimationLayerindex=void 0,this.isReadyCache=!1))}checkFlatObjectAnimation(e){const i=this.getUniqueRenderIndex(e.attributes.styleId,e.attributes.layerId);this.animationLayersUniqueIds.has(i)&&(this.needRerenderCore=!0)}tryToCacheObjects(e,i,n){return this.cacheDisabled||this.cacheFramebufferId===void 0||this.animationLayersMinIndex===Oa||this.isLowZoom||this.getUniqueRenderIndex(i.attributes.styleId,i.attributes.layerId)>=this.animationLayersMinIndex?!1:(e[this.cacheFramebufferId]||(e[this.cacheFramebufferId]={framebuffer:this.modules.renderer.getFramebuffer(this.cacheFramebufferId),objects:[],tileObjects:new Set}),this.cacheObjectsCount++,this.isReadyCache||(e[this.cacheFramebufferId].objects.push(i),e[this.cacheFramebufferId].tileObjects.add(n)),!0)}hasReadyCache(){return this.isReadyCache&&!this.cacheDisabled}render(){var i;if(this.cacheDisabled)return!1;if(this.cacheFramebufferId===void 0||this.cacheObjectsCount===0||this.isLowZoom)return;this.prevFrameAnimationLayerindex=this.animationLayersMinIndex;const e=(i=this.modules.renderer.getFramebuffer(this.cacheFramebufferId))==null?void 0:i.renderTarget;e&&this.copyRenderTargetToCanvasTexture(this._gl,e)}destroy(){this.cacheFramebufferId=void 0,this.vao.remove()}getUniqueRenderIndex(e,i){const n=this.modules.styleManager.getStyleLayer(e,i);if(!n)return Oa;const s=this.modules.styleManager.getMaxLayersCount();return-e*s+n.renderIndex}createCacheFramebuffer(){if(!this.isWebgl2Context()&&!this.modules.renderer.webGlExtensions.EXT_frag_depth){console.warn('Render cache disabled - WebGL extension "EXT_frag_depth" not available'),this.cacheDisabled=!0;return}const e=this.modules.renderer.getViewportSize(),i=this.modules.renderer.webglContextState.MAX_TEXTURE_SIZE;if(Math.max(...e)>i){Ze(`Disabling post-effects as viewport size ${e[0]}x${e[1]} exceeds hardware limits of ${i}x${i}`),this.cacheDisabled=!0;return}const s=this._gl,{styleManager:o}=this.modules,r=j.NearestFilter,a=this.modules.renderer.getViewportSize(),l=new Nt({size:[a[0],a[1]],magFilter:r,minFilter:r,wrapS:j.ClampToEdgeWrapping,wrapT:j.ClampToEdgeWrapping,depthTexture:!0,format:j.RgbaFormat});return this.modules.renderer.addFramebuffer({onResize:()=>{const c=this.modules.renderer.getViewportSize();l.setSize([c[0],c[1]]),l.bind(s),l.unbind(s)},renderTarget:l,onRenderStart:()=>{if(this.isReadyCache||this.cacheFramebufferId===void 0)return;const c=this.modules.renderer.getFramebuffer(this.cacheFramebufferId);if(!c)return;c.renderTarget.bind(s);const d=Tt(o.getClearColor()),h=s.COLOR_BUFFER_BIT|s.DEPTH_BUFFER_BIT;this.storeWebglState(s),s.depthMask(!0),s.enable(s.DEPTH_TEST),s.clearDepth(1),s.clearColor(d[0],d[1],d[2],d[3]),s.clear(h),c.renderTarget.unbind(s),this.restoreWebglState(s)},onRenderEnd:()=>{},isCacheFramebuffer:!0,useDem:!0,renderIndex:Oa})}isWebgl2Context(){return!(this.modules.map.getWebGLContext()instanceof WebGLRenderingContext)}copyRenderTargetToCanvasTexture(e,i){const{viewport:n}=this.state,s=window.devicePixelRatio,o=this.modules.renderer.getViewportSize();e.bindFramebuffer(e.FRAMEBUFFER,null),e.viewport(n.left*s,n.bottom*s,o[0],o[1]),this.storeWebglState(e),e.depthMask(!0),e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),this.debugMode&&(e.enable(e.BLEND),e.blendFunc(e.SRC_ALPHA_SATURATE,e.ONE_MINUS_SRC_COLOR));const r=this.modules.renderer.webGlExtensions;this.vao.bind({gl:e,extensions:r});const a=i.getTexture();a==null||a.enable(e,0);const l=i.getDepthAttachment();l==null||l.enable(e,1),this.copyProgram.enable(e),this.copyProgram.bind(e,{u_texture:0,u_depth:1}),e.drawArrays(e.TRIANGLE_FAN,0,4),this.restoreWebglState(e)}storeWebglState(e){this.stateWebgl={depthmask:e.getParameter(e.DEPTH_WRITEMASK),depthTest:e.getParameter(e.DEPTH_TEST),depthFunc:e.getParameter(e.DEPTH_FUNC),clearDepth:e.getParameter(e.DEPTH_CLEAR_VALUE)}}restoreWebglState(e){this.stateWebgl&&(e.depthMask(this.stateWebgl.depthmask),this.stateWebgl.depthTest?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),e.depthFunc(this.stateWebgl.depthFunc),e.clearDepth(this.stateWebgl.clearDepth))}}const y5=6e4;class w5{constructor(e,i){this.rerenderEvents=[],this.prevObjects=new Map,this.currentObjects=new Map,this.mapState=e,this.modules=i,this.throttledAutoRefresh=br(()=>{this.refresh()},y5)}frameEnd(){this.rerenderEvents.forEach(e=>this.modules.renderer.addRerenderEvent(e)),this.clearAnimationTickers()}frameStart(){this.rerenderEvents=[]}clearAllTickers(){this.clearAnimationTickers();for(const e of this.currentObjects.keys())yt(e,this.mapState);this.prevObjects=new Map,this.currentObjects=new Map}animateGltfObject(e,i,n){const{localMatrix:s,animationStack:o,transformStack:r}=e.renderingProperties;if(i.style.playAnimation===void 0||!(o!=null&&o.length)||!s||!o||!r)return;const a=this.updateAnimationKeyframes(e,i);Nw(s,o,r,n.buffers,a)}clearAnimationTickers(){for(const e of this.prevObjects.keys())this.currentObjects.has(e)||yt(e,this.mapState);this.prevObjects=new Map(this.currentObjects),this.currentObjects=new Map}refresh(){this.modules.renderer.addRerenderEvent()}updateAnimationKeyframes(e,i){const{animationStack:n}=e.renderingProperties;if(!n)return;const s=new Map;if(!(e.layerSettings.depthTest||e.layerSettings.shadow)){for(const o of n){const r=`${e.id}_${o.actionId}`,a=Al(r,this.mapState),l=this.applyAnimationState(r,i,e);if(this.isNeedAnimation(o,l)){if(!a&&l.currentCount>0){const c=l.animationDuration||(o.max?o.max[0]:0),d=l.startOffset||0,h=l.startOffset?(o.frameCount-1)*d/c:0,u=o.frameCount-1,f=c*(1e3/l.playSpeed)-d*(1e3/l.playSpeed);Bt(r,{easing:"linear",forceFinalValue:!0,renderAfterUpdate:!1},this.mapState,h,u,f,1,{actionId:o.actionId})}kt(r,{keepFinished:!0,step:(c,d,h,u)=>{s.set(h.actionId,d),u||this.rerender(e,i,l)},complete:c=>{l.currentCount>0&&l.currentCount--,l.currentCount>0&&(yt(r,this.mapState),this.rerender(e,i,l))}},this.mapState),this.currentObjects.set(r,l)}}return s}}initObjectAnimationState(e,i){const n=this.resolveOptions(e,i),s=n[2]??1/0,o=s,r=n[1]||1,a=n[4]||void 0,l=n[3]||void 0,c=typeof n[0]=="number"?n[0]:void 0,d=typeof n[0]=="string"?n[0]:void 0,h=typeof n[0]=="object"?n[0]:void 0;return{repeatCount:s,playSpeed:r,animationIndex:c,animationName:d,currentCount:o,animations:h,animationDuration:a,startOffset:l,tickerByStep:!!l}}resolveOptions(e,i){if(e.type!=="gltfModel")return{type:"animation-options"};const n=ut(this.mapState.styleZoom,this.mapState.styleState,i.attributes.tileData);return n.callBackFn=()=>this.throttledAutoRefresh(),rv(e.style.playAnimation,n)}isNeedAnimation(e,i){return i.animationIndex!==void 0&&e.animationIndex===i.animationIndex||i.animationName!==void 0&&e.animationName===i.animationName||i.animations!==void 0&&i.animations.includes(e.animationIndex)||i.animations!==void 0&&i.animations.includes(e.animationName)}applyAnimationState(e,i,n){const s=this.prevObjects.get(e),o=this.initObjectAnimationState(i,n);return s&&o.repeatCount===s.repeatCount&&(o.currentCount=s.currentCount),o}rerender(e,i,n){n.repeatCount!==0&&!n.tickerByStep&&this.rerenderEvents.push({type:"layerAnimationTicker",layerId:i.innerId,styleId:e.attributes.styleId})}}const kn=.1,b5={id:"simple-mesh",type:"simpleMesh",innerId:m_,filter:!1,minzoom:0,maxzoom:20,precomputes:[],renderIndex:0,style:{}},ap={polygonsQty:1e4,drawCallsQty:150,iterations:7},lx=[15,25,40],x5=1e3;class S5{constructor(e,i){this.state=e,this.modules=i,this.buffer=null,this.sceneObjects=[],this.pixels=new Float32Array(4),this.timeout=1/0,this.scale=at(1,1,1),this.startTs=0,this.de=Ro(this.state,this.modules),this.framebufferId=this.createFramebuffer(),this.modules.dynamicStyle.addLayer(b5)}async run(e=ap.polygonsQty,i=ap.drawCallsQty,n=ap.iterations,s=x5){this.timeout=s,this.startTs=performance.now();try{return await this._run(e,i,i*n,n)}catch{return{status:"error"}}}destroy(){this.modules.renderer.removeFramebuffer(this.framebufferId),this.buffer=null,this.sceneObjects=[],this.modules.dynamicStyle.removeLayer(m_)}async _run(e,i,n,s){const o=this.modules.renderer.getRenderingContext(),r=this.modules.renderer.getFramebuffer(this.framebufferId);if(!r)throw new Error("Failed to create framebuffer for benchmark.");r.renderTarget.bind(o),o.viewport(0,0,this.modules.renderer.getViewportSize()[0],this.modules.renderer.getViewportSize()[1]);const a=this.prepareData(e,n),l=await this.measureRendering(s,i);if(r.renderTarget.unbind(o),l.length<3)return{status:"timeout"};const c=this.processResults(l);let d=Math.min(c.mean,c.median);try{const f=localStorage.getItem("__MAPGL_BENCH_TIME"),m="0.0.0";if(f){const p=f.split(":"),_=parseFloat(p[1]);m!==p[0]||Number.isNaN(_)||d<_?localStorage.setItem("__MAPGL_BENCH_TIME",`${m}:${d.toPrecision(4)}`):d=_}else localStorage.setItem("__MAPGL_BENCH_TIME",`${m}:${d.toPrecision(4)}`)}catch{}const h=lx.findIndex(f=>d<=f),u=h>-1?lx.length-h-1:0;return{status:l.length<s?"part-done":"done",tier:u,measurements:c,preparation:a}}prepareData(e,i){const n=performance.now();this.buffer=this.generateSphere(e);const s=performance.now(),o=performance.now();this.sceneObjects=this.createSceneObjects(i);const r=performance.now();return{generationTime:s-n,objectsTime:r-o}}async measureRendering(e,i){return new Promise(n=>{const s=[];let o=0,r=0;const a=()=>{const l=performance.now();if(l-this.startTs>this.timeout){n(s);return}const c=this.modules.renderer.getRenderingContext();c.clear(c.COLOR_BUFFER_BIT|c.DEPTH_BUFFER_BIT),this.scale[0]+=.5-Math.random(),rm(this.state,this.modules,this.sceneObjects.slice(r,r+i),this.de),c.readPixels(0,0,1,1,c.RGBA,c.FLOAT,this.pixels),s.push(performance.now()-l),o++,r+=i,o<e?Promise.resolve().then(a):n(s)};setTimeout(()=>{a()},0)})}processResults(e){const i=e.slice();i.sort((s,o)=>s-o);const n=i.slice(0,i.length-.2*i.length);return{median:n[Math.floor(n.length/2)],mean:n.reduce((s,o)=>s+o,0)/n.length,min:n[0],max:n[n.length-1]}}generateSphere(e){const i=Math.floor(Math.sqrt(e/2)),n=i*2,a=i*n*2*3*3,l=new Float32Array(a);let c=0;const d=Math.PI/i,h=2*Math.PI/n,u=new Float32Array(3),f=new Float32Array(3),m=new Float32Array(3),p=new Float32Array(3);for(let _=0;_<i;_++){const g=_*d,y=(_+1)*d,b=Math.sin(g),v=Math.cos(g),I=Math.sin(y),S=Math.cos(y);for(let P=0;P<n;P++){const T=P*h,L=(P+1)*h,B=Math.sin(T),O=Math.cos(T),w=Math.sin(L),x=Math.cos(L);u[0]=kn*b*O,u[1]=kn*v,u[2]=kn*b*B,f[0]=kn*b*x,f[1]=kn*v,f[2]=kn*b*w,m[0]=kn*I*O,m[1]=kn*S,m[2]=kn*I*B,p[0]=kn*I*x,p[1]=kn*S,p[2]=kn*I*w,l.set(u,c),l.set(m,c+3),l.set(f,c+6),l.set(m,c+9),l.set(p,c+12),l.set(f,c+15),c+=18}}return l.buffer}createFramebuffer(){const e=new Nt({size:this.modules.renderer.getViewportSize(),magFilter:j.NearestFilter,minFilter:j.NearestFilter,wrapS:j.ClampToEdgeWrapping,wrapT:j.ClampToEdgeWrapping,type:j.Float,flipY:!0});return this.modules.renderer.addFramebuffer({clearColor:[0,0,0,0],renderTarget:e,onResize:()=>{}})}createSceneObjects(e){const i={programName:"simpleMesh",vaoCreator:v1,webglState:A1,programBinder:(a,l)=>{const c=Gi();l.bind(a,{u_mat4_mvp:Ha(c,c,this.scale),u_float_scale:1,u_vec3_transform:at(0,0,0)})},tileBinder:()=>!0,objectBinder:(a,l,c,d,h)=>{l.bind(a,{u_float_scale:h.meta.scale,u_vec3_transform:h.meta.transform})},needsVisibilityBuffer:!1},n=[],s=v1(new R(this.buffer),this.modules.renderer.getShaderProgram("simpleMesh")),o=new Ct("zenith",[],this.modules,this.state),r={layerId:m_,styleId:Lo,tileData:[]};for(let a=0;a<e;a++){const c=(a/20&1)===0?1-(1+a%10)/10:(1+a%10)/10,d=at(-1+a%20/10,1-Math.floor(a/20)*2/(e/20),0);n.push({id:Vn(),type:Xi.Tile,start:0,count:this.buffer.byteLength/12,attributesHash:`benchmark-${a}`,vao:s,drawMode:Ua,tile:o,symbol:"simpleMesh",sink:"fill",layerSettings:i,canRender:!0,attributes:r,meta:{scale:c,transform:d},renderingProperties:{}})}return n}}class M5{constructor(e,i,n){this.benchmark=null,this.map=n,this.camera=new hn(e),this.layout=new ZN(i),this.collector=new dL("main"),this.workers=new aN,this.identifier=new dB(e,this),this.styleManager=new PB(this),this.assetManager=new FB(e,this),this.imageManager=new $N(this),this.floorManager=new IN(e,this),this.personalPoiManager=new UB(this),this.buildingHeightAnimator=new nL(e,this),this.modelsScene=new p5(e,this),this.renderer=new Do(e,this),this.layers=new bN(this),this.sourceStorage=new YN,this.tileManager=new TN(e,this),this.modelLayer=new NB(e,this),this.dynamicStyle=new SA,this.imageCache=new SN(this),this.labeler=new RN(e,this),this.ruler=new UN(e,this),this.trafficTileLayer=new VN(e,this),this.handler=new GN(e,this),this.mouseMoveHandler=new eL(this),this.tileKeyInfo=new XN(e),this.demManager=new qC(this),this.environmentManager=new e5(this),this.defaultSource=new Qb(e,this),this.labelsDebug=new JN(e,this),this.postEffectsManager=new LR(e,this),this.renderCacheManager=new v5(e,this),this.animationManager=new w5(e,this),this.shadowManager=new ER(e,this),this.instanceLinker=new hF(this),e.graphicsPresetMode==="auto"&&(this.benchmark=new S5(e,this))}destroy(){this.demManager.disable(),this.imageManager.destroy(),this.trafficTileLayer.destroy(),this.tileManager.destroy(),this.workers.destroy(),this.renderer.destroy(),this.handler.destroy(),this.mouseMoveHandler.destroy(),this.ruler.destroy(),this.labelsDebug.hide(),this.renderCacheManager.destroy(),this.tileKeyInfo.destroy(),this.layout.destroy()}}const ka=class ka{constructor(e,i={},n){this.requestedFrame=requestAnimationFrame(()=>{}),this.isStyleUpdateInProgress=!1,this.isFirstStyleUpdate=!0,this.lastResizeTime=-1/0,this.replicasDiffer=new Et([{path:"visibleMapReplicas",type:"replicas"}]),this.graphicsPresetDiffer=new Et([{path:"graphicsPreset",type:"string"}]),this.renderLoop=h=>{this.requestedFrame=requestAnimationFrame(this.renderLoop),this.updateImmersiveLevel(),this.modules.map.emit("framestart");const u=this.state;if(u.time=Date.now(),this.processMetrics(),this.state.enableTrackResize&&this.autoResize(h),this.modules.mouseMoveHandler.update(),this.handlers.forEach(f=>f.update()),kP(u),zP(u),DP(u),BP(u),this.stillnessUpdater.update(u),CP(u,this.modules.layout.rootContainer),xP(u,this.modules.layout.rootContainer,this.modules.renderer),AP(u,this.modules.renderer),u.demMode=this.checkDemEnabled()&&u.elevationScale>0,this.checkGlobeEnabled(),this.modules.camera.update(),this.updateElevation(),this.updateTilesBounds(),this.replicasDiffer.check(u)&&(u.needReplicasUpdate=!0),this.modules.demManager.update(),this.modules.environmentManager.update(),this.modules.labelsDebug.update(),this.modules.trafficTileLayer.update(),this.modules.layers.getLayers().forEach(f=>{f.update!==void 0&&f.update()}),this.modules.tileManager.update(),this.modules.instanceLinker.update(),this.modules.sourceStorage.updateViewportSources(),this.modules.floorManager.update(),this.modules.modelLayer.update(),this.modules.personalPoiManager.update(),this.modules.ruler.update(),this.modules.dynamicStyle.update(),this.modules.styleManager.update(),this.modules.buildingHeightAnimator.update(),this.modules.modelsScene.update(),this.modules.shadowManager.update(),this.modules.map.emit("update"),this.modules.labeler.update(),this.performanceChecker.update(),this.modules.identifier.update(),this.modules.postEffectsManager.update(),u.loopWorld&&!this.modules.renderer.isNeedRerender()&&Hr(u.center),(lc.alwaysRerender||this.modules.renderer.isNeedRerender())&&u.collectStats&&(u.stats.drawCount=0,u.stats.vertexCount=0,u.stats.triangleCount=0,u.stats.drawCountBySymbol={}),lc.alwaysRerender||this.modules.renderer.isNeedRerender()){let f=this.modules.tileManager.getTileObjects();u.demMode&&(f=f.concat(this.modules.demManager.getGroundTiles())),this.modules.renderer.prerenderUpdate(),u.metrics.firstdraw===void 0&&(u.metrics.firstdraw=performance.now()-u.metrics.start),f.forEach(m=>{m.needSync&&m.syncReplicas(this.state)}),this.modules.renderCacheManager.frameStart(),this.modules.animationManager.frameStart(),this.modules.shadowManager.drawShadowMap(f),this.modules.renderer.renderLabelingTexture(f),this.modules.renderer.renderSpriteLabelingTexture(f),this.modules.renderer.renderTileObjects(f),this.modules.shadowManager.drawDebugFbIfNeeded(),u.needRerender=!1,this.state.rerenderEvents=new Array,this.modules.animationManager.frameEnd(),this.modules.renderCacheManager.frameEnd(),u.collectStats&&(this.modules.map.emit("stats",u.stats),u.metricsSent||(u.metrics.vertexCount=u.stats.vertexCount,u.metrics.triangleCount=u.stats.triangleCount,u.metrics.drawCount=u.stats.drawCount))}this.finishStyleUpdatingCheck(),this.modules.map.update(),this.modules.assetManager.invalidateUsedGltfModels(),u.needReplicasUpdate=!1,u.shouldIsReadyWaitForUpdates=!1,u.shouldIsIdleWaitForUpdates=!1,this.modules.map.emit("frameend"),this.modules.styleManager.getStyle(this.modules.map.state.handyStyleId)&&this.state.graphicsPresetMode&&this.graphicsPresetDiffer.check(this.state.styleState)&&this.modules.map.emit("graphicspresetchange")};const s={...ka.options,...i},o={...ka.options.padding,...s.padding},r={...ka.options.viewport,...s.viewport},a=s.maxBounds?du(s.maxBounds):s.loopWorld?mc:_c,l=Z.fromGeo(s.center);Hr(l),jr(l,a,l);const c=s.graphicsPreset&&s.graphicsPreset!=="auto"?{...s.styleState,graphicsPreset:s.graphicsPreset}:s.styleState,d=this.state={time:Date.now(),center:l,zoom:s.styleZoom!==void 0?Ya(s.styleZoom,l):s.zoom,rotation:ve(s.rotation),pitch:ve(s.pitch),styleZoom:s.styleZoom!==void 0?s.styleZoom:Xo(s.zoom,l),zoomTypePreserving:s.styleZoom!==void 0?"styleZoom":"zoom",minZoom:s.minZoom,maxZoom:s.maxZoom,maxBounds:a,loopWorld:s.loopWorld??!1,touchRotationThreshold:ve(s.touchRotationThreshold),minPitch:ve(s.minPitch),maxPitch:ve(s.maxPitch),lowZoomMaxPitch:s.lowZoomMaxPitch?ve(s.lowZoomMaxPitch):null,size:[Math.max(1,e.clientWidth-r.left-r.right),Math.max(1,e.clientHeight-r.top-r.bottom)],tickers:{},stillness:1,needRerender:!0,needLabeling:!1,needReplicasUpdate:!1,userHasInteracted:!1,viewport:r,padding:o,labelingOpacity:0,tileServer:s.tileServer,styleServer:s.styleServer||Ga.url,fontUrl:s.fontUrl||jt.defaultUrl,modelUrl:s.modelUrl||xp,iconUrl:s.iconUrl||Jh.defaultUrl,keyUrl:s.keyUrl||t2,tileSet:s.tileSet,tileProtocol:s.tileProtocol,commercialTileSet:s.commercialTileSet,modelsTileSet:s.modelsTileSet??Uo.tileSet,modelsTilesUrl:s.modelsTilesUrl??ac.models,defaultSourceModelsRootUrl:s.defaultSourceModelsRootUrl,defaultSourceModelsAppearStrategy:s.defaultSourceModelsAppearStrategy,subdomains:s.subdomains.split(""),floorsEnabled:s.floorsEnabled,collectStats:s.collectStats,stats:{tileCount:0,dynamicTileCount:0,globeTileCount:0,drawCount:0,vertexCount:0,triangleCount:0,drawCountBySymbol:{},foundVisibleTilesCount:0},trafficServer:s.trafficServer,trafficProtocol:s.trafficProtocol,identifyPickDistance:rn.pickDistance,lang:s.lang,tileServerDefaultLang:s.tileServerDefaultLang,tileKey:s.key,appId:s.appId,disableHoverStyles:s.disableHoverStyles,keepCenterWhileUserZoomRotate:!!s.keepCenterWhileUserZoomRotate,disableRotationByUserInteraction:!!s.disableRotationByUserInteraction,disablePitchByUserInteraction:!!s.disablePitchByUserInteraction,disableDragging:!!s.disableDragging,enableTwoFingerDragging:!!s.enableTwoFingerDragging,performanceCaveatEmitted:!1,sessionId:s.sessionId,tileSessionId:s.tileSessionId,shownRegionIds:new Set,preserveDrawingBuffer:!!s.preserveDrawingBuffer,defaultBackgroundColor:ia(s.defaultBackgroundColor),handyStyleId:NaN,styleState:Rh(c),disableIconCache:s.disableIconCache,disableRenderingCache:s.disableRenderingCache,rtlPlugin:{scenario:s.useRtlTextPlugin??"depends-on-language",loadFailed:!1,url:s.rtlPluginUrl??i2,hash:s.rtlPluginHash??n2},mobileSdkMode:s.mobileSdkMode,dracoDecoderUrl:(s==null?void 0:s.dracoDecoderUrl)??s2,demMode:!1,globeMode:!1,globeReady:!1,visibleMapReplicas:[0],tilesBounds:[[0,0],[0,0],[0,0],[0,0]],extendedTilesBounds:[[0,0],[0,0],[0,0],[0,0]],elevation:void 0,elevationScale:0,minElevation:void 0,skipElevationAnimation:s.skipElevationAnimation,metrics:{start:performance.now(),fail:!1,vertexCount:0,triangleCount:0,drawCount:0},metricsSent:!1,shouldIsReadyWaitForUpdates:!1,shouldIsIdleWaitForUpdates:!1,commercialPoiRandomSeed:s.commercialPoiRandomSeed,disableSurvivedPoiPrevalence:!!s.disableSurvivedPoiPrevalence,webglVersion:s.webglVersion,enableTrackResize:!!s.enableTrackResize,autoResizeInterval:lc.autoResizeInterval,showDefaultTileBounds:!!s.showDefaultTileBounds,immersiveLevel:{tiers:!1},pitchHightLimitation:s.pitchHightLimitation===void 0?ve(90):ve(s.pitchHightLimitation),isLabelingDepthTestDisabled:!1,disableHidingPois:s.disableHidingPois??!1,disableAntiAliasing:s.disableAntiAliasing??!0,rerenderEvents:new Array,cameraConfig:Object.assign({},ln),cityCommPoiLabeling:{config:s.cityCommPoiLabelingConfig,ascSortedZoomNumbers:PN(s.cityCommPoiLabelingConfig)},trafficMinZoom:s.trafficMinZoom??ki.minZoom,trafficMaxZoom:s.trafficMaxZoom??ki.maxZoom,trafficMaxDetailLevel:s.trafficMaxDetailLevel??ki.maxDetailLevel,bssHostAppParams:s.bssHostAppParams,disableStyleFallback:!!s.disableStyleFallback,useFlatDemIrregularMeshNormals:s.useFlatDemIrregularMeshNormals??!1,hiddenImmersiveRoutesEnabled:UC(),modelShowHideEventsSublayers:new Set(s.modelShowHideEventsSublayers??[]),graphicsPresetMode:s.graphicsPreset,shouldEmitGraphicsPresetChangeEvent:!1,isDeprecatedSystem:th(),disableModelsGrowthAnimation:s.disableModelsGrowthAnimation??!1};s.cameraConfig&&Object.assign(d.cameraConfig,s.cameraConfig),this.modules=new M5(d,e,n),typeof d.commercialPoiRandomSeed=="number"&&this.modules.workers.labeling.setCommercialPoiRandomSeed(d.commercialPoiRandomSeed),this.modules.styleManager.setDynamicStyle(this.modules.dynamicStyle.getStyle()),this.handlers=[new XP(d,this.modules.layout.mapContainer),new YP(this.modules)],s.disableZoomOnScroll||this.handlers.push(new WP(d,this.modules.layout.mapContainer)),HP&&Bd&&this.handlers.push(new qP(d,e,n)),this.performanceChecker=new KP(d,this.modules),this.stillnessUpdater=new QP,this.measurePerformance(s.graphicsPreset==="auto").then(()=>{this.requestedFrame=requestAnimationFrame(this.renderLoop)})}destroy(){cancelAnimationFrame(this.requestedFrame),this.modules.destroy(),this.handlers.forEach(e=>e.destroy())}isIdle(){return!this.modules.renderer.isNeedRerender()&&!this.state.shouldIsIdleWaitForUpdates&&this.modules.tileManager.isIdle()&&this.modules.assetManager.isIdle()&&this.modules.trafficTileLayer.viewportTilesReady()&&this.modules.layers.entranceAnimationFinished()&&this.modules.modelLayer.isIdle()&&!this.modules.buildingHeightAnimator.isAnimating()&&!this.modules.modelsScene.isAnimating()&&this.modules.labeler.isIdle()}isReady(){return this.isIdle()&&this.modules.floorManager.floorsReady()&&this.modules.identifier.isIdle()&&this.modules.imageManager.isIdle()&&this.modules.imageCache.isIdle()&&this.modules.personalPoiManager.isIdle()&&this.modules.tileKeyInfo.isIdle()&&this.modules.postEffectsManager.isReady()&&!this.state.shouldIsReadyWaitForUpdates}redrawMap(){this.modules.tileManager.redraw(),this.modules.trafficTileLayer.redraw(),this.modules.modelLayer.redraw(),this.modules.personalPoiManager.redraw()}activateStyleUpdating(){this.modules.tileManager.activateStyleUpdating(),this.modules.modelLayer.activateStyleUpdating(),this.modules.trafficTileLayer.activateStyleUpdating(),this.isStyleUpdateInProgress=!0}getIsFirstStyleUpdate(){return this.isFirstStyleUpdate}async measurePerformance(e){if(!e)return;performance.now();const i=await this.modules.benchmark.run();switch(this.modules.benchmark.destroy(),this.modules.benchmark=null,i.status){case"error":this.state.metrics.graphicsPreset="error";break;case"timeout":this.state.metrics.graphicsPreset="timeout",this.modules.map.patchStyleState({graphicsPreset:"light"});break;case"part-done":case"done":const n=i.tier>0?i.tier>1?"immersive":"normal":"light";this.state.metrics.graphicsPreset=i.status==="part-done"?"timeout":n,this.state.metrics.benchRenderTime=Math.round(i.measurements.mean),this.state.metrics.benchGenTime=Math.round(i.preparation.generationTime),this.modules.map.patchStyleState({graphicsPreset:n});break}}processMetrics(){const e=this.state;if(e.metricsSent||e.graphicsPresetMode==="auto"&&!e.metrics.graphicsPreset)return;const i=e.metrics,n=performance.now()-i.start>Fp;(i.interactive!==void 0&&i.init!==void 0&&i.firstlabeling!==void 0&&i.ready!==void 0&&i.firstcontent!==void 0&&i.firstdraw!==void 0||n)&&(i.fail=n,this.modules.map.emit("metrics",i),e.metricsSent=!0)}finishStyleUpdatingCheck(){this.isStyleUpdateInProgress&&this.modules.tileManager.viewportTilesReady()&&this.modules.trafficTileLayer.viewportTilesReady()&&this.modules.modelLayer.viewportModelsReady()&&(this.modules.tileManager.finishStyleUpdating(),this.modules.trafficTileLayer.finishStyleUpdating(),this.modules.modelLayer.finishStyleUpdating(),this.modules.modelsScene.finishStyleUpdating(),this.modules.personalPoiManager.redraw(),this.updateBackgroundColor(),this.isStyleUpdateInProgress=!1,this.isFirstStyleUpdate=!1,this.modules.renderer.addRerenderEvent(),this.state.needLabeling=!0)}updateBackgroundColor(){const{renderer:e,postEffectsManager:i,styleManager:n}=this.modules,s=n.getClearColor();s!==void 0&&(e.setClearColor(s),i.setClearColor(s))}checkDemEnabled(){return this.state.styleState.terrainEnabled===!0?this.modules.demManager.isEnabled()||this.modules.demManager.enable():this.modules.demManager.isEnabled()&&this.modules.demManager.disable(),this.modules.demManager.isEnabled()}checkGlobeEnabled(){const{styleState:i,styleZoom:n,globeMode:s,handyStyleId:o}=this.state,{defaultSource:r,map:a}=this.modules,l=s;if(!this.modules.styleManager.getStyleLayer(o,ga)){this.state.globeMode=!1;return}const{globeMaxZoom:d}=In,h=!l&&n<d||l&&n<d+.2,u=i.globeEnabled===!0&&h&&!a.getFeatureFlag("globeOff");!l&&u&&(this.modules.defaultSource.addGlobeSource(),this.state.globeReady=!1),l&&!u&&(this.modules.defaultSource.removeGlobeSource(),this.state.globeReady=!1),u&&r.isGlobeTilesReady()&&(this.state.globeReady=!0),this.state.globeMode=u,(u||l&&!u)&&this.updateBackgroundColor()}updateImmersiveLevel(){const e=!!this.state.styleState.immersiveRoadsOn;this.state.immersiveLevel.tiers=e&&this.state.styleZoom>=jp}updateTilesBounds(){const{size:e,zoom:i}=this.state,[n,s,o,r]=this.modules.camera.getViewportVertices(),a=wo(n,s);let l=Mc(o,a);const c=this.state.cameraConfig;let d=mu(e[1],i)*c.viewportLimitRatio;if(d<c.minTrapezeHeight&&(d=c.minTrapezeHeight),l>d){const h=d/l;Ti(o,s,o,h),Ti(r,n,r,h),l=d}if(Br(this.state.tilesBounds[0],n),Br(this.state.tilesBounds[1],s),Br(this.state.tilesBounds[2],o),Br(this.state.tilesBounds[3],r),this.state.visibleMapReplicas=this.state.loopWorld&&!this.state.globeMode?ZS(this.state.tilesBounds):[0],this.state.demMode){const h=Cg(this.modules.camera.position,a);if(h<0){const f=(l+Math.abs(h))/l;Ti(n,r,n,f),Ti(s,o,s,f)}if(this.state.elevation!==void 0&&!Number.isNaN(this.state.elevation)){const f=this.modules.camera.position[2],m=this.state.minElevation!==void 0&&!Number.isNaN(this.state.minElevation)?this.state.minElevation:this.state.elevation,p=Math.max(this.state.elevation-m,0)*Ge/f+1,_=(p-1)*Math.max(1-this.state.pitch/this.state.maxPitch,.1)+1,g=Math.max(this.state.pitch/this.state.maxPitch*30,4);Ti(n,this.modules.camera.position,n,Math.min(_,g)),Ti(s,this.modules.camera.position,s,Math.min(_,g)),Ti(r,this.modules.camera.position,r,Math.min(p,g)),Ti(o,this.modules.camera.position,o,Math.min(p,g))}}this.state.extendedTilesBounds[0]=n,this.state.extendedTilesBounds[1]=s,this.state.extendedTilesBounds[2]=o,this.state.extendedTilesBounds[3]=r}updateElevation(){if(this.state.elevationScale=this.modules.demManager.getVerticalScale(),!this.state.demMode){this.state.elevation!==void 0&&(this.modules.renderer.addRerenderEvent(),this.state.elevation=void 0);return}const e=this.modules.demManager.getElevation(this.state.center);if(e!==void 0)if(this.state.elevation===void 0||this.state.skipElevationAnimation)this.state.elevation=e;else{const n=$C*(e-this.state.elevation);Math.abs(n)<WC?this.state.elevation=e:this.state.elevation+=n;const s=this.modules.demManager.getElevation(this.modules.camera.position);if(s!==void 0){const o=this.state.elevationScale,r=s*o,a=this.modules.camera.position[2]/Ge,l=Math.min(30,a*.2),c=this.state.elevation*o+a-l;r>c&&(this.state.elevation+=(r-c)/o)}}const i=this.modules.demManager.getMinElevation();i!==void 0&&(this.state.minElevation=i)}autoResize(e){if(e-this.lastResizeTime>=this.state.autoResizeInterval){const i=this.modules.layout.canvas,{clientWidth:n,clientHeight:s}=this.modules.layout.rootContainer,o=window.devicePixelRatio;(i.width!==Math.floor(n*o)||i.height!==Math.floor(s*o))&&(this.lastResizeTime=e,this.modules.map.invalidateSize())}}};ka.options={center:[0,0],zoom:0,minZoom:zr.minZoom,maxZoom:zr.maxZoom,rotation:0,touchRotationThreshold:10,pitch:0,minPitch:0,maxPitch:45,lowZoomMaxPitch:45,viewport:{top:0,right:0,bottom:0,left:0},padding:{top:0,right:0,bottom:0,left:0},tileServer:Xe.server,tileSet:Xe.tileSet,tileProtocol:Xe.protocol,commercialTileSet:Fr.tileSet,key:Xe.tileKey,subdomains:Xe.subdomains,floorsEnabled:jo.enabled,trafficProtocol:ki.protocol,trafficServer:ki.host,collectStats:!1,style:"",styleState:MN(),styleOptions:{rootUrl:"",iconsPath:"",fontsPath:"",stylePath:"",modelsPath:""},lang:eu,appId:Xe.appId,disableHoverStyles:!1,disableZoomOnScroll:!1,disableDragging:!1,enableTwoFingerDragging:!1,disableRotationByUserInteraction:!1,disablePitchByUserInteraction:!1,defaultBackgroundColor:"#f6f2de",disableIconCache:!1,disableRenderingCache:!1,mobileSdkMode:!1,skipElevationAnimation:!1,enableTrackResize:!1,showDefaultTileBounds:!1,immersiveOn:!1,pitchHightLimitation:90,trafficMinZoom:ki.minZoom,trafficMaxZoom:ki.maxZoom,trafficMaxDetailLevel:ki.maxDetailLevel,disableStyleFallback:!1,useFlatDemIrregularMeshNormals:!1,modelShowHideEventsSublayers:[],styleServer:"",fontUrl:"",modelUrl:"",iconUrl:"",keyUrl:""};let lp=ka;const cx=["disableDragging","enableTrackResize","loopWorld","disableHidingPois","enableTwoFingerDragging"];function I5(t){let e=!1,i;return function(...n){return e||(e=!0,i=t.apply(this,n)),i}}let dx=t=>t,Ql=null;const T5=new Promise(t=>{Ql=()=>{t()}}),E5=new Set(["ar"]);function hx(t,e){return t==="always-on"||t==="depends-on-language"&&E5.has(e)}function A5(t,e,i){const n=e.workers.labeling;function s(){n.markRtlPluginLoaded().then(()=>{Ql!==null&&Ql()})}return hx(t.scenario,i)?fetch(t.url,{integrity:t.hash}).then(o=>o.text()).then(o=>Promise.all([n.loadRtlPlugin(o),Promise.resolve(P5(o))])).catch(o=>{s();const r=new Error,a="[RTL Plugin]: loading failed.";throw r.message=L5(o)?`${a} ${o.message}`:a,r}):(s(),Promise.resolve())}const P5=I5(function(t){new Function(t)(),dx=self.mapglRtlPlugin.processRtl,Ql&&Ql()});function L5(t){return typeof t=="object"&&!!t&&"message"in t}const C5="https://mapgl.2gis.com/api/js",kh={minZoom:2,maxZoom:20},R5="tile{subdomain}-sdk.maps.2gis.com",ux="https://tile{subdomain}-sdk.maps.2gis.com/api/v3/ald",z5="https://s1.bss.2gis.com/bss/3",cp=()=>{let t="",e;for(let i=0;i<32;i++)e=Math.random()*16|0,i>4&&i<21&&!(i%4)&&(t+="-"),t+=(i===12?4:i===16?e&3|8:e).toString(16);return t},F5=2;function D5(t){const e=[F5,t instanceof WebGLRenderingContext?1:2,t.getParameter(t.ALIASED_LINE_WIDTH_RANGE),t.getParameter(t.ALIASED_POINT_SIZE_RANGE),t.getParameter(t.COMPRESSED_TEXTURE_FORMATS),t.getParameter(t.MAX_COMBINED_TEXTURE_IMAGE_UNITS),t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),t.getParameter(t.MAX_RENDERBUFFER_SIZE),t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),t.getParameter(t.MAX_TEXTURE_SIZE),t.getParameter(t.MAX_VARYING_VECTORS),t.getParameter(t.MAX_VERTEX_ATTRIBS),t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS),t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),t.getParameter(t.MAX_VIEWPORT_DIMS),t.getParameter(t.PACK_ALIGNMENT),t.getParameter(t.SUBPIXEL_BITS),t.getParameter(t.UNPACK_ALIGNMENT),t.getParameter(t.VIEWPORT),t.getParameter(t.SHADING_LANGUAGE_VERSION),t.getParameter(t.VENDOR),t.getParameter(t.RENDERER)];t instanceof WebGLRenderingContext?e.push(...new Array(28).fill(-1)):e.push(t.getParameter(t.MAX_3D_TEXTURE_SIZE),t.getParameter(t.MAX_ARRAY_TEXTURE_LAYERS),t.getParameter(t.MAX_CLIENT_WAIT_TIMEOUT_WEBGL),t.getParameter(t.MAX_COLOR_ATTACHMENTS),t.getParameter(t.MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS),t.getParameter(t.MAX_COMBINED_UNIFORM_BLOCKS),t.getParameter(t.MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS),t.getParameter(t.MAX_DRAW_BUFFERS),t.getParameter(t.MAX_ELEMENT_INDEX),t.getParameter(t.MAX_ELEMENTS_INDICES),t.getParameter(t.MAX_ELEMENTS_VERTICES),t.getParameter(t.MAX_FRAGMENT_INPUT_COMPONENTS),t.getParameter(t.MAX_FRAGMENT_UNIFORM_BLOCKS),t.getParameter(t.MAX_FRAGMENT_UNIFORM_COMPONENTS),t.getParameter(t.MAX_PROGRAM_TEXEL_OFFSET),t.getParameter(t.MAX_SAMPLES),t.getParameter(t.MAX_SERVER_WAIT_TIMEOUT),t.getParameter(t.MAX_TEXTURE_LOD_BIAS),t.getParameter(t.MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS),t.getParameter(t.MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS),t.getParameter(t.MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS),t.getParameter(t.MAX_UNIFORM_BLOCK_SIZE),t.getParameter(t.MAX_UNIFORM_BUFFER_BINDINGS),t.getParameter(t.MAX_VARYING_COMPONENTS),t.getParameter(t.MAX_VERTEX_OUTPUT_COMPONENTS),t.getParameter(t.MAX_VERTEX_UNIFORM_BLOCKS),t.getParameter(t.MAX_VERTEX_UNIFORM_COMPONENTS),t.getParameter(t.MIN_PROGRAM_TEXEL_OFFSET));const i=t.getExtension("WEBGL_debug_renderer_info");i?e.push(t.getParameter(i.UNMASKED_VENDOR_WEBGL),t.getParameter(i.UNMASKED_RENDERER_WEBGL)):e.push("Unsupported","Unsupported");const n=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.LOW_FLOAT),s=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.MEDIUM_FLOAT),o=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.HIGH_FLOAT);return o&&s&&n?(e.push(`[${n.rangeMin},${n.rangeMax}](${n.precision})`),e.push(`[${s.rangeMin},${s.rangeMax}](${s.precision})`),e.push(`[${o.rangeMin},${o.rangeMax}](${o.precision})`)):e.push(new Array(3).fill("Unsupported")),e.push(window.devicePixelRatio),e}function O5(t){const e={};for(const[i,n]of Object.entries(t)){if(hy(n)){e[i]=Array.from(n);continue}e[i]=n}return e}function B5(t){const e={1:["stateSetVersion","webGlVersion","ALIASED_LINE_WIDTH_RANGE","ALIASED_POINT_SIZE_RANGE","COMPRESSED_TEXTURE_FORMATS","MAX_COMBINED_TEXTURE_IMAGE_UNITS","MAX_CUBE_MAP_TEXTURE_SIZE","MAX_FRAGMENT_UNIFORM_VECTORS","MAX_RENDERBUFFER_SIZE","MAX_TEXTURE_IMAGE_UNITS","MAX_TEXTURE_SIZE","MAX_VARYING_VECTORS","MAX_VERTEX_ATTRIBS","MAX_VERTEX_TEXTURE_IMAGE_UNITS","MAX_VERTEX_UNIFORM_VECTORS","MAX_VIEWPORT_DIMS","PACK_ALIGNMENT","SUBPIXEL_BITS","UNPACK_ALIGNMENT","VIEWPORT","SHADING_LANGUAGE_VERSION","VENDOR","RENDERER","MAX_3D_TEXTURE_SIZE","MAX_ARRAY_TEXTURE_LAYERS","MAX_CLIENT_WAIT_TIMEOUT_WEBGL","MAX_COLOR_ATTACHMENTS","MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS","MAX_COMBINED_UNIFORM_BLOCKS","MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS","MAX_DRAW_BUFFERS","MAX_ELEMENT_INDEX","MAX_ELEMENTS_INDICES","MAX_ELEMENTS_VERTICES","MAX_FRAGMENT_INPUT_COMPONENTS","MAX_FRAGMENT_UNIFORM_BLOCKS","MAX_FRAGMENT_UNIFORM_COMPONENTS","MAX_PROGRAM_TEXEL_OFFSET","MAX_SAMPLES","MAX_SERVER_WAIT_TIMEOUT","MAX_TEXTURE_LOD_BIAS","MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS","MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS","MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS","MAX_UNIFORM_BLOCK_SIZE","MAX_UNIFORM_BUFFER_BINDINGS","MAX_VARYING_COMPONENTS","MAX_VERTEX_OUTPUT_COMPONENTS","MAX_VERTEX_UNIFORM_BLOCKS","MAX_VERTEX_UNIFORM_COMPONENTS","MIN_PROGRAM_TEXEL_OFFSET"]};e[2]=[...e[1],"UNMASKED_VENDOR_WEBGL","UNMASKED_RENDERER_WEBGL","precisionLow","precisionMedium","precisionHigh","devicePixelRatio"];const i=t[0],n=e[i]??{},s={};for(let o=0;o<t.length;o++)s[n[o]??o]=t[o];return s}const Nh=5e3,k5=64,N5=16;class U5{constructor(e,i){this.queue=[],this.commPoiMsgOrderNumber=0,this.utcOffset=j5(),this.unsentMessages=[],this.isMetricsFailed=!1,this.onCommPoiShowEvent=({commPois:n})=>{const s=Date.now(),{tileKey:o,sessionId:r}=this.map.state;for(const a of n){const l=G5(a,s,this.commPoiMsgOrderNumber++,o,this.utcOffset,r);l&&this.queue.push(l)}this.timer||(this.timer=window.setTimeout(this.sendMessages,Nh))},this.onContextLostEvent=async()=>{const n=Date.now(),s={cpu:0,gpu:0},o={start:0,fail:!0,contextLost:!0},r=await this.createMetricMessage(n,o,s);this.queue.push(r),this.timer||(this.timer=window.setTimeout(this.sendMessages,Nh))},this.onMetricsEvent=async n=>{this.isMetricsFailed&&(n.fail=!0);const s=Date.now(),o=await this.getMetricsMessage(n,s);this.queue.push(o),this.timer||(this.timer=window.setTimeout(this.sendMessages,Nh))},this.onSendFail=n=>{this.unsentMessages.push(...n),this.timer||(this.timer=window.setTimeout(this.sendMessages,Nh))},this.sendMessages=()=>{this.timer=void 0;const n=[...this.unsentMessages,...this.queue];this.queue=[],this.unsentMessages=[],n.length&&fetch(this.bssUrl,{method:"POST",body:JSON.stringify(n),headers:{"Content-Type":"application/json"}}).then(s=>{s.ok||this.onSendFail(n)},()=>this.onSendFail(n))},this.markMetricsAsFailed=()=>{this.isMetricsFailed=!0},this.map=e,this.bssUrl=i.bssUrl??z5,i.disableBssStatisticsForCommPoi||e.on("commpoishow",this.onCommPoiShowEvent),e.on("metrics",this.onMetricsEvent),this.map.getCanvas().addEventListener("webglcontextlost",()=>{this.onContextLostEvent()}),window.addEventListener("blur",this.markMetricsAsFailed,{once:!0}),window.addEventListener("focus",this.markMetricsAsFailed,{once:!0}),document.addEventListener("visibilitychange",this.markMetricsAsFailed,{once:!0}),(!document.hasFocus()||document.hidden)&&this.markMetricsAsFailed()}destroy(){clearTimeout(this.timer),this.queue=[],this.timer=void 0,this.map.off("commpoishow",this.onCommPoiShowEvent),window.removeEventListener("blur",this.markMetricsAsFailed),window.removeEventListener("focus",this.markMetricsAsFailed),document.removeEventListener("visibilitychange",this.markMetricsAsFailed),this.map.getCanvas().removeEventListener("webglcontextlost",this.onContextLostEvent)}async getDefaultStats(){const e=D5(this.map.getWebGLContext()),i=B5(e),n=O5(i),s=this.map.performanceChecker.getFpsStats(),o=Array.from(this.map.state.center),r=this.map.state.zoom,a=this.map.state.rotation,l=this.map.state.pitch,c=await GC();return{webglStats:n,fps:s,center:o,zoom:r,rotation:a,pitch:l,webGpuSupported:c}}async createMetricMessage(e,i,n){const s=await this.getDefaultStats();return{type:411,eventType:"mapglCounter",eventId:cp(),timestamp:e,payload:{mapGlMapMetrics:{...i,...s,memory:n},mapGlHostAppParams:V5(this.map.state.bssHostAppParams)},common:{formatVersion:3,appVersion:Qg(yp,k5),product:44}}}async getMetricsMessage(e,i){const n=await this.map.performanceChecker.getMemoryStats(),s=await this.createMetricMessage(i,e,n);return s.payload.mapGlMapMetrics.fail&&!s.payload.mapGlMapMetrics.fps.isStatic&&e.firstcontent!==void 0&&(s.payload.mapGlMapMetrics.fail=!1),s}}function G5(t,e,i,n,s,o){const r={adsHighlight:!0,entity:{id:t.id,type:"branch"}};t.adsPriority!==void 0&&(r.adsPriority=t.adsPriority);const a={type:302,eventType:"view",eventId:cp(),eventOrdinal:i,uiElement:{name:"POI",ownerName:"map"},timestamp:e,utcOffset:s,payload:{POI:r},common:{formatVersion:3,appVersion:Qg(yp,N5),product:44,apikey:n}};return o&&(a.common.sessionId=o),!n||n===Ep?null:a}function j5(){const e=new Date().getTimezoneOffset(),i=e>0?"-":"+",n=`${Math.floor(Math.abs(e)/60)}`,s=`${Math.abs(e)%60}`;return i+(n.length>1?n:"0"+n)+":"+(s.length>1?s:"0"+s)}function V5(t){if(t){const e={...t};return"userId"in e&&typeof e.userId!="string"&&delete e.userId,"sessionId"in e&&typeof e.sessionId!="string"&&delete e.sessionId,"product"in e&&typeof e.product!="number"&&delete e.product,e}return t}const fx=t=>typeof t=="number"&&!isNaN(t)&&t!==Number.NEGATIVE_INFINITY&&t!==Number.POSITIVE_INFINITY;function H5(t){return Array.isArray(t)&&fx(t[0])&&fx(t[1])}var dp=(t=>(t[t.IgnoreCall=0]="IgnoreCall",t[t.UseDefault=1]="UseDefault",t))(dp||{});const Z5={0:"Method call will be ignored.",1:"Method call will use default value."};class $5{constructor(e){this.options=e}isValidGeoPoint(e,i){return this.processValidationResult(e,H5(e),"Invalid GeoPoint",i)}processValidationResult(e,i,n,s){return!i&&this.options.reportToConsole&&console.warn(`${n}: ${JSON.stringify(e)}
${Z5[s]}`),i}}const _x=new $5({reportToConsole:!0}),W5=["immersiveRoadsOff","shadowsOff","fogOff","skyOff","modelsOff","globeOff"],Er=t=>{t&&Object.entries(t).forEach(([e,i])=>{i===void 0&&delete t[e]})},mx=t=>{var e;Er(t),t.type==="group"?(Er(t.commonDefaults),Er((e=t.commonDefaults)==null?void 0:e.style),Er(t.layerTypeDefaults),t.layerTypeDefaults&&Object.values(t.layerTypeDefaults).forEach(i=>{Er(i),Er(i==null?void 0:i.style)})):t.type!=="custom"&&Er(t.style)},X5=t=>{console.warn("assertUnreachable: ",t)},Uh="Style preprocessing:";function Y5(t){const e=new Map,i=n=>{n==null||n.forEach(s=>{const o={layers:n,layer:s};e.set(s.id,o),s.type==="group"&&i(s.layers)})};return i(t.layers),e}function q5(t,e){const i=new Set;performance.now(),e!=null&&e.parentStyleId&&console.warn(`${Uh} Parent style with id=${t.parentStyleId} have parent with id=${e.parentStyleId}. Recursive inheritance is not supported.`);const n=e??t;if(n.layers=n.layers??[],e){const o=Y5(n),r=t.layersInserts??[];r.length&&r.forEach(({layer:l,beforeId:c})=>{var d;if(c){const h=o.get(c);if(h){const{layers:u,layer:f}=h,m=u.findIndex(p=>f===p);u.splice(m,0,l),l.type!=="custom"&&l.type!=="group"&&i.add(l)}else console.warn(`${Uh} Child style tries to insert layer with beforeId=${c}. There is no layer with such id in the parent style. Layer insertion ignored.`)}else(d=n.layers)==null||d.push(l)});const a=Object.keys(t.layersPatches??{}).reduce((l,c)=>(o.has(c)||l.push(c),l),[]);a.length&&console.warn(`${Uh} Child style tries to patch layers with ids which do not exist in parent style: ${a.join("; ")}`)}const s=(o,r,a,l,c)=>{var d;if(r)for(let h=0;h<r.length;h++){const u=r[h];if(u.type==="custom")continue;let f=(d=a==null?void 0:a.layersPatches)==null?void 0:d[u.id];f&&(f==null?void 0:f.type)!==u.type&&(console.warn(`${Uh} Layer patch ignored due type mismatch. Target layer with id=${u.id} has type=${u.type}, but the patch has type=${f.type}.`),f=void 0),mx(u),f&&mx(f),u.type==="group"?(s(o,u.layers,a,u,f),r[h]={...u,...f},delete r[h].commonDefaults,delete r[h].layerTypeDefaults):r[h]=K5(o,u,l,c,u.type===(f==null?void 0:f.type)?f:void 0)}};return s(i,n.layers,e?t:void 0),e&&(["background","models","icons","labelingGroups","light","graphicsPresets","terrain","environment"].forEach(o=>{(n[o]&&Object.values(n[o]).length||t[o]&&Object.values(t[o]).length)&&(n[o]={...n[o],...t[o]})}),n.name=t.name),["models","icons"].forEach(o=>{n[o]&&Object.keys(n[o]).forEach(r=>{n[o][r]===null&&delete n[o][r]})}),n}function K5(t,e,i,n,s){var a,l,c,d,h,u,f,m;const o={...i==null?void 0:i.commonDefaults},r={...n==null?void 0:n.commonDefaults};switch(e.type){case"heatmap":case"overpass":case"tunnel":{delete o.interactive,delete r.interactive,delete o.ignoreTier,delete r.ignoreTier;break}case"embankment":case"polygon3d":case"buildingModel":case"model":case"lineExtrusion":case"polygonExtrusion":case"point":{delete o.ignoreTier,delete r.ignoreTier;break}case"arrow":case"dashedLine":case"labelLine":case"line":case"metricPoint":case"oneWayLine":case"polygon":case"raster":case"shiftedLine":break;default:X5(e)}return{...o,...(a=i==null?void 0:i.layerTypeDefaults)==null?void 0:a[e.type],...e,...r,...(l=n==null?void 0:n.layerTypeDefaults)==null?void 0:l[e.type],...t.has(e)?e:void 0,...s,style:{...(c=i==null?void 0:i.commonDefaults)==null?void 0:c.style,...(h=(d=i==null?void 0:i.layerTypeDefaults)==null?void 0:d[e.type])==null?void 0:h.style,...e.style,...(u=n==null?void 0:n.commonDefaults)==null?void 0:u.style,...(m=(f=n==null?void 0:n.layerTypeDefaults)==null?void 0:f[e.type])==null?void 0:m.style,...t.has(e)?e.style:void 0,...s==null?void 0:s.style}}}async function J5(t,e,i){const n=new URL(Jo(t,{id:e}));n.searchParams.append("key",i);const s=await fetch(n.toString());if(s.status===404){console.warn(`No access to style with id «${e}».`);return}if(!s.ok)return;const o=await s.json();if(o&&o.result)return{loadedId:e,style:o.result}}async function Q5(t,e,i){let n;try{const s=Cn(i||{},{rootUrl:Ga.url,stylePath:Ga.path,iconsPath:Jh.defaultUrl,fontsPath:jt.defaultUrl,modelsPath:xp}),o=await J5(Nf(s),t,e);if(!o)throw new Error;n=o.style}catch{throw new Error("FETCH_PARENT_STYLE_ERROR")}return n}async function e6(t,e,i){let n;return t.parentStyleId&&(n=await Q5(t.parentStyleId,e,i)),q5(t,n)}const px=["zoom","rotation","pitch","center"],t6=150,i6=["static","immersive_roads"];class hp extends Qo{constructor(e,i){super();const n=this.core=new lp(e,i,this);this.state=n.state,this.modules=n.modules,this.performanceChecker=n.performanceChecker,this.values={isMoveChanging:!1,isIdle:!1},px.forEach(o=>{this.cloneFromStateToValues(o,`${o}1`),this.cloneFromStateToValues(o,`${o}2`),this.cloneFromStateToValues(o,`${o}End1`),this.cloneFromStateToValues(o,`${o}End2`),this.values[`${o}EndTime`]=0,this.values[`is${o}Changing`]=!1}),this.cloneFromStateToValues("size","size"),this.performanceChecker.on("performancecaveat",()=>{this.emit("performancecaveat")});const s=o=>{if(o instanceof Error)throw o};this.setStyle((i==null?void 0:i.style)??rc,i==null?void 0:i.styleOptions).catch(s),this.setLang(this.state.lang),i&&!i.disableBssStatistics&&(this._bssDispatcher=new U5(this,{disableBssStatisticsForCommPoi:!!i.disableBssStatisticsForCommPoi,bssUrl:i.bssUrl})),this.state.metrics.init=performance.now()-this.state.metrics.start,this.updateDataToggle()}setCenter(e,i){if(!_x.isValidGeoPoint(e,dp.IgnoreCall))return this;this.state.userHasInteracted=!1;let n=Z.fromGeo(e);return this.state.loopWorld||(n=Li(n)),yr(this.state,n,i),this}setZoom(e,i){return Zr(e,Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER)?(this.state.zoomTypePreserving="zoom",this.state.userHasInteracted=!1,io(this.state,e,i),this.state.shouldIsReadyWaitForUpdates=!0,this):this}setStyleZoom(e,i){if(!Zr(e,Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER))return this;const n=Ya(e,this.state.center);return this.state.zoomTypePreserving="styleZoom",this.state.userHasInteracted=!1,io(this.state,n,i),this}setMinZoom(e,i){return this.state.minZoom=e,this.setZoom(this.state.zoom,i),this}setMaxZoom(e,i){return this.state.maxZoom=e,this.setZoom(this.state.zoom,i),this}setRotation(e,i){return Zr(e,Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER)?(this.state.userHasInteracted=!1,Dl(this.state,ve(e),i),this):this}setPitch(e,i){return Zr(e,Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER)?(this.state.userHasInteracted=!1,Dd(this.state,ve(e),i),this):this}setAnimationTerrain(e){this.modules.demManager.setAnimationTerrain(e)}getAnimationTerrainStatus(){return this.modules.demManager.getAnimationTerrainStatus()}setMinPitch(e,i){return this.state.minPitch=ve(e),this.setPitch(Ln(this.state.pitch),i),this}setMaxPitch(e,i){return this.state.maxPitch=ve(e),this.setPitch(Ln(this.state.pitch),i),this}setLowZoomMaxPitch(e,i){return this.state.lowZoomMaxPitch=ve(e),this.setPitch(Ln(this.state.pitch),i),this}setViewport(e,i){return this.state.userHasInteracted=!1,bP(this.state,this.modules.layout.rootContainer,this.modules.renderer,e,i),this}setMaxBounds(e){return this.state.maxBounds=du(e),this}setPadding(e,i){const n={top:e.top??0,left:e.left??0,right:e.right??0,bottom:e.bottom??0};return this.state.userHasInteracted=!1,EP(this.state,this.modules.renderer,n,i),this}setTime(e){this.patchStyleState({_customUserTimeOffset:e?e-this.state.time:0}),this.modules.animationManager.clearAllTickers(),this.modules.renderer.addRerenderEvent()}getTime(e){return e?this.state.time-new Date().getTimezoneOffset()*6e4+ +(this.state.styleState._customUserTimeOffset||0):this.state.time+ +(this.state.styleState._customUserTimeOffset||0)}getPadding(){return this.state.padding}getCenter(){const e=Li(this.state.center);return Z.toGeo(e).slice(0,2)}getZoom(){return this.state.zoom}getStyleZoom(){return this.state.styleZoom}getMinZoom(){return this.state.minZoom}getMaxZoom(){return this.state.maxZoom}getRotation(){return Ln(this.state.rotation)}getPitch(){return Ln(this.state.pitch)}getViewport(){return this.state.viewport}getSize(){return[this.state.size[0],this.state.size[1]]}getBounds(e){let i=this.modules.camera;if(e!=null&&e.skipPadding)i=new hn({...this.state,padding:{left:0,right:0,top:0,bottom:0}});else if(e!=null&&e.sizeExtension){const s=e.sizeExtension,[o,r]=this.state.size,a=[o+s,r+s];i=new hn({...this.state,size:a})}i.update();const n=bo(i.getViewportVertices());return{southWest:Z.toGeo(n.min),northEast:Z.toGeo(n.max)}}getDefaultSource(){return this.modules.defaultSource}hideBuildingsById(e,i=mn){if(!e.length)return;const{identifier:n}=this.modules;n.getIdScope(i).hide(e),this.modules.renderer.addRerenderEvent({type:"triggerRerender"})}showHiddenBuildingsById(e,i=mn){if(!e.length)return;const{identifier:n}=this.modules;n.getIdScope(i).show(e),this.modules.renderer.addRerenderEvent({type:"triggerRerender"})}getWebGLContext(){return this.modules.renderer.getRenderingContext()}getCanvas(){return this.modules.layout.canvas}enableRuler(){this.modules.ruler.enable()}setRulerPoints(e){this.modules.ruler.enabled||this.modules.ruler.enable(),this.modules.ruler.setPoints(e)}disableRuler(){this.modules.ruler.disable()}showTraffic(){this.modules.trafficTileLayer.show()}hideTraffic(){this.modules.trafficTileLayer.hide()}setPersonalPoi(e){this.modules.personalPoiManager.setPersonalPoi(e)}setSelectedIds(e=[],i=mn){const{identifier:n}=this.modules,s=n.getIdScope(i);return s==null||s.select(e),this.modules.identifier.debouncedFillCache(),this}project(e){return this.modules.camera.project(e)}unproject(e){return this.modules.camera.unproject(e)}getCameraProjectionMatrix(){return this.modules.camera.projectionMatrix}getCameraViewMatrix(){return this.modules.camera.viewMatrix}getCameraViewProjectionMatrix(){return this.modules.camera.viewProjectionMatrix}invalidateSize(){this.state.userHasInteracted=!1;const e=window.devicePixelRatio,{viewport:i}=this.state,{clientWidth:n,clientHeight:s}=this.modules.layout.rootContainer;return this.state.size=[Math.max(1,n-i.left-i.right),Math.max(1,s-i.top-i.bottom)],this.modules.renderer.setPixelRatio(e),this.modules.renderer.setSize(n,s),this.modules.renderer.addRerenderEvent(),this}destroy(){var e;this.core.destroy(),(e=this._bssDispatcher)==null||e.destroy()}refresh(){return this.modules.renderer.addRerenderEvent(),this.state.needLabeling=!0,this.modules.identifier.resetCache(),this}changeFloorNumber(e,i){return this.modules.floorManager.changeFloorNumber(e,i),this.state.shouldIsReadyWaitForUpdates=!0,this}hasLayer(e){return this.modules.styleManager.hasLayer(e)}addLayer(e,i){return e.type==="custom"&&(this.state.disableAntiAliasing=!0),this.modules.styleManager.addLayer(e,i),this.core.activateStyleUpdating(),this}removeLayer(e){return this.modules.styleManager.removeLayer(e),this.core.activateStyleUpdating(),this}hideLayers(e){const{id:i,type:n}=e,s=o=>(this.modules.styleManager.hideLayers(o),this.modules.renderer.addRerenderEvent(),this);if(gv(n)&&vv(n)){const o=yv(n);if(o)return s({type:o})}else if(i)return s({id:i});return console.warn(`[#hideLayers] The layer with type "${n}" can't be hidden.`),this}showLayers(e){const{id:i,type:n}=e,s=o=>(this.modules.styleManager.showLayers(o),this.modules.renderer.addRerenderEvent(),this);if(gv(n)&&vv(n)){const o=yv(n);if(o)return s({type:o})}else if(i)return s({id:i});return console.warn(`[#showLayers] The layer with type "${n}" can't be shown.`),this}async setStyle(e,i){let n,s=!1,o=!1;try{return typeof e=="string"?LI(e)?(s=!this.core.state.disableStyleFallback&&Number.isNaN(this.state.handyStyleId)&&e!==rc,n=await this.setCustomStyleById(e,i)):n=await this.setCustomStyleFromUrl(e,i):(await this.setCustomStyleDirectly(e,i),n=e),o=!0,this.emit("styleload",{style:n}),n}catch(r){if(o)throw r;if(r instanceof Error&&this.emit("styleloaderror",{style:e}),s&&!this.currentPendingStyle)return this.setStyle(rc);throw r}}addIcon(e,i){return e?(this.modules.styleManager.addIcon(e,i)&&this.core.activateStyleUpdating(),this):(console.error("The icon name is empty."),this)}removeIcon(e){return e?(this.modules.styleManager.removeIcon(e)&&this.core.activateStyleUpdating(),this):this}addModel(e,i){return e?(this.modules.styleManager.addModel(e,i)&&this.core.activateStyleUpdating(),this):(console.error("The model name is empty."),this)}waitForGpuToFinishDrawing(){return this.modules.renderer.readIdentifyPixels(),this}setLang(e){const i=hx(this.state.rtlPlugin.scenario,e);this.state.rtlPlugin.loadFailed&&i||(this.state.lang=e,this.state.rtlPlugin.loadFailed||A5(this.state.rtlPlugin,this.modules,e).catch(n=>{throw this.state.rtlPlugin.loadFailed=!0,this.setLang(eu),n}),this.modules.tileManager.redraw())}showLabelsDebug(e){this.modules.labelsDebug.show(e)}hideLabelsDebug(){this.modules.labelsDebug.hide()}getContainer(){return this.modules.layout.mapContainer}getExternalContainer(){return this.modules.layout.externalContainer}fitBounds({northEast:e,southWest:i},n){const s={top:0,left:0,right:0,bottom:0,...n!=null&&n.padding?n.padding:{}},o=this.getViewport(),r=this.getPadding(),a=n!=null&&n.skipMapPadding?s:SP(r,s),l=this.getSize(),c=n!=null&&n.considerRotation?this.getRotation():0;if(l[0]-a.left-a.right<=0||l[1]-a.top-a.bottom<=0)return console.warn("Map cannot fit within canvas with the given bounds and padding."),this;n!=null&&n.considerRotation||Dl(this.state,c,{animate:!1});const d=bg([[i[0],e[1]],e,[e[0],i[1]],i],c,[l[0]-a.left-a.right,l[1]-a.top-a.bottom]);if(!d)return console.warn("Map cannot fit within canvas with the given bounds and padding."),this;const h=[(l[0]-a.left-a.right)/2+a.left+o.left,(l[1]-a.top-a.bottom)/2+a.top+o.top];let u;(n==null?void 0:n.maxZoom)!==void 0?u=Math.min(d.zoom,n==null?void 0:n.maxZoom):u=d.zoom,u=Be(u,this.state.minZoom,this.state.maxZoom);const m=new hn({zoom:u,rotation:this.state.rotation,size:this.state.size,padding:this.state.padding,viewport:this.state.viewport,pitch:0,center:d.center,cameraConfig:this.state.cameraConfig,globeMode:this.state.globeMode,styleState:this.state.styleState}).flat.unproject(h),p=[0,0];Ai(p,d.center,m);const _=[0,0,0];An(_,d.center,p);const g=n!=null&&n.animation?n.animation:{};g.easing||(g.easing="easeOutCubic");const y={...g};return yr(this.state,_,g),io(this.state,u,y),Dd(this.state,0,g),this}update(){const e=this.state,{time:i,userHasInteracted:n}=e,s=this.values,o={};px.forEach(l=>{let c=e[l];l==="zoom"&&e.zoomTypePreserving==="styleZoom"&&(c=e.styleZoom),o[`${l}start`]=!s[`is${l}Changing`]&&!this.areEqual(c,s[`${l}1`])&&this.areEqual(s[`${l}1`],s[`${l}2`]),o[`${l}start`]&&(s[`is${l}Changing`]=!0),s[`is${l}Changing`]&&(o[l]=!this.areEqual(c,s[`${l}1`]),i-s[`${l}EndTime`]>t6&&(o[`${l}end`]=this.areEqual(c,s[`${l}End1`])&&!this.areEqual(s[`${l}End1`],s[`${l}End2`]),o[`${l}end`]&&(s[`is${l}Changing`]=!1),this.copyFromValuesToValues(`${l}End2`,`${l}End1`),this.copyFromStateToValues(c,`${l}End1`),s[`${l}EndTime`]=i)),this.copyFromValuesToValues(`${l}2`,`${l}1`),this.copyFromStateToValues(c,`${l}1`)}),o.resize=!this.areEqual(e.size,s.size),this.copyFromStateToValues(e.size,"size"),o.movestart=(o.zoomstart||o.rotationstart||o.centerstart||o.pitchstart)&&!s.isMoveChanging,o.movestart&&(s.isMoveChanging=!0),o.move=s.iszoomChanging||s.isrotationChanging||s.iscenterChanging||s.ispitchChanging,o.moveend=(o.zoomend||o.rotationend||o.centerend||o.pitchend)&&!o.move,o.moveend&&(s.isMoveChanging=!1);const r=s.isIdle,a=s.isReady;s.isIdle=this.isIdle(),s.isReady=this.isReady(),o.idle=!r&&s.isIdle,o.ready=!a&&s.isReady,e.metrics.ready===void 0&&o.ready&&(e.metrics.ready=performance.now()-e.metrics.start);for(const l in o){const c=l;o[c]&&this.emit(c,{isUser:n})}}isIdle(){return!this.values.isMoveChanging&&!this.currentPendingStyle&&this.core.isIdle()}isReady(){return!this.values.isMoveChanging&&!this.currentPendingStyle&&this.core.isReady()}setAutoHoverMode(e){this.modules.defaultSource.resetHoverId(),this.state.disableHoverStyles=!e}setStyleState(e){const{_customUserTimeOffset:i}=this.state.styleState,n=()=>{this.state.styleState._customUserTimeOffset=i};if(this.state.graphicsPresetMode){e.graphicsPreset&&(this.state.styleState=Rh({graphicsPreset:th()?"light":e.graphicsPreset})),this.state.styleState=Rh(e,this.getGraphicsPreset().preset),n(),this.updateDataToggle(),this.modules.renderer.addRerenderEvent();return}this.state.styleState=Rh(e),n(),this.updateDataToggle(),this.modules.renderer.addRerenderEvent()}getStyleState(){return{...this.state.styleState}}patchStyleState(e){if(this.state.graphicsPresetMode){e.graphicsPreset&&(this.state.styleState=ep(this.state.styleState,{graphicsPreset:th()?"light":e.graphicsPreset})),this.state.styleState=ep(this.state.styleState,e,this.getGraphicsPreset().preset),this.updateDataToggle(),this.modules.renderer.addRerenderEvent();return}this.state.styleState=ep(this.state.styleState,e),this.updateDataToggle(),this.modules.renderer.addRerenderEvent()}setOption(e,i){if(cx.indexOf(e)===-1){console.error(`Can't change the "${e}" option.`);return}switch(e){case"loopWorld":{if(this.state.loopWorld===i)return;const n=i?mc:_c,s=this.state.maxBounds;(mo(s.min,mc.min)&&mo(s.max,mc.max)||mo(s.min,_c.min)&&mo(s.max,_c.max))&&(this.state.maxBounds=n),this.modules.renderer.addRerenderEvent();break}case"disableHidingPois":{if(this.state.disableHidingPois===i)return;this.modules.renderer.addRerenderEvent();break}}this.state[e]=i}getOption(e){if(cx.indexOf(e)===-1){console.error(`Can't get the value of the "${e}" option.`);return}return this.state[e]}getGroundPoint(e){return this.modules.demManager.getGroundPoint(e)}configureFloors({activeGroup:e,allowedFloorIds:i}){this.modules.floorManager.configure({activeGroup:e,allowedFloorIds:i})}getMapRenderStat(){var f,m,p;this.modules.renderer.addRerenderEvent();const{drawCount:e,vertexCount:i,triangleCount:n}=this.state.stats,o=598044/(this.state.size[0]*this.state.size[1]/window.devicePixelRatio),r=[{level:0,draws:[0,500],vertcles:[0,1e6],triangles:[0,333e3]},{level:1,draws:[501,1e3],vertcles:[1000001,2e6],triangles:[3330001,666e3]},{level:2,draws:[1001,1500],vertcles:[2000001,3e6],triangles:[666001,999e3]},{level:3,draws:[1501,2500],vertcles:[3000001,6e6],triangles:[999001,2e6]},{level:4,draws:[2501,3500],vertcles:[6000001,12e6],triangles:[2000001,4e6]},{level:5,draws:[3501,1/0],vertcles:[12000001,1/0],triangles:[4000001,1/0]}],a=e*o,l=i*o,c=n*o,d=((f=r.find(_=>_.draws[0]<=a&&_.draws[1]>=a))==null?void 0:f.level)||0,h=((m=r.find(_=>_.vertcles[0]<=l&&_.vertcles[1]>=l))==null?void 0:m.level)||0,u=((p=r.find(_=>_.triangles[0]<=c&&_.triangles[1]>=c))==null?void 0:p.level)||0;return{drawCount:e,vertexCount:i,drawsLevel:d,vertexLevel:h,triangleCount:n,triangleLevel:u,level:Math.ceil((d+h)/2)}}getDataToggle(){return this.modules.defaultSource.getDataType()}setLightingStyle(e){const i=this.modules.styleManager.getStyle(this.state.handyStyleId);i&&(i.light=m0(e,i.dem),i.light.lightingModesResolved={},this.state.needRerender=!0)}getFeatureFlag(e){return this.modules?this.modules.styleManager.getFeatureFlag(e):!1}getGraphicsPreset(){if(!this.state.graphicsPresetMode)throw new Error("map.getGraphicsPreset is only available when graphicsPresetMode is set.");return{name:this.state.styleState.graphicsPreset,preset:W5.reduce((e,i)=>(e[i]=this.getFeatureFlag(i),e),{})}}async setCustomStyleById(e,i){this.currentPendingStyle=e;const{iconUrl:n,styleServer:s,fontUrl:o,modelUrl:r}=this.state,a=Cn(i||{},{rootUrl:s,stylePath:Ga.path,iconsPath:n,fontsPath:o,modelsPath:r}),l=await this.fetchStyleById(Nf(a),e);if(this.currentPendingStyle!==e)return Promise.reject(`Cancel setting the style «${e}», there is a newer style was set`);if(!l)throw this.currentPendingStyle=void 0,new Error(`There is no correct style with id «${e}»`);const{style:c,loadedId:d}=l;return await this.setCustomStyle(c,a,d),d}async setCustomStyleFromUrl(e,i){this.currentPendingStyle=e;const n=Cn(i||{},{rootUrl:e,iconsPath:"",fontsPath:"",stylePath:"style.json",modelsPath:""}),s=await n6(Nf(n));if(e!==this.currentPendingStyle)return Promise.reject(`Cancel setting the style «${e}», there is a newer style was set`);if(!s)throw this.currentPendingStyle=void 0,new Error(`There are no correct styles by url «${e}»`);return await this.setCustomStyle(s,n),e}setCustomStyleDirectly(e,i){const n=window.location.protocol,s=window.location.host,o=Cn(i||{},{rootUrl:`${n}//${s}`,stylePath:"",iconsPath:"",fontsPath:"",modelsPath:""});this.currentPendingStyle=`__${Date.now()}__${performance.now()}__`;const r=e&&JSON.parse(JSON.stringify(e));return this.setCustomStyle(r,o)}async setCustomStyle(e,i,n){if(!e)throw new Error("Can't set empty style");this.currentPendingStyle=void 0;const s=await e6(e,this.state.tileKey,i);if(this.currentPendingStyle!==void 0)return;const{showCommPoi:o}=await this.modules.tileKeyInfo.getKeyInfo(),r=this.modules.styleManager.createStyle(s,i,o,n);this.state.handyStyleId=r.id,this.patchStyleState({}),this.core.activateStyleUpdating()}copyFromStateToValues(e,i){ec(e)?$a(this.values[i],e):this.values[i]=e}cloneFromStateToValues(e,i){const n=this.state[e];ec(n)?this.values[i]=Kp(n):this.values[i]=n}copyFromValuesToValues(e,i){const n=this.values[i];ec(n)?$a(this.values[e],n):this.values[e]=n}areEqual(e,i){return ec(e)&&ec(i)?mo(e,i):e===i}async fetchStyleById(e,i){const n=new URL(Jo(e,{id:i}));n.searchParams.append("key",this.state.tileKey);const s=await fetch(n.toString());if(s.status===404){console.warn(`No access to style with id «${i}».`);return}if(!s.ok)return;const o=await s.json();if(o&&o.result)return{loadedId:i,style:o.result}}updateDataToggle(){this.modules.defaultSource.setDataType(this.state.styleState.immersiveRoadsOn?i6:void 0)}}function n6(t){return fetch(t).then(e=>{if(e.ok)return e.json()})}function ec(t){return t.length!==void 0}const gx=0,s6=-1,o6=-2,vx=3,r6=0,a6=0,l6="#3388ff",c6="#00000000",d6="#00000000";let up=class extends Zi{constructor(e,i){super(e,i),this.length=1,this.isGeometryOutOfMainReplica=!1,this.removed=!1,this.options=i;const{dynamicStyle:n,layers:s}=this.modules;this.dynamicStyleId=n.getStyle().id,this.geoPoints=this.options.coordinates.filter((r,a,l)=>a===0||!v2(l[a],l[a-1])),this.points=this.geoPoints.map(r=>Z.fromGeo(r)),this.isGeometryOutOfMainReplica=this.points.some(r=>r[0]>2147483648||r[0]<-2147483648);let o=0;this.distances=[],this.distances.push(o);for(let r=1;r<this.geoPoints.length;r++)o+=qo(this.geoPoints[r-1],this.geoPoints[r]),this.distances.push(o);if(this.stateDiffer=new Et([{path:"center",type:"vec2"},{path:"zoom",type:"number"},{path:"size",type:"vec2"},{path:"rotation",type:"number"},{path:"pitch",type:"number"},{path:"padding",type:"padding"},{path:"demMode",type:"boolean"}]),this.debouncedGenerate=Fl(()=>{this.generate()},200),this.tileAttrs=rs({beginningIsCut:0,endingIsCut:0,db_tiers:i.tiers}),this.options.width!==0){this.rawStyleLayer={type:"line",id:`dynamic-polyline-${this.uniqId}`,minzoom:this.options.minZoom,maxzoom:this.options.maxZoom,style:{color:this.options.color??l6,width:this.options.width??vx},webglState:this.options.renderingMode!=="3d"?this.options.webglState:{depthTest:!0}};const r=_t(this.rawStyleLayer);if(r&&(this.styleLayerId=r.innerId,n.addLayer(r,this.options.zIndex??gx)),this.options.renderingMode==="3d"&&this.options.hiddenPartColor){this.rawHiddenStyleLayer={type:"line",id:`dynamic-polyline-hidden-${this.uniqId}`,minzoom:this.options.minZoom,maxzoom:this.options.maxZoom,style:{color:this.options.hiddenPartColor,width:this.options.width??vx},webglState:{depthTest:!0,depthMask:!1,cullFace:!1,depthFunc:window.WebGLRenderingContext.GREATER}};const a=_t(this.rawHiddenStyleLayer);a&&(this.styleHiddenLayerId=a.innerId,n.addLayer(a,this.options.zIndex??gx))}if(i.showAnimation&&i.showAnimation.animate!==!1&&this.points.length>1){this.animationTickerName=`polyline-${this.uniqId}`;const a=r==null?void 0:r.innerId;a&&this.startShowTicker(this.animationTickerName,a)}}if(this.options.width2){this.rawStyleLayer2={type:"line",id:`dynamic-polyline2-${this.uniqId}`,minzoom:this.options.minZoom,maxzoom:this.options.maxZoom,style:{color:this.options.color2??c6,width:this.options.width2??r6},webglState:this.options.renderingMode!=="3d"?this.options.webglState:{depthTest:!0}};const r=_t(this.rawStyleLayer2);r&&(this.styleLayer2Id=r.innerId,n.addLayer(r,this.options.zIndex2??s6))}if(this.options.width3){this.rawStyleLayer3={type:"line",id:`dynamic-polyline3-${this.uniqId}`,minzoom:this.options.minZoom,maxzoom:this.options.maxZoom,style:{color:this.options.color3??d6,width:this.options.width3??a6},webglState:this.options.renderingMode!=="3d"?this.options.webglState:{depthTest:!0}};const r=_t(this.rawStyleLayer3);r&&(this.styleLayer3Id=r.innerId,n.addLayer(r,this.options.zIndex3??o6))}this.styleLayerId===void 0&&this.styleLayer2Id===void 0&&this.styleLayer3Id===void 0||(s.addLayer(this),this.generate())}update(){this.removed||(super.update(),this.stateDiffer.check(this.mapState)&&this.debouncedGenerate(),this.animationTickerName&&this.updateShowTicker(this.animationTickerName))}isOutOfMainReplica(){return this.isGeometryOutOfMainReplica}snapPoint(e){function i([h,u],f=0){return[f+(h+2147483648)/4294967296,(u+2147483648)/4294967296]}function n([h,u]){return[h*4294967296-2147483648,u*4294967296-2147483648]}const s=this.mapState.visibleMapReplicas,o=this.points.map(h=>i(h));let r=1/0,a=o[0],l=0;for(const h of s){const u=i(this.modules.camera.flat.unproject(e),h);for(let f=0;f<o.length-1;f++){const m=o[f],p=o[f+1],_=IS(u,m,p),g=_[0]-u[0],y=_[1]-u[1],b=g*g+y*y;b<r&&(r=b,a=n(_),l=f)}}const c=Z.toGeo(a),d=this.distances[l]+qo(c,this.geoPoints[l]);return{point:c,distance:d}}setStyle(e){this.setSubLayerStyle(this.styleLayerId,this.rawStyleLayer,e.color),this.setSubLayerStyle(this.styleLayer2Id,this.rawStyleLayer2,e.color2),this.setSubLayerStyle(this.styleLayer3Id,this.rawStyleLayer3,e.color3),this.setSubLayerStyle(this.styleHiddenLayerId,this.rawHiddenStyleLayer,e.hiddenPartColor)}remove(){this.removed||(this.removed=!0,this.animationTickerName&&(yt(this.animationTickerName,this.mapState),this.animationTickerName=void 0),this.interactive&&this.modules.identifier.resetCache(),this.styleLayerId!==void 0&&this.modules.dynamicStyle.removeLayer(this.styleLayerId),this.styleHiddenLayerId!==void 0&&this.modules.dynamicStyle.removeLayer(this.styleHiddenLayerId),this.styleLayer2Id!==void 0&&this.modules.dynamicStyle.removeLayer(this.styleLayer2Id),this.styleLayer3Id!==void 0&&this.modules.dynamicStyle.removeLayer(this.styleLayer3Id),super.destroy())}startShowTicker(e,i){var a,l,c;const o=((a=this.options.showAnimation)==null?void 0:a.easing)!==void 0?this.options.showAnimation.easing:"linear",r=((l=this.options.showAnimation)==null?void 0:l.duration)!==void 0?this.options.showAnimation.duration:250;Bt(e,{easing:o,animationGroup:(c=this.options.showAnimation)==null?void 0:c.animationGroup},this.mapState,0,1,r,1,{layerId:i,styleId:this.dynamicStyleId}),this.length=0}setSubLayerStyle(e,i,n){if(e!==void 0&&n&&i&&n!==i.style.color){const{dynamicStyle:s}=this.modules;i.style.color=n;const o=_t(i);o&&(s.updateLayerStyle(e,o),this.modules.renderer.addRerenderEvent())}}updateShowTicker(e){kt(e,{step:(i,n)=>{var o,r,a,l;const s=yc(((r=(o=this.options.showAnimation)==null?void 0:o.durationRange)==null?void 0:r.start)||0,((l=(a=this.options.showAnimation)==null?void 0:a.durationRange)==null?void 0:l.end)||1,n);s!==this.length&&(this.length=s,this.generate())}},this.mapState)}generate(){if(this.points.length<2||this.removed)return;const e=!!this.animationTickerName,{dynamicStyle:i,collector:n,tileManager:s,identifier:o,map:r}=this.modules,{tileProps:a}=Gs,l=Math.min(Math.floor(r.getZoom()),15),c=Mt(l),d=Rg(this.points,this.distances,this.length),h=zg(d,c),u=Oe(),f=ji();this.tileObjects.forEach(m=>{m.clean(this.mapState),s.removeObject(m,e)}),this.tileObjects=[];for(let m=0;m<h.length;m++){const p=h[m];uc(f);for(let O=0;O<p.length;O++)Vi(f,p[O]);Gr(u,f);const _=Kr(u,l),g=Math.pow(2,_[2]),y=[...this.mapState.visibleMapReplicas];if(this.isOutOfMainReplica()){const O=y[0],w=y[y.length-1];y.push(O-1,w+1)}if(!y.map(O=>[_[0]+O*g,_[1],_[2],_[3]]).some(O=>this.mapState.globeMode?Ac(this.mapState,this.modules.camera,O):Xr(O,this.mapState.tilesBounds,this.modules)))continue;if(this.options.displayTileBounds){const w=i.getStyle().layers.find(V=>V.id==="debug-tile-bounds");x0(n,w,this.mapState.styleState);const x=n.getAccumulatedData(),C=new Ct("dynamicObject",x.data,this.modules,this.mapState,_);this.tileObjects.push(C),s.addObject(C,e)}const I=Ye(_),S=[],P=[];for(let O=0;O<p.length;O++)Pt(u,p[O],I),S[O]=u[0],P[O]=u[1];this.tileAttrs[a.beginningIsCut]=0,this.tileAttrs[a.endingIsCut]=0,m!==0&&(this.tileAttrs[a.beginningIsCut]=1),m+1!==h.length&&(this.tileAttrs[a.endingIsCut]=1);const T=di(this.mapState.styleState,un,yi,this.tileAttrs,Hi,this.interactive?"0":"");if(this.styleLayerId!==void 0){const O=i.getStyle().layersById[this.styleLayerId];Zc(O)&&(Zt(O,T),vt({collector:n,generator:St.generate,args:[i.getStyle().id,O,T,I,{x:S,y:P}]}))}if(this.styleHiddenLayerId!==void 0){const O=i.getStyle().layersById[this.styleHiddenLayerId];Zc(O)&&(Zt(O,T),vt({collector:n,generator:St.generate,args:[i.getStyle().id,O,T,I,{x:S,y:P}]}))}if(this.styleLayer2Id!==void 0){const O=i.getStyle().layersById[this.styleLayer2Id];Zc(O)&&(Zt(O,T),vt({collector:n,generator:St.generate,args:[i.getStyle().id,O,T,I,{x:S,y:P}]}))}if(this.styleLayer3Id!==void 0){const O=i.getStyle().layersById[this.styleLayer3Id];Zc(O)&&(Zt(O,T),vt({collector:n,generator:St.generate,args:[i.getStyle().id,O,T,I,{x:S,y:P}]}))}const L=n.getAccumulatedData(),B=new Ct("dynamicObject",L.data,this.modules,this.mapState,I.coords,this);s.addObject(B,e),this.tileObjects.push(B),this.interactive&&this.identifyIds.push(L.identifyIds)}this.interactive&&o.resetCache(),n.reset(),e||this.modules.renderer.addRerenderEvent()}};const yx=0,wx=-1,bx=8,xx=12,h6="#2480ff",u6="#ffffff",Sx=6,Mx=20,f6="#ffffff00";class Ix extends Zi{constructor(e,i){var s,o,r;super(e,i),this.isGeometryOutOfMainReplica=!1,this.length=1,this.dynamicStyleId=this.modules.dynamicStyle.getStyle().id,this.removed=!1,this.options=i,this.points=this.options.coordinates.map(a=>Z.fromGeo(a)),this.isGeometryOutOfMainReplica=this.points.some(a=>a[0]>2147483648||a[0]<-2147483648),this.distances=[],this.stateDiffer=new Et([{path:"center",type:"vec2"},{path:"zoom",type:"number"},{path:"size",type:"vec2"},{path:"rotation",type:"number"},{path:"pitch",type:"number"},{path:"padding",type:"padding"},{path:"demMode",type:"boolean"}]),this.debouncedGenerate=Fl(()=>{this.generate()},200),this.tileAttrs=rs({previousPointX:0,previousPointY:0,nextPointX:0,nextPointY:0,beginningIsCut:0,endingIsCut:0,componentDistanceStart:0,objectLength:0,db_tiers:i.tiers});const{layers:n}=this.modules;if(n.addLayer(this),this.dashLayerRaw={type:"dashedLine",id:`dynamic-dashed-polyline-dash-${this.uniqId}`,minzoom:this.options.minZoom,maxzoom:this.options.maxZoom,style:{color:this.options.dashColor||h6,dashLength:this.options.dashLength??Sx,gapColor:this.options.gapColor||f6,gapLength:this.options.gapLength??Mx,width:this.options.width??bx},webglState:this.options.renderingMode!=="3d"?this.options.webglState:{depthTest:!0}},this.baseLayerRaw={type:"line",id:`dynamic-dashed-polyline-base-${this.uniqId}`,minzoom:this.options.minZoom,maxzoom:this.options.maxZoom,style:{color:this.options.dash2Color||u6,width:((s=this.options)==null?void 0:s.width2)??xx},webglState:this.options.renderingMode!=="3d"?this.options.webglState:{depthTest:!0}},this.dashLayer=_t(this.dashLayerRaw),this.baseLayer=_t(this.baseLayerRaw),i.renderingMode==="3d"&&i.hiddenPartDashColor&&(this.hiddenDashLayerRaw={type:"dashedLine",id:`dynamic-hidden-dashed-polyline-dash-${this.uniqId}`,minzoom:this.options.minZoom,maxzoom:this.options.maxZoom,style:{color:i.hiddenPartDashColor,dashLength:this.options.dashLength??Sx,gapColor:this.options.hiddenPartGapColor,gapLength:this.options.gapLength??Mx,width:this.options.width??bx},webglState:{depthTest:!0,depthMask:!1,cullFace:!1,depthFunc:window.WebGLRenderingContext.GREATER}},this.hiddenDashLayer=_t(this.hiddenDashLayerRaw),this.options.hiddenPartDash2Color&&(this.hiddenBaseLayerRaw={type:"line",id:`dynamic-hidden-dashed-polyline-base-${this.uniqId}`,minzoom:this.options.minZoom,maxzoom:this.options.maxZoom,style:{color:this.options.hiddenPartDash2Color,width:((o=this.options)==null?void 0:o.width2)??xx},webglState:{depthTest:!0,depthMask:!1,cullFace:!1,depthFunc:window.WebGLRenderingContext.GREATER}},this.hiddenBaseLayer=_t(this.hiddenBaseLayerRaw))),i.showAnimation&&i.showAnimation.animate!==!1&&this.points.length>1){let a=0;this.distances.push(a);for(let c=1;c<this.options.coordinates.length;c++)a+=qo(this.options.coordinates[c-1],this.options.coordinates[c]),this.distances.push(a);this.animationTickerName=`dashedLine-${this.uniqId}`;const l=(r=this.baseLayer)==null?void 0:r.innerId;l&&this.startShowTicker(this.animationTickerName,l)}this.generate()}update(){this.removed||(super.update(),this.stateDiffer.check(this.mapState)&&this.debouncedGenerate(),this.animationTickerName&&this.updateShowTicker(this.animationTickerName))}isOutOfMainReplica(){return this.isGeometryOutOfMainReplica}setStyle(e){const{dashColor:i,dash2Color:n,gapColor:s,hiddenPartDashColor:o,hiddenPartGapColor:r,hiddenPartDash2Color:a}=e,{dynamicStyle:l}=this.modules;if(this.dashLayer){i!==void 0&&(this.dashLayerRaw.style.color=i),s!==void 0&&(this.dashLayerRaw.style.gapColor=s);const c=_t(this.dashLayerRaw);c&&l.updateLayerStyle(this.dashLayer.innerId,c)}if(this.baseLayer){n!==void 0&&(this.baseLayerRaw.style.color=n);const c=_t(this.baseLayerRaw);c&&l.updateLayerStyle(this.baseLayer.innerId,c)}if(this.hiddenDashLayer&&this.hiddenDashLayerRaw){o!==void 0&&(this.hiddenDashLayerRaw.style.color=o),s!==void 0&&(this.hiddenDashLayerRaw.style.gapColor=r);const c=_t(this.hiddenDashLayerRaw);c&&l.updateLayerStyle(this.hiddenDashLayer.innerId,c)}if(this.hiddenBaseLayer&&this.hiddenBaseLayerRaw){a!==void 0&&(this.hiddenBaseLayerRaw.style.color=a);const c=_t(this.hiddenBaseLayerRaw);c&&l.updateLayerStyle(this.hiddenBaseLayer.innerId,c)}this.modules.renderer.addRerenderEvent()}remove(){this.removed||(this.removed=!0,this.animationTickerName&&(yt(this.animationTickerName,this.mapState),this.animationTickerName=void 0),this.interactive&&this.modules.identifier.resetCache(),this.baseLayer&&this.modules.dynamicStyle.removeLayer(this.baseLayer.innerId),this.dashLayer&&this.modules.dynamicStyle.removeLayer(this.dashLayer.innerId),this.hiddenBaseLayer&&this.modules.dynamicStyle.removeLayer(this.hiddenBaseLayer.innerId),this.hiddenDashLayer&&this.modules.dynamicStyle.removeLayer(this.hiddenDashLayer.innerId),super.destroy())}updateShowTicker(e){kt(e,{step:(i,n)=>{var o,r,a,l;const s=yc(((r=(o=this.options.showAnimation)==null?void 0:o.durationRange)==null?void 0:r.start)||0,((l=(a=this.options.showAnimation)==null?void 0:a.durationRange)==null?void 0:l.end)||1,n);s!==this.length&&(this.length=s,this.generate())}},this.mapState)}startShowTicker(e,i){var a,l,c;const o=((a=this.options.showAnimation)==null?void 0:a.easing)!==void 0?this.options.showAnimation.easing:"linear",r=((l=this.options.showAnimation)==null?void 0:l.duration)!==void 0?this.options.showAnimation.duration:250;Bt(e,{easing:o,animationGroup:(c=this.options.showAnimation)==null?void 0:c.animationGroup},this.mapState,0,1,r,1,{layerId:i,styleId:this.dynamicStyleId}),this.length=0}generate(){if(this.points.length<2||this.removed)return;const e=!!this.animationTickerName,{dynamicStyle:i,collector:n,tileManager:s,map:o,identifier:r}=this.modules,{tileProps:a}=Gs,l=Math.min(Math.floor(o.getZoom()),12),c=Mt(l),d=Rg(this.points,this.distances,this.length),h=zg(d,c),u=Oe(),f=ji();this.tileObjects.forEach(y=>{y.clean(this.mapState),s.removeObject(y,e)}),this.tileObjects=[];const m=[];let p=0;for(const y of h){uc(f);for(let T=0;T<y.length;T++)Vi(f,y[T]);Gr(u,f);const b=Kr(u,l),v=Ye(b),I=[],S=[];let P=0;for(let T=0;T<y.length;T++)if(Pt(u,y[T],v),I[T]=u[0],S[T]=u[1],T!==0){const L=I[T]-I[T-1],B=S[T]-S[T-1];P+=Math.sqrt(L*L+B*B)}p+=P,m.push({vertices:{x:I,y:S},tileInfo:v,distance:P})}let _=0;const g=di(this.mapState.styleState,un,yi,this.tileAttrs,Hi,this.interactive?"0":"");m.forEach((y,b)=>{const{tileInfo:v,distance:I,vertices:S}=y;if(this.tileAttrs[a.beginningIsCut]=0,this.tileAttrs[a.endingIsCut]=0,this.tileAttrs[a.previousPointX]=0,this.tileAttrs[a.previousPointY]=0,this.tileAttrs[a.nextPointX]=0,this.tileAttrs[a.nextPointY]=0,this.tileAttrs[a.componentDistanceStart]=_,_+=I,this.tileAttrs[a.objectLength]=p,b!==0){const w=h[b-1],x=w[w.length-2];Pt(u,x,v),this.tileAttrs[a.beginningIsCut]=1,this.tileAttrs[a.previousPointX]=u[0],this.tileAttrs[a.previousPointY]=u[1]}if(b!==m.length-1){const x=h[b+1][1];Pt(u,x,v),this.tileAttrs[a.endingIsCut]=1,this.tileAttrs[a.nextPointX]=u[0],this.tileAttrs[a.nextPointY]=u[1]}const P=Math.pow(2,v.coords[2]),T=[...this.mapState.visibleMapReplicas];if(this.isOutOfMainReplica()){const w=T[0],x=T[T.length-1];T.push(w-1,x+1)}if(T.map(w=>[v.coords[0]+w*P,v.coords[1],v.coords[2],v.coords[3]]).every(w=>!Xr(w,this.mapState.tilesBounds,this.modules)))return;this.dashLayer&&(i.addLayer(this.dashLayer,this.options.zIndex??yx),Zt(this.dashLayer,g),vt({collector:n,generator:es.generate,args:[this.dynamicStyleId,this.dashLayer,g,v,S]})),this.baseLayer&&(i.addLayer(this.baseLayer,this.options.zIndex2??wx),Zt(this.baseLayer,g),vt({collector:n,generator:St.generate,args:[this.dynamicStyleId,this.baseLayer,g,v,S]})),this.hiddenDashLayer&&(i.addLayer(this.hiddenDashLayer,this.options.zIndex??yx),Zt(this.hiddenDashLayer,g),vt({collector:n,generator:es.generate,args:[this.dynamicStyleId,this.hiddenDashLayer,g,v,S]})),this.hiddenBaseLayer&&(i.addLayer(this.hiddenBaseLayer,this.options.zIndex2??wx),Zt(this.hiddenBaseLayer,g),vt({collector:n,generator:St.generate,args:[this.dynamicStyleId,this.hiddenBaseLayer,g,v,S]}));const B=n.getAccumulatedData(),O=new Ct("dynamicObject",B.data,this.modules,this.mapState,v.coords,this);s.addObject(O,e),this.tileObjects.push(O),this.interactive&&this.identifyIds.push(B.identifyIds)}),this.interactive&&r.resetCache(),n.reset(),e||this.modules.renderer.addRerenderEvent()}}const _6="#3388ff33",m6="#3388ff",p6=3;let Tx=class extends Zi{constructor(e,i){super(e,i),this.isGeometryOutOfMainReplica=!1,this.options=i;const n=this.options.coordinates.map(L=>{const B=L.map(O=>Z.fromGeo(O));if(B.length>1){const O=B[0],w=B[B.length-1];(O[0]!==w[0]||O[1]!==w[1])&&B.push(O)}return B});let s=[];const o=[],{dynamicStyle:r,collector:a,tileManager:l,identifier:c,layers:d}=this.modules;n.forEach(L=>{s.length&&o.push(s.length),s=s.concat(L)}),this.isGeometryOutOfMainReplica=s.some(L=>L[0]>2147483648||L[0]<-2147483648);const h=_t({type:"polygon",id:`dynamic-polygon-${this.uniqId}`,minzoom:this.options.minZoom,maxzoom:this.options.maxZoom,style:{color:this.options.color||_6}});if(!h)return;r.addLayer(h,this.options.zIndex),this.fillLayerId=h.innerId;const u=rs({beginningIsCut:0,endingIsCut:0,db_tiers:i.tiers}),f=ji();for(let L=0;L<s.length;L++)Vi(f,s[L]);const m=ir(f),p=Ye(m),_=[];for(let L=0;L<s.length;L++)_.push(s[L][0]),_.push(s[L][1]);const g=$m(_,o),y=Oe(),b=[],v=[],I=[],S=di(this.mapState.styleState,un,yi,u,Hi,this.interactive?"0":"");Zt(h,S);for(let L=0;L<g.length;L+=3){for(let B=0;B<3;B++)Pt(y,s[g[L+B]],p),b[B]=y[0],v[B]=y[1],I[B]=0;vt({collector:a,generator:qi.generate,args:[r.getStyle().id,h,S,{x:b,y:v,cut:I},dr(window.devicePixelRatio),r.getStyle().rasterSets]})}if(this.options.strokeWidth!==0){const L=_t({type:"line",id:`dynamic-polygon-stroke-${this.uniqId}`,minzoom:this.options.minZoom,maxzoom:this.options.maxZoom,style:{color:this.options.strokeColor||m6,width:this.options.strokeWidth||p6}});L&&(r.addLayer(L,this.options.zIndex),this.borderLayerId=L.innerId,Zt(L,S),n.forEach(B=>{const O=[],w=[];B.forEach((x,C)=>{Pt(y,x,p),O[C]=y[0],w[C]=y[1]}),vt({collector:a,generator:St.generate,args:[r.getStyle().id,L,S,p,{x:O,y:w}]})}))}const P=a.getAccumulatedData(),T=new Ct("dynamicObject",P.data,this.modules,this.mapState,p.coords,this);l.addObject(T),this.tileObjects.push(T),this.interactive&&this.identifyIds.push(P.identifyIds),d.addLayer(this),a.reset(),this.modules.renderer.addRerenderEvent(),this.interactive&&c.resetCache()}isOutOfMainReplica(){return this.isGeometryOutOfMainReplica}remove(){this.interactive&&this.modules.identifier.resetCache(),this.fillLayerId&&this.modules.dynamicStyle.removeLayer(this.fillLayerId),this.borderLayerId&&this.modules.dynamicStyle.removeLayer(this.borderLayerId),super.destroy()}};const g6="#3388ff33",v6="#3388ff",y6=1,w6=150;let Ex=class extends Zi{constructor(e,i){if(super(e,i),this.isGeometryOutOfMainReplica=!1,this.options=i,i.segments&&i.segments<=0)return;const{dynamicStyle:n,collector:s,tileManager:o,identifier:r,layers:a}=this.modules,l=b6(Z.fromGeo(this.options.coordinates),Vr(this.options.coordinates,this.options.radius),this.options.segments??w6);this.isGeometryOutOfMainReplica=l.some(S=>S[0]>2147483648||S[0]<-2147483648);const c=_t({type:"polygon",id:`dynamic-circle-${this.uniqId}`,minzoom:this.options.minZoom,maxzoom:this.options.maxZoom,style:{color:this.options.color??g6,strokeWidth:this.options.borderWidth??y6,strokeColor:this.options.borderColor??v6}});if(!c)return;n.addLayer(c,this.options.zIndex),this.layerId=c.innerId;const d=rs({db_tiers:i.tiers}),h=ji();for(let S=0;S<l.length;S++)Vi(h,l[S]);const u=ir(h),f=Ye(u),m=[],p=[],_=[],g=Oe(),y=this.options.borderWidth!==0?1:0;for(let S=0;S<l.length;S++)Pt(g,l[S],f),m[S]=g[0],p[S]=g[1],_[S]=y;const b=di(this.mapState.styleState,un,yi,d,Hi,this.interactive?"0":"");Zt(c,b),vt({collector:s,generator:qi.generate,args:[n.getStyle().id,c,b,{x:m,y:p,cut:_},dr(window.devicePixelRatio)]});const v=s.getAccumulatedData(),I=new Ct("dynamicObject",v.data,this.modules,this.mapState,f.coords,this);o.addObject(I),this.tileObjects.push(I),this.interactive&&this.identifyIds.push(v.identifyIds),a.addLayer(this),s.reset(),this.modules.renderer.addRerenderEvent(),this.interactive&&r.resetCache()}remove(){this.interactive&&this.modules.identifier.resetCache(),this.layerId&&this.modules.dynamicStyle.removeLayer(this.layerId),super.destroy()}isOutOfMainReplica(){return this.isGeometryOutOfMainReplica}};function b6(t,e,i){const n=[];if(i>0){n.push(at(t[0]+e,t[1],t[2]));const s=Math.PI/Math.ceil(i/2);for(let o=s;o<Math.PI;o+=s){const r=e*Math.cos(o),a=e*Math.sin(o);n.push(at(t[0]+r,t[1]+a,t[2]),at(t[0]+r,t[1]-a,t[2]))}n.push(at(t[0]-e,t[1],t[2]))}return n}function fp(t,e,i,n,s,o){if(s-n<=i)return;const r=n+s>>1;Ax(t,e,r,n,s,o%2),fp(t,e,i,n,r-1,o+1),fp(t,e,i,r+1,s,o+1)}function Ax(t,e,i,n,s,o){for(;s>n;){if(s-n>600){const c=s-n+1,d=i-n+1,h=Math.log(c),u=.5*Math.exp(2*h/3),f=.5*Math.sqrt(h*u*(c-u)/c)*(d-c/2<0?-1:1),m=Math.max(n,Math.floor(i-d*u/c+f)),p=Math.min(s,Math.floor(i+(c-d)*u/c+f));Ax(t,e,i,m,p,o)}const r=e[2*i+o];let a=n,l=s;for(tc(t,e,n,i),e[2*s+o]>r&&tc(t,e,n,s);a<l;){for(tc(t,e,a,l),a++,l--;e[2*a+o]<r;)a++;for(;e[2*l+o]>r;)l--}e[2*n+o]===r?tc(t,e,n,l):(l++,tc(t,e,l,s)),l<=i&&(n=l+1),i<=l&&(s=l-1)}}function tc(t,e,i,n){_p(t,i,n),_p(e,2*i,2*n),_p(e,2*i+1,2*n+1)}function _p(t,e,i){const n=t[e];t[e]=t[i],t[i]=n}function x6(t,e,i,n,s,o,r){const a=[0,t.length-1,0],l=[];let c,d;for(;a.length;){const h=a.pop(),u=a.pop(),f=a.pop();if(u-f<=r){for(let _=f;_<=u;_++)c=e[2*_],d=e[2*_+1],c>=i&&c<=s&&d>=n&&d<=o&&l.push(t[_]);continue}const m=Math.floor((f+u)/2);c=e[2*m],d=e[2*m+1],c>=i&&c<=s&&d>=n&&d<=o&&l.push(t[m]);const p=(h+1)%2;(h===0?i<=c:n<=d)&&(a.push(f),a.push(m-1),a.push(p)),(h===0?s>=c:o>=d)&&(a.push(m+1),a.push(u),a.push(p))}return l}function S6(t,e,i,n,s,o){const r=[0,t.length-1,0],a=[],l=s*s;for(;r.length;){const c=r.pop(),d=r.pop(),h=r.pop();if(d-h<=o){for(let _=h;_<=d;_++)Px(e[2*_],e[2*_+1],i,n)<=l&&a.push(t[_]);continue}const u=Math.floor((h+d)/2),f=e[2*u],m=e[2*u+1];Px(f,m,i,n)<=l&&a.push(t[u]);const p=(c+1)%2;(c===0?i-s<=f:n-s<=m)&&(r.push(h),r.push(u-1),r.push(p)),(c===0?i+s>=f:n+s>=m)&&(r.push(u+1),r.push(d),r.push(p))}return a}function Px(t,e,i,n){const s=t-i,o=e-n;return s*s+o*o}const M6=t=>t[0],I6=t=>t[1];class T6{constructor(e,i=M6,n=I6,s=64,o=Float64Array){this.nodeSize=s,this.points=e;const r=e.length<65536?Uint16Array:Uint32Array,a=this.ids=new r(e.length),l=this.coords=new o(e.length*2);for(let c=0;c<e.length;c++)a[c]=c,l[2*c]=i(e[c]),l[2*c+1]=n(e[c]);fp(a,l,s,0,a.length-1,0)}range(e,i,n,s){return x6(this.ids,this.coords,e,i,n,s,this.nodeSize)}within(e,i,n){return S6(this.ids,this.coords,e,i,n,this.nodeSize)}}function E6(t,e){const i=[],n=[],s=[],o=Oe();return t.forEach(({mapCoords:r,weight:a})=>{A6(o,r,e);const l=o[0],c=o[1];for(let d=0;d<6;d++)i.push(l,c),s.push(a);n.push(-1,-1,1,-1,-1,1,-1,1,1,-1,1,1)}),{vertices:new R(new Uint16Array(i),{itemSize:2,dataType:R.UnsignedShort,stride:0,offset:0,normalized:!0}),widens:new R(new Int8Array(n),{itemSize:2,dataType:R.Byte,stride:0,offset:0,normalized:!1}),weights:new R(new Float32Array(s),{itemSize:1,dataType:R.Float,stride:0,offset:0,normalized:!1})}}function A6(t,e,i){t[0]=(e[0]-i.offset[0])*rt/i.size,t[1]=(e[1]-i.offset[1])*rt/i.size}function P6(t,e){const i=L6(t),n=C6(i,e);return new j(new Uint8Array(n),{size:[e,1]})}function L6(t){const e=new Error("The palette is not valid. The heatmap won't be rendered."),i=Object.getOwnPropertyNames(t);if(i.length===0)throw e;const n=i.map(a=>Number(a));if(n.some(a=>Number.isNaN(a)||a<0||a>1))throw e;const s={};n.forEach(a=>{if(typeof t[a]!="string")throw e;s[a]=ia(t[a])});const o=Math.min(...n),r=Math.max(...n);return o>0&&(s[0]=s[o]),r<1&&(s[1]=s[r]),s}function C6(t,e){const i=Object.keys(t).map(r=>Number(r)).sort((r,a)=>r-a);let n=0;const s=[],o=e-1;for(let r=0;r<e;r++){const a=r/o;a>i[n+1]&&n++;const l=i[n],c=i[n+1],d=c-l,u=(a-l)/d;for(let f=0;f<4;f++)s[r*4+f]=z6(t[l].value[f],t[c].value[f],u)}return s.map(r=>Math.round(r))}function R6(t,e){return t.every((i,n)=>i===e[n])}function z6(t,e,i){return t*(1-i)+e*i}const F6=256,D6=.5,O6=3,B6=10,k6=1,N6=1,U6={0:"rgba(89, 0, 89, 0)",.25:"rgba(0, 0, 89, 0.78)",.5:"rgba(0, 198, 68, 1)",.7:"rgba(198, 186, 0, 1)",.8:"rgba(249, 152, 0, 1)",1:"rgba(200, 0, 0, 1)"};class G6 extends Zi{constructor(e,i={}){super(e,{interactive:!1}),this.offscreenTextureIndex=-1,this.fillBuffers=m=>{if(!this.tree)return;const p=bo(this.mapState.tilesBounds),_=ir(p);if(this.tileCoords&&R6(_,this.tileCoords))return;this.resetBuffers(),this.tileCoords=_;const g=Mt(_[2]),y=Wi(_);En(this.matrix,y,at(g,g,No));const b=this.tree.range(y[0],y[1],y[0]+g,y[1]+g).map(I=>this.points[I]),v=Ye(_);this.buffers=E6(b,v),this.vertexCount=b.length*6,this.vao=new de(m,{a_vec2_position:this.buffers.vertices,a_vec2_widen:this.buffers.widens,a_float_weight:this.buffers.weights})},this.resizeFrameBuffer=()=>{this.frameBuffer.setSize([Math.ceil(this.mapState.size[0]*window.devicePixelRatio/this.downscale),Math.ceil(this.mapState.size[1]*window.devicePixelRatio/this.downscale)]),this.frameBuffer.bind(this.gl),this.frameBuffer.unbind(this.gl);const m=this.frameBuffer.getTexture();m?this.modules.imageManager.updatePreparedTexture(this.offscreenTextureIndex,m):Ze("Can't update a non-prepared texture"),this.heatmapNeedRerender=!0,this.modules.renderer.addRerenderEvent()};const{downscale:n,palette:s,points:o,minZoom:r,maxZoom:a,zIndex:l,pointRadius:c,intensity:d,opacity:h}=i;this.rampTextureIndex=this.modules.imageManager.addPreparedTexture(P6(s??U6,F6)),this.gl=this.modules.renderer.getRenderingContext(),this.downscale=n??N6,this.frameBuffer=new Nt({size:[Math.ceil(this.mapState.size[0]*window.devicePixelRatio/this.downscale),Math.ceil(this.mapState.size[1]*window.devicePixelRatio/this.downscale)],magFilter:j.LinearFilter,minFilter:j.LinearFilter,wrapS:j.ClampToEdgeWrapping,wrapT:j.ClampToEdgeWrapping});const u=this.frameBuffer.getTexture();u?this.offscreenTextureIndex=this.modules.imageManager.addPreparedTexture(u):Ze("Can't add a non-prepared texture."),this.points=[],this.vertexCount=0,this.isDestroyed=!1,this.heatmapNeedRerender=!1,this.matrix=Gi(),this.mvpMatrix=Gi(),this.viewDiffer=new Et([{path:"center",type:"vec2"},{path:"zoom",type:"number"},{path:"rotation",type:"number"},{path:"pitch",type:"number"},{path:"padding",type:"padding"}]),this.sizeDiffer=new Et([{path:"size",type:"vec2"}]),this.throttledFillBuffer=br(this.fillBuffers,50);const f=_t({type:"heatmap",id:`dynamic-heatmap-${this.uniqId}`,minzoom:r,maxzoom:a,style:{opacity:h??D6,intensity:d??O6,radius:c??B6}});if(!f)throw new Error("There is no correct style layer for heatmap");this.layer=f,this.modules.dynamicStyle.addLayer(f,l),o&&this.setPoints(o)}isOutOfMainReplica(){return!1}setPoints(e){if(!this.isDestroyed){if(this.points=e.map(({coordinates:i,weight:n})=>({mapCoords:Z.fromGeo(i),weight:n??k6})),this.tree=new T6(this.points,i=>i.mapCoords[0],i=>i.mapCoords[1]),this.tileCoords=void 0,!this.tileObjects.length){const{layers:i,collector:n,dynamicStyle:s,tileManager:o}=this.modules;vt({collector:n,generator:Js.generateTexture,args:[s.getStyle().id,this.layer,this.offscreenTextureIndex,this.rampTextureIndex]});const r=n.getAccumulatedData(),a=new Ct("dynamicObject",r.data,this.modules,this.mapState);o.addObject(a),this.tileObjects.push(a),i.addLayer(this),n.reset()}this.modules.renderer.addRerenderEvent(),this.heatmapNeedRerender=!0}}update(){super.update();const e=this.modules.renderer.getShaderProgram("heatmap",this.modules.renderer.commonShaderDefines);if(this.sizeDiffer.check(this.mapState)&&this.resizeFrameBuffer(),!this.heatmapNeedRerender&&!this.viewDiffer.check(this.mapState)&&!this.modules.renderer.isNeedRerender()||!this.tree)return;const{zoom:i,styleZoom:n,styleState:s}=this.mapState,o=this.gl;if(this.throttledFillBuffer(e),!this.vao||!this.buffers||!this.tree||!this.tileCoords)return;const r=ut(n,s,[]),a=W(this.layer.style.radius,r),l=W(this.layer.style.intensity,r),c=256*Math.pow(2,i-this.tileCoords[2])*window.devicePixelRatio;e.enable(o),o instanceof WebGLRenderingContext&&Q0(o,e,this.mapState,this.modules),e.bind(o,{u_mat4_mvp:Us(this.mvpMatrix,this.modules.camera.viewProjectionMatrix,this.matrix),u_mat4_model:this.matrix,u_float_radius:a*window.devicePixelRatio,u_float_intensity:l,u_float_tile_to_pixel_ratio:1/c}),this.vao.bind({gl:o,extensions:this.modules.renderer.webGlExtensions}),this.gl.viewport(0,0,Math.ceil(this.mapState.size[0]*window.devicePixelRatio/this.downscale),Math.ceil(this.mapState.size[1]*window.devicePixelRatio/this.downscale)),this.frameBuffer.bind(o),o.clearColor(0,0,0,0),o.clear(o.COLOR_BUFFER_BIT),vn(o,F1,this.modules.renderer.lastAppliedGlState),o.drawArrays(o.TRIANGLES,0,this.vertexCount),this.frameBuffer.unbind(o),this.heatmapNeedRerender=!1}destroy(){if(this.isDestroyed)return;super.destroy(),this.points=[],this.tree=void 0,this.isDestroyed=!0,this.resetBuffers(),this.layer&&this.modules.dynamicStyle.removeLayer(this.layer.innerId),this.frameBuffer.remove();const{imageManager:e}=this.modules;e.deleteTexture(this.offscreenTextureIndex),e.deleteTexture(this.rampTextureIndex)}resetBuffers(){this.buffers&&(Object.values(this.buffers).forEach(e=>e.remove()),this.buffers=void 0),this.vao&&(this.vao.remove(),this.vao=void 0)}}const j6="#000000",V6=0,H6="#ffffff",Z6=0,Lx=[0,0],$6=0,W6=[0,0,0,0],mp=-1;let Cx=class extends Zi{constructor(e,i,n){var O,w;super(e,{interactive:i.interactive??!1},n),this.hovered=!1,this.lastLabelingRevision=mp,this.status="visible",this.labelingStatus=0,this.options=i,this.labelKey=`point-label-${this.uniqId}`;const s=i.font??ho,o=i.fontSize??jt.baseSize,r=i.letterSpacing??Z6,a=i.lineHeight??jt.baseLineHeight,l=[((O=this.options.offset)==null?void 0:O[0])??Lx[0],((w=this.options.offset)==null?void 0:w[1])??Lx[1]],c=_t({type:"point",id:`dynamic-pointLabel-${this.uniqId}`,minzoom:this.options.minZoom,maxzoom:this.options.maxZoom,interactive:this.interactive,style:{textFont:s,textFontSize:o,textColor:i.color??j6,textHaloWidth:i.haloRadius??V6,textHaloColor:i.haloColor??H6,textLetterSpacing:r,textLineHeight:a,textOffset:l,allowElevation:!0}}),d=Z.fromGeo(this.options.coordinates);if(this.position={userValue:d,normalizedValue:Li(d)},!c)return;const{dynamicStyle:h,collector:u,assetManager:f,styleManager:m,tileManager:p,layers:_,defaultSource:g}=this.modules,y=this.options.zIndex??$6;h.addLayer(c,y);const b=rs({db_label:this.options.text}),v=Wn(this.position.normalizedValue),I={x:[0],y:[0]},S=di(this.mapState.styleState,un,Gs.tileProps,b,Hi,this.interactive?"0":"");Zt(c,S),vt({collector:u,generator:ad,args:[h.getStyle(),c,S,Gs,Lh,v,g.getId(),I,dr(window.devicePixelRatio)]});const P=u.getAccumulatedData();if(!P.labels.length)return;const T=[{metatileHash:-1,labels:P.labels,styleId:h.getStyle().id}],L=bf(T,Eo.DynamicObject,m,this.mapState.styleState,this.mapState.styleZoom);if(L.length!==1)return;const B=L[0];T5.then(()=>{B.label=dx(B.label)??"",B.updateRanges()}).then(()=>Promise.all(B.ranges.map(x=>f.loadFont(s,x)))).then(()=>{if(this.status==="destroyed")return;B.textMetrics=yB(B.label,r,f.getFontGlyphs(s));const x=X6(i.anchor),C=o/jt.baseSize,V=o*a*B.textMetrics.lines.length,M=C*B.textMetrics.maxWidth,A=[-M*(x[0]-.5),-V*(x[1]-.5)],[E,k]=l,D=[E+A[0],k+A[1]],U=Z.toGeo(this.position.userValue),N=Yt.fromGeo(U);vt({collector:u,generator:Kc,args:[B,1,B.textMetrics,[0,0,0],N,0,D,c,h.getStyle().fontNameToIndex[s],window.devicePixelRatio]});const G=u.getAccumulatedData(),Q=new Ct("dynamicObject",G.data,this.modules,this.mapState,Wn(this.position.normalizedValue),this);pp(Q,this.position.userValue[2]),_.addLayer(this),this.tileObjects.push(Q),this.interactive&&(this.identifyIds.push(P.identifyIds),this.modules.identifier.resetCache()),u.reset(),this.options.labeling&&this.options.labeling.type!=="none"?(this.labelBox={id:this.uniqId,width:M,height:V,position:this.position.normalizedValue,offset:[D[0]-x[0]*M,D[1]-x[1]*V],labelingGroup:"pointLabel"},this.addLabelToLabeler(),this.update()):this.status==="visible"&&p.addObject(Q),this.modules.renderer.addRerenderEvent(),this.initImageIfNeed(B,M,V,l,A)})}hide(){this.status==="visible"&&(this.status="hidden",this.removeLabelFromLabeler(),this.removeTilesFromMap(),this.labelingStatus=1)}show(){this.status==="hidden"&&(this.status="visible",this.labelBox||this.addTilesToMap(),this.labelingStatus=0,this.addLabelToLabeler(),this.update())}isOutOfMainReplica(){return!1}remove(){this.status!=="destroyed"&&(this.interactive&&this.modules.identifier.resetCache(),this.removeLabelFromLabeler(),super.destroy(),this.status="destroyed")}setCoordinates(e){if(this.status==="destroyed")return;const i=Z.fromGeo(e);this.position={userValue:i,normalizedValue:Li(i)},this.tileObjects.forEach(n=>{n.setTileCoords(Wn(this.position.normalizedValue),this.mapState),pp(n,this.position.userValue[2])}),this.labelBox&&(this.labelBox.position=this.position.normalizedValue,this.addLabelToLabeler()),this.tileObjects.length!==0&&this.status==="visible"&&this.modules.renderer.addRerenderEvent()}getCoordinates(){return Z.toGeo(this.position.userValue)}update(){if(this.status==="destroyed"||(super.update(),this.status!=="visible"||!this.labelBox||this.lastLabelingRevision===this.modules.labeler.getLabelingRevision()))return;this.lastLabelingRevision=this.modules.labeler.getLabelingRevision();const e=this.modules.labeler.isLabelBoxSurvived(this.uniqId),i=this.labelingStatus;let n=eo.none;switch(this.labelingStatus){case 0:e?(this.addTilesToMap(),n=eo.none,this.labelingStatus=3):this.labelingStatus=1;break;case 1:e&&(this.addTilesToMap(),n=eo.fadeIn,this.labelingStatus=2);break;case 2:e?this.labelingStatus=3:(this.labelingStatus=4,n=eo.fadeOut);break;case 3:e||(n=eo.fadeOut,this.labelingStatus=4);break;case 4:e?(n=eo.fadeIn,this.labelingStatus=2):(this.removeTilesFromMap(),this.labelingStatus=1);break}i!==this.labelingStatus&&this.labelingStatus!==1&&this.tileObjects.forEach(s=>s.children.forEach(o=>{o.attributes.animDirection=n}))}async initImageIfNeed(e,i,n,s,o){var O,w;if(!this.options.image)return;const{imageCache:r,dynamicStyle:a,collector:l,tileManager:c}=this.modules,d=window.devicePixelRatio,h=await r.getRasterSet(this.options.image.url,void 0,this.options.image.size,[0,0]);if(!h||this.status==="destroyed")return;const u=h.rasters[0];a.appendRasterSet(h,Vs(this.options.image.url,0,0));const[f,m,p,_]=this.options.image.padding||W6,g=(i+_+m)*d,y=(n+f+p)*d,b=((m-_)/2+s[0]+o[0])*d,v=((p-f)/2+s[1]+o[1])*d,I=(O=this.options.image.stretchX)==null?void 0:O.map(([x,C])=>[x*d,C*d]),S=(w=this.options.image.stretchY)==null?void 0:w.map(([x,C])=>[x*d,C*d]),P=Z.toGeo(this.position.userValue),T=Yt.fromGeo(P);vt({collector:l,generator:Cf,args:[e,[0,0,0],T,0,u,g,y,b,v,window.devicePixelRatio,I,S]});const L=l.getAccumulatedData();l.reset();const B=new Ct("dynamicObject",L.data,this.modules,this.mapState,Wn(this.position.normalizedValue));pp(B,this.position.userValue[2]),this.tileObjects.push(B),this.status!=="hidden"&&!this.labelBox&&c.addObject(B),this.labelBox&&(this.labelBox.height=n+f+p,this.labelBox.width=i+_+m,this.labelBox.offset[0]-=_,this.labelBox.offset[1]-=f,this.addLabelToLabeler(),this.labelingStatus!==1&&this.labelingStatus!==0&&(c.addObject(B),this.mapState.needRerender=!0),this.lastLabelingRevision=mp)}addTilesToMap(){this.tileObjects.forEach(e=>{this.modules.tileManager.addObject(e)})}removeTilesFromMap(){this.tileObjects.forEach(e=>{this.modules.tileManager.removeObject(e)})}addLabelToLabeler(){this.removeLabelFromLabeler(),this.labelBox&&(this.modules.labeler.addLabelBox(this.labelKey,this.labelBox),this.lastLabelingRevision=mp)}removeLabelFromLabeler(){this.labelBox&&this.modules.labeler.removeLabels(this.labelKey)}};function X6(t){return[t&&t[0]!==void 0?Be(t[0],0,1):.5,t&&t[1]!==void 0?Be(t[1],0,1):.5]}function pp(t,e){t.modelMatrices.forEach(i=>{i[14]=e})}const Y6=18,q6=[.5,.5],K6=[0,18],J6=0,Q6=0;let eU=class extends U0{constructor(e,i){super(e,i,i.draggable),this.visible=!0,this.map=e,this.options=i;const{coordinates:n,size:s,zIndex:o,minZoom:r,maxZoom:a,hoverIcon:l,hoverSize:c,hoverAnchor:d,label:h,rotation:u,opacity:f,hoverOpacity:m}=i;this.status="normal";const p=Z.fromGeo(n);this.position={userValue:p,normalizedValue:Li(p)},this.rotation=ve(u??Q6),this.zIndex=o!==void 0?o:J6,this.minZoom=r??-1/0,this.maxZoom=a??1/0;const _=i.icon!==void 0?i.icon:Up,g=i.icon!==void 0?i.anchor:Gp;this.on("mouseover",this.switchToHoveredStyle),this.on("mouseout",this.switchToNormalStyle),this.modules.layers.addLayer(this),this.setIconInternal({icon:_,anchor:g,size:s,opacity:f}).then(()=>{l!==void 0&&this.setHoverIconInternal({icon:l,anchor:d,size:c,opacity:m})}),this.setLabel(h)}destroy(){var e;this.status!=="destroyed"&&(this.status="destroyed",(e=this.label)==null||e.remove(),this.interactive&&this.modules.identifier.resetCache(),this.off("mouseover",this.switchToHoveredStyle),this.off("mouseout",this.switchToNormalStyle),super.destroy())}update(){if(this.mapState.globeMode){const{tileManager:e}=this.modules,i=this.modules.camera.ecef.canSee(this.options.coordinates);this.visible&&!i?this.tileObjects.forEach(n=>e.removeObject(n)):!this.visible&&i&&this.tileObjects.forEach(n=>e.addObject(n)),this.visible=i}}isOutOfMainReplica(){return!1}setRotation(e){if(this.status==="destroyed")return;const i=ve(e);i!==this.rotation&&(this.rotation=i,this.normalStateData&&(this.normalStateData.styleLayer.style.iconRotation=this.rotation,this.modules.renderer.addRerenderEvent()),this.hoverStateData&&(this.hoverStateData.styleLayer.style.iconRotation=this.rotation,this.modules.renderer.addRerenderEvent()))}getRotation(){return Ln(this.rotation)}setIcon(e){this.status!=="destroyed"&&(Rx({icon:this.options.icon,anchor:this.options.anchor,size:this.options.size,opacity:this.options.opacity},e)||(this.options.icon=e.icon,this.options.anchor=e.anchor,this.options.size=e.size,this.options.opacity=e.opacity,this.setIconInternal(e)))}setHoverIcon(e){if(this.status!=="destroyed"){if(!e){this.status==="hover"&&this.switchToNormalStyle(),this.hoverStateData&&(vo(this.tileObjects,this.hoverStateData.tileObject),vo(this.identifyIds,this.hoverStateData.identifyIds),this.hoverStateData.tileObject.clean(this.mapState),this.hoverStateData=void 0);return}Rx({icon:this.options.hoverIcon,anchor:this.options.hoverAnchor,size:this.options.hoverSize,opacity:this.options.hoverOpacity},e)||(this.options.hoverIcon=e.icon,this.options.hoverAnchor=e.anchor,this.options.hoverSize=e.size,this.options.hoverOpacity=e.opacity,this.setHoverIconInternal(e))}}setLabel(e){var i;this.status!=="destroyed"&&((i=this.label)==null||i.remove(),e&&(this.label=new Cx(this.map,{coordinates:this.getCoordinates(),...e,minZoom:Math.max(e.minZoom??this.minZoom,this.minZoom),maxZoom:Math.min(e.maxZoom??this.maxZoom,this.maxZoom),fontSize:e.fontSize??Y6,anchor:e.anchor||q6,offset:e.offset||K6,zIndex:e.zIndex??this.zIndex+1e-5,interactive:this.interactive},this)))}setCoordinates(e){var i;this.setPosition(Z.fromGeo(e)),(i=this.label)==null||i.setCoordinates(e)}getCoordinates(){return Z.toGeo(this.getPosition())}show(){var e;this.status==="hidden"&&((e=this.label)==null||e.show(),this.normalStateData&&(this.modules.tileManager.addObject(this.normalStateData.tileObject),this.modules.renderer.addRerenderEvent(),this.interactive&&this.modules.identifier.resetCache()),this.status="normal")}hide(){var i,n,s;if(this.status==="destroyed"||this.status==="hidden")return;(i=this.label)==null||i.hide();const e=this.status==="normal"?(n=this.normalStateData)==null?void 0:n.tileObject:(s=this.hoverStateData)==null?void 0:s.tileObject;e&&(this.modules.tileManager.removeObject(e),this.modules.renderer.addRerenderEvent(),this.interactive&&this.modules.identifier.resetCache()),this.status="hidden"}setPosition(e){this.position={userValue:e,normalizedValue:Li(e)},this.tileObjects.length&&(this.tileObjects.forEach(i=>{i.setTileCoords(Wn(this.position.normalizedValue),this.mapState)}),this.status!=="hidden"&&(this.modules.renderer.addRerenderEvent(),this.interactive&&this.modules.identifier.resetCache()))}getPosition(){return this.position.userValue}contains(e){if(!this.normalStateData)return!1;const{hoverStateData:i,normalStateData:n}=this,s=i!==void 0?i.size:n.size,o=i!==void 0?i.anchor:n.anchor,r=this.modules.camera.flat.project(this.position.normalizedValue),a=r[0]-s[0]*o[0],l=r[0]+s[0]*(1-o[0]),c=r[1]-s[1]*o[1],d=r[1]+s[1]*(1-o[1]);return e[0]>a&&e[0]<l&&e[1]>c&&e[1]<d}switchToHoveredStyle(){if(this.status==="normal"&&this.hoverStateData&&this.normalStateData){const{tileManager:e}=this.modules;e.removeObject(this.normalStateData.tileObject),e.addObject(this.hoverStateData.tileObject),this.status="hover",this.modules.renderer.addRerenderEvent()}this.label&&(this.label.hovered=!0,this.modules.renderer.addRerenderEvent())}switchToNormalStyle(){if(this.status==="hover"&&this.normalStateData&&this.hoverStateData){const{tileManager:e}=this.modules;e.removeObject(this.hoverStateData.tileObject),e.addObject(this.normalStateData.tileObject),this.status="normal",this.modules.renderer.addRerenderEvent()}this.label&&(this.label.hovered=!1,this.modules.renderer.addRerenderEvent())}getMarkerStateData(e,{icon:i,anchor:n,size:s,opacity:o}){const{zIndex:r,position:a}=this,{collector:l,dynamicStyle:c,styleManager:d,defaultSource:h}=this.modules,u=rs({dpi:window.devicePixelRatio*96}),f=Wn(a.normalizedValue),m=typeof this.position.userValue[2]=="number"?this.position.userValue[2]:0,p=_t({type:"point",id:`dynamic-marker-${this.uniqId}`,minzoom:this.minZoom,maxzoom:this.maxZoom,style:{iconImage:i,iconAnchor:n,iconRotation:this.rotation,iconOpacity:o,elevation:m}});if(!p)throw new Error(`Marker with icon ${i} was created with null style layer`);const _=ai(p.style.iconAnchor);c.addLayer(p,r),c.appendRasterSet(e,Vs(i,_[0],_[1]));const g=di(this.mapState.styleState,un,Gs.tileProps,u,Hi,this.interactive?"0":"");Zt(p,g),vt({collector:l,generator:ad,args:[c.getStyle(),p,g,Gs,Lh,f,h.getId(),{x:[0],y:[0]},dr(window.devicePixelRatio)]});const{identifyIds:y,labels:b}=l.getAccumulatedData();if(!b.length)throw new Error(`Marker with icon ${i} was created with empty labels`);const v=[{metatileHash:-1,labels:b,styleId:c.getStyle().id}],I=bf(v,Eo.DynamicObject,d,this.mapState.styleState,this.mapState.styleZoom);if(I.length!==1)throw new Error(`Marker with icon ${i} has empty unpacked labels`);const S=I[0],P=Z.toGeo(this.position.userValue),T=Yt.fromGeo(P);Qv(l,S,[0,0,m],T,0,e.rasters[0],window.devicePixelRatio);const{data:L}=l.getAccumulatedData();l.reset();const B=new Ct("dynamicObject",L,this.modules,this.mapState,f,this);return{styleLayer:p,tileObject:B,identifyIds:y,icon:i,anchor:[e.rasters[0].anchorX,e.rasters[0].anchorY],size:s||[e.rasters[0].w/window.devicePixelRatio,e.rasters[0].h/window.devicePixelRatio]}}async setIconInternal(e){return this.modules.imageCache.getRasterSet(e.icon,void 0,e.size,e.anchor).then(i=>{if(this.status==="destroyed"||!i)return;const n=this.normalStateData,s=this.getMarkerStateData(i,e);this.status==="normal"&&(n&&this.modules.tileManager.removeObject(n.tileObject),this.modules.tileManager.addObject(s.tileObject),this.modules.renderer.addRerenderEvent(),this.interactive&&this.modules.identifier.resetCache()),n&&(vo(this.tileObjects,n.tileObject),vo(this.identifyIds,n.identifyIds),n.tileObject.clean(this.mapState)),this.tileObjects.push(s.tileObject),this.interactive&&this.identifyIds.push(s.identifyIds),this.normalStateData=s})}async setHoverIconInternal(e){return this.modules.imageCache.getRasterSet(e.icon,void 0,e.size,e.anchor).then(i=>{if(this.status==="destroyed"||!i)return;const n=this.hoverStateData,s=this.getMarkerStateData(i,e);this.status==="hover"&&(n&&this.modules.tileManager.removeObject(n.tileObject),this.modules.tileManager.addObject(s.tileObject),this.modules.renderer.addRerenderEvent(),this.interactive&&this.modules.identifier.resetCache()),n&&(vo(this.tileObjects,n.tileObject),vo(this.identifyIds,n.identifyIds),n.tileObject.clean(this.mapState)),this.tileObjects.push(s.tileObject),this.interactive&&this.identifyIds.push(s.identifyIds),this.hoverStateData=s})}};function Rx(t,e){var i,n,s,o,r,a,l,c,d,h;return!(t.icon!==e.icon||((i=t.anchor)==null?void 0:i[0])!==((n=e.anchor)==null?void 0:n[0])||((s=t.anchor)==null?void 0:s[1])!==((o=e.anchor)==null?void 0:o[1])||((r=t.size)==null?void 0:r[0])!==((a=e.size)==null?void 0:a[0])||((l=t.size)==null?void 0:l[1])!==((c=e.size)==null?void 0:c[1])||((d=t.opacity)==null?void 0:d.toString())!==((h=e.opacity)==null?void 0:h.toString()))}const tU={symbol:"polygon",sinks:{fill:{stride:8,binder:(t,e)=>{t.views.position=new Uint16Array(e),t.views.localID=new Uint32Array(e,4)},packObjectAttributes(t,e,i){return It([t,e.innerId],e,i)},unpackObjectAttributes(t){return{styleId:t[0],layerId:t[1],tileData:t.slice(2)}}}},generate(t,e,i,n,s){const o=s.x,r=s.y,a=t.idIndexer.getIndex(n,e,i),l=q(i.ignoreTier,n)?null:n.tileAttrs[n.tileProps.db_tiers],c=t.getBucket(i.type,"fill",qi.sinks.fill.packObjectAttributes(e,i,l,"",n),qi.sinks.fill.binder);let d=c.elements.offset;iU(c.indices,d,0,1,2,2,1,3),Gh(c,d++,o[0],r[0],a),Gh(c,d++,o[1],r[1],a),Gh(c,d++,o[2],r[2],a),Gh(c,d++,o[3],r[3],a),c.elements.offset=d}};function Gh(t,e,i,n,s){const o=e*4;t.views.position[o]=$+i,t.views.position[o+1]=$+n;const r=e*2;t.views.localID[r]=s}function iU(t,e,i,n,s,o,r,a){const l=t.buffer,c=t.offset;l[c]=e+i,l[c+1]=e+n,l[c+2]=e+s,l[c+3]=e+o,l[c+4]=e+r,l[c+5]=e+a,t.offset=c+6}const nU="#0085a0";class sU extends Zi{constructor(e,i){super(e,i),this.isGeometryOutOfMainReplica=!1;const{dynamicStyle:n,collector:s,tileManager:o,identifier:r,layers:a}=this.modules;this.options=i,this.points=[];const l=_t({type:"polygon",id:`dynamic-polygon-${this.uniqId}`,minzoom:this.options.minZoom,maxzoom:this.options.maxZoom,style:{color:this.options.color||nU}});if(!l)return;n.addLayer(l,this.options.zIndex),this.layerId=l.innerId;const c=rs({db_tiers:i.tiers});this.points=oU(Z.fromGeo(this.options.center),Vr(this.options.center,this.options.width),Vr(this.options.center,this.options.height)),this.isGeometryOutOfMainReplica=this.points.some(b=>b[0]>2147483648||b[0]<-2147483648);const d=ji();for(let b=0;b<this.points.length;b++)Vi(d,this.points[b]);const h=ir(d),u=Ye(h),f=[],m=[],p=Oe();for(let b=0;b<this.points.length;b++)Pt(p,this.points[b],u),f[b]=p[0],m[b]=p[1];const _=di(this.mapState.styleState,un,yi,c,Hi,this.options.interactive?"0":"");vt({collector:s,generator:tU.generate,args:[n.getStyle().id,l,_,{x:f,y:m}]});const g=s.getAccumulatedData(),y=new Ct("dynamicObject",g.data,this.modules,this.mapState,h,this);o.addObject(y),this.tileObjects.push(y),this.options.interactive&&this.identifyIds.push(g.identifyIds),a.addLayer(this),s.reset(),this.modules.renderer.addRerenderEvent(),this.options.interactive&&r.resetCache()}destroy(){this.layerId!==void 0&&this.modules.dynamicStyle.removeLayer(this.layerId),this.options.interactive&&this.modules&&this.modules.identifier.resetCache(),super.destroy()}isOutOfMainReplica(){return this.isGeometryOutOfMainReplica}}function oU(t,e,i){const n=e/2,s=i/2,o=t[0],r=t[1],a=t[2];return[[o-n,r-s,a],[o+n,r-s,a],[o-n,r+s,a],[o+n,r+s,a]]}let zx=class extends Zi{constructor(e,i){super(e,{interactive:!1}),this.isGeometryOutOfMainReplica=!1;const{dynamicStyle:n}=this.modules;this.options={...i,image:{url:i.image.url}},this.points=[],this.styleLayer=_t({type:"raster",id:`dynamic-raster-${this.uniqId}`,minzoom:this.options.minZoom,maxzoom:this.options.maxZoom,style:{opacity:this.options.opacity}}),this.styleLayer&&(n.addLayer(this.styleLayer,this.options.zIndex),this.layerId=this.styleLayer.innerId,this.modules.imageManager.loadTexture(this.options.image.url,{skipAtlasSizeChecking:!0}).then(s=>{this.textureIndex=s,this.generate()}))}destroy(){this.layerId!==void 0&&this.modules.dynamicStyle.removeLayer(this.layerId),super.destroy()}updateImage(e){const{url:i,bounds:n}=e;return!i&&!n?Promise.resolve():(i&&(this.options.image.url=i),n&&(this.options.bounds=n),(i?this.modules.imageManager.loadTexture(i,{skipAtlasSizeChecking:!0}):Promise.resolve(this.textureIndex)).then(o=>{this.textureIndex=o,this.clean(),this.generate()}))}isOutOfMainReplica(){return this.isGeometryOutOfMainReplica}generate(){if(!this.styleLayer||this.textureIndex===void 0)return;const{collector:e,dynamicStyle:i,tileManager:n,layers:s}=this.modules;this.points=rU(this.options.bounds),this.isGeometryOutOfMainReplica=this.points.some(m=>m[0]>2147483648||m[0]<-2147483648);const o=ji();for(let m=0;m<this.points.length;m++)Vi(o,this.points[m]);const r=ir(o),a=Ye(r),l=[],c=[],d=Oe();for(let m=0;m<this.points.length;m++)Pt(d,this.points[m],a),l[m]=d[0],c[m]=d[1];const h=di(this.mapState.styleState,{},yi,[],Hi);vt({collector:e,generator:fa.generate,args:[{x:l,y:c},i.getStyle().id,h,this.styleLayer,this.textureIndex,this.options.tiers??null]});const u=e.getAccumulatedData(),f=new Ct("dynamicObject",u.data,this.modules,this.mapState,r,this);n.addObject(f),this.tileObjects.push(f),s.addLayer(this),e.reset(),this.modules.renderer.addRerenderEvent()}clean(){const e=this.tileObjects[0];e&&(e.clean(this.mapState),this.modules.tileManager.removeObject(e),this.modules.layers.removeLayer(this),this.tileObjects=[])}};function rU(t){const{min:e,max:i}=du(t);return[e,[i[0],e[1]],[e[0],i[1]],i]}class aU{constructor(e,i,n){this.id=e,this.modules=i,this.options=n,this.type="raster",this.textureIndices={},this.tileLoader=new Ul("arrayBuffer"),this.attributes={},this.tiles=new Map,this.sourceAttrs=n.attributes||{},this.url=s=>{const[o,r,a]=Jr(s),{min:l,max:c}=xo(s),d={southWest:[l[0],l[1]].map(h=>h/Sp),northEast:[c[0],c[1]].map(h=>h/Sp)};return this.options.url(o,r,a,d)}}deleteTextures(){for(const e in this.textureIndices)this.modules.imageManager.deleteTexture(this.textureIndices[e]);this.textureIndices={}}abortTileFetch(e){this.tileLoader.abortRequest(Ce(e))}deleteTile(e){const i=Ce(e),n=this.textureIndices[i];isNaN(n)||this.modules.imageManager.deleteTexture(n),this.tiles.delete(i)}fetchTile(e){const i=Ce(e),n=this.url(e);return this.tileLoader.fetch(e,()=>n).then(s=>{if(s.error){const r=this.modules.sourceStorage.getSourceById(this.id);(r==null?void 0:r.type)==="raster"&&this.modules.map.emit("error",{type:"rasterTileLoadError",tileCoords:Jr(e),tileUrl:n,source:r,responseMessage:s.error.message,responseStatus:s.error.status})}return s.rejected||this.tiles.set(i,s.data),[{regionId:0,metatileHash:-1}]})}async generateTile(e,i){const n=[],s=[],o=this.modules.styleManager.getStyle(e.handyStyleId),r=Ce(i),a=this.tiles.get(r);if(!a||!o)return Promise.resolve({results:n,transferable:s});const l=await this.modules.imageManager.addTexture(a,{imagePadding:0,size:[256,256]});if(l===void 0)return Promise.resolve({results:n,transferable:s});this.textureIndices[r]=l;const c=[],d=[],h=Oe(),u=lU(Wi(i),Mt(i[2])),f=Ye(i);for(let _=0;_<u.length;_++)Pt(h,u[_],f),c[_]=h[0],d[_]=h[1];const m=di(e.styleState,this.sourceAttrs,yi,[],Hi);o.layers.filter(_=>_.type==="raster"&&q(_.filter,m)).forEach(_=>{Zt(_,m),vt({collector:this.modules.collector,generator:fa.generate,args:[{x:c,y:d},o.id,m,_,l,null]})});const p=this.modules.collector.getAccumulatedData();return n.push({regionId:0,metatileHash:0,styleId:o.id,collectorOutput:p}),s.push(...p.transferable),this.modules.collector.reset(),Promise.resolve({results:n,transferable:s})}getAttributes(){return this.attributes}setAttributes(e){this.attributes=e}destroy(){this.tileLoader.destroy()}}function lU(t,e){const i=t[0],n=t[1],s=t[2];return[[i,n,s],[i+e,n,s],[i,n+e,s],[i+e,n+e,s]]}let Fx=class{constructor(e,i,n){this.type="raster",this.id=vr(),this.modules=e.modules,this.source=new aU(this.id,this.modules,i);const s=i.minZoom??zr.minZoom,o=i.maxZoom??zr.maxZoom;this.layer=new os(s,o,s,o,this.modules,e.state,this.source),this.modules.tileManager.addTileLayer(this.layer),this.modules.sourceStorage.addSource(this),this.mapglApiSource=n}destroy(){this.source.deleteTextures(),this.modules.tileManager.removeTileLayer(this.layer),this.modules.sourceStorage.removeSource(this.getId()),this.layer.destroy()}getAttributes(){return this.source.getAttributes()}getZoomDirection(){return this.layer.getZoomDirection()}getId(){return this.source.id}setAttributes(e){this.source.setAttributes(e),this.layer.redraw()}isIdentifiedAsDefault(){return!1}};const cU=0;class dU extends Zi{constructor(e,i){super(e,i),this.options=i,this.visible=!0;const n=Z.fromGeo(i.coordinates);this.position={userValue:n,normalizedValue:Li(n)},this.zIndex=i.zIndex??cU,this.isDestroyed=!1,this.labelKey=`onlineMarker-${this.uniqId}`,this.elevation=i.elevation?i.elevation*Z.scaleFactor(i.coordinates[1])*Ge:0,this.actualIcon=i.icon,this.setIcon(i.icon)}destroy(){this.isDestroyed=!0,this.modules.identifier.resetCache(),this.modules.labeler.removeLabels(this.labelKey),super.destroy()}isOutOfMainReplica(){return!1}setIcon(e){this.actualIcon=e;const{url:i,transformer:n,size:s,anchor:o}=e;this.modules.imageCache.getRasterSet(i,n,s,o).then(r=>{if(this.isDestroyed||!r||this.actualIcon!==e)return;this.removeIcon();const a=_t({type:"point",id:`dynamic-onlineMarker-${this.uniqId}`,minzoom:-1/0,maxzoom:1/0,style:{iconImage:i,iconAnchor:o}}),l=rs({}),{collector:c,dynamicStyle:d,styleManager:h,defaultSource:u}=this.modules,f=this.zIndex;if(!a)return;const m=ai(a.style.iconAnchor);d.addLayer(a,f),d.appendRasterSet(r,Vs(i,m[0],m[1]));const p=Wn(this.position.normalizedValue),_={x:[0],y:[0]},g=di(this.mapState.styleState,un,Gs.tileProps,l,Hi,this.interactive?"0":"");Zt(a,g),vt({collector:c,generator:ad,args:[d.getStyle(),a,g,Gs,Lh,p,u.getId(),_,dr(window.devicePixelRatio)]});const y=c.getAccumulatedData(),{identifyIds:b,labels:v}=y;if(!v.length)return;const I=[{metatileHash:-1,labels:v,styleId:d.getStyle().id}],S=bf(I,Eo.DynamicObject,h,this.mapState.styleState,this.mapState.styleZoom);if(S.length!==1)return;const P=S[0],T=Z.toGeo(this.position.userValue),L=Yt.fromGeo(T);Qv(c,P,[0,0,this.elevation],L,0,r.rasters[0],window.devicePixelRatio);const B=c.getAccumulatedData();c.reset();const O=new Ct("dynamicObject",B.data,this.modules,this.mapState,Wn(this.position.normalizedValue),this);this.tileObjects.push(O),this.identifyIds=[b],this.modules.tileManager.addObject(O),this.modules.layers.addLayer(this),this.modules.identifier.debouncedFillCache(),this.modules.labeler.removeLabels(this.labelKey),this.modules.labeler.addLabelBox(this.labelKey,{id:this.uniqId,width:s[0],height:s[1],position:this.position.normalizedValue,offset:[-o[0],-o[1]],labelingGroup:"marker"}),this.modules.renderer.addRerenderEvent()})}update(){if(this.mapState.globeMode){const{tileManager:e}=this.modules,i=this.modules.camera.ecef.canSee(this.options.coordinates);this.visible&&!i?this.tileObjects.forEach(n=>e.removeObject(n)):!this.visible&&i&&this.tileObjects.forEach(n=>e.addObject(n)),this.visible=i}}removeIcon(){const e=this.tileObjects[0];e&&(e.clean(this.mapState),this.modules.tileManager.removeObject(e),this.tileObjects=[])}}function hU(t,e,i,n,s,o){return{type:t,maxDetailLevel:o,minDetailLevel:s,maxZoomLevel:n,minZoomLevel:i,zoomLevel:Math.floor(e),tiles:{},viewportTiles:[]}}function uU(t){t.tiles={},t.viewportTiles=[]}function fU(t){return{type:"data",key:Ce(t),coords:t,zoomLevel:t[2],detailLevel:t[3],needFetch:!1,needAbortFetch:!1,status:mr.Initial}}function _U(t,e,i,n,s){return hU("data",t,e,i,n,s)}function mU(t,e,i,n){if(t.zoomLevel<t.minZoomLevel){t.viewportTiles=[];return}const s=Be(t.zoomLevel,t.minZoomLevel,t.maxZoomLevel),o=Be(t.zoomLevel,t.minDetailLevel,t.maxDetailLevel);t.viewportTiles=Du(e,i,s,t.minZoomLevel,o).map(Ce);for(let r=0;r<t.viewportTiles.length;r++){const a=t.viewportTiles[r];let l=t.tiles[a];l||(l=t.tiles[a]=n(zu(a)))}}function pU(t){const e=[];for(const i in t.tiles){const n=t.tiles[i];n.needFetch&&(n.needFetch=!1,e.push(n))}return e}function gU(t){const e=[];for(const i in t.tiles){const n=t.tiles[i];n.needAbortFetch&&(n.needAbortFetch=!1,e.push(n))}return e}function vU(t,e){const i=new Set(t.viewportTiles),n=[];for(const s in t.tiles){const o=t.tiles[s];!i.has(s)&&!0&&n.push(o)}return n}class yU extends Qo{constructor(e,i,n){super(),this.prevZoomLevel=0,this.mapState=e,this.modules=i,this.config=n,this.gridState=_U(e.styleZoom,n.minZoom,n.maxZoom,n.minZoom,n.maxZoom),this.viewportDiffer=new Et([{path:"center",type:"vec2"},{path:"zoom",type:"number"},{path:"size",type:"vec2"},{path:"rotation",type:"number"},{path:"pitch",type:"number"},{path:"demMode",type:"boolean"}]),this.dataTileLoader=new Ul("json"),this.modules.layers.addLayer(this)}destroy(){uU(this.gridState),this.modules.layers.removeLayer(this)}update(){let e=!0;if(this.viewportDiffer.check(this.mapState)){const i=Math.floor(this.mapState.styleZoom);i!==this.prevZoomLevel&&(e=!1),this.prevZoomLevel=i,this.gridState.zoomLevel=i,mU(this.gridState,this.mapState,this.modules,fU),this.emit("tilesSetChanged",{tileIds:this.gridState.viewportTiles})}for(const i in this.gridState.tiles){if(!this.gridState.viewportTiles.includes(i)){this.gridState.tiles[i].status===mr.Loading&&(this.gridState.tiles[i].needAbortFetch=!0);continue}this.gridState.tiles[i].status===mr.Initial&&(this.gridState.tiles[i].needFetch=!0,this.gridState.tiles[i].status=mr.Loading)}e&&(this.fetch(pU(this.gridState)),this.abortFetch(gU(this.gridState)),this.clearTiles(vU(this.gridState)))}fetch(e){e.sort((i,n)=>Yr(this.mapState.center,i,n)).forEach(i=>this.fetchTile(i))}abortFetch(e){e.forEach(i=>{this.dataTileLoader.abortRequest(i.key)})}clearTiles(e){for(const i of e)delete this.gridState.tiles[i.key],this.emit("dataTileCleared",{tileId:i.key})}fetchTile(e){const{tsURLTemplate:i}=this.config;this.dataTileLoader.fetch(e.coords,i).then(n=>{n.rejected||this.emit("dataTileLoaded",{tileId:e.key,data:n.data})})}}const wU=Object.freeze(Object.defineProperty({__proto__:null,Circle:Ex,CircleMarker:A_,DashedPolyline:Ix,DataTileLayer:yU,DefaultSource:Qb,DynamicObject:Zi,Entrance:Db,GeoJsonSource:Md,GeoJsonTileSource:y0,GeoJsonViewportSource:Id,GltfModel:ex,Heatmap:G6,HtmlMarker:Jl,LinePatternType:Ts,Map:hp,MapClass:hp,Marker:eU,OnlineMarker:dU,PointLabel:Cx,Polygon:Tx,Polyline:up,Raster:zx,RasterTileSource:Fx,Rect:sU,ZenithSource:u_,config:d2,linePatternFromString:Ay,mapglUtils:gS,utils:dS},Symbol.toStringTag,{value:"Module"}));class ko{constructor(e,i,n){var o;const{position:s}=n;this._wrap=document.createElement("div"),this._wrap.style.userSelect="none",typeof i=="string"?this._wrap.innerHTML=i:this._wrap.appendChild(i),this._position=s,this._controlPane=e._controlPane,this._container=this._controlPane.getContainerByPosition(s),(o=this._container)==null||o.append(this._wrap)}destroy(){this._wrap.remove()}getPosition(){return this._position}setPosition(e){this._container.removeChild(this._wrap),this._container=this._controlPane.getContainerByPosition(e),this._container.append(this._wrap),this._position=e}getContainer(){return this._wrap}}const Ar={root:"_root_15b3i_1",button:"_button_15b3i_11",zoomIn:"_zoomIn_15b3i_40",zoomOut:"_zoomOut_15b3i_44"},bU=`
    <div class="${Ar.root}">
        <button type="button" class="${Ar.button} ${Ar.zoomIn}">
            <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 32 32"
                width="32"
                height="32"
                fill="currentColor"
            >
                <path d="M24 15h-7V8h-2v7H8v2h7v7h2v-7h7v-2z"></path>
            </svg>
        </button>
        <button type="button" class="${Ar.button} ${Ar.zoomOut}">
            <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 32 32"
                fill="currentColor"
                width="32"
                height="32"
            >
                <path d="M8 15h16v2H8z"></path>
            </svg>
        </button>
    </div>
`;class Dx extends ko{constructor(e,i){super(e,bU,i),this._zoomIn=n=>{n.preventDefault(),this._map.setZoom(this._map.getZoom()+1,{duration:400})},this._zoomOut=n=>{n.preventDefault(),this._map.setZoom(this._map.getZoom()-1,{duration:400})},this._checkZoom=()=>{const n=this._map.getZoom();n<=this._map.getMinZoom()?this._zoomOutButton.disabled=!0:this._zoomOutButton.disabled=!1,n>=this._map.getMaxZoom()?this._zoomInButton.disabled=!0:this._zoomInButton.disabled=!1},this._map=e,this._zoomInButton=this._wrap.querySelector(`.${Ar.zoomIn}`),this._zoomOutButton=this._wrap.querySelector(`.${Ar.zoomOut}`),this._zoomInButton.addEventListener("click",this._zoomIn),this._zoomOutButton.addEventListener("click",this._zoomOut),this._map.on("zoom",this._checkZoom)}destroy(){this._map.off("zoom",this._checkZoom),this._zoomInButton.removeEventListener("click",this._zoomIn),this._zoomOutButton.removeEventListener("click",this._zoomOut),super.destroy()}}const Pr={root:"_root_a34vx_1",button:"_button_a34vx_9",none:"_none_a34vx_24",easy:"_easy_a34vx_28",medium:"_medium_a34vx_32",hard:"_hard_a34vx_36"},xU=`<svg xmlns="http://www.w3.org/2000/svg" width="20" height="14" viewBox="0 0 20 14" style="margin-top: 4px">
    <path d="M 18,5 C 18,4 17,1 15,1 H 12 10 C 8,1 7,4 7,5 H 5 v 2 h 1 v 4 c 0,0.6 0,1 1,1 v 2 h 2 v -2 h 7 v 2 h 2 v -2 c 1,0 1,-0.4 1,-1 V 7 h 1 V 5 H 18 z M 10,3 h 2 3 c 2,0 2,1 2,3 H 8 C 8,4 8,3 10,3 z M 9,10 H 8 C 7.4,10 7,9.6 7,9 7,8.4 7.4,8 8,8 h 1 c 0.6,0 1,0.4 1,1 0,0.6 -0.4,1 -1,1 z m 8,0 H 16 C 15.4,10 15,9.6 15,9 15,8.4 15.4,8 16,8 h 1 c 0.6,0 1,0.4 1,1 0,0.6 -0.4,1 -1,1 z M 4,4 H 6 V 3 H 4 C 1,3 1,6 1,7 H 0 v 1 h 1 v 4 H 3 V 11 H 5 V 7 H 2 C 2,6 2,4 4,4 z M 3,9 4,10 H 2 V 9 h 1 z" fill="#616161" fill-rule="evenodd"/>
    <g fill="#fff">
        <path d="m 16,8 h 1 c 0.4,0 0.7,0.2 0.8,0.5 C 17.9,8.4 18,8.2 18,8 18,7.4 17.6,7 17,7 h -1 c -0.6,0 -1,0.4 -1,1 0,0.2 0.1,0.4 0.2,0.5 C 15.3,8.2 15.6,8 16,8 z"/>
        <path d="M 8,8 H 9 C 9.4,8 9.7,8.2 9.8,8.5 9.9,8.4 10,8.2 10,8 10,7.4 9.6,7 9,7 H 8 C 7.4,7 7,7.4 7,8 7,8.2 7.1,8.4 7.2,8.5 7.3,8.2 7.6,8 8,8 z"/>
        <path d="M 6,3 H 4 C 4,3 4,3 4,3 2,3 2,5 2,6 H 2 C 2.1,5 2.5,4 4,4 H 5 6 V 3 z"/>
        <path d="M0 7H1V8H0z"/>
        <path d="M 15,2 H 12 10 C 8,2 8,3 8,5 H 8 C 8,3.7 8.3,3 10,3 h 2 3 c 1.7,0 1.9,0.7 2,2 h 0 C 17,3 17,2 15,2 z"/>
        <path d="M3 9L4 9 3 8 2 8 2 9 2 9 2 9 3 9z"/>
        <path d="M 7,11 C 6,11 6,10.6 6,10 v 1 c 0,0.6 0,1 1,1 v -1 z"/>
        <path d="m 18,11 v 1 c 1,0 1,-0.4 1,-1 v -1 c 0,0.6 0,1 -1,1 z"/>
        <path d="M19 6H20V7H19z"/>
        <path d="M3 11L1 11 1 12 3 12 3 11 5 11 5 7 5 7 5 10 3 10z"/>
        <path d="M16 13H18V14H16z"/>
        <path d="M5 6H6V7H5z"/>
        <path d="M9 13L7 13 7 14 9 14 9 12 16 12 16 11 9 11z"/>
    </g>
    <g fill="#444">
        <path d="M 2,6 C 2,6.4 2,6.7 2,7 H 5 V 6 H 2 z"/>
        <path d="M2 9L2 10 4 10 3 9z"/>
        <path d="M 4,3 H 6 V 2 H 4 C 1,2 1,5 1,6 H 0 V 7 H 1 C 1,6 1,3 4,3 z"/>
        <path d="M 18,4 C 18,3 17,0 15,0 H 12 10 C 8,0 7,3 7,4 H 6 5 V 5 H 7 C 7,4 8,1 10,1 h 2 3 c 2,0 3,3 3,4 h 2 V 4 h -2 z"/>
        <path d="M 8,10 H 9 C 9.6,10 10,9.6 10,9 10,8.8 9.9,8.6 9.8,8.5 9.7,8.8 9.4,9 9,9 H 8 C 7.6,9 7.3,8.8 7.2,8.5 7.1,8.6 7,8.8 7,9 c 0,0.6 0.4,1 1,1 z"/>
        <path d="M 17,6 C 17,5.6 17,5.3 17,5 H 8 c 0,0.3 0,0.6 0,1 h 9 z"/>
        <path d="M 17.8,8.5 C 17.7,8.8 17.4,9 17,9 H 16 C 15.6,9 15.3,8.8 15.2,8.5 15.1,8.6 15,8.8 15,9 c 0,0.6 0.4,1 1,1 h 1 c 0.6,0 1,-0.4 1,-1 0,-0.2 -0.1,-0.4 -0.2,-0.5 z"/>
    </g>
</svg>
`;class Ox extends ko{constructor(e,i){super(e,"",i),this._onClick=n=>{n.preventDefault(),this._trafficVisible?(this._map.hideTraffic(),this._map.patchStyleState({trafficOn:!1})):(this._map.showTraffic(),this._map.patchStyleState({trafficOn:!0}))},this._map=e,this._trafficVisible=!1,this._render(),e.on("trafficscore",({score:n})=>{this._score=n,this._render()}),e.on("trafficshow",()=>{this._trafficVisible=!0,this._render()}),e.on("traffichide",()=>{this._trafficVisible=!1,this._render()})}_render(){const e=this._trafficVisible?SU(this._score):Pr.none,i=`
            <div class="${Pr.root}">
                <button type="button" class="${Pr.button} ${e}">
                    ${this._trafficVisible&&this._score!==void 0?this._score:xU}
                </button>
            </div>
        `;this._wrap.innerHTML=i,this._wrap.querySelector(`.${Pr.button}`).addEventListener("click",this._onClick)}}function SU(t){return t===void 0?"":t>6?Pr.hard:t>3?Pr.medium:Pr.easy}const jh={container:"_container_1k5vl_1",logos:"_logos_1k5vl_5"};var Bx=(t=>(t.osm="osm",t.api="api",t.license="license",t))(Bx||{});const MU=`<a href="https://dev.2gis.ru/link_api_map" target="_blank" style="height: 20px;">
    <svg width="40" height="20" viewBox="0 0 40 20" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M2.00011 8.72731C1.98229 5.72738 4.05025 4 6.80779 4C9.47674 4 11.2797 5.58179 11.2797 8.05437C11.2797 10.1091 10.0602 11.2546 7.99196 12.2727C7.21431 12.6547 6.34807 13.1818 5.46454 13.4544H11.3681V16H2.00011V12.66C3.85604 12.0235 4.88111 11.3271 6.59576 10.4728C7.90363 9.81815 8.71666 9.23633 8.71666 8.1819C8.71666 7.16358 7.97439 6.36366 6.80779 6.36366C5.27006 6.36366 4.52753 7.52729 4.56292 8.72731H2.00011Z" fill="#6E7173"/>
        <path d="M23.6348 9.63643V10.5453C23.6348 13.5455 21.6552 16 18.067 16C14.6202 16 12.2518 13.4727 12.2518 9.99986C12.2518 6.52731 14.5497 4 18.1554 4C21.2487 4 23.1751 5.8363 23.6348 7.99991H21.0717C20.6301 6.96353 19.534 6.36366 18.2261 6.36366C15.9813 6.36366 14.7263 8.14523 14.7263 9.99986C14.7263 11.8545 15.9991 13.6363 18.2086 13.6363C19.5872 13.6363 20.736 12.9456 21.0896 11.8181H17.7313V9.63643H23.6348Z" fill="#6E7173"/>
        <path d="M27.4528 16H24.9783V4H27.4528V16Z" fill="#6E7173"/>
        <path d="M38.4292 7.63648H35.8662C35.6185 6.85461 34.947 6.18167 33.4446 6.18167C32.1543 6.18167 31.5004 6.69096 31.5004 7.41809C31.5004 8.30915 32.7375 8.56366 34.293 8.83623L34.361 8.84818C36.4076 9.20779 38.5 9.57545 38.5 12.2727C38.5 14.8 36.4672 16 33.7274 16C31.1998 16 28.9373 14.4727 28.6899 12.1818H31.2527C31.5712 13.1273 32.5079 13.8181 33.8512 13.8181C35.1415 13.8181 35.8662 13.3818 35.8662 12.5455C35.8662 11.514 34.3606 11.2653 32.8555 11.0167C32.8221 11.0112 32.7887 11.0056 32.7553 11.0001C31.1468 10.7273 28.8844 9.9818 28.8844 7.54535C28.8844 5.34534 30.7581 4 33.5332 4C36.2727 4 38.164 5.41814 38.4292 7.63648Z" fill="#6E7173"/>
    </svg>
</a>`,IU=`<a href="https://dev.urbi.ae" target="_blank" style="height: 20px; line-height: 20px;">
    <svg style="width: auto; height: 16px;" width="29" height="12" viewBox="0 0 29 12" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path fill-rule="evenodd" clip-rule="evenodd" d="M5 4V8.0625C5 9.13823 4.64701 9.5 3.75 9.5C3.00479 9.5 2.5 9.15185 2.5 8.0625V4H0V8.5C0 10.6515 1.45917 12 3.75 12C6.19263 12 7.5 10.6515 7.5 8.5V4H5ZM18.5 9.5V2H16V11.9993L20.5 12C23.013 12.0276 24.5 10.4576 24.5 8C24.5 5.4872 23.2711 4 20.5 4H19.5V6.5H20.5C21.6954 6.5 22 6.9645 22 8C22 9.06311 21.3422 9.51381 20.5 9.5H18.5ZM13 4C12.1529 4 11.7541 4.19542 11.5 5L11 4H9.01412V12H11.5V7.75C11.5 6.87606 12.1106 6.5 13 6.5H15V4H13ZM28.25 12V4H25.75V12H28.25ZM27 3C27.9508 3 28.75 2.32569 28.75 1.5C28.75 0.674312 27.9508 0 27 0C26.0492 0 25.25 0.674312 25.25 1.5C25.25 2.32569 26.0492 3 27 3Z" fill="#6E7173"/>
    </svg>
</a>`,kx=t=>`
    <div class=${jh.container}>
        <div class=${jh.logos}>
            ${t==="2gis"?MU:IU}
        </div>
    </div>
`,TU=200,EU=.4,AU=6.9,PU={type:"FeatureCollection",features:[{type:"Feature",properties:{},geometry:{coordinates:[[[31.287134399571926,46.13828663057069],[32.75238568004798,45.79865765372267],[33.58288063506086,46.01903186613521],[33.61486347995313,46.2235364272577],[33.78934942202696,46.198543888421256],[35.00827602994491,45.75534495217423],[35.2288647404554,45.79620376974098],[35.17718890419883,45.90635851081622],[35.435536217844785,46.10280090340363],[35.79210757517962,46.37361688082296],[36.11428232078944,46.29643073207143],[36.55169983042855,46.510726153023995],[36.8324385653631,46.4588228565425],[37.14524285843429,46.69589191473136],[37.39260951621397,46.689280151379506],[37.627431059848774,46.82264082535376],[38.1229012131082,46.84212508154449],[38.33448922300602,46.97422615512966],[38.224662200013626,47.230888527366346],[38.32912700579817,47.25438400708447],[38.34419757143178,47.312784332059664],[38.21546574161874,47.30909993831261],[38.254518753011865,47.36826000208279],[38.31067651491526,47.38482171052604],[38.321606223663025,47.571364572295465],[38.3617938178036,47.57882910808604],[38.36170197978049,47.618956233608515],[38.45674637734251,47.62208601169297],[38.46107375227305,47.64691148544472],[38.63803321177437,47.647842642655746],[38.672098728783254,47.68762314810277],[38.775725461608346,47.68709376851825],[38.8049944923477,47.813690288503295],[38.834920351813224,47.8196727375917],[38.84241614380997,47.85748354545768],[39.07247756595089,47.86497172354581],[39.10052537670751,47.840884138531834],[39.38214421832214,47.86795888702861],[39.40746330974267,47.8256169720315],[39.482844878880115,47.85023053453213],[39.53382832770623,47.81883936134608],[39.73848854131376,47.82763637975813],[39.79371699101341,47.869042802541685],[39.83078252402845,47.99974474342423],[39.77863815152742,48.03277123184873],[39.88321233741743,48.03971572761765],[39.870917803736376,48.113006872810985],[39.93505319594328,48.18105768715421],[39.94606694701065,48.22361687262517],[40.01236868994266,48.22433847068592],[40.03218509167988,48.26056076274611],[39.984065212024376,48.320002192647365],[39.922439044370975,48.29188408842856],[39.851945001258656,48.331239182362935],[39.94636538164761,48.35223341528243],[39.941853222859265,48.388067879458134],[39.899783141900656,48.45166958120498],[39.85004077188802,48.47107700658495],[39.85404334598155,48.49815859245703],[39.871488094298144,48.507759719913],[39.83989084312387,48.58511601134842],[39.690955803936305,48.59154349398949],[39.668972082370914,48.61595180677952],[39.71340429381095,48.65723964838148],[39.72739208280473,48.68576344104625],[39.720852030234056,48.70453377084817],[39.71060957078353,48.71895533887451],[39.72773821117514,48.727349762777976],[39.742522688889096,48.74565876284592],[39.73675984758131,48.75923566351821],[39.75294236354742,48.76535707528038],[39.77230712573868,48.765131537231696],[39.78708527484656,48.792695126714506],[39.79951920927968,48.83846452038483],[39.97324551864918,48.788853683331496],[40.0854569051011,48.87270686936236],[40.054991236497585,48.91511705296017],[40.01572101314082,48.91564488817568],[39.985747700540486,48.87433169550951],[39.92581794882187,48.895346707874324],[39.85691072202724,48.89266055501065],[39.84380033698696,48.90643237682923],[39.77980530005851,48.92505561008153],[39.76769275004051,48.96624269122293],[39.75249250304927,48.988397421631134],[39.72953342924575,48.98364479695306],[39.6963475099607,49.006204908207565],[39.67412801512273,48.99350840477692],[39.688776866237845,49.04629763624743],[39.77599141224027,49.03984390969006],[39.80998946255809,49.05657174933967],[39.94020528746006,49.054672146531885],[39.94517686594733,49.08306814321608],[40.03354656530658,49.17940433543734],[40.08179564952226,49.187957220033326],[40.127812302222935,49.23339833688371],[40.21735722846822,49.24434936924021],[40.23083631365782,49.264375707391025],[40.184193609561845,49.28357807698788],[40.20554425700146,49.348627711592286],[40.0352506597566,49.460305560239135],[40.042265513048875,49.52110947883719],[40.17301947712943,49.570462036839785],[40.135367644468886,49.619991840168154],[39.930446598607006,49.58753811881613],[39.89326483911972,49.561338740411344],[39.80152397436578,49.5648154530997],[39.747824755329106,49.601752391386356],[39.65652368638126,49.620013992728445],[39.59591913143757,49.727977277611615],[39.43167355486196,49.76704897880802],[39.38482981859343,49.7428519723461],[39.28679269123114,49.7589376228415],[39.23167115889703,49.80067773683314],[39.23126430925569,49.83799228995301],[39.184177982005934,49.89212328019818],[38.939466721594385,49.8129411626972],[38.67999394500015,49.99954348208959],[38.498971405582154,49.969630683120045],[38.36122588838947,50.008962505581735],[38.33064743770436,50.10587365547255],[38.179344250662524,50.08108187117696],[38.17324129258458,49.96421343242167],[38.0243275352658,49.9126740335152],[38.00390141376576,49.80621204332192],[37.9339784494789,49.72626072303203],[37.997665462537555,49.705679809807805],[37.98195913415958,49.63338227733652],[37.87841001479606,49.55639540561637],[37.8726905583969,49.314558240834856],[37.83487442598039,49.211403426079585],[37.568531160033984,49.23978324969454],[37.49068171343487,49.18083483226363],[37.467253126665184,49.08118016596504],[37.29258016280227,48.98322524059054],[37.27222555931064,48.936467375391885],[36.983084082742096,48.80186787172613],[36.72382254183347,48.816637155788754],[36.863697512625095,48.16812695432242],[36.85276964213293,48.06101666035238],[36.63699950073965,48.1120861847823],[36.55643334225425,48.079707051057994],[36.5326892781749,47.85663993329777],[36.15757828505022,47.87029971236788],[36.007257866960344,48.150801757163464],[35.84084530869785,48.072372143164614],[35.69001200739808,48.14916424481041],[34.84251652180234,48.13828093857032],[34.93636037372508,47.54124693653375],[34.561002995692604,47.57138977148597],[33.975870854429644,47.468842659893966],[33.94579238047862,47.53020932511487],[33.65802349898351,47.49630012349715],[33.57945696368617,47.61817363276853],[33.07047295330287,47.579949515419315],[33.106438567586736,47.23712252316682],[32.87965855893614,47.10939623564883],[32.94045936300873,47.00638816222238],[32.531962255274834,46.887846448242044],[32.23541823078415,46.84566846340053],[31.99589893588245,46.69298741295057],[31.792169481175108,46.355938076969124],[31.231245271853055,46.42046225841926],[31.287134399571926,46.13828663057069]]],type:"Polygon"}}]};class LU extends ko{constructor(e,i){super(e,kx(i.copyrightType),i),this.copyrightType="2gis",this._isHidden=!1,this._onViewportchange=()=>{this.throttledVisibleCopyright()},this._onClick=s=>{if(s.target&&RU(s.target)){const o=s.target.dataset.type;o&&CU(o)&&this._map.emit("copyrightclick",{type:o,href:s.target.href,originalEvent:s})}},this.copyrightType=i.copyrightType,this._map=e,this._map._impl.on("viewportchange",this._onViewportchange),this._map._impl.on("idle",this._onViewportchange),i.interactive===!1&&(this._wrap.style.pointerEvents="none"),this._excludeAreaSource=new $x(this._map,{data:PU}),this._excludeAreaSource._impl.layer.updateViewport=()=>{Cl(this._excludeAreaSource._impl.layer.gridState,{...this._map._impl.state,styleZoom:this._map._impl.state.styleZoom+1},this._map._impl.modules)},this._wrap.querySelector(`.${jh.container}`).addEventListener("click",this._onClick),this.throttledVisibleCopyright=br(()=>{this.update()},TU)}destroy(){this._map._impl.off("viewportchange",this._onViewportchange),this._map._impl.off("idle",this._onViewportchange),this._wrap.querySelector(`.${jh.container}`).removeEventListener("click",this._onClick),super.destroy()}update(){var n,s;const e=(n=this._excludeAreaSource)==null?void 0:n._impl.sourceCore.idToIndex;let i=!1;if(this._map.getZoom()>AU&&e){let o=0;const r=((s=this._excludeAreaSource)==null?void 0:s._impl.layer.gridState.viewportTiles)||[];for(const a of r){const l=e[a];l&&(o+=Object.keys(l).length)}i=o>r.length*EU}i&&!this._isHidden&&(this._isHidden=!0,super.getContainer().innerHTML=""),!i&&this._isHidden&&(this._isHidden=!1,super.getContainer().innerHTML=kx(this.copyrightType))}}function CU(t){return t in Bx}function RU(t){return t&&"href"in t&&"dataset"in t}const Nx={wrap:"_wrap_sphd3_1",container:"_container_sphd3_16"};class zU{constructor(e,i){this.rootContainer=e._impl.modules.layout.rootContainer,this.content=i,this.isShown=!1}display(){this.isShown||(this.wrap||(this.wrap=this.initWrap()),this.rootContainer.appendChild(this.wrap),this.isShown=!0)}hide(){this.isShown&&(this.wrap&&this.rootContainer.removeChild(this.wrap),this.isShown=!1)}isDisplayed(){return this.isShown}}const FU=` <div class=${Nx.container}>Your MapGL key is invalid. Please contact api@2gis.com to get MapGL key.</div> `;class DU extends zU{constructor(e){super(e,FU),e._impl.on("invalidtilekey",()=>{this.isDisplayed()||this.display()})}initWrap(){const e=document.createElement("div");return e.classList.add(`${Nx.wrap}`),e.innerHTML=this.content,e}}class OU{constructor(e){this.northEast=e.northEast,this.southWest=e.southWest}extend(e){return this.southWest=[Math.min(this.southWest[0],e[0]),Math.min(this.southWest[1],e[1])],this.northEast=[Math.max(this.northEast[0],e[0]),Math.max(this.northEast[1],e[1])],this}getCenter(){return[(this.southWest[0]+this.northEast[0])/2,(this.southWest[1]+this.northEast[1])/2]}containsPoint(e){const[i,n]=e,s=i>=this.southWest[0]&&i<=this.northEast[0],o=n>=this.southWest[1]&&n<=this.northEast[1];return s&&o}containsBounds(e){const{southWest:i,northEast:n}=e,s=this.containsPoint(i),o=this.containsPoint(n);return s&&o}intersects(e){const{southWest:i,northEast:n}=e,s=this.getPointRelatedLocation(i),o=this.getPointRelatedLocation(n),r=+s.N+ +o.N,a=+s.S+ +o.S,l=+s.W+ +o.W,c=+s.E+ +o.E;return!(r===2||a===2||l===2||c===2)}getPointRelatedLocation(e){return{S:e[1]<this.southWest[1],N:e[1]>this.northEast[1],W:e[0]<this.southWest[0],E:e[0]>this.northEast[0]}}}const Mn={root:"_root_1g6lv_1",container:"_container_1g6lv_5",scroller:"_scroller_1g6lv_15",content:"_content_1g6lv_24",control:"_control_1g6lv_29",label:"_label_1g6lv_61"},BU=`
    <div class="${Mn.root}">
        <div class="${Mn.container}">
            <div class="${Mn.scroller}">
                <div class="${Mn.content}" />
            </div>
        </div>
    </div>
`,kU='<svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"><path d="M240-200h120v-240h240v240h120v-360L480-740 240-560v360Zm-80 80v-480l320-240 320 240v480H520v-240h-80v240H160Zm320-350Z" /></svg>';class Ux extends ko{constructor(e,i){super(e,BU,i),this.options=i,this._removeButtonsEventListeners=()=>{this._content&&this._content.childNodes.forEach(n=>{if(this._handlers.has(n)){const s=this._handlers.get(n);s!==void 0&&n.removeEventListener("click",s)}})},this._showControl=n=>{var l;const{currentFloorLevelIndex:s,floorPlanId:o,floorLevels:r}=n;this._floor={currentFloorLevelIndex:s,floorPlanId:o},this._root.style.display="block",this._content.innerHTML="";let a;if(r.forEach(({floorLevelIndex:c,floorLevelName:d})=>{const h=document.createElement("button");h.className=Mn.control,h.innerHTML=`<div class="${Mn.label}">${d}</div>`,h.name=c.toLocaleString(),h.type="button",s===c&&(h.disabled=!0,a=h);const u=this._controlHandler(c);h.addEventListener("click",u),this._handlers.set(h,u),this._content.append(h)}),this.options.hideFloorsButton){const c=document.createElement("button");c.className=`${Mn.control} ${Mn.hideFloorsButton}`,c.innerHTML=`<div class="${Mn.label}">${kU}</div>`,c.name="NaN",c.type="button",Number.isNaN(s)&&(c.disabled=!0,a=c);const d=this._controlHandler(NaN);c.addEventListener("click",d),this._handlers.set(c,d),this._content.append(c)}if(a&&a.offsetTop){const c=(l=a.parentElement)==null?void 0:l.parentElement;c&&(c.scrollTop=a.offsetTop)}},this._hideControl=()=>{this._map._impl.state.floorsEnabled&&(this._removeButtonsEventListeners(),this._floor=void 0,this._root.style.display="none")},this._onLevelChange=n=>{this._switchCurrentFloorLevel(n.floorLevelIndex)},this._controlHandler=n=>s=>{if(s.preventDefault(),this._switchCurrentFloorLevel(n),this._floor){const o=!Number.isNaN(n);this._map._impl.state.floorsEnabled=o,o&&this._map.setFloorPlanLevel(this._floor.floorPlanId,n)}},this._switchCurrentFloorLevel=n=>{this._floor&&(this._wrap.querySelector(`.${Mn.control}[name="${this._floor.currentFloorLevelIndex}"]`).disabled=!1,this._wrap.querySelector(`.${Mn.control}[name="${n}"]`).disabled=!0,this._floor.currentFloorLevelIndex=n)},this._map=e,this._root=this._wrap.querySelector(`.${Mn.root}`),this._content=this._wrap.querySelector(`.${Mn.content}`),this._handlers=new WeakMap,this._root.style.display="none",e.on("floorplanshow",this._showControl),e.on("floorplanhide",this._hideControl),e.on("floorlevelchange",this._onLevelChange)}destroy(){this._map.off("floorplanshow",this._showControl),this._map.off("floorplanhide",this._hideControl),this._map.off("floorlevelchange",this._onLevelChange),this._removeButtonsEventListeners(),super.destroy()}}const gp={controlPane:"_controlPane_mz9by_1",container:"_container_mz9by_10",topLeft:"_topLeft_mz9by_23",topCenter:"_topCenter_mz9by_28",topRight:"_topRight_mz9by_34",centerLeft:"_centerLeft_mz9by_39",centerRight:"_centerRight_mz9by_45",bottomLeft:"_bottomLeft_mz9by_51",bottomCenter:"_bottomCenter_mz9by_56",bottomRight:"_bottomRight_mz9by_62"},ic=10;class NU{constructor(e,i){this.wrap=document.createElement("div"),this.wrap.className=gp.controlPane,this.containers={};const{rootContainer:n}=e._impl.modules.layout;n.appendChild(this.wrap),this.padding={top:ic,right:ic,bottom:ic,left:ic},this.setPadding(i.padding||{})}setPadding(e){Object.keys(this.padding).forEach(i=>{const n=i;this.padding[n]=e[n]??ic,this.wrap.style[`margin${n.replace(/^\w/,s=>s.toUpperCase())}`]=`${this.padding[n]}px`})}getPadding(){return{...this.padding}}destroy(){this.wrap.remove()}getContainerByPosition(e){let i=this.containers[e];return i||(i=this.containers[e]=this._initControlContainer(e)),i}_initControlContainer(e){const i=document.createElement("div");return i.classList.add(gp.container,gp[e]),this.wrap.appendChild(i),i}}const Gx={root:"_root_cio8k_1",label:"_label_cio8k_13"},Vh={meter:{en:"m",ru:"м"},kilometer:{en:"km",ru:"км"}},UU=66;class jx extends ko{constructor(e,i){super(e,"",i),this._render=()=>{const{state:n}=this._map._impl,s=!!n.styleState.globeEnabled&&n.zoom<In.globeMaxZoom;if(this._wrap.hidden=s,s)return;const o=this._wrap.getBoundingClientRect(),r=this._calcSize([o.x,o.y],o.width||UU,0),a=`
            <div class="${Gx.root}">
                <div class="${Gx.label}">
                    ${GU(r,this._map.getLanguage())}
                </div>
            </div>
        `;this._wrap.innerHTML=a},this._map=e,this._render(),e.on("zoom",this._render),e.on("pitch",this._render),e.on("changeLanguage",this._render),e.on("move",this._render),e.on("resize",this._render)}destroy(){this._map.off("zoom",this._render),this._map.off("pitch",this._render),this._map.off("changeLanguage",this._render),this._map.off("move",this._render),this._map.off("resize",this._render),super.destroy()}_calcSize(e,i,n){return gu(this._map.getCenter(),this._map.getZoom(),this._map.getRotation(),this._map.getSize(),this._map.getPitch(),e,void 0,this._map.getPadding(),i,n)}}function GU(t,e){return t<1e3?`${t} ${Vh.meter[e]||Vh.meter.en}`:`${(t/1e3).toFixed(1)} ${Vh.kilometer[e]||Vh.kilometer.en}`}class Vx{constructor(e){this._impl=e._impl.getDefaultSource()}setFeatureStateMap(e){this._impl.setFeatureStateMap(e)}}function on(t,e){const i={...t};for(const n in e){const s=n;i[s]===void 0&&(i[s]=e[s])}return i}const nc={root:"_root_1uycl_1",button:"_button_1uycl_9",none:"_none_1uycl_24",easy:"_easy_1uycl_28"},jU=`<?xml version="1.0" encoding="utf-8"?>\r
<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"\r
	 width="20px" height="20px" viewBox="337.5 232.3 125 85.9" xml:space="preserve"\r
	>\r
<polygon fill="#FF0013" points="453.9,306.2 424.7,232.3 400,275.5 375.4,232.3 346.1,306.2 337.5,306.2 337.5,317.4 381.7,317.4 \r
	381.7,306.2 375.1,306.2 381.5,287.8 400,318.2 418.5,287.8 424.9,306.2 418.3,306.2 418.3,317.4 462.5,317.4 462.5,306.2 "/>\r
</svg>\r
`;class VU extends ko{constructor(e,i){super(e,"",i),this._onFloorsActiveGroupChange=n=>{if(this._causedScenarioChange){this._causedScenarioChange=!1;return}this._active=n==="metro",this._render()},this._onClick=n=>{n.preventDefault(),this._causedScenarioChange=!0,this._map._impl.modules.floorManager.configure({activeGroup:this._active?"default":"metro"}),this._active=!this._active,this._render()},this._map=e,this._active=!1,this._causedScenarioChange=!1,this._visible=!0,this._render(),e.on("floorsactivegroupchange",this._onFloorsActiveGroupChange)}destroy(){this._map.off("floorsactivegroupchange",this._onFloorsActiveGroupChange)}_render(){const e=this._active?nc.easy:nc.none,i=`
            <div class="${nc.root}" style="${this._visible?"":"display: none;"}">
                <button type="button" class="${nc.button} ${e}">
                    ${jU}
                </button>
            </div>
        `;this._wrap.innerHTML=i,this._wrap.querySelector(`.${nc.button}`).addEventListener("click",this._onClick)}}const HU={center:[0,0],zoom:0,minZoom:kh.minZoom,maxZoom:kh.maxZoom,rotation:0,touchRotationThreshold:10,pitch:0,minPitch:0,maxPitch:45,lowZoomMaxPitch:45,viewport:{top:0,right:0,bottom:0,left:0},padding:{top:0,right:0,bottom:0,left:0},style:"",lang:"en",disableHidingPois:!1,disableHoverStyles:!1,disableZoomOnScroll:!1,disableDragging:!1,enableTwoFingerDragging:!1,disableRotationByUserInteraction:!1,disablePitchByUserInteraction:!1,defaultBackgroundColor:"#f6f2de",disableIconCache:!1,mobileSdkMode:!1,skipElevationAnimation:!1,enableTrackResize:!1,showDefaultTileBounds:!1,immersiveOn:!1,pitchHightLimitation:90,loopWorld:!1,cityCommPoiLabelingConfig:Lp,disableRenderingCache:!1,disableStyleFallback:!1,fontUrl:"",modelUrl:"",iconUrl:"",keyUrl:"",disableModelsGrowthAnimation:!1};let ZU=class extends ao{constructor(e,i){super();let n;if(typeof e=="string"){const a=document.getElementById(e);if(a)n=a;else throw new Error(`Could not found html element with id: ${e}`)}else n=e;const s={...i.styleOptions},r={...on(this._validateOptions(i),HU),disableHoverStyles:i.disableHoverStyles??!0,tileServer:i.tileServer||R5,style:i.style||rc,styleOptions:s,styleState:i.styleState,sessionId:cp(),tileSessionId:i.tileSessionId};this._impl=new hp(n,r),this._impl.on("idle",a=>this._emitMapEvent("idle",a)).on("ready",a=>this._emitMapEvent("ready",a)).on("resize",a=>this._emitMapEvent("resize",a)).on("move",a=>this._emitMapEvent("move",a)).on("movestart",a=>this._emitMapEvent("movestart",a)).on("moveend",a=>this._emitMapEvent("moveend",a)).on("center",a=>this._emitMapEvent("center",a)).on("centerstart",a=>this._emitMapEvent("centerstart",a)).on("centerend",a=>this._emitMapEvent("centerend",a)).on("zoom",a=>this._emitMapEvent("zoom",a)).on("zoomstart",a=>this._emitMapEvent("zoomstart",a)).on("zoomend",a=>this._emitMapEvent("zoomend",a)).on("rotation",a=>this._emitMapEvent("rotation",a)).on("rotationstart",a=>this._emitMapEvent("rotationstart",a)).on("rotationend",a=>this._emitMapEvent("rotationend",a)).on("pitch",a=>this._emitMapEvent("pitch",a)).on("pitchstart",a=>this._emitMapEvent("pitchstart",a)).on("pitchend",a=>this._emitMapEvent("pitchend",a)).on("trafficshow",()=>this.emit("trafficshow")).on("traffichide",()=>this.emit("traffichide")).on("floorcomplexshow",({id:a,currentFloor:l,floorNames:c})=>this.emit("floorplanshow",{floorPlanId:a,currentFloorLevelIndex:l,floorLevels:c.map((d,h)=>({floorLevelIndex:h,floorLevelName:d}))})).on("floorcomplexhide",a=>this.emit("floorplanhide",{floorPlanId:a.id})).on("floorcomplexlevelchange",a=>this.emit("floorlevelchange",{floorLevelName:a.floorName,floorLevelIndex:a.floorIndex,floorPlanId:a.id})).on("floorsactivegroupchange",a=>this.emit("floorsactivegroupchange",a)).on("modelshow",a=>this.emit("modelshow",a)).on("modelhide",a=>this.emit("modelhide",a)),this._impl.on("click",a=>this._emitMapPointerEvent("click",a)).on("dblclick",a=>this._emitMapPointerEvent("dblclick",a)).on("contextmenu",a=>this._emitMapPointerEvent("contextmenu",a)).on("mousemove",a=>this._emitMapPointerEvent("mousemove",a)).on("mouseover",a=>this._emitMapPointerEvent("mouseover",a)).on("mouseout",a=>this._emitMapPointerEvent("mouseout",a)).on("mousedown",a=>this._emitMapPointerEvent("mousedown",a)).on("mouseup",a=>this._emitMapPointerEvent("mouseup",a)).on("touchstart",a=>this._emitMapPointerEvent("touchstart",a)).on("touchend",a=>this._emitMapPointerEvent("touchend",a)),this._impl.on("error",a=>this._emitMapErrorEvent("error",a)),this._impl.on("trafficscore",({score:a})=>this.emit("trafficscore",{score:a})),this._impl.on("styleload",({style:a})=>this.emit("styleload",{style:a})),this._impl.on("styleloaderror",({style:a})=>this.emit("styleloaderror",{style:a})),this._impl.on("graphicspresetchange",()=>this.emit("graphicspresetchange",this._impl.getGraphicsPreset())),this._controlPane=new NU(this,{padding:i.controlsLayoutPadding}),this._initControls(i),new DU(this),this._defaultSource=new Vx(this)}setCenter(e,i){return this._impl.setCenter(e,i),this}getCenter(){return this._impl.getCenter()}setZoom(e,i){return this._impl.setZoom(e,i),this}getZoom(){return this._impl.getZoom()}getStyleZoom(){return this._impl.getStyleZoom()}setStyleZoom(e,i){return this._impl.setStyleZoom(e,i),this}setRotation(e,i){return this._impl.setRotation(e,i),this}getRotation(){return this._impl.getRotation()}setPitch(e,i){return this._impl.setPitch(e,i),this}getPitch(){return this._impl.getPitch()}setMinZoom(e,i){return this._impl.setMinZoom(e,i),this}getMinZoom(){return this._impl.getMinZoom()}getMaxZoom(){return this._impl.getMaxZoom()}setMaxZoom(e,i){return this._impl.setMaxZoom(e,i),this}setMinPitch(e,i){return this._impl.setMinPitch(e,i),this}setMaxPitch(e,i){return this._impl.setMaxPitch(e,i),this}setLowZoomMaxPitch(e,i){return this._impl.setLowZoomMaxPitch(e,i),this}getSize(){return this._impl.getSize()}isIdle(){return this._impl.isIdle()}getBounds(e){return new OU(this._impl.getBounds(e))}project(e){return this._impl.project(e)}unproject(e){return this._impl.unproject(e)}getProjectionMatrix(){return this._impl.getCameraViewProjectionMatrix().slice()}getProjectionMatrixForGltfPlugin(){return this._impl.getCameraProjectionMatrix().slice()}getWebGLContext(){return this._impl.getWebGLContext()}getCanvas(){return this._impl.getCanvas()}getContainer(){return this._impl.getExternalContainer()}invalidateSize(){return this._impl.invalidateSize(),this}showTraffic(){return this._impl.showTraffic(),this}hideTraffic(){return this._impl.hideTraffic(),this}setSelectedObjects(e=[],i){return this._impl.setSelectedIds(e,i),this}async setStyleById(e){return this._impl.setStyle(e)}async setStyleFromUrl(e,i){return this._impl.setStyle(e,i)}setLanguage(e){return this._impl.setLang(e),this.emit("changeLanguage",{lang:e}),this}getLanguage(){return this._impl.state.lang}setFloorPlanLevel(e,i){this._impl.changeFloorNumber(e,i)}setMaxBounds(e){return this._impl.setMaxBounds(e),this}getPadding(){return this._impl.getPadding()}getDefaultSource(){return this._defaultSource}setPadding(e,i){return this._impl.setPadding(e,i),this}setStyle(e,i){return this._impl.setStyle(e,i)}hasLayer(e){return this._impl.hasLayer(e)}addLayer(e,i){return this._impl.addLayer(e,i),this}addIcon(e,i){return this._impl.addIcon(e,i),this}removeIcon(e){return this._impl.removeIcon(e),this}getMapRenderStat(){return this._impl.getMapRenderStat()}addModel(e,i){return this._impl.addModel(e,i),this}removeLayer(e){return this._impl.removeLayer(e),this}setAutoHoverMode(e){return this._impl.setAutoHoverMode(e),this}fitBounds(e,i){return this._impl.fitBounds(e,i),this}setStyleState(e){return this._impl.setStyleState(e),this}setTime(e){this._impl.setTime(e)}getTime(e){this._impl.getTime(e)}getStyleState(){return this._impl.getStyleState()}setStyleOptions(e){return this._impl.patchStyleState({trafficOn:e.traffic}),this}setOption(e,i){return this._impl.setOption(e,i),this}getOption(e){return this._impl.getOption(e)}patchStyleState(e){return this._impl.patchStyleState(e),this}destroy(){this._controlPane.destroy(),this._impl.destroy(),this.emit("destroy")}triggerRerender(){this._impl.modules.renderer.addRerenderEvent({type:"triggerRerender"})}setControlsLayoutPadding(e){this._controlPane.setPadding(e)}getControlsLayoutPadding(){return this._controlPane.getPadding()}setHiddenObjects(e){this._impl.hideBuildingsById(e)}setEnvironmentParams(e){this._impl.modules.environmentManager.setParameters(e)}unsetHiddenObjects(e){this._impl.showHiddenBuildingsById(e)}showLabelsDebug(e){this._impl.showLabelsDebug(e)}hideLabelsDebug(){this._impl.hideLabelsDebug()}getGroundPoint(e){return this._impl.getGroundPoint(e)}configureFloors({activeGroup:e,allowedFloorIds:i}){this._impl.configureFloors({activeGroup:e,allowedFloorIds:i})}setLightingStyle(e){this._impl.setLightingStyle(e)}hideLayers(e){return this._impl.hideLayers(e),this}showLayers(e){return this._impl.showLayers(e),this}getGraphicsPreset(){return this._impl.getGraphicsPreset().preset}_emitMapEvent(e,i){this.emit(e,{isUser:i.isUser})}_emitMapErrorEvent(e,i){const{tileCoords:n,tileUrl:s,source:o,responseMessage:r,responseStatus:a}=i;if((o==null?void 0:o.type)==="raster"){const l=o.mapglApiSource;this.emit(e,{type:"rasterTileLoadError",responseMessage:r,responseStatus:a,tileUrl:s,tileCoords:[n[0],n[1],n[2]],source:l})}}_emitMapPointerEvent(e,i){const{originalEvent:n,lngLat:s,point:o,target:r,targetData:a}=i;let l;if(a!==void 0)switch(a.type){case"geojson":{l={type:a.type,source:a.source.mapglApiSource,feature:a.feature,id:a.id,layerId:a.layerId};break}case"zenith":{l={type:a.type,id:a.id,source:a.source.mapglApiSource,attributes:a.attributes,layerId:a.layerId};break}case"default":{l={type:a.type,id:a.id,layerId:a.layerId};const{floorId:d}=a;d&&(l.floorId=d);break}}let c;r!==void 0&&(c={id:r.id},r.center&&(c.center=r.center)),this.emit(e,{originalEvent:n,lngLat:s,point:o,target:c,targetData:l})}_initControls(e){if(e.copyright!==!1&&this._impl.modules.tileKeyInfo.getKeyInfo().then(i=>{!i.error&&!i.hideCopyright&&new LU(this,{position:typeof e.copyright=="string"?e.copyright:"bottomRight",interactive:e.interactiveCopyright,copyrightType:i.urbi?"Urbi":"2gis"})}),e.zoomControl!==!1){const i=typeof e.zoomControl=="string"?e.zoomControl:"topRight";new Dx(this,{position:i})}if(e.trafficControl){const i=typeof e.trafficControl=="string"?e.trafficControl:"topRight";new Ox(this,{position:i})}if(e.metroControl){const i=typeof e.metroControl=="string"?e.metroControl:"topRight";new VU(this,{position:i})}if(e.scaleControl){const i=typeof e.scaleControl=="string"?e.scaleControl:"bottomLeft";new jx(this,{position:i})}if(e.floorControl){const i=typeof e.floorControl=="string"?e.floorControl:"topRight";new Ux(this,{position:i})}}_validateOptions(e){return e={...e},typeof e=="object"&&"center"in e&&(_x.isValidGeoPoint(e.center,dp.UseDefault)||(e.center=void 0)),e}};const $U="Noto_Sans",WU={minZoom:-1/0,maxZoom:1/0,anchor:[.5,.5],offset:[0,18],relativeAnchor:[.5,.5],zIndex:0,lineHeight:1.2,letterSpacing:0,haloRadius:0,fontSize:18,color:"#000000",haloColor:"#ffffff"},XU={minZoom:-1/0,maxZoom:1/0,zIndex:0,icon:"data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzBweCIgaGVpZ2h0PSI0OHB4IiB2aWV3Qm94PSIwIDAgMzAgNDgiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayI+PCEtLSBHZW5lcmF0b3I6IFNrZXRjaCA1MS4yICg1NzUxOSkgLSBodHRwOi8vd3d3LmJvaGVtaWFuY29kaW5nLmNvbS9za2V0Y2ggLS0+PHRpdGxlPlBhZ2UgMSBDb3B5PC90aXRsZT48ZGVzYz5DcmVhdGVkIHdpdGggU2tldGNoLjwvZGVzYz48ZGVmcz48bGluZWFyR3JhZGllbnQgeDE9IjUwJSIgeTE9IjUwJSIgeDI9IjUwJSIgeTI9IjAlIiBpZD0ibGluZWFyR3JhZGllbnQtMSI+PHN0b3Agc3RvcC1jb2xvcj0iIzFCODlFRSIgb2Zmc2V0PSIwJSI+PC9zdG9wPjxzdG9wIHN0b3AtY29sb3I9IiMzMTk4RUMiIG9mZnNldD0iMTAwJSI+PC9zdG9wPjwvbGluZWFyR3JhZGllbnQ+PC9kZWZzPjxnIGlkPSJQYWdlLTEiIHN0cm9rZT0ibm9uZSIgc3Ryb2tlLXdpZHRoPSIxIiBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxnIGlkPSJSZWNvdmVyeS0wMSIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoLTgzOS4wMDAwMDAsIC00MjUuMDAwMDAwKSI+PGcgaWQ9IlBhZ2UtMS1Db3B5IiB0cmFuc2Zvcm09InRyYW5zbGF0ZSg4MzkuMDAwMDAwLCA0MjUuMDAwMDAwKSI+PGVsbGlwc2UgaWQ9Ik92YWwtMyIgZmlsbD0iIzAwMDAwMCIgb3BhY2l0eT0iMC4wMzYzODA1OTciIGN4PSIxNSIgY3k9IjQ1LjUiIHJ4PSIzIiByeT0iMS41Ij48L2VsbGlwc2U+PGVsbGlwc2UgaWQ9Ik92YWwtMy1Db3B5IiBmaWxsPSIjMDAwMDAwIiBvcGFjaXR5PSIwLjAzNjM4MDU5NyIgY3g9IjE1IiBjeT0iNDUuNSIgcng9IjQuNSIgcnk9IjIuNSI+PC9lbGxpcHNlPjxwYXRoIGQ9Ik0xNSw0NS44ODM2MzUzIEwxNS44ODIzNTI5LDQ1Ljg4MzYzNTMgQzE1Ljg4MjM1MjksMjkuMjE3NzUyOSAyMC43NzY3NjQ3LDIzLjc5NzQ1ODggMjcuOTg3MzUyOSwyMy43OTc0NTg4IEwyOC4zMjk3MDU5LDIzLjc5NzQ1ODggQzI5LjA3Nzk0MTIsMjEuNTkwNjk0MSAzMCwxNy45OTE1NzY1IDMwLDE1LjAwMDQgQzMwLDcuMTQzOTI5NDEgMjMuNzY3OTQxMiwwLjAwMDQgMTUsMC4wMDA0IEM2LjIzMjA1ODgyLDAuMDAwNCAwLDcuMTQzOTI5NDEgMCwxNS4wMDA0IEMwLDE3Ljk5MTU3NjUgMC45MjIwNTg4MjQsMjEuNTkwNjk0MSAxLjY3MDI5NDEyLDIzLjc5NzQ1ODggTDIuMDEyNjQ3MDYsMjMuNzk3NDU4OCBDOS4yMjQxMTc2NSwyMy43OTc0NTg4IDE0LjExNzY0NzEsMjkuMjE3NzUyOSAxNC4xMTc2NDcxLDQ1Ljg4MzYzNTMgTDE1LDQ1Ljg4MzYzNTMgWiIgaWQ9IkZpbGwtMSIgZmlsbD0idXJsKCNsaW5lYXJHcmFkaWVudC0xKSI+PC9wYXRoPjwvZz48L2c+PC9nPjwvc3ZnPg==",interactive:!0,hoverSize:[15,43],rotation:0,userData:void 0,opacity:1,hoverOpacity:1};class YU extends ao{constructor(e,i){super(),i.icon||(i.anchor=[15,46]);const n=on(i,XU);this.userData=n.userData,this.rootOptions={zIndex:n.zIndex,minZoom:n.minZoom,maxZoom:n.maxZoom},this._impl=new JMarker(e._impl,{coordinates:n.coordinates,icon:n.icon,zIndex:n.zIndex,minZoom:n.minZoom,maxZoom:n.maxZoom,interactive:n.interactive,opacity:n.opacity,hoverOpacity:n.hoverOpacity,label:Hx(this.rootOptions,i.label),anchor:i.anchor,size:i.size,rotation:i.rotation,hoverIcon:i.hoverIcon,hoverSize:i.hoverSize,hoverAnchor:i.hoverAnchor}),this._impl.on("click",s=>this._emitPointerEvent("click",s)).on("dblclick",s=>this._emitPointerEvent("dblclick",s)).on("mousemove",s=>this._emitPointerEvent("mousemove",s)).on("mouseover",s=>this._emitPointerEvent("mouseover",s)).on("mouseout",s=>this._emitPointerEvent("mouseout",s)).on("mousedown",s=>this._emitPointerEvent("mousedown",s)).on("mouseup",s=>this._emitPointerEvent("mouseup",s)).on("touchstart",s=>this._emitPointerEvent("touchstart",s)).on("touchend",s=>this._emitPointerEvent("touchend",s))}setIcon({icon:e,anchor:i,size:n,opacity:s}){return this._impl.setIcon({icon:e,anchor:i,size:n,opacity:s}),this}setHoverIcon(e){const i=e?{icon:e.icon,anchor:e.anchor,size:e.size,opacity:e.opacity}:void 0;return this._impl.setHoverIcon(i),this}setRotation(e){return this._impl.setRotation(e),this}getRotation(){return this._impl.getRotation()}setLabel(e){return this._impl.setLabel(Hx(this.rootOptions,e)),this}setCoordinates(e){return this._impl.setCoordinates(e),this}getCoordinates(){return this._impl.getCoordinates()}show(){return this._impl.show(),this}hide(){return this._impl.hide(),this}destroy(){this._impl.destroy()}_emitPointerEvent(e,i){const{originalEvent:n,lngLat:s,point:o}=i;this.emit(e,{originalEvent:n,lngLat:s,point:o,targetData:this})}}function Hx(t,e){if(!e)return;e.minZoom=Math.max(e.minZoom??t.minZoom,t.minZoom),e.maxZoom=Math.min(e.maxZoom??t.maxZoom,t.maxZoom),e.zIndex=e.zIndex??t.zIndex+1e-5;const i=on(e,WU);return e.offset===void 0&&e.anchor!==void 0&&(i.offset=e.anchor.map(n=>-n)),{text:i.text,image:e.image,minZoom:i.minZoom,maxZoom:i.maxZoom,color:i.color,fontSize:i.fontSize,haloRadius:i.haloRadius,haloColor:i.haloColor,letterSpacing:i.letterSpacing,lineHeight:i.lineHeight,zIndex:i.zIndex,offset:i.offset,anchor:i.relativeAnchor,font:$U}}const qU="Noto_Sans",KU={anchor:[0,0],offset:[0,0],fontSize:24,color:"#000000",haloColor:"#ffffff",haloRadius:0,minZoom:-1/0,maxZoom:1/0,zIndex:0,letterSpacing:0,lineHeight:1.2,relativeAnchor:[.5,.5],userData:void 0,interactive:!1};class JU extends ao{constructor(e,i){super(),this.userData=i.userData;const n=on(i,KU);i.offset===void 0&&i.anchor!==void 0&&(n.offset=i.anchor.map(s=>-s)),this._impl=new PointLabel(e._impl,{coordinates:n.coordinates,text:n.text,minZoom:n.minZoom,maxZoom:n.maxZoom,color:n.color,fontSize:n.fontSize,haloRadius:n.haloRadius,haloColor:n.haloColor,letterSpacing:n.letterSpacing,lineHeight:n.lineHeight,zIndex:n.zIndex,offset:n.offset,anchor:n.relativeAnchor,labeling:i.labeling,image:i.image,font:qU,interactive:n.interactive}),this._impl.on("click",s=>this._emitPointerEvent("click",s)).on("dblclick",s=>this._emitPointerEvent("dblclick",s)).on("mousemove",s=>this._emitPointerEvent("mousemove",s)).on("mouseover",s=>this._emitPointerEvent("mouseover",s)).on("mouseout",s=>this._emitPointerEvent("mouseout",s)).on("mousedown",s=>this._emitPointerEvent("mousedown",s)).on("mouseup",s=>this._emitPointerEvent("mouseup",s)).on("touchstart",s=>this._emitPointerEvent("touchstart",s)).on("touchend",s=>this._emitPointerEvent("touchend",s))}destroy(){this._impl.remove()}show(){return this._impl.show(),this}hide(){return this._impl.hide(),this}setCoordinates(e){return this._impl.setCoordinates(e),this}getCoordinates(){return this._impl.getCoordinates()}_emitPointerEvent(e,i){const{originalEvent:n,lngLat:s,point:o}=i;this.emit(e,{originalEvent:n,lngLat:s,point:o,targetData:this})}}const QU={minZoom:-1/0,maxZoom:1/0,zIndex:0,anchor:[-0,-0],preventMapInteractions:!0,userData:void 0,interactive:!0,disableRounding:!1,labeling:{type:"none"}},e8=!1;class t8{constructor(e,i){this.userData=i.userData;const n=on(i,QU);this._impl=new Jl(e._impl,{coordinates:n.coordinates,html:n.html,offset:[-n.anchor[0],-n.anchor[1]],minZoom:n.minZoom,maxZoom:n.maxZoom,zIndex:n.zIndex,preventMapInteractions:n.preventMapInteractions,interactive:n.interactive,animate:e8,disableRounding:n.disableRounding,labeling:n.labeling})}destroy(){this._impl.destroy()}setCoordinates(e){return this._impl.setPosition(e),this}setAnchor(e){return this._impl.setOffset([-e[0],-e[1]]),this}setContent(e){return this._impl.setContent(e),this}setZIndex(e){return this._impl.setZIndex(e),this}getCoordinates(){return this._impl.getPosition()}getAnchor(){const e=this._impl.getOffset();return[-e[0],-e[1]]}getContent(){return this._impl.getHtmlElement()}getZIndex(){return this._impl.getZIndex()}}const i8={zIndex:0,minZoom:-1/0,maxZoom:1/0,color:"#3388ff33",strokeColor:"#3388ff",strokeWidth:1,interactive:!0,userData:void 0};class n8 extends ao{constructor(e,i){super(),this.userData=i.userData;const n=on(i,i8),s={coordinates:n.coordinates,radius:n.radius,minZoom:n.minZoom,maxZoom:n.maxZoom,interactive:n.interactive,color:n.color,zIndex:n.zIndex,borderWidth:n.strokeWidth,borderColor:n.strokeColor,segments:150,tiers:i.tiers};this._impl=new Ex(e._impl,s),this._impl.on("click",o=>this._emitPointerEvent("click",o)).on("dblclick",o=>this._emitPointerEvent("dblclick",o)).on("mousemove",o=>this._emitPointerEvent("mousemove",o)).on("mouseover",o=>this._emitPointerEvent("mouseover",o)).on("mouseout",o=>this._emitPointerEvent("mouseout",o)).on("mousedown",o=>this._emitPointerEvent("mousedown",o)).on("mouseup",o=>this._emitPointerEvent("mouseup",o)).on("touchstart",o=>this._emitPointerEvent("touchstart",o)).on("touchend",o=>this._emitPointerEvent("touchend",o))}destroy(){this._impl.remove()}_emitPointerEvent(e,i){const{originalEvent:n,lngLat:s,point:o}=i;this.emit(e,{originalEvent:n,lngLat:s,point:o,targetData:this})}}const s8={interactive:!0,maxZoom:1/0,minZoom:-1/0,color:"#ffffff",radius:20,diameter:NaN,zIndex:0,strokeWidth:3,stroke2Width:0,strokeColor:"#3388ff",stroke2Color:"#00000000",userData:void 0};class o8 extends ao{constructor(e,i){super(),this.userData=i.userData,this.options=on(i,s8);const n={coordinates:this.options.coordinates,interactive:this.options.interactive,maxZoom:this.options.maxZoom,minZoom:this.options.minZoom,color:this.options.color,width:Number.isNaN(this.options.diameter)?this.options.radius:this.options.diameter,zIndex:this.options.zIndex,borderWidth:this.options.strokeWidth,borderColor:this.options.strokeColor,border2Width:this.options.stroke2Width,border2Color:this.options.stroke2Color,draggable:!1};this._impl=new A_(e._impl,n),this._impl.on("click",s=>this._emitPointerEvent("click",s)).on("dblclick",s=>this._emitPointerEvent("dblclick",s)).on("mousemove",s=>this._emitPointerEvent("mousemove",s)).on("mouseover",s=>this._emitPointerEvent("mouseover",s)).on("mouseout",s=>this._emitPointerEvent("mouseout",s)).on("mousedown",s=>this._emitPointerEvent("mousedown",s)).on("mouseup",s=>this._emitPointerEvent("mouseup",s)).on("touchstart",s=>this._emitPointerEvent("touchstart",s)).on("touchend",s=>this._emitPointerEvent("touchend",s))}destroy(){this._impl.remove()}_emitPointerEvent(e,i){const{originalEvent:n,lngLat:s,point:o}=i;this.emit(e,{originalEvent:n,lngLat:s,point:o,targetData:this})}}const r8={interactive:!0,maxZoom:1/0,minZoom:-1/0,width:3,width2:0,width3:0,color:"#3388ff",color2:"#00000000",color3:"#00000000",zIndex:0,zIndex2:-1,zIndex3:-2,dashLength:0,gapLength:0,gapColor:"#ffffff00",userData:void 0,renderingMode:"2d"};class a8 extends ao{constructor(e,i){super(),this.userData=i.userData;const n=on(i,r8);if(i.dashLength){const s={coordinates:n.coordinates,interactive:n.interactive,maxZoom:n.maxZoom,minZoom:n.minZoom,width:n.width,width2:n.width2,dashColor:n.color,dash2Color:n.color,gapColor:n.gapColor,dashLength:n.dashLength,dash2Length:0,zIndex:n.zIndex,zIndex2:n.zIndex2,gapLength:n.gapLength===0?n.dashLength:n.gapLength,displayTileBounds:!1,showAnimation:{animate:!1},renderingMode:n.renderingMode,hiddenPartDashColor:i.hiddenPartColor,hiddenPartDash2Color:i.hiddenPartColor,hiddenPartGapColor:i.hiddenPartGapColor,webglState:i.webglState,tiers:i.tiers};this._impl=new Ix(e._impl,s),this._impl.on("click",o=>this._emitPointerEvent("click",o)).on("dblclick",o=>this._emitPointerEvent("dblclick",o)).on("mousemove",o=>this._emitPointerEvent("mousemove",o)).on("mouseover",o=>this._emitPointerEvent("mouseover",o)).on("mouseout",o=>this._emitPointerEvent("mouseout",o)).on("mousedown",o=>this._emitPointerEvent("mousedown",o)).on("mouseup",o=>this._emitPointerEvent("mouseup",o)).on("touchstart",o=>this._emitPointerEvent("touchstart",o)).on("touchend",o=>this._emitPointerEvent("touchend",o))}else{const s={coordinates:n.coordinates,interactive:n.interactive,maxZoom:n.maxZoom,minZoom:n.minZoom,width:n.width,width2:n.width2,width3:n.width3,color:n.color,color2:n.color2,color3:n.color3,zIndex:n.zIndex,zIndex2:n.zIndex2,zIndex3:n.zIndex3,displayTileBounds:!1,showAnimation:{animate:!1},webglState:i.webglState,renderingMode:n.renderingMode,hiddenPartColor:i.hiddenPartColor,tiers:i.tiers};this._impl=new up(e._impl,s),this._impl.on("click",o=>this._emitPointerEvent("click",o)).on("dblclick",o=>this._emitPointerEvent("dblclick",o)).on("mousemove",o=>this._emitPointerEvent("mousemove",o)).on("mouseover",o=>this._emitPointerEvent("mouseover",o)).on("mouseout",o=>this._emitPointerEvent("mouseout",o)).on("mousedown",o=>this._emitPointerEvent("mousedown",o)).on("mouseup",o=>this._emitPointerEvent("mouseup",o)).on("touchstart",o=>this._emitPointerEvent("touchstart",o)).on("touchend",o=>this._emitPointerEvent("touchend",o))}}destroy(){this._impl.remove()}_emitPointerEvent(e,i){const{originalEvent:n,lngLat:s,point:o}=i;this.emit(e,{originalEvent:n,lngLat:s,point:o,targetData:this})}}const l8={interactive:!0,maxZoom:1/0,minZoom:-1/0,color:"#3388ff33",zIndex:0,strokeWidth:3,strokeColor:"#3388ff",userData:void 0};class c8 extends ao{constructor(e,i){super(),this.userData=i.userData;const n=on(i,l8),s={coordinates:n.coordinates,interactive:n.interactive,maxZoom:n.maxZoom,minZoom:n.minZoom,color:n.color,zIndex:n.zIndex,strokeWidth:n.strokeWidth,strokeColor:n.strokeColor,tiers:i.tiers};this._impl=new Tx(e._impl,s),this._impl.on("click",o=>this._emitPointerEvent("click",o)).on("dblclick",o=>this._emitPointerEvent("dblclick",o)).on("mousemove",o=>this._emitPointerEvent("mousemove",o)).on("mouseover",o=>this._emitPointerEvent("mouseover",o)).on("mouseout",o=>this._emitPointerEvent("mouseout",o)).on("mousedown",o=>this._emitPointerEvent("mousedown",o)).on("mouseup",o=>this._emitPointerEvent("mouseup",o)).on("touchstart",o=>this._emitPointerEvent("touchstart",o)).on("touchend",o=>this._emitPointerEvent("touchend",o))}destroy(){this._impl.remove()}_emitPointerEvent(e,i){const{originalEvent:n,lngLat:s,point:o}=i;this.emit(e,{originalEvent:n,lngLat:s,point:o,targetData:this})}}const d8={minZoom:-1/0,maxZoom:1/0,zIndex:0,opacity:1};class h8{constructor(e,i){const n=on(i,d8),s={bounds:n.bounds,image:{url:n.image.url},minZoom:n.minZoom,maxZoom:n.maxZoom,zIndex:n.zIndex,opacity:n.opacity,tiers:i.tiers};this._impl=new zx(e._impl,s)}async updateImage(e){await this._impl.updateImage(e)}destroy(){this._impl.destroy()}}const u8={scale:1,rotation:0,offset:0,linkedIds:[],interactive:!1,interactiveOcclusion:!0,minZoom:-1/0,maxZoom:1/0,zIndex:0,hideOnInit:!1,ignoreGlobalLighting:!1,colorTextureUvIndex:0,nearCameraFade:2500,showRatio:1,userData:void 0,planId:"",disableAnimation:!1,hover:{},select:{},color:"#ffffffff",playAnimation:-1};class f8 extends ao{constructor(e,i){super(),this.userData=i.userData;const n=on(i,u8),s={coordinates:n.coordinates,modelSrc:n.modelSrc,scale:n.scale,rotation:n.rotation,offset:n.offset,linkedIds:n.linkedIds,planId:n.planId,interactive:n.interactive,interactiveOcclusion:n.interactiveOcclusion,minZoom:n.minZoom,maxZoom:n.maxZoom,zIndex:n.zIndex,hideOnInit:n.hideOnInit,ignoreGlobalLighting:n.ignoreGlobalLighting,colorTextureUvIndex:n.colorTextureUvIndex,nearCameraFade:n.nearCameraFade,showRatio:n.showRatio,disableAnimation:n.disableAnimation,hover:n.hover,select:n.select,color:n.color,playAnimation:n.playAnimation,throttledIdentifierUpdate:n.throttledIdentifierUpdate};this._impl=new JGltfModel(e._impl,s),this._impl.on("click",o=>this._emitPointerEvent("click",o)).on("dblclick",o=>this._emitPointerEvent("dblclick",o)).on("mousemove",o=>this._emitPointerEvent("mousemove",o)).on("mouseover",o=>this._emitPointerEvent("mouseover",o)).on("mouseout",o=>this._emitPointerEvent("mouseout",o)).on("mousedown",o=>this._emitPointerEvent("mousedown",o)).on("mouseup",o=>this._emitPointerEvent("mouseup",o)).on("touchstart",o=>this._emitPointerEvent("touchstart",o)).on("touchend",o=>this._emitPointerEvent("touchend",o)).on("modelloaded",()=>this._emitPointerEvent("modelloaded"))}destroy(e){this._impl.destroy(e)}hide(){this._impl.hide()}show(){this._impl.show()}transform(e){this._impl.transform(e)}stopTransformation(){this._impl.stopTransformation()}getCoordinates(){return this._impl.getCoordinates()}getScale(){return this._impl.getScale()}getRotation(){return this._impl.getRotation()}getOffset(){return this._impl.getOffset()}setState(e){this._impl.setState(e)}_emitPointerEvent(e,i){this.emit(e,i?{originalEvent:i.originalEvent,lngLat:i.lngLat,point:i.point,targetData:this}:void 0)}}const Zx={attributes:{},maxZoom:17,dimensions:2,modelsPath:"",modelsAppearStrategy:"byModel",promoteId:"",idScope:"default",tolerance:3};class $x{constructor(e,i){this.options=on(i,Zx),this._impl=new Md(e._impl,this.options,this)}destroy(){this._impl.destroy()}setAttributes(e){return this._impl.setAttributes(e),this}getAttributes(){return this._impl.getAttributes()}async setData(e){await this._impl.setData(e)}}const _8={...Zx,viewportPadding:0};class m8{constructor(e,i){this.options=on(i,_8);const n={...this.options,data:Sd};this._impl=new Id(e._impl,n,this),this._impl.setDataFn(i.data),this._impl.setViewportPadding(this.options.viewportPadding)}destroy(){this._impl.destroy()}setAttributes(e){return this._impl.setAttributes(e),this}getAttributes(){return this._impl.getAttributes()}async setData(e){return this._impl.setDataFn(e)}setViewportPadding(e){return this._impl.setViewportPadding(e),this}}const Wx={container:"_container_v1bkq_1",text:"_text_v1bkq_11"},p8=t=>`
    <div class=${Wx.container}>
        <div class=${Wx.text}>
            ${t}
        </div>
    </div>
`;class g8 extends ko{constructor(e,i){super(e,p8(i),{position:"bottomLeft"})}}const v8={attributes:{},attribution:"",minZoom:kh.minZoom,maxZoom:kh.maxZoom};class y8{constructor(e,i){this.options=on(i,v8),this._impl=new Fx(e._impl,this.options,this),this._attribution=new g8(e,this.options.attribution)}destroy(){this._impl.destroy(),this._attribution.destroy()}setAttributes(e){return this._impl.setAttributes(e),this}getAttributes(){return this._impl.getAttributes()}}const Zh=class Zh{constructor(e,i){this.options=i;const n=this.prepareOptions(this.options,e);this._impl=new u_(e._impl,n,this)}destroy(){this._impl.destroy()}setAttributes(e){return this._impl.setAttributes(e),this}getAttributes(){return this._impl.getAttributes()}setFeatureStateMap(e){this._impl.setFeatureStateMap(e)}prepareOptions(e,i){const n={tileServer:e.tileServer??"",tileSet:e.tileSet??"",tileProtocol:e.tileProtocol??"",tileKey:e.tileKey??"",subdomains:e.subdomains??(e.layerId?["0,1,2,3"]:[""]),appId:e.appId??i._impl.state.appId,tileTemplateUrl:e.tileTemplateUrl,metatileTemplateUrl:e.metatileTemplateUrl,defaultLang:e.defaultLang,sessionId:e.sessionId,sourceAttributes:e.sourceAttributes,modelsPath:e.modelsPath,disableTilesAnimation:e.disableTilesAnimation,promoteAttributes:e.promoteAttributes,promoteId:e.promoteId,idScope:e.idScope,modelsAppearStrategy:e.modelsAppearStrategy,minZoom:e.minZoom??9,maxZoom:e.maxZoom??15,maxDetailLevel:e.maxGenerateZoom??17,strokeMinZoom:e.strokeMinZoom??8};return e.layerId&&(n.tileTemplateUrl||(n.tileTemplateUrl=`${ux}?ts=userdata&x={x}&y={y}&z={z}&layer=${e.layerId}`),n.metatileTemplateUrl||(n.metatileTemplateUrl=`${ux}/file/{hash}?ts=userdata&layer=${e.layerId}`)),n}};Zh.tileTemplateUrl="{protocol}://{host}/v2/ald?ts={tileSet}&x={x}&y={y}&z={z}&lang={lang}",Zh.metatileTemplateUrl="{protocol}://{host}/v2/ald/file/{hash}.json?ts={tileSet}";let vp=Zh;function w8(t){const e=t.split("?")[1];if(!e)return;const n=e.split("&").map(s=>s.split("=")).find(s=>s[0]==="callback");if(n)return n[1]}setTimeout(()=>{const t=Array.from(document.querySelectorAll("script")).find(i=>i.src.match(C5));if(!t)return;const e=w8(t.src);if(e)if(typeof window[e]=="function")window[e]();else throw new Error(`Not found callback function with name "${e}"`)},0),setTimeout(()=>{if("__mapglPlugins"in window)for(const t in window.__mapglPlugins)window.mapgl[t]=window.__mapglPlugins[t]},0);const yp="0.0.0";Je.API_VERSION=yp,Je.Circle=n8,Je.CircleMarker=o8,Je.Control=ko,Je.DefaultSource=Vx,Je.FloorControl=Ux,Je.GeoJsonSource=$x,Je.GeoJsonViewportSource=m8,Je.GltfModel=f8,Je.HtmlMarker=t8,Je.Label=JU,Je.Map=ZU,Je.Marker=YU,Je.Polygon=c8,Je.Polyline=a8,Je.Raster=h8,Je.RasterTileSource=y8,Je.ScaleControl=jx,Je.TrafficControl=Ox,Je.ZenithSource=vp,Je.ZoomControl=Dx,Je._J=wU,Je.isSupported=TC,Je.isTerrainSupported=Q_,Je.notSupportedReason=O1,Je.terrainNotSupportedReason=NC,Object.defineProperty(Je,Symbol.toStringTag,{value:"Module"})});
